<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: rpmio/rpmio.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>rpmio/rpmio.c</h1><a href="rpmio_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#if HAVE_MACHINE_TYPES_H</span>
<a name="l00009"></a>00009 <span class="preprocessor"></span><span class="preprocessor"># include &lt;machine/types.h&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#endif</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span>
<a name="l00012"></a>00012 <span class="preprocessor">#if HAVE_SYS_SOCKET_H</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor"># include &lt;sys/socket.h&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#endif</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>          <span class="comment">/* XXX for inet_aton and HP-UX */</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#if HAVE_NETINET_IN_SYSTM_H</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor"># include &lt;sys/types.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor"># include &lt;netinet/in_systm.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#endif</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span>
<a name="l00024"></a>00024 <span class="preprocessor">#if HAVE_LIBIO_H &amp;&amp; defined(_G_IO_IO_FILE_VERSION)</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#define _USE_LIBIO      1</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span>
<a name="l00028"></a>00028 <span class="comment">/* XXX HP-UX w/o -D_XOPEN_SOURCE needs */</span>
<a name="l00029"></a>00029 <span class="preprocessor">#if !defined(HAVE_HERRNO) &amp;&amp; (defined(__hpux) || defined(__LCLINT__))</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00031"></a>00031 <span class="keyword">extern</span> <span class="keywordtype">int</span> h_errno;
<a name="l00032"></a>00032 <span class="preprocessor">#endif</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span>
<a name="l00034"></a>00034 <span class="preprocessor">#ifndef IPPORT_FTP</span>
<a name="l00035"></a><a class="code" href="rpmio_8c.html#b1bfa063152e67aed53df45f4fae8cd8">00035</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPORT_FTP      21</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#ifndef IPPORT_HTTP</span>
<a name="l00038"></a><a class="code" href="rpmio_8c.html#4c4b2f064d844572b83e49a63b1fdfad">00038</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPORT_HTTP     80</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#if !defined(HAVE_INET_ATON)</span>
<a name="l00042"></a><a class="code" href="rpmio_8c.html#7e3dddc5b7255116c3f9fdc2162b9c53">00042</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#7e3dddc5b7255116c3f9fdc2162b9c53">inet_aton</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cp, <span class="keyword">struct</span> in_addr *inp)
<a name="l00043"></a>00043         <span class="comment">/*@modifies *inp @*/</span>
<a name="l00044"></a>00044 {
<a name="l00045"></a>00045     <span class="keywordtype">long</span> addr;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     addr = inet_addr(cp);
<a name="l00048"></a>00048     <span class="keywordflow">if</span> (addr == ((<span class="keywordtype">long</span>) -1)) <span class="keywordflow">return</span> 0;
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     memcpy(inp, &amp;addr, <span class="keyword">sizeof</span>(addr));
<a name="l00051"></a>00051     <span class="keywordflow">return</span> 1;
<a name="l00052"></a>00052 }
<a name="l00053"></a>00053 <span class="preprocessor">#endif</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a>00055 <span class="preprocessor">#if defined(USE_ALT_DNS) &amp;&amp; USE_ALT_DNS</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span><span class="preprocessor">#include "dns.h"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#endif</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &lt;<a class="code" href="rpmio__internal_8h.html">rpmio_internal.h</a>&gt;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#undef  fdFileno</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#undef  fdOpen</span>
<a name="l00062"></a><a class="code" href="rpmio_8c.html#4c1fcf2fbff64cf829bd61c90642fc42">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define fdOpen  __fdOpen</span>
<a name="l00063"></a>00063 <span class="preprocessor"></span><span class="preprocessor">#undef  fdRead</span>
<a name="l00064"></a><a class="code" href="rpmio_8c.html#6ef797fdef2a33b8657eede1910145a5">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define fdRead  __fdRead</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#undef  fdWrite</span>
<a name="l00066"></a><a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define fdWrite __fdWrite</span>
<a name="l00067"></a>00067 <span class="preprocessor"></span><span class="preprocessor">#undef  fdClose</span>
<a name="l00068"></a><a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define fdClose __fdClose</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &lt;rpmdav.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include "<a class="code" href="ugid_8h.html">ugid.h</a>"</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include "<a class="code" href="rpmmessages_8h.html">rpmmessages.h</a>"</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00075"></a>00075 
<a name="l00076"></a>00076 <span class="comment">/*@access FILE @*/</span>      <span class="comment">/* XXX to permit comparison/conversion with void *. */</span>
<a name="l00077"></a>00077 <span class="comment">/*@access urlinfo @*/</span>
<a name="l00078"></a>00078 <span class="comment">/*@access FDSTAT_t @*/</span>
<a name="l00079"></a>00079 
<a name="l00080"></a><a class="code" href="rpmio_8c.html#69136a223a4fd132f25e271ce53aef27">00080</a> <span class="preprocessor">#define FDNREFS(fd)     (fd ? ((FD_t)fd)-&gt;nrefs : -9)</span>
<a name="l00081"></a><a class="code" href="rpmio_8c.html#24461c76daf77f140c768105762cf9be">00081</a> <span class="preprocessor"></span><span class="preprocessor">#define FDTO(fd)        (fd ? ((FD_t)fd)-&gt;rd_timeoutsecs : -99)</span>
<a name="l00082"></a><a class="code" href="rpmio_8c.html#5e229e76711f921ef3ddde578b13570f">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define FDCPIOPOS(fd)   (fd ? ((FD_t)fd)-&gt;fd_cpioPos : -99)</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="rpmio_8c.html#e6da4ead36aaca357049bc243ffa3327">00084</a> <span class="preprocessor">#define FDONLY(fd)      assert(fdGetIo(fd) == fdio)</span>
<a name="l00085"></a><a class="code" href="rpmio_8c.html#192a662aa997ccd8f413bac184053342">00085</a> <span class="preprocessor"></span><span class="preprocessor">#define GZDONLY(fd)     assert(fdGetIo(fd) == gzdio)</span>
<a name="l00086"></a><a class="code" href="rpmio_8c.html#dcedc97818000c63f87b249151ad1f19">00086</a> <span class="preprocessor"></span><span class="preprocessor">#define BZDONLY(fd)     assert(fdGetIo(fd) == bzdio)</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="rpmio_8c.html#26c954164d1681f609d3f9a0e9d2b1a8">00088</a> <span class="preprocessor">#define UFDONLY(fd)     </span><span class="comment">/* assert(fdGetIo(fd) == ufdio) */</span>
<a name="l00089"></a>00089 
<a name="l00090"></a><a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">00090</a> <span class="preprocessor">#define fdGetFILE(_fd)  ((FILE *)fdGetFp(_fd))</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>
<a name="l00094"></a>00094 <span class="comment">/*@unchecked@*/</span>
<a name="l00095"></a>00095 <span class="preprocessor">#if _USE_LIBIO</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a> = 0;
<a name="l00097"></a>00097 <span class="preprocessor">#else</span>
<a name="l00098"></a><a class="code" href="rpmio_8c.html#8d00cce32160aa23a96acdf43831958c">00098</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a> = 1;
<a name="l00099"></a>00099 <span class="preprocessor">#endif</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a><a class="code" href="rpmio_8c.html#8450159bfc9b50b1431b588ca9f2ff03">00101</a> <span class="preprocessor">#define TIMEOUT_SECS 60</span>
<a name="l00102"></a>00102 <span class="preprocessor"></span>
<a name="l00105"></a>00105 <span class="comment">/*@unchecked@*/</span>
<a name="l00106"></a><a class="code" href="rpmio_8c.html#e9746945efef21a62e0a404fe440962b">00106</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#e9746945efef21a62e0a404fe440962b">ftpTimeoutSecs</a> = <a class="code" href="rpmio_8c.html#8450159bfc9b50b1431b588ca9f2ff03">TIMEOUT_SECS</a>;
<a name="l00107"></a>00107 
<a name="l00110"></a>00110 <span class="comment">/*@unchecked@*/</span>
<a name="l00111"></a><a class="code" href="rpmio_8c.html#8d3ed96efb923a51905969fee4460a16">00111</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#8d3ed96efb923a51905969fee4460a16">httpTimeoutSecs</a> = <a class="code" href="rpmio_8c.html#8450159bfc9b50b1431b588ca9f2ff03">TIMEOUT_SECS</a>;
<a name="l00112"></a>00112 
<a name="l00115"></a>00115 <span class="comment">/*@unchecked@*/</span>
<a name="l00116"></a><a class="code" href="rpmio__internal_8h.html#2d5b915e8c5d750401c5720dc28bf206">00116</a> <span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a> = 0;
<a name="l00117"></a>00117 
<a name="l00120"></a>00120 <span class="comment">/*@unchecked@*/</span>
<a name="l00121"></a><a class="code" href="rpmio__internal_8h.html#c07495b0f9a93d6a7487859d9a8c6157">00121</a> <span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#c07495b0f9a93d6a7487859d9a8c6157">_av_debug</a> = 0;
<a name="l00122"></a>00122 
<a name="l00125"></a>00125 <span class="comment">/*@unchecked@*/</span>
<a name="l00126"></a><a class="code" href="rpmio__internal_8h.html#adaf57ff8960c1dbab523ea7c63ef621">00126</a> <span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#adaf57ff8960c1dbab523ea7c63ef621">_ftp_debug</a> = 0;
<a name="l00127"></a>00127 
<a name="l00130"></a>00130 <span class="comment">/*@unchecked@*/</span>
<a name="l00131"></a><a class="code" href="rpmio__internal_8h.html#6e350417e29d996fcf79179a7a05a19e">00131</a> <span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#6e350417e29d996fcf79179a7a05a19e">_dav_debug</a> = 0;
<a name="l00132"></a>00132 
<a name="l00138"></a>00138 <span class="comment">/*@unused@*/</span> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> *
<a name="l00139"></a><a class="code" href="rpmio_8c.html#d608c2923552dbeeb832133a9a289bb7">00139</a> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(<span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span> <span class="comment">/*@out@*/</span> <span class="keyword">const</span> <span class="keywordtype">void</span> * p)
<a name="l00140"></a>00140         <span class="comment">/*@modifies p@*/</span>
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142     <span class="keywordflow">if</span> (p != NULL)      free((<span class="keywordtype">void</span> *)p);
<a name="l00143"></a>00143     <span class="keywordflow">return</span> NULL;
<a name="l00144"></a>00144 }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146 <span class="comment">/* =============================================================== */</span>
<a name="l00147"></a>00147 
<a name="l00148"></a>00148 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00149"></a><a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">00149</a> <span class="keyword">static</span> <span class="comment">/*@observer@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(<span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l00150"></a>00150         <span class="comment">/*@*/</span>
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <span class="keyword">static</span> <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00153"></a>00153     <span class="keywordtype">char</span> *be = buf;
<a name="l00154"></a>00154     <span class="keywordtype">int</span> i;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l00157"></a>00157     <span class="keywordflow">if</span> (fd == NULL)
<a name="l00158"></a>00158         <span class="keywordflow">return</span> buf;
<a name="l00159"></a>00159 
<a name="l00160"></a>00160 <span class="preprocessor">#ifdef DYING</span>
<a name="l00161"></a>00161 <span class="preprocessor"></span>    sprintf(be, <span class="stringliteral">"fd %p"</span>, fd);   be += strlen(be);
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> &gt;= 0) {
<a name="l00163"></a>00163         sprintf(be, <span class="stringliteral">" secs %d"</span>, fd-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a>);
<a name="l00164"></a>00164         be += strlen(be);
<a name="l00165"></a>00165     }
<a name="l00166"></a>00166 <span class="preprocessor">#endif</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> != -1) {
<a name="l00168"></a>00168         sprintf(be, <span class="stringliteral">" clen %d"</span>, (<span class="keywordtype">int</span>)fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a>);
<a name="l00169"></a>00169         be += strlen(be);
<a name="l00170"></a>00170      }
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a>) {
<a name="l00172"></a>00172         strcpy(be, <span class="stringliteral">" chunked"</span>);
<a name="l00173"></a>00173         be += strlen(be);
<a name="l00174"></a>00174      }
<a name="l00175"></a>00175     *be++ = <span class="charliteral">'\t'</span>;
<a name="l00176"></a>00176     <span class="keywordflow">for</span> (i = fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>; i &gt;= 0; i--) {
<a name="l00177"></a>00177         <a class="code" href="struct__FDSTACK__s.html">FDSTACK_t</a> * fps = &amp;fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[i];
<a name="l00178"></a>00178         <span class="keywordflow">if</span> (i != fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>)
<a name="l00179"></a>00179             *be++ = <span class="charliteral">' '</span>;
<a name="l00180"></a>00180         *be++ = <span class="charliteral">'|'</span>;
<a name="l00181"></a>00181         *be++ = <span class="charliteral">' '</span>;
<a name="l00182"></a>00182         <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>) {
<a name="l00183"></a>00183             sprintf(be, <span class="stringliteral">"FD %d fp %p"</span>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>);
<a name="l00184"></a>00184         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>) {
<a name="l00185"></a>00185             sprintf(be, <span class="stringliteral">"UFD %d fp %p"</span>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>);
<a name="l00186"></a>00186         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8h.html#8006ed5e13305414c48d5bddd32eda87">gzdio</a>) {
<a name="l00187"></a>00187             sprintf(be, <span class="stringliteral">"GZD %p fdno %d"</span>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>);
<a name="l00188"></a>00188 <span class="preprocessor">#if HAVE_BZLIB_H</span>
<a name="l00189"></a>00189 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8h.html#708b90fe8836a10b2983dcb4ca3c198e">bzdio</a>) {
<a name="l00190"></a>00190             sprintf(be, <span class="stringliteral">"BZD %p fdno %d"</span>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>);
<a name="l00191"></a>00191 <span class="preprocessor">#endif</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>) {
<a name="l00193"></a>00193             <span class="comment">/*@+voidabstract@*/</span>
<a name="l00194"></a>00194             sprintf(be, <span class="stringliteral">"%s %p(%d) fdno %d"</span>,
<a name="l00195"></a>00195                 (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a> &lt; 0 ? <span class="stringliteral">"LIBIO"</span> : <span class="stringliteral">"FP"</span>),
<a name="l00196"></a>00196                 fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>, fileno(((FILE *)fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>)), fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>);
<a name="l00197"></a>00197             <span class="comment">/*@=voidabstract@*/</span>
<a name="l00198"></a>00198         } <span class="keywordflow">else</span> {
<a name="l00199"></a>00199             sprintf(be, <span class="stringliteral">"??? io %p fp %p fdno %d ???"</span>,
<a name="l00200"></a>00200                 fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>, fps-&gt;<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>);
<a name="l00201"></a>00201         }
<a name="l00202"></a>00202         be += strlen(be);
<a name="l00203"></a>00203         *be = <span class="charliteral">'\0'</span>;
<a name="l00204"></a>00204     }
<a name="l00205"></a>00205     <span class="keywordflow">return</span> buf;
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209 <span class="comment">/* =============================================================== */</span>
<a name="l00210"></a><a class="code" href="rpmio_8h.html#1fa5444b2f4f7abbafdd768036b62fec">00210</a> off_t <a class="code" href="rpmio_8c.html#1fa5444b2f4f7abbafdd768036b62fec">fdSize</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l00211"></a>00211 {
<a name="l00212"></a>00212     <span class="keyword">struct </span>stat sb;
<a name="l00213"></a>00213     off_t rc = -1; 
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="preprocessor">#ifdef  NOISY</span>
<a name="l00216"></a>00216 <span class="preprocessor"></span><a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(0, (stderr, <span class="stringliteral">"==&gt;\tfdSize(%p) rc %ld\n"</span>, fd, (<span class="keywordtype">long</span>)rc));
<a name="l00217"></a>00217 <span class="preprocessor">#endif</span>
<a name="l00218"></a>00218 <span class="preprocessor"></span>    <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> &gt;= 0)
<a name="l00220"></a>00220         rc = fd-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a>;
<a name="l00221"></a>00221     <span class="keywordflow">else</span> <span class="keywordflow">switch</span> (fd-&gt;<a class="code" href="struct__FD__s.html#31c0f4a49be2e2eed552d198a10fcf12">urlType</a>) {
<a name="l00222"></a>00222     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l00223"></a>00223     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l00224"></a>00224         <span class="keywordflow">if</span> (fstat(<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(fd), &amp;sb) == 0)
<a name="l00225"></a>00225             rc = sb.st_size;
<a name="l00226"></a>00226         <span class="comment">/*@fallthrough@*/</span>
<a name="l00227"></a>00227     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l00228"></a>00228     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l00229"></a>00229     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l00230"></a>00230     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l00231"></a>00231     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l00232"></a>00232         <span class="keywordflow">break</span>;
<a name="l00233"></a>00233     }
<a name="l00234"></a>00234     <span class="keywordflow">return</span> rc;
<a name="l00235"></a>00235 }
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="rpmio_8h.html#671e4056425535bd1421347a5bcdacf9">00237</a> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#671e4056425535bd1421347a5bcdacf9">fdDup</a>(<span class="keywordtype">int</span> fdno)
<a name="l00238"></a>00238 {
<a name="l00239"></a>00239     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l00240"></a>00240     <span class="keywordtype">int</span> nfdno;
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keywordflow">if</span> ((nfdno = dup(fdno)) &lt; 0)
<a name="l00243"></a>00243         <span class="keywordflow">return</span> NULL;
<a name="l00244"></a>00244     fd = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"open (fdDup)"</span>);
<a name="l00245"></a>00245     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(fd, nfdno);
<a name="l00246"></a>00246 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; fdDup(%d) fd %p %s\n"</span>, fdno, (fd ? fd : NULL), <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00247"></a>00247     <span class="comment">/*@-refcounttrans@*/</span> <span class="keywordflow">return</span> fd; <span class="comment">/*@=refcounttrans@*/</span>
<a name="l00248"></a>00248 }
<a name="l00249"></a>00249 
<a name="l00250"></a><a class="code" href="rpmio_8c.html#13ecf86b6a5b2681d1c310bb889453a6">00250</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@unused@*/</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#13ecf86b6a5b2681d1c310bb889453a6">fdSeekNot</a>(<span class="keywordtype">void</span> * cookie,
<a name="l00251"></a>00251                 <span class="comment">/*@unused@*/</span> <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos,  <span class="comment">/*@unused@*/</span> <span class="keywordtype">int</span> whence)
<a name="l00252"></a>00252         <span class="comment">/*@*/</span>
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00255"></a>00255     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);         <span class="comment">/* XXX keep gcc quiet */</span>
<a name="l00256"></a>00256     <span class="keywordflow">return</span> -2;
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="preprocessor">#ifdef UNUSED</span>
<a name="l00260"></a>00260 <span class="preprocessor"></span>FILE *fdFdopen(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmode)
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00263"></a>00263     <span class="keywordtype">int</span> fdno;
<a name="l00264"></a>00264     FILE * fp;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="keywordflow">if</span> (fmode == NULL) <span class="keywordflow">return</span> NULL;
<a name="l00267"></a>00267     fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd);
<a name="l00268"></a>00268     <span class="keywordflow">if</span> (fdno &lt; 0) <span class="keywordflow">return</span> NULL;
<a name="l00269"></a>00269     fp = fdopen(fdno, fmode);
<a name="l00270"></a>00270 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; fdFdopen(%p,\"%s\") fdno %d -&gt; fp %p fdno %d\n"</span>, cookie, fmode, fdno, fp, fileno(fp)));
<a name="l00271"></a>00271     fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open (fdFdopen)"</span>);
<a name="l00272"></a>00272     <span class="keywordflow">return</span> fp;
<a name="l00273"></a>00273 }
<a name="l00274"></a>00274 <span class="preprocessor">#endif</span>
<a name="l00275"></a>00275 <span class="preprocessor"></span>
<a name="l00276"></a>00276 <span class="comment">/* =============================================================== */</span>
<a name="l00277"></a>00277 <span class="comment">/*@-mustmod@*/</span> <span class="comment">/* FIX: cookie is modified */</span>
<a name="l00278"></a><a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">00278</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> * msg,
<a name="l00279"></a>00279                 <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="keywordtype">unsigned</span> line)
<a name="l00280"></a>00280         <span class="comment">/*@modifies *cookie @*/</span>
<a name="l00281"></a>00281 {
<a name="l00282"></a>00282     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l00283"></a>00283 <span class="keywordflow">if</span> (cookie == NULL)
<a name="l00284"></a>00284     <span class="comment">/*@-castexpose@*/</span>
<a name="l00285"></a>00285 <a class="code" href="rpmio__internal_8h.html#64d2c721e09e970b557e9bb4ef01b398">DBGREFS</a>(0, (stderr, <span class="stringliteral">"--&gt; fd  %p ++ %d %s at %s:%u\n"</span>, cookie, <a class="code" href="rpmio_8c.html#69136a223a4fd132f25e271ce53aef27">FDNREFS</a>(cookie)+1, msg, file, line));
<a name="l00286"></a>00286     <span class="comment">/*@=castexpose@*/</span>
<a name="l00287"></a>00287     fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00288"></a>00288     <span class="keywordflow">if</span> (fd) {
<a name="l00289"></a>00289         fd-&gt;<a class="code" href="struct__FD__s.html#2ccba788a8ecadf0c562c7a35df25361">nrefs</a>++;
<a name="l00290"></a>00290 <a class="code" href="rpmio__internal_8h.html#64d2c721e09e970b557e9bb4ef01b398">DBGREFS</a>(fd, (stderr, <span class="stringliteral">"--&gt; fd  %p ++ %d %s at %s:%u %s\n"</span>, fd, fd-&gt;<a class="code" href="struct__FD__s.html#2ccba788a8ecadf0c562c7a35df25361">nrefs</a>, msg, file, line, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00291"></a>00291     }
<a name="l00292"></a>00292     <span class="keywordflow">return</span> fd;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 <span class="comment">/*@=mustmod@*/</span>
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@null@*/</span>
<a name="l00297"></a><a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">00297</a> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">XfdFree</a>( <span class="comment">/*@killref@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg,
<a name="l00298"></a>00298                 <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="keywordtype">unsigned</span> line)
<a name="l00299"></a>00299         <span class="comment">/*@modifies fd @*/</span>
<a name="l00300"></a>00300 {
<a name="l00301"></a>00301         <span class="keywordtype">int</span> i;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303 <span class="keywordflow">if</span> (fd == NULL)
<a name="l00304"></a>00304 <a class="code" href="rpmio__internal_8h.html#64d2c721e09e970b557e9bb4ef01b398">DBGREFS</a>(0, (stderr, <span class="stringliteral">"--&gt; fd  %p -- %d %s at %s:%u\n"</span>, fd, <a class="code" href="rpmio_8c.html#69136a223a4fd132f25e271ce53aef27">FDNREFS</a>(fd), msg, file, line));
<a name="l00305"></a>00305     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l00306"></a>00306     <span class="keywordflow">if</span> (fd) {
<a name="l00307"></a>00307 <a class="code" href="rpmio__internal_8h.html#64d2c721e09e970b557e9bb4ef01b398">DBGREFS</a>(fd, (stderr, <span class="stringliteral">"--&gt; fd  %p -- %d %s at %s:%u %s\n"</span>, fd, fd-&gt;nrefs, msg, file, line, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (--fd-&gt;nrefs &gt; 0)
<a name="l00309"></a>00309             <span class="comment">/*@-refcounttrans -retalias@*/</span> <span class="keywordflow">return</span> fd; <span class="comment">/*@=refcounttrans =retalias@*/</span>
<a name="l00310"></a>00310         fd-&gt;stats = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fd-&gt;stats);
<a name="l00311"></a>00311         <span class="keywordflow">for</span> (i = fd-&gt;ndigests - 1; i &gt;= 0; i--) {
<a name="l00312"></a>00312             <a class="code" href="struct__FDDIGEST__s.html">FDDIGEST_t</a> fddig = fd-&gt;digests + i;
<a name="l00313"></a>00313             <span class="keywordflow">if</span> (fddig-&gt;<a class="code" href="struct__FDDIGEST__s.html#f4f6a57577c71c0eaa8f20bd9aab82b5">hashctx</a> == NULL)
<a name="l00314"></a>00314                 <span class="keywordflow">continue</span>;
<a name="l00315"></a>00315             (void) <a class="code" href="group__rpmio.html#g13dcad611d1f0c8d57f8464ccff955f6" title="Return digest and destroy context.">rpmDigestFinal</a>(fddig-&gt;<a class="code" href="struct__FDDIGEST__s.html#f4f6a57577c71c0eaa8f20bd9aab82b5">hashctx</a>, NULL, NULL, 0);
<a name="l00316"></a>00316             fddig-&gt;<a class="code" href="struct__FDDIGEST__s.html#f4f6a57577c71c0eaa8f20bd9aab82b5">hashctx</a> = NULL;
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318         fd-&gt;ndigests = 0;
<a name="l00319"></a>00319         <span class="comment">/*@-refcounttrans@*/</span> free(fd); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l00320"></a>00320     }
<a name="l00321"></a>00321     <span class="keywordflow">return</span> NULL;
<a name="l00322"></a>00322 }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@null@*/</span>
<a name="l00325"></a><a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">00325</a> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">XfdNew</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * msg, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="keywordtype">unsigned</span> line)
<a name="l00326"></a>00326         <span class="comment">/*@globals internalState @*/</span>
<a name="l00327"></a>00327         <span class="comment">/*@modifies internalState @*/</span>
<a name="l00328"></a>00328 {
<a name="l00329"></a>00329     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*fd));
<a name="l00330"></a>00330     <span class="keywordflow">if</span> (fd == NULL) <span class="comment">/* XXX xmalloc never returns NULL */</span>
<a name="l00331"></a>00331         <span class="keywordflow">return</span> NULL;
<a name="l00332"></a>00332     fd-&gt;nrefs = 0;
<a name="l00333"></a>00333     fd-&gt;flags = 0;
<a name="l00334"></a>00334     fd-&gt;magic = <a class="code" href="rpmio__internal_8h.html#eed47a5d53b45db6470a676b1ec1d503">FDMAGIC</a>;
<a name="l00335"></a>00335     fd-&gt;urlType = <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337     fd-&gt;nfps = 0;
<a name="l00338"></a>00338     memset(fd-&gt;fps, 0, <span class="keyword">sizeof</span>(fd-&gt;fps));
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     fd-&gt;fps[0].io = <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>;
<a name="l00341"></a>00341     fd-&gt;fps[0].fp = NULL;
<a name="l00342"></a>00342     fd-&gt;fps[0].fdno = -1;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344     fd-&gt;url = NULL;
<a name="l00345"></a>00345     fd-&gt;rd_timeoutsecs = 1;     <span class="comment">/* XXX default value used to be -1 */</span>
<a name="l00346"></a>00346     fd-&gt;contentLength = fd-&gt;bytesRemain = -1;
<a name="l00347"></a>00347     fd-&gt;wr_chunked = 0;
<a name="l00348"></a>00348     fd-&gt;syserrno = 0;
<a name="l00349"></a>00349     fd-&gt;errcookie = NULL;
<a name="l00350"></a>00350     fd-&gt;stats = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*fd-&gt;stats));
<a name="l00351"></a>00351 
<a name="l00352"></a>00352     fd-&gt;ndigests = 0;
<a name="l00353"></a>00353     memset(fd-&gt;digests, 0, <span class="keyword">sizeof</span>(fd-&gt;digests));
<a name="l00354"></a>00354 
<a name="l00355"></a>00355     fd-&gt;ftpFileDoneNeeded = 0;
<a name="l00356"></a>00356     fd-&gt;firstFree = 0;
<a name="l00357"></a>00357     fd-&gt;fileSize = 0;
<a name="l00358"></a>00358     fd-&gt;fd_cpioPos = 0;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     <span class="keywordflow">return</span> <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>(fd, msg, file, line);
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 
<a name="l00363"></a><a class="code" href="rpmio_8c.html#6393b608235df93f25682e8f2ebf9d70">00363</a> <span class="keyword">static</span> ssize_t <a class="code" href="rpmio_8c.html#6ef797fdef2a33b8657eede1910145a5">fdRead</a>(<span class="keywordtype">void</span> * cookie, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l00364"></a>00364         <span class="comment">/*@globals errno, fileSystem, internalState @*/</span>
<a name="l00365"></a>00365         <span class="comment">/*@modifies buf, errno, fileSystem, internalState @*/</span>
<a name="l00366"></a>00366         <span class="comment">/*@requires maxSet(buf) &gt;= (count - 1) @*/</span>
<a name="l00367"></a>00367         <span class="comment">/*@ensures maxRead(buf) == result @*/</span>
<a name="l00368"></a>00368 {
<a name="l00369"></a>00369     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00370"></a>00370     ssize_t rc;
<a name="l00371"></a>00371 
<a name="l00372"></a>00372     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> 0; <span class="comment">/* XXX simulate EOF */</span>
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13f76ed3f89d0f2a6ed3dba717149020a1">FDSTAT_READ</a>);
<a name="l00375"></a>00375 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00376"></a>00376     <span class="comment">/* HACK: flimsy wiring for davRead */</span>
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL) {
<a name="l00378"></a>00378 <span class="preprocessor">#ifdef WITH_NEON</span>
<a name="l00379"></a>00379 <span class="preprocessor"></span>        rc = davRead(fd, buf, (count &gt; fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> ? fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> : count));
<a name="l00380"></a>00380 <span class="preprocessor">#else</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>        rc = -1;
<a name="l00382"></a>00382 <span class="preprocessor">#endif</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>        <span class="comment">/* XXX Chunked davRead EOF. */</span>
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (rc == 0)
<a name="l00385"></a>00385             fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> = 0;
<a name="l00386"></a>00386     } <span class="keywordflow">else</span>
<a name="l00387"></a>00387         rc = read(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd), buf, (count &gt; fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> ? fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> : count));
<a name="l00388"></a>00388 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00389"></a>00389     <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13f76ed3f89d0f2a6ed3dba717149020a1">FDSTAT_READ</a>, rc);
<a name="l00390"></a>00390 
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#95fedde211083585c3cbc36fcb875d37">ndigests</a> &amp;&amp; rc &gt; 0) <a class="code" href="group__rpmio.html#g975f61657e5110723b61dc5b6a693509" title="Update digest(s) attached to fd.">fdUpdateDigests</a>(fd, buf, rc);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tfdRead(%p,%p,%ld) rc %ld %s\n"</span>, cookie, buf, (<span class="keywordtype">long</span>)count, (<span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="keywordflow">return</span> rc;
<a name="l00396"></a>00396 }
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="rpmio_8c.html#664df72ef43befcb8eac25b8882fb4cc">00398</a> <span class="keyword">static</span> ssize_t <a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l00399"></a>00399         <span class="comment">/*@globals errno, fileSystem, internalState @*/</span>
<a name="l00400"></a>00400         <span class="comment">/*@modifies errno, fileSystem, internalState @*/</span>
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00403"></a>00403     <span class="keywordtype">int</span> fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd);
<a name="l00404"></a>00404     ssize_t rc;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> 0; <span class="comment">/* XXX simulate EOF */</span>
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#95fedde211083585c3cbc36fcb875d37">ndigests</a> &amp;&amp; count &gt; 0) <a class="code" href="group__rpmio.html#g975f61657e5110723b61dc5b6a693509" title="Update digest(s) attached to fd.">fdUpdateDigests</a>(fd, buf, count);
<a name="l00409"></a>00409 
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (count == 0) <span class="keywordflow">return</span> 0;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd137d176cf33c540d67c9688548aa341570">FDSTAT_WRITE</a>);
<a name="l00413"></a>00413 <span class="comment">/*@-boundsread@*/</span>
<a name="l00414"></a>00414     <span class="comment">/* HACK: flimsy wiring for davWrite */</span>
<a name="l00415"></a>00415     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL) {
<a name="l00416"></a>00416 <span class="preprocessor">#ifdef WITH_NEON</span>
<a name="l00417"></a>00417 <span class="preprocessor"></span>        rc = davWrite(fd, buf, (count &gt; fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> ? fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> : count));
<a name="l00418"></a>00418 <span class="preprocessor">#else</span>
<a name="l00419"></a>00419 <span class="preprocessor"></span>        <span class="keywordflow">return</span> -1;
<a name="l00420"></a>00420 <span class="preprocessor">#endif</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span>    } <span class="keywordflow">else</span>
<a name="l00422"></a>00422         rc = write(fdno, buf, (count &gt; fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> ? fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> : count));
<a name="l00423"></a>00423 <span class="comment">/*@=boundsread@*/</span>
<a name="l00424"></a>00424     <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd137d176cf33c540d67c9688548aa341570">FDSTAT_WRITE</a>, rc);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tfdWrite(%p,%p,%ld) rc %ld %s\n"</span>, cookie, buf, (<span class="keywordtype">long</span>)count, (<span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     <span class="keywordflow">return</span> rc;
<a name="l00429"></a>00429 }
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="rpmio_8c.html#a80cc4e0b022c3c26430198574847989">00431</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#a80cc4e0b022c3c26430198574847989">fdSeek</a>(<span class="keywordtype">void</span> * cookie, <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos, <span class="keywordtype">int</span> whence)
<a name="l00432"></a>00432         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l00433"></a>00433         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435 <span class="preprocessor">#ifdef USE_COOKIE_SEEK_POINTER</span>
<a name="l00436"></a>00436 <span class="preprocessor"></span>    _IO_off64_t p = *pos;
<a name="l00437"></a>00437 <span class="preprocessor">#else</span>
<a name="l00438"></a>00438 <span class="preprocessor"></span>    off_t p = pos;
<a name="l00439"></a>00439 <span class="preprocessor">#endif</span>
<a name="l00440"></a>00440 <span class="preprocessor"></span>    <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00441"></a>00441     off_t rc;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     assert(fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == -1);      <span class="comment">/* XXX FIXME fadio only for now */</span>
<a name="l00444"></a>00444     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13913aa37078e2181ae94b56e4afeabfd0">FDSTAT_SEEK</a>);
<a name="l00445"></a>00445     rc = lseek(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd), p, whence);
<a name="l00446"></a>00446     <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13913aa37078e2181ae94b56e4afeabfd0">FDSTAT_SEEK</a>, rc);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tfdSeek(%p,%ld,%d) rc %lx %s\n"</span>, cookie, (<span class="keywordtype">long</span>)p, whence, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00449"></a>00449 
<a name="l00450"></a>00450     <span class="keywordflow">return</span> rc;
<a name="l00451"></a>00451 }
<a name="l00452"></a>00452 
<a name="l00453"></a><a class="code" href="rpmio_8c.html#8b1bfbf62a425aa5fd8d60e1bc4cd878">00453</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>( <span class="comment">/*@only@*/</span> <span class="keywordtype">void</span> * cookie)
<a name="l00454"></a>00454         <span class="comment">/*@globals errno, fileSystem, systemState, internalState @*/</span>
<a name="l00455"></a>00455         <span class="comment">/*@modifies errno, fileSystem, systemState, internalState @*/</span>
<a name="l00456"></a>00456 {
<a name="l00457"></a>00457     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l00458"></a>00458     <span class="keywordtype">int</span> fdno;
<a name="l00459"></a>00459     <span class="keywordtype">int</span> rc;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461     <span class="keywordflow">if</span> (cookie == NULL) <span class="keywordflow">return</span> -2;
<a name="l00462"></a>00462     fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l00463"></a>00463     fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(fd, -1);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd1326569f04d9a438c2b088e4716b755c4b">FDSTAT_CLOSE</a>);
<a name="l00468"></a>00468     <span class="comment">/* HACK: flimsy wiring for davClose */</span>
<a name="l00469"></a>00469 <span class="comment">/*@-branchstate@*/</span>
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL) {
<a name="l00471"></a>00471 <span class="preprocessor">#ifdef WITH_NEON</span>
<a name="l00472"></a>00472 <span class="preprocessor"></span>        rc = davClose(fd);
<a name="l00473"></a>00473 <span class="preprocessor">#else</span>
<a name="l00474"></a>00474 <span class="preprocessor"></span>        <span class="keywordflow">return</span> -1;
<a name="l00475"></a>00475 <span class="preprocessor">#endif</span>
<a name="l00476"></a>00476 <span class="preprocessor"></span>    } <span class="keywordflow">else</span>
<a name="l00477"></a>00477         rc = ((fdno &gt;= 0) ? close(fdno) : -2);
<a name="l00478"></a>00478 <span class="comment">/*@=branchstate@*/</span>
<a name="l00479"></a>00479     <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd1326569f04d9a438c2b088e4716b755c4b">FDSTAT_CLOSE</a>, rc);
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tfdClose(%p) rc %lx %s\n"</span>, (fd ? fd : NULL), (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00482"></a>00482 
<a name="l00483"></a>00483     fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open (fdClose)"</span>);
<a name="l00484"></a>00484     <span class="keywordflow">return</span> rc;
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="rpmio_8c.html#c218fc43a85bc65ac74248b8b35dc8e6">00487</a> <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#4c1fcf2fbff64cf829bd61c90642fc42">fdOpen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keywordtype">int</span> flags, mode_t mode)
<a name="l00488"></a>00488         <span class="comment">/*@globals errno, fileSystem, internalState @*/</span>
<a name="l00489"></a>00489         <span class="comment">/*@modifies errno, fileSystem, internalState @*/</span>
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l00492"></a>00492     <span class="keywordtype">int</span> fdno;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     fdno = open(path, flags, mode);
<a name="l00495"></a>00495     <span class="keywordflow">if</span> (fdno &lt; 0) <span class="keywordflow">return</span> NULL;
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (fcntl(fdno, F_SETFD, FD_CLOEXEC)) {
<a name="l00497"></a>00497         (void) close(fdno);
<a name="l00498"></a>00498         <span class="keywordflow">return</span> NULL;
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500     fd = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"open (fdOpen)"</span>);
<a name="l00501"></a>00501     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(fd, fdno);
<a name="l00502"></a>00502     fd-&gt;<a class="code" href="struct__FD__s.html#701a48c518edd61185edd44a64cb348c">flags</a> = flags;
<a name="l00503"></a>00503 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tfdOpen(\"%s\",%x,0%o) %s\n"</span>, path, (<span class="keywordtype">unsigned</span>)flags, (<span class="keywordtype">unsigned</span>)mode, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l00504"></a>00504     <span class="comment">/*@-refcounttrans@*/</span> <span class="keywordflow">return</span> fd; <span class="comment">/*@=refcounttrans@*/</span>
<a name="l00505"></a>00505 }
<a name="l00506"></a>00506 
<a name="l00507"></a>00507 <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l00508"></a><a class="code" href="rpmio_8c.html#bf6cc6cdc530ac44e690b6de7c993376">00508</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFDIO__s.html">FDIO_s</a> <a class="code" href="rpmio_8c.html#bf6cc6cdc530ac44e690b6de7c993376">fdio_s</a> = {
<a name="l00509"></a>00509   <a class="code" href="rpmio_8c.html#6ef797fdef2a33b8657eede1910145a5">fdRead</a>, <a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>, <a class="code" href="rpmio_8c.html#a80cc4e0b022c3c26430198574847989">fdSeek</a>, <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>, <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>, <a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">XfdFree</a>, <a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">XfdNew</a>, <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>,
<a name="l00510"></a>00510   <a class="code" href="rpmio_8c.html#4c1fcf2fbff64cf829bd61c90642fc42">fdOpen</a>, NULL, <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>, NULL,  mkdir, chdir, rmdir, rename, unlink
<a name="l00511"></a>00511 };
<a name="l00512"></a>00512 <span class="comment">/*@=type@*/</span>
<a name="l00513"></a><a class="code" href="rpmio_8h.html#3631e87ad697d5acfce8446af8b73c22">00513</a> <a class="code" href="structFDIO__s.html">FDIO_t</a> <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a> = <span class="comment">/*@-compmempass@*/</span> &amp;<a class="code" href="rpmio_8c.html#bf6cc6cdc530ac44e690b6de7c993376">fdio_s</a> <span class="comment">/*@=compmempass@*/</span> ;
<a name="l00514"></a>00514 
<a name="l00515"></a><a class="code" href="rpmio_8h.html#74370513bf226276d69c6837ce6872b9">00515</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#74370513bf226276d69c6837ce6872b9">fdWritable</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd, <span class="keywordtype">int</span> secs)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517     <span class="keywordtype">int</span> fdno;
<a name="l00518"></a>00518     <span class="keywordtype">int</span> rc;
<a name="l00519"></a>00519 <span class="preprocessor">#if HAVE_POLL_H</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>    <span class="keywordtype">int</span> msecs = (secs &gt;= 0 ? (1000 * secs) : -1);
<a name="l00521"></a>00521     <span class="keyword">struct </span>pollfd wrfds;
<a name="l00522"></a>00522 <span class="preprocessor">#else</span>
<a name="l00523"></a>00523 <span class="preprocessor"></span>    <span class="keyword">struct </span>timeval timeout, *tvp = (secs &gt;= 0 ? &amp;timeout : NULL);
<a name="l00524"></a>00524     fd_set wrfds;
<a name="l00525"></a>00525     FD_ZERO(&amp;wrfds);
<a name="l00526"></a>00526 <span class="preprocessor">#endif</span>
<a name="l00527"></a>00527 <span class="preprocessor"></span>        
<a name="l00528"></a>00528     <span class="comment">/* HACK: flimsy wiring for davWrite */</span>
<a name="l00529"></a>00529     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL)
<a name="l00530"></a>00530         <span class="keywordflow">return</span> 1;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">if</span> ((fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd)) &lt; 0)
<a name="l00533"></a>00533         <span class="keywordflow">return</span> -1;      <span class="comment">/* XXX W2DO? */</span>
<a name="l00534"></a>00534         
<a name="l00535"></a>00535     <span class="keywordflow">do</span> {
<a name="l00536"></a>00536 <span class="preprocessor">#if HAVE_POLL_H</span>
<a name="l00537"></a>00537 <span class="preprocessor"></span>        wrfds.fd = fdno;
<a name="l00538"></a>00538         wrfds.events = POLLOUT;
<a name="l00539"></a>00539         wrfds.revents = 0;
<a name="l00540"></a>00540         rc = poll(&amp;wrfds, 1, msecs);
<a name="l00541"></a>00541 <span class="preprocessor">#else</span>
<a name="l00542"></a>00542 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (tvp) {
<a name="l00543"></a>00543             tvp-&gt;tv_sec = secs;
<a name="l00544"></a>00544             tvp-&gt;tv_usec = 0;
<a name="l00545"></a>00545         }
<a name="l00546"></a>00546         FD_SET(fdno, &amp;wrfds);
<a name="l00547"></a>00547 <span class="comment">/*@-compdef -nullpass@*/</span>
<a name="l00548"></a>00548         rc = select(fdno + 1, NULL, &amp;wrfds, NULL, tvp);
<a name="l00549"></a>00549 <span class="comment">/*@=compdef =nullpass@*/</span>
<a name="l00550"></a>00550 <span class="preprocessor">#endif</span>
<a name="l00551"></a>00551 <span class="preprocessor"></span>
<a name="l00552"></a>00552         <span class="comment">/* HACK: EBADF on PUT chunked termination from ufdClose. */</span>
<a name="l00553"></a>00553 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a> &amp;&amp; !(rc == 1 &amp;&amp; <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == 0))
<a name="l00554"></a>00554 fprintf(stderr, <span class="stringliteral">"*** fdWritable fdno %d rc %d %s\n"</span>, fdno, rc, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l00555"></a>00555         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00556"></a>00556             <span class="keywordflow">switch</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l00557"></a>00557             <span class="keywordflow">case</span> EINTR:
<a name="l00558"></a>00558                 <span class="keywordflow">continue</span>;
<a name="l00559"></a>00559                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00560"></a>00560             <span class="keywordflow">default</span>:
<a name="l00561"></a>00561                 <span class="keywordflow">return</span> rc;
<a name="l00562"></a>00562                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00563"></a>00563             }
<a name="l00564"></a>00564         }
<a name="l00565"></a>00565         <span class="keywordflow">return</span> rc;
<a name="l00566"></a>00566     } <span class="keywordflow">while</span> (1);
<a name="l00567"></a>00567     <span class="comment">/*@notreached@*/</span>
<a name="l00568"></a>00568 }
<a name="l00569"></a>00569 
<a name="l00570"></a><a class="code" href="rpmio_8h.html#e7bf383d1ec94b1ecfa584191ed09de1">00570</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#e7bf383d1ec94b1ecfa584191ed09de1">fdReadable</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd, <span class="keywordtype">int</span> secs)
<a name="l00571"></a>00571 {
<a name="l00572"></a>00572     <span class="keywordtype">int</span> fdno;
<a name="l00573"></a>00573     <span class="keywordtype">int</span> rc;
<a name="l00574"></a>00574 <span class="preprocessor">#if HAVE_POLL_H</span>
<a name="l00575"></a>00575 <span class="preprocessor"></span>    <span class="keywordtype">int</span> msecs = (secs &gt;= 0 ? (1000 * secs) : -1);
<a name="l00576"></a>00576     <span class="keyword">struct </span>pollfd rdfds;
<a name="l00577"></a>00577 <span class="preprocessor">#else</span>
<a name="l00578"></a>00578 <span class="preprocessor"></span>    <span class="keyword">struct </span>timeval timeout, *tvp = (secs &gt;= 0 ? &amp;timeout : NULL);
<a name="l00579"></a>00579     fd_set rdfds;
<a name="l00580"></a>00580     FD_ZERO(&amp;rdfds);
<a name="l00581"></a>00581 <span class="preprocessor">#endif</span>
<a name="l00582"></a>00582 <span class="preprocessor"></span>
<a name="l00583"></a>00583     <span class="comment">/* HACK: flimsy wiring for davRead */</span>
<a name="l00584"></a>00584     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL)
<a name="l00585"></a>00585         <span class="keywordflow">return</span> 1;
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="keywordflow">if</span> ((fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd)) &lt; 0)
<a name="l00588"></a>00588         <span class="keywordflow">return</span> -1;      <span class="comment">/* XXX W2DO? */</span>
<a name="l00589"></a>00589         
<a name="l00590"></a>00590     <span class="keywordflow">do</span> {
<a name="l00591"></a>00591 <span class="preprocessor">#if HAVE_POLL_H</span>
<a name="l00592"></a>00592 <span class="preprocessor"></span>        rdfds.fd = fdno;
<a name="l00593"></a>00593         rdfds.events = POLLIN;
<a name="l00594"></a>00594         rdfds.revents = 0;
<a name="l00595"></a>00595         rc = poll(&amp;rdfds, 1, msecs);
<a name="l00596"></a>00596 <span class="preprocessor">#else</span>
<a name="l00597"></a>00597 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (tvp) {
<a name="l00598"></a>00598             tvp-&gt;tv_sec = secs;
<a name="l00599"></a>00599             tvp-&gt;tv_usec = 0;
<a name="l00600"></a>00600         }
<a name="l00601"></a>00601         FD_SET(fdno, &amp;rdfds);
<a name="l00602"></a>00602         <span class="comment">/*@-compdef -nullpass@*/</span>
<a name="l00603"></a>00603         rc = select(fdno + 1, &amp;rdfds, NULL, NULL, tvp);
<a name="l00604"></a>00604         <span class="comment">/*@=compdef =nullpass@*/</span>
<a name="l00605"></a>00605 <span class="preprocessor">#endif</span>
<a name="l00606"></a>00606 <span class="preprocessor"></span>
<a name="l00607"></a>00607         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00608"></a>00608             <span class="keywordflow">switch</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l00609"></a>00609             <span class="keywordflow">case</span> EINTR:
<a name="l00610"></a>00610                 <span class="keywordflow">continue</span>;
<a name="l00611"></a>00611                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00612"></a>00612             <span class="keywordflow">default</span>:
<a name="l00613"></a>00613                 <span class="keywordflow">return</span> rc;
<a name="l00614"></a>00614                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00615"></a>00615             }
<a name="l00616"></a>00616         }
<a name="l00617"></a>00617         <span class="keywordflow">return</span> rc;
<a name="l00618"></a>00618     } <span class="keywordflow">while</span> (1);
<a name="l00619"></a>00619     <span class="comment">/*@notreached@*/</span>
<a name="l00620"></a>00620 }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00623"></a><a class="code" href="group__rpmio.html#gfed118f9abfd7d30ddc17d2970f0bca1">00623</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmio.html#gfed118f9abfd7d30ddc17d2970f0bca1">fdFgets</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd, <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> len)
<a name="l00624"></a>00624 {
<a name="l00625"></a>00625     <span class="keywordtype">int</span> fdno;
<a name="l00626"></a>00626     <span class="keywordtype">int</span> secs = fd-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a>;
<a name="l00627"></a>00627     <span class="keywordtype">size_t</span> nb = 0;
<a name="l00628"></a>00628     <span class="keywordtype">int</span> ec = 0;
<a name="l00629"></a>00629     <span class="keywordtype">char</span> lastchar = <span class="charliteral">'\0'</span>;
<a name="l00630"></a>00630 
<a name="l00631"></a>00631     <span class="keywordflow">if</span> ((fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd)) &lt; 0)
<a name="l00632"></a>00632         <span class="keywordflow">return</span> 0;       <span class="comment">/* XXX W2DO? */</span>
<a name="l00633"></a>00633         
<a name="l00634"></a>00634     <span class="keywordflow">do</span> {
<a name="l00635"></a>00635         <span class="keywordtype">int</span> rc;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         <span class="comment">/* Is there data to read? */</span>
<a name="l00638"></a>00638         rc = <a class="code" href="rpmio_8c.html#e7bf383d1ec94b1ecfa584191ed09de1">fdReadable</a>(fd, secs);
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="keywordflow">switch</span> (rc) {
<a name="l00641"></a>00641         <span class="keywordflow">case</span> -1:        <span class="comment">/* error */</span>
<a name="l00642"></a>00642             ec = -1;
<a name="l00643"></a>00643             <span class="keywordflow">continue</span>;
<a name="l00644"></a>00644             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00645"></a>00645         <span class="keywordflow">case</span>  0:        <span class="comment">/* timeout */</span>
<a name="l00646"></a>00646             ec = -1;
<a name="l00647"></a>00647             <span class="keywordflow">continue</span>;
<a name="l00648"></a>00648             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00649"></a>00649         <span class="keywordflow">default</span>:        <span class="comment">/* data to read */</span>
<a name="l00650"></a>00650             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00651"></a>00651         }
<a name="l00652"></a>00652 
<a name="l00653"></a>00653         <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = 0;
<a name="l00654"></a>00654 <span class="preprocessor">#ifdef  NOISY</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span>        rc = <a class="code" href="rpmio_8c.html#6ef797fdef2a33b8657eede1910145a5">fdRead</a>(fd, buf + nb, 1);
<a name="l00656"></a>00656 <span class="preprocessor">#else</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span>        rc = read(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd), buf + nb, 1);
<a name="l00658"></a>00658 <span class="preprocessor">#endif</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00660"></a>00660             fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l00661"></a>00661             <span class="keywordflow">switch</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l00662"></a>00662             <span class="keywordflow">case</span> EWOULDBLOCK:
<a name="l00663"></a>00663                 <span class="keywordflow">continue</span>;
<a name="l00664"></a>00664                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00665"></a>00665             <span class="keywordflow">default</span>:
<a name="l00666"></a>00666                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00667"></a>00667             }
<a name="l00668"></a>00668 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l00669"></a>00669 fprintf(stderr, <span class="stringliteral">"*** read: fd %p rc %d errno %d %s \"%s\"\n"</span>, fd, rc, <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>), buf);
<a name="l00670"></a>00670             ec = -1;
<a name="l00671"></a>00671             <span class="keywordflow">break</span>;
<a name="l00672"></a>00672         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0) {
<a name="l00673"></a>00673 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l00674"></a>00674 fprintf(stderr, <span class="stringliteral">"*** read: fd %p rc %d EOF errno %d %s \"%s\"\n"</span>, fd, rc, <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>), buf);
<a name="l00675"></a>00675             <span class="keywordflow">break</span>;
<a name="l00676"></a>00676         } <span class="keywordflow">else</span> {
<a name="l00677"></a>00677             nb += rc;
<a name="l00678"></a>00678             buf[nb] = <span class="charliteral">'\0'</span>;
<a name="l00679"></a>00679             lastchar = buf[nb - 1];
<a name="l00680"></a>00680         }
<a name="l00681"></a>00681     } <span class="keywordflow">while</span> (ec == 0 &amp;&amp; nb &lt; len &amp;&amp; lastchar != <span class="charliteral">'\n'</span>);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683     <span class="keywordflow">return</span> (ec &gt;= 0 ? nb : ec);
<a name="l00684"></a>00684 }
<a name="l00685"></a>00685 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 <span class="comment">/* =============================================================== */</span>
<a name="l00688"></a>00688 <span class="comment">/* Support for FTP/HTTP I/O.</span>
<a name="l00689"></a>00689 <span class="comment"> */</span>
<a name="l00690"></a><a class="code" href="rpmio_8h.html#c6db8428595950b1927900800976324d">00690</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(<span class="keywordtype">int</span> errorNumber)
<a name="l00691"></a>00691 {
<a name="l00692"></a>00692     <span class="keywordflow">switch</span> (errorNumber) {
<a name="l00693"></a>00693     <span class="keywordflow">case</span> 0:
<a name="l00694"></a>00694         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Success"</span>);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="comment">/* HACK error impediance match, coalesce and rename. */</span>
<a name="l00697"></a>00697     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df26a80d42e23bcf757b5ed51e9ed2f2e6">FTPERR_NE_ERROR</a>:
<a name="l00698"></a>00698         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_ERROR: Generic error."</span>);
<a name="l00699"></a>00699     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe706f7a989f0d80e20ad3cc55235b43e">FTPERR_NE_LOOKUP</a>:
<a name="l00700"></a>00700         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_LOOKUP: Hostname lookup failed."</span>);
<a name="l00701"></a>00701     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfdb1d8d49d211d79f73571c8e0d4c1a6e">FTPERR_NE_AUTH</a>:
<a name="l00702"></a>00702         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_AUTH: Server authentication failed."</span>);
<a name="l00703"></a>00703     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df911b9bf207d6fd6bc9e49955fec7524d">FTPERR_NE_PROXYAUTH</a>:
<a name="l00704"></a>00704         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_PROXYAUTH: Proxy authentication failed."</span>);
<a name="l00705"></a>00705     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df4ed9a73451fe95815c19d9511e0a91d9">FTPERR_NE_CONNECT</a>:
<a name="l00706"></a>00706         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_CONNECT: Could not connect to server."</span>);
<a name="l00707"></a>00707     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df0337daeeb3424dc662ffc0b15368456f">FTPERR_NE_TIMEOUT</a>:
<a name="l00708"></a>00708         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_TIMEOUT: Connection timed out."</span>);
<a name="l00709"></a>00709     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df49a701f4eaa3cb301c34d2dd92224e5b">FTPERR_NE_FAILED</a>:
<a name="l00710"></a>00710         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_FAILED: The precondition failed."</span>);
<a name="l00711"></a>00711     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df84226a2516102ce915cf5efa9689cec8">FTPERR_NE_RETRY</a>:
<a name="l00712"></a>00712         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_RETRY: Retry request."</span>);
<a name="l00713"></a>00713     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df81a6a021ea73fc642416ec1d5bc8e595">FTPERR_NE_REDIRECT</a>:
<a name="l00714"></a>00714         <span class="keywordflow">return</span> (<span class="stringliteral">"NE_REDIRECT: Redirect received."</span>);
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfaec5ca85b84b9204004f57b51137af2e">FTPERR_BAD_SERVER_RESPONSE</a>:
<a name="l00717"></a>00717         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Bad server response"</span>);
<a name="l00718"></a>00718     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe5f4a8e52b1aa4a15964ad66f3db553e">FTPERR_SERVER_IO_ERROR</a>:
<a name="l00719"></a>00719         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Server I/O error"</span>);
<a name="l00720"></a>00720     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfa5ca8c4d0f97ab83bbd3ad6d7ff9a9f5">FTPERR_SERVER_TIMEOUT</a>:
<a name="l00721"></a>00721         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Server timeout"</span>);
<a name="l00722"></a>00722     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df65fc649df35f424064e534293b1052a5">FTPERR_BAD_HOST_ADDR</a>:
<a name="l00723"></a>00723         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to lookup server host address"</span>);
<a name="l00724"></a>00724     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df54d0adab5cb39c6a3de9105516c1dad1">FTPERR_BAD_HOSTNAME</a>:
<a name="l00725"></a>00725         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to lookup server host name"</span>);
<a name="l00726"></a>00726     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe842c6482ce6b27c8230e02826a450f1">FTPERR_FAILED_CONNECT</a>:
<a name="l00727"></a>00727         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Failed to connect to server"</span>);
<a name="l00728"></a>00728     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfa4cb0d3019a67841b78982f1c175fa8f">FTPERR_FAILED_DATA_CONNECT</a>:
<a name="l00729"></a>00729         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Failed to establish data connection to server"</span>);
<a name="l00730"></a>00730     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfff96831adcf22317c0e912311cc8a030">FTPERR_FILE_IO_ERROR</a>:
<a name="l00731"></a>00731         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"I/O error to local file"</span>);
<a name="l00732"></a>00732     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>:
<a name="l00733"></a>00733         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Error setting remote server to passive mode"</span>);
<a name="l00734"></a>00734     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfc1d11490913e4982ea2bde2b9fba9bc7">FTPERR_FILE_NOT_FOUND</a>:
<a name="l00735"></a>00735         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"File not found on server"</span>);
<a name="l00736"></a>00736     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df9b5b23dc00c75669108827db558d19fc">FTPERR_NIC_ABORT_IN_PROGRESS</a>:
<a name="l00737"></a>00737         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Abort in progress"</span>);
<a name="l00738"></a>00738 
<a name="l00739"></a>00739     <span class="keywordflow">case</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>:
<a name="l00740"></a>00740     <span class="keywordflow">default</span>:
<a name="l00741"></a>00741         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unknown or unexpected error"</span>);
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 
<a name="l00745"></a><a class="code" href="rpmio_8h.html#62165c9ccf342d1adf51aec55804283d">00745</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rpmio_8c.html#62165c9ccf342d1adf51aec55804283d">urlStrerror</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *url)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747     <span class="keyword">const</span> <span class="keywordtype">char</span> *retstr;
<a name="l00748"></a>00748     <span class="comment">/*@-branchstate@*/</span>
<a name="l00749"></a>00749     <span class="keywordflow">switch</span> (<a class="code" href="rpmurl_8h.html#9def993f3a6f0b632236c66e03df7da6" title="Return type of URL.">urlIsURL</a>(url)) {
<a name="l00750"></a>00750     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l00751"></a>00751     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l00752"></a>00752     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l00753"></a>00753     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l00754"></a>00754     {   <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l00755"></a>00755 <span class="comment">/* XXX This only works for httpReq/ftpLogin/ftpReq failures */</span>
<a name="l00756"></a>00756         <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#317bdf1b8d8cf4ee786d8f38f8094cb2" title="Parse URL string into a control structure.">urlSplit</a>(url, &amp;u) == 0) {
<a name="l00757"></a>00757             retstr = <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a>);
<a name="l00758"></a>00758         } <span class="keywordflow">else</span>
<a name="l00759"></a>00759             retstr = <span class="stringliteral">"Malformed URL"</span>;
<a name="l00760"></a>00760     }   <span class="keywordflow">break</span>;
<a name="l00761"></a>00761     <span class="keywordflow">default</span>:
<a name="l00762"></a>00762         retstr = <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>);
<a name="l00763"></a>00763         <span class="keywordflow">break</span>;
<a name="l00764"></a>00764     }
<a name="l00765"></a>00765     <span class="comment">/*@=branchstate@*/</span>
<a name="l00766"></a>00766     <span class="keywordflow">return</span> retstr;
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a>00769 <span class="preprocessor">#if !defined(HAVE_GETADDRINFO)</span>
<a name="l00770"></a>00770 <span class="preprocessor"></span><span class="preprocessor">#if !defined(USE_ALT_DNS) || !USE_ALT_DNS </span>
<a name="l00771"></a><a class="code" href="rpmio_8c.html#2f66ea8c0b07bb954e664ba11674c38d">00771</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#2f66ea8c0b07bb954e664ba11674c38d">mygethostbyname</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * host,
<a name="l00772"></a>00772                 <span class="comment">/*@out@*/</span> <span class="keyword">struct</span> in_addr * address)
<a name="l00773"></a>00773         <span class="comment">/*@globals h_errno @*/</span>
<a name="l00774"></a>00774         <span class="comment">/*@modifies *address @*/</span>
<a name="l00775"></a>00775 {
<a name="l00776"></a>00776     <span class="keyword">struct </span>hostent * hostinfo;
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="comment">/*@-multithreaded @*/</span>
<a name="l00779"></a>00779     hostinfo = gethostbyname(host);
<a name="l00780"></a>00780     <span class="comment">/*@=multithreaded @*/</span>
<a name="l00781"></a>00781     <span class="keywordflow">if</span> (!hostinfo) <span class="keywordflow">return</span> 1;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00784"></a>00784     memcpy(address, hostinfo-&gt;h_addr_list[0], <span class="keyword">sizeof</span>(*address));
<a name="l00785"></a>00785 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00786"></a>00786     <span class="keywordflow">return</span> 0;
<a name="l00787"></a>00787 }
<a name="l00788"></a>00788 <span class="preprocessor">#endif</span>
<a name="l00789"></a>00789 <span class="preprocessor"></span>
<a name="l00790"></a>00790 <span class="comment">/*@-boundsread@*/</span>
<a name="l00791"></a>00791 <span class="comment">/*@-compdef@*/</span>  <span class="comment">/* FIX: address-&gt;s_addr undefined. */</span>
<a name="l00792"></a><a class="code" href="rpmio_8c.html#5f61ad8a8acb1c8538101f85d4ddaea2">00792</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#5f61ad8a8acb1c8538101f85d4ddaea2">getHostAddress</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * host, <span class="comment">/*@out@*/</span> <span class="keyword">struct</span> in_addr * address)
<a name="l00793"></a>00793         <span class="comment">/*@globals errno, h_errno @*/</span>
<a name="l00794"></a>00794         <span class="comment">/*@modifies *address, errno @*/</span>
<a name="l00795"></a>00795 {
<a name="l00796"></a>00796 <span class="preprocessor">#if 0   </span><span class="comment">/* XXX workaround nss_foo module hand-off using valgrind. */</span>
<a name="l00797"></a>00797     <span class="keywordflow">if</span> (!strcmp(host, <span class="stringliteral">"localhost"</span>)) {
<a name="l00798"></a>00798         <span class="comment">/*@-moduncon @*/</span>
<a name="l00799"></a>00799         <span class="keywordflow">if</span> (!<a class="code" href="rpmio_8c.html#7e3dddc5b7255116c3f9fdc2162b9c53">inet_aton</a>(<span class="stringliteral">"127.0.0.1"</span>, address))
<a name="l00800"></a>00800             <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df65fc649df35f424064e534293b1052a5">FTPERR_BAD_HOST_ADDR</a>;
<a name="l00801"></a>00801         <span class="comment">/*@=moduncon @*/</span>
<a name="l00802"></a>00802     } <span class="keywordflow">else</span>
<a name="l00803"></a>00803 <span class="preprocessor">#endif</span>
<a name="l00804"></a>00804 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#65a1599547748acb6ea978146c47043e">xisdigit</a>(host[0])) {
<a name="l00805"></a>00805         <span class="comment">/*@-moduncon @*/</span>
<a name="l00806"></a>00806         <span class="keywordflow">if</span> (!<a class="code" href="rpmio_8c.html#7e3dddc5b7255116c3f9fdc2162b9c53">inet_aton</a>(host, address))
<a name="l00807"></a>00807             <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df65fc649df35f424064e534293b1052a5">FTPERR_BAD_HOST_ADDR</a>;
<a name="l00808"></a>00808         <span class="comment">/*@=moduncon @*/</span>
<a name="l00809"></a>00809     } <span class="keywordflow">else</span> {
<a name="l00810"></a>00810         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#2f66ea8c0b07bb954e664ba11674c38d">mygethostbyname</a>(host, address)) {
<a name="l00811"></a>00811             <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = h_errno;
<a name="l00812"></a>00812             <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df54d0adab5cb39c6a3de9105516c1dad1">FTPERR_BAD_HOSTNAME</a>;
<a name="l00813"></a>00813         }
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     
<a name="l00816"></a>00816     <span class="keywordflow">return</span> 0;
<a name="l00817"></a>00817 }
<a name="l00818"></a>00818 <span class="comment">/*@=compdef@*/</span>
<a name="l00819"></a>00819 <span class="comment">/*@=boundsread@*/</span>
<a name="l00820"></a>00820 <span class="preprocessor">#endif</span>
<a name="l00821"></a>00821 <span class="preprocessor"></span>
<a name="l00822"></a><a class="code" href="rpmio_8c.html#bf021cfb3837c47e0bd6383f7629d9f8">00822</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#bf021cfb3837c47e0bd6383f7629d9f8">tcpConnect</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ctrl, <span class="keyword">const</span> <span class="keywordtype">char</span> * host, <span class="keywordtype">int</span> port)
<a name="l00823"></a>00823         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00824"></a>00824         <span class="comment">/*@modifies ctrl, fileSystem, internalState @*/</span>
<a name="l00825"></a>00825 {
<a name="l00826"></a>00826     <span class="keywordtype">int</span> fdno = -1;
<a name="l00827"></a>00827     <span class="keywordtype">int</span> rc;
<a name="l00828"></a>00828 <span class="preprocessor">#ifdef  HAVE_GETADDRINFO</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span>    <span class="keyword">struct </span>addrinfo hints, *res, *res0;
<a name="l00830"></a>00830     <span class="keywordtype">char</span> pbuf[NI_MAXSERV];
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     memset(&amp;hints, 0, <span class="keyword">sizeof</span>(hints));
<a name="l00833"></a>00833     hints.ai_family = AF_UNSPEC;
<a name="l00834"></a>00834     hints.ai_socktype = SOCK_STREAM;
<a name="l00835"></a>00835     sprintf(pbuf, <span class="stringliteral">"%d"</span>, port);
<a name="l00836"></a>00836     pbuf[<span class="keyword">sizeof</span>(pbuf)-1] = <span class="charliteral">'\0'</span>;
<a name="l00837"></a>00837     rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe842c6482ce6b27c8230e02826a450f1">FTPERR_FAILED_CONNECT</a>;
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (getaddrinfo(host, pbuf, &amp;hints, &amp;res0) == 0) {
<a name="l00839"></a>00839         <span class="keywordflow">for</span> (res = res0; res != NULL; res= res-&gt;ai_next) {
<a name="l00840"></a>00840             <span class="keywordflow">if</span> ((fdno = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol)) &lt; 0)
<a name="l00841"></a>00841                 <span class="keywordflow">continue</span>;
<a name="l00842"></a>00842             if (connect(fdno, res-&gt;ai_addr, res-&gt;ai_addrlen) &lt; 0) {
<a name="l00843"></a>00843                 close(fdno);
<a name="l00844"></a>00844                 <span class="keywordflow">continue</span>;
<a name="l00845"></a>00845             }
<a name="l00846"></a>00846             <span class="comment">/* success */</span>
<a name="l00847"></a>00847             rc = 0;
<a name="l00848"></a>00848             <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#adaf57ff8960c1dbab523ea7c63ef621">_ftp_debug</a>) {
<a name="l00849"></a>00849                 <span class="keywordtype">char</span> hbuf[NI_MAXHOST];
<a name="l00850"></a>00850                 getnameinfo(res-&gt;ai_addr, res-&gt;ai_addrlen, hbuf, <span class="keyword">sizeof</span>(hbuf),
<a name="l00851"></a>00851                                 NULL, 0, NI_NUMERICHOST);
<a name="l00852"></a>00852                 fprintf(stderr,<span class="stringliteral">"++ connect [%s]:%d on fdno %d\n"</span>,
<a name="l00853"></a>00853                                 <span class="comment">/*@-unrecog@*/</span> hbuf <span class="comment">/*@=unrecog@*/</span>, port, fdno);
<a name="l00854"></a>00854             }
<a name="l00855"></a>00855             <span class="keywordflow">break</span>;
<a name="l00856"></a>00856         }
<a name="l00857"></a>00857         freeaddrinfo(res0);
<a name="l00858"></a>00858     }
<a name="l00859"></a>00859     <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00860"></a>00860         <span class="keywordflow">goto</span> errxit;
<a name="l00861"></a>00861 
<a name="l00862"></a>00862 <span class="preprocessor">#else   </span><span class="comment">/* HAVE_GETADDRINFO */</span>                      
<a name="l00863"></a>00863     <span class="keyword">struct </span>sockaddr_in sin;
<a name="l00864"></a>00864 
<a name="l00865"></a>00865 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00866"></a>00866     memset(&amp;sin, 0, <span class="keyword">sizeof</span>(sin));
<a name="l00867"></a>00867 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00868"></a>00868     sin.sin_family = AF_INET;
<a name="l00869"></a>00869     sin.sin_port = htons(port);
<a name="l00870"></a>00870     sin.sin_addr.s_addr = INADDR_ANY;
<a name="l00871"></a>00871     
<a name="l00872"></a>00872   <span class="keywordflow">do</span> {
<a name="l00873"></a>00873     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#5f61ad8a8acb1c8538101f85d4ddaea2">getHostAddress</a>(host, &amp;sin.sin_addr)) &lt; 0)
<a name="l00874"></a>00874         <span class="keywordflow">break</span>;
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     <span class="keywordflow">if</span> ((fdno = socket(sin.sin_family, SOCK_STREAM, IPPROTO_IP)) &lt; 0) {
<a name="l00877"></a>00877         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe842c6482ce6b27c8230e02826a450f1">FTPERR_FAILED_CONNECT</a>;
<a name="l00878"></a>00878         <span class="keywordflow">break</span>;
<a name="l00879"></a>00879     }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881     <span class="comment">/*@-internalglobs@*/</span>
<a name="l00882"></a>00882     <span class="keywordflow">if</span> (connect(fdno, (<span class="keyword">struct</span> sockaddr *) &amp;sin, <span class="keyword">sizeof</span>(sin))) {
<a name="l00883"></a>00883         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe842c6482ce6b27c8230e02826a450f1">FTPERR_FAILED_CONNECT</a>;
<a name="l00884"></a>00884         <span class="keywordflow">break</span>;
<a name="l00885"></a>00885     }
<a name="l00886"></a>00886     <span class="comment">/*@=internalglobs@*/</span>
<a name="l00887"></a>00887   } <span class="keywordflow">while</span> (0);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889     <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l00890"></a>00890         <span class="keywordflow">goto</span> errxit;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#adaf57ff8960c1dbab523ea7c63ef621">_ftp_debug</a>)
<a name="l00893"></a>00893 fprintf(stderr,<span class="stringliteral">"++ connect %s:%d on fdno %d\n"</span>,
<a name="l00894"></a>00894 <span class="comment">/*@-unrecog -moduncon -evalorderuncon @*/</span>
<a name="l00895"></a>00895 inet_ntoa(sin.sin_addr)
<a name="l00896"></a>00896 <span class="comment">/*@=unrecog =moduncon =evalorderuncon @*/</span> ,
<a name="l00897"></a>00897 (<span class="keywordtype">int</span>)ntohs(sin.sin_port), fdno);
<a name="l00898"></a>00898 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_GETADDRINFO */</span>
<a name="l00899"></a>00899 
<a name="l00900"></a>00900     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(ctrl, (fdno &gt;= 0 ? fdno : -1));
<a name="l00901"></a>00901     <span class="keywordflow">return</span> 0;
<a name="l00902"></a>00902 
<a name="l00903"></a>00903 errxit:
<a name="l00904"></a>00904     <span class="comment">/*@-observertrans@*/</span>
<a name="l00905"></a>00905     <a class="code" href="group__rpmio.html#g6b5537d2765a23330c35844d403aedc5">fdSetSyserrno</a>(ctrl, errno, <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(rc));
<a name="l00906"></a>00906     <span class="comment">/*@=observertrans@*/</span>
<a name="l00907"></a>00907     <span class="keywordflow">if</span> (fdno &gt;= 0)
<a name="l00908"></a>00908         (void) close(fdno);
<a name="l00909"></a>00909     <span class="keywordflow">return</span> rc;
<a name="l00910"></a>00910 }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00913"></a><a class="code" href="rpmio_8c.html#5d437954780ceff1f98f8fcae21c0e27">00913</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#5d437954780ceff1f98f8fcae21c0e27">checkResponse</a>(<span class="keywordtype">void</span> * uu, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ctrl,
<a name="l00914"></a>00914                 <span class="comment">/*@out@*/</span> <span class="keywordtype">int</span> *ecp, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> ** str)
<a name="l00915"></a>00915         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l00916"></a>00916         <span class="comment">/*@modifies ctrl, *ecp, *str, fileSystem @*/</span>
<a name="l00917"></a>00917 {
<a name="l00918"></a>00918     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u = uu;
<a name="l00919"></a>00919     <span class="keywordtype">char</span> *buf;
<a name="l00920"></a>00920     <span class="keywordtype">size_t</span> bufAlloced;
<a name="l00921"></a>00921     <span class="keywordtype">int</span> bufLength = 0; 
<a name="l00922"></a>00922     <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l00923"></a>00923     <span class="keywordtype">char</span> *se;
<a name="l00924"></a>00924     <span class="keywordtype">int</span> ec = 0;
<a name="l00925"></a>00925     <span class="keywordtype">int</span> moretodo = 1;
<a name="l00926"></a>00926     <span class="keywordtype">char</span> errorCode[4];
<a name="l00927"></a>00927  
<a name="l00928"></a>00928     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8b1651880045ae1681eddfbf367fa340">bufAlloced</a> == 0 || u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a> == NULL) {
<a name="l00930"></a>00930         u-&gt;<a class="code" href="structurlinfo__s.html#8b1651880045ae1681eddfbf367fa340">bufAlloced</a> = <a class="code" href="rpmurl_8h.html#bd9e44ba06760e96b6cf7b6729bf1762">_url_iobuf_size</a>;
<a name="l00931"></a>00931         u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a> = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(u-&gt;<a class="code" href="structurlinfo__s.html#8b1651880045ae1681eddfbf367fa340">bufAlloced</a>, <span class="keyword">sizeof</span>(u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>[0]));
<a name="l00932"></a>00932     }
<a name="l00933"></a>00933     buf = u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>;
<a name="l00934"></a>00934     bufAlloced = u-&gt;<a class="code" href="structurlinfo__s.html#8b1651880045ae1681eddfbf367fa340">bufAlloced</a>;
<a name="l00935"></a>00935     *buf = <span class="charliteral">'\0'</span>;
<a name="l00936"></a>00936 
<a name="l00937"></a>00937     errorCode[0] = <span class="charliteral">'\0'</span>;
<a name="l00938"></a>00938     
<a name="l00939"></a>00939     <span class="keywordflow">do</span> {
<a name="l00940"></a>00940         <span class="keywordtype">int</span> rc;
<a name="l00941"></a>00941 
<a name="l00942"></a>00942         <span class="comment">/*</span>
<a name="l00943"></a>00943 <span class="comment">         * Read next line from server.</span>
<a name="l00944"></a>00944 <span class="comment">         */</span>
<a name="l00945"></a>00945         se = buf + bufLength;
<a name="l00946"></a>00946         *se = <span class="charliteral">'\0'</span>;
<a name="l00947"></a>00947         rc = <a class="code" href="group__rpmio.html#gfed118f9abfd7d30ddc17d2970f0bca1">fdFgets</a>(ctrl, se, (bufAlloced - bufLength));
<a name="l00948"></a>00948         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l00949"></a>00949             ec = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfaec5ca85b84b9204004f57b51137af2e">FTPERR_BAD_SERVER_RESPONSE</a>;
<a name="l00950"></a>00950             <span class="keywordflow">continue</span>;
<a name="l00951"></a>00951         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0 || <a class="code" href="rpmio_8c.html#74370513bf226276d69c6837ce6872b9">fdWritable</a>(ctrl, 0) &lt; 1)
<a name="l00952"></a>00952             moretodo = 0;
<a name="l00953"></a>00953 
<a name="l00954"></a>00954         <span class="comment">/*</span>
<a name="l00955"></a>00955 <span class="comment">         * Process next line from server.</span>
<a name="l00956"></a>00956 <span class="comment">         */</span>
<a name="l00957"></a>00957         <span class="keywordflow">for</span> (s = se; *s != <span class="charliteral">'\0'</span>; s = se) {
<a name="l00958"></a>00958                 <span class="keyword">const</span> <span class="keywordtype">char</span> *e;
<a name="l00959"></a>00959 
<a name="l00960"></a>00960                 <span class="keywordflow">while</span> (*se &amp;&amp; *se != <span class="charliteral">'\n'</span>) se++;
<a name="l00961"></a>00961 
<a name="l00962"></a>00962                 <span class="keywordflow">if</span> (se &gt; s &amp;&amp; se[-1] == <span class="charliteral">'\r'</span>)
<a name="l00963"></a>00963                    se[-1] = <span class="charliteral">'\0'</span>;
<a name="l00964"></a>00964                 <span class="keywordflow">if</span> (*se == <span class="charliteral">'\0'</span>)
<a name="l00965"></a>00965                     <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00966"></a>00966 
<a name="l00967"></a>00967 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#adaf57ff8960c1dbab523ea7c63ef621">_ftp_debug</a>)
<a name="l00968"></a>00968 fprintf(stderr, <span class="stringliteral">"&lt;- %s\n"</span>, s);
<a name="l00969"></a>00969 
<a name="l00970"></a>00970                 <span class="comment">/* HTTP: header termination on empty line */</span>
<a name="l00971"></a>00971                 <span class="keywordflow">if</span> (*s == <span class="charliteral">'\0'</span>) {
<a name="l00972"></a>00972                     moretodo = 0;
<a name="l00973"></a>00973                     <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00974"></a>00974                 }
<a name="l00975"></a>00975                 *se++ = <span class="charliteral">'\0'</span>;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977                 <span class="comment">/* HTTP: look for "HTTP/1.1 123 ..." */</span>
<a name="l00978"></a>00978                 <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"HTTP"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"HTTP"</span>)-1)) {
<a name="l00979"></a>00979                     ctrl-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> = -1;
<a name="l00980"></a>00980                     if ((e = strchr(s, <span class="charliteral">'.'</span>)) != NULL) {
<a name="l00981"></a>00981                         e++;
<a name="l00982"></a>00982                         u-&gt;<a class="code" href="structurlinfo__s.html#2fcc3dfd8942251085f7ae7aa1e82602">httpVersion</a> = *e - <span class="charliteral">'0'</span>;
<a name="l00983"></a>00983                         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#2fcc3dfd8942251085f7ae7aa1e82602">httpVersion</a> &lt; 1 || u-&gt;<a class="code" href="structurlinfo__s.html#2fcc3dfd8942251085f7ae7aa1e82602">httpVersion</a> &gt; 2)
<a name="l00984"></a>00984                             ctrl-&gt;<a class="code" href="struct__FD__s.html#9291417ba2a470d34437ec7cd0629ea1">persist</a> = u-&gt;<a class="code" href="structurlinfo__s.html#2fcc3dfd8942251085f7ae7aa1e82602">httpVersion</a> = 0;
<a name="l00985"></a>00985                         <span class="keywordflow">else</span>
<a name="l00986"></a>00986                             ctrl-&gt;<a class="code" href="struct__FD__s.html#9291417ba2a470d34437ec7cd0629ea1">persist</a> = 1;
<a name="l00987"></a>00987                     }
<a name="l00988"></a>00988                     <span class="keywordflow">if</span> ((e = strchr(s, <span class="charliteral">' '</span>)) != NULL) {
<a name="l00989"></a>00989                         e++;
<a name="l00990"></a>00990                         <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789"</span>, *e))
<a name="l00991"></a>00991                             strncpy(errorCode, e, 3);
<a name="l00992"></a>00992                         errorCode[3] = <span class="charliteral">'\0'</span>;
<a name="l00993"></a>00993                     }
<a name="l00994"></a>00994                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00995"></a>00995                 }
<a name="l00996"></a>00996 
<a name="l00997"></a>00997                 <span class="comment">/* HTTP: look for "token: ..." */</span>
<a name="l00998"></a>00998                 <span class="keywordflow">for</span> (e = s; *e &amp;&amp; !(*e == <span class="charliteral">' '</span> || *e == <span class="charliteral">':'</span>); e++)
<a name="l00999"></a>00999                     {};
<a name="l01000"></a>01000                 <span class="keywordflow">if</span> (e &gt; s &amp;&amp; *e++ == <span class="charliteral">':'</span>) {
<a name="l01001"></a>01001                     <span class="keywordtype">size_t</span> ne = (e - s);
<a name="l01002"></a>01002                     <span class="keywordflow">while</span> (*e &amp;&amp; *e == <span class="charliteral">' '</span>) e++;
<a name="l01003"></a>01003 <span class="preprocessor">#if 0</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Date:"</span>, ne)) {
<a name="l01005"></a>01005                     } <span class="keywordflow">else</span>
<a name="l01006"></a>01006                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Server:"</span>, ne)) {
<a name="l01007"></a>01007                     } <span class="keywordflow">else</span>
<a name="l01008"></a>01008                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Last-Modified:"</span>, ne)) {
<a name="l01009"></a>01009                     } <span class="keywordflow">else</span>
<a name="l01010"></a>01010                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"ETag:"</span>, ne)) {
<a name="l01011"></a>01011                     } <span class="keywordflow">else</span>
<a name="l01012"></a>01012 #endif
<a name="l01013"></a>01013                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Accept-Ranges:"</span>, ne)) {
<a name="l01014"></a>01014                         <span class="keywordflow">if</span> (!strcmp(e, <span class="stringliteral">"bytes"</span>))
<a name="l01015"></a>01015                             u-&gt;<a class="code" href="structurlinfo__s.html#d01f04b8ae783a2d9ae66e6d7470ea10">httpHasRange</a> = 1;
<a name="l01016"></a>01016                         if (!strcmp(e, <span class="stringliteral">"none"</span>))
<a name="l01017"></a>01017                             u-&gt;<a class="code" href="structurlinfo__s.html#d01f04b8ae783a2d9ae66e6d7470ea10">httpHasRange</a> = 0;
<a name="l01018"></a>01018                     } <span class="keywordflow">else</span>
<a name="l01019"></a>01019                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Content-Length:"</span>, ne)) {
<a name="l01020"></a>01020                         <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789"</span>, *e))
<a name="l01021"></a>01021                             ctrl-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> = atoi(e);
<a name="l01022"></a>01022                     } <span class="keywordflow">else</span>
<a name="l01023"></a>01023                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Connection:"</span>, ne)) {
<a name="l01024"></a>01024                         <span class="keywordflow">if</span> (!strcmp(e, <span class="stringliteral">"close"</span>))
<a name="l01025"></a>01025                             ctrl-&gt;<a class="code" href="struct__FD__s.html#9291417ba2a470d34437ec7cd0629ea1">persist</a> = 0;
<a name="l01026"></a>01026                     }
<a name="l01027"></a>01027 <span class="preprocessor">#if 0</span>
<a name="l01028"></a>01028 <span class="preprocessor"></span>                    <span class="keywordflow">else</span>
<a name="l01029"></a>01029                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Content-Type:"</span>, ne)) {
<a name="l01030"></a>01030                     } <span class="keywordflow">else</span>
<a name="l01031"></a>01031                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Transfer-Encoding:"</span>, ne)) {
<a name="l01032"></a>01032                         <span class="keywordflow">if</span> (!strcmp(e, <span class="stringliteral">"chunked"</span>))
<a name="l01033"></a>01033                             ctrl-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a> = 1;
<a name="l01034"></a>01034                         <span class="keywordflow">else</span>
<a name="l01035"></a>01035                             ctrl-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a> = 0;
<a name="l01036"></a>01036                     } <span class="keywordflow">else</span>
<a name="l01037"></a>01037                     <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"Allow:"</span>, ne)) {
<a name="l01038"></a>01038                     }
<a name="l01039"></a>01039 #endif
<a name="l01040"></a>01040                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01041"></a>01041                 }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043                 <span class="comment">/* HTTP: look for "&lt;TITLE&gt;501 ... &lt;/TITLE&gt;" */</span>
<a name="l01044"></a>01044                 <span class="keywordflow">if</span> (!strncmp(s, <span class="stringliteral">"&lt;TITLE&gt;"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"&lt;TITLE&gt;"</span>)-1))
<a name="l01045"></a>01045                     s += <span class="keyword">sizeof</span>(<span class="stringliteral">"&lt;TITLE&gt;"</span>) - 1;
<a name="l01046"></a>01046 
<a name="l01047"></a>01047                 <span class="comment">/* FTP: look for "123-" and/or "123 " */</span>
<a name="l01048"></a>01048                 <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789"</span>, *s)) {
<a name="l01049"></a>01049                     <span class="keywordflow">if</span> (errorCode[0] != <span class="charliteral">'\0'</span>) {
<a name="l01050"></a>01050                         <span class="keywordflow">if</span> (!strncmp(s, errorCode, <span class="keyword">sizeof</span>(<span class="stringliteral">"123"</span>)-1) &amp;&amp; s[3] == <span class="charliteral">' '</span>)
<a name="l01051"></a>01051                             moretodo = 0;
<a name="l01052"></a>01052                     } <span class="keywordflow">else</span> {
<a name="l01053"></a>01053                         strncpy(errorCode, s, <span class="keyword">sizeof</span>(<span class="stringliteral">"123"</span>)-1);
<a name="l01054"></a>01054                         errorCode[3] = <span class="charliteral">'\0'</span>;
<a name="l01055"></a>01055                         <span class="keywordflow">if</span> (s[3] != <span class="charliteral">'-'</span>)
<a name="l01056"></a>01056                             moretodo = 0;
<a name="l01057"></a>01057                     }
<a name="l01058"></a>01058                 }
<a name="l01059"></a>01059         }
<a name="l01060"></a>01060 
<a name="l01061"></a>01061         <span class="keywordflow">if</span> (moretodo &amp;&amp; se &gt; s) {
<a name="l01062"></a>01062             bufLength = se - s - 1;
<a name="l01063"></a>01063             <span class="keywordflow">if</span> (s != buf)
<a name="l01064"></a>01064                 memmove(buf, s, bufLength);
<a name="l01065"></a>01065         } <span class="keywordflow">else</span> {
<a name="l01066"></a>01066             bufLength = 0;
<a name="l01067"></a>01067         }
<a name="l01068"></a>01068     } <span class="keywordflow">while</span> (moretodo &amp;&amp; ec == 0);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070     <span class="keywordflow">if</span> (str)    *str = buf;
<a name="l01071"></a>01071     <span class="keywordflow">if</span> (ecp)    *ecp = atoi(errorCode);
<a name="l01072"></a>01072 
<a name="l01073"></a>01073     <span class="keywordflow">return</span> ec;
<a name="l01074"></a>01074 }
<a name="l01075"></a>01075 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01076"></a>01076 
<a name="l01077"></a><a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">01077</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> ** str)
<a name="l01078"></a>01078         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l01079"></a>01079         <span class="comment">/*@modifies u, *str, fileSystem @*/</span>
<a name="l01080"></a>01080 {
<a name="l01081"></a>01081     <span class="keywordtype">int</span> ec = 0;
<a name="l01082"></a>01082     <span class="keywordtype">int</span> rc;
<a name="l01083"></a>01083 
<a name="l01084"></a>01084     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01085"></a>01085     rc = <a class="code" href="rpmio_8c.html#5d437954780ceff1f98f8fcae21c0e27">checkResponse</a>(u, u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, &amp;ec, str);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087     <span class="keywordflow">switch</span> (ec) {
<a name="l01088"></a>01088     <span class="keywordflow">case</span> 550:
<a name="l01089"></a>01089         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfc1d11490913e4982ea2bde2b9fba9bc7">FTPERR_FILE_NOT_FOUND</a>;
<a name="l01090"></a>01090         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l01091"></a>01091     <span class="keywordflow">case</span> 552:
<a name="l01092"></a>01092         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df9b5b23dc00c75669108827db558d19fc">FTPERR_NIC_ABORT_IN_PROGRESS</a>;
<a name="l01093"></a>01093         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l01094"></a>01094     <span class="keywordflow">default</span>:
<a name="l01095"></a>01095         <span class="keywordflow">if</span> (ec &gt;= 400 &amp;&amp; ec &lt;= 599) {
<a name="l01096"></a>01096             <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfaec5ca85b84b9204004f57b51137af2e">FTPERR_BAD_SERVER_RESPONSE</a>;
<a name="l01097"></a>01097         }
<a name="l01098"></a>01098         <span class="keywordflow">break</span>;
<a name="l01099"></a>01099     }
<a name="l01100"></a>01100     <span class="keywordflow">return</span> rc;
<a name="l01101"></a>01101 }
<a name="l01102"></a>01102 
<a name="l01103"></a><a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">01103</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <span class="keywordtype">char</span> ** str, ...)
<a name="l01104"></a>01104         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l01105"></a>01105         <span class="comment">/*@modifies u, *str, fileSystem, internalState @*/</span>
<a name="l01106"></a>01106 {
<a name="l01107"></a>01107     va_list ap;
<a name="l01108"></a>01108     <span class="keywordtype">int</span> len = 0;
<a name="l01109"></a>01109     <span class="keyword">const</span> <span class="keywordtype">char</span> * s, * t;
<a name="l01110"></a>01110     <span class="keywordtype">char</span> * te;
<a name="l01111"></a>01111     <span class="keywordtype">int</span> rc;
<a name="l01112"></a>01112 
<a name="l01113"></a>01113     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01114"></a>01114     va_start(ap, str);
<a name="l01115"></a>01115     <span class="keywordflow">while</span> ((s = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)) != NULL) {
<a name="l01116"></a>01116         <span class="keywordflow">if</span> (len) len++;
<a name="l01117"></a>01117         len += strlen(s);
<a name="l01118"></a>01118     }
<a name="l01119"></a>01119     len += <span class="keyword">sizeof</span>(<span class="stringliteral">"\r\n"</span>)-1;
<a name="l01120"></a>01120     va_end(ap);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01123"></a>01123     t = te = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(len + 1);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     va_start(ap, str);
<a name="l01126"></a>01126     <span class="keywordflow">while</span> ((s = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)) != NULL) {
<a name="l01127"></a>01127         <span class="keywordflow">if</span> (te &gt; t) *te++ = <span class="charliteral">' '</span>;
<a name="l01128"></a>01128         te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(te, s);
<a name="l01129"></a>01129     }
<a name="l01130"></a>01130     te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(te, <span class="stringliteral">"\r\n"</span>);
<a name="l01131"></a>01131     va_end(ap);
<a name="l01132"></a>01132 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 <span class="keywordflow">if</span> (_ftp_debug)
<a name="l01135"></a>01135 fprintf(stderr, <span class="stringliteral">"-&gt; %s"</span>, t);
<a name="l01136"></a>01136     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, t, (te-t)) != (te-t))
<a name="l01137"></a>01137         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe5f4a8e52b1aa4a15964ad66f3db553e">FTPERR_SERVER_IO_ERROR</a>;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, str);
<a name="l01140"></a>01140     <span class="keywordflow">return</span> rc;
<a name="l01141"></a>01141 }
<a name="l01142"></a>01142 
<a name="l01143"></a><a class="code" href="rpmio_8c.html#2082968b946d473000d3b65978ae7211">01143</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#2082968b946d473000d3b65978ae7211">ftpLogin</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u)
<a name="l01144"></a>01144         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01145"></a>01145         <span class="comment">/*@modifies u, fileSystem, internalState @*/</span>
<a name="l01146"></a>01146 {
<a name="l01147"></a>01147     <span class="keyword">const</span> <span class="keywordtype">char</span> * host;
<a name="l01148"></a>01148     <span class="keyword">const</span> <span class="keywordtype">char</span> * user;
<a name="l01149"></a>01149     <span class="keyword">const</span> <span class="keywordtype">char</span> * password;
<a name="l01150"></a>01150     <span class="keywordtype">int</span> port;
<a name="l01151"></a>01151     <span class="keywordtype">int</span> rc;
<a name="l01152"></a>01152 
<a name="l01153"></a>01153     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01154"></a>01154     u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"open ctrl"</span>);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156     <span class="keywordflow">if</span> (((host = (u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> : u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a>)) == NULL)) {
<a name="l01157"></a>01157         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df54d0adab5cb39c6a3de9105516c1dad1">FTPERR_BAD_HOSTNAME</a>;
<a name="l01158"></a>01158         <span class="keywordflow">goto</span> errxit;
<a name="l01159"></a>01159     }
<a name="l01160"></a>01160 
<a name="l01161"></a>01161     <span class="keywordflow">if</span> ((port = (u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> &gt; 0 ? u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> : u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a>)) &lt; 0) port = <a class="code" href="rpmio_8c.html#b1bfa063152e67aed53df45f4fae8cd8">IPPORT_FTP</a>;
<a name="l01162"></a>01162 
<a name="l01163"></a>01163     <span class="comment">/*@-branchstate@*/</span>
<a name="l01164"></a>01164     <span class="keywordflow">if</span> ((user = (u-&gt;<a class="code" href="structurlinfo__s.html#ca1ff621d781bab60db384046c4580be">proxyu</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#ca1ff621d781bab60db384046c4580be">proxyu</a> : u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a>)) == NULL)
<a name="l01165"></a>01165         user = <span class="stringliteral">"anonymous"</span>;
<a name="l01166"></a>01166     <span class="comment">/*@=branchstate@*/</span>
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     <span class="comment">/*@-branchstate@*/</span>
<a name="l01169"></a>01169     <span class="keywordflow">if</span> ((password = u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a>) == NULL) {
<a name="l01170"></a>01170         uid_t uid = getuid();
<a name="l01171"></a>01171         <span class="keyword">struct </span>passwd * pw;
<a name="l01172"></a>01172         <span class="keywordflow">if</span> (uid &amp;&amp; (pw = getpwuid(uid)) != NULL) {
<a name="l01173"></a>01173 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01174"></a>01174             <span class="keywordtype">char</span> *myp = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(strlen(pw-&gt;pw_name) + <span class="keyword">sizeof</span>(<span class="stringliteral">"@"</span>));
<a name="l01175"></a>01175             strcpy(myp, pw-&gt;pw_name);
<a name="l01176"></a>01176             strcat(myp, <span class="stringliteral">"@"</span>);
<a name="l01177"></a>01177 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01178"></a>01178             password = myp;
<a name="l01179"></a>01179         } <span class="keywordflow">else</span> {
<a name="l01180"></a>01180             password = <span class="stringliteral">"root@"</span>;
<a name="l01181"></a>01181         }
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183     <span class="comment">/*@=branchstate@*/</span>
<a name="l01184"></a>01184 
<a name="l01185"></a>01185     <span class="comment">/*@-branchstate@*/</span>
<a name="l01186"></a>01186     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) &gt;= 0 &amp;&amp; <a class="code" href="rpmio_8c.html#74370513bf226276d69c6837ce6872b9">fdWritable</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, 0) &lt; 1)
<a name="l01187"></a>01187         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01188"></a>01188     <span class="comment">/*@=branchstate@*/</span>
<a name="l01189"></a>01189 
<a name="l01190"></a>01190 <span class="comment">/*@-usereleased@*/</span>
<a name="l01191"></a>01191     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) &lt; 0) {
<a name="l01192"></a>01192         rc = <a class="code" href="rpmio_8c.html#bf021cfb3837c47e0bd6383f7629d9f8">tcpConnect</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, host, port);
<a name="l01193"></a>01193         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01194"></a>01194             <span class="keywordflow">goto</span> errxit2;
<a name="l01195"></a>01195     }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, NULL)))
<a name="l01198"></a>01198         <span class="keywordflow">goto</span> errxit;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, NULL, <span class="stringliteral">"USER"</span>, user, NULL)))
<a name="l01201"></a>01201         <span class="keywordflow">goto</span> errxit;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, NULL, <span class="stringliteral">"PASS"</span>, password, NULL)))
<a name="l01204"></a>01204         <span class="keywordflow">goto</span> errxit;
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, NULL, <span class="stringliteral">"TYPE"</span>, <span class="stringliteral">"I"</span>, NULL)))
<a name="l01207"></a>01207         <span class="keywordflow">goto</span> errxit;
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     <span class="comment">/*@-compdef@*/</span>
<a name="l01210"></a>01210     <span class="keywordflow">return</span> 0;
<a name="l01211"></a>01211     <span class="comment">/*@=compdef@*/</span>
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 errxit:
<a name="l01214"></a>01214     <span class="comment">/*@-observertrans@*/</span>
<a name="l01215"></a>01215     <a class="code" href="group__rpmio.html#g6b5537d2765a23330c35844d403aedc5">fdSetSyserrno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>, <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(rc));
<a name="l01216"></a>01216     <span class="comment">/*@=observertrans@*/</span>
<a name="l01217"></a>01217 errxit2:
<a name="l01218"></a>01218     <span class="comment">/*@-branchstate@*/</span>
<a name="l01219"></a>01219     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) &gt;= 0)
<a name="l01220"></a>01220         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01221"></a>01221     <span class="comment">/*@=branchstate@*/</span>
<a name="l01222"></a>01222     <span class="comment">/*@-compdef@*/</span>
<a name="l01223"></a>01223     <span class="keywordflow">return</span> rc;
<a name="l01224"></a>01224     <span class="comment">/*@=compdef@*/</span>
<a name="l01225"></a>01225 <span class="comment">/*@=usereleased@*/</span>
<a name="l01226"></a>01226 }
<a name="l01227"></a>01227 
<a name="l01228"></a><a class="code" href="group__rpmio.html#gb1bd7ba764e2c5af827dccbc02e2d488">01228</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmio.html#gb1bd7ba764e2c5af827dccbc02e2d488">ftpReq</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> data, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="group__rpmio.html#gf37bd955568ab25d967ec380c2f55370">ftpCmd</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> * ftpArg)
<a name="l01229"></a>01229 {
<a name="l01230"></a>01230     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u = data-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a>;
<a name="l01231"></a>01231 <span class="preprocessor">#if !defined(HAVE_GETADDRINFO)</span>
<a name="l01232"></a>01232 <span class="preprocessor"></span>    <span class="keyword">struct </span>sockaddr_in dataAddress;
<a name="l01233"></a>01233 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_GETADDRINFO */</span>
<a name="l01234"></a>01234     <span class="keywordtype">char</span> remoteIP[NI_MAXHOST];
<a name="l01235"></a>01235     <span class="keywordtype">char</span> * cmd;
<a name="l01236"></a>01236     <span class="keywordtype">int</span> cmdlen;
<a name="l01237"></a>01237     <span class="keywordtype">char</span> * passReply;
<a name="l01238"></a>01238     <span class="keywordtype">char</span> * chptr;
<a name="l01239"></a>01239     <span class="keywordtype">int</span> rc;
<a name="l01240"></a>01240     <span class="keywordtype">int</span> epsv;
<a name="l01241"></a>01241     <span class="keywordtype">int</span> port;
<a name="l01242"></a>01242 
<a name="l01243"></a>01243 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01244"></a>01244     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01245"></a>01245     <span class="keywordflow">if</span> (ftpCmd == NULL)
<a name="l01246"></a>01246         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;  <span class="comment">/* XXX W2DO? */</span>
<a name="l01247"></a>01247 
<a name="l01248"></a>01248     cmdlen = strlen(ftpCmd) + (ftpArg ? 1+strlen(ftpArg) : 0) + <span class="keyword">sizeof</span>(<span class="stringliteral">"\r\n"</span>);
<a name="l01249"></a>01249     chptr = cmd = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(cmdlen);
<a name="l01250"></a>01250     chptr = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(chptr, ftpCmd);
<a name="l01251"></a>01251     <span class="keywordflow">if</span> (ftpArg) {
<a name="l01252"></a>01252         *chptr++ = <span class="charliteral">' '</span>;
<a name="l01253"></a>01253         chptr = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(chptr, ftpArg);
<a name="l01254"></a>01254     }
<a name="l01255"></a>01255     chptr = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(chptr, <span class="stringliteral">"\r\n"</span>);
<a name="l01256"></a>01256     cmdlen = chptr - cmd;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258 <span class="comment">/*</span>
<a name="l01259"></a>01259 <span class="comment"> * Get the ftp version of the Content-Length.</span>
<a name="l01260"></a>01260 <span class="comment"> */</span>
<a name="l01261"></a>01261     <span class="keywordflow">if</span> (!strncmp(cmd, <span class="stringliteral">"RETR"</span>, 4)) {
<a name="l01262"></a>01262         <span class="keywordtype">unsigned</span> cl;
<a name="l01263"></a>01263 
<a name="l01264"></a>01264         passReply = NULL;
<a name="l01265"></a>01265         rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, &amp;passReply, <span class="stringliteral">"SIZE"</span>, ftpArg, NULL);
<a name="l01266"></a>01266         <span class="keywordflow">if</span> (rc)
<a name="l01267"></a>01267             <span class="keywordflow">goto</span> errxit;
<a name="l01268"></a>01268         <span class="keywordflow">if</span> (sscanf(passReply, <span class="stringliteral">"%d %u"</span>, &amp;rc, &amp;cl) != 2) {
<a name="l01269"></a>01269             rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfaec5ca85b84b9204004f57b51137af2e">FTPERR_BAD_SERVER_RESPONSE</a>;
<a name="l01270"></a>01270             <span class="keywordflow">goto</span> errxit;
<a name="l01271"></a>01271         }
<a name="l01272"></a>01272         rc = 0;
<a name="l01273"></a>01273         data-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> = cl;
<a name="l01274"></a>01274     }
<a name="l01275"></a>01275 
<a name="l01276"></a>01276     epsv = 0;
<a name="l01277"></a>01277     passReply = NULL;
<a name="l01278"></a>01278 <span class="preprocessor">#ifdef HAVE_GETNAMEINFO</span>
<a name="l01279"></a>01279 <span class="preprocessor"></span>    rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, &amp;passReply, <span class="stringliteral">"EPSV"</span>, NULL);
<a name="l01280"></a>01280     <span class="keywordflow">if</span> (rc==0) {
<a name="l01281"></a>01281 <span class="preprocessor">#ifdef HAVE_GETADDRINFO</span>
<a name="l01282"></a>01282 <span class="preprocessor"></span>        <span class="keyword">struct </span>sockaddr_storage ss;
<a name="l01283"></a>01283 <span class="preprocessor">#else </span><span class="comment">/* HAVE_GETADDRINFO */</span>
<a name="l01284"></a>01284         <span class="keyword">struct </span>sockaddr_in ss;
<a name="l01285"></a>01285 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_GETADDRINFO */</span>
<a name="l01286"></a>01286         <span class="keywordtype">int</span> size;
<a name="l01287"></a>01287         <span class="comment">/* we need to know IP of remote host */</span>
<a name="l01288"></a>01288         size=<span class="keyword">sizeof</span>(ss);
<a name="l01289"></a>01289         <span class="keywordflow">if</span> ((getpeername(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(<a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>)), (<span class="keyword">struct</span> sockaddr *)&amp;ss, &amp;size) == 0) &amp;&amp;
<a name="l01290"></a>01290                         (getnameinfo((<span class="keyword">struct</span> sockaddr *)&amp;ss, size, remoteIP, <span class="keyword">sizeof</span>(remoteIP),
<a name="l01291"></a>01291                                 NULL, 0, NI_NUMERICHOST) == 0))
<a name="l01292"></a>01292                 epsv++;
<a name="l01293"></a>01293         <span class="keywordflow">else</span> {
<a name="l01294"></a>01294                 <span class="comment">/* abort EPSV and fall back to PASV */</span>
<a name="l01295"></a>01295                 rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, &amp;passReply, <span class="stringliteral">"ABOR"</span>, NULL);
<a name="l01296"></a>01296                 <span class="keywordflow">if</span> (rc) {
<a name="l01297"></a>01297                     rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01298"></a>01298                     <span class="keywordflow">goto</span> errxit;
<a name="l01299"></a>01299                 }
<a name="l01300"></a>01300         }
<a name="l01301"></a>01301     }
<a name="l01302"></a>01302     <span class="keywordflow">if</span> (epsv==0)
<a name="l01303"></a>01303 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_GETNAMEINFO */</span>
<a name="l01304"></a>01304         rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, &amp;passReply, <span class="stringliteral">"PASV"</span>, NULL);
<a name="l01305"></a>01305     <span class="keywordflow">if</span> (rc) {
<a name="l01306"></a>01306         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01307"></a>01307         <span class="keywordflow">goto</span> errxit;
<a name="l01308"></a>01308     }
<a name="l01309"></a>01309 
<a name="l01310"></a>01310     chptr = passReply;
<a name="l01311"></a>01311     <span class="keywordflow">while</span> (*chptr &amp;&amp; *chptr != <span class="charliteral">'('</span>) chptr++;
<a name="l01312"></a>01312     <span class="keywordflow">if</span> (*chptr != <span class="charliteral">'('</span>) <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>; 
<a name="l01313"></a>01313     chptr++;
<a name="l01314"></a>01314     passReply = chptr;
<a name="l01315"></a>01315     <span class="keywordflow">while</span> (*chptr &amp;&amp; *chptr != <span class="charliteral">')'</span>) chptr++;
<a name="l01316"></a>01316     <span class="keywordflow">if</span> (*chptr != <span class="charliteral">')'</span>) <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01317"></a>01317     *chptr-- = <span class="charliteral">'\0'</span>;
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (epsv) {
<a name="l01320"></a>01320         <span class="keywordtype">int</span> i;
<a name="l01321"></a>01321         <span class="keywordflow">if</span>(sscanf(passReply,<span class="stringliteral">"%*c%*c%*c%d%*c"</span>,&amp;i) != 1) {
<a name="l01322"></a>01322            rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01323"></a>01323            <span class="keywordflow">goto</span> errxit;
<a name="l01324"></a>01324         }
<a name="l01325"></a>01325         port = i;
<a name="l01326"></a>01326     } <span class="keywordflow">else</span> {
<a name="l01327"></a>01327  
<a name="l01328"></a>01328     <span class="keywordflow">while</span> (*chptr &amp;&amp; *chptr != <span class="charliteral">','</span>) chptr--;
<a name="l01329"></a>01329     <span class="keywordflow">if</span> (*chptr != <span class="charliteral">','</span>) <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01330"></a>01330     chptr--;
<a name="l01331"></a>01331     <span class="keywordflow">while</span> (*chptr &amp;&amp; *chptr != <span class="charliteral">','</span>) chptr--;
<a name="l01332"></a>01332     <span class="keywordflow">if</span> (*chptr != <span class="charliteral">','</span>) <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01333"></a>01333     *chptr++ = <span class="charliteral">'\0'</span>;
<a name="l01334"></a>01334     
<a name="l01335"></a>01335     <span class="comment">/* now passReply points to the IP portion, and chptr points to the</span>
<a name="l01336"></a>01336 <span class="comment">       port number portion */</span>
<a name="l01337"></a>01337 
<a name="l01338"></a>01338     {   <span class="keywordtype">int</span> i, j;
<a name="l01339"></a>01339         <span class="keywordflow">if</span> (sscanf(chptr, <span class="stringliteral">"%d,%d"</span>, &amp;i, &amp;j) != 2) {
<a name="l01340"></a>01340             rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01341"></a>01341             <span class="keywordflow">goto</span> errxit;
<a name="l01342"></a>01342         }
<a name="l01343"></a>01343         port = (((unsigned)i) &lt;&lt; 8) + j;
<a name="l01344"></a>01344     }
<a name="l01345"></a>01345 
<a name="l01346"></a>01346     chptr = passReply;
<a name="l01347"></a>01347     <span class="keywordflow">while</span> (*chptr++ != <span class="charliteral">'\0'</span>) {
<a name="l01348"></a>01348         <span class="keywordflow">if</span> (*chptr == <span class="charliteral">','</span>) *chptr = <span class="charliteral">'.'</span>;
<a name="l01349"></a>01349     }
<a name="l01350"></a>01350 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01351"></a>01351     sprintf(remoteIP, <span class="stringliteral">"%s"</span>, passReply);
<a name="l01352"></a>01352     } <span class="comment">/* if (epsv) */</span>
<a name="l01353"></a>01353 
<a name="l01354"></a>01354 <span class="preprocessor">#ifdef HAVE_GETADDRINFO</span>
<a name="l01355"></a>01355 <span class="preprocessor"></span>    {
<a name="l01356"></a>01356         <span class="keyword">struct </span>addrinfo hints, *res, *res0;
<a name="l01357"></a>01357         <span class="keywordtype">char</span> pbuf[NI_MAXSERV];
<a name="l01358"></a>01358 
<a name="l01359"></a>01359         memset(&amp;hints, 0, <span class="keyword">sizeof</span>(hints));
<a name="l01360"></a>01360         hints.ai_family = AF_UNSPEC;
<a name="l01361"></a>01361         hints.ai_socktype = SOCK_STREAM;
<a name="l01362"></a>01362         hints.ai_flags = AI_NUMERICHOST;
<a name="l01363"></a>01363         sprintf(pbuf, <span class="stringliteral">"%d"</span>, port);
<a name="l01364"></a>01364         pbuf[<span class="keyword">sizeof</span>(pbuf)-1] = <span class="charliteral">'\0'</span>;
<a name="l01365"></a>01365         <span class="keywordflow">if</span> (getaddrinfo(remoteIP, pbuf, &amp;hints, &amp;res0)) {
<a name="l01366"></a>01366             rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01367"></a>01367             <span class="keywordflow">goto</span> errxit;
<a name="l01368"></a>01368         }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370         <span class="keywordflow">for</span> (res = res0; res != NULL; res = res-&gt;ai_next) {
<a name="l01371"></a>01371             rc = socket(res-&gt;ai_family, res-&gt;ai_socktype, res-&gt;ai_protocol);
<a name="l01372"></a>01372             <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(data, (rc &gt;= 0 ? rc : -1));
<a name="l01373"></a>01373             <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01374"></a>01374                 <span class="keywordflow">if</span> (res-&gt;ai_next)
<a name="l01375"></a>01375                     <span class="keywordflow">continue</span>;
<a name="l01376"></a>01376                 <span class="keywordflow">else</span> {
<a name="l01377"></a>01377                     rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe842c6482ce6b27c8230e02826a450f1">FTPERR_FAILED_CONNECT</a>;
<a name="l01378"></a>01378                     freeaddrinfo(res0);
<a name="l01379"></a>01379                     <span class="keywordflow">goto</span> errxit;
<a name="l01380"></a>01380                 }
<a name="l01381"></a>01381             }
<a name="l01382"></a>01382             data = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(data, <span class="stringliteral">"open data (ftpReq)"</span>);
<a name="l01383"></a>01383 
<a name="l01384"></a>01384             <span class="comment">/* XXX setsockopt SO_LINGER */</span>
<a name="l01385"></a>01385             <span class="comment">/* XXX setsockopt SO_KEEPALIVE */</span>
<a name="l01386"></a>01386             <span class="comment">/* XXX setsockopt SO_TOS IPTOS_THROUGHPUT */</span>
<a name="l01387"></a>01387             
<a name="l01388"></a>01388             {
<a name="l01389"></a>01389                 <span class="keywordtype">int</span> criterr = 0;
<a name="l01390"></a>01390                 <span class="keywordflow">while</span> (connect(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data), res-&gt;ai_addr, res-&gt;ai_addrlen) &lt; 0) {
<a name="l01391"></a>01391                     <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == EINTR)
<a name="l01392"></a>01392                         <span class="keywordflow">continue</span>;
<a name="l01393"></a>01393                     criterr++;
<a name="l01394"></a>01394                 }
<a name="l01395"></a>01395                 <span class="keywordflow">if</span> (criterr) {
<a name="l01396"></a>01396                     <span class="keywordflow">if</span> (res-&gt;ai_addr) {
<a name="l01397"></a>01397                         <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(data);
<a name="l01398"></a>01398                         <span class="keywordflow">continue</span>;
<a name="l01399"></a>01399                     } <span class="keywordflow">else</span> {
<a name="l01400"></a>01400                         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01401"></a>01401                         freeaddrinfo(res0);
<a name="l01402"></a>01402                         <span class="keywordflow">goto</span> errxit;
<a name="l01403"></a>01403                     }
<a name="l01404"></a>01404                 }
<a name="l01405"></a>01405             }
<a name="l01406"></a>01406             <span class="comment">/* success */</span>
<a name="l01407"></a>01407             rc = 0;
<a name="l01408"></a>01408             <span class="keywordflow">break</span>;
<a name="l01409"></a>01409         }
<a name="l01410"></a>01410         freeaddrinfo(res0);
<a name="l01411"></a>01411     }
<a name="l01412"></a>01412             
<a name="l01413"></a>01413 <span class="preprocessor">#else </span><span class="comment">/* HAVE_GETADDRINFO */</span>
<a name="l01414"></a>01414     memset(&amp;dataAddress, 0, <span class="keyword">sizeof</span>(dataAddress));
<a name="l01415"></a>01415     dataAddress.sin_family = AF_INET;
<a name="l01416"></a>01416     dataAddress.sin_port = htons(port);
<a name="l01417"></a>01417 
<a name="l01418"></a>01418     <span class="comment">/*@-moduncon@*/</span>
<a name="l01419"></a>01419     <span class="keywordflow">if</span> (!<a class="code" href="rpmio_8c.html#7e3dddc5b7255116c3f9fdc2162b9c53">inet_aton</a>(remoteIP, &amp;dataAddress.sin_addr)) {
<a name="l01420"></a>01420         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df1f1d54af133a9d23428ea9ccd4213148">FTPERR_PASSIVE_ERROR</a>;
<a name="l01421"></a>01421         <span class="keywordflow">goto</span> errxit;
<a name="l01422"></a>01422     }
<a name="l01423"></a>01423     <span class="comment">/*@=moduncon@*/</span>
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     rc = socket(AF_INET, SOCK_STREAM, IPPROTO_IP);
<a name="l01426"></a>01426     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(data, (rc &gt;= 0 ? rc : -1));
<a name="l01427"></a>01427     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01428"></a>01428         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe842c6482ce6b27c8230e02826a450f1">FTPERR_FAILED_CONNECT</a>;
<a name="l01429"></a>01429         <span class="keywordflow">goto</span> errxit;
<a name="l01430"></a>01430     }
<a name="l01431"></a>01431     data = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(data, <span class="stringliteral">"open data (ftpReq)"</span>);
<a name="l01432"></a>01432 
<a name="l01433"></a>01433     <span class="comment">/* XXX setsockopt SO_LINGER */</span>
<a name="l01434"></a>01434     <span class="comment">/* XXX setsockopt SO_KEEPALIVE */</span>
<a name="l01435"></a>01435     <span class="comment">/* XXX setsockopt SO_TOS IPTOS_THROUGHPUT */</span>
<a name="l01436"></a>01436 
<a name="l01437"></a>01437     <span class="comment">/*@-internalglobs@*/</span>
<a name="l01438"></a>01438     <span class="keywordflow">while</span> (connect(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data), (<span class="keyword">struct</span> sockaddr *) &amp;dataAddress, 
<a name="l01439"></a>01439                 <span class="keyword">sizeof</span>(dataAddress)) &lt; 0)
<a name="l01440"></a>01440     {
<a name="l01441"></a>01441         <span class="keywordflow">if</span> (errno == EINTR)
<a name="l01442"></a>01442             <span class="keywordflow">continue</span>;
<a name="l01443"></a>01443         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfa4cb0d3019a67841b78982f1c175fa8f">FTPERR_FAILED_DATA_CONNECT</a>;
<a name="l01444"></a>01444         <span class="keywordflow">goto</span> errxit;
<a name="l01445"></a>01445     }
<a name="l01446"></a>01446     <span class="comment">/*@=internalglobs@*/</span>
<a name="l01447"></a>01447 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_GETADDRINFO */</span>
<a name="l01448"></a>01448 
<a name="l01449"></a>01449 <span class="keywordflow">if</span> (_ftp_debug)
<a name="l01450"></a>01450 fprintf(stderr, <span class="stringliteral">"-&gt; %s"</span>, cmd);
<a name="l01451"></a>01451     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, cmd, cmdlen) != cmdlen) {
<a name="l01452"></a>01452         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe5f4a8e52b1aa4a15964ad66f3db553e">FTPERR_SERVER_IO_ERROR</a>;
<a name="l01453"></a>01453         <span class="keywordflow">goto</span> errxit;
<a name="l01454"></a>01454     }
<a name="l01455"></a>01455 
<a name="l01456"></a>01456     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, NULL))) {
<a name="l01457"></a>01457         <span class="keywordflow">goto</span> errxit;
<a name="l01458"></a>01458     }
<a name="l01459"></a>01459 
<a name="l01460"></a>01460     data-&gt;ftpFileDoneNeeded = 1;
<a name="l01461"></a>01461     u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"grab data (ftpReq)"</span>);
<a name="l01462"></a>01462     u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"open data (ftpReq)"</span>);
<a name="l01463"></a>01463     <span class="keywordflow">return</span> 0;
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 errxit:
<a name="l01466"></a>01466     <span class="comment">/*@-observertrans@*/</span>
<a name="l01467"></a>01467     <a class="code" href="group__rpmio.html#g6b5537d2765a23330c35844d403aedc5">fdSetSyserrno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, errno, <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(rc));
<a name="l01468"></a>01468     <span class="comment">/*@=observertrans@*/</span>
<a name="l01469"></a>01469     <span class="comment">/*@-branchstate@*/</span>
<a name="l01470"></a>01470     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data) &gt;= 0)
<a name="l01471"></a>01471         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(data); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01472"></a>01472     <span class="comment">/*@=branchstate@*/</span>
<a name="l01473"></a>01473     <span class="keywordflow">return</span> rc;
<a name="l01474"></a>01474 }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476 <span class="comment">/*@unchecked@*/</span> <span class="comment">/*@null@*/</span>
<a name="l01477"></a><a class="code" href="rpmio_8c.html#a6111e29675012caa28229fb0d40c98f">01477</a> <span class="keyword">static</span> <a class="code" href="rpmmessages_8h.html#bc524033d736bfb98027bd28907c03df">rpmCallbackFunction</a>      <a class="code" href="rpmio_8c.html#a6111e29675012caa28229fb0d40c98f">urlNotify</a> = NULL;
<a name="l01478"></a>01478 
<a name="l01479"></a>01479 <span class="comment">/*@unchecked@*/</span> <span class="comment">/*@null@*/</span>
<a name="l01480"></a><a class="code" href="rpmio_8c.html#ab54343be84ee0434c0651239064e19a">01480</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *                   <a class="code" href="rpmio_8c.html#ab54343be84ee0434c0651239064e19a">urlNotifyData</a> = NULL;
<a name="l01481"></a>01481 
<a name="l01482"></a>01482 <span class="comment">/*@unchecked@*/</span>
<a name="l01483"></a><a class="code" href="rpmio_8c.html#87ee96d91780ed0af90e1305e31cfc81">01483</a> <span class="keyword">static</span> <span class="keywordtype">int</span>                      <a class="code" href="rpmio_8c.html#87ee96d91780ed0af90e1305e31cfc81">urlNotifyCount</a> = -1;
<a name="l01484"></a>01484 
<a name="l01485"></a><a class="code" href="rpmmessages_8h.html#70450e5c1f836592cd196a745c919194">01485</a> <span class="keywordtype">void</span> <a class="code" href="rpmio_8c.html#896ceb973ed865a9bff431682a362e0b">urlSetCallback</a>(<a class="code" href="rpmmessages_8h.html#bc524033d736bfb98027bd28907c03df">rpmCallbackFunction</a> notify, <span class="keywordtype">void</span> *notifyData, <span class="keywordtype">int</span> notifyCount) {
<a name="l01486"></a>01486     urlNotify = notify;
<a name="l01487"></a>01487     urlNotifyData = notifyData;
<a name="l01488"></a>01488     urlNotifyCount = (notifyCount &gt;= 0) ? notifyCount : 4096;
<a name="l01489"></a>01489 }
<a name="l01490"></a>01490 
<a name="l01491"></a><a class="code" href="rpmio_8h.html#33a57ae29060a478df51e281fc745efb">01491</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#33a57ae29060a478df51e281fc745efb">ufdCopy</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> sfd, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> tfd)
<a name="l01492"></a>01492 {
<a name="l01493"></a>01493     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l01494"></a>01494     <span class="keywordtype">int</span> itemsRead;
<a name="l01495"></a>01495     <span class="keywordtype">int</span> itemsCopied = 0;
<a name="l01496"></a>01496     <span class="keywordtype">int</span> rc = 0;
<a name="l01497"></a>01497     <span class="keywordtype">int</span> notifier = -1;
<a name="l01498"></a>01498 
<a name="l01499"></a>01499     <span class="keywordflow">if</span> (urlNotify) {
<a name="l01500"></a>01500 <span class="comment">/*@-boundsread@*/</span>
<a name="l01501"></a>01501         <span class="comment">/*@-noeffectuncon @*/</span> <span class="comment">/* FIX: check rc */</span>
<a name="l01502"></a>01502         (void)(*urlNotify) (NULL, <a class="code" href="rpmmessages_8h.html#ee1ee0900a6f9abe699d626b5490c4e36410f1f8c50d549cf6c343c554f0bd59">RPMCALLBACK_INST_OPEN_FILE</a>,
<a name="l01503"></a>01503                 0, 0, NULL, urlNotifyData);
<a name="l01504"></a>01504         <span class="comment">/*@=noeffectuncon @*/</span>
<a name="l01505"></a>01505 <span class="comment">/*@=boundsread@*/</span>
<a name="l01506"></a>01506     }
<a name="l01507"></a>01507     
<a name="l01508"></a>01508     <span class="keywordflow">while</span> (1) {
<a name="l01509"></a>01509         rc = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(buf, <span class="keyword">sizeof</span>(buf[0]), <span class="keyword">sizeof</span>(buf), sfd);
<a name="l01510"></a>01510         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01511"></a>01511             <span class="keywordflow">break</span>;
<a name="l01512"></a>01512         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0) {
<a name="l01513"></a>01513             rc = itemsCopied;
<a name="l01514"></a>01514             <span class="keywordflow">break</span>;
<a name="l01515"></a>01515         }
<a name="l01516"></a>01516         itemsRead = rc;
<a name="l01517"></a>01517         rc = <a class="code" href="rpmio_8c.html#0b66d10b5a0e926d57e86327f4e9dcc6" title="fwrite(3) clone.">Fwrite</a>(buf, <span class="keyword">sizeof</span>(buf[0]), itemsRead, tfd);
<a name="l01518"></a>01518         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01519"></a>01519             <span class="keywordflow">break</span>;
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (rc != itemsRead) {
<a name="l01521"></a>01521             rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfff96831adcf22317c0e912311cc8a030">FTPERR_FILE_IO_ERROR</a>;
<a name="l01522"></a>01522             <span class="keywordflow">break</span>;
<a name="l01523"></a>01523         }
<a name="l01524"></a>01524 
<a name="l01525"></a>01525         itemsCopied += itemsRead;
<a name="l01526"></a>01526         <span class="keywordflow">if</span> (urlNotify &amp;&amp; urlNotifyCount &gt; 0) {
<a name="l01527"></a>01527             <span class="keywordtype">int</span> n = itemsCopied/urlNotifyCount;
<a name="l01528"></a>01528             <span class="keywordflow">if</span> (n != notifier) {
<a name="l01529"></a>01529 <span class="comment">/*@-boundsread@*/</span>
<a name="l01530"></a>01530                 <span class="comment">/*@-noeffectuncon @*/</span> <span class="comment">/* FIX: check rc */</span>
<a name="l01531"></a>01531                 (void)(*urlNotify) (NULL, <a class="code" href="rpmmessages_8h.html#ee1ee0900a6f9abe699d626b5490c4e3f2472ce803fbc31360ecd0bca1d3a844">RPMCALLBACK_INST_PROGRESS</a>,
<a name="l01532"></a>01532                         itemsCopied, 0, NULL, urlNotifyData);
<a name="l01533"></a>01533                 <span class="comment">/*@=noeffectuncon @*/</span>
<a name="l01534"></a>01534 <span class="comment">/*@=boundsread@*/</span>
<a name="l01535"></a>01535                 notifier = n;
<a name="l01536"></a>01536             }
<a name="l01537"></a>01537         }
<a name="l01538"></a>01538     }
<a name="l01539"></a>01539 
<a name="l01540"></a>01540     <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(sfd, (stderr, <span class="stringliteral">"++ copied %d bytes: %s\n"</span>, itemsCopied,
<a name="l01541"></a>01541         <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(rc)));
<a name="l01542"></a>01542 
<a name="l01543"></a>01543     <span class="keywordflow">if</span> (urlNotify) {
<a name="l01544"></a>01544 <span class="comment">/*@-boundsread@*/</span>
<a name="l01545"></a>01545         <span class="comment">/*@-noeffectuncon @*/</span> <span class="comment">/* FIX: check rc */</span>
<a name="l01546"></a>01546         (void)(*urlNotify) (NULL, <a class="code" href="rpmmessages_8h.html#ee1ee0900a6f9abe699d626b5490c4e36410f1f8c50d549cf6c343c554f0bd59">RPMCALLBACK_INST_OPEN_FILE</a>,
<a name="l01547"></a>01547                 itemsCopied, itemsCopied, NULL, urlNotifyData);
<a name="l01548"></a>01548         <span class="comment">/*@=noeffectuncon @*/</span>
<a name="l01549"></a>01549 <span class="comment">/*@=boundsread@*/</span>
<a name="l01550"></a>01550     }
<a name="l01551"></a>01551     
<a name="l01552"></a>01552     <span class="keywordflow">return</span> rc;
<a name="l01553"></a>01553 }
<a name="l01554"></a>01554 
<a name="l01555"></a><a class="code" href="rpmio_8c.html#e2dbaf9850990f4cd88d62bdd9731d7b">01555</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#e2dbaf9850990f4cd88d62bdd9731d7b">urlConnect</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url, <span class="comment">/*@out@*/</span> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> * uret)
<a name="l01556"></a>01556         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01557"></a>01557         <span class="comment">/*@modifies *uret, fileSystem, internalState @*/</span>
<a name="l01558"></a>01558 {
<a name="l01559"></a>01559     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l01560"></a>01560     <span class="keywordtype">int</span> rc = 0;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562     <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#317bdf1b8d8cf4ee786d8f38f8094cb2" title="Parse URL string into a control structure.">urlSplit</a>(url, &amp;u) &lt; 0)
<a name="l01563"></a>01563         <span class="keywordflow">return</span> -1;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>) {
<a name="l01566"></a>01566         <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l01567"></a>01567 
<a name="l01568"></a>01568         <span class="keywordflow">if</span> ((fd = u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) == NULL) {
<a name="l01569"></a>01569             fd = u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"persist ctrl (urlConnect FTP)"</span>);
<a name="l01570"></a>01570             <a class="code" href="group__rpmio.html#gc47f81dea769678613395bd3d291147e">fdSetIo</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>);
<a name="l01571"></a>01571         }
<a name="l01572"></a>01572         
<a name="l01573"></a>01573         fd-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> = <a class="code" href="rpmio_8c.html#e9746945efef21a62e0a404fe440962b">ftpTimeoutSecs</a>;
<a name="l01574"></a>01574         fd-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> = fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> = -1;
<a name="l01575"></a>01575         fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a> = NULL;         <span class="comment">/* XXX FTP ctrl has not */</span>
<a name="l01576"></a>01576         fd-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a> = 0;
<a name="l01577"></a>01577         fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"grab ctrl (urlConnect FTP)"</span>);
<a name="l01578"></a>01578 
<a name="l01579"></a>01579         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) &lt; 0) {
<a name="l01580"></a>01580             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"logging into %s as %s, pw %s\n"</span>),
<a name="l01581"></a>01581                         u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> : <span class="stringliteral">"???"</span>,
<a name="l01582"></a>01582                         u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> : <span class="stringliteral">"ftp"</span>,
<a name="l01583"></a>01583                         u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> : <span class="stringliteral">"(username)"</span>);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585             <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#2082968b946d473000d3b65978ae7211">ftpLogin</a>(u)) &lt; 0) {       <span class="comment">/* XXX save ftpLogin error */</span>
<a name="l01586"></a>01586                 u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"grab ctrl (urlConnect FTP)"</span>);
<a name="l01587"></a>01587                 u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a> = rc;
<a name="l01588"></a>01588             }
<a name="l01589"></a>01589         }
<a name="l01590"></a>01590     }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01593"></a>01593     <span class="keywordflow">if</span> (uret != NULL)
<a name="l01594"></a>01594         *uret = <a class="code" href="rpmurl_8h.html#c6c1cad826e839c25c2842ab97c0bd6e">urlLink</a>(u, <span class="stringliteral">"urlConnect"</span>);
<a name="l01595"></a>01595 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01596"></a>01596     u = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(u, <span class="stringliteral">"urlSplit (urlConnect)"</span>);    
<a name="l01597"></a>01597 
<a name="l01598"></a>01598     <span class="keywordflow">return</span> rc;
<a name="l01599"></a>01599 }
<a name="l01600"></a>01600 
<a name="l01601"></a><a class="code" href="rpmio_8h.html#bf2a213ca984f30255ec6eacf55fb5ba">01601</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#bf2a213ca984f30255ec6eacf55fb5ba">ufdGetFile</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> sfd, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> tfd)
<a name="l01602"></a>01602 {
<a name="l01603"></a>01603     <span class="keywordtype">int</span> rc;
<a name="l01604"></a>01604 
<a name="l01605"></a>01605     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(sfd);
<a name="l01606"></a>01606     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(tfd);
<a name="l01607"></a>01607     rc = <a class="code" href="rpmio_8c.html#33a57ae29060a478df51e281fc745efb">ufdCopy</a>(sfd, tfd);
<a name="l01608"></a>01608     (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(sfd);
<a name="l01609"></a>01609     <span class="keywordflow">if</span> (rc &gt; 0)         <span class="comment">/* XXX ufdCopy now returns no. bytes copied */</span>
<a name="l01610"></a>01610         rc = 0;
<a name="l01611"></a>01611     <span class="keywordflow">return</span> rc;
<a name="l01612"></a>01612 }
<a name="l01613"></a>01613 
<a name="l01614"></a><a class="code" href="group__rpmio.html#gf37bd955568ab25d967ec380c2f55370">01614</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmio.html#gf37bd955568ab25d967ec380c2f55370">ftpCmd</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * cmd, <span class="keyword">const</span> <span class="keywordtype">char</span> * url, <span class="keyword">const</span> <span class="keywordtype">char</span> * arg2)
<a name="l01615"></a>01615 {
<a name="l01616"></a>01616     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l01617"></a>01617     <span class="keywordtype">int</span> rc;
<a name="l01618"></a>01618     <span class="keyword">const</span> <span class="keywordtype">char</span> * path;
<a name="l01619"></a>01619 
<a name="l01620"></a>01620     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#e2dbaf9850990f4cd88d62bdd9731d7b">urlConnect</a>(url, &amp;u) &lt; 0)
<a name="l01621"></a>01621         <span class="keywordflow">return</span> -1;
<a name="l01622"></a>01622 
<a name="l01623"></a>01623     (void) <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(url, &amp;path);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625     rc = <a class="code" href="rpmio_8c.html#45d4090b766d9c54c4c3f1e193867a81">ftpCommand</a>(u, NULL, cmd, path, arg2, NULL);
<a name="l01626"></a>01626     u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"grab ctrl (ftpCmd)"</span>);
<a name="l01627"></a>01627     <span class="keywordflow">return</span> rc;
<a name="l01628"></a>01628 }
<a name="l01629"></a>01629 
<a name="l01630"></a>01630 <span class="comment">/* XXX these aren't worth the pain of including correctly */</span>
<a name="l01631"></a>01631 <span class="preprocessor">#if !defined(IAC)</span>
<a name="l01632"></a><a class="code" href="rpmio_8c.html#552ab9f303f69bb96c1bf2f2aff61574">01632</a> <span class="preprocessor"></span><span class="preprocessor">#define IAC     255             </span><span class="comment">/* interpret as command: */</span>
<a name="l01633"></a>01633 <span class="preprocessor">#endif</span>
<a name="l01634"></a>01634 <span class="preprocessor"></span><span class="preprocessor">#if !defined(IP)</span>
<a name="l01635"></a><a class="code" href="rpmio_8c.html#788c64601d46e188b1b4594619bae9e2">01635</a> <span class="preprocessor"></span><span class="preprocessor">#define IP      244             </span><span class="comment">/* interrupt process--permanently */</span>
<a name="l01636"></a>01636 <span class="preprocessor">#endif</span>
<a name="l01637"></a>01637 <span class="preprocessor"></span><span class="preprocessor">#if !defined(DM)</span>
<a name="l01638"></a><a class="code" href="rpmio_8c.html#0c76e286d9b33261bade203f4d259d1e">01638</a> <span class="preprocessor"></span><span class="preprocessor">#define DM      242             </span><span class="comment">/* data mark--for connect. cleaning */</span>
<a name="l01639"></a>01639 <span class="preprocessor">#endif</span>
<a name="l01640"></a>01640 <span class="preprocessor"></span><span class="preprocessor">#if !defined(SHUT_RDWR)</span>
<a name="l01641"></a><a class="code" href="rpmio_8c.html#34915e23abdc36ec776bbcff501f4607">01641</a> <span class="preprocessor"></span><span class="preprocessor">#define SHUT_RDWR       1+1</span>
<a name="l01642"></a>01642 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01643"></a>01643 <span class="preprocessor"></span>
<a name="l01644"></a><a class="code" href="rpmio_8c.html#b1ab49d4ef260d6eab1658619d1bd1f8">01644</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#b1ab49d4ef260d6eab1658619d1bd1f8">ftpAbort</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> data)
<a name="l01645"></a>01645         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l01646"></a>01646         <span class="comment">/*@modifies u, data, fileSystem, internalState @*/</span>
<a name="l01647"></a>01647 {
<a name="l01648"></a>01648     <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ipbuf[3] = { <a class="code" href="rpmio_8c.html#552ab9f303f69bb96c1bf2f2aff61574">IAC</a>, <a class="code" href="rpmio_8c.html#788c64601d46e188b1b4594619bae9e2">IP</a>, <a class="code" href="rpmio_8c.html#552ab9f303f69bb96c1bf2f2aff61574">IAC</a> };
<a name="l01649"></a>01649     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ctrl;
<a name="l01650"></a>01650     <span class="keywordtype">int</span> rc;
<a name="l01651"></a>01651     <span class="keywordtype">int</span> tosecs;
<a name="l01652"></a>01652 
<a name="l01653"></a>01653     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01654"></a>01654 
<a name="l01655"></a>01655     <span class="keywordflow">if</span> (data != NULL) {
<a name="l01656"></a>01656         data-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a> = 0;
<a name="l01657"></a>01657         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data) &gt;= 0)
<a name="l01658"></a>01658             u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"open data (ftpAbort)"</span>);
<a name="l01659"></a>01659         u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"grab data (ftpAbort)"</span>);
<a name="l01660"></a>01660     }
<a name="l01661"></a>01661     ctrl = u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>;
<a name="l01662"></a>01662 
<a name="l01663"></a>01663     <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(0, (stderr, <span class="stringliteral">"-&gt; ABOR\n"</span>));
<a name="l01664"></a>01664 
<a name="l01665"></a>01665 <span class="comment">/*@-usereleased -compdef@*/</span>
<a name="l01666"></a>01666     <span class="keywordflow">if</span> (send(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(ctrl), ipbuf, <span class="keyword">sizeof</span>(ipbuf), MSG_OOB) != <span class="keyword">sizeof</span>(ipbuf)) {
<a name="l01667"></a>01667         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(ctrl); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01668"></a>01668         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe5f4a8e52b1aa4a15964ad66f3db553e">FTPERR_SERVER_IO_ERROR</a>;
<a name="l01669"></a>01669     }
<a name="l01670"></a>01670 
<a name="l01671"></a>01671     sprintf(u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>, <span class="stringliteral">"%cABOR\r\n"</span>,(<span class="keywordtype">char</span>) <a class="code" href="rpmio_8c.html#0c76e286d9b33261bade203f4d259d1e">DM</a>);
<a name="l01672"></a>01672     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(ctrl, u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>, 7) != 7) {
<a name="l01673"></a>01673         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(ctrl); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01674"></a>01674         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe5f4a8e52b1aa4a15964ad66f3db553e">FTPERR_SERVER_IO_ERROR</a>;
<a name="l01675"></a>01675     }
<a name="l01676"></a>01676 
<a name="l01677"></a>01677     <span class="keywordflow">if</span> (data &amp;&amp; <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data) &gt;= 0) {
<a name="l01678"></a>01678         <span class="comment">/* XXX shorten data drain time wait */</span>
<a name="l01679"></a>01679         tosecs = data-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a>;
<a name="l01680"></a>01680         data-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> = 10;
<a name="l01681"></a>01681         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#e7bf383d1ec94b1ecfa584191ed09de1">fdReadable</a>(data, data-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a>) &gt; 0) {
<a name="l01682"></a>01682 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01683"></a>01683             <span class="keywordflow">while</span> (<a class="code" href="rpmio_8h.html#dd0ea98621412703fd5854ecf8fe8e2e">timedRead</a>(data, u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>, u-&gt;<a class="code" href="structurlinfo__s.html#8b1651880045ae1681eddfbf367fa340">bufAlloced</a>) &gt; 0)
<a name="l01684"></a>01684                 u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>[0] = <span class="charliteral">'\0'</span>;
<a name="l01685"></a>01685 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01686"></a>01686         }
<a name="l01687"></a>01687         data-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> = tosecs;
<a name="l01688"></a>01688         <span class="comment">/* XXX ftp abort needs to close the data channel to receive status */</span>
<a name="l01689"></a>01689         (void) shutdown(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data), <a class="code" href="rpmio_8c.html#34915e23abdc36ec776bbcff501f4607">SHUT_RDWR</a>);
<a name="l01690"></a>01690         (void) close(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(data));
<a name="l01691"></a>01691         data-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[0].<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a> = -1; <span class="comment">/* XXX WRONG but expedient */</span>
<a name="l01692"></a>01692     }
<a name="l01693"></a>01693 
<a name="l01694"></a>01694     <span class="comment">/* XXX shorten ctrl drain time wait */</span>
<a name="l01695"></a>01695     tosecs = u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a>;
<a name="l01696"></a>01696     u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> = 10;
<a name="l01697"></a>01697     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, NULL)) == <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df9b5b23dc00c75669108827db558d19fc">FTPERR_NIC_ABORT_IN_PROGRESS</a>) {
<a name="l01698"></a>01698         rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, NULL);
<a name="l01699"></a>01699     }
<a name="l01700"></a>01700     rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, NULL);
<a name="l01701"></a>01701     u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> = tosecs;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703     <span class="keywordflow">return</span> rc;
<a name="l01704"></a>01704 <span class="comment">/*@=usereleased =compdef@*/</span>
<a name="l01705"></a>01705 }
<a name="l01706"></a>01706 
<a name="l01707"></a><a class="code" href="rpmio_8c.html#bb40b3ebfc08e116be0a62c4e76be083">01707</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#bb40b3ebfc08e116be0a62c4e76be083">ftpFileDone</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> data)
<a name="l01708"></a>01708         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l01709"></a>01709         <span class="comment">/*@modifies u, data, fileSystem @*/</span>
<a name="l01710"></a>01710 {
<a name="l01711"></a>01711     <span class="keywordtype">int</span> rc = 0;
<a name="l01712"></a>01712 
<a name="l01713"></a>01713     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01714"></a>01714     assert(data-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a>);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716     <span class="keywordflow">if</span> (data-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a>) {
<a name="l01717"></a>01717         data-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a> = 0;
<a name="l01718"></a>01718         u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"open data (ftpFileDone)"</span>);
<a name="l01719"></a>01719         u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"grab data (ftpFileDone)"</span>);
<a name="l01720"></a>01720         rc = <a class="code" href="rpmio_8c.html#9fa147267bc655ecacb4a920ba632771">ftpCheckResponse</a>(u, NULL);
<a name="l01721"></a>01721     }
<a name="l01722"></a>01722     <span class="keywordflow">return</span> rc;
<a name="l01723"></a>01723 }
<a name="l01724"></a>01724 
<a name="l01725"></a><a class="code" href="rpmio_8c.html#506270604c7cfed4a922b788ac2501e5">01725</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#506270604c7cfed4a922b788ac2501e5">httpResp</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ctrl, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> ** str)
<a name="l01726"></a>01726         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l01727"></a>01727         <span class="comment">/*@modifies ctrl, *str, fileSystem @*/</span>
<a name="l01728"></a>01728 {
<a name="l01729"></a>01729     <span class="keywordtype">int</span> ec = 0;
<a name="l01730"></a>01730     <span class="keywordtype">int</span> rc;
<a name="l01731"></a>01731 
<a name="l01732"></a>01732     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01733"></a>01733     rc = <a class="code" href="rpmio_8c.html#5d437954780ceff1f98f8fcae21c0e27">checkResponse</a>(u, ctrl, &amp;ec, str);
<a name="l01734"></a>01734 
<a name="l01735"></a>01735 <span class="keywordflow">if</span> (_ftp_debug &amp;&amp; !(rc == 0 &amp;&amp; (ec == 200 || ec == 201)))
<a name="l01736"></a>01736 fprintf(stderr, <span class="stringliteral">"*** httpResp: rc %d ec %d\n"</span>, rc, ec);
<a name="l01737"></a>01737 
<a name="l01738"></a>01738     <span class="keywordflow">switch</span> (ec) {
<a name="l01739"></a>01739     <span class="keywordflow">case</span> 200:
<a name="l01740"></a>01740     <span class="keywordflow">case</span> 201:                   <span class="comment">/* 201 Created. */</span>
<a name="l01741"></a>01741         <span class="keywordflow">break</span>;
<a name="l01742"></a>01742     <span class="keywordflow">case</span> 204:                   <span class="comment">/* HACK: if overwriting, 204 No Content. */</span>
<a name="l01743"></a>01743     <span class="keywordflow">case</span> 403:                   <span class="comment">/* 403 Forbidden. */</span>
<a name="l01744"></a>01744         ctrl-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> = EACCES;        <span class="comment">/* HACK */</span>
<a name="l01745"></a>01745         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;
<a name="l01746"></a>01746         <span class="keywordflow">break</span>;
<a name="l01747"></a>01747     <span class="keywordflow">default</span>:
<a name="l01748"></a>01748         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfc1d11490913e4982ea2bde2b9fba9bc7">FTPERR_FILE_NOT_FOUND</a>;
<a name="l01749"></a>01749         <span class="keywordflow">break</span>;
<a name="l01750"></a>01750     }
<a name="l01751"></a>01751     <span class="keywordflow">return</span> rc;
<a name="l01752"></a>01752 }
<a name="l01753"></a>01753 
<a name="l01754"></a><a class="code" href="rpmio_8c.html#7453ee39c803e39f03e1a77b5fe18f41">01754</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#7453ee39c803e39f03e1a77b5fe18f41">httpReq</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ctrl, <span class="keyword">const</span> <span class="keywordtype">char</span> * httpCmd, <span class="keyword">const</span> <span class="keywordtype">char</span> * httpArg)
<a name="l01755"></a>01755         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01756"></a>01756         <span class="comment">/*@modifies ctrl, fileSystem, internalState @*/</span>
<a name="l01757"></a>01757 {
<a name="l01758"></a>01758     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l01759"></a>01759     <span class="keyword">const</span> <span class="keywordtype">char</span> * host;
<a name="l01760"></a>01760     <span class="keyword">const</span> <span class="keywordtype">char</span> * path;
<a name="l01761"></a>01761     <span class="keywordtype">char</span> hthost[NI_MAXHOST];
<a name="l01762"></a>01762     <span class="keywordtype">int</span> port;
<a name="l01763"></a>01763     <span class="keywordtype">int</span> rc;
<a name="l01764"></a>01764     <span class="keywordtype">char</span> * req;
<a name="l01765"></a>01765     <span class="keywordtype">size_t</span> len;
<a name="l01766"></a>01766     <span class="keywordtype">int</span> retrying = 0;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768 assert(ctrl != NULL);
<a name="l01769"></a>01769     u = ctrl-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a>;
<a name="l01770"></a>01770     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l01771"></a>01771 
<a name="l01772"></a>01772     <span class="keywordflow">if</span> (((host = (u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> : u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a>)) == NULL))
<a name="l01773"></a>01773         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df54d0adab5cb39c6a3de9105516c1dad1">FTPERR_BAD_HOSTNAME</a>;
<a name="l01774"></a>01774     <span class="keywordflow">if</span> (strchr(host, <span class="charliteral">':'</span>))
<a name="l01775"></a>01775         sprintf(hthost, <span class="stringliteral">"[%s]"</span>, host);
<a name="l01776"></a>01776     <span class="keywordflow">else</span>
<a name="l01777"></a>01777         strcpy(hthost, host);
<a name="l01778"></a>01778 
<a name="l01779"></a>01779     <span class="keywordflow">if</span> ((port = (u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> &gt; 0 ? u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> : u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a>)) &lt; 0) port = 80;
<a name="l01780"></a>01780     path = (u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> || u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> &gt; 0) ? u-&gt;<a class="code" href="structurlinfo__s.html#810926c59d9599b52ed296e2052a136a">url</a> : httpArg;
<a name="l01781"></a>01781     <span class="comment">/*@-branchstate@*/</span>
<a name="l01782"></a>01782     if (path == NULL) path = <span class="stringliteral">""</span>;
<a name="l01783"></a>01783     <span class="comment">/*@=branchstate@*/</span>
<a name="l01784"></a>01784 
<a name="l01785"></a>01785 reopen:
<a name="l01786"></a>01786     <span class="comment">/*@-branchstate@*/</span>
<a name="l01787"></a>01787     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(ctrl) &gt;= 0 &amp;&amp; (rc = <a class="code" href="rpmio_8c.html#74370513bf226276d69c6837ce6872b9">fdWritable</a>(ctrl, 0)) &lt; 1) {
<a name="l01788"></a>01788         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(ctrl); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01789"></a>01789     }
<a name="l01790"></a>01790     <span class="comment">/*@=branchstate@*/</span>
<a name="l01791"></a>01791 
<a name="l01792"></a>01792 <span class="comment">/*@-usereleased@*/</span>
<a name="l01793"></a>01793     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(ctrl) &lt; 0) {
<a name="l01794"></a>01794         rc = <a class="code" href="rpmio_8c.html#bf021cfb3837c47e0bd6383f7629d9f8">tcpConnect</a>(ctrl, host, port);
<a name="l01795"></a>01795         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l01796"></a>01796             <span class="keywordflow">goto</span> errxit2;
<a name="l01797"></a>01797         ctrl = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(ctrl, <span class="stringliteral">"open ctrl (httpReq)"</span>);
<a name="l01798"></a>01798     }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800     len = <span class="keyword">sizeof</span>(<span class="stringliteral">"\</span>
<a name="l01801"></a>01801 <span class="stringliteral">req x HTTP/1.0\r\n\</span>
<a name="l01802"></a>01802 <span class="stringliteral">User-Agent: rpm/3.0.4\r\n\</span>
<a name="l01803"></a>01803 <span class="stringliteral">Host: y:z\r\n\</span>
<a name="l01804"></a>01804 <span class="stringliteral">Accept: text/plain\r\n\</span>
<a name="l01805"></a>01805 <span class="stringliteral">Transfer-Encoding: chunked\r\n\</span>
<a name="l01806"></a>01806 <span class="stringliteral">\r\n\</span>
<a name="l01807"></a>01807 <span class="stringliteral">"</span>) + strlen(httpCmd) + strlen(path) + <span class="keyword">sizeof</span>(<a class="code" href="config_8h.html#d50944c12fe46b051e56ecff63a08c17">VERSION</a>) + strlen(hthost) + 20;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01810"></a>01810     req = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(len);
<a name="l01811"></a>01811     *req = <span class="charliteral">'\0'</span>;
<a name="l01812"></a>01812 
<a name="l01813"></a>01813   <span class="keywordflow">if</span> (!strcmp(httpCmd, <span class="stringliteral">"PUT"</span>)) {
<a name="l01814"></a>01814     sprintf(req, <span class="stringliteral">"\</span>
<a name="l01815"></a>01815 <span class="stringliteral">%s %s HTTP/1.%d\r\n\</span>
<a name="l01816"></a>01816 <span class="stringliteral">User-Agent: rpm/%s\r\n\</span>
<a name="l01817"></a>01817 <span class="stringliteral">Host: %s:%d\r\n\</span>
<a name="l01818"></a>01818 <span class="stringliteral">Accept: text/plain\r\n\</span>
<a name="l01819"></a>01819 <span class="stringliteral">Transfer-Encoding: chunked\r\n\</span>
<a name="l01820"></a>01820 <span class="stringliteral">\r\n\</span>
<a name="l01821"></a>01821 <span class="stringliteral">"</span>,      httpCmd, path, (u-&gt;<a class="code" href="structurlinfo__s.html#2fcc3dfd8942251085f7ae7aa1e82602">httpVersion</a> ? 1 : 0), <a class="code" href="config_8h.html#d50944c12fe46b051e56ecff63a08c17">VERSION</a>, hthost, port);
<a name="l01822"></a>01822 } <span class="keywordflow">else</span> {
<a name="l01823"></a>01823     sprintf(req, <span class="stringliteral">"\</span>
<a name="l01824"></a>01824 <span class="stringliteral">%s %s HTTP/1.%d\r\n\</span>
<a name="l01825"></a>01825 <span class="stringliteral">User-Agent: rpm/%s\r\n\</span>
<a name="l01826"></a>01826 <span class="stringliteral">Host: %s:%d\r\n\</span>
<a name="l01827"></a>01827 <span class="stringliteral">Accept: text/plain\r\n\</span>
<a name="l01828"></a>01828 <span class="stringliteral">\r\n\</span>
<a name="l01829"></a>01829 <span class="stringliteral">"</span>,      httpCmd, path, (u-&gt;<a class="code" href="structurlinfo__s.html#2fcc3dfd8942251085f7ae7aa1e82602">httpVersion</a> ? 1 : 0), <a class="code" href="config_8h.html#d50944c12fe46b051e56ecff63a08c17">VERSION</a>, hthost, port);
<a name="l01830"></a>01830 }
<a name="l01831"></a>01831 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01832"></a>01832 
<a name="l01833"></a>01833 <span class="keywordflow">if</span> (_ftp_debug)
<a name="l01834"></a>01834 fprintf(stderr, <span class="stringliteral">"-&gt; %s"</span>, req);
<a name="l01835"></a>01835 
<a name="l01836"></a>01836     len = strlen(req);
<a name="l01837"></a>01837     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(ctrl, req, len) != len) {
<a name="l01838"></a>01838         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38dfe5f4a8e52b1aa4a15964ad66f3db553e">FTPERR_SERVER_IO_ERROR</a>;
<a name="l01839"></a>01839         <span class="keywordflow">goto</span> errxit;
<a name="l01840"></a>01840     }
<a name="l01841"></a>01841 
<a name="l01842"></a>01842     <span class="comment">/*@-branchstate@*/</span>
<a name="l01843"></a>01843     <span class="keywordflow">if</span> (!strcmp(httpCmd, <span class="stringliteral">"PUT"</span>)) {
<a name="l01844"></a>01844         ctrl-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a> = 1;
<a name="l01845"></a>01845     } <span class="keywordflow">else</span> {
<a name="l01846"></a>01846 
<a name="l01847"></a>01847         rc = <a class="code" href="rpmio_8c.html#506270604c7cfed4a922b788ac2501e5">httpResp</a>(u, ctrl, NULL);
<a name="l01848"></a>01848 
<a name="l01849"></a>01849         <span class="keywordflow">if</span> (rc) {
<a name="l01850"></a>01850             <span class="keywordflow">if</span> (!retrying) {    <span class="comment">/* not HTTP_OK */</span>
<a name="l01851"></a>01851                 retrying = 1;
<a name="l01852"></a>01852                 <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(ctrl); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01853"></a>01853                 <span class="keywordflow">goto</span> reopen;
<a name="l01854"></a>01854             }
<a name="l01855"></a>01855             <span class="keywordflow">goto</span> errxit;
<a name="l01856"></a>01856         }
<a name="l01857"></a>01857     }
<a name="l01858"></a>01858     <span class="comment">/*@=branchstate@*/</span>
<a name="l01859"></a>01859 
<a name="l01860"></a>01860     ctrl = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(ctrl, <span class="stringliteral">"open data (httpReq)"</span>);
<a name="l01861"></a>01861     <span class="keywordflow">return</span> 0;
<a name="l01862"></a>01862 
<a name="l01863"></a>01863 errxit:
<a name="l01864"></a>01864     <span class="comment">/*@-observertrans@*/</span>
<a name="l01865"></a>01865     <a class="code" href="group__rpmio.html#g6b5537d2765a23330c35844d403aedc5">fdSetSyserrno</a>(ctrl, <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>, <a class="code" href="rpmio_8c.html#c6db8428595950b1927900800976324d">ftpStrerror</a>(rc));
<a name="l01866"></a>01866     <span class="comment">/*@=observertrans@*/</span>
<a name="l01867"></a>01867 errxit2:
<a name="l01868"></a>01868     <span class="comment">/*@-branchstate@*/</span>
<a name="l01869"></a>01869     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(ctrl) &gt;= 0)
<a name="l01870"></a>01870         <span class="comment">/*@-refcounttrans@*/</span> (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(ctrl); <span class="comment">/*@=refcounttrans@*/</span>
<a name="l01871"></a>01871     <span class="comment">/*@=branchstate@*/</span>
<a name="l01872"></a>01872     <span class="keywordflow">return</span> rc;
<a name="l01873"></a>01873 <span class="comment">/*@=usereleased@*/</span>
<a name="l01874"></a>01874 }
<a name="l01875"></a>01875 
<a name="l01876"></a>01876 <span class="comment">/* XXX DYING: unused */</span>
<a name="l01877"></a><a class="code" href="rpmio_8h.html#33e1ca49fdd6863fa48cef6a1dc467de">01877</a> <span class="keywordtype">void</span> * <a class="code" href="rpmio_8c.html#33e1ca49fdd6863fa48cef6a1dc467de">ufdGetUrlinfo</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l01878"></a>01878 {
<a name="l01879"></a>01879     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l01880"></a>01880     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a> == NULL)
<a name="l01881"></a>01881         <span class="keywordflow">return</span> NULL;
<a name="l01882"></a>01882     <span class="keywordflow">return</span> <a class="code" href="rpmurl_8h.html#c6c1cad826e839c25c2842ab97c0bd6e">urlLink</a>(fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a>, <span class="stringliteral">"ufdGetUrlinfo"</span>);
<a name="l01883"></a>01883 }
<a name="l01884"></a>01884 
<a name="l01885"></a>01885 <span class="comment">/* =============================================================== */</span>
<a name="l01886"></a><a class="code" href="rpmio_8c.html#52bffea6a35b9b856592e24f7a4d93db">01886</a> <span class="keyword">static</span> ssize_t <a class="code" href="rpmio_8c.html#52bffea6a35b9b856592e24f7a4d93db">ufdRead</a>(<span class="keywordtype">void</span> * cookie, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l01887"></a>01887         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l01888"></a>01888         <span class="comment">/*@modifies buf, fileSystem, internalState @*/</span>
<a name="l01889"></a>01889         <span class="comment">/*@requires maxSet(buf) &gt;= (count - 1) @*/</span>
<a name="l01890"></a>01890         <span class="comment">/*@ensures maxRead(buf) == result @*/</span>
<a name="l01891"></a>01891 {
<a name="l01892"></a>01892     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l01893"></a>01893     <span class="keywordtype">int</span> bytesRead;
<a name="l01894"></a>01894     <span class="keywordtype">int</span> total;
<a name="l01895"></a>01895 
<a name="l01896"></a>01896     <span class="comment">/* XXX preserve timedRead() behavior */</span>
<a name="l01897"></a>01897     <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>) {
<a name="l01898"></a>01898         <span class="keyword">struct </span>stat sb;
<a name="l01899"></a>01899         <span class="keywordtype">int</span> fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd);
<a name="l01900"></a>01900         (void) fstat(fdno, &amp;sb);
<a name="l01901"></a>01901         <span class="keywordflow">if</span> (S_ISREG(sb.st_mode))
<a name="l01902"></a>01902             <span class="keywordflow">return</span> <a class="code" href="rpmio_8c.html#6ef797fdef2a33b8657eede1910145a5">fdRead</a>(fd, buf, count);
<a name="l01903"></a>01903     }
<a name="l01904"></a>01904 
<a name="l01905"></a>01905     <a class="code" href="rpmio_8c.html#26c954164d1681f609d3f9a0e9d2b1a8">UFDONLY</a>(fd);
<a name="l01906"></a>01906     assert(fd-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a> &gt;= 0);
<a name="l01907"></a>01907 
<a name="l01908"></a>01908     <span class="keywordflow">for</span> (total = 0; total &lt; count; total += bytesRead) {
<a name="l01909"></a>01909 
<a name="l01910"></a>01910         <span class="keywordtype">int</span> rc;
<a name="l01911"></a>01911 
<a name="l01912"></a>01912         bytesRead = 0;
<a name="l01913"></a>01913 
<a name="l01914"></a>01914         <span class="comment">/* Is there data to read? */</span>
<a name="l01915"></a>01915         <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> total; <span class="comment">/* XXX simulate EOF */</span>
<a name="l01916"></a>01916         rc = <a class="code" href="rpmio_8c.html#e7bf383d1ec94b1ecfa584191ed09de1">fdReadable</a>(fd, fd-&gt;<a class="code" href="struct__FD__s.html#52856a7b911ae3bb44905d7dcd343723">rd_timeoutsecs</a>);
<a name="l01917"></a>01917 
<a name="l01918"></a>01918         switch (rc) {
<a name="l01919"></a>01919         <span class="keywordflow">case</span> -1:        <span class="comment">/* error */</span>
<a name="l01920"></a>01920         <span class="keywordflow">case</span>  0:        <span class="comment">/* timeout */</span>
<a name="l01921"></a>01921             <span class="keywordflow">return</span> total;
<a name="l01922"></a>01922             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01923"></a>01923         <span class="keywordflow">default</span>:        <span class="comment">/* data to read */</span>
<a name="l01924"></a>01924             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01925"></a>01925         }
<a name="l01926"></a>01926 
<a name="l01927"></a>01927 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01928"></a>01928         rc = <a class="code" href="rpmio_8c.html#6ef797fdef2a33b8657eede1910145a5">fdRead</a>(fd, buf + total, count - total);
<a name="l01929"></a>01929 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01930"></a>01930 
<a name="l01931"></a>01931         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01932"></a>01932             <span class="keywordflow">switch</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l01933"></a>01933             <span class="keywordflow">case</span> EWOULDBLOCK:
<a name="l01934"></a>01934                 <span class="keywordflow">continue</span>;
<a name="l01935"></a>01935                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01936"></a>01936             <span class="keywordflow">default</span>:
<a name="l01937"></a>01937                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01938"></a>01938             }
<a name="l01939"></a>01939 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l01940"></a>01940 fprintf(stderr, <span class="stringliteral">"*** read: rc %d errno %d %s \"%s\"\n"</span>, rc, <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>), buf);
<a name="l01941"></a>01941             <span class="keywordflow">return</span> rc;
<a name="l01942"></a>01942             <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l01943"></a>01943         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0) {
<a name="l01944"></a>01944             <span class="keywordflow">return</span> total;
<a name="l01945"></a>01945             <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l01946"></a>01946         }
<a name="l01947"></a>01947         bytesRead = rc;
<a name="l01948"></a>01948     }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950     <span class="keywordflow">return</span> count;
<a name="l01951"></a>01951 }
<a name="l01952"></a>01952 
<a name="l01953"></a><a class="code" href="rpmio_8c.html#333e8c934184fa0f405b08a7d2f9d773">01953</a> <span class="keyword">static</span> ssize_t <a class="code" href="rpmio_8c.html#333e8c934184fa0f405b08a7d2f9d773">ufdWrite</a>(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l01954"></a>01954         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l01955"></a>01955         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l01956"></a>01956 {
<a name="l01957"></a>01957     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l01958"></a>01958     <span class="keywordtype">int</span> bytesWritten;
<a name="l01959"></a>01959     <span class="keywordtype">int</span> total = 0;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961 <span class="preprocessor">#ifdef  NOTYET</span>
<a name="l01962"></a>01962 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>) {
<a name="l01963"></a>01963         <span class="keyword">struct </span>stat sb;
<a name="l01964"></a>01964         (void) fstat(<a class="code" href="group__rpmio.html#gcc4deea09d28ccd7f289bf804d7dcb18">fdGetFdno</a>(fd), &amp;sb);
<a name="l01965"></a>01965         <span class="keywordflow">if</span> (S_ISREG(sb.st_mode))
<a name="l01966"></a>01966             <span class="keywordflow">return</span> <a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(fd, buf, count);
<a name="l01967"></a>01967     }
<a name="l01968"></a>01968 <span class="preprocessor">#endif</span>
<a name="l01969"></a>01969 <span class="preprocessor"></span>
<a name="l01970"></a>01970     <a class="code" href="rpmio_8c.html#26c954164d1681f609d3f9a0e9d2b1a8">UFDONLY</a>(fd);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972     <span class="keywordflow">for</span> (total = 0; total &lt; count; total += bytesWritten) {
<a name="l01973"></a>01973 
<a name="l01974"></a>01974         <span class="keywordtype">int</span> rc;
<a name="l01975"></a>01975 
<a name="l01976"></a>01976         bytesWritten = 0;
<a name="l01977"></a>01977 
<a name="l01978"></a>01978         <span class="comment">/* Is there room to write data? */</span>
<a name="l01979"></a>01979         <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) {
<a name="l01980"></a>01980 fprintf(stderr, <span class="stringliteral">"*** ufdWrite fd %p WRITE PAST END OF CONTENT\n"</span>, fd);
<a name="l01981"></a>01981             <span class="keywordflow">return</span> total;       <span class="comment">/* XXX simulate EOF */</span>
<a name="l01982"></a>01982         }
<a name="l01983"></a>01983         rc = <a class="code" href="rpmio_8c.html#74370513bf226276d69c6837ce6872b9">fdWritable</a>(fd, 2);         <span class="comment">/* XXX configurable? */</span>
<a name="l01984"></a>01984 
<a name="l01985"></a>01985         <span class="keywordflow">switch</span> (rc) {
<a name="l01986"></a>01986         <span class="keywordflow">case</span> -1:        <span class="comment">/* error */</span>
<a name="l01987"></a>01987         <span class="keywordflow">case</span>  0:        <span class="comment">/* timeout */</span>
<a name="l01988"></a>01988             <span class="keywordflow">return</span> total;
<a name="l01989"></a>01989             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01990"></a>01990         <span class="keywordflow">default</span>:        <span class="comment">/* data to write */</span>
<a name="l01991"></a>01991             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01992"></a>01992         }
<a name="l01993"></a>01993 
<a name="l01994"></a>01994         rc = <a class="code" href="rpmio_8c.html#fe17d82d9339a3b1a16397fc0c3f138c">fdWrite</a>(fd, buf + total, count - total);
<a name="l01995"></a>01995 
<a name="l01996"></a>01996         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l01997"></a>01997             <span class="keywordflow">switch</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l01998"></a>01998             <span class="keywordflow">case</span> EWOULDBLOCK:
<a name="l01999"></a>01999                 <span class="keywordflow">continue</span>;
<a name="l02000"></a>02000                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02001"></a>02001             <span class="keywordflow">default</span>:
<a name="l02002"></a>02002                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02003"></a>02003             }
<a name="l02004"></a>02004 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l02005"></a>02005 fprintf(stderr, <span class="stringliteral">"*** write: rc %d errno %d %s \"%s\"\n"</span>, rc, <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>), buf);
<a name="l02006"></a>02006             <span class="keywordflow">return</span> rc;
<a name="l02007"></a>02007             <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l02008"></a>02008         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0) {
<a name="l02009"></a>02009             <span class="keywordflow">return</span> total;
<a name="l02010"></a>02010             <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l02011"></a>02011         }
<a name="l02012"></a>02012         bytesWritten = rc;
<a name="l02013"></a>02013     }
<a name="l02014"></a>02014 
<a name="l02015"></a>02015     <span class="keywordflow">return</span> count;
<a name="l02016"></a>02016 }
<a name="l02017"></a>02017 
<a name="l02018"></a><a class="code" href="rpmio_8c.html#be1b4a9be70b2f10e3045945db44d6bf">02018</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#be1b4a9be70b2f10e3045945db44d6bf">ufdSeek</a>(<span class="keywordtype">void</span> * cookie, <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos, <span class="keywordtype">int</span> whence)
<a name="l02019"></a>02019         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02020"></a>02020         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02021"></a>02021 {
<a name="l02022"></a>02022     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02023"></a>02023 
<a name="l02024"></a>02024     <span class="keywordflow">switch</span> (fd-&gt;<a class="code" href="struct__FD__s.html#31c0f4a49be2e2eed552d198a10fcf12">urlType</a>) {
<a name="l02025"></a>02025     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l02026"></a>02026     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l02027"></a>02027         <span class="keywordflow">break</span>;
<a name="l02028"></a>02028     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l02029"></a>02029     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l02030"></a>02030     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l02031"></a>02031     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l02032"></a>02032     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l02033"></a>02033     <span class="keywordflow">default</span>:
<a name="l02034"></a>02034         <span class="keywordflow">return</span> -2;
<a name="l02035"></a>02035         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l02036"></a>02036     }
<a name="l02037"></a>02037     <span class="keywordflow">return</span> <a class="code" href="rpmio_8c.html#a80cc4e0b022c3c26430198574847989">fdSeek</a>(cookie, pos, whence);
<a name="l02038"></a>02038 }
<a name="l02039"></a>02039 
<a name="l02040"></a>02040 <span class="comment">/*@-branchstate@*/</span>
<a name="l02041"></a>02041 <span class="comment">/*@-usereleased@*/</span>      <span class="comment">/* LCL: fd handling is tricky here. */</span>
<a name="l02042"></a><a class="code" href="group__rpmio.html#g96fee811afb511f17448141ad62d8e99">02042</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmio.html#g96fee811afb511f17448141ad62d8e99">ufdClose</a>( <span class="comment">/*@only@*/</span> <span class="keywordtype">void</span> * cookie)
<a name="l02043"></a>02043 {
<a name="l02044"></a>02044     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02045"></a>02045 
<a name="l02046"></a>02046     <a class="code" href="rpmio_8c.html#26c954164d1681f609d3f9a0e9d2b1a8">UFDONLY</a>(fd);
<a name="l02047"></a>02047 
<a name="l02048"></a>02048     <span class="comment">/*@-branchstate@*/</span>
<a name="l02049"></a>02049     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a>) {
<a name="l02050"></a>02050         <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u = fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a>;
<a name="l02051"></a>02051 
<a name="l02052"></a>02052         <span class="keywordflow">if</span> (fd == u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>)
<a name="l02053"></a>02053                 fd = u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"grab data (ufdClose persist)"</span>);
<a name="l02054"></a>02054         <span class="keywordflow">else</span>
<a name="l02055"></a>02055                 fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"grab data (ufdClose)"</span>);
<a name="l02056"></a>02056         (void) <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a>, <span class="stringliteral">"url (ufdClose)"</span>);
<a name="l02057"></a>02057         fd-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a> = NULL;
<a name="l02058"></a>02058         u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"grab ctrl (ufdClose)"</span>);
<a name="l02059"></a>02059 
<a name="l02060"></a>02060         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>) {
<a name="l02061"></a>02061 
<a name="l02062"></a>02062             <span class="comment">/* XXX if not using libio, lose the fp from fpio */</span>
<a name="l02063"></a>02063             {   FILE * fp;
<a name="l02064"></a>02064                 <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l02065"></a>02065                 fp = <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd);
<a name="l02066"></a>02066                 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a> &amp;&amp; fp)
<a name="l02067"></a>02067                     <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, NULL);
<a name="l02068"></a>02068                 <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l02069"></a>02069             }
<a name="l02070"></a>02070 
<a name="l02071"></a>02071             <span class="comment">/*</span>
<a name="l02072"></a>02072 <span class="comment">             * Non-error FTP has 4 refs on the data fd:</span>
<a name="l02073"></a>02073 <span class="comment">             *  "persist data (ufdOpen FTP)"            rpmio.c:888</span>
<a name="l02074"></a>02074 <span class="comment">             *  "grab data (ufdOpen FTP)"               rpmio.c:892</span>
<a name="l02075"></a>02075 <span class="comment">             *  "open data (ftpReq)"                    ftp.c:633</span>
<a name="l02076"></a>02076 <span class="comment">             *  "fopencookie"                           rpmio.c:1507</span>
<a name="l02077"></a>02077 <span class="comment">             *</span>
<a name="l02078"></a>02078 <span class="comment">             * Non-error FTP has 5 refs on the ctrl fd:</span>
<a name="l02079"></a>02079 <span class="comment">             *  "persist ctrl"                          url.c:176</span>
<a name="l02080"></a>02080 <span class="comment">             *  "grab ctrl (urlConnect FTP)"            rpmio.c:404</span>
<a name="l02081"></a>02081 <span class="comment">             *  "open ctrl"                             ftp.c:504</span>
<a name="l02082"></a>02082 <span class="comment">             *  "grab data (ftpReq)"                    ftp.c:661</span>
<a name="l02083"></a>02083 <span class="comment">             *  "open data (ftpReq)"                    ftp.c:662</span>
<a name="l02084"></a>02084 <span class="comment">             */</span>
<a name="l02085"></a>02085             <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> &gt; 0) {
<a name="l02086"></a>02086                 <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a>) {
<a name="l02087"></a>02087                     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#e7bf383d1ec94b1ecfa584191ed09de1">fdReadable</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, 0) &gt; 0)
<a name="l02088"></a>02088                         (void) <a class="code" href="rpmio_8c.html#bb40b3ebfc08e116be0a62c4e76be083">ftpFileDone</a>(u, fd);
<a name="l02089"></a>02089                     <span class="keywordflow">else</span>
<a name="l02090"></a>02090                         (<span class="keywordtype">void</span>) <a class="code" href="rpmio_8c.html#b1ab49d4ef260d6eab1658619d1bd1f8">ftpAbort</a>(u, fd);
<a name="l02091"></a>02091                 }
<a name="l02092"></a>02092             } <span class="keywordflow">else</span> {
<a name="l02093"></a>02093                 <span class="keywordtype">int</span> rc;
<a name="l02094"></a>02094                 <span class="comment">/* XXX STOR et al require close before ftpFileDone */</span>
<a name="l02095"></a>02095                 <span class="comment">/*@-refcounttrans@*/</span>
<a name="l02096"></a>02096                 rc = <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(fd);
<a name="l02097"></a>02097                 <span class="comment">/*@=refcounttrans@*/</span>
<a name="l02098"></a>02098 <span class="preprocessor">#if 0   </span><span class="comment">/* XXX error exit from ufdOpen does not have this set */</span>
<a name="l02099"></a>02099                 assert(fd-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a> != 0);
<a name="l02100"></a>02100 <span class="preprocessor">#endif</span>
<a name="l02101"></a>02101 <span class="preprocessor"></span>                <span class="comment">/*@-compdef@*/</span> <span class="comment">/* FIX: u-&gt;data undefined */</span>
<a name="l02102"></a>02102                 <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#22ba0fb5f14e44ca03bfa17365836c3b">ftpFileDoneNeeded</a>)
<a name="l02103"></a>02103                     (void) <a class="code" href="rpmio_8c.html#bb40b3ebfc08e116be0a62c4e76be083">ftpFileDone</a>(u, fd);
<a name="l02104"></a>02104                 <span class="comment">/*@=compdef@*/</span>
<a name="l02105"></a>02105                 <span class="keywordflow">return</span> rc;
<a name="l02106"></a>02106             }
<a name="l02107"></a>02107         }
<a name="l02108"></a>02108 
<a name="l02109"></a>02109         <span class="comment">/* XXX Why not (u-&gt;urltype == URL_IS_HTTP) ??? */</span>
<a name="l02110"></a>02110         <span class="comment">/* XXX Why not (u-&gt;urltype == URL_IS_HTTPS) ??? */</span>
<a name="l02111"></a>02111         <span class="comment">/* XXX Why not (u-&gt;urltype == URL_IS_HKP) ??? */</span>
<a name="l02112"></a>02112         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> != NULL
<a name="l02113"></a>02113          &amp;&amp; (!strncmp(u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a>, <span class="stringliteral">"http"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"http"</span>)-1) || !strncmp(u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a>, <span class="stringliteral">"hkp"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"hkp"</span>)-1)))
<a name="l02114"></a>02114         {
<a name="l02115"></a>02115             <span class="comment">/*</span>
<a name="l02116"></a>02116 <span class="comment">             * HTTP has 4 (or 5 if persistent malloc) refs on the fd:</span>
<a name="l02117"></a>02117 <span class="comment">             *  "persist ctrl"                          url.c:177</span>
<a name="l02118"></a>02118 <span class="comment">             *  "grab ctrl (ufdOpen HTTP)"              rpmio.c:924</span>
<a name="l02119"></a>02119 <span class="comment">             *  "grab data (ufdOpen HTTP)"              rpmio.c:928</span>
<a name="l02120"></a>02120 <span class="comment">             *  "open ctrl (httpReq)"                   ftp.c:382</span>
<a name="l02121"></a>02121 <span class="comment">             *  "open data (httpReq)"                   ftp.c:435</span>
<a name="l02122"></a>02122 <span class="comment">             */</span>
<a name="l02123"></a>02123 
<a name="l02124"></a>02124             <span class="keywordflow">if</span> (fd == u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>)
<a name="l02125"></a>02125                 fd = u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open data (ufdClose HTTP persist ctrl)"</span>);
<a name="l02126"></a>02126             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fd == u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>)
<a name="l02127"></a>02127                 fd = u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open data (ufdClose HTTP persist data)"</span>);
<a name="l02128"></a>02128             <span class="keywordflow">else</span>
<a name="l02129"></a>02129                 fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open data (ufdClose HTTP)"</span>);
<a name="l02130"></a>02130 
<a name="l02131"></a>02131             <span class="comment">/* XXX if not using libio, lose the fp from fpio */</span>
<a name="l02132"></a>02132             {   FILE * fp;
<a name="l02133"></a>02133                 <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l02134"></a>02134                 fp = <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd);
<a name="l02135"></a>02135                 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a> &amp;&amp; fp)
<a name="l02136"></a>02136                     <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, NULL);
<a name="l02137"></a>02137                 <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l02138"></a>02138             }
<a name="l02139"></a>02139 
<a name="l02140"></a>02140             <span class="comment">/* If content remains, then don't persist. */</span>
<a name="l02141"></a>02141             <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> &gt; 0)
<a name="l02142"></a>02142                 fd-&gt;<a class="code" href="struct__FD__s.html#9291417ba2a470d34437ec7cd0629ea1">persist</a> = 0;
<a name="l02143"></a>02143             fd-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> = fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> = -1;
<a name="l02144"></a>02144 
<a name="l02145"></a>02145             <span class="comment">/* If persisting, then Fclose will juggle refcounts. */</span>
<a name="l02146"></a>02146             <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#9291417ba2a470d34437ec7cd0629ea1">persist</a> &amp;&amp; (fd == u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> || fd == u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>))
<a name="l02147"></a>02147                 <span class="keywordflow">return</span> 0;
<a name="l02148"></a>02148         }
<a name="l02149"></a>02149     }
<a name="l02150"></a>02150     <span class="keywordflow">return</span> <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(fd);
<a name="l02151"></a>02151 }
<a name="l02152"></a>02152 <span class="comment">/*@=usereleased@*/</span>
<a name="l02153"></a>02153 <span class="comment">/*@=branchstate@*/</span>
<a name="l02154"></a>02154 
<a name="l02155"></a>02155 <span class="comment">/*@-nullstate@*/</span>        <span class="comment">/* FIX: u-&gt;{ctrl,data}-&gt;url undef after XurlLink. */</span>
<a name="l02156"></a><a class="code" href="group__rpmio.html#gb43222cbeef3320495bb2c43c0d1d651">02156</a> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="group__rpmio.html#gb43222cbeef3320495bb2c43c0d1d651">ftpOpen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *url, <span class="comment">/*@unused@*/</span> <span class="keywordtype">int</span> flags,
<a name="l02157"></a>02157                 <span class="comment">/*@unused@*/</span> mode_t mode, <span class="comment">/*@out@*/</span> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> *uret)
<a name="l02158"></a>02158         <span class="comment">/*@modifies *uret @*/</span>
<a name="l02159"></a>02159 {
<a name="l02160"></a>02160     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u = NULL;
<a name="l02161"></a>02161     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = NULL;
<a name="l02162"></a>02162 
<a name="l02163"></a>02163 <span class="preprocessor">#if 0   </span><span class="comment">/* XXX makeTempFile() heartburn */</span>
<a name="l02164"></a>02164     assert(!(flags &amp; O_RDWR));
<a name="l02165"></a>02165 <span class="preprocessor">#endif</span>
<a name="l02166"></a>02166 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#e2dbaf9850990f4cd88d62bdd9731d7b">urlConnect</a>(url, &amp;u) &lt; 0)
<a name="l02167"></a>02167         <span class="keywordflow">goto</span> exit;
<a name="l02168"></a>02168 
<a name="l02169"></a>02169     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> == NULL)
<a name="l02170"></a>02170         u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"persist data (ftpOpen)"</span>);
<a name="l02171"></a>02171 
<a name="l02172"></a>02172     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a> == NULL)
<a name="l02173"></a>02173         fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>, <span class="stringliteral">"grab data (ftpOpen persist data)"</span>);
<a name="l02174"></a>02174     <span class="keywordflow">else</span>
<a name="l02175"></a>02175         fd = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"grab data (ftpOpen)"</span>);
<a name="l02176"></a>02176 
<a name="l02177"></a>02177     <span class="keywordflow">if</span> (fd) {
<a name="l02178"></a>02178         <a class="code" href="group__rpmio.html#gc47f81dea769678613395bd3d291147e">fdSetIo</a>(fd, <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>);
<a name="l02179"></a>02179         fd-&gt;ftpFileDoneNeeded = 0;
<a name="l02180"></a>02180         fd-&gt;rd_timeoutsecs = <a class="code" href="rpmio_8c.html#e9746945efef21a62e0a404fe440962b">ftpTimeoutSecs</a>;
<a name="l02181"></a>02181         fd-&gt;contentLength = fd-&gt;bytesRemain = -1;
<a name="l02182"></a>02182         fd-&gt;url = <a class="code" href="rpmurl_8h.html#c6c1cad826e839c25c2842ab97c0bd6e">urlLink</a>(u, <span class="stringliteral">"url (ufdOpen FTP)"</span>);
<a name="l02183"></a>02183         fd-&gt;urlType = <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>;
<a name="l02184"></a>02184     }
<a name="l02185"></a>02185 
<a name="l02186"></a>02186 exit:
<a name="l02187"></a>02187 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02188"></a>02188     <span class="keywordflow">if</span> (uret)
<a name="l02189"></a>02189         *uret = u;
<a name="l02190"></a>02190 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02191"></a>02191     <span class="comment">/*@-refcounttrans@*/</span>
<a name="l02192"></a>02192     <span class="keywordflow">return</span> fd;
<a name="l02193"></a>02193     <span class="comment">/*@=refcounttrans@*/</span>
<a name="l02194"></a>02194 }
<a name="l02195"></a>02195 <span class="comment">/*@=nullstate@*/</span>
<a name="l02196"></a>02196 
<a name="l02197"></a>02197 <span class="preprocessor">#ifndef WITH_NEON</span>
<a name="l02198"></a>02198 <span class="preprocessor"></span><span class="comment">/*@-nullstate@*/</span>        <span class="comment">/* FIX: u-&gt;{ctrl,data}-&gt;url undef after XurlLink. */</span>
<a name="l02199"></a><a class="code" href="rpmio_8c.html#35aa425211638ca103840e9f2c35af59">02199</a> <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#35aa425211638ca103840e9f2c35af59">httpOpen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url, <span class="comment">/*@unused@*/</span> <span class="keywordtype">int</span> flags,
<a name="l02200"></a>02200                 <span class="comment">/*@unused@*/</span> mode_t mode, <span class="comment">/*@out@*/</span> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> * uret)
<a name="l02201"></a>02201         <span class="comment">/*@globals internalState @*/</span>
<a name="l02202"></a>02202         <span class="comment">/*@modifies *uret, internalState @*/</span>
<a name="l02203"></a>02203 {
<a name="l02204"></a>02204     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u = NULL;
<a name="l02205"></a>02205     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = NULL;
<a name="l02206"></a>02206 
<a name="l02207"></a>02207 <span class="preprocessor">#if 0   </span><span class="comment">/* XXX makeTempFile() heartburn */</span>
<a name="l02208"></a>02208     assert(!(flags &amp; O_RDWR));
<a name="l02209"></a>02209 <span class="preprocessor">#endif</span>
<a name="l02210"></a>02210 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#317bdf1b8d8cf4ee786d8f38f8094cb2" title="Parse URL string into a control structure.">urlSplit</a>(url, &amp;u))
<a name="l02211"></a>02211         <span class="keywordflow">goto</span> exit;
<a name="l02212"></a>02212 
<a name="l02213"></a>02213     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> == NULL)
<a name="l02214"></a>02214         u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"persist ctrl (httpOpen)"</span>);
<a name="l02215"></a>02215     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>-&gt;<a class="code" href="struct__FD__s.html#2ccba788a8ecadf0c562c7a35df25361">nrefs</a> &gt; 2 &amp;&amp; u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> == NULL)
<a name="l02216"></a>02216         u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"persist data (httpOpen)"</span>);
<a name="l02217"></a>02217 
<a name="l02218"></a>02218     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a> == NULL)
<a name="l02219"></a>02219         fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"grab ctrl (httpOpen persist ctrl)"</span>);
<a name="l02220"></a>02220     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>-&gt;<a class="code" href="struct__FD__s.html#d86d70f045a04fba95ac758d918cfd44">url</a> == NULL)
<a name="l02221"></a>02221         fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>, <span class="stringliteral">"grab ctrl (httpOpen persist data)"</span>);
<a name="l02222"></a>02222     <span class="keywordflow">else</span>
<a name="l02223"></a>02223         fd = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"grab ctrl (httpOpen)"</span>);
<a name="l02224"></a>02224 
<a name="l02225"></a>02225     <span class="keywordflow">if</span> (fd) {
<a name="l02226"></a>02226         <a class="code" href="group__rpmio.html#gc47f81dea769678613395bd3d291147e">fdSetIo</a>(fd, <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>);
<a name="l02227"></a>02227         fd-&gt;ftpFileDoneNeeded = 0;
<a name="l02228"></a>02228         fd-&gt;rd_timeoutsecs = <a class="code" href="rpmio_8c.html#8d3ed96efb923a51905969fee4460a16">httpTimeoutSecs</a>;
<a name="l02229"></a>02229         fd-&gt;contentLength = fd-&gt;bytesRemain = -1;
<a name="l02230"></a>02230         fd-&gt;url = <a class="code" href="rpmurl_8h.html#c6c1cad826e839c25c2842ab97c0bd6e">urlLink</a>(u, <span class="stringliteral">"url (httpOpen)"</span>);
<a name="l02231"></a>02231         fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"grab data (httpOpen)"</span>);
<a name="l02232"></a>02232         fd-&gt;urlType = <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>;
<a name="l02233"></a>02233     }
<a name="l02234"></a>02234 
<a name="l02235"></a>02235 exit:
<a name="l02236"></a>02236 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02237"></a>02237     <span class="keywordflow">if</span> (uret)
<a name="l02238"></a>02238         *uret = u;
<a name="l02239"></a>02239 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02240"></a>02240     <span class="comment">/*@-refcounttrans@*/</span>
<a name="l02241"></a>02241     <span class="keywordflow">return</span> fd;
<a name="l02242"></a>02242     <span class="comment">/*@=refcounttrans@*/</span>
<a name="l02243"></a>02243 }
<a name="l02244"></a>02244 <span class="comment">/*@=nullstate@*/</span>
<a name="l02245"></a>02245 <span class="preprocessor">#endif</span>
<a name="l02246"></a>02246 <span class="preprocessor"></span>
<a name="l02247"></a><a class="code" href="rpmio_8c.html#6072c8ced11a7cbaff09f1852a1934f2">02247</a> <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#6072c8ced11a7cbaff09f1852a1934f2">ufdOpen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url, <span class="keywordtype">int</span> flags, mode_t mode)
<a name="l02248"></a>02248         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l02249"></a>02249         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02250"></a>02250 {
<a name="l02251"></a>02251     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = NULL;
<a name="l02252"></a>02252     <span class="keyword">const</span> <span class="keywordtype">char</span> * cmd;
<a name="l02253"></a>02253     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l02254"></a>02254     <span class="keyword">const</span> <span class="keywordtype">char</span> * path;
<a name="l02255"></a>02255     <a class="code" href="rpmurl_8h.html#8fc34597e828d3067e3844b571922d2d" title="Supported URL types.">urltype</a> urlType = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(url, &amp;path);
<a name="l02256"></a>02256 
<a name="l02257"></a>02257 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l02258"></a>02258 fprintf(stderr, <span class="stringliteral">"*** ufdOpen(%s,0x%x,0%o)\n"</span>, url, (<span class="keywordtype">unsigned</span>)flags, (<span class="keywordtype">unsigned</span>)mode);
<a name="l02259"></a>02259 
<a name="l02260"></a>02260     <span class="comment">/*@-branchstate@*/</span>
<a name="l02261"></a>02261     <span class="keywordflow">switch</span> (urlType) {
<a name="l02262"></a>02262     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l02263"></a>02263         fd = <a class="code" href="group__rpmio.html#gb43222cbeef3320495bb2c43c0d1d651">ftpOpen</a>(url, flags, mode, &amp;u);
<a name="l02264"></a>02264         <span class="keywordflow">if</span> (fd == NULL || u == NULL)
<a name="l02265"></a>02265             <span class="keywordflow">break</span>;
<a name="l02266"></a>02266 
<a name="l02267"></a>02267         <span class="comment">/* XXX W2DO? use STOU rather than STOR to prevent clobbering */</span>
<a name="l02268"></a>02268         cmd = ((flags &amp; O_WRONLY) 
<a name="l02269"></a>02269                 ?  ((flags &amp; O_APPEND) ? <span class="stringliteral">"APPE"</span> :
<a name="l02270"></a>02270                    ((flags &amp; O_CREAT) ? <span class="stringliteral">"STOR"</span> : <span class="stringliteral">"STOR"</span>))
<a name="l02271"></a>02271                 :  ((flags &amp; O_CREAT) ? <span class="stringliteral">"STOR"</span> : <span class="stringliteral">"RETR"</span>));
<a name="l02272"></a>02272         u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a> = <a class="code" href="group__rpmio.html#gb1bd7ba764e2c5af827dccbc02e2d488">ftpReq</a>(fd, cmd, path);
<a name="l02273"></a>02273         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a> &lt; 0) {
<a name="l02274"></a>02274             <span class="comment">/* XXX make sure that we can exit through ufdClose */</span>
<a name="l02275"></a>02275             fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"error data (ufdOpen FTP)"</span>);
<a name="l02276"></a>02276         } <span class="keywordflow">else</span> {
<a name="l02277"></a>02277             fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> = ((!strcmp(cmd, <span class="stringliteral">"RETR"</span>))
<a name="l02278"></a>02278                 ?  fd-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> : -1);
<a name="l02279"></a>02279             fd-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a> = 0;
<a name="l02280"></a>02280         }
<a name="l02281"></a>02281         <span class="keywordflow">break</span>;
<a name="l02282"></a>02282     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l02283"></a>02283     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l02284"></a>02284     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l02285"></a>02285 <span class="preprocessor">#ifdef WITH_NEON</span>
<a name="l02286"></a>02286 <span class="preprocessor"></span>        fd = davOpen(url, flags, mode, &amp;u);
<a name="l02287"></a>02287 <span class="preprocessor">#else</span>
<a name="l02288"></a>02288 <span class="preprocessor"></span>        fd = <a class="code" href="rpmio_8c.html#35aa425211638ca103840e9f2c35af59">httpOpen</a>(url, flags, mode, &amp;u);
<a name="l02289"></a>02289 <span class="preprocessor">#endif</span>
<a name="l02290"></a>02290 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fd == NULL || u == NULL)
<a name="l02291"></a>02291             <span class="keywordflow">break</span>;
<a name="l02292"></a>02292 
<a name="l02293"></a>02293         cmd = ((flags &amp; O_WRONLY)
<a name="l02294"></a>02294                 ?  ((flags &amp; O_APPEND) ? <span class="stringliteral">"PUT"</span> :
<a name="l02295"></a>02295                    ((flags &amp; O_CREAT) ? <span class="stringliteral">"PUT"</span> : <span class="stringliteral">"PUT"</span>))
<a name="l02296"></a>02296                 : <span class="stringliteral">"GET"</span>);
<a name="l02297"></a>02297 <span class="preprocessor">#ifdef WITH_NEON</span>
<a name="l02298"></a>02298 <span class="preprocessor"></span>        u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a> = davReq(fd, cmd, path);
<a name="l02299"></a>02299 <span class="preprocessor">#else</span>
<a name="l02300"></a>02300 <span class="preprocessor"></span>        u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a> = <a class="code" href="rpmio_8c.html#7453ee39c803e39f03e1a77b5fe18f41">httpReq</a>(fd, cmd, path);
<a name="l02301"></a>02301 <span class="preprocessor">#endif</span>
<a name="l02302"></a>02302 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#3e572af843a187395db03c073a683f9f">openError</a> &lt; 0) {
<a name="l02303"></a>02303             <span class="comment">/* XXX make sure that we can exit through ufdClose */</span>
<a name="l02304"></a>02304             fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"error ctrl (ufdOpen HTTP)"</span>);
<a name="l02305"></a>02305             fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"error data (ufdOpen HTTP)"</span>);
<a name="l02306"></a>02306         } <span class="keywordflow">else</span> {
<a name="l02307"></a>02307             fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> = ((!strcmp(cmd, <span class="stringliteral">"GET"</span>))
<a name="l02308"></a>02308                 ?  fd-&gt;<a class="code" href="struct__FD__s.html#74e13d5ecb1c4ab82453d0890cfee845">contentLength</a> : -1);
<a name="l02309"></a>02309             fd-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a> = ((!strcmp(cmd, <span class="stringliteral">"PUT"</span>))
<a name="l02310"></a>02310                 ?  fd-&gt;<a class="code" href="struct__FD__s.html#2c766b7bbfa821ea63e3be94458957a4">wr_chunked</a> : 0);
<a name="l02311"></a>02311         }
<a name="l02312"></a>02312         <span class="keywordflow">break</span>;
<a name="l02313"></a>02313     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l02314"></a>02314         assert(!(flags &amp; O_RDWR));
<a name="l02315"></a>02315         fd = <a class="code" href="rpmio_8c.html#671e4056425535bd1421347a5bcdacf9">fdDup</a>( ((flags &amp; O_WRONLY) ? STDOUT_FILENO : STDIN_FILENO) );
<a name="l02316"></a>02316         <span class="keywordflow">if</span> (fd) {
<a name="l02317"></a>02317             <a class="code" href="group__rpmio.html#gc47f81dea769678613395bd3d291147e">fdSetIo</a>(fd, <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>);
<a name="l02318"></a>02318             fd-&gt;rd_timeoutsecs = 600;   <span class="comment">/* XXX W2DO? 10 mins? */</span>
<a name="l02319"></a>02319             fd-&gt;contentLength = fd-&gt;bytesRemain = -1;
<a name="l02320"></a>02320         }
<a name="l02321"></a>02321         <span class="keywordflow">break</span>;
<a name="l02322"></a>02322     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l02323"></a>02323     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l02324"></a>02324     <span class="keywordflow">default</span>:
<a name="l02325"></a>02325         fd = <a class="code" href="rpmio_8c.html#4c1fcf2fbff64cf829bd61c90642fc42">fdOpen</a>(path, flags, mode);
<a name="l02326"></a>02326         <span class="keywordflow">if</span> (fd) {
<a name="l02327"></a>02327             <a class="code" href="group__rpmio.html#gc47f81dea769678613395bd3d291147e">fdSetIo</a>(fd, <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>);
<a name="l02328"></a>02328             fd-&gt;rd_timeoutsecs = 1;
<a name="l02329"></a>02329             fd-&gt;contentLength = fd-&gt;bytesRemain = -1;
<a name="l02330"></a>02330         }
<a name="l02331"></a>02331         <span class="keywordflow">break</span>;
<a name="l02332"></a>02332     }
<a name="l02333"></a>02333     <span class="comment">/*@=branchstate@*/</span>
<a name="l02334"></a>02334 
<a name="l02335"></a>02335     <span class="keywordflow">if</span> (fd == NULL) <span class="keywordflow">return</span> NULL;
<a name="l02336"></a>02336     fd-&gt;<a class="code" href="struct__FD__s.html#31c0f4a49be2e2eed552d198a10fcf12">urlType</a> = urlType;
<a name="l02337"></a>02337     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(fd) &lt; 0) {
<a name="l02338"></a>02338         (void) <a class="code" href="group__rpmio.html#g96fee811afb511f17448141ad62d8e99">ufdClose</a>(fd);
<a name="l02339"></a>02339         <span class="keywordflow">return</span> NULL;
<a name="l02340"></a>02340     }
<a name="l02341"></a>02341 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tufdOpen(\"%s\",%x,0%o) %s\n"</span>, url, (<span class="keywordtype">unsigned</span>)flags, (<span class="keywordtype">unsigned</span>)mode, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02342"></a>02342     <span class="keywordflow">return</span> fd;
<a name="l02343"></a>02343 }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345 <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l02346"></a><a class="code" href="rpmio_8c.html#a7d3f2e2e0883663f9342654f3bac74b">02346</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFDIO__s.html">FDIO_s</a> <a class="code" href="rpmio_8c.html#a7d3f2e2e0883663f9342654f3bac74b">ufdio_s</a> = {
<a name="l02347"></a>02347   <a class="code" href="rpmio_8c.html#52bffea6a35b9b856592e24f7a4d93db">ufdRead</a>, <a class="code" href="rpmio_8c.html#333e8c934184fa0f405b08a7d2f9d773">ufdWrite</a>, <a class="code" href="rpmio_8c.html#be1b4a9be70b2f10e3045945db44d6bf">ufdSeek</a>, <a class="code" href="group__rpmio.html#g96fee811afb511f17448141ad62d8e99">ufdClose</a>, <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>, <a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">XfdFree</a>, <a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">XfdNew</a>, <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>,
<a name="l02348"></a>02348   <a class="code" href="rpmio_8c.html#6072c8ced11a7cbaff09f1852a1934f2">ufdOpen</a>, NULL, <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>, NULL, <a class="code" href="rpmio_8h.html#4faa989db577f600d6a7ffdc73d779e6" title="mkdir(2) clone.">Mkdir</a>, <a class="code" href="rpmio_8h.html#41d271fe42dbc6e3a2d6cc9278b8565e" title="chdir(2) clone.">Chdir</a>, <a class="code" href="rpmio_8h.html#3e95a5143035de193cb66cc52486683d" title="rmdir(2) clone.">Rmdir</a>, <a class="code" href="rpmio_8h.html#95f4c89827f6555eba20d2eb2f955d7a" title="rename(2) clone.">Rename</a>, <a class="code" href="rpmio_8h.html#1c789f4e5cf1fb0106ec85ebad2406ad" title="unlink(2) clone.">Unlink</a>
<a name="l02349"></a>02349 };
<a name="l02350"></a>02350 <span class="comment">/*@=type@*/</span>
<a name="l02351"></a><a class="code" href="rpmio_8h.html#3380cbd41af873481b8a93f3f8159479">02351</a> <a class="code" href="structFDIO__s.html">FDIO_t</a> <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a> = <span class="comment">/*@-compmempass@*/</span> &amp;<a class="code" href="rpmio_8c.html#a7d3f2e2e0883663f9342654f3bac74b">ufdio_s</a> <span class="comment">/*@=compmempass@*/</span> ;
<a name="l02352"></a>02352 
<a name="l02353"></a>02353 <span class="comment">/* =============================================================== */</span>
<a name="l02354"></a>02354 <span class="comment">/* Support for GZIP library.</span>
<a name="l02355"></a>02355 <span class="comment"> */</span>
<a name="l02356"></a>02356 <span class="preprocessor">#ifdef  HAVE_ZLIB_H</span>
<a name="l02357"></a>02357 <span class="preprocessor"></span><span class="comment">/*@-moduncon@*/</span>
<a name="l02358"></a>02358 
<a name="l02359"></a>02359 <span class="comment">/*@-noparams@*/</span>
<a name="l02360"></a>02360 <span class="preprocessor">#include &lt;zlib.h&gt;</span>
<a name="l02361"></a>02361 <span class="comment">/*@=noparams@*/</span>
<a name="l02362"></a>02362 
<a name="l02363"></a>02363 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@dependent@*/</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> * gzdFileno(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02364"></a>02364         <span class="comment">/*@*/</span>
<a name="l02365"></a>02365 {
<a name="l02366"></a>02366     <span class="keywordtype">void</span> * rc = NULL;
<a name="l02367"></a>02367     <span class="keywordtype">int</span> i;
<a name="l02368"></a>02368 
<a name="l02369"></a>02369     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02370"></a>02370     <span class="keywordflow">for</span> (i = fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>; i &gt;= 0; i--) {
<a name="l02371"></a>02371 <span class="comment">/*@-boundsread@*/</span>
<a name="l02372"></a>02372         <a class="code" href="struct__FDSTACK__s.html">FDSTACK_t</a> * fps = &amp;fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[i];
<a name="l02373"></a>02373 <span class="comment">/*@=boundsread@*/</span>
<a name="l02374"></a>02374         <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> != <a class="code" href="rpmio_8h.html#8006ed5e13305414c48d5bddd32eda87">gzdio</a>)
<a name="l02375"></a>02375             <span class="keywordflow">continue</span>;
<a name="l02376"></a>02376         rc = fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>;
<a name="l02377"></a>02377         <span class="keywordflow">break</span>;
<a name="l02378"></a>02378     }
<a name="l02379"></a>02379     
<a name="l02380"></a>02380     <span class="keywordflow">return</span> rc;
<a name="l02381"></a>02381 }
<a name="l02382"></a>02382 
<a name="l02383"></a>02383 <span class="keyword">static</span> <span class="comment">/*@null@*/</span>
<a name="l02384"></a>02384 <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> gzdOpen(<span class="keyword">const</span> <span class="keywordtype">char</span> * path, <span class="keyword">const</span> <span class="keywordtype">char</span> * fmode)
<a name="l02385"></a>02385         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02386"></a>02386         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02387"></a>02387 {
<a name="l02388"></a>02388     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l02389"></a>02389     gzFile gzfile;
<a name="l02390"></a>02390     <span class="keywordflow">if</span> ((gzfile = gzopen(path, fmode)) == NULL)
<a name="l02391"></a>02391         <span class="keywordflow">return</span> NULL;
<a name="l02392"></a>02392     fd = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"open (gzdOpen)"</span>);
<a name="l02393"></a>02393     <a class="code" href="group__rpmio.html#g0681199a3bc301577673efffab678642">fdPop</a>(fd); <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, gzdio, gzfile, -1);
<a name="l02394"></a>02394     
<a name="l02395"></a>02395 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tgzdOpen(\"%s\", \"%s\") fd %p %s\n"</span>, path, fmode, (fd ? fd : NULL), <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02396"></a>02396     <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"gzdOpen"</span>);
<a name="l02397"></a>02397 }
<a name="l02398"></a>02398 
<a name="l02399"></a>02399 <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> gzdFdopen(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmode)
<a name="l02400"></a>02400         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02401"></a>02401         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02402"></a>02402 {
<a name="l02403"></a>02403     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02404"></a>02404     <span class="keywordtype">int</span> fdno;
<a name="l02405"></a>02405     gzFile gzfile;
<a name="l02406"></a>02406 
<a name="l02407"></a>02407     <span class="keywordflow">if</span> (fmode == NULL) <span class="keywordflow">return</span> NULL;
<a name="l02408"></a>02408     fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd);
<a name="l02409"></a>02409     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(fd, -1);          <span class="comment">/* XXX skip the fdio close */</span>
<a name="l02410"></a>02410     <span class="keywordflow">if</span> (fdno &lt; 0) <span class="keywordflow">return</span> NULL;
<a name="l02411"></a>02411     gzfile = gzdopen(fdno, fmode);
<a name="l02412"></a>02412     <span class="keywordflow">if</span> (gzfile == NULL) <span class="keywordflow">return</span> NULL;
<a name="l02413"></a>02413 
<a name="l02414"></a>02414     <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, gzdio, gzfile, fdno);            <span class="comment">/* Push gzdio onto stack */</span>
<a name="l02415"></a>02415 
<a name="l02416"></a>02416     <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"gzdFdopen"</span>);
<a name="l02417"></a>02417 }
<a name="l02418"></a>02418 
<a name="l02419"></a>02419 <span class="keyword">static</span> <span class="keywordtype">int</span> gzdFlush(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02420"></a>02420         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l02421"></a>02421         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l02422"></a>02422 {
<a name="l02423"></a>02423     gzFile gzfile;
<a name="l02424"></a>02424     gzfile = gzdFileno(fd);
<a name="l02425"></a>02425     <span class="keywordflow">if</span> (gzfile == NULL) <span class="keywordflow">return</span> -2;
<a name="l02426"></a>02426     <span class="keywordflow">return</span> gzflush(gzfile, Z_SYNC_FLUSH);       <span class="comment">/* XXX W2DO? */</span>
<a name="l02427"></a>02427 }
<a name="l02428"></a>02428 
<a name="l02429"></a>02429 <span class="comment">/* =============================================================== */</span>
<a name="l02430"></a>02430 <span class="keyword">static</span> ssize_t gzdRead(<span class="keywordtype">void</span> * cookie, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l02431"></a>02431         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02432"></a>02432         <span class="comment">/*@modifies buf, fileSystem, internalState @*/</span>
<a name="l02433"></a>02433 {
<a name="l02434"></a>02434     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02435"></a>02435     gzFile gzfile;
<a name="l02436"></a>02436     ssize_t rc;
<a name="l02437"></a>02437 
<a name="l02438"></a>02438     <span class="keywordflow">if</span> (fd == NULL || fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> 0;   <span class="comment">/* XXX simulate EOF */</span>
<a name="l02439"></a>02439 
<a name="l02440"></a>02440     gzfile = gzdFileno(fd);
<a name="l02441"></a>02441     <span class="keywordflow">if</span> (gzfile == NULL) <span class="keywordflow">return</span> -2;      <span class="comment">/* XXX can't happen */</span>
<a name="l02442"></a>02442 
<a name="l02443"></a>02443     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13f76ed3f89d0f2a6ed3dba717149020a1">FDSTAT_READ</a>);
<a name="l02444"></a>02444     rc = gzread(gzfile, buf, count);
<a name="l02445"></a>02445 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tgzdRead(%p,%p,%u) rc %lx %s\n"</span>, cookie, buf, (<span class="keywordtype">unsigned</span>)count, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02446"></a>02446     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02447"></a>02447         <span class="keywordtype">int</span> zerror = 0;
<a name="l02448"></a>02448         fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = gzerror(gzfile, &amp;zerror);
<a name="l02449"></a>02449         <span class="keywordflow">if</span> (zerror == Z_ERRNO) {
<a name="l02450"></a>02450             fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l02451"></a>02451             fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a>);
<a name="l02452"></a>02452         }
<a name="l02453"></a>02453     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt;= 0) {
<a name="l02454"></a>02454         <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13f76ed3f89d0f2a6ed3dba717149020a1">FDSTAT_READ</a>, rc);
<a name="l02455"></a>02455         <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#95fedde211083585c3cbc36fcb875d37">ndigests</a> &amp;&amp; rc &gt; 0) <a class="code" href="group__rpmio.html#g975f61657e5110723b61dc5b6a693509" title="Update digest(s) attached to fd.">fdUpdateDigests</a>(fd, buf, rc);
<a name="l02456"></a>02456     }
<a name="l02457"></a>02457     <span class="keywordflow">return</span> rc;
<a name="l02458"></a>02458 }
<a name="l02459"></a>02459 
<a name="l02460"></a>02460 <span class="keyword">static</span> ssize_t gzdWrite(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l02461"></a>02461         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02462"></a>02462         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02463"></a>02463 {
<a name="l02464"></a>02464     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02465"></a>02465     gzFile gzfile;
<a name="l02466"></a>02466     ssize_t rc;
<a name="l02467"></a>02467 
<a name="l02468"></a>02468     <span class="keywordflow">if</span> (fd == NULL || fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> 0;   <span class="comment">/* XXX simulate EOF */</span>
<a name="l02469"></a>02469 
<a name="l02470"></a>02470     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#95fedde211083585c3cbc36fcb875d37">ndigests</a> &amp;&amp; count &gt; 0) <a class="code" href="group__rpmio.html#g975f61657e5110723b61dc5b6a693509" title="Update digest(s) attached to fd.">fdUpdateDigests</a>(fd, buf, count);
<a name="l02471"></a>02471 
<a name="l02472"></a>02472     gzfile = gzdFileno(fd);
<a name="l02473"></a>02473     <span class="keywordflow">if</span> (gzfile == NULL) <span class="keywordflow">return</span> -2;      <span class="comment">/* XXX can't happen */</span>
<a name="l02474"></a>02474 
<a name="l02475"></a>02475     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd137d176cf33c540d67c9688548aa341570">FDSTAT_WRITE</a>);
<a name="l02476"></a>02476     rc = gzwrite(gzfile, (<span class="keywordtype">void</span> *)buf, count);
<a name="l02477"></a>02477 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tgzdWrite(%p,%p,%u) rc %lx %s\n"</span>, cookie, buf, (<span class="keywordtype">unsigned</span>)count, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02478"></a>02478     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02479"></a>02479         <span class="keywordtype">int</span> zerror = 0;
<a name="l02480"></a>02480         fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = gzerror(gzfile, &amp;zerror);
<a name="l02481"></a>02481         <span class="keywordflow">if</span> (zerror == Z_ERRNO) {
<a name="l02482"></a>02482             fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l02483"></a>02483             fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a>);
<a name="l02484"></a>02484         }
<a name="l02485"></a>02485     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt; 0) {
<a name="l02486"></a>02486         <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd137d176cf33c540d67c9688548aa341570">FDSTAT_WRITE</a>, rc);
<a name="l02487"></a>02487     }
<a name="l02488"></a>02488     <span class="keywordflow">return</span> rc;
<a name="l02489"></a>02489 }
<a name="l02490"></a>02490 
<a name="l02491"></a>02491 <span class="comment">/* XXX zlib-1.0.4 has not */</span>
<a name="l02492"></a>02492 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> gzdSeek(<span class="keywordtype">void</span> * cookie, <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos, <span class="keywordtype">int</span> whence)
<a name="l02493"></a>02493         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02494"></a>02494         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02495"></a>02495 {
<a name="l02496"></a>02496 <span class="preprocessor">#ifdef USE_COOKIE_SEEK_POINTER</span>
<a name="l02497"></a>02497 <span class="preprocessor"></span>    _IO_off64_t p = *pos;
<a name="l02498"></a>02498 <span class="preprocessor">#else</span>
<a name="l02499"></a>02499 <span class="preprocessor"></span>    off_t p = pos;
<a name="l02500"></a>02500 <span class="preprocessor">#endif</span>
<a name="l02501"></a>02501 <span class="preprocessor"></span>    <span class="keywordtype">int</span> rc;
<a name="l02502"></a>02502 <span class="preprocessor">#if HAVE_GZSEEK</span>
<a name="l02503"></a>02503 <span class="preprocessor"></span>    <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02504"></a>02504     gzFile gzfile;
<a name="l02505"></a>02505 
<a name="l02506"></a>02506     <span class="keywordflow">if</span> (fd == NULL) <span class="keywordflow">return</span> -2;
<a name="l02507"></a>02507     assert(fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == -1);      <span class="comment">/* XXX FIXME */</span>
<a name="l02508"></a>02508 
<a name="l02509"></a>02509     gzfile = gzdFileno(fd);
<a name="l02510"></a>02510     <span class="keywordflow">if</span> (gzfile == NULL) <span class="keywordflow">return</span> -2;      <span class="comment">/* XXX can't happen */</span>
<a name="l02511"></a>02511 
<a name="l02512"></a>02512     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13913aa37078e2181ae94b56e4afeabfd0">FDSTAT_SEEK</a>);
<a name="l02513"></a>02513     rc = gzseek(gzfile, p, whence);
<a name="l02514"></a>02514 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tgzdSeek(%p,%ld,%d) rc %lx %s\n"</span>, cookie, (<span class="keywordtype">long</span>)p, whence, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02515"></a>02515     <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02516"></a>02516         <span class="keywordtype">int</span> zerror = 0;
<a name="l02517"></a>02517         fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = gzerror(gzfile, &amp;zerror);
<a name="l02518"></a>02518         <span class="keywordflow">if</span> (zerror == Z_ERRNO) {
<a name="l02519"></a>02519             fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l02520"></a>02520             fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a>);
<a name="l02521"></a>02521         }
<a name="l02522"></a>02522     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt;= 0) {
<a name="l02523"></a>02523         <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13913aa37078e2181ae94b56e4afeabfd0">FDSTAT_SEEK</a>, rc);
<a name="l02524"></a>02524     }
<a name="l02525"></a>02525 <span class="preprocessor">#else</span>
<a name="l02526"></a>02526 <span class="preprocessor"></span>    rc = -2;
<a name="l02527"></a>02527 <span class="preprocessor">#endif</span>
<a name="l02528"></a>02528 <span class="preprocessor"></span>    <span class="keywordflow">return</span> rc;
<a name="l02529"></a>02529 }
<a name="l02530"></a>02530 
<a name="l02531"></a>02531 <span class="keyword">static</span> <span class="keywordtype">int</span> gzdClose( <span class="comment">/*@only@*/</span> <span class="keywordtype">void</span> * cookie)
<a name="l02532"></a>02532         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02533"></a>02533         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02534"></a>02534 {
<a name="l02535"></a>02535     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02536"></a>02536     gzFile gzfile;
<a name="l02537"></a>02537     <span class="keywordtype">int</span> rc;
<a name="l02538"></a>02538 
<a name="l02539"></a>02539     gzfile = gzdFileno(fd);
<a name="l02540"></a>02540     <span class="keywordflow">if</span> (gzfile == NULL) <span class="keywordflow">return</span> -2;      <span class="comment">/* XXX can't happen */</span>
<a name="l02541"></a>02541 
<a name="l02542"></a>02542     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd1326569f04d9a438c2b088e4716b755c4b">FDSTAT_CLOSE</a>);
<a name="l02543"></a>02543     <span class="comment">/*@-dependenttrans@*/</span>
<a name="l02544"></a>02544     rc = gzclose(gzfile);
<a name="l02545"></a>02545     <span class="comment">/*@=dependenttrans@*/</span>
<a name="l02546"></a>02546 
<a name="l02547"></a>02547     <span class="comment">/* XXX TODO: preserve fd if errors */</span>
<a name="l02548"></a>02548 
<a name="l02549"></a>02549     <span class="keywordflow">if</span> (fd) {
<a name="l02550"></a>02550 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tgzdClose(%p) zerror %d %s\n"</span>, cookie, rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02551"></a>02551         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02552"></a>02552             fd-&gt;errcookie = <span class="stringliteral">"gzclose error"</span>;
<a name="l02553"></a>02553             <span class="keywordflow">if</span> (rc == Z_ERRNO) {
<a name="l02554"></a>02554                 fd-&gt;syserrno = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l02555"></a>02555                 fd-&gt;errcookie = <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(fd-&gt;syserrno);
<a name="l02556"></a>02556             }
<a name="l02557"></a>02557         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt;= 0) {
<a name="l02558"></a>02558             <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd1326569f04d9a438c2b088e4716b755c4b">FDSTAT_CLOSE</a>, rc);
<a name="l02559"></a>02559         }
<a name="l02560"></a>02560     }
<a name="l02561"></a>02561 
<a name="l02562"></a>02562 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tgzdClose(%p) rc %lx %s\n"</span>, cookie, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02563"></a>02563 
<a name="l02564"></a>02564     <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a> || <a class="code" href="rpmmessages_8h.html#acf0bfe66457ef54024b347e601eac47">rpmIsDebug</a>()) <a class="code" href="group__rpmio.html#gb8d2e931364744f892cf49bc437c32ea">fdstat_print</a>(fd, <span class="stringliteral">"GZDIO"</span>, stderr);
<a name="l02565"></a>02565     <span class="comment">/*@-branchstate@*/</span>
<a name="l02566"></a>02566     <span class="keywordflow">if</span> (rc == 0)
<a name="l02567"></a>02567         fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open (gzdClose)"</span>);
<a name="l02568"></a>02568     <span class="comment">/*@=branchstate@*/</span>
<a name="l02569"></a>02569     <span class="keywordflow">return</span> rc;
<a name="l02570"></a>02570 }
<a name="l02571"></a>02571 
<a name="l02572"></a>02572 <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l02573"></a>02573 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFDIO__s.html">FDIO_s</a> gzdio_s = {
<a name="l02574"></a>02574   gzdRead, gzdWrite, gzdSeek, gzdClose, <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>, <a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">XfdFree</a>, <a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">XfdNew</a>, <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>,
<a name="l02575"></a>02575   NULL, gzdOpen, gzdFileno, gzdFlush,   NULL, NULL, NULL, NULL, NULL
<a name="l02576"></a>02576 };
<a name="l02577"></a>02577 <span class="comment">/*@=type@*/</span>
<a name="l02578"></a>02578 <a class="code" href="structFDIO__s.html">FDIO_t</a> <a class="code" href="rpmio_8h.html#8006ed5e13305414c48d5bddd32eda87">gzdio</a> = <span class="comment">/*@-compmempass@*/</span> &amp;gzdio_s <span class="comment">/*@=compmempass@*/</span> ;
<a name="l02579"></a>02579 
<a name="l02580"></a>02580 <span class="comment">/*@=moduncon@*/</span>
<a name="l02581"></a>02581 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_ZLIB_H */</span>
<a name="l02582"></a>02582 
<a name="l02583"></a>02583 <span class="comment">/* =============================================================== */</span>
<a name="l02584"></a>02584 <span class="comment">/* Support for BZIP2 library.</span>
<a name="l02585"></a>02585 <span class="comment"> */</span>
<a name="l02586"></a>02586 <span class="preprocessor">#if HAVE_BZLIB_H</span>
<a name="l02587"></a>02587 <span class="preprocessor"></span><span class="comment">/*@-moduncon@*/</span>
<a name="l02588"></a>02588 
<a name="l02589"></a>02589 <span class="preprocessor">#include &lt;bzlib.h&gt;</span>
<a name="l02590"></a>02590 
<a name="l02591"></a>02591 <span class="preprocessor">#ifdef HAVE_BZ2_1_0</span>
<a name="l02592"></a>02592 <span class="preprocessor"></span><span class="preprocessor"># define bzopen  BZ2_bzopen</span>
<a name="l02593"></a>02593 <span class="preprocessor"></span><span class="preprocessor"># define bzclose BZ2_bzclose</span>
<a name="l02594"></a>02594 <span class="preprocessor"></span><span class="preprocessor"># define bzdopen BZ2_bzdopen</span>
<a name="l02595"></a>02595 <span class="preprocessor"></span><span class="preprocessor"># define bzerror BZ2_bzerror</span>
<a name="l02596"></a>02596 <span class="preprocessor"></span><span class="preprocessor"># define bzflush BZ2_bzflush</span>
<a name="l02597"></a>02597 <span class="preprocessor"></span><span class="preprocessor"># define bzread  BZ2_bzread</span>
<a name="l02598"></a>02598 <span class="preprocessor"></span><span class="preprocessor"># define bzwrite BZ2_bzwrite</span>
<a name="l02599"></a>02599 <span class="preprocessor"></span><span class="preprocessor">#endif </span><span class="comment">/* HAVE_BZ2_1_0 */</span>
<a name="l02600"></a>02600 
<a name="l02601"></a>02601 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@dependent@*/</span> <span class="keywordtype">void</span> * bzdFileno(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02602"></a>02602         <span class="comment">/*@*/</span>
<a name="l02603"></a>02603 {
<a name="l02604"></a>02604     <span class="keywordtype">void</span> * rc = NULL;
<a name="l02605"></a>02605     <span class="keywordtype">int</span> i;
<a name="l02606"></a>02606 
<a name="l02607"></a>02607     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02608"></a>02608     <span class="keywordflow">for</span> (i = fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>; i &gt;= 0; i--) {
<a name="l02609"></a>02609 <span class="comment">/*@-boundsread@*/</span>
<a name="l02610"></a>02610         <a class="code" href="struct__FDSTACK__s.html">FDSTACK_t</a> * fps = &amp;fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[i];
<a name="l02611"></a>02611 <span class="comment">/*@=boundsread@*/</span>
<a name="l02612"></a>02612         <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> != bzdio)
<a name="l02613"></a>02613             <span class="keywordflow">continue</span>;
<a name="l02614"></a>02614         rc = fps-&gt;<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a>;
<a name="l02615"></a>02615         <span class="keywordflow">break</span>;
<a name="l02616"></a>02616     }
<a name="l02617"></a>02617     
<a name="l02618"></a>02618     <span class="keywordflow">return</span> rc;
<a name="l02619"></a>02619 }
<a name="l02620"></a>02620 
<a name="l02621"></a>02621 <span class="comment">/*@-globuse@*/</span>
<a name="l02622"></a>02622 <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> bzdOpen(<span class="keyword">const</span> <span class="keywordtype">char</span> * path, <span class="keyword">const</span> <span class="keywordtype">char</span> * mode)
<a name="l02623"></a>02623         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l02624"></a>02624         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l02625"></a>02625 {
<a name="l02626"></a>02626     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l02627"></a>02627     BZFILE *bzfile;;
<a name="l02628"></a>02628     <span class="keywordflow">if</span> ((bzfile = bzopen(path, mode)) == NULL)
<a name="l02629"></a>02629         <span class="keywordflow">return</span> NULL;
<a name="l02630"></a>02630     fd = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"open (bzdOpen)"</span>);
<a name="l02631"></a>02631     <a class="code" href="group__rpmio.html#g0681199a3bc301577673efffab678642">fdPop</a>(fd); <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, bzdio, bzfile, -1);
<a name="l02632"></a>02632     <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"bzdOpen"</span>);
<a name="l02633"></a>02633 }
<a name="l02634"></a>02634 <span class="comment">/*@=globuse@*/</span>
<a name="l02635"></a>02635 
<a name="l02636"></a>02636 <span class="comment">/*@-globuse@*/</span>
<a name="l02637"></a>02637 <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> bzdFdopen(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> * fmode)
<a name="l02638"></a>02638         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02639"></a>02639         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02640"></a>02640 {
<a name="l02641"></a>02641     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02642"></a>02642     <span class="keywordtype">int</span> fdno;
<a name="l02643"></a>02643     BZFILE *bzfile;
<a name="l02644"></a>02644 
<a name="l02645"></a>02645     <span class="keywordflow">if</span> (fmode == NULL) <span class="keywordflow">return</span> NULL;
<a name="l02646"></a>02646     fdno = <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd);
<a name="l02647"></a>02647     <a class="code" href="group__rpmio.html#g204d36a5a9ce83c6cd777b70bc2df3fd">fdSetFdno</a>(fd, -1);          <span class="comment">/* XXX skip the fdio close */</span>
<a name="l02648"></a>02648     <span class="keywordflow">if</span> (fdno &lt; 0) <span class="keywordflow">return</span> NULL;
<a name="l02649"></a>02649     bzfile = bzdopen(fdno, fmode);
<a name="l02650"></a>02650     <span class="keywordflow">if</span> (bzfile == NULL) <span class="keywordflow">return</span> NULL;
<a name="l02651"></a>02651 
<a name="l02652"></a>02652     <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, bzdio, bzfile, fdno);            <span class="comment">/* Push bzdio onto stack */</span>
<a name="l02653"></a>02653 
<a name="l02654"></a>02654     <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"bzdFdopen"</span>);
<a name="l02655"></a>02655 }
<a name="l02656"></a>02656 <span class="comment">/*@=globuse@*/</span>
<a name="l02657"></a>02657 
<a name="l02658"></a>02658 <span class="comment">/*@-globuse@*/</span>
<a name="l02659"></a>02659 <span class="keyword">static</span> <span class="keywordtype">int</span> bzdFlush(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02660"></a>02660         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l02661"></a>02661         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l02662"></a>02662 {
<a name="l02663"></a>02663     <span class="keywordflow">return</span> bzflush(bzdFileno(fd));
<a name="l02664"></a>02664 }
<a name="l02665"></a>02665 <span class="comment">/*@=globuse@*/</span>
<a name="l02666"></a>02666 
<a name="l02667"></a>02667 <span class="comment">/* =============================================================== */</span>
<a name="l02668"></a>02668 <span class="comment">/*@-globuse@*/</span>
<a name="l02669"></a>02669 <span class="comment">/*@-mustmod@*/</span>          <span class="comment">/* LCL: *buf is modified */</span>
<a name="l02670"></a>02670 <span class="keyword">static</span> ssize_t bzdRead(<span class="keywordtype">void</span> * cookie, <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l02671"></a>02671         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02672"></a>02672         <span class="comment">/*@modifies *buf, fileSystem, internalState @*/</span>
<a name="l02673"></a>02673 {
<a name="l02674"></a>02674     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02675"></a>02675     BZFILE *bzfile;
<a name="l02676"></a>02676     ssize_t rc = 0;
<a name="l02677"></a>02677 
<a name="l02678"></a>02678     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> 0; <span class="comment">/* XXX simulate EOF */</span>
<a name="l02679"></a>02679     bzfile = bzdFileno(fd);
<a name="l02680"></a>02680     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13f76ed3f89d0f2a6ed3dba717149020a1">FDSTAT_READ</a>);
<a name="l02681"></a>02681     <span class="keywordflow">if</span> (bzfile)
<a name="l02682"></a>02682         <span class="comment">/*@-compdef@*/</span>
<a name="l02683"></a>02683         rc = bzread(bzfile, buf, count);
<a name="l02684"></a>02684         <span class="comment">/*@=compdef@*/</span>
<a name="l02685"></a>02685     <span class="keywordflow">if</span> (rc == -1) {
<a name="l02686"></a>02686         <span class="keywordtype">int</span> zerror = 0;
<a name="l02687"></a>02687         <span class="keywordflow">if</span> (bzfile)
<a name="l02688"></a>02688             fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = bzerror(bzfile, &amp;zerror);
<a name="l02689"></a>02689     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt;= 0) {
<a name="l02690"></a>02690         <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd13f76ed3f89d0f2a6ed3dba717149020a1">FDSTAT_READ</a>, rc);
<a name="l02691"></a>02691         <span class="comment">/*@-compdef@*/</span>
<a name="l02692"></a>02692         <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#95fedde211083585c3cbc36fcb875d37">ndigests</a> &amp;&amp; rc &gt; 0) <a class="code" href="group__rpmio.html#g975f61657e5110723b61dc5b6a693509" title="Update digest(s) attached to fd.">fdUpdateDigests</a>(fd, buf, rc);
<a name="l02693"></a>02693         <span class="comment">/*@=compdef@*/</span>
<a name="l02694"></a>02694     }
<a name="l02695"></a>02695     <span class="keywordflow">return</span> rc;
<a name="l02696"></a>02696 }
<a name="l02697"></a>02697 <span class="comment">/*@=mustmod@*/</span>
<a name="l02698"></a>02698 <span class="comment">/*@=globuse@*/</span>
<a name="l02699"></a>02699 
<a name="l02700"></a>02700 <span class="comment">/*@-globuse@*/</span>
<a name="l02701"></a>02701 <span class="keyword">static</span> ssize_t bzdWrite(<span class="keywordtype">void</span> * cookie, <span class="keyword">const</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> count)
<a name="l02702"></a>02702         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02703"></a>02703         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02704"></a>02704 {
<a name="l02705"></a>02705     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02706"></a>02706     BZFILE *bzfile;
<a name="l02707"></a>02707     ssize_t rc;
<a name="l02708"></a>02708 
<a name="l02709"></a>02709     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#4373be95db55b037a82b5d2bffa2a6a6">bytesRemain</a> == 0) <span class="keywordflow">return</span> 0; <span class="comment">/* XXX simulate EOF */</span>
<a name="l02710"></a>02710 
<a name="l02711"></a>02711     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#95fedde211083585c3cbc36fcb875d37">ndigests</a> &amp;&amp; count &gt; 0) <a class="code" href="group__rpmio.html#g975f61657e5110723b61dc5b6a693509" title="Update digest(s) attached to fd.">fdUpdateDigests</a>(fd, buf, count);
<a name="l02712"></a>02712 
<a name="l02713"></a>02713     bzfile = bzdFileno(fd);
<a name="l02714"></a>02714     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd137d176cf33c540d67c9688548aa341570">FDSTAT_WRITE</a>);
<a name="l02715"></a>02715     rc = bzwrite(bzfile, (<span class="keywordtype">void</span> *)buf, count);
<a name="l02716"></a>02716     <span class="keywordflow">if</span> (rc == -1) {
<a name="l02717"></a>02717         <span class="keywordtype">int</span> zerror = 0;
<a name="l02718"></a>02718         fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = bzerror(bzfile, &amp;zerror);
<a name="l02719"></a>02719     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt; 0) {
<a name="l02720"></a>02720         <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd137d176cf33c540d67c9688548aa341570">FDSTAT_WRITE</a>, rc);
<a name="l02721"></a>02721     }
<a name="l02722"></a>02722     <span class="keywordflow">return</span> rc;
<a name="l02723"></a>02723 }
<a name="l02724"></a>02724 <span class="comment">/*@=globuse@*/</span>
<a name="l02725"></a>02725 
<a name="l02726"></a>02726 <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> bzdSeek(<span class="keywordtype">void</span> * cookie, <span class="comment">/*@unused@*/</span> <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos,
<a name="l02727"></a>02727                         <span class="comment">/*@unused@*/</span> <span class="keywordtype">int</span> whence)
<a name="l02728"></a>02728         <span class="comment">/*@*/</span>
<a name="l02729"></a>02729 {
<a name="l02730"></a>02730     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02731"></a>02731 
<a name="l02732"></a>02732     <a class="code" href="rpmio_8c.html#dcedc97818000c63f87b249151ad1f19">BZDONLY</a>(fd);
<a name="l02733"></a>02733     <span class="keywordflow">return</span> -2;
<a name="l02734"></a>02734 }
<a name="l02735"></a>02735 
<a name="l02736"></a>02736 <span class="keyword">static</span> <span class="keywordtype">int</span> bzdClose( <span class="comment">/*@only@*/</span> <span class="keywordtype">void</span> * cookie)
<a name="l02737"></a>02737         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l02738"></a>02738         <span class="comment">/*@modifies fileSystem, internalState @*/</span>
<a name="l02739"></a>02739 {
<a name="l02740"></a>02740     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="group__rpmio.html#gb391cd75dfba6b657600b6bd6b8a35f5">c2f</a>(cookie);
<a name="l02741"></a>02741     BZFILE *bzfile;
<a name="l02742"></a>02742     <span class="keywordtype">int</span> rc;
<a name="l02743"></a>02743 
<a name="l02744"></a>02744     bzfile = bzdFileno(fd);
<a name="l02745"></a>02745 
<a name="l02746"></a>02746     <span class="keywordflow">if</span> (bzfile == NULL) <span class="keywordflow">return</span> -2;
<a name="l02747"></a>02747     <a class="code" href="group__rpmio.html#g149d59904cdbad761791a5631f5f36f8">fdstat_enter</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd1326569f04d9a438c2b088e4716b755c4b">FDSTAT_CLOSE</a>);
<a name="l02748"></a>02748     <span class="comment">/*@-noeffectuncon@*/</span> <span class="comment">/* FIX: check rc */</span>
<a name="l02749"></a>02749     bzclose(bzfile);
<a name="l02750"></a>02750     <span class="comment">/*@=noeffectuncon@*/</span>
<a name="l02751"></a>02751     rc = 0;     <span class="comment">/* XXX FIXME */</span>
<a name="l02752"></a>02752 
<a name="l02753"></a>02753     <span class="comment">/* XXX TODO: preserve fd if errors */</span>
<a name="l02754"></a>02754 
<a name="l02755"></a>02755     <span class="keywordflow">if</span> (fd) {
<a name="l02756"></a>02756         <span class="keywordflow">if</span> (rc == -1) {
<a name="l02757"></a>02757             <span class="keywordtype">int</span> zerror = 0;
<a name="l02758"></a>02758             fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> = bzerror(bzfile, &amp;zerror);
<a name="l02759"></a>02759         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc &gt;= 0) {
<a name="l02760"></a>02760             <a class="code" href="group__rpmio.html#ge2948474ca348cb249b0b57fb43d2e8e">fdstat_exit</a>(fd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd1326569f04d9a438c2b088e4716b755c4b">FDSTAT_CLOSE</a>, rc);
<a name="l02761"></a>02761         }
<a name="l02762"></a>02762     }
<a name="l02763"></a>02763 
<a name="l02764"></a>02764 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt;\tbzdClose(%p) rc %lx %s\n"</span>, cookie, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02765"></a>02765 
<a name="l02766"></a>02766     <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a> || <a class="code" href="rpmmessages_8h.html#acf0bfe66457ef54024b347e601eac47">rpmIsDebug</a>()) <a class="code" href="group__rpmio.html#gb8d2e931364744f892cf49bc437c32ea">fdstat_print</a>(fd, <span class="stringliteral">"BZDIO"</span>, stderr);
<a name="l02767"></a>02767     <span class="comment">/*@-branchstate@*/</span>
<a name="l02768"></a>02768     <span class="keywordflow">if</span> (rc == 0)
<a name="l02769"></a>02769         fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"open (bzdClose)"</span>);
<a name="l02770"></a>02770     <span class="comment">/*@=branchstate@*/</span>
<a name="l02771"></a>02771     <span class="keywordflow">return</span> rc;
<a name="l02772"></a>02772 }
<a name="l02773"></a>02773 
<a name="l02774"></a>02774 <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l02775"></a>02775 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFDIO__s.html">FDIO_s</a> bzdio_s = {
<a name="l02776"></a>02776   bzdRead, bzdWrite, bzdSeek, bzdClose, <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>, <a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">XfdFree</a>, <a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">XfdNew</a>, <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>,
<a name="l02777"></a>02777   NULL, bzdOpen, bzdFileno, bzdFlush,   NULL, NULL, NULL, NULL, NULL
<a name="l02778"></a>02778 };
<a name="l02779"></a>02779 <span class="comment">/*@=type@*/</span>
<a name="l02780"></a>02780 <a class="code" href="structFDIO__s.html">FDIO_t</a> <a class="code" href="rpmio_8h.html#708b90fe8836a10b2983dcb4ca3c198e">bzdio</a> = <span class="comment">/*@-compmempass@*/</span> &amp;bzdio_s <span class="comment">/*@=compmempass@*/</span> ;
<a name="l02781"></a>02781 
<a name="l02782"></a>02782 <span class="comment">/*@=moduncon@*/</span>
<a name="l02783"></a>02783 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_BZLIB_H */</span>
<a name="l02784"></a>02784 
<a name="l02785"></a>02785 <span class="comment">/* =============================================================== */</span>
<a name="l02786"></a>02786 <span class="comment">/*@observer@*/</span>
<a name="l02787"></a><a class="code" href="rpmio_8c.html#fc9965cd223374e231e57a8bf2ba3626">02787</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmio_8c.html#fc9965cd223374e231e57a8bf2ba3626">getFdErrstr</a> (<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02788"></a>02788         <span class="comment">/*@*/</span>
<a name="l02789"></a>02789 {
<a name="l02790"></a>02790     <span class="keyword">const</span> <span class="keywordtype">char</span> *errstr = NULL;
<a name="l02791"></a>02791 
<a name="l02792"></a>02792 <span class="preprocessor">#ifdef  HAVE_ZLIB_H</span>
<a name="l02793"></a>02793 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == gzdio) {
<a name="l02794"></a>02794         errstr = fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a>;
<a name="l02795"></a>02795     } <span class="keywordflow">else</span>
<a name="l02796"></a>02796 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_ZLIB_H */</span>
<a name="l02797"></a>02797 
<a name="l02798"></a>02798 <span class="preprocessor">#ifdef  HAVE_BZLIB_H</span>
<a name="l02799"></a>02799 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == bzdio) {
<a name="l02800"></a>02800         errstr = fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a>;
<a name="l02801"></a>02801     } <span class="keywordflow">else</span>
<a name="l02802"></a>02802 <span class="preprocessor">#endif  </span><span class="comment">/* HAVE_BZLIB_H */</span>
<a name="l02803"></a>02803 
<a name="l02804"></a>02804     {
<a name="l02805"></a>02805         errstr = (fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a>) : <span class="stringliteral">""</span>);
<a name="l02806"></a>02806     }
<a name="l02807"></a>02807 
<a name="l02808"></a>02808     <span class="keywordflow">return</span> errstr;
<a name="l02809"></a>02809 }
<a name="l02810"></a>02810 
<a name="l02811"></a>02811 <span class="comment">/* =============================================================== */</span>
<a name="l02812"></a>02812 
<a name="l02813"></a><a class="code" href="rpmio_8h.html#89912365365ef408f46a76f2958fc78c">02813</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02814"></a>02814 {
<a name="l02815"></a>02815     <span class="keywordflow">if</span> (fd == NULL)
<a name="l02816"></a>02816         <span class="keywordflow">return</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) : <span class="stringliteral">""</span>);
<a name="l02817"></a>02817     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02818"></a>02818     <span class="keywordflow">return</span> <a class="code" href="rpmio_8c.html#fc9965cd223374e231e57a8bf2ba3626">getFdErrstr</a>(fd);
<a name="l02819"></a>02819 }
<a name="l02820"></a>02820 
<a name="l02821"></a><a class="code" href="rpmio_8c.html#48dc468d7f554afaa311d9abeeda122c">02821</a> <span class="preprocessor">#define FDIOVEC(_fd, _vec)      \</span>
<a name="l02822"></a>02822 <span class="preprocessor">  ((fdGetIo(_fd) &amp;&amp; fdGetIo(_fd)-&gt;_vec) ? fdGetIo(_fd)-&gt;_vec : NULL)</span>
<a name="l02823"></a>02823 <span class="preprocessor"></span>
<a name="l02824"></a><a class="code" href="rpmio_8h.html#243fbe7e1cc405489b11045e43e20207">02824</a> <span class="keywordtype">size_t</span> <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(<span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd) {
<a name="l02825"></a>02825     <a class="code" href="rpmio_8h.html#77cca54654353df344a1042771b44ede">fdio_read_function_t</a> _read;
<a name="l02826"></a>02826     <span class="keywordtype">int</span> rc;
<a name="l02827"></a>02827 
<a name="l02828"></a>02828     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02829"></a>02829 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Fread(%p,%u,%u,%p) %s\n"</span>, buf, (<span class="keywordtype">unsigned</span>)size, (<span class="keywordtype">unsigned</span>)nmemb, (fd ? fd : NULL), <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02830"></a>02830 
<a name="l02831"></a>02831     <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>) {
<a name="l02832"></a>02832         <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l02833"></a>02833         rc = fread(buf, size, nmemb, <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd));
<a name="l02834"></a>02834         <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l02835"></a>02835         <span class="keywordflow">return</span> rc;
<a name="l02836"></a>02836     }
<a name="l02837"></a>02837 
<a name="l02838"></a>02838     <span class="comment">/*@-nullderef@*/</span>
<a name="l02839"></a>02839     _read = <a class="code" href="rpmio_8c.html#48dc468d7f554afaa311d9abeeda122c">FDIOVEC</a>(fd, <a class="code" href="structFDIO__s.html#5a1aa8cdffbfb630acd5e8f92ac364f1">read</a>);
<a name="l02840"></a>02840     <span class="comment">/*@=nullderef@*/</span>
<a name="l02841"></a>02841 
<a name="l02842"></a>02842     rc = (_read ? (*_read) (fd, buf, size * nmemb) : -2);
<a name="l02843"></a>02843     <span class="keywordflow">return</span> rc;
<a name="l02844"></a>02844 }
<a name="l02845"></a>02845 
<a name="l02846"></a><a class="code" href="rpmio_8h.html#0b66d10b5a0e926d57e86327f4e9dcc6">02846</a> <span class="keywordtype">size_t</span> <a class="code" href="rpmio_8c.html#0b66d10b5a0e926d57e86327f4e9dcc6" title="fwrite(3) clone.">Fwrite</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *buf, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02847"></a>02847 {
<a name="l02848"></a>02848     <a class="code" href="rpmio_8h.html#f9652be80513cabd596ac2f210eecdec">fdio_write_function_t</a> _write;
<a name="l02849"></a>02849     <span class="keywordtype">int</span> rc;
<a name="l02850"></a>02850 
<a name="l02851"></a>02851     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02852"></a>02852 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Fwrite(%p,%u,%u,%p) %s\n"</span>, buf, (<span class="keywordtype">unsigned</span>)size, (<span class="keywordtype">unsigned</span>)nmemb, (fd ? fd : NULL), <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02853"></a>02853 
<a name="l02854"></a>02854     <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>) {
<a name="l02855"></a>02855 <span class="comment">/*@-boundsread@*/</span>
<a name="l02856"></a>02856         <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l02857"></a>02857         rc = fwrite(buf, size, nmemb, <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd));
<a name="l02858"></a>02858         <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l02859"></a>02859 <span class="comment">/*@=boundsread@*/</span>
<a name="l02860"></a>02860         <span class="keywordflow">return</span> rc;
<a name="l02861"></a>02861     }
<a name="l02862"></a>02862 
<a name="l02863"></a>02863     <span class="comment">/*@-nullderef@*/</span>
<a name="l02864"></a>02864     _write = <a class="code" href="rpmio_8c.html#48dc468d7f554afaa311d9abeeda122c">FDIOVEC</a>(fd, <a class="code" href="structFDIO__s.html#eaecdc0ee5105afecbf347d1d80440a7">write</a>);
<a name="l02865"></a>02865     <span class="comment">/*@=nullderef@*/</span>
<a name="l02866"></a>02866 
<a name="l02867"></a>02867     rc = (_write ? _write(fd, buf, size * nmemb) : -2);
<a name="l02868"></a>02868     <span class="keywordflow">return</span> rc;
<a name="l02869"></a>02869 }
<a name="l02870"></a>02870 
<a name="l02871"></a><a class="code" href="rpmio_8h.html#401ed5293490b3f87058f2aad606844a">02871</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#401ed5293490b3f87058f2aad606844a" title="fseek(3) clone.">Fseek</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd, <a class="code" href="group__rpmio.html#ge354580cbf0f2d412dbc21ace73e3535" title="Hide libio API lossage.">_libio_off_t</a> offset, <span class="keywordtype">int</span> whence) {
<a name="l02872"></a>02872     <a class="code" href="rpmio_8h.html#52b91f06ba4170ee850ddfe4533d98d5">fdio_seek_function_t</a> _seek;
<a name="l02873"></a>02873 <span class="preprocessor">#ifdef USE_COOKIE_SEEK_POINTER</span>
<a name="l02874"></a>02874 <span class="preprocessor"></span>    _IO_off64_t o64 = offset;
<a name="l02875"></a>02875     <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos = &amp;o64;
<a name="l02876"></a>02876 <span class="preprocessor">#else</span>
<a name="l02877"></a>02877 <span class="preprocessor"></span>    <a class="code" href="group__rpmio.html#g56fc71b362acd4def148e0c433ec5a4c">_libio_pos_t</a> pos = offset;
<a name="l02878"></a>02878 <span class="preprocessor">#endif</span>
<a name="l02879"></a>02879 <span class="preprocessor"></span>
<a name="l02880"></a>02880     <span class="keywordtype">long</span> <span class="keywordtype">int</span> rc;
<a name="l02881"></a>02881 
<a name="l02882"></a>02882     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02883"></a>02883 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Fseek(%p,%ld,%d) %s\n"</span>, fd, (<span class="keywordtype">long</span>)offset, whence, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02884"></a>02884 
<a name="l02885"></a>02885     <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>) {
<a name="l02886"></a>02886         FILE *fp;
<a name="l02887"></a>02887 
<a name="l02888"></a>02888         <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l02889"></a>02889         fp = <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd);
<a name="l02890"></a>02890         rc = fseek(fp, offset, whence);
<a name="l02891"></a>02891         <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l02892"></a>02892         <span class="keywordflow">return</span> rc;
<a name="l02893"></a>02893     }
<a name="l02894"></a>02894 
<a name="l02895"></a>02895     <span class="comment">/*@-nullderef@*/</span>
<a name="l02896"></a>02896     _seek = <a class="code" href="rpmio_8c.html#48dc468d7f554afaa311d9abeeda122c">FDIOVEC</a>(fd, <a class="code" href="structFDIO__s.html#c611a605182ecfceca1c8804edee808e">seek</a>);
<a name="l02897"></a>02897     <span class="comment">/*@=nullderef@*/</span>
<a name="l02898"></a>02898 
<a name="l02899"></a>02899     rc = (_seek ? _seek(fd, pos, whence) : -2);
<a name="l02900"></a>02900     <span class="keywordflow">return</span> rc;
<a name="l02901"></a>02901 }
<a name="l02902"></a>02902 
<a name="l02903"></a><a class="code" href="rpmio_8h.html#df9d9b5146b0155f3629c50a5fbb3cb8">02903</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l02904"></a>02904 {
<a name="l02905"></a>02905     <span class="keywordtype">int</span> rc = 0, ec = 0;
<a name="l02906"></a>02906 
<a name="l02907"></a>02907     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l02908"></a>02908 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Fclose(%p) %s\n"</span>, (fd ? fd : NULL), <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l02909"></a>02909 
<a name="l02910"></a>02910     fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"Fclose"</span>);
<a name="l02911"></a>02911     <span class="comment">/*@-branchstate@*/</span>
<a name="l02912"></a>02912     <span class="keywordflow">while</span> (fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a> &gt;= 0) {
<a name="l02913"></a>02913 <span class="comment">/*@-boundsread@*/</span>
<a name="l02914"></a>02914         <a class="code" href="struct__FDSTACK__s.html">FDSTACK_t</a> * fps = &amp;fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>];
<a name="l02915"></a>02915 <span class="comment">/*@=boundsread@*/</span>
<a name="l02916"></a>02916         
<a name="l02917"></a>02917         <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>) {
<a name="l02918"></a>02918             FILE *fp;
<a name="l02919"></a>02919             <span class="keywordtype">int</span> fpno;
<a name="l02920"></a>02920 
<a name="l02921"></a>02921             <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l02922"></a>02922             fp = <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd);
<a name="l02923"></a>02923             fpno = fileno(fp);
<a name="l02924"></a>02924             <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l02925"></a>02925         <span class="comment">/* XXX persistent HTTP/1.1 returns the previously opened fp */</span>
<a name="l02926"></a>02926             <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a> &gt; 0 &amp;&amp; fpno == -1 &amp;&amp;
<a name="l02927"></a>02927                 fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>-1].<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a> &amp;&amp;
<a name="l02928"></a>02928                 fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>-1].<a class="code" href="struct__FDSTACK__s.html#b8c0e90a901e0c34008a5238674bceb1">fp</a> == fp &amp;&amp;
<a name="l02929"></a>02929                 (fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>-1].<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a> &gt;= 0 || fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL))
<a name="l02930"></a>02930             {
<a name="l02931"></a>02931                 <span class="keywordtype">int</span> hadreqpersist = (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL);
<a name="l02932"></a>02932 
<a name="l02933"></a>02933                 <span class="keywordflow">if</span> (fp)
<a name="l02934"></a>02934                     rc = fflush(fp);
<a name="l02935"></a>02935                 fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>--;
<a name="l02936"></a>02936                 <span class="comment">/*@-refcounttrans@*/</span>
<a name="l02937"></a>02937                 rc = <a class="code" href="group__rpmio.html#g96fee811afb511f17448141ad62d8e99">ufdClose</a>(fd);
<a name="l02938"></a>02938                 <span class="comment">/*@=refcounttrans@*/</span>
<a name="l02939"></a>02939 <span class="comment">/*@-usereleased@*/</span>
<a name="l02940"></a>02940                 <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#gcc4deea09d28ccd7f289bf804d7dcb18">fdGetFdno</a>(fd) &gt;= 0)
<a name="l02941"></a>02941                     <span class="keywordflow">break</span>;
<a name="l02942"></a>02942                 <span class="keywordflow">if</span> (!fd-&gt;<a class="code" href="struct__FD__s.html#9291417ba2a470d34437ec7cd0629ea1">persist</a>)
<a name="l02943"></a>02943                     hadreqpersist = 0;
<a name="l02944"></a>02944                 <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, NULL);
<a name="l02945"></a>02945                 fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>++;
<a name="l02946"></a>02946                 <span class="keywordflow">if</span> (fp) {
<a name="l02947"></a>02947                     <span class="comment">/* HACK: flimsy Keepalive wiring. */</span>
<a name="l02948"></a>02948                     <span class="keywordflow">if</span> (hadreqpersist) {
<a name="l02949"></a>02949                         fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>--;
<a name="l02950"></a>02950 <span class="comment">/*@-exposetrans@*/</span>
<a name="l02951"></a>02951                         <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, fp);
<a name="l02952"></a>02952 <span class="comment">/*@=exposetrans@*/</span>
<a name="l02953"></a>02953 <span class="comment">/*@-refcounttrans@*/</span>
<a name="l02954"></a>02954                         (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(fd);
<a name="l02955"></a>02955 <span class="comment">/*@=refcounttrans@*/</span>
<a name="l02956"></a>02956                         <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, NULL);
<a name="l02957"></a>02957                         fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>++;
<a name="l02958"></a>02958 <span class="comment">/*@-refcounttrans@*/</span>
<a name="l02959"></a>02959                         (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(fd);
<a name="l02960"></a>02960 <span class="comment">/*@=refcounttrans@*/</span>
<a name="l02961"></a>02961                     } <span class="keywordflow">else</span>
<a name="l02962"></a>02962                         rc = fclose(fp);
<a name="l02963"></a>02963                 }
<a name="l02964"></a>02964                 <a class="code" href="group__rpmio.html#g0681199a3bc301577673efffab678642">fdPop</a>(fd);
<a name="l02965"></a>02965                 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a>)
<a name="l02966"></a>02966                     <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, NULL);
<a name="l02967"></a>02967             } <span class="keywordflow">else</span> {
<a name="l02968"></a>02968                 <span class="keywordflow">if</span> (fp)
<a name="l02969"></a>02969                     rc = fclose(fp);
<a name="l02970"></a>02970                 <span class="keywordflow">if</span> (fpno == -1) {
<a name="l02971"></a>02971                     fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"fopencookie (Fclose)"</span>);
<a name="l02972"></a>02972                     <a class="code" href="group__rpmio.html#g0681199a3bc301577673efffab678642">fdPop</a>(fd);
<a name="l02973"></a>02973                 }
<a name="l02974"></a>02974             }
<a name="l02975"></a>02975         } <span class="keywordflow">else</span> {
<a name="l02976"></a>02976             <span class="comment">/*@-nullderef@*/</span>
<a name="l02977"></a>02977             <a class="code" href="rpmio_8h.html#be94cfaf36529b680963a0ebe6197636">fdio_close_function_t</a> _close = <a class="code" href="rpmio_8c.html#48dc468d7f554afaa311d9abeeda122c">FDIOVEC</a>(fd, <a class="code" href="structFDIO__s.html#62d348b8433a595b0106ba0533b13461">close</a>);
<a name="l02978"></a>02978             <span class="comment">/*@=nullderef@*/</span>
<a name="l02979"></a>02979             rc = _close(fd);
<a name="l02980"></a>02980         }
<a name="l02981"></a>02981         <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a> == 0)
<a name="l02982"></a>02982             <span class="keywordflow">break</span>;
<a name="l02983"></a>02983         <span class="keywordflow">if</span> (ec == 0 &amp;&amp; rc)
<a name="l02984"></a>02984             ec = rc;
<a name="l02985"></a>02985         <a class="code" href="group__rpmio.html#g0681199a3bc301577673efffab678642">fdPop</a>(fd);
<a name="l02986"></a>02986     }
<a name="l02987"></a>02987     <span class="comment">/*@=branchstate@*/</span>
<a name="l02988"></a>02988     fd = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fd, <span class="stringliteral">"Fclose"</span>);
<a name="l02989"></a>02989     <span class="keywordflow">return</span> ec;
<a name="l02990"></a>02990 <span class="comment">/*@=usereleased@*/</span>
<a name="l02991"></a>02991 }
<a name="l02992"></a>02992 
<a name="l03004"></a>03004 <span class="comment">/*@-boundswrite@*/</span>
<a name="l03005"></a><a class="code" href="rpmio_8c.html#5683a71ccfff1fd6ca817a1e6d1ab76b">03005</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="rpmio_8c.html#5683a71ccfff1fd6ca817a1e6d1ab76b" title="Convert stdio fmode to open(2) mode, filtering out zlib/bzlib flags.">cvtfmode</a> (<span class="keyword">const</span> <span class="keywordtype">char</span> *m,
<a name="l03006"></a>03006                                 <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> *stdio, <span class="keywordtype">size_t</span> nstdio,
<a name="l03007"></a>03007                                 <span class="comment">/*@out@*/</span> <span class="keywordtype">char</span> *other, <span class="keywordtype">size_t</span> nother,
<a name="l03008"></a>03008                                 <span class="comment">/*@out@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> **end, <span class="comment">/*@out@*/</span> <span class="keywordtype">int</span> * f)
<a name="l03009"></a>03009         <span class="comment">/*@modifies *stdio, *other, *end, *f @*/</span>
<a name="l03010"></a>03010 {
<a name="l03011"></a>03011     <span class="keywordtype">int</span> flags = 0;
<a name="l03012"></a>03012     <span class="keywordtype">char</span> c;
<a name="l03013"></a>03013 
<a name="l03014"></a>03014     <span class="keywordflow">switch</span> (*m) {
<a name="l03015"></a>03015     <span class="keywordflow">case</span> <span class="charliteral">'a'</span>:
<a name="l03016"></a>03016         flags |= O_WRONLY | O_CREAT | O_APPEND;
<a name="l03017"></a>03017         <span class="keywordflow">if</span> (--nstdio &gt; 0) *stdio++ = *m;
<a name="l03018"></a>03018         <span class="keywordflow">break</span>;
<a name="l03019"></a>03019     <span class="keywordflow">case</span> <span class="charliteral">'w'</span>:
<a name="l03020"></a>03020         flags |= O_WRONLY | O_CREAT | O_TRUNC;
<a name="l03021"></a>03021         <span class="keywordflow">if</span> (--nstdio &gt; 0) *stdio++ = *m;
<a name="l03022"></a>03022         <span class="keywordflow">break</span>;
<a name="l03023"></a>03023     <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
<a name="l03024"></a>03024         flags |= O_RDONLY;
<a name="l03025"></a>03025         <span class="keywordflow">if</span> (--nstdio &gt; 0) *stdio++ = *m;
<a name="l03026"></a>03026         <span class="keywordflow">break</span>;
<a name="l03027"></a>03027     <span class="keywordflow">default</span>:
<a name="l03028"></a>03028         *stdio = <span class="charliteral">'\0'</span>;
<a name="l03029"></a>03029         <span class="keywordflow">return</span>;
<a name="l03030"></a>03030         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l03031"></a>03031     }
<a name="l03032"></a>03032     m++;
<a name="l03033"></a>03033 
<a name="l03034"></a>03034     <span class="keywordflow">while</span> ((c = *m++) != <span class="charliteral">'\0'</span>) {
<a name="l03035"></a>03035         <span class="keywordflow">switch</span> (c) {
<a name="l03036"></a>03036         <span class="keywordflow">case</span> <span class="charliteral">'.'</span>:
<a name="l03037"></a>03037             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03038"></a>03038         <span class="keywordflow">case</span> <span class="charliteral">'+'</span>:
<a name="l03039"></a>03039             flags &amp;= ~(O_RDONLY|O_WRONLY);
<a name="l03040"></a>03040             flags |= O_RDWR;
<a name="l03041"></a>03041             <span class="keywordflow">if</span> (--nstdio &gt; 0) *stdio++ = c;
<a name="l03042"></a>03042             <span class="keywordflow">continue</span>;
<a name="l03043"></a>03043             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03044"></a>03044         <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
<a name="l03045"></a>03045             <span class="keywordflow">if</span> (--nstdio &gt; 0) *stdio++ = c;
<a name="l03046"></a>03046             <span class="keywordflow">continue</span>;
<a name="l03047"></a>03047             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03048"></a>03048         <span class="keywordflow">case</span> <span class="charliteral">'x'</span>:
<a name="l03049"></a>03049             flags |= O_EXCL;
<a name="l03050"></a>03050             <span class="keywordflow">if</span> (--nstdio &gt; 0) *stdio++ = c;
<a name="l03051"></a>03051             <span class="keywordflow">continue</span>;
<a name="l03052"></a>03052             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03053"></a>03053         <span class="keywordflow">default</span>:
<a name="l03054"></a>03054             <span class="keywordflow">if</span> (--nother &gt; 0) *other++ = c;
<a name="l03055"></a>03055             <span class="keywordflow">continue</span>;
<a name="l03056"></a>03056             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03057"></a>03057         }
<a name="l03058"></a>03058         <span class="keywordflow">break</span>;
<a name="l03059"></a>03059     }
<a name="l03060"></a>03060 
<a name="l03061"></a>03061     *stdio = *other = <span class="charliteral">'\0'</span>;
<a name="l03062"></a>03062     <span class="keywordflow">if</span> (end != NULL)
<a name="l03063"></a>03063         *end = (*m != <span class="charliteral">'\0'</span> ? m : NULL);
<a name="l03064"></a>03064     <span class="keywordflow">if</span> (f != NULL)
<a name="l03065"></a>03065         *f = flags;
<a name="l03066"></a>03066 }
<a name="l03067"></a>03067 <span class="comment">/*@=boundswrite@*/</span>
<a name="l03068"></a>03068 
<a name="l03069"></a>03069 <span class="preprocessor">#if _USE_LIBIO</span>
<a name="l03070"></a>03070 <span class="preprocessor"></span><span class="preprocessor">#if defined(__GLIBC__) &amp;&amp; __GLIBC__ == 2 &amp;&amp; __GLIBC_MINOR__ == 0</span>
<a name="l03071"></a>03071 <span class="preprocessor"></span><span class="comment">/* XXX retrofit glibc-2.1.x typedef on glibc-2.0.x systems */</span>
<a name="l03072"></a>03072 <span class="keyword">typedef</span> _IO_cookie_io_functions_t cookie_io_functions_t;
<a name="l03073"></a>03073 <span class="preprocessor">#endif</span>
<a name="l03074"></a>03074 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l03075"></a>03075 <span class="preprocessor"></span>
<a name="l03076"></a>03076 <span class="comment">/*@-boundswrite@*/</span>
<a name="l03077"></a><a class="code" href="rpmio_8h.html#43d8e90a91a7bb3b9873be26b2e7b6a3">03077</a> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#43d8e90a91a7bb3b9873be26b2e7b6a3">Fdopen</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ofd, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmode)
<a name="l03078"></a>03078 {
<a name="l03079"></a>03079     <span class="keywordtype">char</span> stdio[20], other[20], zstdio[20];
<a name="l03080"></a>03080     <span class="keyword">const</span> <span class="keywordtype">char</span> *end = NULL;
<a name="l03081"></a>03081     <a class="code" href="structFDIO__s.html">FDIO_t</a> iof = NULL;
<a name="l03082"></a>03082     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = ofd;
<a name="l03083"></a>03083 
<a name="l03084"></a>03084 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l03085"></a>03085 fprintf(stderr, <span class="stringliteral">"*** Fdopen(%p,%s) %s\n"</span>, fd, fmode, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd));
<a name="l03086"></a>03086     <a class="code" href="rpmio__internal_8h.html#c6e9cf1a5e1a90faa62cc5c364083d83">FDSANE</a>(fd);
<a name="l03087"></a>03087 
<a name="l03088"></a>03088     <span class="keywordflow">if</span> (fmode == NULL)
<a name="l03089"></a>03089         <span class="keywordflow">return</span> NULL;
<a name="l03090"></a>03090 
<a name="l03091"></a>03091     <a class="code" href="rpmio_8c.html#5683a71ccfff1fd6ca817a1e6d1ab76b" title="Convert stdio fmode to open(2) mode, filtering out zlib/bzlib flags.">cvtfmode</a>(fmode, stdio, <span class="keyword">sizeof</span>(stdio), other, <span class="keyword">sizeof</span>(other), &amp;end, NULL);
<a name="l03092"></a>03092     <span class="keywordflow">if</span> (stdio[0] == <span class="charliteral">'\0'</span>)
<a name="l03093"></a>03093         <span class="keywordflow">return</span> NULL;
<a name="l03094"></a>03094     zstdio[0] = <span class="charliteral">'\0'</span>;
<a name="l03095"></a>03095     strncat(zstdio, stdio, <span class="keyword">sizeof</span>(zstdio) - strlen(zstdio));
<a name="l03096"></a>03096     strncat(zstdio, other, <span class="keyword">sizeof</span>(zstdio) - strlen(zstdio));
<a name="l03097"></a>03097 
<a name="l03098"></a>03098     <span class="keywordflow">if</span> (end == NULL &amp;&amp; other[0] == <span class="charliteral">'\0'</span>)
<a name="l03099"></a>03099         <span class="comment">/*@-refcounttrans -retalias@*/</span> <span class="keywordflow">return</span> fd; <span class="comment">/*@=refcounttrans =retalias@*/</span>
<a name="l03100"></a>03100 
<a name="l03101"></a>03101     <span class="comment">/*@-branchstate@*/</span>
<a name="l03102"></a>03102     <span class="keywordflow">if</span> (end &amp;&amp; *end) {
<a name="l03103"></a>03103         <span class="keywordflow">if</span> (!strcmp(end, <span class="stringliteral">"fdio"</span>)) {
<a name="l03104"></a>03104             iof = <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>;
<a name="l03105"></a>03105         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(end, <span class="stringliteral">"gzdio"</span>)) {
<a name="l03106"></a>03106             iof = gzdio;
<a name="l03107"></a>03107             <span class="comment">/*@-internalglobs@*/</span>
<a name="l03108"></a>03108             fd = gzdFdopen(fd, zstdio);
<a name="l03109"></a>03109             <span class="comment">/*@=internalglobs@*/</span>
<a name="l03110"></a>03110 <span class="preprocessor">#if HAVE_BZLIB_H</span>
<a name="l03111"></a>03111 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(end, <span class="stringliteral">"bzdio"</span>)) {
<a name="l03112"></a>03112             iof = bzdio;
<a name="l03113"></a>03113             <span class="comment">/*@-internalglobs@*/</span>
<a name="l03114"></a>03114             fd = bzdFdopen(fd, zstdio);
<a name="l03115"></a>03115             <span class="comment">/*@=internalglobs@*/</span>
<a name="l03116"></a>03116 <span class="preprocessor">#endif</span>
<a name="l03117"></a>03117 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(end, <span class="stringliteral">"ufdio"</span>)) {
<a name="l03118"></a>03118             iof = <a class="code" href="rpmio_8c.html#3380cbd41af873481b8a93f3f8159479">ufdio</a>;
<a name="l03119"></a>03119         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(end, <span class="stringliteral">"fpio"</span>)) {
<a name="l03120"></a>03120             iof = <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>;
<a name="l03121"></a>03121             <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a>) {
<a name="l03122"></a>03122                 <span class="keywordtype">int</span> fdno = <a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(fd);
<a name="l03123"></a>03123                 FILE * fp = fdopen(fdno, stdio);
<a name="l03124"></a>03124 <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l03125"></a>03125 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l03126"></a>03126 fprintf(stderr, <span class="stringliteral">"*** Fdopen fpio fp %p\n"</span>, (<span class="keywordtype">void</span> *)fp);
<a name="l03127"></a>03127 <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l03128"></a>03128                 <span class="keywordflow">if</span> (fp == NULL)
<a name="l03129"></a>03129                     <span class="keywordflow">return</span> NULL;
<a name="l03130"></a>03130                 <span class="comment">/* XXX gzdio/bzdio use fp for private data */</span>
<a name="l03131"></a>03131                 <span class="comment">/*@+voidabstract@*/</span>
<a name="l03132"></a>03132                 <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(fd) == NULL)
<a name="l03133"></a>03133                     <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, fp);
<a name="l03134"></a>03134                 <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>, fp, fdno);     <span class="comment">/* Push fpio onto stack */</span>
<a name="l03135"></a>03135                 <span class="comment">/*@=voidabstract@*/</span>
<a name="l03136"></a>03136             }
<a name="l03137"></a>03137         }
<a name="l03138"></a>03138     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (other[0] != <span class="charliteral">'\0'</span>) {
<a name="l03139"></a>03139         <span class="keywordflow">for</span> (end = other; *end &amp;&amp; strchr(<span class="stringliteral">"0123456789fh"</span>, *end); end++)
<a name="l03140"></a>03140             {};
<a name="l03141"></a>03141         <span class="keywordflow">if</span> (*end == <span class="charliteral">'\0'</span>) {
<a name="l03142"></a>03142             iof = gzdio;
<a name="l03143"></a>03143             <span class="comment">/*@-internalglobs@*/</span>
<a name="l03144"></a>03144             fd = gzdFdopen(fd, zstdio);
<a name="l03145"></a>03145             <span class="comment">/*@=internalglobs@*/</span>
<a name="l03146"></a>03146         }
<a name="l03147"></a>03147     }
<a name="l03148"></a>03148     <span class="comment">/*@=branchstate@*/</span>
<a name="l03149"></a>03149     <span class="keywordflow">if</span> (iof == NULL)
<a name="l03150"></a>03150         <span class="comment">/*@-refcounttrans -retalias@*/</span> <span class="keywordflow">return</span> fd; <span class="comment">/*@=refcounttrans =retalias@*/</span>
<a name="l03151"></a>03151 
<a name="l03152"></a>03152     <span class="keywordflow">if</span> (!<a class="code" href="poptALL_8c.html#8d00cce32160aa23a96acdf43831958c">noLibio</a>) {
<a name="l03153"></a>03153         FILE * fp = NULL;
<a name="l03154"></a>03154 
<a name="l03155"></a>03155 <span class="preprocessor">#if _USE_LIBIO</span>
<a name="l03156"></a>03156 <span class="preprocessor"></span>        {   cookie_io_functions_t ciof;
<a name="l03157"></a>03157             ciof.read = iof-&gt;<a class="code" href="structFDIO__s.html#5a1aa8cdffbfb630acd5e8f92ac364f1">read</a>;
<a name="l03158"></a>03158             ciof.write = iof-&gt;<a class="code" href="structFDIO__s.html#eaecdc0ee5105afecbf347d1d80440a7">write</a>;
<a name="l03159"></a>03159             ciof.seek = iof-&gt;<a class="code" href="structFDIO__s.html#c611a605182ecfceca1c8804edee808e">seek</a>;
<a name="l03160"></a>03160             ciof.close = iof-&gt;<a class="code" href="structFDIO__s.html#62d348b8433a595b0106ba0533b13461">close</a>;
<a name="l03161"></a>03161             fp = fopencookie(fd, stdio, ciof);
<a name="l03162"></a>03162 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; fopencookie(%p,\"%s\",*%p) returns fp %p\n"</span>, fd, stdio, iof, fp));
<a name="l03163"></a>03163         }
<a name="l03164"></a>03164 <span class="preprocessor">#endif</span>
<a name="l03165"></a>03165 <span class="preprocessor"></span>
<a name="l03166"></a>03166         <span class="comment">/*@-branchstate@*/</span>
<a name="l03167"></a>03167         <span class="keywordflow">if</span> (fp) {
<a name="l03168"></a>03168             <span class="comment">/* XXX gzdio/bzdio use fp for private data */</span>
<a name="l03169"></a>03169             <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l03170"></a>03170             <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(fd) == NULL)
<a name="l03171"></a>03171                 <a class="code" href="group__rpmio.html#g7dc6fc524462673660016e2fcaf4e7f6">fdSetFp</a>(fd, fp);
<a name="l03172"></a>03172             <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>, fp, fileno(fp));   <span class="comment">/* Push fpio onto stack */</span>
<a name="l03173"></a>03173             <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l03174"></a>03174             fd = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(fd, <span class="stringliteral">"fopencookie"</span>);
<a name="l03175"></a>03175         }
<a name="l03176"></a>03176         <span class="comment">/*@=branchstate@*/</span>
<a name="l03177"></a>03177     }
<a name="l03178"></a>03178 
<a name="l03179"></a>03179 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Fdopen(%p,\"%s\") returns fd %p %s\n"</span>, ofd, fmode, (fd ? fd : NULL), <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l03180"></a>03180     <span class="comment">/*@-refcounttrans -retalias@*/</span> <span class="keywordflow">return</span> fd; <span class="comment">/*@=refcounttrans =retalias@*/</span>
<a name="l03181"></a>03181 }
<a name="l03182"></a>03182 <span class="comment">/*@=boundswrite@*/</span>
<a name="l03183"></a>03183 
<a name="l03184"></a><a class="code" href="rpmio_8h.html#89bd8d7de2b3d1944f570fc2d2d7470a">03184</a> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmode)
<a name="l03185"></a>03185 {
<a name="l03186"></a>03186     <span class="keywordtype">char</span> stdio[20], other[20];
<a name="l03187"></a>03187     <span class="keyword">const</span> <span class="keywordtype">char</span> *end = NULL;
<a name="l03188"></a>03188     mode_t perms = 0666;
<a name="l03189"></a>03189     <span class="keywordtype">int</span> flags;
<a name="l03190"></a>03190     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l03191"></a>03191 
<a name="l03192"></a>03192     <span class="keywordflow">if</span> (path == NULL || fmode == NULL)
<a name="l03193"></a>03193         <span class="keywordflow">return</span> NULL;
<a name="l03194"></a>03194 
<a name="l03195"></a>03195     stdio[0] = <span class="charliteral">'\0'</span>;
<a name="l03196"></a>03196     <a class="code" href="rpmio_8c.html#5683a71ccfff1fd6ca817a1e6d1ab76b" title="Convert stdio fmode to open(2) mode, filtering out zlib/bzlib flags.">cvtfmode</a>(fmode, stdio, <span class="keyword">sizeof</span>(stdio), other, <span class="keyword">sizeof</span>(other), &amp;end, &amp;flags);
<a name="l03197"></a>03197     <span class="keywordflow">if</span> (stdio[0] == <span class="charliteral">'\0'</span>)
<a name="l03198"></a>03198         <span class="keywordflow">return</span> NULL;
<a name="l03199"></a>03199 
<a name="l03200"></a>03200     <span class="comment">/*@-branchstate@*/</span>
<a name="l03201"></a>03201     <span class="keywordflow">if</span> (end == NULL || !strcmp(end, <span class="stringliteral">"fdio"</span>)) {
<a name="l03202"></a>03202 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l03203"></a>03203 fprintf(stderr, <span class="stringliteral">"*** Fopen fdio path %s fmode %s\n"</span>, path, fmode);
<a name="l03204"></a>03204         fd = <a class="code" href="rpmio_8c.html#4c1fcf2fbff64cf829bd61c90642fc42">fdOpen</a>(path, flags, perms);
<a name="l03205"></a>03205         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd) &lt; 0) {
<a name="l03206"></a>03206             <span class="keywordflow">if</span> (fd) (void) <a class="code" href="rpmio_8c.html#18fde9c3d3b0b0b75be33acd86adba48">fdClose</a>(fd);
<a name="l03207"></a>03207             <span class="keywordflow">return</span> NULL;
<a name="l03208"></a>03208         }
<a name="l03209"></a>03209     } <span class="keywordflow">else</span> {
<a name="l03210"></a>03210         FILE *fp;
<a name="l03211"></a>03211         <span class="keywordtype">int</span> fdno;
<a name="l03212"></a>03212         <span class="keywordtype">int</span> isHTTP = 0;
<a name="l03213"></a>03213 
<a name="l03214"></a>03214         <span class="comment">/* XXX gzdio and bzdio here too */</span>
<a name="l03215"></a>03215 
<a name="l03216"></a>03216         <span class="keywordflow">switch</span> (<a class="code" href="rpmurl_8h.html#9def993f3a6f0b632236c66e03df7da6" title="Return type of URL.">urlIsURL</a>(path)) {
<a name="l03217"></a>03217         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l03218"></a>03218         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l03219"></a>03219         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l03220"></a>03220             isHTTP = 1;
<a name="l03221"></a>03221             <span class="comment">/*@fallthrough@*/</span>
<a name="l03222"></a>03222         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l03223"></a>03223         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l03224"></a>03224         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l03225"></a>03225         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l03226"></a>03226 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l03227"></a>03227 fprintf(stderr, <span class="stringliteral">"*** Fopen ufdio path %s fmode %s\n"</span>, path, fmode);
<a name="l03228"></a>03228             fd = <a class="code" href="rpmio_8c.html#6072c8ced11a7cbaff09f1852a1934f2">ufdOpen</a>(path, flags, perms);
<a name="l03229"></a>03229             <span class="keywordflow">if</span> (fd == NULL || !(<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd) &gt;= 0 || fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL))
<a name="l03230"></a>03230                 <span class="keywordflow">return</span> fd;
<a name="l03231"></a>03231             <span class="keywordflow">break</span>;
<a name="l03232"></a>03232         <span class="keywordflow">default</span>:
<a name="l03233"></a>03233 <span class="keywordflow">if</span> (<a class="code" href="poptALL_8c.html#2d5b915e8c5d750401c5720dc28bf206">_rpmio_debug</a>)
<a name="l03234"></a>03234 fprintf(stderr, <span class="stringliteral">"*** Fopen WTFO path %s fmode %s\n"</span>, path, fmode);
<a name="l03235"></a>03235             <span class="keywordflow">return</span> NULL;
<a name="l03236"></a>03236             <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l03237"></a>03237         }
<a name="l03238"></a>03238 
<a name="l03239"></a>03239         <span class="comment">/* XXX persistent HTTP/1.1 returns the previously opened fp */</span>
<a name="l03240"></a>03240         <span class="keywordflow">if</span> (isHTTP &amp;&amp; ((fp = <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(fd)) != NULL) &amp;&amp; ((fdno = <a class="code" href="group__rpmio.html#gcc4deea09d28ccd7f289bf804d7dcb18">fdGetFdno</a>(fd)) &gt;= 0 || fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL))
<a name="l03241"></a>03241         {
<a name="l03242"></a>03242             <span class="comment">/*@+voidabstract@*/</span>
<a name="l03243"></a>03243             <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(fd, <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>, fp, fileno(fp));   <span class="comment">/* Push fpio onto stack */</span>
<a name="l03244"></a>03244             <span class="comment">/*@=voidabstract@*/</span>
<a name="l03245"></a>03245             <span class="keywordflow">return</span> fd;
<a name="l03246"></a>03246         }
<a name="l03247"></a>03247     }
<a name="l03248"></a>03248     <span class="comment">/*@=branchstate@*/</span>
<a name="l03249"></a>03249 
<a name="l03250"></a>03250     <span class="comment">/*@-branchstate@*/</span>
<a name="l03251"></a>03251     <span class="keywordflow">if</span> (fd)
<a name="l03252"></a>03252         fd = <a class="code" href="rpmio_8c.html#43d8e90a91a7bb3b9873be26b2e7b6a3">Fdopen</a>(fd, fmode);
<a name="l03253"></a>03253     <span class="comment">/*@=branchstate@*/</span>
<a name="l03254"></a>03254     <span class="keywordflow">return</span> fd;
<a name="l03255"></a>03255 }
<a name="l03256"></a>03256 
<a name="l03257"></a><a class="code" href="rpmio_8h.html#151331b54e01d3b4ebe94382603ad609">03257</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#151331b54e01d3b4ebe94382603ad609" title="fflush(3) clone.">Fflush</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l03258"></a>03258 {
<a name="l03259"></a>03259     <span class="keywordtype">void</span> * vh;
<a name="l03260"></a>03260     <span class="keywordflow">if</span> (fd == NULL) <span class="keywordflow">return</span> -1;
<a name="l03261"></a>03261     <span class="keywordflow">if</span> (<a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>)
<a name="l03262"></a>03262         <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l03263"></a>03263         <span class="keywordflow">return</span> fflush(<a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd));
<a name="l03264"></a>03264         <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l03265"></a>03265 
<a name="l03266"></a>03266     vh = <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(fd);
<a name="l03267"></a>03267     <span class="keywordflow">if</span> (vh &amp;&amp; <a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == gzdio)
<a name="l03268"></a>03268         <span class="keywordflow">return</span> gzdFlush(vh);
<a name="l03269"></a>03269 <span class="preprocessor">#if HAVE_BZLIB_H</span>
<a name="l03270"></a>03270 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (vh &amp;&amp; <a class="code" href="group__rpmio.html#g506f8c83d1681b0d918cd11e56a059ec">fdGetIo</a>(fd) == bzdio)
<a name="l03271"></a>03271         <span class="keywordflow">return</span> bzdFlush(vh);
<a name="l03272"></a>03272 <span class="preprocessor">#endif</span>
<a name="l03273"></a>03273 <span class="preprocessor"></span>
<a name="l03274"></a>03274     <span class="keywordflow">return</span> 0;
<a name="l03275"></a>03275 }
<a name="l03276"></a>03276 
<a name="l03277"></a><a class="code" href="rpmio_8h.html#5c33b1522107db905bc2e243e8715b7b">03277</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l03278"></a>03278 {
<a name="l03279"></a>03279     <span class="keywordtype">int</span> i, rc = 0;
<a name="l03280"></a>03280 
<a name="l03281"></a>03281     <span class="keywordflow">if</span> (fd == NULL) <span class="keywordflow">return</span> -1;
<a name="l03282"></a>03282     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL) {
<a name="l03283"></a>03283         <span class="comment">/* HACK: flimsy wiring for neon errors. */</span>
<a name="l03284"></a>03284         rc = (fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a>  || fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> != NULL) ? -1 : 0;
<a name="l03285"></a>03285     } <span class="keywordflow">else</span>
<a name="l03286"></a>03286     <span class="keywordflow">for</span> (i = fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a>; rc == 0 &amp;&amp; i &gt;= 0; i--) {
<a name="l03287"></a>03287 <span class="comment">/*@-boundsread@*/</span>
<a name="l03288"></a>03288         <a class="code" href="struct__FDSTACK__s.html">FDSTACK_t</a> * fps = &amp;fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[i];
<a name="l03289"></a>03289 <span class="comment">/*@=boundsread@*/</span>
<a name="l03290"></a>03290         <span class="keywordtype">int</span> ec;
<a name="l03291"></a>03291         
<a name="l03292"></a>03292         <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>) {
<a name="l03293"></a>03293             <span class="comment">/*@+voidabstract -nullpass@*/</span>
<a name="l03294"></a>03294             ec = ferror(<a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd));
<a name="l03295"></a>03295             <span class="comment">/*@=voidabstract =nullpass@*/</span>
<a name="l03296"></a>03296         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == gzdio) {
<a name="l03297"></a>03297             ec = (fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a> || fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> != NULL) ? -1 : 0;
<a name="l03298"></a>03298             i--;        <span class="comment">/* XXX fdio under gzdio always has fdno == -1 */</span>
<a name="l03299"></a>03299 <span class="preprocessor">#if HAVE_BZLIB_H</span>
<a name="l03300"></a>03300 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fps-&gt;<a class="code" href="struct__FDSTACK__s.html#2484c26b32466e9aa7b27b84e1640510">io</a> == bzdio) {
<a name="l03301"></a>03301             ec = (fd-&gt;<a class="code" href="struct__FD__s.html#0461c98bcce9f467c7c95ea3cf66b633">syserrno</a>  || fd-&gt;<a class="code" href="struct__FD__s.html#0567eed62678265ac1964683da97bf1e">errcookie</a> != NULL) ? -1 : 0;
<a name="l03302"></a>03302             i--;        <span class="comment">/* XXX fdio under bzdio always has fdno == -1 */</span>
<a name="l03303"></a>03303 <span class="preprocessor">#endif</span>
<a name="l03304"></a>03304 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
<a name="l03305"></a>03305         <span class="comment">/* XXX need to check ufdio/gzdio/bzdio/fdio errors correctly. */</span>
<a name="l03306"></a>03306             ec = (<a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>(fd) &lt; 0 ? -1 : 0);
<a name="l03307"></a>03307         }
<a name="l03308"></a>03308 
<a name="l03309"></a>03309         <span class="keywordflow">if</span> (rc == 0 &amp;&amp; ec)
<a name="l03310"></a>03310             rc = ec;
<a name="l03311"></a>03311     }
<a name="l03312"></a>03312 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Ferror(%p) rc %d %s\n"</span>, fd, rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l03313"></a>03313     <span class="keywordflow">return</span> rc;
<a name="l03314"></a>03314 }
<a name="l03315"></a>03315 
<a name="l03316"></a><a class="code" href="rpmio_8h.html#6728c7372657b891dcaf375c2c50a3da">03316</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l03317"></a>03317 {
<a name="l03318"></a>03318     <span class="keywordtype">int</span> i, rc = -1;
<a name="l03319"></a>03319 
<a name="l03320"></a>03320     <span class="keywordflow">if</span> (fd == NULL) <span class="keywordflow">return</span> -1;
<a name="l03321"></a>03321     <span class="keywordflow">if</span> (fd-&gt;<a class="code" href="struct__FD__s.html#6979627ed383ae9aaa42d18bff284e07">req</a> != NULL)
<a name="l03322"></a>03322         rc = 123456789; <span class="comment">/* HACK: https has no steenkin fileno. */</span>
<a name="l03323"></a>03323     <span class="keywordflow">else</span>
<a name="l03324"></a>03324     <span class="keywordflow">for</span> (i = fd-&gt;<a class="code" href="struct__FD__s.html#f17852f4d0f2a23fbde29df4d1883590">nfps</a> ; rc == -1 &amp;&amp; i &gt;= 0; i--) {
<a name="l03325"></a>03325 <span class="comment">/*@-boundsread@*/</span>
<a name="l03326"></a>03326         rc = fd-&gt;<a class="code" href="struct__FD__s.html#0361ab86990b0a1720f64cd0119258d2">fps</a>[i].<a class="code" href="struct__FDSTACK__s.html#c7aaf2c9ceee81a766988e506cdb876a">fdno</a>;
<a name="l03327"></a>03327 <span class="comment">/*@=boundsread@*/</span>
<a name="l03328"></a>03328     }
<a name="l03329"></a>03329     
<a name="l03330"></a>03330 <a class="code" href="rpmio__internal_8h.html#7dec9cb7dbf1b873458ac15e5a74791e">DBGIO</a>(fd, (stderr, <span class="stringliteral">"==&gt; Fileno(%p) rc %d %s\n"</span>, (fd ? fd : NULL), rc, <a class="code" href="rpmio_8c.html#b82b29e0365f9de4c1878e8d405a1609">fdbg</a>(fd)));
<a name="l03331"></a>03331     <span class="keywordflow">return</span> rc;
<a name="l03332"></a>03332 }
<a name="l03333"></a>03333 
<a name="l03334"></a>03334 <span class="comment">/* XXX this is naive */</span>
<a name="l03335"></a><a class="code" href="rpmio_8h.html#991680510e2c44ac9b73cb8278216522">03335</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#991680510e2c44ac9b73cb8278216522" title="fcntl(2) clone.">Fcntl</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd, <span class="keywordtype">int</span> op, <span class="keywordtype">void</span> *lip)
<a name="l03336"></a>03336 {
<a name="l03337"></a>03337     <span class="keywordflow">return</span> fcntl(<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(fd), op, lip);
<a name="l03338"></a>03338 }
<a name="l03339"></a>03339 
<a name="l03340"></a>03340 <span class="comment">/* =============================================================== */</span>
<a name="l03341"></a>03341 <span class="comment">/* Helper routines that may be generally useful.</span>
<a name="l03342"></a>03342 <span class="comment"> */</span>
<a name="l03343"></a>03343 <span class="comment">/*@-bounds@*/</span>
<a name="l03344"></a><a class="code" href="rpmio_8h.html#976e0482261042739075b794fe4218db">03344</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#976e0482261042739075b794fe4218db" title="Insure that directories in path exist, creating as needed.">rpmioMkpath</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * path, mode_t mode, uid_t uid, gid_t gid)
<a name="l03345"></a>03345 {
<a name="l03346"></a>03346     <span class="keywordtype">char</span> * d, * de;
<a name="l03347"></a>03347     <span class="keywordtype">int</span> created = 0;
<a name="l03348"></a>03348     <span class="keywordtype">int</span> rc;
<a name="l03349"></a>03349 
<a name="l03350"></a>03350     <span class="keywordflow">if</span> (path == NULL)
<a name="l03351"></a>03351         <span class="keywordflow">return</span> -1;
<a name="l03352"></a>03352     d = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(strlen(path)+2);
<a name="l03353"></a>03353     de = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(d, path);
<a name="l03354"></a>03354     de[1] = <span class="charliteral">'\0'</span>;
<a name="l03355"></a>03355     <span class="keywordflow">for</span> (de = d; *de != <span class="charliteral">'\0'</span>; de++) {
<a name="l03356"></a>03356         <span class="keyword">struct</span> stat st;
<a name="l03357"></a>03357         <span class="keywordtype">char</span> savec;
<a name="l03358"></a>03358 
<a name="l03359"></a>03359         <span class="keywordflow">while</span> (*de &amp;&amp; *de != <span class="charliteral">'/'</span>) de++;
<a name="l03360"></a>03360         savec = de[1];
<a name="l03361"></a>03361         de[1] = <span class="charliteral">'\0'</span>;
<a name="l03362"></a>03362 
<a name="l03363"></a>03363         rc = <a class="code" href="rpmio_8h.html#dc0189fecdf5b08ae2d6b7c7f7906f87" title="stat(2) clone.">Stat</a>(d, &amp;st);
<a name="l03364"></a>03364         <span class="keywordflow">if</span> (rc) {
<a name="l03365"></a>03365             <span class="keywordflow">switch</span>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l03366"></a>03366             <span class="keywordflow">default</span>:
<a name="l03367"></a>03367                 <span class="keywordflow">return</span> errno;
<a name="l03368"></a>03368                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03369"></a>03369             <span class="keywordflow">case</span> ENOENT:
<a name="l03370"></a>03370                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l03371"></a>03371             }
<a name="l03372"></a>03372             rc = <a class="code" href="rpmio_8h.html#4faa989db577f600d6a7ffdc73d779e6" title="mkdir(2) clone.">Mkdir</a>(d, mode);
<a name="l03373"></a>03373             <span class="keywordflow">if</span> (rc)
<a name="l03374"></a>03374                 <span class="keywordflow">return</span> errno;
<a name="l03375"></a>03375             created = 1;
<a name="l03376"></a>03376             <span class="keywordflow">if</span> (!(uid == (uid_t) -1 &amp;&amp; gid == (gid_t) -1)) {
<a name="l03377"></a>03377                 rc = chown(d, uid, gid);
<a name="l03378"></a>03378                 <span class="keywordflow">if</span> (rc)
<a name="l03379"></a>03379                     <span class="keywordflow">return</span> errno;
<a name="l03380"></a>03380             }
<a name="l03381"></a>03381         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!S_ISDIR(st.st_mode)) {
<a name="l03382"></a>03382             <span class="keywordflow">return</span> ENOTDIR;
<a name="l03383"></a>03383         }
<a name="l03384"></a>03384         de[1] = savec;
<a name="l03385"></a>03385     }
<a name="l03386"></a>03386     rc = 0;
<a name="l03387"></a>03387     <span class="keywordflow">if</span> (created)
<a name="l03388"></a>03388         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <span class="stringliteral">"created directory(s) %s mode 0%o\n"</span>,
<a name="l03389"></a>03389                         path, mode);
<a name="l03390"></a>03390     <span class="keywordflow">return</span> rc;
<a name="l03391"></a>03391 }
<a name="l03392"></a>03392 <span class="comment">/*@=bounds@*/</span>
<a name="l03393"></a>03393 
<a name="l03394"></a>03394 <span class="comment">/*@-boundswrite@*/</span>
<a name="l03395"></a><a class="code" href="rpmio__internal_8h.html#1e362301fe497d3d52ca15e7e5fe55bf">03395</a> <span class="keywordtype">int</span> <a class="code" href="rpmio_8c.html#a6d30e27618f54cd0651c57e40aab547" title="Read an entire file into a buffer.">rpmioSlurp</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * fn, <span class="keyword">const</span> <a class="code" href="rpmpgp_8h.html#ea185528b70b44efcecbc49855184018">byte</a> ** bp, ssize_t * blenp)
<a name="l03396"></a>03396 {
<a name="l03397"></a>03397     <span class="keyword">static</span> ssize_t blenmax = (32 * BUFSIZ);
<a name="l03398"></a>03398     ssize_t blen = 0;
<a name="l03399"></a>03399     <a class="code" href="rpmpgp_8h.html#ea185528b70b44efcecbc49855184018">byte</a> * b = NULL;
<a name="l03400"></a>03400     ssize_t size;
<a name="l03401"></a>03401     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l03402"></a>03402     <span class="keywordtype">int</span> rc = 0;
<a name="l03403"></a>03403 
<a name="l03404"></a>03404     fd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fn, <span class="stringliteral">"r.ufdio"</span>);
<a name="l03405"></a>03405     <span class="keywordflow">if</span> (fd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd)) {
<a name="l03406"></a>03406         rc = 2;
<a name="l03407"></a>03407         <span class="keywordflow">goto</span> exit;
<a name="l03408"></a>03408     }
<a name="l03409"></a>03409 
<a name="l03410"></a>03410     size = <a class="code" href="rpmio_8c.html#1fa5444b2f4f7abbafdd768036b62fec">fdSize</a>(fd);
<a name="l03411"></a>03411     blen = (size &gt;= 0 ? size : blenmax);
<a name="l03412"></a>03412     <span class="comment">/*@-branchstate@*/</span>
<a name="l03413"></a>03413     <span class="keywordflow">if</span> (blen) {
<a name="l03414"></a>03414         <span class="keywordtype">int</span> nb;
<a name="l03415"></a>03415         b = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(blen+1);
<a name="l03416"></a>03416         b[0] = <span class="charliteral">'\0'</span>;
<a name="l03417"></a>03417         nb = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(b, <span class="keyword">sizeof</span>(*b), blen, fd);
<a name="l03418"></a>03418         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd) || (size &gt; 0 &amp;&amp; nb != blen)) {
<a name="l03419"></a>03419             rc = 1;
<a name="l03420"></a>03420             <span class="keywordflow">goto</span> exit;
<a name="l03421"></a>03421         }
<a name="l03422"></a>03422         <span class="keywordflow">if</span> (blen == blenmax &amp;&amp; nb &lt; blen) {
<a name="l03423"></a>03423             blen = nb;
<a name="l03424"></a>03424             b = <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(b, blen+1);
<a name="l03425"></a>03425         }
<a name="l03426"></a>03426         b[blen] = <span class="charliteral">'\0'</span>;
<a name="l03427"></a>03427     }
<a name="l03428"></a>03428     <span class="comment">/*@=branchstate@*/</span>
<a name="l03429"></a>03429 
<a name="l03430"></a>03430 exit:
<a name="l03431"></a>03431     <span class="keywordflow">if</span> (fd) (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l03432"></a>03432         
<a name="l03433"></a>03433     <span class="keywordflow">if</span> (rc) {
<a name="l03434"></a>03434         <span class="keywordflow">if</span> (b) free(b);
<a name="l03435"></a>03435         b = NULL;
<a name="l03436"></a>03436         blen = 0;
<a name="l03437"></a>03437     }
<a name="l03438"></a>03438 
<a name="l03439"></a>03439     <span class="keywordflow">if</span> (bp) *bp = b;
<a name="l03440"></a>03440     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (b) free(b);
<a name="l03441"></a>03441 
<a name="l03442"></a>03442     <span class="keywordflow">if</span> (blenp) *blenp = blen;
<a name="l03443"></a>03443 
<a name="l03444"></a>03444     <span class="keywordflow">return</span> rc;
<a name="l03445"></a>03445 }
<a name="l03446"></a>03446 <span class="comment">/*@=boundswrite@*/</span>
<a name="l03447"></a>03447 
<a name="l03448"></a>03448 <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l03449"></a><a class="code" href="rpmio_8c.html#1e6d35f574e9f7f64e069e24709b199e">03449</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structFDIO__s.html">FDIO_s</a> <a class="code" href="rpmio_8c.html#1e6d35f574e9f7f64e069e24709b199e">fpio_s</a> = {
<a name="l03450"></a>03450   <a class="code" href="rpmio_8c.html#52bffea6a35b9b856592e24f7a4d93db">ufdRead</a>, <a class="code" href="rpmio_8c.html#333e8c934184fa0f405b08a7d2f9d773">ufdWrite</a>, <a class="code" href="rpmio_8c.html#a80cc4e0b022c3c26430198574847989">fdSeek</a>, <a class="code" href="group__rpmio.html#g96fee811afb511f17448141ad62d8e99">ufdClose</a>, <a class="code" href="rpmio_8c.html#a21f2047d2acd50aecccf0743006095f">XfdLink</a>, <a class="code" href="rpmio_8c.html#e9433033f78fae9f660de2116f50dcb9">XfdFree</a>, <a class="code" href="rpmio_8c.html#9e92c8e6aefbde9ff8511a7b177ce529">XfdNew</a>, <a class="code" href="rpmio_8h.html#99dc07c9763906e1ef5d095a71e9c431">fdFileno</a>,
<a name="l03451"></a>03451   <a class="code" href="rpmio_8c.html#6072c8ced11a7cbaff09f1852a1934f2">ufdOpen</a>, NULL, <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>, NULL, <a class="code" href="rpmio_8h.html#4faa989db577f600d6a7ffdc73d779e6" title="mkdir(2) clone.">Mkdir</a>, <a class="code" href="rpmio_8h.html#41d271fe42dbc6e3a2d6cc9278b8565e" title="chdir(2) clone.">Chdir</a>, <a class="code" href="rpmio_8h.html#3e95a5143035de193cb66cc52486683d" title="rmdir(2) clone.">Rmdir</a>, <a class="code" href="rpmio_8h.html#95f4c89827f6555eba20d2eb2f955d7a" title="rename(2) clone.">Rename</a>, Unlink
<a name="l03452"></a>03452 };
<a name="l03453"></a>03453 <span class="comment">/*@=type@*/</span>
<a name="l03454"></a><a class="code" href="rpmio_8h.html#865e01d13e85fdc70b4afc72981ec033">03454</a> <a class="code" href="structFDIO__s.html">FDIO_t</a> <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a> = <span class="comment">/*@-compmempass@*/</span> &amp;<a class="code" href="rpmio_8c.html#1e6d35f574e9f7f64e069e24709b199e">fpio_s</a> <span class="comment">/*@=compmempass@*/</span> ;
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:54 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
