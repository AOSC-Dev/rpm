<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: rpmio/url.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>rpmio/url.c</h1><a href="url_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;<a class="code" href="rpmmacro_8h.html">rpmmacro.h</a>&gt;</span>
<a name="l00010"></a>00010 <span class="preprocessor">#include &lt;<a class="code" href="rpmmessages_8h.html">rpmmessages.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;<a class="code" href="rpmio__internal_8h.html">rpmio_internal.h</a>&gt;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="comment">/*@access FD_t@*/</span>               <span class="comment">/* XXX compared with NULL */</span>
<a name="l00016"></a>00016 <span class="comment">/*@access urlinfo@*/</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="preprocessor">#ifndef IPPORT_FTP</span>
<a name="l00019"></a><a class="code" href="url_8c.html#b1bfa063152e67aed53df45f4fae8cd8">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPORT_FTP      21</span>
<a name="l00020"></a>00020 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span><span class="preprocessor">#ifndef IPPORT_HTTP</span>
<a name="l00022"></a><a class="code" href="url_8c.html#4c4b2f064d844572b83e49a63b1fdfad">00022</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPORT_HTTP     80</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00024"></a>00024 <span class="preprocessor"></span><span class="preprocessor">#ifndef IPPORT_HTTPS</span>
<a name="l00025"></a><a class="code" href="url_8c.html#533c0f1d68037c5e0b847f07d562f9d2">00025</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPORT_HTTPS    443</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#ifndef IPPORT_PGPKEYSERVER</span>
<a name="l00028"></a><a class="code" href="url_8c.html#9a689e3b65f7381e2cc5c1c916893b43">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define IPPORT_PGPKEYSERVER     11371</span>
<a name="l00029"></a>00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span>
<a name="l00033"></a>00033 <span class="comment">/*@unchecked@*/</span>
<a name="l00034"></a><a class="code" href="url_8c.html#bd9e44ba06760e96b6cf7b6729bf1762">00034</a> <span class="keywordtype">int</span> <a class="code" href="rpmurl_8h.html#bd9e44ba06760e96b6cf7b6729bf1762">_url_iobuf_size</a> = <a class="code" href="rpmurl_8h.html#9dd58187ff5a449f24c13a7804c73e10">RPMURL_IOBUF_SIZE</a>;
<a name="l00035"></a>00035 
<a name="l00038"></a>00038 <span class="comment">/*@unchecked@*/</span>
<a name="l00039"></a><a class="code" href="url_8c.html#85349e708f188a943568778918e38205">00039</a> <span class="keywordtype">int</span> <a class="code" href="rpmurl_8h.html#85349e708f188a943568778918e38205">_url_debug</a> = 0;
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="url_8c.html#b9ecc589f40d3ae58a39c9a6f3838abf">00041</a> <span class="preprocessor">#define URLDBG(_f, _m, _x)      if ((_url_debug | (_f)) &amp; (_m)) fprintf _x</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a><a class="code" href="url_8c.html#f44f5d0a75e8b25097c2a23bd66030b3">00043</a> <span class="preprocessor">#define URLDBGIO(_f, _x)        URLDBG((_f), RPMURL_DEBUG_IO, _x)</span>
<a name="l00044"></a><a class="code" href="url_8c.html#e0d8b100703187cfceb291f9d5a90d7b">00044</a> <span class="preprocessor"></span><span class="preprocessor">#define URLDBGREFS(_f, _x)      URLDBG((_f), RPMURL_DEBUG_REFS, _x)</span>
<a name="l00045"></a>00045 <span class="preprocessor"></span>
<a name="l00048"></a>00048 <span class="comment">/*@unchecked@*/</span>
<a name="l00049"></a>00049 <span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00050"></a><a class="code" href="url_8c.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">00050</a> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> *<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a> = NULL;
<a name="l00051"></a>00051 
<a name="l00054"></a>00054 <span class="comment">/*@unchecked@*/</span>
<a name="l00055"></a><a class="code" href="url_8c.html#44e040e8dc393e8d0daa6356280826d0">00055</a> <span class="keywordtype">int</span> <a class="code" href="rpmurl_8h.html#44e040e8dc393e8d0daa6356280826d0">_url_count</a> = 0;
<a name="l00056"></a>00056 
<a name="l00062"></a>00062 <span class="comment">/*@unused@*/</span> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> *
<a name="l00063"></a><a class="code" href="url_8c.html#d608c2923552dbeeb832133a9a289bb7">00063</a> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(<span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">void</span> * p) <span class="comment">/*@modifies p@*/</span>
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     <span class="keywordflow">if</span> (p != NULL)      free((<span class="keywordtype">void</span> *)p);
<a name="l00066"></a>00066     <span class="keywordflow">return</span> NULL;
<a name="l00067"></a>00067 }
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="url_8c.html#f66c2854bb69e01b2aedb2a9564aa131">00069</a> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> <a class="code" href="rpmurl_8h.html#f66c2854bb69e01b2aedb2a9564aa131">XurlLink</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="keywordtype">unsigned</span> line)
<a name="l00070"></a>00070 {
<a name="l00071"></a>00071     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l00072"></a>00072     u-&gt;<a class="code" href="structurlinfo__s.html#3891e3350cdfcab198df09fb98408376">nrefs</a>++;
<a name="l00073"></a>00073 <span class="comment">/*@-modfilesys@*/</span>
<a name="l00074"></a>00074 <a class="code" href="url_8c.html#e0d8b100703187cfceb291f9d5a90d7b">URLDBGREFS</a>(0, (stderr, <span class="stringliteral">"--&gt; url %p ++ %d %s at %s:%u\n"</span>, u, u-&gt;<a class="code" href="structurlinfo__s.html#3891e3350cdfcab198df09fb98408376">nrefs</a>, msg, file, line));
<a name="l00075"></a>00075 <span class="comment">/*@=modfilesys@*/</span>
<a name="l00076"></a>00076     <span class="comment">/*@-refcounttrans@*/</span> <span class="keywordflow">return</span> u; <span class="comment">/*@=refcounttrans@*/</span>
<a name="l00077"></a>00077 }
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="url_8c.html#28a208eaf5b9636fa39303f7b2a27e8d">00079</a> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> <a class="code" href="rpmurl_8h.html#28a208eaf5b9636fa39303f7b2a27e8d">XurlNew</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *msg, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="keywordtype">unsigned</span> line)
<a name="l00080"></a>00080 {
<a name="l00081"></a>00081     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l00082"></a>00082     <span class="keywordflow">if</span> ((u = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(<span class="keyword">sizeof</span>(*u))) == NULL)
<a name="l00083"></a>00083         <span class="keywordflow">return</span> NULL;
<a name="l00084"></a>00084     memset(u, 0, <span class="keyword">sizeof</span>(*u));
<a name="l00085"></a>00085     u-&gt;proxyp = -1;
<a name="l00086"></a>00086     u-&gt;port = -1;
<a name="l00087"></a>00087     u-&gt;urltype = <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>;
<a name="l00088"></a>00088     u-&gt;ctrl = NULL;
<a name="l00089"></a>00089     u-&gt;data = NULL;
<a name="l00090"></a>00090     u-&gt;bufAlloced = 0;
<a name="l00091"></a>00091     u-&gt;buf = NULL;
<a name="l00092"></a>00092     u-&gt;httpHasRange = 1;
<a name="l00093"></a>00093     u-&gt;httpVersion = 0;
<a name="l00094"></a>00094     u-&gt;nrefs = 0;
<a name="l00095"></a>00095     u-&gt;magic = <a class="code" href="rpmurl_8h.html#a2c15075ce887314d6abda414e5dd5dd">URLMAGIC</a>;
<a name="l00096"></a>00096     <span class="keywordflow">return</span> <a class="code" href="rpmurl_8h.html#f66c2854bb69e01b2aedb2a9564aa131">XurlLink</a>(u, msg, file, line);
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="url_8c.html#1ed625c061d5117881bb87b0d1f82d58">00099</a> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> <a class="code" href="rpmurl_8h.html#1ed625c061d5117881bb87b0d1f82d58">XurlFree</a>(<a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="keywordtype">unsigned</span> line)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     <span class="keywordtype">int</span> xx;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l00104"></a>00104 <a class="code" href="url_8c.html#e0d8b100703187cfceb291f9d5a90d7b">URLDBGREFS</a>(0, (stderr, <span class="stringliteral">"--&gt; url %p -- %d %s at %s:%u\n"</span>, u, u-&gt;<a class="code" href="structurlinfo__s.html#3891e3350cdfcab198df09fb98408376">nrefs</a>, msg, file, line));
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (--u-&gt;<a class="code" href="structurlinfo__s.html#3891e3350cdfcab198df09fb98408376">nrefs</a> &gt; 0)
<a name="l00106"></a>00106         <span class="comment">/*@-refcounttrans -retalias@*/</span> <span class="keywordflow">return</span> u; <span class="comment">/*@=refcounttrans =retalias@*/</span>
<a name="l00107"></a>00107     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) {
<a name="l00108"></a>00108 <span class="preprocessor">#ifndef NOTYET</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span>        <span class="keywordtype">void</span> * fp = <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>);
<a name="l00110"></a>00110         <span class="comment">/*@-branchstate@*/</span>
<a name="l00111"></a>00111         <span class="keywordflow">if</span> (fp) {
<a name="l00112"></a>00112             <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>, fp, -1);   <span class="comment">/* Push fpio onto stack */</span>
<a name="l00113"></a>00113             (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>);
<a name="l00114"></a>00114         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>-&gt;<a class="code" href="structFDIO__s.html#4cfb3ad9c9004c05422467b86f182740">_fileno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>) &gt;= 0)
<a name="l00115"></a>00115             xx = <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>-&gt;<a class="code" href="structFDIO__s.html#62d348b8433a595b0106ba0533b13461">close</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>);
<a name="l00116"></a>00116         <span class="comment">/*@=branchstate@*/</span>
<a name="l00117"></a>00117 <span class="preprocessor">#else</span>
<a name="l00118"></a>00118 <span class="preprocessor"></span>        (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>);
<a name="l00119"></a>00119 <span class="preprocessor">#endif</span>
<a name="l00120"></a>00120 <span class="preprocessor"></span>
<a name="l00121"></a>00121         u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a> = <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>-&gt;<a class="code" href="structFDIO__s.html#26073c5326efa80bb82de1b897f84863">_fdderef</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, <span class="stringliteral">"persist ctrl (urlFree)"</span>, file, line);
<a name="l00122"></a>00122         <span class="comment">/*@-usereleased@*/</span>
<a name="l00123"></a>00123         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>)
<a name="l00124"></a>00124             fprintf(stderr, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"warning: u %p ctrl %p nrefs != 0 (%s %s)\n"</span>),
<a name="l00125"></a>00125                         u, u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>, (u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> : <span class="stringliteral">""</span>),
<a name="l00126"></a>00126                         (u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> : <span class="stringliteral">""</span>));
<a name="l00127"></a>00127         <span class="comment">/*@=usereleased@*/</span>
<a name="l00128"></a>00128     }
<a name="l00129"></a>00129     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>) {
<a name="l00130"></a>00130 <span class="preprocessor">#ifndef NOTYET</span>
<a name="l00131"></a>00131 <span class="preprocessor"></span>        <span class="keywordtype">void</span> * fp = <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>);
<a name="l00132"></a>00132         <span class="keywordflow">if</span> (fp) {
<a name="l00133"></a>00133             <a class="code" href="group__rpmio.html#gefc835aebcbae2b03ac9f97dcf3d1c46">fdPush</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>, <a class="code" href="rpmio_8c.html#865e01d13e85fdc70b4afc72981ec033">fpio</a>, fp, -1);   <span class="comment">/* Push fpio onto stack */</span>
<a name="l00134"></a>00134             (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>);
<a name="l00135"></a>00135         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>-&gt;<a class="code" href="structFDIO__s.html#4cfb3ad9c9004c05422467b86f182740">_fileno</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>) &gt;= 0)
<a name="l00136"></a>00136             xx = <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>-&gt;<a class="code" href="structFDIO__s.html#62d348b8433a595b0106ba0533b13461">close</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>);
<a name="l00137"></a>00137 <span class="preprocessor">#else</span>
<a name="l00138"></a>00138 <span class="preprocessor"></span>        (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(u-&gt;<a class="code" href="structurlinfo__s.html#07e2c6e9569eadbf5b272a79180fa412">ctrl</a>);
<a name="l00139"></a>00139 <span class="preprocessor">#endif</span>
<a name="l00140"></a>00140 <span class="preprocessor"></span>
<a name="l00141"></a>00141         u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a> = <a class="code" href="rpmio_8c.html#3631e87ad697d5acfce8446af8b73c22">fdio</a>-&gt;<a class="code" href="structFDIO__s.html#26073c5326efa80bb82de1b897f84863">_fdderef</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>, <span class="stringliteral">"persist data (urlFree)"</span>, file, line);
<a name="l00142"></a>00142         <span class="comment">/*@-usereleased@*/</span>
<a name="l00143"></a>00143         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>)
<a name="l00144"></a>00144             fprintf(stderr, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"warning: u %p data %p nrefs != 0 (%s %s)\n"</span>),
<a name="l00145"></a>00145                         u, u-&gt;<a class="code" href="structurlinfo__s.html#a8aa27eea072105bad0e1d1622b0140e">data</a>, (u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> : <span class="stringliteral">""</span>),
<a name="l00146"></a>00146                         (u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> : <span class="stringliteral">""</span>));
<a name="l00147"></a>00147         <span class="comment">/*@=usereleased@*/</span>
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#e1b946e6840eea54710417ff9069af82">sess</a> != NULL) {
<a name="l00150"></a>00150 <span class="preprocessor">#ifdef WITH_NEON</span>
<a name="l00151"></a>00151 <span class="preprocessor"></span>        <span class="comment">/* HACK: neon include has prototype. */</span>
<a name="l00152"></a>00152         ne_session_destroy(u-&gt;<a class="code" href="structurlinfo__s.html#e1b946e6840eea54710417ff9069af82">sess</a>);
<a name="l00153"></a>00153 <span class="preprocessor">#endif</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>        u-&gt;<a class="code" href="structurlinfo__s.html#e1b946e6840eea54710417ff9069af82">sess</a> = NULL;
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156     u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(u-&gt;<a class="code" href="structurlinfo__s.html#c002b8fee0c4622df72e54d8c023e5a5">buf</a>);
<a name="l00157"></a>00157     u-&gt;<a class="code" href="structurlinfo__s.html#810926c59d9599b52ed296e2052a136a">url</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(u-&gt;<a class="code" href="structurlinfo__s.html#810926c59d9599b52ed296e2052a136a">url</a>);
<a name="l00158"></a>00158     u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a>);
<a name="l00159"></a>00159     u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a>);
<a name="l00160"></a>00160     u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a>);
<a name="l00161"></a>00161     u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a>);
<a name="l00162"></a>00162     u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a>);
<a name="l00163"></a>00163     u-&gt;<a class="code" href="structurlinfo__s.html#ca1ff621d781bab60db384046c4580be">proxyu</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#ca1ff621d781bab60db384046c4580be">proxyu</a>);
<a name="l00164"></a>00164     u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>((<span class="keywordtype">void</span> *)u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a>);
<a name="l00165"></a>00165 
<a name="l00166"></a>00166     <span class="comment">/*@-refcounttrans@*/</span> u = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(u); <span class="comment">/*@-refcounttrans@*/</span>
<a name="l00167"></a>00167     <span class="keywordflow">return</span> NULL;
<a name="l00168"></a>00168 }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00171"></a><a class="code" href="url_8c.html#c800978d37f9d36fee3ac630cfd73db5">00171</a> <span class="keywordtype">void</span> <a class="code" href="rpmurl_8h.html#c800978d37f9d36fee3ac630cfd73db5" title="Free cached URL control structures.">urlFreeCache</a>(<span class="keywordtype">void</span>)
<a name="l00172"></a>00172 {
<a name="l00173"></a>00173     <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>) {
<a name="l00174"></a>00174         <span class="keywordtype">int</span> i;
<a name="l00175"></a>00175         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rpmurl_8h.html#44e040e8dc393e8d0daa6356280826d0">_url_count</a>; i++) {
<a name="l00176"></a>00176             <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i] == NULL) <span class="keywordflow">continue</span>;
<a name="l00177"></a>00177             <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i] = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i], <span class="stringliteral">"_url_cache"</span>);
<a name="l00178"></a>00178             <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i])
<a name="l00179"></a>00179                 fprintf(stderr,
<a name="l00180"></a>00180                         <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"warning: _url_cache[%d] %p nrefs(%d) != 1 (%s %s)\n"</span>),
<a name="l00181"></a>00181                         i, <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i], <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i]-&gt;nrefs,
<a name="l00182"></a>00182                         (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i]-&gt;host ? <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i]-&gt;host : <span class="stringliteral">""</span>),
<a name="l00183"></a>00183                         (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i]-&gt;scheme ? <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i]-&gt;scheme : <span class="stringliteral">""</span>));
<a name="l00184"></a>00184         }
<a name="l00185"></a>00185     }
<a name="l00186"></a>00186     <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>);
<a name="l00187"></a>00187     <a class="code" href="rpmurl_8h.html#44e040e8dc393e8d0daa6356280826d0">_url_count</a> = 0;
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00190"></a>00190 
<a name="l00191"></a><a class="code" href="url_8c.html#cf1f0229f3fb2cb68cc22dced9a50579">00191</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="url_8c.html#cf1f0229f3fb2cb68cc22dced9a50579">urlStrcmp</a>(<span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * str1, <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * str2)
<a name="l00192"></a>00192         <span class="comment">/*@*/</span>
<a name="l00193"></a>00193 {
<a name="l00194"></a>00194     <span class="keywordflow">if</span> (str1)
<a name="l00195"></a>00195         <span class="keywordflow">if</span> (str2)
<a name="l00196"></a>00196             <span class="keywordflow">return</span> strcmp(str1, str2);
<a name="l00197"></a>00197     <span class="keywordflow">if</span> (str1 != str2)
<a name="l00198"></a>00198         <span class="keywordflow">return</span> -1;
<a name="l00199"></a>00199     <span class="keywordflow">return</span> 0;
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00203"></a>00203 <span class="comment">/*@-mods@*/</span>
<a name="l00204"></a><a class="code" href="url_8c.html#d6949a734a2d1450c7fc4e21b7a3c7f9">00204</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="url_8c.html#d6949a734a2d1450c7fc4e21b7a3c7f9">urlFind</a>(<span class="comment">/*@null@*/</span> <span class="comment">/*@in@*/</span> <span class="comment">/*@out@*/</span> <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> * uret, <span class="keywordtype">int</span> mustAsk)
<a name="l00205"></a>00205         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00206"></a>00206         <span class="comment">/*@modifies *uret, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l00209"></a>00209     <span class="keywordtype">int</span> ucx;
<a name="l00210"></a>00210     <span class="keywordtype">int</span> i = 0;
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="keywordflow">if</span> (uret == NULL)
<a name="l00213"></a>00213         <span class="keywordflow">return</span>;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     u = *uret;
<a name="l00216"></a>00216     <a class="code" href="rpmurl_8h.html#5d3280f6157f1df3be1defc186106b5f">URLSANE</a>(u);
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     ucx = -1;
<a name="l00219"></a>00219     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rpmurl_8h.html#44e040e8dc393e8d0daa6356280826d0">_url_count</a>; i++) {
<a name="l00220"></a>00220         <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> ou = NULL;
<a name="l00221"></a>00221         <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a> == NULL || (ou = <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[i]) == NULL) {
<a name="l00222"></a>00222             <span class="keywordflow">if</span> (ucx &lt; 0)
<a name="l00223"></a>00223                 ucx = i;
<a name="l00224"></a>00224             <span class="keywordflow">continue</span>;
<a name="l00225"></a>00225         }
<a name="l00226"></a>00226 
<a name="l00227"></a>00227         <span class="comment">/* Check for cache-miss condition. A cache miss is</span>
<a name="l00228"></a>00228 <span class="comment">         *    a) both items are not NULL and don't compare.</span>
<a name="l00229"></a>00229 <span class="comment">         *    b) either of the items is not NULL.</span>
<a name="l00230"></a>00230 <span class="comment">         */</span>
<a name="l00231"></a>00231         <span class="keywordflow">if</span> (<a class="code" href="url_8c.html#cf1f0229f3fb2cb68cc22dced9a50579">urlStrcmp</a>(u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a>, ou-&gt;scheme))
<a name="l00232"></a>00232             <span class="keywordflow">continue</span>;
<a name="l00233"></a>00233         if (<a class="code" href="url_8c.html#cf1f0229f3fb2cb68cc22dced9a50579">urlStrcmp</a>(u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a>, ou-&gt;host))
<a name="l00234"></a>00234             <span class="keywordflow">continue</span>;
<a name="l00235"></a>00235         if (<a class="code" href="url_8c.html#cf1f0229f3fb2cb68cc22dced9a50579">urlStrcmp</a>(u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a>, ou-&gt;user))
<a name="l00236"></a>00236             <span class="keywordflow">continue</span>;
<a name="l00237"></a>00237         if (<a class="code" href="url_8c.html#cf1f0229f3fb2cb68cc22dced9a50579">urlStrcmp</a>(u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a>, ou-&gt;portstr))
<a name="l00238"></a>00238             <span class="keywordflow">continue</span>;
<a name="l00239"></a>00239         <span class="keywordflow">break</span>;  <span class="comment">/* Found item in cache */</span>
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="keywordflow">if</span> (i == _url_count) {
<a name="l00243"></a>00243         <span class="keywordflow">if</span> (ucx &lt; 0) {
<a name="l00244"></a>00244             ucx = _url_count++;
<a name="l00245"></a>00245             <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a> = <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>, <span class="keyword">sizeof</span>(*<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>) * _url_count);
<a name="l00246"></a>00246         }
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>)         <span class="comment">/* XXX always true */</span>
<a name="l00248"></a>00248             <a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[ucx] = <a class="code" href="rpmurl_8h.html#c6c1cad826e839c25c2842ab97c0bd6e">urlLink</a>(u, <span class="stringliteral">"_url_cache (miss)"</span>);
<a name="l00249"></a>00249         u = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(u, <span class="stringliteral">"urlSplit (urlFind miss)"</span>);
<a name="l00250"></a>00250     } <span class="keywordflow">else</span> {
<a name="l00251"></a>00251         ucx = i;
<a name="l00252"></a>00252         u = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(u, <span class="stringliteral">"urlSplit (urlFind hit)"</span>);
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     <span class="comment">/* This URL is now cached. */</span>
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>)             <span class="comment">/* XXX always true */</span>
<a name="l00258"></a>00258         u = <a class="code" href="rpmurl_8h.html#c6c1cad826e839c25c2842ab97c0bd6e">urlLink</a>(<a class="code" href="rpmurl_8h.html#9a92030d7a52c9d5aa0dc0b0bfbc3b32">_url_cache</a>[ucx], <span class="stringliteral">"_url_cache"</span>);
<a name="l00259"></a>00259     *uret = u;
<a name="l00260"></a>00260     <span class="comment">/*@-usereleased@*/</span>
<a name="l00261"></a>00261     u = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(u, <span class="stringliteral">"_url_cache (urlFind)"</span>);
<a name="l00262"></a>00262     <span class="comment">/*@=usereleased@*/</span>
<a name="l00263"></a>00263 
<a name="l00264"></a>00264     <span class="comment">/* Zap proxy host and port in case they have been reset */</span>
<a name="l00265"></a>00265     u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> = -1;
<a name="l00266"></a>00266     u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a>);
<a name="l00267"></a>00267 
<a name="l00268"></a>00268     <span class="comment">/* Perform one-time FTP initialization */</span>
<a name="l00269"></a>00269     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>) {
<a name="l00270"></a>00270 
<a name="l00271"></a>00271         <span class="keywordflow">if</span> (mustAsk || (u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> != NULL &amp;&amp; u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> == NULL)) {
<a name="l00272"></a>00272             <span class="keyword">const</span> <span class="keywordtype">char</span> * host = (u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> : <span class="stringliteral">""</span>);
<a name="l00273"></a>00273             <span class="keyword">const</span> <span class="keywordtype">char</span> * user = (u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> : <span class="stringliteral">""</span>);
<a name="l00274"></a>00274             <span class="keywordtype">char</span> * prompt;
<a name="l00275"></a>00275             prompt = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(strlen(host) + strlen(user) + 256);
<a name="l00276"></a>00276             sprintf(prompt, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Password for %s@%s: "</span>), user, host);
<a name="l00277"></a>00277             u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a>);
<a name="l00278"></a>00278 <span class="comment">/*@-dependenttrans -moduncon @*/</span>
<a name="l00279"></a>00279             u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> = <span class="comment">/*@-unrecog@*/</span> getpass(prompt) <span class="comment">/*@=unrecog@*/</span>;
<a name="l00280"></a>00280 <span class="comment">/*@=dependenttrans =moduncon @*/</span>
<a name="l00281"></a>00281             <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a>)
<a name="l00282"></a>00282                 u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a>);
<a name="l00283"></a>00283         }
<a name="l00284"></a>00284 
<a name="l00285"></a>00285         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> == NULL) {
<a name="l00286"></a>00286             <span class="keyword">const</span> <span class="keywordtype">char</span> *proxy = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{_ftpproxy}"</span>, NULL);
<a name="l00287"></a>00287             <span class="keywordflow">if</span> (proxy &amp;&amp; *proxy != <span class="charliteral">'%'</span>) {
<a name="l00288"></a>00288 <span class="comment">/*@observer@*/</span>
<a name="l00289"></a>00289                 <span class="keyword">const</span> <span class="keywordtype">char</span> * host = (u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> : <span class="stringliteral">""</span>);
<a name="l00290"></a>00290                 <span class="keyword">const</span> <span class="keywordtype">char</span> *uu = (u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> : <span class="stringliteral">"anonymous"</span>);
<a name="l00291"></a>00291                 <span class="keywordtype">char</span> *nu = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(strlen(uu) + <span class="keyword">sizeof</span>(<span class="stringliteral">"@"</span>) + strlen(host));
<a name="l00292"></a>00292                 (void) <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(nu, uu), <span class="stringliteral">"@"</span>), host);
<a name="l00293"></a>00293                 u-&gt;<a class="code" href="structurlinfo__s.html#ca1ff621d781bab60db384046c4580be">proxyu</a> = nu;
<a name="l00294"></a>00294                 u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(proxy);
<a name="l00295"></a>00295             }
<a name="l00296"></a>00296             proxy = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(proxy);
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> &lt; 0) {
<a name="l00300"></a>00300             <span class="keyword">const</span> <span class="keywordtype">char</span> *proxy = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{_ftpport}"</span>, NULL);
<a name="l00301"></a>00301             <span class="keywordflow">if</span> (proxy &amp;&amp; *proxy != <span class="charliteral">'%'</span>) {
<a name="l00302"></a>00302                 <span class="keywordtype">char</span> *end = NULL;
<a name="l00303"></a>00303                 <span class="keywordtype">int</span> port = strtol(proxy, &amp;end, 0);
<a name="l00304"></a>00304                 <span class="keywordflow">if</span> (!(end &amp;&amp; *end == <span class="charliteral">'\0'</span>)) {
<a name="l00305"></a>00305                     fprintf(stderr, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"error: %sport must be a number\n"</span>),
<a name="l00306"></a>00306                         (u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> : <span class="stringliteral">""</span>));
<a name="l00307"></a>00307                     <span class="keywordflow">return</span>;
<a name="l00308"></a>00308                 }
<a name="l00309"></a>00309                 u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> = port;
<a name="l00310"></a>00310             }
<a name="l00311"></a>00311             proxy = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(proxy);
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment">/* Perform one-time HTTP initialization */</span>
<a name="l00316"></a>00316     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a> || u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a> || u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>) {
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> == NULL) {
<a name="l00319"></a>00319             <span class="keyword">const</span> <span class="keywordtype">char</span> *proxy = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{_httpproxy}"</span>, NULL);
<a name="l00320"></a>00320             <span class="keywordflow">if</span> (proxy &amp;&amp; *proxy != <span class="charliteral">'%'</span>)
<a name="l00321"></a>00321                 u-&gt;<a class="code" href="structurlinfo__s.html#e13c8ce85730a4c4d0eaf8cfb76d894e">proxyh</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(proxy);
<a name="l00322"></a>00322             proxy = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(proxy);
<a name="l00323"></a>00323         }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> &lt; 0) {
<a name="l00326"></a>00326             <span class="keyword">const</span> <span class="keywordtype">char</span> *proxy = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{_httpport}"</span>, NULL);
<a name="l00327"></a>00327             <span class="keywordflow">if</span> (proxy &amp;&amp; *proxy != <span class="charliteral">'%'</span>) {
<a name="l00328"></a>00328                 <span class="keywordtype">char</span> *end;
<a name="l00329"></a>00329                 <span class="keywordtype">int</span> port = strtol(proxy, &amp;end, 0);
<a name="l00330"></a>00330                 <span class="keywordflow">if</span> (!(end &amp;&amp; *end == <span class="charliteral">'\0'</span>)) {
<a name="l00331"></a>00331                     fprintf(stderr, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"error: %sport must be a number\n"</span>),
<a name="l00332"></a>00332                         (u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> ? u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> : <span class="stringliteral">""</span>));
<a name="l00333"></a>00333                     <span class="keywordflow">return</span>;
<a name="l00334"></a>00334                 }
<a name="l00335"></a>00335                 u-&gt;<a class="code" href="structurlinfo__s.html#da50fd693888587dc69f57a6d581cf92">proxyp</a> = port;
<a name="l00336"></a>00336             }
<a name="l00337"></a>00337             proxy = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(proxy);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339 
<a name="l00340"></a>00340     }
<a name="l00341"></a>00341 
<a name="l00342"></a>00342     <span class="keywordflow">return</span>;
<a name="l00343"></a>00343 }
<a name="l00344"></a>00344 <span class="comment">/*@=mods@*/</span>
<a name="l00345"></a>00345 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00346"></a>00346 
<a name="l00349"></a>00349 <span class="comment">/*@observer@*/</span> <span class="comment">/*@unchecked@*/</span>
<a name="l00350"></a><a class="code" href="structurlstring.html">00350</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structurlstring.html">urlstring</a> {
<a name="l00351"></a>00351 <span class="comment">/*@observer@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00352"></a><a class="code" href="structurlstring.html#583ad8412f8216f2dc3110a310dec06a">00352</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structurlstring.html#583ad8412f8216f2dc3110a310dec06a">leadin</a>;
<a name="l00353"></a><a class="code" href="structurlstring.html#4da4a35a9d5e3b1cb5564825afd41fbf">00353</a>     <a class="code" href="rpmurl_8h.html#8fc34597e828d3067e3844b571922d2d" title="Supported URL types.">urltype</a>     <a class="code" href="structurlstring.html#4da4a35a9d5e3b1cb5564825afd41fbf">ret</a>;
<a name="l00354"></a>00354 } <a class="code" href="url_8c.html#9c7cead43bf30abb54683664e15ab72b">urlstrings</a>[] = {
<a name="l00355"></a>00355     { <span class="stringliteral">"file://"</span>,        <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a> },
<a name="l00356"></a>00356     { <span class="stringliteral">"ftp://"</span>,         <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a> },
<a name="l00357"></a>00357     { <span class="stringliteral">"hkp://"</span>,         <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a> },
<a name="l00358"></a>00358     { <span class="stringliteral">"http://"</span>,        <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a> },
<a name="l00359"></a>00359     { <span class="stringliteral">"https://"</span>,       <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a> },
<a name="l00360"></a>00360     { <span class="stringliteral">"-"</span>,              <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a> },
<a name="l00361"></a>00361     { NULL,             <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a> }
<a name="l00362"></a>00362 };
<a name="l00363"></a>00363 
<a name="l00364"></a><a class="code" href="url_8c.html#9def993f3a6f0b632236c66e03df7da6">00364</a> <a class="code" href="rpmurl_8h.html#8fc34597e828d3067e3844b571922d2d" title="Supported URL types.">urltype</a> <a class="code" href="rpmurl_8h.html#9def993f3a6f0b632236c66e03df7da6" title="Return type of URL.">urlIsURL</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url)
<a name="l00365"></a>00365 {
<a name="l00366"></a>00366     <span class="keyword">struct </span><a class="code" href="structurlstring.html">urlstring</a> *us;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368 <span class="comment">/*@-boundsread@*/</span>
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (url &amp;&amp; *url) {
<a name="l00370"></a>00370         <span class="keywordflow">for</span> (us = <a class="code" href="url_8c.html#9c7cead43bf30abb54683664e15ab72b">urlstrings</a>; us-&gt;<a class="code" href="structurlstring.html#583ad8412f8216f2dc3110a310dec06a">leadin</a> != NULL; us++) {
<a name="l00371"></a>00371             <span class="keywordflow">if</span> (strncmp(url, us-&gt;<a class="code" href="structurlstring.html#583ad8412f8216f2dc3110a310dec06a">leadin</a>, strlen(us-&gt;<a class="code" href="structurlstring.html#583ad8412f8216f2dc3110a310dec06a">leadin</a>)))
<a name="l00372"></a>00372                 <span class="keywordflow">continue</span>;
<a name="l00373"></a>00373             <span class="keywordflow">return</span> us-&gt;<a class="code" href="structurlstring.html#4da4a35a9d5e3b1cb5564825afd41fbf">ret</a>;
<a name="l00374"></a>00374         }
<a name="l00375"></a>00375     }
<a name="l00376"></a>00376 <span class="comment">/*@=boundsread@*/</span>
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     <span class="keywordflow">return</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>;
<a name="l00379"></a>00379 }
<a name="l00380"></a>00380 
<a name="l00381"></a>00381 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00382"></a>00382 <span class="comment">/* Return path portion of url (or pointer to NUL if url == NULL) */</span>
<a name="l00383"></a><a class="code" href="url_8c.html#35492e2be1d0a9376b9b0d29512dab4d">00383</a> <a class="code" href="rpmurl_8h.html#8fc34597e828d3067e3844b571922d2d" title="Supported URL types.">urltype</a> <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url, <span class="keyword">const</span> <span class="keywordtype">char</span> ** pathp)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385     <span class="keyword">const</span> <span class="keywordtype">char</span> *path;
<a name="l00386"></a>00386     <span class="keywordtype">int</span> <a class="code" href="rpmurl_8h.html#8fc34597e828d3067e3844b571922d2d" title="Supported URL types.">urltype</a>;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388     path = url;
<a name="l00389"></a>00389     urltype = <a class="code" href="rpmurl_8h.html#9def993f3a6f0b632236c66e03df7da6" title="Return type of URL.">urlIsURL</a>(url);
<a name="l00390"></a>00390     <span class="comment">/*@-branchstate@*/</span>
<a name="l00391"></a>00391     <span class="keywordflow">switch</span> (urltype) {
<a name="l00392"></a>00392     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l00393"></a>00393         url += <span class="keyword">sizeof</span>(<span class="stringliteral">"ftp://"</span>) - 1;
<a name="l00394"></a>00394         path = strchr(url, <span class="charliteral">'/'</span>);
<a name="l00395"></a>00395         <span class="keywordflow">if</span> (path == NULL) path = url + strlen(url);
<a name="l00396"></a>00396         <span class="keywordflow">break</span>;
<a name="l00397"></a>00397     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l00398"></a>00398         url += <span class="keyword">sizeof</span>(<span class="stringliteral">"file://"</span>) - 1;
<a name="l00399"></a>00399         path = strchr(url, <span class="charliteral">'/'</span>);
<a name="l00400"></a>00400         <span class="keywordflow">if</span> (path == NULL) path = url + strlen(url);
<a name="l00401"></a>00401         <span class="keywordflow">break</span>;
<a name="l00402"></a>00402     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l00403"></a>00403         url += <span class="keyword">sizeof</span>(<span class="stringliteral">"hkp://"</span>) - 1;
<a name="l00404"></a>00404         path = strchr(url, <span class="charliteral">'/'</span>);
<a name="l00405"></a>00405         <span class="keywordflow">if</span> (path == NULL) path = url + strlen(url);
<a name="l00406"></a>00406         <span class="keywordflow">break</span>;
<a name="l00407"></a>00407     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l00408"></a>00408         url += <span class="keyword">sizeof</span>(<span class="stringliteral">"http://"</span>) - 1;
<a name="l00409"></a>00409         path = strchr(url, <span class="charliteral">'/'</span>);
<a name="l00410"></a>00410         <span class="keywordflow">if</span> (path == NULL) path = url + strlen(url);
<a name="l00411"></a>00411         <span class="keywordflow">break</span>;
<a name="l00412"></a>00412     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l00413"></a>00413         url += <span class="keyword">sizeof</span>(<span class="stringliteral">"https://"</span>) - 1;
<a name="l00414"></a>00414         path = strchr(url, <span class="charliteral">'/'</span>);
<a name="l00415"></a>00415         <span class="keywordflow">if</span> (path == NULL) path = url + strlen(url);
<a name="l00416"></a>00416         <span class="keywordflow">break</span>;
<a name="l00417"></a>00417     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l00418"></a>00418         <span class="keywordflow">if</span> (path == NULL) path = <span class="stringliteral">""</span>;
<a name="l00419"></a>00419         <span class="keywordflow">break</span>;
<a name="l00420"></a>00420     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l00421"></a>00421         path = <span class="stringliteral">""</span>;
<a name="l00422"></a>00422         <span class="keywordflow">break</span>;
<a name="l00423"></a>00423     }
<a name="l00424"></a>00424     <span class="comment">/*@=branchstate@*/</span>
<a name="l00425"></a>00425     <span class="keywordflow">if</span> (pathp)
<a name="l00426"></a>00426         <span class="comment">/*@-observertrans@*/</span>
<a name="l00427"></a>00427         *pathp = path;
<a name="l00428"></a>00428         <span class="comment">/*@=observertrans@*/</span>
<a name="l00429"></a>00429     <span class="keywordflow">return</span> urltype;
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00432"></a>00432 
<a name="l00433"></a>00433 <span class="comment">/*</span>
<a name="l00434"></a>00434 <span class="comment"> * Split URL into components. The URL can look like</span>
<a name="l00435"></a>00435 <span class="comment"> *      scheme://user:password@host:port/path</span>
<a name="l00436"></a>00436 <span class="comment">  * or as in RFC2732 for IPv6 address</span>
<a name="l00437"></a>00437 <span class="comment">  *    service://user:password@[ip:v6:ad:dr:es:s]:port/path</span>
<a name="l00438"></a>00438 <span class="comment"> */</span>
<a name="l00439"></a>00439 <span class="comment">/*@-bounds@*/</span>
<a name="l00440"></a>00440 <span class="comment">/*@-modfilesys@*/</span>
<a name="l00441"></a><a class="code" href="url_8c.html#317bdf1b8d8cf4ee786d8f38f8094cb2">00441</a> <span class="keywordtype">int</span> <a class="code" href="rpmurl_8h.html#317bdf1b8d8cf4ee786d8f38f8094cb2" title="Parse URL string into a control structure.">urlSplit</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url, <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> *uret)
<a name="l00442"></a>00442 {
<a name="l00443"></a>00443     <a class="code" href="structurlinfo__s.html" title="URL control structure.">urlinfo</a> u;
<a name="l00444"></a>00444     <span class="keywordtype">char</span> *myurl;
<a name="l00445"></a>00445     <span class="keywordtype">char</span> *s, *se, *f, *fe;
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (uret == NULL)
<a name="l00448"></a>00448         <span class="keywordflow">return</span> -1;
<a name="l00449"></a>00449     <span class="keywordflow">if</span> ((u = <a class="code" href="rpmurl_8h.html#b1d6deda1e708c64d500499f538641a3">urlNew</a>(<span class="stringliteral">"urlSplit"</span>)) == NULL)
<a name="l00450"></a>00450         <span class="keywordflow">return</span> -1;
<a name="l00451"></a>00451 
<a name="l00452"></a>00452     <span class="keywordflow">if</span> ((se = s = myurl = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(url)) == NULL) {
<a name="l00453"></a>00453         u = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(u, <span class="stringliteral">"urlSplit (error #1)"</span>);
<a name="l00454"></a>00454         <span class="keywordflow">return</span> -1;
<a name="l00455"></a>00455     }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457     u-&gt;<a class="code" href="structurlinfo__s.html#810926c59d9599b52ed296e2052a136a">url</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(url);
<a name="l00458"></a>00458     u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> = <a class="code" href="rpmurl_8h.html#9def993f3a6f0b632236c66e03df7da6" title="Return type of URL.">urlIsURL</a>(url);
<a name="l00459"></a>00459 
<a name="l00460"></a>00460     <span class="keywordflow">while</span> (1) {
<a name="l00461"></a>00461         <span class="comment">/* Point to end of next item */</span>
<a name="l00462"></a>00462         <span class="keywordflow">while</span> (*se &amp;&amp; *se != <span class="charliteral">'/'</span>) se++;
<a name="l00463"></a>00463         <span class="comment">/* Item was scheme. Save scheme and go for the rest ...*/</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (*se &amp;&amp; (se != s) &amp;&amp; se[-1] == <span class="charliteral">':'</span> &amp;&amp; se[0] == <span class="charliteral">'/'</span> &amp;&amp; se[1] == <span class="charliteral">'/'</span>) {
<a name="l00465"></a>00465                 se[-1] = <span class="charliteral">'\0'</span>;
<a name="l00466"></a>00466             u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(s);
<a name="l00467"></a>00467             se += 2;    <span class="comment">/* skip over "//" */</span>
<a name="l00468"></a>00468             s = se++;
<a name="l00469"></a>00469             <span class="keywordflow">continue</span>;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471         
<a name="l00472"></a>00472         <span class="comment">/* Item was everything-but-path. Continue parse on rest */</span>
<a name="l00473"></a>00473         *se = <span class="charliteral">'\0'</span>;
<a name="l00474"></a>00474         <span class="keywordflow">break</span>;
<a name="l00475"></a>00475     }
<a name="l00476"></a>00476 
<a name="l00477"></a>00477     <span class="comment">/* Look for ...@host... */</span>
<a name="l00478"></a>00478     fe = f = s;
<a name="l00479"></a>00479     <span class="keywordflow">while</span> (*fe &amp;&amp; *fe != <span class="charliteral">'@'</span>) fe++;
<a name="l00480"></a>00480     <span class="comment">/*@-branchstate@*/</span>
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (*fe == <span class="charliteral">'@'</span>) {
<a name="l00482"></a>00482         s = fe + 1;
<a name="l00483"></a>00483         *fe = <span class="charliteral">'\0'</span>;
<a name="l00484"></a>00484         <span class="comment">/* Look for user:password@host... */</span>
<a name="l00485"></a>00485         <span class="keywordflow">while</span> (fe &gt; f &amp;&amp; *fe != <span class="charliteral">':'</span>) fe--;
<a name="l00486"></a>00486         <span class="keywordflow">if</span> (*fe == <span class="charliteral">':'</span>) {
<a name="l00487"></a>00487             *fe++ = <span class="charliteral">'\0'</span>;
<a name="l00488"></a>00488             u-&gt;<a class="code" href="structurlinfo__s.html#ccad905550fc5832c521ecde849a7df4">password</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fe);
<a name="l00489"></a>00489         }
<a name="l00490"></a>00490         u-&gt;<a class="code" href="structurlinfo__s.html#a1588d6ff310cbee4492ca5d51474217">user</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(f);
<a name="l00491"></a>00491     }
<a name="l00492"></a>00492     <span class="comment">/*@=branchstate@*/</span>
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="comment">/* Look for ...host:port or [v6addr]:port*/</span>
<a name="l00495"></a>00495     fe = f = s;
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (strchr(fe, <span class="charliteral">'['</span>) &amp;&amp; strchr(fe, <span class="charliteral">']'</span>))
<a name="l00497"></a>00497     {
<a name="l00498"></a>00498             fe = strchr(f, <span class="charliteral">']'</span>);
<a name="l00499"></a>00499             *f++ = <span class="charliteral">'\0'</span>;
<a name="l00500"></a>00500             *fe++ = <span class="charliteral">'\0'</span>;
<a name="l00501"></a>00501     }
<a name="l00502"></a>00502     <span class="keywordflow">while</span> (*fe &amp;&amp; *fe != <span class="charliteral">':'</span>) fe++;
<a name="l00503"></a>00503     <span class="keywordflow">if</span> (*fe == <span class="charliteral">':'</span>) {
<a name="l00504"></a>00504         *fe++ = <span class="charliteral">'\0'</span>;
<a name="l00505"></a>00505         u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fe);
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a> != NULL &amp;&amp; u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a>[0] != <span class="charliteral">'\0'</span>) {
<a name="l00507"></a>00507             <span class="keywordtype">char</span> *end;
<a name="l00508"></a>00508             u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> = strtol(u-&gt;<a class="code" href="structurlinfo__s.html#ecc9565c6f6a2006b01fa947a2d643cc">portstr</a>, &amp;end, 0);
<a name="l00509"></a>00509             <span class="keywordflow">if</span> (!(end &amp;&amp; *end == <span class="charliteral">'\0'</span>)) {
<a name="l00510"></a>00510                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#7f05203668c38f07c3b18032902988ae">RPMMESS_ERROR</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"url port must be a number\n"</span>));
<a name="l00511"></a>00511                 myurl = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(myurl);
<a name="l00512"></a>00512                 u = <a class="code" href="rpmurl_8h.html#fc273d8cf23e6087a8996a356234e231">urlFree</a>(u, <span class="stringliteral">"urlSplit (error #3)"</span>);
<a name="l00513"></a>00513                 <span class="keywordflow">return</span> -1;
<a name="l00514"></a>00514             }
<a name="l00515"></a>00515         }
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517     u-&gt;<a class="code" href="structurlinfo__s.html#e7c94308ea4b9f38730a9f7151fa1c71">host</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(f);
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> &lt; 0 &amp;&amp; u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a> != NULL) {
<a name="l00520"></a>00520         <span class="keyword">struct </span>servent *serv;
<a name="l00521"></a>00521 <span class="comment">/*@-multithreaded -moduncon @*/</span>
<a name="l00522"></a>00522         <span class="comment">/* HACK hkp:// might lookup "pgpkeyserver" */</span>
<a name="l00523"></a>00523         serv = getservbyname(u-&gt;<a class="code" href="structurlinfo__s.html#d868ebf170c98d7400f50c229387cc9a">scheme</a>, <span class="stringliteral">"tcp"</span>);
<a name="l00524"></a>00524 <span class="comment">/*@=multithreaded =moduncon @*/</span>
<a name="l00525"></a>00525         <span class="keywordflow">if</span> (serv != NULL)
<a name="l00526"></a>00526             u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> = ntohs(serv-&gt;s_port);
<a name="l00527"></a>00527         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>)
<a name="l00528"></a>00528             u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> = <a class="code" href="rpmio_8c.html#b1bfa063152e67aed53df45f4fae8cd8">IPPORT_FTP</a>;
<a name="l00529"></a>00529         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>)
<a name="l00530"></a>00530             u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> = <a class="code" href="url_8c.html#9a689e3b65f7381e2cc5c1c916893b43">IPPORT_PGPKEYSERVER</a>;
<a name="l00531"></a>00531         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>)
<a name="l00532"></a>00532             u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> = <a class="code" href="rpmio_8c.html#4c4b2f064d844572b83e49a63b1fdfad">IPPORT_HTTP</a>;
<a name="l00533"></a>00533         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (u-&gt;<a class="code" href="structurlinfo__s.html#8e9ba4cd3ab2512cce7ddbf5463a076e">urltype</a> == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>)
<a name="l00534"></a>00534             u-&gt;<a class="code" href="structurlinfo__s.html#8bdb03a9bbe21c67a08166130304e120">port</a> = <a class="code" href="url_8c.html#533c0f1d68037c5e0b847f07d562f9d2">IPPORT_HTTPS</a>;
<a name="l00535"></a>00535     }
<a name="l00536"></a>00536 
<a name="l00537"></a>00537     myurl = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(myurl);
<a name="l00538"></a>00538     <span class="keywordflow">if</span> (uret) {
<a name="l00539"></a>00539         *uret = u;
<a name="l00540"></a>00540 <span class="comment">/*@-globs -mods @*/</span> <span class="comment">/* FIX: rpmGlobalMacroContext not in &lt;rpmlib.h&gt; */</span>
<a name="l00541"></a>00541         <a class="code" href="url_8c.html#d6949a734a2d1450c7fc4e21b7a3c7f9">urlFind</a>(uret, 0);
<a name="l00542"></a>00542 <span class="comment">/*@=globs =mods @*/</span>
<a name="l00543"></a>00543     }
<a name="l00544"></a>00544     <span class="keywordflow">return</span> 0;
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 <span class="comment">/*@=modfilesys@*/</span>
<a name="l00547"></a>00547 <span class="comment">/*@=bounds@*/</span>
<a name="l00548"></a>00548 
<a name="l00549"></a><a class="code" href="url_8c.html#066815a1b9d1f618bfc020e794ccf081">00549</a> <span class="keywordtype">int</span> <a class="code" href="rpmurl_8h.html#066815a1b9d1f618bfc020e794ccf081" title="Copy data from URL to local file.">urlGetFile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * url, <span class="keyword">const</span> <span class="keywordtype">char</span> * dest)
<a name="l00550"></a>00550 {
<a name="l00551"></a>00551     <span class="keywordtype">int</span> rc;
<a name="l00552"></a>00552     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> sfd = NULL;
<a name="l00553"></a>00553     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> tfd = NULL;
<a name="l00554"></a>00554     <span class="keyword">const</span> <span class="keywordtype">char</span> * sfuPath = NULL;
<a name="l00555"></a>00555     <span class="keywordtype">int</span> urlType = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(url, &amp;sfuPath);
<a name="l00556"></a>00556 
<a name="l00557"></a>00557     <span class="keywordflow">if</span> (*sfuPath == <span class="charliteral">'\0'</span>)
<a name="l00558"></a>00558         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;
<a name="l00559"></a>00559         
<a name="l00560"></a>00560     sfd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(url, <span class="stringliteral">"r.ufdio"</span>);
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (sfd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(sfd)) {
<a name="l00562"></a>00562         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"failed to open %s: %s\n"</span>), url, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(sfd));
<a name="l00563"></a>00563         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;
<a name="l00564"></a>00564         <span class="keywordflow">goto</span> exit;
<a name="l00565"></a>00565     }
<a name="l00566"></a>00566 
<a name="l00567"></a>00567     <span class="keywordflow">if</span> (dest == NULL) {
<a name="l00568"></a>00568         <span class="keywordflow">if</span> ((dest = strrchr(sfuPath, <span class="charliteral">'/'</span>)) != NULL)
<a name="l00569"></a>00569             dest++;
<a name="l00570"></a>00570         <span class="keywordflow">else</span>
<a name="l00571"></a>00571             dest = sfuPath;
<a name="l00572"></a>00572     }
<a name="l00573"></a>00573 
<a name="l00574"></a>00574     <span class="keywordflow">if</span> (dest == NULL)
<a name="l00575"></a>00575         <span class="keywordflow">return</span> <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     tfd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(dest, <span class="stringliteral">"w.ufdio"</span>);
<a name="l00578"></a>00578 <span class="keywordflow">if</span> (<a class="code" href="rpmurl_8h.html#85349e708f188a943568778918e38205">_url_debug</a>)
<a name="l00579"></a>00579 fprintf(stderr, <span class="stringliteral">"*** urlGetFile sfd %p %s tfd %p %s\n"</span>, sfd, url, (tfd ? tfd : NULL), dest);
<a name="l00580"></a>00580     <span class="keywordflow">if</span> (tfd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(tfd)) {
<a name="l00581"></a>00581         <span class="comment">/* XXX Fstrerror */</span>
<a name="l00582"></a>00582         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"failed to create %s: %s\n"</span>), dest, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(tfd));
<a name="l00583"></a>00583         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;
<a name="l00584"></a>00584         <span class="keywordflow">goto</span> exit;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587     <span class="keywordflow">switch</span> (urlType) {
<a name="l00588"></a>00588     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l00589"></a>00589     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l00590"></a>00590     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l00591"></a>00591     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l00592"></a>00592     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l00593"></a>00593     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l00594"></a>00594     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l00595"></a>00595         <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#bf2a213ca984f30255ec6eacf55fb5ba">ufdGetFile</a>(sfd, tfd))) {
<a name="l00596"></a>00596             (void) <a class="code" href="rpmio_8h.html#1c789f4e5cf1fb0106ec85ebad2406ad" title="unlink(2) clone.">Unlink</a>(dest);
<a name="l00597"></a>00597             <span class="comment">/* XXX FIXME: sfd possibly closed by copyData */</span>
<a name="l00598"></a>00598             <span class="comment">/*@-usereleased@*/</span> (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(sfd) <span class="comment">/*@=usereleased@*/</span> ;
<a name="l00599"></a>00599         }
<a name="l00600"></a>00600         sfd = NULL;     <span class="comment">/* XXX Fclose(sfd) done by ufdGetFile */</span>
<a name="l00601"></a>00601         <span class="keywordflow">break</span>;
<a name="l00602"></a>00602     <span class="keywordflow">default</span>:
<a name="l00603"></a>00603         rc = <a class="code" href="rpmio_8h.html#89105757671b32966dac2063163f38df48132fe3fa733c2a0b96893be6830bb4">FTPERR_UNKNOWN</a>;
<a name="l00604"></a>00604         <span class="keywordflow">break</span>;
<a name="l00605"></a>00605     }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 exit:
<a name="l00608"></a>00608     <span class="keywordflow">if</span> (tfd)
<a name="l00609"></a>00609         (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(tfd);
<a name="l00610"></a>00610     <span class="keywordflow">if</span> (sfd)
<a name="l00611"></a>00611         (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(sfd);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613     <span class="keywordflow">return</span> rc;
<a name="l00614"></a>00614 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:55 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
