<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: lua/lcode.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>lua/lcode.c</h1><a href="lcode_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** $Id: lcode.c,v 1.2 2004/03/23 05:09:14 jbj Exp $</span>
<a name="l00003"></a>00003 <span class="comment">** Code generator for Lua</span>
<a name="l00004"></a>00004 <span class="comment">** See Copyright Notice in lua.h</span>
<a name="l00005"></a>00005 <span class="comment">*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a><a class="code" href="lcode_8c.html#bd9b7eb1bb9c303d69e93bb9ef8ad830">00010</a> <span class="preprocessor">#define lcode_c</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "lua.h"</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="lcode_8h.html">lcode.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="ldebug_8h.html">ldebug.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="ldo_8h.html">ldo.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="llex_8h.html">llex.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="lmem_8h.html">lmem.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="lobject_8h.html">lobject.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="lopcodes_8h.html">lopcodes.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="lparser_8h.html">lparser.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="ltable_8h.html">ltable.h</a>"</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="lcode_8c.html#cb0d3e4e01f0054b0de12e221aaea6e6">00025</a> <span class="preprocessor">#define hasjumps(e)     ((e)-&gt;t != (e)-&gt;f)</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 
<a name="l00028"></a><a class="code" href="lcode_8h.html#f0e44c83f5033198066e7f658f7e39ea">00028</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#f0e44c83f5033198066e7f658f7e39ea">luaK_nil</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> from, <span class="keywordtype">int</span> n) {
<a name="l00029"></a>00029   <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *previous;
<a name="l00030"></a>00030   <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a> &gt; fs-&gt;<a class="code" href="structFuncState.html#80af93c0a90b577f6c7950cb733d4049">lasttarget</a> &amp;&amp;  <span class="comment">/* no jumps to current position? */</span>
<a name="l00031"></a>00031       <a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(*(previous = &amp;fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#8eae520619c5b9bf7384af1ab8543f9a">code</a>[fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>-1])) == <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f83279f88d983880567a6e87174a22dff6">OP_LOADNIL</a>) {
<a name="l00032"></a>00032     <span class="keywordtype">int</span> pfrom = <a class="code" href="lopcodes_8h.html#1b6535ddc0b6ed588de8cc2a1096cc84">GETARG_A</a>(*previous);
<a name="l00033"></a>00033     <span class="keywordtype">int</span> pto = <a class="code" href="lopcodes_8h.html#59d1e6aadb0052fa6edc4c9500f88c3f">GETARG_B</a>(*previous);
<a name="l00034"></a>00034     <span class="keywordflow">if</span> (pfrom &lt;= from &amp;&amp; from &lt;= pto+1) {  <span class="comment">/* can connect both? */</span>
<a name="l00035"></a>00035       <span class="keywordflow">if</span> (from+n-1 &gt; pto)
<a name="l00036"></a>00036         <a class="code" href="lopcodes_8h.html#8b4ad719c249408727af43797f70fd70">SETARG_B</a>(*previous, from+n-1);
<a name="l00037"></a>00037       <span class="keywordflow">return</span>;
<a name="l00038"></a>00038     }
<a name="l00039"></a>00039   }
<a name="l00040"></a>00040   <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f83279f88d983880567a6e87174a22dff6">OP_LOADNIL</a>, from, from+n-1, 0);  <span class="comment">/* else no optimization */</span>
<a name="l00041"></a>00041 }
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 
<a name="l00044"></a><a class="code" href="lcode_8h.html#4fa57ffd18a3767fd22f642d9bd11ba6">00044</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#4fa57ffd18a3767fd22f642d9bd11ba6">luaK_jump</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs) {
<a name="l00045"></a>00045   <span class="keywordtype">int</span> jpc = fs-&gt;<a class="code" href="structFuncState.html#1f931eab98b3defe8c1948ac18d20644">jpc</a>;  <span class="comment">/* save list of jumps to here */</span>
<a name="l00046"></a>00046   <span class="keywordtype">int</span> j;
<a name="l00047"></a>00047   fs-&gt;<a class="code" href="structFuncState.html#1f931eab98b3defe8c1948ac18d20644">jpc</a> = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;
<a name="l00048"></a>00048   j = <a class="code" href="lcode_8h.html#708ac3cce1e396eba0b6af84861b5895">luaK_codeAsBx</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8c1cb8286635de6f6d8acd3a106ef4b2a">OP_JMP</a>, 0, <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);
<a name="l00049"></a>00049   <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;j, jpc);  <span class="comment">/* keep them on hold */</span>
<a name="l00050"></a>00050   <span class="keywordflow">return</span> j;
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="lcode_8c.html#8a7476adf622d981388a578fb352319c">00054</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#8a7476adf622d981388a578fb352319c">luaK_condjump</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8">OpCode</a> op, <span class="keywordtype">int</span> A, <span class="keywordtype">int</span> B, <span class="keywordtype">int</span> C)
<a name="l00055"></a>00055         <span class="comment">/*@modifies fs @*/</span>
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057   <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, op, A, B, C);
<a name="l00058"></a>00058   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#4fa57ffd18a3767fd22f642d9bd11ba6">luaK_jump</a>(fs);
<a name="l00059"></a>00059 }
<a name="l00060"></a>00060 
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="lcode_8c.html#8e3146048cb11984ba0aa0b9dbd71de3">00062</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#8e3146048cb11984ba0aa0b9dbd71de3">luaK_fixjump</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> pc, <span class="keywordtype">int</span> dest)
<a name="l00063"></a>00063         <span class="comment">/*@modifies fs @*/</span>
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065   <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *jmp = &amp;fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#8eae520619c5b9bf7384af1ab8543f9a">code</a>[pc];
<a name="l00066"></a>00066   <span class="keywordtype">int</span> offset = dest-(pc+1);
<a name="l00067"></a>00067   <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(dest != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);
<a name="l00068"></a>00068   <span class="keywordflow">if</span> (abs(offset) &gt; <a class="code" href="lopcodes_8h.html#82ada800ff3f3b969fb1b34fea4b2be8">MAXARG_sBx</a>)
<a name="l00069"></a>00069     <a class="code" href="llex_8c.html#62dfdc3824855840c7b8ef0161ce973a">luaX_syntaxerror</a>(fs-&gt;<a class="code" href="structFuncState.html#d1376c6bb410926d7c4081d63e682910">ls</a>, <span class="stringliteral">"control structure too long"</span>);
<a name="l00070"></a>00070   <a class="code" href="lopcodes_8h.html#a99a5486b9b5185b624f24910a43300b">SETARG_sBx</a>(*jmp, offset);
<a name="l00071"></a>00071 }
<a name="l00072"></a>00072 
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">/*</span>
<a name="l00075"></a>00075 <span class="comment">** returns current `pc' and marks it as a jump target (to avoid wrong</span>
<a name="l00076"></a>00076 <span class="comment">** optimizations with consecutive instructions not in the same basic block).</span>
<a name="l00077"></a>00077 <span class="comment">*/</span>
<a name="l00078"></a><a class="code" href="lcode_8h.html#79ef791c64cd5f02e5ea7ebbeef61e33">00078</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#79ef791c64cd5f02e5ea7ebbeef61e33">luaK_getlabel</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs) {
<a name="l00079"></a>00079   fs-&gt;<a class="code" href="structFuncState.html#80af93c0a90b577f6c7950cb733d4049">lasttarget</a> = fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>;
<a name="l00080"></a>00080   <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>;
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="lcode_8c.html#bc5a5e1a7bf84f40e184bad259eb8a6c">00084</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#bc5a5e1a7bf84f40e184bad259eb8a6c">luaK_getjump</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> pc)
<a name="l00085"></a>00085         <span class="comment">/*@*/</span>
<a name="l00086"></a>00086 {
<a name="l00087"></a>00087   <span class="keywordtype">int</span> offset = <a class="code" href="lopcodes_8h.html#fb75cf4013e702c6ca0531318223baa8">GETARG_sBx</a>(fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#8eae520619c5b9bf7384af1ab8543f9a">code</a>[pc]);
<a name="l00088"></a>00088   <span class="keywordflow">if</span> (offset == <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>)  <span class="comment">/* point to itself represents end of list */</span>
<a name="l00089"></a>00089     <span class="keywordflow">return</span> <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;  <span class="comment">/* end of list */</span>
<a name="l00090"></a>00090   <span class="keywordflow">else</span>
<a name="l00091"></a>00091     <span class="keywordflow">return</span> (pc+1)+offset;  <span class="comment">/* turn offset into absolute position */</span>
<a name="l00092"></a>00092 }
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="lcode_8c.html#e84e7399c953ec6a734375734374ed0f">00095</a> <span class="keyword">static</span> <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *<a class="code" href="lcode_8c.html#e84e7399c953ec6a734375734374ed0f">getjumpcontrol</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> pc)
<a name="l00096"></a>00096         <span class="comment">/*@*/</span>
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098   <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *pi = &amp;fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#8eae520619c5b9bf7384af1ab8543f9a">code</a>[pc];
<a name="l00099"></a>00099   <span class="keywordflow">if</span> (pc &gt;= 1 &amp;&amp; <a class="code" href="lopcodes_8h.html#c70d94d3e14fbbc708860491f31c7e5c">testOpMode</a>(<a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(*(pi-1)), <a class="code" href="lopcodes_8h.html#c5548e9f891d0c31fc9012defc845a3e01d185fe863d283be4b4d44c6bc26da4">OpModeT</a>))
<a name="l00100"></a>00100     <span class="keywordflow">return</span> pi-1;
<a name="l00101"></a>00101   <span class="keywordflow">else</span>
<a name="l00102"></a>00102     <span class="keywordflow">return</span> pi;
<a name="l00103"></a>00103 }
<a name="l00104"></a>00104 
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="comment">/*</span>
<a name="l00107"></a>00107 <span class="comment">** check whether list has any jump that do not produce a value</span>
<a name="l00108"></a>00108 <span class="comment">** (or produce an inverted value)</span>
<a name="l00109"></a>00109 <span class="comment">*/</span>
<a name="l00110"></a><a class="code" href="lcode_8c.html#d34a2d53e7c571b0f606862e0192914a">00110</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#d34a2d53e7c571b0f606862e0192914a">need_value</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> list, <span class="keywordtype">int</span> <a class="code" href="lparser_8c.html#c6430a9ba53b3f58401a2f61530597f9">cond</a>)
<a name="l00111"></a>00111         <span class="comment">/*@*/</span>
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113   <span class="keywordflow">for</span> (; list != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>; list = <a class="code" href="lcode_8c.html#bc5a5e1a7bf84f40e184bad259eb8a6c">luaK_getjump</a>(fs, list)) {
<a name="l00114"></a>00114     <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> i = *<a class="code" href="lcode_8c.html#e84e7399c953ec6a734375734374ed0f">getjumpcontrol</a>(fs, list);
<a name="l00115"></a>00115     <span class="keywordflow">if</span> (<a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(i) != <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8d9053c66a926eca03e88f98ed50bb509">OP_TEST</a> || <a class="code" href="lopcodes_8h.html#e2885b1cb338f15dce1f7628aee686c0">GETARG_C</a>(i) != cond) <span class="keywordflow">return</span> 1;
<a name="l00116"></a>00116   }
<a name="l00117"></a>00117   <span class="keywordflow">return</span> 0;  <span class="comment">/* not found */</span>
<a name="l00118"></a>00118 }
<a name="l00119"></a>00119 
<a name="l00120"></a>00120 
<a name="l00121"></a><a class="code" href="lcode_8c.html#0e685399f4047288b5a22dd3f301e14e">00121</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#0e685399f4047288b5a22dd3f301e14e">patchtestreg</a> (<a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *i, <span class="keywordtype">int</span> reg)
<a name="l00122"></a>00122         <span class="comment">/*@modifies *i @*/</span>
<a name="l00123"></a>00123 {
<a name="l00124"></a>00124   <span class="keywordflow">if</span> (reg == <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>) reg = <a class="code" href="lopcodes_8h.html#59d1e6aadb0052fa6edc4c9500f88c3f">GETARG_B</a>(*i);
<a name="l00125"></a>00125   <a class="code" href="lopcodes_8h.html#29c64cfcdafe9108e9e918f77bc59170">SETARG_A</a>(*i, reg);
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="lcode_8c.html#971578c244aae3043ac48d30c113874f">00129</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#971578c244aae3043ac48d30c113874f">luaK_patchlistaux</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> list,
<a name="l00130"></a>00130           <span class="keywordtype">int</span> ttarget, <span class="keywordtype">int</span> treg, <span class="keywordtype">int</span> ftarget, <span class="keywordtype">int</span> freg, <span class="keywordtype">int</span> dtarget)
<a name="l00131"></a>00131         <span class="comment">/*@modifies fs @*/</span>
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133   <span class="keywordflow">while</span> (list != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>) {
<a name="l00134"></a>00134     <span class="keywordtype">int</span> <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a> = <a class="code" href="lcode_8c.html#bc5a5e1a7bf84f40e184bad259eb8a6c">luaK_getjump</a>(fs, list);
<a name="l00135"></a>00135     <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *i = <a class="code" href="lcode_8c.html#e84e7399c953ec6a734375734374ed0f">getjumpcontrol</a>(fs, list);
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (<a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(*i) != <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8d9053c66a926eca03e88f98ed50bb509">OP_TEST</a>) {
<a name="l00137"></a>00137       <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(dtarget != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);
<a name="l00138"></a>00138       <a class="code" href="lcode_8c.html#8e3146048cb11984ba0aa0b9dbd71de3">luaK_fixjump</a>(fs, list, dtarget);  <span class="comment">/* jump to default target */</span>
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140     <span class="keywordflow">else</span> {
<a name="l00141"></a>00141       <span class="keywordflow">if</span> (<a class="code" href="lopcodes_8h.html#e2885b1cb338f15dce1f7628aee686c0">GETARG_C</a>(*i)) {
<a name="l00142"></a>00142         <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(ttarget != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);
<a name="l00143"></a>00143         <a class="code" href="lcode_8c.html#0e685399f4047288b5a22dd3f301e14e">patchtestreg</a>(i, treg);
<a name="l00144"></a>00144         <a class="code" href="lcode_8c.html#8e3146048cb11984ba0aa0b9dbd71de3">luaK_fixjump</a>(fs, list, ttarget);
<a name="l00145"></a>00145       }
<a name="l00146"></a>00146       <span class="keywordflow">else</span> {
<a name="l00147"></a>00147         <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(ftarget != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);
<a name="l00148"></a>00148         <a class="code" href="lcode_8c.html#0e685399f4047288b5a22dd3f301e14e">patchtestreg</a>(i, freg);
<a name="l00149"></a>00149         <a class="code" href="lcode_8c.html#8e3146048cb11984ba0aa0b9dbd71de3">luaK_fixjump</a>(fs, list, ftarget);
<a name="l00150"></a>00150       }
<a name="l00151"></a>00151     }
<a name="l00152"></a>00152     list = next;
<a name="l00153"></a>00153   }
<a name="l00154"></a>00154 }
<a name="l00155"></a>00155 
<a name="l00156"></a>00156 
<a name="l00157"></a><a class="code" href="lcode_8c.html#def0567501f3358e0848d7c0e90ec3c8">00157</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#def0567501f3358e0848d7c0e90ec3c8">luaK_dischargejpc</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs)
<a name="l00158"></a>00158         <span class="comment">/*@modifies fs @*/</span>
<a name="l00159"></a>00159 {
<a name="l00160"></a>00160   <a class="code" href="lcode_8c.html#971578c244aae3043ac48d30c113874f">luaK_patchlistaux</a>(fs, fs-&gt;<a class="code" href="structFuncState.html#1f931eab98b3defe8c1948ac18d20644">jpc</a>, fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>);
<a name="l00161"></a>00161   fs-&gt;<a class="code" href="structFuncState.html#1f931eab98b3defe8c1948ac18d20644">jpc</a> = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;
<a name="l00162"></a>00162 }
<a name="l00163"></a>00163 
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="lcode_8h.html#ee2b024b70ad7bbe4fe585910a4f7b29">00165</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#ee2b024b70ad7bbe4fe585910a4f7b29">luaK_patchlist</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> list, <span class="keywordtype">int</span> target) {
<a name="l00166"></a>00166   <span class="keywordflow">if</span> (target == fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>)
<a name="l00167"></a>00167     <a class="code" href="lcode_8c.html#1b7d48d1ccc2de1177ab4ffb476112b9">luaK_patchtohere</a>(fs, list);
<a name="l00168"></a>00168   <span class="keywordflow">else</span> {
<a name="l00169"></a>00169     <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(target &lt; fs-&gt;pc);
<a name="l00170"></a>00170     <a class="code" href="lcode_8c.html#971578c244aae3043ac48d30c113874f">luaK_patchlistaux</a>(fs, list, target, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, target, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, target);
<a name="l00171"></a>00171   }
<a name="l00172"></a>00172 }
<a name="l00173"></a>00173 
<a name="l00174"></a>00174 
<a name="l00175"></a><a class="code" href="lcode_8h.html#1b7d48d1ccc2de1177ab4ffb476112b9">00175</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#1b7d48d1ccc2de1177ab4ffb476112b9">luaK_patchtohere</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> list) {
<a name="l00176"></a>00176   <a class="code" href="lcode_8c.html#79ef791c64cd5f02e5ea7ebbeef61e33">luaK_getlabel</a>(fs);
<a name="l00177"></a>00177   <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;fs-&gt;<a class="code" href="structFuncState.html#1f931eab98b3defe8c1948ac18d20644">jpc</a>, list);
<a name="l00178"></a>00178 }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 
<a name="l00181"></a><a class="code" href="lcode_8h.html#757aee9fd65c61b9a0d04923c95deac3">00181</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> *l1, <span class="keywordtype">int</span> l2) {
<a name="l00182"></a>00182   <span class="keywordflow">if</span> (l2 == <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>) <span class="keywordflow">return</span>;
<a name="l00183"></a>00183   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*l1 == <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>)
<a name="l00184"></a>00184     *l1 = l2;
<a name="l00185"></a>00185   <span class="keywordflow">else</span> {
<a name="l00186"></a>00186     <span class="keywordtype">int</span> list = *l1;
<a name="l00187"></a>00187     <span class="keywordtype">int</span> <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>;
<a name="l00188"></a>00188     <span class="keywordflow">while</span> ((next = <a class="code" href="lcode_8c.html#bc5a5e1a7bf84f40e184bad259eb8a6c">luaK_getjump</a>(fs, list)) != <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>)  <span class="comment">/* find last element */</span>
<a name="l00189"></a>00189       list = next;
<a name="l00190"></a>00190     <a class="code" href="lcode_8c.html#8e3146048cb11984ba0aa0b9dbd71de3">luaK_fixjump</a>(fs, list, l2);
<a name="l00191"></a>00191   }
<a name="l00192"></a>00192 }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194 
<a name="l00195"></a><a class="code" href="lcode_8h.html#77c71807f065ecf66387fad29df1f21a">00195</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#77c71807f065ecf66387fad29df1f21a">luaK_checkstack</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> n) {
<a name="l00196"></a>00196   <span class="keywordtype">int</span> newstack = fs-&gt;<a class="code" href="structFuncState.html#34c3a8e63c22d3f33bb811cb40f295cb">freereg</a> + n;
<a name="l00197"></a>00197   <span class="keywordflow">if</span> (newstack &gt; fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#b281ea4d60679ae1f78bfb0ab46fc386">maxstacksize</a>) {
<a name="l00198"></a>00198     <span class="keywordflow">if</span> (newstack &gt;= <a class="code" href="llimits_8h.html#2aca31367becc56355ff631209b81e92">MAXSTACK</a>)
<a name="l00199"></a>00199       <a class="code" href="llex_8c.html#62dfdc3824855840c7b8ef0161ce973a">luaX_syntaxerror</a>(fs-&gt;<a class="code" href="structFuncState.html#d1376c6bb410926d7c4081d63e682910">ls</a>, <span class="stringliteral">"function or expression too complex"</span>);
<a name="l00200"></a>00200     fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#b281ea4d60679ae1f78bfb0ab46fc386">maxstacksize</a> = <a class="code" href="llimits_8h.html#f469cd45a80dd7d512ca0dff225a99ce">cast</a>(<a class="code" href="llimits_8h.html#64f8b22b40cd3b0d9a7b61d79ae2d98f">lu_byte</a>, newstack);
<a name="l00201"></a>00201   }
<a name="l00202"></a>00202 }
<a name="l00203"></a>00203 
<a name="l00204"></a>00204 
<a name="l00205"></a><a class="code" href="lcode_8h.html#f4b237c64911bef6e109e8c10fd97c6b">00205</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#f4b237c64911bef6e109e8c10fd97c6b">luaK_reserveregs</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> n) {
<a name="l00206"></a>00206   <a class="code" href="lcode_8c.html#77c71807f065ecf66387fad29df1f21a">luaK_checkstack</a>(fs, n);
<a name="l00207"></a>00207   fs-&gt;<a class="code" href="structFuncState.html#34c3a8e63c22d3f33bb811cb40f295cb">freereg</a> += n;
<a name="l00208"></a>00208 }
<a name="l00209"></a>00209 
<a name="l00210"></a>00210 
<a name="l00211"></a><a class="code" href="lcode_8c.html#7dc527688c46a2f3ed0a6aaf32dc7168">00211</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#7dc527688c46a2f3ed0a6aaf32dc7168">freereg</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> reg)
<a name="l00212"></a>00212         <span class="comment">/*@modifies fs @*/</span>
<a name="l00213"></a>00213 {
<a name="l00214"></a>00214   <span class="keywordflow">if</span> (reg &gt;= fs-&gt;<a class="code" href="structFuncState.html#5a192e938fd948980f43ccc3b637db3b">nactvar</a> &amp;&amp; reg &lt; <a class="code" href="llimits_8h.html#2aca31367becc56355ff631209b81e92">MAXSTACK</a>) {
<a name="l00215"></a>00215     fs-&gt;<a class="code" href="structFuncState.html#34c3a8e63c22d3f33bb811cb40f295cb">freereg</a>--;
<a name="l00216"></a>00216     <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(reg == fs-&gt;<a class="code" href="structFuncState.html#34c3a8e63c22d3f33bb811cb40f295cb">freereg</a>);
<a name="l00217"></a>00217   }
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220 
<a name="l00221"></a><a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">00221</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e)
<a name="l00222"></a>00222         <span class="comment">/*@modifies fs @*/</span>
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>)
<a name="l00225"></a>00225     <a class="code" href="lcode_8c.html#7dc527688c46a2f3ed0a6aaf32dc7168">freereg</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00226"></a>00226 }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228 
<a name="l00229"></a><a class="code" href="lcode_8c.html#2429283de65a34530175edfc8cbe927b">00229</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#2429283de65a34530175edfc8cbe927b">addk</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structlua__TObject.html">TObject</a> *k, <a class="code" href="structlua__TObject.html">TObject</a> *v)
<a name="l00230"></a>00230         <span class="comment">/*@modifies fs @*/</span>
<a name="l00231"></a>00231 {
<a name="l00232"></a>00232   <span class="keyword">const</span> <a class="code" href="structlua__TObject.html">TObject</a> *idx = <a class="code" href="ltable_8c.html#09200bed948e4efc8ca8d233b3481cc0">luaH_get</a>(fs-&gt;<a class="code" href="structFuncState.html#743eedcc2e6b7325ff4575cee12dd266">h</a>, k);
<a name="l00233"></a>00233   <span class="keywordflow">if</span> (<a class="code" href="lobject_8h.html#68cb1f4d9b30527dc6736266f463dae1">ttisnumber</a>(idx)) {
<a name="l00234"></a>00234     <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(<a class="code" href="lobject_8c.html#2aad8c91ed030a5ac8a9e8effcce7188">luaO_rawequalObj</a>(&amp;fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#858fef033e8f2c3d5193daea5fb9986c">k</a>[<a class="code" href="llimits_8h.html#f469cd45a80dd7d512ca0dff225a99ce">cast</a>(<span class="keywordtype">int</span>, <a class="code" href="lobject_8h.html#b4014580971546004cd5982d201111c9">nvalue</a>(idx))], v));
<a name="l00235"></a>00235     <span class="keywordflow">return</span> <a class="code" href="llimits_8h.html#f469cd45a80dd7d512ca0dff225a99ce">cast</a>(<span class="keywordtype">int</span>, <a class="code" href="lobject_8h.html#b4014580971546004cd5982d201111c9">nvalue</a>(idx));
<a name="l00236"></a>00236   }
<a name="l00237"></a>00237   <span class="keywordflow">else</span> {  <span class="comment">/* constant not found; create a new entry */</span>
<a name="l00238"></a>00238     <a class="code" href="structProto.html">Proto</a> *f = fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>;
<a name="l00239"></a>00239     <a class="code" href="lmem_8h.html#df13c8c70de65f436d1620269e39382e">luaM_growvector</a>(fs-&gt;<a class="code" href="structFuncState.html#cc8fa751d5a970425f186d6ffe004f6a">L</a>, f-&gt;<a class="code" href="structProto.html#858fef033e8f2c3d5193daea5fb9986c">k</a>, fs-&gt;<a class="code" href="structFuncState.html#8b327d797614ab483d6d9bf1075c1681">nk</a>, f-&gt;<a class="code" href="structProto.html#f6bedfc3d3db5d980b083064cd2daa0b">sizek</a>, <a class="code" href="structlua__TObject.html">TObject</a>,
<a name="l00240"></a>00240                     <a class="code" href="lopcodes_8h.html#85a28f2fc1e6efe4507df90dd1d232af">MAXARG_Bx</a>, <span class="stringliteral">"constant table overflow"</span>);
<a name="l00241"></a>00241     <a class="code" href="lobject_8h.html#888eea997c5ea4d1970154e32994d312">setobj2n</a>(&amp;f-&gt;<a class="code" href="structProto.html#858fef033e8f2c3d5193daea5fb9986c">k</a>[fs-&gt;<a class="code" href="structFuncState.html#8b327d797614ab483d6d9bf1075c1681">nk</a>], v);
<a name="l00242"></a>00242     <a class="code" href="lobject_8h.html#93e2206898108ffb2d6d06d5f0130e91">setnvalue</a>(<a class="code" href="ltable_8c.html#f5ad9bf060df23d1f85629cb0c35a8d2">luaH_set</a>(fs-&gt;<a class="code" href="structFuncState.html#cc8fa751d5a970425f186d6ffe004f6a">L</a>, fs-&gt;<a class="code" href="structFuncState.html#743eedcc2e6b7325ff4575cee12dd266">h</a>, k), <a class="code" href="llimits_8h.html#f469cd45a80dd7d512ca0dff225a99ce">cast</a>(lua_Number, fs-&gt;<a class="code" href="structFuncState.html#8b327d797614ab483d6d9bf1075c1681">nk</a>));
<a name="l00243"></a>00243     <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structFuncState.html#8b327d797614ab483d6d9bf1075c1681">nk</a>++;
<a name="l00244"></a>00244   }
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00247"></a>00247 
<a name="l00248"></a><a class="code" href="lcode_8h.html#c5214800a2b57a6e1a31bb19eb4b3395">00248</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#c5214800a2b57a6e1a31bb19eb4b3395">luaK_stringK</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="unionTString.html">TString</a> *s) {
<a name="l00249"></a>00249   <a class="code" href="structlua__TObject.html">TObject</a> o;
<a name="l00250"></a>00250   <a class="code" href="lobject_8h.html#a5660c8c49a4be5229c26e1c144be813">setsvalue</a>(&amp;o, s);
<a name="l00251"></a>00251   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#2429283de65a34530175edfc8cbe927b">addk</a>(fs, &amp;o, &amp;o);
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 
<a name="l00255"></a><a class="code" href="lcode_8h.html#83eb4c9bdd72a34653c61f987f105110">00255</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#83eb4c9bdd72a34653c61f987f105110">luaK_numberK</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, lua_Number r) {
<a name="l00256"></a>00256   <a class="code" href="structlua__TObject.html">TObject</a> o;
<a name="l00257"></a>00257   <a class="code" href="lobject_8h.html#93e2206898108ffb2d6d06d5f0130e91">setnvalue</a>(&amp;o, r);
<a name="l00258"></a>00258   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#2429283de65a34530175edfc8cbe927b">addk</a>(fs, &amp;o, &amp;o);
<a name="l00259"></a>00259 }
<a name="l00260"></a>00260 
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="lcode_8c.html#f2fc0861ba52782321217b748fbdf499">00262</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#f2fc0861ba52782321217b748fbdf499">nil_constant</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs)
<a name="l00263"></a>00263         <span class="comment">/*@modifies fs @*/</span>
<a name="l00264"></a>00264 {
<a name="l00265"></a>00265   <a class="code" href="structlua__TObject.html">TObject</a> k, v;
<a name="l00266"></a>00266   <a class="code" href="lobject_8h.html#f648493e16661b749b1d1c4611d793dd">setnilvalue</a>(&amp;v);
<a name="l00267"></a>00267   <a class="code" href="lobject_8h.html#f29567f303a0ecb4e29ff0debec071b6">sethvalue</a>(&amp;k, fs-&gt;<a class="code" href="structFuncState.html#743eedcc2e6b7325ff4575cee12dd266">h</a>);  <span class="comment">/* cannot use nil as key; instead use table itself */</span>
<a name="l00268"></a>00268   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#2429283de65a34530175edfc8cbe927b">addk</a>(fs, &amp;k, &amp;v);
<a name="l00269"></a>00269 }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271 
<a name="l00272"></a><a class="code" href="lcode_8h.html#c83fa2e2e20245bb4f77f9f9c9048260">00272</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#5f7128346dd46b4d976f04ace956acad">luaK_setcallreturns</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e, <span class="keywordtype">int</span> nresults) {
<a name="l00273"></a>00273   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36585500c09ed0cd78fd58ea0393f699801">VCALL</a>) {  <span class="comment">/* expression is an open function call? */</span>
<a name="l00274"></a>00274     <a class="code" href="lopcodes_8h.html#a49102d375e58785a2ecef0f89b8af49">SETARG_C</a>(<a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e), nresults+1);
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (nresults == 1) {  <span class="comment">/* `regular' expression? */</span>
<a name="l00276"></a>00276       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>;
<a name="l00277"></a>00277       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lopcodes_8h.html#1b6535ddc0b6ed588de8cc2a1096cc84">GETARG_A</a>(<a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e));
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279   }
<a name="l00280"></a>00280 }
<a name="l00281"></a>00281 
<a name="l00282"></a>00282 
<a name="l00283"></a><a class="code" href="lcode_8h.html#188d8cd72c3cf299964c8c25d7ed1636">00283</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00284"></a>00284   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00285"></a>00285     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3657c10242c81862cb07becbb59361ec5d3">VLOCAL</a>: {
<a name="l00286"></a>00286       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>;
<a name="l00287"></a>00287       <span class="keywordflow">break</span>;
<a name="l00288"></a>00288     }
<a name="l00289"></a>00289     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3657e4c12de0487705bdbd560c5da79f93e">VUPVAL</a>: {
<a name="l00290"></a>00290       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f80c96592c1ab5bb60e10eb42eb6e435aa">OP_GETUPVAL</a>, 0, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, 0);
<a name="l00291"></a>00291       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00292"></a>00292       <span class="keywordflow">break</span>;
<a name="l00293"></a>00293     }
<a name="l00294"></a>00294     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365d49e8bc7b1038d398333814c66cff8ed">VGLOBAL</a>: {
<a name="l00295"></a>00295       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#f65b8b50684bdb36f8315e452f8262c0">luaK_codeABx</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f88f4a1f0944efde71d0f95f29693808b2">OP_GETGLOBAL</a>, 0, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00296"></a>00296       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00297"></a>00297       <span class="keywordflow">break</span>;
<a name="l00298"></a>00298     }
<a name="l00299"></a>00299     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3653fe06ae89e406efc66f506f78de14880">VINDEXED</a>: {
<a name="l00300"></a>00300       <a class="code" href="lcode_8c.html#7dc527688c46a2f3ed0a6aaf32dc7168">freereg</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a>);
<a name="l00301"></a>00301       <a class="code" href="lcode_8c.html#7dc527688c46a2f3ed0a6aaf32dc7168">freereg</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00302"></a>00302       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f806aba2f78387b3f823f0cfc425ba473e">OP_GETTABLE</a>, 0, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, e-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a>);
<a name="l00303"></a>00303       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00304"></a>00304       <span class="keywordflow">break</span>;
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36585500c09ed0cd78fd58ea0393f699801">VCALL</a>: {
<a name="l00307"></a>00307       <a class="code" href="lcode_8c.html#5f7128346dd46b4d976f04ace956acad">luaK_setcallreturns</a>(fs, e, 1);
<a name="l00308"></a>00308       <span class="keywordflow">break</span>;
<a name="l00309"></a>00309     }
<a name="l00310"></a>00310     <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;  <span class="comment">/* there is one value available (somewhere) */</span>
<a name="l00311"></a>00311   }
<a name="l00312"></a>00312 }
<a name="l00313"></a>00313 
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="lcode_8c.html#7354e88ad5ba6fa0b748807c4a237406">00315</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#7354e88ad5ba6fa0b748807c4a237406">code_label</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> A, <span class="keywordtype">int</span> b, <span class="keywordtype">int</span> jump)
<a name="l00316"></a>00316         <span class="comment">/*@modifies fs @*/</span>
<a name="l00317"></a>00317 {
<a name="l00318"></a>00318   <a class="code" href="lcode_8c.html#79ef791c64cd5f02e5ea7ebbeef61e33">luaK_getlabel</a>(fs);  <span class="comment">/* those instructions may be jump targets */</span>
<a name="l00319"></a>00319   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8f01c42e5508fdf39a4968d8c8deb0e09">OP_LOADBOOL</a>, A, b, jump);
<a name="l00320"></a>00320 }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 
<a name="l00323"></a><a class="code" href="lcode_8c.html#8552ea44a0601babed528d5c824d4f65">00323</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#8552ea44a0601babed528d5c824d4f65">discharge2reg</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e, <span class="keywordtype">int</span> reg)
<a name="l00324"></a>00324         <span class="comment">/*@modifies fs, e @*/</span>
<a name="l00325"></a>00325 {
<a name="l00326"></a>00326   <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00327"></a>00327   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00328"></a>00328     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365225f5542d71d86a5bf7ec9d1ee0d416b">VNIL</a>: {
<a name="l00329"></a>00329       <a class="code" href="lcode_8c.html#f0e44c83f5033198066e7f658f7e39ea">luaK_nil</a>(fs, reg, 1);
<a name="l00330"></a>00330       <span class="keywordflow">break</span>;
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36516c77a001b2e595f45e2ecaa72986582">VFALSE</a>:  <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3650d12eaf8ce871d39014851e42fc9cc6d">VTRUE</a>: {
<a name="l00333"></a>00333       <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8f01c42e5508fdf39a4968d8c8deb0e09">OP_LOADBOOL</a>, reg, e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3650d12eaf8ce871d39014851e42fc9cc6d">VTRUE</a>, 0);
<a name="l00334"></a>00334       <span class="keywordflow">break</span>;
<a name="l00335"></a>00335     }
<a name="l00336"></a>00336     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36513f719512f86d353f14cc37c782205f6">VK</a>: {
<a name="l00337"></a>00337       <a class="code" href="lcode_8c.html#f65b8b50684bdb36f8315e452f8262c0">luaK_codeABx</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f821061309b8ce575e20d51138d725a0b1">OP_LOADK</a>, reg, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00338"></a>00338       <span class="keywordflow">break</span>;
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>: {
<a name="l00341"></a>00341       <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *pc = &amp;<a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e);
<a name="l00342"></a>00342       <a class="code" href="lopcodes_8h.html#29c64cfcdafe9108e9e918f77bc59170">SETARG_A</a>(*pc, reg);
<a name="l00343"></a>00343       <span class="keywordflow">break</span>;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>: {
<a name="l00346"></a>00346       <span class="keywordflow">if</span> (reg != e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>)
<a name="l00347"></a>00347         <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f89a45e5b03f75222f95232ad9d96ec252">OP_MOVE</a>, reg, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, 0);
<a name="l00348"></a>00348       <span class="keywordflow">break</span>;
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350     <span class="keywordflow">default</span>: {
<a name="l00351"></a>00351       <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365071b80e3ffdc8174d6b7b61f584a41ef">VVOID</a> || e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>);
<a name="l00352"></a>00352       <span class="keywordflow">return</span>;  <span class="comment">/* nothing to do... */</span>
<a name="l00353"></a>00353     }
<a name="l00354"></a>00354   }
<a name="l00355"></a>00355   e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = reg;
<a name="l00356"></a>00356   e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359 
<a name="l00360"></a><a class="code" href="lcode_8c.html#549cf78d0a27d762374cb0342f2e9cf1">00360</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#549cf78d0a27d762374cb0342f2e9cf1">discharge2anyreg</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e)
<a name="l00361"></a>00361         <span class="comment">/*@modifies fs, e @*/</span>
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> != <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>) {
<a name="l00364"></a>00364     <a class="code" href="lcode_8c.html#f4b237c64911bef6e109e8c10fd97c6b">luaK_reserveregs</a>(fs, 1);
<a name="l00365"></a>00365     <a class="code" href="lcode_8c.html#8552ea44a0601babed528d5c824d4f65">discharge2reg</a>(fs, e, fs-&gt;freereg-1);
<a name="l00366"></a>00366   }
<a name="l00367"></a>00367 }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369 
<a name="l00370"></a><a class="code" href="lcode_8c.html#432e17a892593852f89f83c5cf1f7c50">00370</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#432e17a892593852f89f83c5cf1f7c50">luaK_exp2reg</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e, <span class="keywordtype">int</span> reg)
<a name="l00371"></a>00371         <span class="comment">/*@modifies fs, e @*/</span>
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373   <a class="code" href="lcode_8c.html#8552ea44a0601babed528d5c824d4f65">discharge2reg</a>(fs, e, reg);
<a name="l00374"></a>00374   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>)
<a name="l00375"></a>00375     <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);  <span class="comment">/* put this jump in `t' list */</span>
<a name="l00376"></a>00376   <span class="keywordflow">if</span> (<a class="code" href="lcode_8c.html#cb0d3e4e01f0054b0de12e221aaea6e6">hasjumps</a>(e)) {
<a name="l00377"></a>00377     <span class="keywordtype">int</span> <span class="keyword">final</span>;  <span class="comment">/* position after whole expression */</span>
<a name="l00378"></a>00378     <span class="keywordtype">int</span> p_f = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;  <span class="comment">/* position of an eventual LOAD false */</span>
<a name="l00379"></a>00379     <span class="keywordtype">int</span> p_t = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;  <span class="comment">/* position of an eventual LOAD true */</span>
<a name="l00380"></a>00380     <span class="keywordflow">if</span> (<a class="code" href="lcode_8c.html#d34a2d53e7c571b0f606862e0192914a">need_value</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>, 1) || <a class="code" href="lcode_8c.html#d34a2d53e7c571b0f606862e0192914a">need_value</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>, 0)) {
<a name="l00381"></a>00381       <span class="keywordtype">int</span> fj = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;  <span class="comment">/* first jump (over LOAD ops.) */</span>
<a name="l00382"></a>00382       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> != <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>)
<a name="l00383"></a>00383         fj = <a class="code" href="lcode_8c.html#4fa57ffd18a3767fd22f642d9bd11ba6">luaK_jump</a>(fs);
<a name="l00384"></a>00384       p_f = <a class="code" href="lcode_8c.html#7354e88ad5ba6fa0b748807c4a237406">code_label</a>(fs, reg, 0, 1);
<a name="l00385"></a>00385       p_t = <a class="code" href="lcode_8c.html#7354e88ad5ba6fa0b748807c4a237406">code_label</a>(fs, reg, 1, 0);
<a name="l00386"></a>00386       <a class="code" href="lcode_8c.html#1b7d48d1ccc2de1177ab4ffb476112b9">luaK_patchtohere</a>(fs, fj);
<a name="l00387"></a>00387     }
<a name="l00388"></a>00388     <span class="keyword">final</span> = <a class="code" href="lcode_8c.html#79ef791c64cd5f02e5ea7ebbeef61e33">luaK_getlabel</a>(fs);
<a name="l00389"></a>00389     <a class="code" href="lcode_8c.html#971578c244aae3043ac48d30c113874f">luaK_patchlistaux</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>, p_f, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, <span class="keyword">final</span>, reg, p_f);
<a name="l00390"></a>00390     <a class="code" href="lcode_8c.html#971578c244aae3043ac48d30c113874f">luaK_patchlistaux</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>, <span class="keyword">final</span>, reg, p_t, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, p_t);
<a name="l00391"></a>00391   }
<a name="l00392"></a>00392   e-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a> = e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a> = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;
<a name="l00393"></a>00393   e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = reg;
<a name="l00394"></a>00394   e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>;
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="lcode_8h.html#5e02efe4cc69aa02684085528919438b">00398</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#5e02efe4cc69aa02684085528919438b">luaK_exp2nextreg</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00399"></a>00399   <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00400"></a>00400   <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e);
<a name="l00401"></a>00401   <a class="code" href="lcode_8c.html#f4b237c64911bef6e109e8c10fd97c6b">luaK_reserveregs</a>(fs, 1);
<a name="l00402"></a>00402   <a class="code" href="lcode_8c.html#432e17a892593852f89f83c5cf1f7c50">luaK_exp2reg</a>(fs, e, fs-&gt;<a class="code" href="structFuncState.html#34c3a8e63c22d3f33bb811cb40f295cb">freereg</a> - 1);
<a name="l00403"></a>00403 }
<a name="l00404"></a>00404 
<a name="l00405"></a>00405 
<a name="l00406"></a><a class="code" href="lcode_8h.html#ed5c2ccba082b20af53448ba4ccf453b">00406</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00407"></a>00407   <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00408"></a>00408   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>) {
<a name="l00409"></a>00409     <span class="keywordflow">if</span> (!<a class="code" href="lcode_8c.html#cb0d3e4e01f0054b0de12e221aaea6e6">hasjumps</a>(e)) <span class="keywordflow">return</span> e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>;  <span class="comment">/* exp is already in a register */</span> 
<a name="l00410"></a>00410     <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> &gt;= fs-&gt;<a class="code" href="structFuncState.html#5a192e938fd948980f43ccc3b637db3b">nactvar</a>) {  <span class="comment">/* reg. is not a local? */</span>
<a name="l00411"></a>00411       <a class="code" href="lcode_8c.html#432e17a892593852f89f83c5cf1f7c50">luaK_exp2reg</a>(fs, e, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);  <span class="comment">/* put value on it */</span>
<a name="l00412"></a>00412       <span class="keywordflow">return</span> e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>;
<a name="l00413"></a>00413     }
<a name="l00414"></a>00414   }
<a name="l00415"></a>00415   <a class="code" href="lcode_8c.html#5e02efe4cc69aa02684085528919438b">luaK_exp2nextreg</a>(fs, e);  <span class="comment">/* default */</span>
<a name="l00416"></a>00416   <span class="keywordflow">return</span> e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>;
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 
<a name="l00420"></a><a class="code" href="lcode_8h.html#12e4478b15a9c2276fba35d117471315">00420</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#12e4478b15a9c2276fba35d117471315">luaK_exp2val</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00421"></a>00421   <span class="keywordflow">if</span> (<a class="code" href="lcode_8c.html#cb0d3e4e01f0054b0de12e221aaea6e6">hasjumps</a>(e))
<a name="l00422"></a>00422     <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a>(fs, e);
<a name="l00423"></a>00423   <span class="keywordflow">else</span>
<a name="l00424"></a>00424     <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427 
<a name="l00428"></a><a class="code" href="lcode_8h.html#ac42ad04e45afd23b5043c1ce4e87724">00428</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00429"></a>00429   <a class="code" href="lcode_8c.html#12e4478b15a9c2276fba35d117471315">luaK_exp2val</a>(fs, e);
<a name="l00430"></a>00430   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00431"></a>00431     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365225f5542d71d86a5bf7ec9d1ee0d416b">VNIL</a>: {
<a name="l00432"></a>00432       <span class="keywordflow">if</span> (fs-&gt;<a class="code" href="structFuncState.html#8b327d797614ab483d6d9bf1075c1681">nk</a> + <a class="code" href="llimits_8h.html#2aca31367becc56355ff631209b81e92">MAXSTACK</a> &lt;= <a class="code" href="lopcodes_8h.html#afb2f05be47bc350dbb7d688e0dc5d44">MAXARG_C</a>) {  <span class="comment">/* constant fit in argC? */</span>
<a name="l00433"></a>00433         e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#f2fc0861ba52782321217b748fbdf499">nil_constant</a>(fs);
<a name="l00434"></a>00434         e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36513f719512f86d353f14cc37c782205f6">VK</a>;
<a name="l00435"></a>00435         <span class="keywordflow">return</span> e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> + <a class="code" href="llimits_8h.html#2aca31367becc56355ff631209b81e92">MAXSTACK</a>;
<a name="l00436"></a>00436       }
<a name="l00437"></a>00437       <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l00438"></a>00438     }
<a name="l00439"></a>00439     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36513f719512f86d353f14cc37c782205f6">VK</a>: {
<a name="l00440"></a>00440       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> + <a class="code" href="llimits_8h.html#2aca31367becc56355ff631209b81e92">MAXSTACK</a> &lt;= <a class="code" href="lopcodes_8h.html#afb2f05be47bc350dbb7d688e0dc5d44">MAXARG_C</a>)  <span class="comment">/* constant fit in argC? */</span>
<a name="l00441"></a>00441         <span class="keywordflow">return</span> e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> + <a class="code" href="llimits_8h.html#2aca31367becc56355ff631209b81e92">MAXSTACK</a>;
<a name="l00442"></a>00442       <span class="keywordflow">else</span> <span class="keywordflow">break</span>;
<a name="l00443"></a>00443     }
<a name="l00444"></a>00444     <span class="keywordflow">default</span>: <span class="keywordflow">break</span>;
<a name="l00445"></a>00445   }
<a name="l00446"></a>00446   <span class="comment">/* not a constant in the right range: put it in a register */</span>
<a name="l00447"></a>00447   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a>(fs, e);
<a name="l00448"></a>00448 }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450 
<a name="l00451"></a><a class="code" href="lcode_8h.html#7c3c2671eeaa65d56ae4f404f3488dd8">00451</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#e8f56eb819dc07c039e9e6975ccc800f">luaK_storevar</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *var, <a class="code" href="structexpdesc.html">expdesc</a> *exp) {
<a name="l00452"></a>00452   <span class="keywordflow">switch</span> (var-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00453"></a>00453     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3657c10242c81862cb07becbb59361ec5d3">VLOCAL</a>: {
<a name="l00454"></a>00454       <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, exp);
<a name="l00455"></a>00455       <a class="code" href="lcode_8c.html#432e17a892593852f89f83c5cf1f7c50">luaK_exp2reg</a>(fs, exp, var-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00456"></a>00456       <span class="keywordflow">return</span>;
<a name="l00457"></a>00457     }
<a name="l00458"></a>00458     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3657e4c12de0487705bdbd560c5da79f93e">VUPVAL</a>: {
<a name="l00459"></a>00459       <span class="keywordtype">int</span> e = <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a>(fs, exp);
<a name="l00460"></a>00460       <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8e379a7c92e7e53cb806754789158d443">OP_SETUPVAL</a>, e, var-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, 0);
<a name="l00461"></a>00461       <span class="keywordflow">break</span>;
<a name="l00462"></a>00462     }
<a name="l00463"></a>00463     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365d49e8bc7b1038d398333814c66cff8ed">VGLOBAL</a>: {
<a name="l00464"></a>00464       <span class="keywordtype">int</span> e = <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a>(fs, exp);
<a name="l00465"></a>00465       <a class="code" href="lcode_8c.html#f65b8b50684bdb36f8315e452f8262c0">luaK_codeABx</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8136b7248bd6ca204f865aacf56fc3147">OP_SETGLOBAL</a>, e, var-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00466"></a>00466       <span class="keywordflow">break</span>;
<a name="l00467"></a>00467     }
<a name="l00468"></a>00468     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3653fe06ae89e406efc66f506f78de14880">VINDEXED</a>: {
<a name="l00469"></a>00469       <span class="keywordtype">int</span> e = <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a>(fs, exp);
<a name="l00470"></a>00470       <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8dca08b0d0f5d427b9457702d1b1e28ae">OP_SETTABLE</a>, var-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, var-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a>, e);
<a name="l00471"></a>00471       <span class="keywordflow">break</span>;
<a name="l00472"></a>00472     }
<a name="l00473"></a>00473     <span class="keywordflow">default</span>: {
<a name="l00474"></a>00474       <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(0);  <span class="comment">/* invalid var kind to store */</span>
<a name="l00475"></a>00475       <span class="keywordflow">break</span>;
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477   }
<a name="l00478"></a>00478   <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, exp);
<a name="l00479"></a>00479 }
<a name="l00480"></a>00480 
<a name="l00481"></a>00481 
<a name="l00482"></a><a class="code" href="lcode_8h.html#b88e15c011fe033c2c2ddd9b803eb624">00482</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#b88e15c011fe033c2c2ddd9b803eb624">luaK_self</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e, <a class="code" href="structexpdesc.html">expdesc</a> *key) {
<a name="l00483"></a>00483   <span class="keywordtype">int</span> <a class="code" href="structCCallS.html#34f5cf3060576756c425f45b4d23b6d3">func</a>;
<a name="l00484"></a>00484   <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a>(fs, e);
<a name="l00485"></a>00485   <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e);
<a name="l00486"></a>00486   func = fs-&gt;<a class="code" href="structFuncState.html#34c3a8e63c22d3f33bb811cb40f295cb">freereg</a>;
<a name="l00487"></a>00487   <a class="code" href="lcode_8c.html#f4b237c64911bef6e109e8c10fd97c6b">luaK_reserveregs</a>(fs, 2);
<a name="l00488"></a>00488   <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8c10dc9bf02f0908196ac866c123d1e65">OP_SELF</a>, func, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a>(fs, key));
<a name="l00489"></a>00489   <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, key);
<a name="l00490"></a>00490   e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = func;
<a name="l00491"></a>00491   e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>;
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494 
<a name="l00495"></a><a class="code" href="lcode_8c.html#3a49ce0ab441f6265c774c9b79532ca2">00495</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#3a49ce0ab441f6265c774c9b79532ca2">invertjump</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e)
<a name="l00496"></a>00496         <span class="comment">/*@*/</span>
<a name="l00497"></a>00497 {
<a name="l00498"></a>00498   <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> *pc = <a class="code" href="lcode_8c.html#e84e7399c953ec6a734375734374ed0f">getjumpcontrol</a>(fs, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00499"></a>00499   <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(<a class="code" href="lopcodes_8h.html#c70d94d3e14fbbc708860491f31c7e5c">testOpMode</a>(<a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(*pc), <a class="code" href="lopcodes_8h.html#c5548e9f891d0c31fc9012defc845a3e01d185fe863d283be4b4d44c6bc26da4">OpModeT</a>) &amp;&amp;
<a name="l00500"></a>00500              <a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(*pc) != <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8d9053c66a926eca03e88f98ed50bb509">OP_TEST</a>);
<a name="l00501"></a>00501   <a class="code" href="lopcodes_8h.html#29c64cfcdafe9108e9e918f77bc59170">SETARG_A</a>(*pc, !(<a class="code" href="lopcodes_8h.html#1b6535ddc0b6ed588de8cc2a1096cc84">GETARG_A</a>(*pc)));
<a name="l00502"></a>00502 }
<a name="l00503"></a>00503 
<a name="l00504"></a>00504 
<a name="l00505"></a><a class="code" href="lcode_8c.html#28fac2114b69397d42683bab4997543a">00505</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#28fac2114b69397d42683bab4997543a">jumponcond</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e, <span class="keywordtype">int</span> <a class="code" href="lparser_8c.html#c6430a9ba53b3f58401a2f61530597f9">cond</a>)
<a name="l00506"></a>00506         <span class="comment">/*@modifies fs, e @*/</span>
<a name="l00507"></a>00507 {
<a name="l00508"></a>00508   <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>) {
<a name="l00509"></a>00509     <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> ie = <a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e);
<a name="l00510"></a>00510     <span class="keywordflow">if</span> (<a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(ie) == <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8791ea6ce16f68048afc8b53d514f33e3">OP_NOT</a>) {
<a name="l00511"></a>00511       fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>--;  <span class="comment">/* remove previous OP_NOT */</span>
<a name="l00512"></a>00512       <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#8a7476adf622d981388a578fb352319c">luaK_condjump</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8d9053c66a926eca03e88f98ed50bb509">OP_TEST</a>, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, <a class="code" href="lopcodes_8h.html#59d1e6aadb0052fa6edc4c9500f88c3f">GETARG_B</a>(ie), !cond);
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     <span class="comment">/* else go through */</span>
<a name="l00515"></a>00515   }
<a name="l00516"></a>00516   <a class="code" href="lcode_8c.html#549cf78d0a27d762374cb0342f2e9cf1">discharge2anyreg</a>(fs, e);
<a name="l00517"></a>00517   <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e);
<a name="l00518"></a>00518   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#8a7476adf622d981388a578fb352319c">luaK_condjump</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8d9053c66a926eca03e88f98ed50bb509">OP_TEST</a>, <a class="code" href="lopcodes_8h.html#5610d5d48ea307983e900b439933b25b">NO_REG</a>, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, cond);
<a name="l00519"></a>00519 }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521 
<a name="l00522"></a><a class="code" href="lcode_8h.html#c0fccff31fa801744eac812f5e1e7388">00522</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#c0fccff31fa801744eac812f5e1e7388">luaK_goiftrue</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00523"></a>00523   <span class="keywordtype">int</span> pc;  <span class="comment">/* pc of last jump */</span>
<a name="l00524"></a>00524   <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00525"></a>00525   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00526"></a>00526     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36513f719512f86d353f14cc37c782205f6">VK</a>: <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3650d12eaf8ce871d39014851e42fc9cc6d">VTRUE</a>: {
<a name="l00527"></a>00527       pc = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;  <span class="comment">/* always true; do nothing */</span>
<a name="l00528"></a>00528       <span class="keywordflow">break</span>;
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36516c77a001b2e595f45e2ecaa72986582">VFALSE</a>: {
<a name="l00531"></a>00531       pc = <a class="code" href="lcode_8c.html#4fa57ffd18a3767fd22f642d9bd11ba6">luaK_jump</a>(fs);  <span class="comment">/* always jump */</span>
<a name="l00532"></a>00532       <span class="keywordflow">break</span>;
<a name="l00533"></a>00533     }
<a name="l00534"></a>00534     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>: {
<a name="l00535"></a>00535       <a class="code" href="lcode_8c.html#3a49ce0ab441f6265c774c9b79532ca2">invertjump</a>(fs, e);
<a name="l00536"></a>00536       pc = e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>;
<a name="l00537"></a>00537       <span class="keywordflow">break</span>;
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     <span class="keywordflow">default</span>: {
<a name="l00540"></a>00540       pc = <a class="code" href="lcode_8c.html#28fac2114b69397d42683bab4997543a">jumponcond</a>(fs, e, 0);
<a name="l00541"></a>00541       <span class="keywordflow">break</span>;
<a name="l00542"></a>00542     }
<a name="l00543"></a>00543   }
<a name="l00544"></a>00544   <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;e-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>, pc);  <span class="comment">/* insert last jump in `f' list */</span>
<a name="l00545"></a>00545 }
<a name="l00546"></a>00546 
<a name="l00547"></a>00547 
<a name="l00548"></a><a class="code" href="lcode_8h.html#dc1ff8fcddb99bd9f62ff08e5cb7740f">00548</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#dc1ff8fcddb99bd9f62ff08e5cb7740f">luaK_goiffalse</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00549"></a>00549   <span class="keywordtype">int</span> pc;  <span class="comment">/* pc of last jump */</span>
<a name="l00550"></a>00550   <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00551"></a>00551   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00552"></a>00552     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365225f5542d71d86a5bf7ec9d1ee0d416b">VNIL</a>: <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36516c77a001b2e595f45e2ecaa72986582">VFALSE</a>: {
<a name="l00553"></a>00553       pc = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;  <span class="comment">/* always false; do nothing */</span>
<a name="l00554"></a>00554       <span class="keywordflow">break</span>;
<a name="l00555"></a>00555     }
<a name="l00556"></a>00556     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3650d12eaf8ce871d39014851e42fc9cc6d">VTRUE</a>: {
<a name="l00557"></a>00557       pc = <a class="code" href="lcode_8c.html#4fa57ffd18a3767fd22f642d9bd11ba6">luaK_jump</a>(fs);  <span class="comment">/* always jump */</span>
<a name="l00558"></a>00558       <span class="keywordflow">break</span>;
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>: {
<a name="l00561"></a>00561       pc = e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>;
<a name="l00562"></a>00562       <span class="keywordflow">break</span>;
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     <span class="keywordflow">default</span>: {
<a name="l00565"></a>00565       pc = <a class="code" href="lcode_8c.html#28fac2114b69397d42683bab4997543a">jumponcond</a>(fs, e, 1);
<a name="l00566"></a>00566       <span class="keywordflow">break</span>;
<a name="l00567"></a>00567     }
<a name="l00568"></a>00568   }
<a name="l00569"></a>00569   <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>, pc);  <span class="comment">/* insert last jump in `t' list */</span>
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00572"></a>00572 
<a name="l00573"></a><a class="code" href="lcode_8c.html#4a5aec1dc507a42523c825036949d966">00573</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#4a5aec1dc507a42523c825036949d966">codenot</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *e)
<a name="l00574"></a>00574         <span class="comment">/*@modifies fs, e @*/</span>
<a name="l00575"></a>00575 {
<a name="l00576"></a>00576   <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e);
<a name="l00577"></a>00577   <span class="keywordflow">switch</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>) {
<a name="l00578"></a>00578     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365225f5542d71d86a5bf7ec9d1ee0d416b">VNIL</a>: <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36516c77a001b2e595f45e2ecaa72986582">VFALSE</a>: {
<a name="l00579"></a>00579       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3650d12eaf8ce871d39014851e42fc9cc6d">VTRUE</a>;
<a name="l00580"></a>00580       <span class="keywordflow">break</span>;
<a name="l00581"></a>00581     }
<a name="l00582"></a>00582     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36513f719512f86d353f14cc37c782205f6">VK</a>: <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3650d12eaf8ce871d39014851e42fc9cc6d">VTRUE</a>: {
<a name="l00583"></a>00583       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36516c77a001b2e595f45e2ecaa72986582">VFALSE</a>;
<a name="l00584"></a>00584       <span class="keywordflow">break</span>;
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>: {
<a name="l00587"></a>00587       <a class="code" href="lcode_8c.html#3a49ce0ab441f6265c774c9b79532ca2">invertjump</a>(fs, e);
<a name="l00588"></a>00588       <span class="keywordflow">break</span>;
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>:
<a name="l00591"></a>00591     <span class="keywordflow">case</span> <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36570a5d7bac7d62d969db4ba478dba9247">VNONRELOC</a>: {
<a name="l00592"></a>00592       <a class="code" href="lcode_8c.html#549cf78d0a27d762374cb0342f2e9cf1">discharge2anyreg</a>(fs, e);
<a name="l00593"></a>00593       <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e);
<a name="l00594"></a>00594       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8791ea6ce16f68048afc8b53d514f33e3">OP_NOT</a>, 0, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, 0);
<a name="l00595"></a>00595       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00596"></a>00596       <span class="keywordflow">break</span>;
<a name="l00597"></a>00597     }
<a name="l00598"></a>00598     <span class="keywordflow">default</span>: {
<a name="l00599"></a>00599       <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(0);  <span class="comment">/* cannot happen */</span>
<a name="l00600"></a>00600       <span class="keywordflow">break</span>;
<a name="l00601"></a>00601     }
<a name="l00602"></a>00602   }
<a name="l00603"></a>00603   <span class="comment">/* interchange true and false lists */</span>
<a name="l00604"></a>00604   { <span class="keywordtype">int</span> temp = e-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>; e-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a> = e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>; e-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a> = temp; }
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607 
<a name="l00608"></a><a class="code" href="lcode_8h.html#3242d93e779d620ec96335068796639e">00608</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#3242d93e779d620ec96335068796639e">luaK_indexed</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *t, <a class="code" href="structexpdesc.html">expdesc</a> *k) {
<a name="l00609"></a>00609   t-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a> = <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a>(fs, k);
<a name="l00610"></a>00610   t-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d3653fe06ae89e406efc66f506f78de14880">VINDEXED</a>;
<a name="l00611"></a>00611 }
<a name="l00612"></a>00612 
<a name="l00613"></a>00613 
<a name="l00614"></a><a class="code" href="lcode_8h.html#40598aa64800d88726015d49ac7fe31d">00614</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#dd831afb5b9e2c2c883405d73f019591">luaK_prefix</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="lcode_8h.html#fb25d5cce16d23cbb1137188f550fe64">UnOpr</a> op, <a class="code" href="structexpdesc.html">expdesc</a> *e) {
<a name="l00615"></a>00615   <span class="keywordflow">if</span> (op == <a class="code" href="lcode_8h.html#fb25d5cce16d23cbb1137188f550fe64c8c2978420d269f0310e922b26f3a406">OPR_MINUS</a>) {
<a name="l00616"></a>00616     <a class="code" href="lcode_8c.html#12e4478b15a9c2276fba35d117471315">luaK_exp2val</a>(fs, e);
<a name="l00617"></a>00617     <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d36513f719512f86d353f14cc37c782205f6">VK</a> &amp;&amp; <a class="code" href="lobject_8h.html#68cb1f4d9b30527dc6736266f463dae1">ttisnumber</a>(&amp;fs-&gt;f-&gt;k[e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>]))
<a name="l00618"></a>00618       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#83eb4c9bdd72a34653c61f987f105110">luaK_numberK</a>(fs, -<a class="code" href="lobject_8h.html#b4014580971546004cd5982d201111c9">nvalue</a>(&amp;fs-&gt;f-&gt;k[e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>]));
<a name="l00619"></a>00619     <span class="keywordflow">else</span> {
<a name="l00620"></a>00620       <a class="code" href="lcode_8c.html#ed5c2ccba082b20af53448ba4ccf453b">luaK_exp2anyreg</a>(fs, e);
<a name="l00621"></a>00621       <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e);
<a name="l00622"></a>00622       e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f82c2f544d4244358e6b092d7b99dec0f2">OP_UNM</a>, 0, e-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, 0);
<a name="l00623"></a>00623       e-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00624"></a>00624     }
<a name="l00625"></a>00625   }
<a name="l00626"></a>00626   <span class="keywordflow">else</span>  <span class="comment">/* op == NOT */</span>
<a name="l00627"></a>00627     <a class="code" href="lcode_8c.html#4a5aec1dc507a42523c825036949d966">codenot</a>(fs, e);
<a name="l00628"></a>00628 }
<a name="l00629"></a>00629 
<a name="l00630"></a>00630 
<a name="l00631"></a><a class="code" href="lcode_8h.html#a8654f61954b965a50f7b0a55b8275e1">00631</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#a8654f61954b965a50f7b0a55b8275e1">luaK_infix</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9">BinOpr</a> op, <a class="code" href="structexpdesc.html">expdesc</a> *v) {
<a name="l00632"></a>00632   <span class="keywordflow">switch</span> (op) {
<a name="l00633"></a>00633     <span class="keywordflow">case</span> <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9a547faae3b92a64f28de201de566bfb7">OPR_AND</a>: {
<a name="l00634"></a>00634       <a class="code" href="lcode_8c.html#c0fccff31fa801744eac812f5e1e7388">luaK_goiftrue</a>(fs, v);
<a name="l00635"></a>00635       <a class="code" href="lcode_8c.html#1b7d48d1ccc2de1177ab4ffb476112b9">luaK_patchtohere</a>(fs, v-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>);
<a name="l00636"></a>00636       v-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a> = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;
<a name="l00637"></a>00637       <span class="keywordflow">break</span>;
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639     <span class="keywordflow">case</span> <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9234ab68698aa8abd114516b8b766932f">OPR_OR</a>: {
<a name="l00640"></a>00640       <a class="code" href="lcode_8c.html#dc1ff8fcddb99bd9f62ff08e5cb7740f">luaK_goiffalse</a>(fs, v);
<a name="l00641"></a>00641       <a class="code" href="lcode_8c.html#1b7d48d1ccc2de1177ab4ffb476112b9">luaK_patchtohere</a>(fs, v-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>);
<a name="l00642"></a>00642       v-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a> = <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>;
<a name="l00643"></a>00643       <span class="keywordflow">break</span>;
<a name="l00644"></a>00644     }
<a name="l00645"></a>00645     <span class="keywordflow">case</span> <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe996cb08140a18930f5fbf2d9903edb5b8">OPR_CONCAT</a>: {
<a name="l00646"></a>00646       <a class="code" href="lcode_8c.html#5e02efe4cc69aa02684085528919438b">luaK_exp2nextreg</a>(fs, v);  <span class="comment">/* operand must be on the `stack' */</span>
<a name="l00647"></a>00647       <span class="keywordflow">break</span>;
<a name="l00648"></a>00648     }
<a name="l00649"></a>00649     <span class="keywordflow">default</span>: {
<a name="l00650"></a>00650       <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a>(fs, v);
<a name="l00651"></a>00651       <span class="keywordflow">break</span>;
<a name="l00652"></a>00652     }
<a name="l00653"></a>00653   }
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a>00656 
<a name="l00657"></a><a class="code" href="lcode_8c.html#abaadad9ddeaebadd1aba701e1ca347c">00657</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#abaadad9ddeaebadd1aba701e1ca347c">codebinop</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="structexpdesc.html">expdesc</a> *res, <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9">BinOpr</a> op,
<a name="l00658"></a>00658                        <span class="keywordtype">int</span> o1, <span class="keywordtype">int</span> o2)
<a name="l00659"></a>00659         <span class="comment">/*@modifies fs, res @*/</span>
<a name="l00660"></a>00660 {
<a name="l00661"></a>00661   <span class="keywordflow">if</span> (op &lt;= <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe97e2f5bf3cf3b7e1350d378bc8c4d023c">OPR_POW</a>) {  <span class="comment">/* arithmetic operator? */</span>
<a name="l00662"></a>00662     <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8">OpCode</a> opc = <a class="code" href="llimits_8h.html#f469cd45a80dd7d512ca0dff225a99ce">cast</a>(<a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8">OpCode</a>, (op - <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9781c9a8f433a7e447d7d0412b42bc521">OPR_ADD</a>) + <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f87904a633eed55be4f9a362d5519b8e55">OP_ADD</a>);  <span class="comment">/* ORDER OP */</span>
<a name="l00663"></a>00663     res-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, opc, 0, o1, o2);
<a name="l00664"></a>00664     res-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00665"></a>00665   }
<a name="l00666"></a>00666   <span class="keywordflow">else</span> {  <span class="comment">/* test operator */</span>
<a name="l00667"></a>00667     <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8">OpCode</a> <a class="code" href="rpmio__internal_8h.html#a72641445e87af11ebfdaed0decf5988">ops</a>[] = {<a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f864431379916faf6a7f623214f6722b1c">OP_EQ</a>, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f864431379916faf6a7f623214f6722b1c">OP_EQ</a>, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f87403065ee82e1822f8da268d648cf104">OP_LT</a>, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8e3b2d09331eb9eb2fdc09e6ba0e0fbf3">OP_LE</a>, OP_LT, OP_LE};
<a name="l00668"></a>00668     <span class="keywordtype">int</span> <a class="code" href="lparser_8c.html#c6430a9ba53b3f58401a2f61530597f9">cond</a> = 1;
<a name="l00669"></a>00669     <span class="keywordflow">if</span> (op &gt;= <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe946289309501420e59a73bf18ccd53b90">OPR_GT</a>) {  <span class="comment">/* `&gt;' or `&gt;='? */</span>
<a name="l00670"></a>00670       <span class="keywordtype">int</span> temp;  <span class="comment">/* exchange args and replace by `&lt;' or `&lt;=' */</span>
<a name="l00671"></a>00671       temp = o1; o1 = o2; o2 = temp;  <span class="comment">/* o1 &lt;==&gt; o2 */</span>
<a name="l00672"></a>00672     }
<a name="l00673"></a>00673     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (op == <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9a5a06e2ded8b6efcf184a2fd3e3e1a7e">OPR_NE</a>) cond = 0;
<a name="l00674"></a>00674     res-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#8a7476adf622d981388a578fb352319c">luaK_condjump</a>(fs, ops[op - <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9a5a06e2ded8b6efcf184a2fd3e3e1a7e">OPR_NE</a>], cond, o1, o2);
<a name="l00675"></a>00675     res-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365ee8f53eac2809d796d61f628e82e3ee3">VJMP</a>;
<a name="l00676"></a>00676   }
<a name="l00677"></a>00677 }
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 
<a name="l00680"></a><a class="code" href="lcode_8h.html#8eec54698e0c429cce8555e9c522d889">00680</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#ff7e055237813c15b2de4983189bd587">luaK_posfix</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9">BinOpr</a> op, <a class="code" href="structexpdesc.html">expdesc</a> *e1, <a class="code" href="structexpdesc.html">expdesc</a> *e2) {
<a name="l00681"></a>00681   <span class="keywordflow">switch</span> (op) {
<a name="l00682"></a>00682     <span class="keywordflow">case</span> <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9a547faae3b92a64f28de201de566bfb7">OPR_AND</a>: {
<a name="l00683"></a>00683       <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(e1-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a> == <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);  <span class="comment">/* list must be closed */</span>
<a name="l00684"></a>00684       <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e2);
<a name="l00685"></a>00685       <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;e1-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>, e2-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>);
<a name="l00686"></a>00686       e1-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = e2-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>; e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = e2-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>; e1-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a> = e2-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a>; e1-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a> = e2-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>;
<a name="l00687"></a>00687       <span class="keywordflow">break</span>;
<a name="l00688"></a>00688     }
<a name="l00689"></a>00689     <span class="keywordflow">case</span> <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe9234ab68698aa8abd114516b8b766932f">OPR_OR</a>: {
<a name="l00690"></a>00690       <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(e1-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a> == <a class="code" href="lcode_8h.html#4c369ccc140a4d776d407520856575d9">NO_JUMP</a>);  <span class="comment">/* list must be closed */</span>
<a name="l00691"></a>00691       <a class="code" href="lcode_8c.html#188d8cd72c3cf299964c8c25d7ed1636">luaK_dischargevars</a>(fs, e2);
<a name="l00692"></a>00692       <a class="code" href="lcode_8c.html#757aee9fd65c61b9a0d04923c95deac3">luaK_concat</a>(fs, &amp;e1-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>, e2-&gt;<a class="code" href="structexpdesc.html#3f6c140fd779dc224ffd535471d4e013">t</a>);
<a name="l00693"></a>00693       e1-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = e2-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>; e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = e2-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>; e1-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a> = e2-&gt;<a class="code" href="structexpdesc.html#815c27edac10c87de9b72b7a758ad471">aux</a>; e1-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a> = e2-&gt;<a class="code" href="structexpdesc.html#7be3168b08c47742f4d9696c6de5f373">f</a>;
<a name="l00694"></a>00694       <span class="keywordflow">break</span>;
<a name="l00695"></a>00695     }
<a name="l00696"></a>00696     <span class="keywordflow">case</span> <a class="code" href="lcode_8h.html#da7f9580c0cb317ba1491731ccf86fe996cb08140a18930f5fbf2d9903edb5b8">OPR_CONCAT</a>: {
<a name="l00697"></a>00697       <a class="code" href="lcode_8c.html#12e4478b15a9c2276fba35d117471315">luaK_exp2val</a>(fs, e2);
<a name="l00698"></a>00698       <span class="keywordflow">if</span> (e2-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> == <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a> &amp;&amp; <a class="code" href="lopcodes_8h.html#c534aadfac00831d34aa121193db8e88">GET_OPCODE</a>(<a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e2)) == <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8db7b410a1a5df04a858a04b9bb618e62">OP_CONCAT</a>) {
<a name="l00699"></a>00699         <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> == <a class="code" href="lopcodes_8h.html#59d1e6aadb0052fa6edc4c9500f88c3f">GETARG_B</a>(<a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e2))-1);
<a name="l00700"></a>00700         <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e1);
<a name="l00701"></a>00701         <a class="code" href="lopcodes_8h.html#8b4ad719c249408727af43797f70fd70">SETARG_B</a>(<a class="code" href="lcode_8h.html#bfc9fe00f812b8c8c8efabb757996737">getcode</a>(fs, e2), e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00702"></a>00702         e1-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = e2-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a>; e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = e2-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>;
<a name="l00703"></a>00703       }
<a name="l00704"></a>00704       <span class="keywordflow">else</span> {
<a name="l00705"></a>00705         <a class="code" href="lcode_8c.html#5e02efe4cc69aa02684085528919438b">luaK_exp2nextreg</a>(fs, e2);
<a name="l00706"></a>00706         <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e2);
<a name="l00707"></a>00707         <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e1);
<a name="l00708"></a>00708         e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a> = <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a>(fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8db7b410a1a5df04a858a04b9bb618e62">OP_CONCAT</a>, 0, e1-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>, e2-&gt;<a class="code" href="structexpdesc.html#9b58441e4a205cd0ff82d17d13882d07">info</a>);
<a name="l00709"></a>00709         e1-&gt;<a class="code" href="structexpdesc.html#c7ed631edd1d995508ea97ce9d6810c6">k</a> = <a class="code" href="lparser_8h.html#2e8a26153bc425ac946c5bea5838d365f4352ffe8be3cd3cf66474ea74e3eb66">VRELOCABLE</a>;
<a name="l00710"></a>00710       }
<a name="l00711"></a>00711       <span class="keywordflow">break</span>;
<a name="l00712"></a>00712     }
<a name="l00713"></a>00713     <span class="keywordflow">default</span>: {
<a name="l00714"></a>00714       <span class="keywordtype">int</span> o1 = <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a>(fs, e1);
<a name="l00715"></a>00715       <span class="keywordtype">int</span> o2 = <a class="code" href="lcode_8c.html#ac42ad04e45afd23b5043c1ce4e87724">luaK_exp2RK</a>(fs, e2);
<a name="l00716"></a>00716       <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e2);
<a name="l00717"></a>00717       <a class="code" href="lcode_8c.html#b2d34e18e9fd58095c835bd28a03135b">freeexp</a>(fs, e1);
<a name="l00718"></a>00718       <a class="code" href="lcode_8c.html#abaadad9ddeaebadd1aba701e1ca347c">codebinop</a>(fs, e1, op, o1, o2);
<a name="l00719"></a>00719     }
<a name="l00720"></a>00720   }
<a name="l00721"></a>00721 }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723 
<a name="l00724"></a><a class="code" href="lcode_8h.html#0e363b5f85b9a6915d53253c89e423f4">00724</a> <span class="keywordtype">void</span> <a class="code" href="lcode_8c.html#0e363b5f85b9a6915d53253c89e423f4">luaK_fixline</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <span class="keywordtype">int</span> line) {
<a name="l00725"></a>00725   fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>-&gt;<a class="code" href="structProto.html#cf42fab1af8ad00f7ceb65535e27df50">lineinfo</a>[fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a> - 1] = line;
<a name="l00726"></a>00726 }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728 
<a name="l00729"></a><a class="code" href="lcode_8h.html#6434ede2e36fe41b9e568ec9c90b18b3">00729</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#6434ede2e36fe41b9e568ec9c90b18b3">luaK_code</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a> i, <span class="keywordtype">int</span> line) {
<a name="l00730"></a>00730   <a class="code" href="structProto.html">Proto</a> *f = fs-&gt;<a class="code" href="structFuncState.html#57f144cf1c97c094944fb03fa0212837">f</a>;
<a name="l00731"></a>00731   <a class="code" href="lcode_8c.html#def0567501f3358e0848d7c0e90ec3c8">luaK_dischargejpc</a>(fs);  <span class="comment">/* `pc' will change */</span>
<a name="l00732"></a>00732   <span class="comment">/* put new instruction in code array */</span>
<a name="l00733"></a>00733   <a class="code" href="lmem_8h.html#df13c8c70de65f436d1620269e39382e">luaM_growvector</a>(fs-&gt;<a class="code" href="structFuncState.html#cc8fa751d5a970425f186d6ffe004f6a">L</a>, f-&gt;<a class="code" href="structProto.html#8eae520619c5b9bf7384af1ab8543f9a">code</a>, fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>, f-&gt;<a class="code" href="structProto.html#f9847e8b5f4e5feb57bf4fd828a2c76c">sizecode</a>, <a class="code" href="llimits_8h.html#cca3addb395457bf751bd428dad257b0">Instruction</a>,
<a name="l00734"></a>00734                   <a class="code" href="llimits_8h.html#58cfcc8e7fa0728a873e6db3ca2db5b3">MAX_INT</a>, <span class="stringliteral">"code size overflow"</span>);
<a name="l00735"></a>00735   f-&gt;<a class="code" href="structProto.html#8eae520619c5b9bf7384af1ab8543f9a">code</a>[fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>] = i;
<a name="l00736"></a>00736   <span class="comment">/* save corresponding line information */</span>
<a name="l00737"></a>00737   <a class="code" href="lmem_8h.html#df13c8c70de65f436d1620269e39382e">luaM_growvector</a>(fs-&gt;<a class="code" href="structFuncState.html#cc8fa751d5a970425f186d6ffe004f6a">L</a>, f-&gt;<a class="code" href="structProto.html#cf42fab1af8ad00f7ceb65535e27df50">lineinfo</a>, fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>, f-&gt;<a class="code" href="structProto.html#1dd67fa946d54e7d7965968629ec0d12">sizelineinfo</a>, <span class="keywordtype">int</span>,
<a name="l00738"></a>00738                   <a class="code" href="llimits_8h.html#58cfcc8e7fa0728a873e6db3ca2db5b3">MAX_INT</a>, <span class="stringliteral">"code size overflow"</span>);
<a name="l00739"></a>00739   f-&gt;<a class="code" href="structProto.html#cf42fab1af8ad00f7ceb65535e27df50">lineinfo</a>[fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>] = line;
<a name="l00740"></a>00740   <span class="keywordflow">return</span> fs-&gt;<a class="code" href="structFuncState.html#b3fb6b2f643a20fbe3f8a0cce7ec58ca">pc</a>++;
<a name="l00741"></a>00741 }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 
<a name="l00744"></a><a class="code" href="lcode_8h.html#edd6fe2ff50da35832facd263c0e9934">00744</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#71be9c0d12dd976861c5e5a68fab4768">luaK_codeABC</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8">OpCode</a> o, <span class="keywordtype">int</span> a, <span class="keywordtype">int</span> b, <span class="keywordtype">int</span> c) {
<a name="l00745"></a>00745   <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(<a class="code" href="lopcodes_8h.html#b3f4ec225a2927c57ed31ffa3814b9c1">getOpMode</a>(o) == <a class="code" href="lopcodes_8h.html#817496f32311641a2ed9ee1f5865809b79fd5c48aea375bee09f8068166c39f1">iABC</a>);
<a name="l00746"></a>00746   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#6434ede2e36fe41b9e568ec9c90b18b3">luaK_code</a>(fs, <a class="code" href="lopcodes_8h.html#0dd059ff51cec2680a3dc8a161ee3f21">CREATE_ABC</a>(o, a, b, c), fs-&gt;<a class="code" href="structFuncState.html#d1376c6bb410926d7c4081d63e682910">ls</a>-&gt;<a class="code" href="structLexState.html#8d5bda84c29de102eb0d4fac7df9c6ad">lastline</a>);
<a name="l00747"></a>00747 }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 
<a name="l00750"></a><a class="code" href="lcode_8h.html#36bf17ed33e1ce70b342423ecb6ffb40">00750</a> <span class="keywordtype">int</span> <a class="code" href="lcode_8c.html#f65b8b50684bdb36f8315e452f8262c0">luaK_codeABx</a> (<a class="code" href="structFuncState.html">FuncState</a> *fs, <a class="code" href="lopcodes_8h.html#dfab396538a59f4b8e31a97483c1e4f8">OpCode</a> o, <span class="keywordtype">int</span> a, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bc) {
<a name="l00751"></a>00751   <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(<a class="code" href="lopcodes_8h.html#b3f4ec225a2927c57ed31ffa3814b9c1">getOpMode</a>(o) == <a class="code" href="lopcodes_8h.html#817496f32311641a2ed9ee1f5865809bea3f278124d776cd4e4e141701f09396">iABx</a> || <a class="code" href="lopcodes_8h.html#b3f4ec225a2927c57ed31ffa3814b9c1">getOpMode</a>(o) == <a class="code" href="lopcodes_8h.html#817496f32311641a2ed9ee1f5865809b51e19d2fd6ce35492f1169244a906d34">iAsBx</a>);
<a name="l00752"></a>00752   <span class="keywordflow">return</span> <a class="code" href="lcode_8c.html#6434ede2e36fe41b9e568ec9c90b18b3">luaK_code</a>(fs, <a class="code" href="lopcodes_8h.html#0fb5959bf226976c940ee16983c47a42">CREATE_ABx</a>(o, a, bc), fs-&gt;<a class="code" href="structFuncState.html#d1376c6bb410926d7c4081d63e682910">ls</a>-&gt;<a class="code" href="structLexState.html#8d5bda84c29de102eb0d4fac7df9c6ad">lastline</a>);
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:54 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
