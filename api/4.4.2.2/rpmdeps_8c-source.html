<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: tools/rpmdeps.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>tools/rpmdeps.c</h1><a href="rpmdeps_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00002"></a><a class="code" href="rpmdeps_8c.html#bfe6ec379e0fe85b10ff6015bc0fdacc">00002</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="system_8h.html#50180bf6cf9a16254855e00c82286804">__progname</a>;
<a name="l00003"></a>00003 
<a name="l00004"></a>00004 <span class="preprocessor">#include &lt;<a class="code" href="rpmbuild_8h.html" title="This is the *only* module users of librpmbuild should need to include.">rpmbuild.h</a>&gt;</span>
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="argv_8h.html">argv.h</a>&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="rpmds_8h.html" title="Structure(s) used for dependency tag sets.">rpmds.h</a>&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;<a class="code" href="rpmfc_8h.html">rpmfc.h</a>&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="comment">/*@unchecked@*/</span>
<a name="l00012"></a><a class="code" href="rpmdeps_8c.html#ffc25bcf40c04f1a95d97c2e76c8084e">00012</a> <span class="keywordtype">char</span> *<a class="code" href="file_8c.html#ffc25bcf40c04f1a95d97c2e76c8084e">progname</a>;
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="comment">/*@unchecked@*/</span>
<a name="l00015"></a><a class="code" href="rpmdeps_8c.html#d3b0856a7a39a5812ae0d09ad085ed12">00015</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmdeps_8c.html#d3b0856a7a39a5812ae0d09ad085ed12">print_provides</a>;
<a name="l00016"></a>00016 
<a name="l00017"></a>00017 <span class="comment">/*@unchecked@*/</span>
<a name="l00018"></a><a class="code" href="rpmdeps_8c.html#168eeb9b583b4fffeedd0eadc87cc6a4">00018</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmdeps_8c.html#168eeb9b583b4fffeedd0eadc87cc6a4">print_requires</a>;
<a name="l00019"></a>00019 
<a name="l00020"></a><a class="code" href="rpmdeps_8c.html#f2cff6720484fd2040127cb0b9bc2643">00020</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rpmdeps_8c.html#f2cff6720484fd2040127cb0b9bc2643">rpmdsPrint</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * msg, <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds, FILE * fp)
<a name="l00021"></a>00021 {
<a name="l00022"></a>00022     <span class="keywordflow">if</span> (fp == NULL) fp = stderr;
<a name="l00023"></a>00023 
<a name="l00024"></a>00024     <span class="keywordflow">if</span> (msg)
<a name="l00025"></a>00025         fprintf(fp, <span class="stringliteral">"===================================== %s\n"</span>, msg);
<a name="l00026"></a>00026 
<a name="l00027"></a>00027     ds = <a class="code" href="rpmds_8c.html#9c00e325e03679279e436bd010ee3b6a" title="Initialize dependency set iterator.">rpmdsInit</a>(ds);
<a name="l00028"></a>00028     <span class="keywordflow">while</span> (<a class="code" href="rpmds_8c.html#e2b07afdbac562e3f1445fc0dd9bd77c" title="Return next dependency set iterator index.">rpmdsNext</a>(ds) &gt;= 0)
<a name="l00029"></a>00029         fprintf(fp, <span class="stringliteral">"%s\n"</span>, <a class="code" href="rpmds_8c.html#469513a3255575fe259677606a7feffb" title="Return current formatted dependency string.">rpmdsDNEVR</a>(ds)+2);
<a name="l00030"></a>00030 }
<a name="l00031"></a>00031 
<a name="l00032"></a><a class="code" href="rpmdeps_8c.html#1205e54530fc93ecb48c40e2fe35c29d">00032</a> <span class="keyword">static</span> <span class="keyword">struct </span>poptOption <a class="code" href="rpmqv_8c.html#1205e54530fc93ecb48c40e2fe35c29d">optionsTable</a>[] = {
<a name="l00033"></a>00033 
<a name="l00034"></a>00034  { NULL, <span class="charliteral">'\0'</span>, POPT_ARG_INCLUDE_TABLE, <a class="code" href="group__rpmcli.html#g132a54ddf32fb598fe2e5b70a22a270d" title="Popt option table for options shared by all modes and executables.">rpmcliAllPoptTable</a>, 0,
<a name="l00035"></a>00035         <a class="code" href="system_8h.html#cac8dc9c2554000001040435a0b0010d">N_</a>(<span class="stringliteral">"Common options for all rpm modes and executables:"</span>),
<a name="l00036"></a>00036         NULL }, 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038  { <span class="stringliteral">"provides"</span>, <span class="charliteral">'P'</span>, POPT_ARG_VAL, &amp;<a class="code" href="rpmdeps_8c.html#d3b0856a7a39a5812ae0d09ad085ed12">print_provides</a>, -1,
<a name="l00039"></a>00039         NULL, NULL },
<a name="l00040"></a>00040  { <span class="stringliteral">"requires"</span>, <span class="charliteral">'R'</span>, POPT_ARG_VAL, &amp;<a class="code" href="rpmdeps_8c.html#168eeb9b583b4fffeedd0eadc87cc6a4">print_requires</a>, -1,
<a name="l00041"></a>00041         NULL, NULL },
<a name="l00042"></a>00042 
<a name="l00043"></a>00043    POPT_AUTOALIAS
<a name="l00044"></a>00044    POPT_AUTOHELP
<a name="l00045"></a>00045    POPT_TABLEEND
<a name="l00046"></a>00046 };
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 <span class="keywordtype">int</span>
<a name="l00049"></a><a class="code" href="rpmdeps_8c.html#b9e816916bf8ce0a39ffd32cc7f5ed29">00049</a> <a class="code" href="rpmqv_8c.html#3d04ca28ed34f9e8632ffe35e03177b1">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>[])
<a name="l00050"></a>00050 {
<a name="l00051"></a>00051     poptContext optCon;
<a name="l00052"></a>00052     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> av = NULL;
<a name="l00053"></a>00053     <a class="code" href="structrpmfc__s.html">rpmfc</a> fc;
<a name="l00054"></a>00054     <span class="keywordtype">int</span> ac = 0;
<a name="l00055"></a>00055     <span class="keywordtype">int</span> ec = 1;
<a name="l00056"></a>00056     <span class="keywordtype">int</span> xx;
<a name="l00057"></a>00057 <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/*@-modobserver@*/</span>
<a name="l00060"></a>00060     <span class="keywordflow">if</span> ((<a class="code" href="file_8c.html#ffc25bcf40c04f1a95d97c2e76c8084e">progname</a> = strrchr(argv[0], <span class="charliteral">'/'</span>)) != NULL)
<a name="l00061"></a>00061         <a class="code" href="file_8c.html#ffc25bcf40c04f1a95d97c2e76c8084e">progname</a>++;
<a name="l00062"></a>00062     <span class="keywordflow">else</span>
<a name="l00063"></a>00063         <a class="code" href="file_8c.html#ffc25bcf40c04f1a95d97c2e76c8084e">progname</a> = argv[0];
<a name="l00064"></a>00064 <span class="comment">/*@=modobserver@*/</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066     optCon = <a class="code" href="poptALL_8c.html#96e06ee81e3d25da5233b6551a693255" title="Initialize most everything needed by an rpm CLI executable context.">rpmcliInit</a>(argc, argv, <a class="code" href="rpmqv_8c.html#1205e54530fc93ecb48c40e2fe35c29d">optionsTable</a>);
<a name="l00067"></a>00067     <span class="keywordflow">if</span> (optCon == NULL)
<a name="l00068"></a>00068         <span class="keywordflow">goto</span> exit;
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     av = poptGetArgs(optCon);
<a name="l00071"></a>00071     ac = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(av);
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <span class="keywordflow">if</span> (ac == 0) {
<a name="l00074"></a>00074         <span class="keywordtype">char</span> * b, * be;
<a name="l00075"></a>00075         av = NULL;
<a name="l00076"></a>00076         <span class="keywordflow">while</span> ((b = fgets(buf, <span class="keyword">sizeof</span>(buf), stdin)) != NULL) {
<a name="l00077"></a>00077             buf[<span class="keyword">sizeof</span>(buf)-1] = <span class="charliteral">'\0'</span>;
<a name="l00078"></a>00078             be = b + strlen(buf) - 1;
<a name="l00079"></a>00079             <span class="keywordflow">while</span> (strchr(<span class="stringliteral">"\r\n"</span>, *be) != NULL)
<a name="l00080"></a>00080                 *be-- = <span class="charliteral">'\0'</span>;
<a name="l00081"></a>00081             xx = <a class="code" href="argv_8c.html#72323478dc4967ef21899e9c48221721" title="Add a string to an argv array.">argvAdd</a>(&amp;av, b);
<a name="l00082"></a>00082         }
<a name="l00083"></a>00083         ac = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(av);
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086     <span class="comment">/* Make sure file names are sorted. */</span>
<a name="l00087"></a>00087     xx = <a class="code" href="argv_8c.html#92b256d456ce6aa425a0a5abaf81474c" title="Sort an argv array.">argvSort</a>(av, NULL);
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="comment">/* Build file class dictionary. */</span>
<a name="l00090"></a>00090     fc = <a class="code" href="rpmfc_8c.html#7e13b4f31e457a3b79cb94049d410d7c" title="Create a file classifier.">rpmfcNew</a>();
<a name="l00091"></a>00091     xx = <a class="code" href="rpmfc_8c.html#1d2f8f13da156a0f85921fd15e4bb9a8">rpmfcClassify</a>(fc, av, NULL);
<a name="l00092"></a>00092 
<a name="l00093"></a>00093     <span class="comment">/* Build file/package dependency dictionary. */</span>
<a name="l00094"></a>00094     xx = <a class="code" href="rpmfc_8c.html#ad428557e9ea4f79296dec422e737000" title="Build file/package dependency dictionary and mappings.">rpmfcApply</a>(fc);
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="keywordflow">if</span> (<a class="code" href="rpmfc_8h.html#608c14cadb7aa2256b7f0577df313971">_rpmfc_debug</a>) {
<a name="l00097"></a>00097 sprintf(buf, <span class="stringliteral">"final: files %d cdict[%d] %d%% ddictx[%d]"</span>, fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>, <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>), ((100 * fc-&gt;<a class="code" href="structrpmfc__s.html#669d14f9a2d946da731544851cbdc1fc">fknown</a>)/fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>), <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>));
<a name="l00098"></a>00098 <a class="code" href="rpmfc_8c.html#1590ab56e344f35ffc8804e6cc2fd267" title="Print results of file classification.">rpmfcPrint</a>(buf, fc, NULL);
<a name="l00099"></a>00099 }
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (<a class="code" href="rpmdeps_8c.html#d3b0856a7a39a5812ae0d09ad085ed12">print_provides</a>)
<a name="l00102"></a>00102         <a class="code" href="rpmdeps_8c.html#f2cff6720484fd2040127cb0b9bc2643">rpmdsPrint</a>(NULL, fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>, stdout);
<a name="l00103"></a>00103     <span class="keywordflow">if</span> (<a class="code" href="rpmdeps_8c.html#168eeb9b583b4fffeedd0eadc87cc6a4">print_requires</a>)
<a name="l00104"></a>00104         <a class="code" href="rpmdeps_8c.html#f2cff6720484fd2040127cb0b9bc2643">rpmdsPrint</a>(NULL, fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, stdout);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     fc = <a class="code" href="rpmfc_8c.html#7e5626c2f41e6cdf4ab167e90586f260" title="Destroy a file classifier.">rpmfcFree</a>(fc);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108     ec = 0;
<a name="l00109"></a>00109 
<a name="l00110"></a>00110 exit:
<a name="l00111"></a>00111     optCon = <a class="code" href="poptALL_8c.html#b9fe2b4702e2c34a5496e573ba6e6aeb" title="Destroy most everything needed by an rpm CLI executable context.">rpmcliFini</a>(optCon);
<a name="l00112"></a>00112     <span class="keywordflow">return</span> ec;
<a name="l00113"></a>00113 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:55 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
