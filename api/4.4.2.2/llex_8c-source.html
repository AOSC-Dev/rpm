<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: lua/llex.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>lua/llex.c</h1><a href="llex_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment">** $Id: llex.c,v 1.2 2004/03/23 05:09:14 jbj Exp $</span>
<a name="l00003"></a>00003 <span class="comment">** Lexical Analyzer</span>
<a name="l00004"></a>00004 <span class="comment">** See Copyright Notice in lua.h</span>
<a name="l00005"></a>00005 <span class="comment">*/</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a><a class="code" href="llex_8c.html#8969275ecda76708723fe4b75b0713f3">00011</a> <span class="preprocessor">#define llex_c</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span>
<a name="l00013"></a>00013 <span class="preprocessor">#include "lua.h"</span>
<a name="l00014"></a>00014 
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="ldo_8h.html">ldo.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="llex_8h.html">llex.h</a>"</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include "<a class="code" href="lobject_8h.html">lobject.h</a>"</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="lparser_8h.html">lparser.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="lstate_8h.html">lstate.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="lstring_8h.html">lstring.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="lzio_8h.html">lzio.h</a>"</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 
<a name="l00025"></a><a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">00025</a> <span class="preprocessor">#define next(LS) (LS-&gt;current = zgetc(LS-&gt;z))</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">/* ORDER RESERVED */</span>
<a name="l00030"></a>00030 <span class="comment">/*@observer@*/</span> <span class="comment">/*@unchecked@*/</span>
<a name="l00031"></a><a class="code" href="llex_8c.html#84fe7e74737dcc7e9c9ddb752eef5b0d">00031</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="llex_8c.html#84fe7e74737dcc7e9c9ddb752eef5b0d">token2string</a> [] = {
<a name="l00032"></a>00032     <span class="stringliteral">"and"</span>, <span class="stringliteral">"break"</span>, <span class="stringliteral">"do"</span>, <span class="stringliteral">"else"</span>, <span class="stringliteral">"elseif"</span>,
<a name="l00033"></a>00033     <span class="stringliteral">"end"</span>, <span class="stringliteral">"false"</span>, <span class="stringliteral">"for"</span>, <span class="stringliteral">"function"</span>, <span class="stringliteral">"if"</span>,
<a name="l00034"></a>00034     <span class="stringliteral">"in"</span>, <span class="stringliteral">"local"</span>, <span class="stringliteral">"nil"</span>, <span class="stringliteral">"not"</span>, <span class="stringliteral">"or"</span>, <span class="stringliteral">"repeat"</span>,
<a name="l00035"></a>00035     <span class="stringliteral">"return"</span>, <span class="stringliteral">"then"</span>, <span class="stringliteral">"true"</span>, <span class="stringliteral">"until"</span>, <span class="stringliteral">"while"</span>, <span class="stringliteral">"*name"</span>,
<a name="l00036"></a>00036     <span class="stringliteral">".."</span>, <span class="stringliteral">"..."</span>, <span class="stringliteral">"=="</span>, <span class="stringliteral">"&gt;="</span>, <span class="stringliteral">"&lt;="</span>, <span class="stringliteral">"~="</span>,
<a name="l00037"></a>00037     <span class="stringliteral">"*number"</span>, <span class="stringliteral">"*string"</span>, <span class="stringliteral">"&lt;eof&gt;"</span>
<a name="l00038"></a>00038 };
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="llex_8h.html#5990de8fb45dcae70577c150f11ebbe4">00041</a> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#5990de8fb45dcae70577c150f11ebbe4">luaX_init</a> (<a class="code" href="structlua__State.html">lua_State</a> *L) {
<a name="l00042"></a>00042   <span class="keywordtype">int</span> i;
<a name="l00043"></a>00043   <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="llex_8h.html#a08571fafceb9ccfcc8bdc182a635c91">NUM_RESERVED</a>; i++) {
<a name="l00044"></a>00044     <a class="code" href="unionTString.html">TString</a> *ts = <a class="code" href="lstring_8h.html#780c0cd806913440453924e96cedbc80">luaS_new</a>(L, <a class="code" href="llex_8c.html#84fe7e74737dcc7e9c9ddb752eef5b0d">token2string</a>[i]);
<a name="l00045"></a>00045     <a class="code" href="lstring_8h.html#8f698cc97c4c2d8c6f17b9617c953071">luaS_fix</a>(ts);  <span class="comment">/* reserved words are never collected */</span>
<a name="l00046"></a>00046     <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(strlen(<a class="code" href="llex_8c.html#84fe7e74737dcc7e9c9ddb752eef5b0d">token2string</a>[i])+1 &lt;= <a class="code" href="llex_8h.html#5cb7c9097d8b4162fa1e5ddd68bfd6b0">TOKEN_LEN</a>);
<a name="l00047"></a>00047     ts-&gt;tsv.reserved = <a class="code" href="llimits_8h.html#f469cd45a80dd7d512ca0dff225a99ce">cast</a>(<a class="code" href="llimits_8h.html#64f8b22b40cd3b0d9a7b61d79ae2d98f">lu_byte</a>, i+1);  <span class="comment">/* reserved word */</span>
<a name="l00048"></a>00048   }
<a name="l00049"></a>00049 }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="llex_8c.html#cf908b6837ca9b598f3ec0c665c1787e">00052</a> <span class="preprocessor">#define MAXSRC          80</span>
<a name="l00053"></a>00053 <span class="preprocessor"></span>
<a name="l00054"></a>00054 
<a name="l00055"></a><a class="code" href="llex_8h.html#275cf8fdaec9b3479be680414c991b42">00055</a> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#275cf8fdaec9b3479be680414c991b42">luaX_checklimit</a> (<a class="code" href="structLexState.html">LexState</a> *ls, <span class="keywordtype">int</span> val, <span class="keywordtype">int</span> limit, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {
<a name="l00056"></a>00056   <span class="keywordflow">if</span> (val &gt; limit) {
<a name="l00057"></a>00057     msg = <a class="code" href="lobject_8c.html#4c19cabd9ff2d10824ec51b2b331fd39">luaO_pushfstring</a>(ls-&gt;<a class="code" href="structLexState.html#246330fb40f867efd283df9d770cbc91">L</a>, <span class="stringliteral">"too many %s (limit=%d)"</span>, msg, limit);
<a name="l00058"></a>00058     <a class="code" href="llex_8c.html#62dfdc3824855840c7b8ef0161ce973a">luaX_syntaxerror</a>(ls, msg);
<a name="l00059"></a>00059   }
<a name="l00060"></a>00060 }
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="llex_8h.html#0d119c045adef256015c7b051336d7fe">00063</a> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#0d119c045adef256015c7b051336d7fe">luaX_errorline</a> (<a class="code" href="structLexState.html">LexState</a> *ls, <span class="keyword">const</span> <span class="keywordtype">char</span> *s, <span class="keyword">const</span> <span class="keywordtype">char</span> *token, <span class="keywordtype">int</span> line) {
<a name="l00064"></a>00064   <a class="code" href="structlua__State.html">lua_State</a> *L = ls-&gt;<a class="code" href="structLexState.html#246330fb40f867efd283df9d770cbc91">L</a>;
<a name="l00065"></a>00065   <span class="keywordtype">char</span> buff[<a class="code" href="llex_8c.html#cf908b6837ca9b598f3ec0c665c1787e">MAXSRC</a>];
<a name="l00066"></a>00066   <a class="code" href="lobject_8c.html#9e6bc3af6746e1e8fc00f2b10ded8c21">luaO_chunkid</a>(buff, <a class="code" href="lobject_8h.html#5e329e8c5c9d6804b34af1edda2189a5">getstr</a>(ls-&gt;<a class="code" href="structLexState.html#28d310102f29834750c081f05ee1fba7">source</a>), <a class="code" href="llex_8c.html#cf908b6837ca9b598f3ec0c665c1787e">MAXSRC</a>);
<a name="l00067"></a>00067   <a class="code" href="lobject_8c.html#4c19cabd9ff2d10824ec51b2b331fd39">luaO_pushfstring</a>(L, <span class="stringliteral">"%s:%d: %s near `%s'"</span>, buff, line, s, token); 
<a name="l00068"></a>00068   <a class="code" href="ldo_8c.html#99fc927fcbb0b9c47d3f027f02ed2d1b">luaD_throw</a>(L, LUA_ERRSYNTAX);
<a name="l00069"></a>00069 }
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="llex_8c.html#af2041ad98462a8d8bd73a16de087356">00072</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#af2041ad98462a8d8bd73a16de087356">luaX_error</a> (<a class="code" href="structLexState.html">LexState</a> *ls, <span class="keyword">const</span> <span class="keywordtype">char</span> *s, <span class="keyword">const</span> <span class="keywordtype">char</span> *token)
<a name="l00073"></a>00073         <span class="comment">/*@modifies ls @*/</span>
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075   <a class="code" href="llex_8c.html#0d119c045adef256015c7b051336d7fe">luaX_errorline</a>(ls, s, token, ls-&gt;<a class="code" href="structLexState.html#f6a3b9f51dffea6b6324a01833c32392">linenumber</a>);
<a name="l00076"></a>00076 }
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 
<a name="l00079"></a><a class="code" href="llex_8h.html#2b1afdcf0a59088ee6c2c56ac69a4753">00079</a> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#62dfdc3824855840c7b8ef0161ce973a">luaX_syntaxerror</a> (<a class="code" href="structLexState.html">LexState</a> *ls, <span class="keyword">const</span> <span class="keywordtype">char</span> *msg) {
<a name="l00080"></a>00080   <span class="keyword">const</span> <span class="keywordtype">char</span> *lasttoken;
<a name="l00081"></a>00081   <span class="keywordflow">switch</span> (ls-&gt;<a class="code" href="structLexState.html#81800213aebe7a68a7237015eea86f91">t</a>.<a class="code" href="structToken.html#c89246ca508e3df6dde42bdf07c0f35a">token</a>) {
<a name="l00082"></a>00082     <span class="keywordflow">case</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706fda51513df891a39681d90039ecbde7b">TK_NAME</a>:
<a name="l00083"></a>00083       lasttoken = <a class="code" href="lobject_8h.html#5e329e8c5c9d6804b34af1edda2189a5">getstr</a>(ls-&gt;<a class="code" href="structLexState.html#81800213aebe7a68a7237015eea86f91">t</a>.<a class="code" href="structToken.html#7311b127571eba6be371d156fdff94cf">seminfo</a>.<a class="code" href="unionSemInfo.html#896c42bfe6c5f6d3d0a53b6dd49a1a27">ts</a>);
<a name="l00084"></a>00084       <span class="keywordflow">break</span>;
<a name="l00085"></a>00085     <span class="keywordflow">case</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37066626a54da0f9520781755ab232575de6">TK_STRING</a>:
<a name="l00086"></a>00086     <span class="keywordflow">case</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea370611aa50ca19b2d7bbbdc35de8dd8a3566">TK_NUMBER</a>:
<a name="l00087"></a>00087       lasttoken = <a class="code" href="lzio_8h.html#8452a6574c720d56368e0d01147a8ff8">luaZ_buffer</a>(ls-&gt;<a class="code" href="structLexState.html#8c1e40147b887dfacafaecad027ea428">buff</a>);
<a name="l00088"></a>00088       <span class="keywordflow">break</span>;
<a name="l00089"></a>00089     <span class="keywordflow">default</span>:
<a name="l00090"></a>00090       lasttoken = <a class="code" href="llex_8c.html#d6bdb1e4b2c531111a14e44aa6006858">luaX_token2str</a>(ls, ls-&gt;<a class="code" href="structLexState.html#81800213aebe7a68a7237015eea86f91">t</a>.<a class="code" href="structToken.html#c89246ca508e3df6dde42bdf07c0f35a">token</a>);
<a name="l00091"></a>00091       <span class="keywordflow">break</span>;
<a name="l00092"></a>00092   }
<a name="l00093"></a>00093   <a class="code" href="llex_8c.html#af2041ad98462a8d8bd73a16de087356">luaX_error</a>(ls, msg, lasttoken);
<a name="l00094"></a>00094 }
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 
<a name="l00097"></a><a class="code" href="llex_8h.html#d6bdb1e4b2c531111a14e44aa6006858">00097</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="llex_8c.html#d6bdb1e4b2c531111a14e44aa6006858">luaX_token2str</a> (<a class="code" href="structLexState.html">LexState</a> *ls, <span class="keywordtype">int</span> token) {
<a name="l00098"></a>00098   <span class="keywordflow">if</span> (token &lt; <a class="code" href="llex_8h.html#879bc134fd18ed5e313b7811f8cbfcbc">FIRST_RESERVED</a>) {
<a name="l00099"></a>00099     <a class="code" href="llimits_8h.html#c4975de4438f4210aa45d111c923498d">lua_assert</a>(token == (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)token);
<a name="l00100"></a>00100     <span class="keywordflow">return</span> <a class="code" href="lobject_8c.html#4c19cabd9ff2d10824ec51b2b331fd39">luaO_pushfstring</a>(ls-&gt;<a class="code" href="structLexState.html#246330fb40f867efd283df9d770cbc91">L</a>, <span class="stringliteral">"%c"</span>, token);
<a name="l00101"></a>00101   }
<a name="l00102"></a>00102   <span class="keywordflow">else</span>
<a name="l00103"></a>00103     <span class="keywordflow">return</span> <a class="code" href="llex_8c.html#84fe7e74737dcc7e9c9ddb752eef5b0d">token2string</a>[token-<a class="code" href="llex_8h.html#879bc134fd18ed5e313b7811f8cbfcbc">FIRST_RESERVED</a>];
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 
<a name="l00107"></a><a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">00107</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a> (<a class="code" href="structLexState.html">LexState</a> *ls, <span class="keyword">const</span> <span class="keywordtype">char</span> *s, <span class="keywordtype">int</span> token)
<a name="l00108"></a>00108         <span class="comment">/*@modifies ls @*/</span>
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110   <span class="keywordflow">if</span> (token == <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706d098fce4afd73fd61ac03701e376d70c">TK_EOS</a>)
<a name="l00111"></a>00111     <a class="code" href="llex_8c.html#af2041ad98462a8d8bd73a16de087356">luaX_error</a>(ls, s, <a class="code" href="llex_8c.html#d6bdb1e4b2c531111a14e44aa6006858">luaX_token2str</a>(ls, token));
<a name="l00112"></a>00112   <span class="keywordflow">else</span>
<a name="l00113"></a>00113     <a class="code" href="llex_8c.html#af2041ad98462a8d8bd73a16de087356">luaX_error</a>(ls, s, <a class="code" href="lzio_8h.html#8452a6574c720d56368e0d01147a8ff8">luaZ_buffer</a>(ls-&gt;buff));
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="llex_8c.html#bfa30bb8e9f98fe9818089e6d94f758f">00117</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#bfa30bb8e9f98fe9818089e6d94f758f">inclinenumber</a> (<a class="code" href="structLexState.html">LexState</a> *LS)
<a name="l00118"></a>00118         <span class="comment">/*@modifies LS @*/</span>
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120   <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);  <span class="comment">/* skip `\n' */</span>
<a name="l00121"></a>00121   ++LS-&gt;<a class="code" href="structLexState.html#f6a3b9f51dffea6b6324a01833c32392">linenumber</a>;
<a name="l00122"></a>00122   <a class="code" href="llex_8c.html#275cf8fdaec9b3479be680414c991b42">luaX_checklimit</a>(LS, LS-&gt;<a class="code" href="structLexState.html#f6a3b9f51dffea6b6324a01833c32392">linenumber</a>, <a class="code" href="llimits_8h.html#58cfcc8e7fa0728a873e6db3ca2db5b3">MAX_INT</a>, <span class="stringliteral">"lines in a chunk"</span>);
<a name="l00123"></a>00123 }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125 
<a name="l00126"></a><a class="code" href="llex_8h.html#77ac2d8fb2149ee123bc1a9fa0fc09b1">00126</a> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#77ac2d8fb2149ee123bc1a9fa0fc09b1">luaX_setinput</a> (<a class="code" href="structlua__State.html">lua_State</a> *L, <a class="code" href="structLexState.html">LexState</a> *LS, <a class="code" href="structZio.html">ZIO</a> *z, <a class="code" href="unionTString.html">TString</a> *source) {
<a name="l00127"></a>00127   LS-&gt;<a class="code" href="structLexState.html#246330fb40f867efd283df9d770cbc91">L</a> = L;
<a name="l00128"></a>00128   LS-&gt;<a class="code" href="structLexState.html#da611999f8386fc5bc5e77be8e00f435">lookahead</a>.<a class="code" href="structToken.html#c89246ca508e3df6dde42bdf07c0f35a">token</a> = <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706d098fce4afd73fd61ac03701e376d70c">TK_EOS</a>;  <span class="comment">/* no look-ahead token */</span>
<a name="l00129"></a>00129   LS-&gt;<a class="code" href="structLexState.html#2e3f3d8ba6c3690f3745f1bb956cea33">z</a> = z;
<a name="l00130"></a>00130   LS-&gt;<a class="code" href="structLexState.html#ff5e2083b02058b79cdfde887244b703">fs</a> = NULL;
<a name="l00131"></a>00131   LS-&gt;<a class="code" href="structLexState.html#f6a3b9f51dffea6b6324a01833c32392">linenumber</a> = 1;
<a name="l00132"></a>00132   LS-&gt;<a class="code" href="structLexState.html#8d5bda84c29de102eb0d4fac7df9c6ad">lastline</a> = 1;
<a name="l00133"></a>00133   LS-&gt;<a class="code" href="structLexState.html#28d310102f29834750c081f05ee1fba7">source</a> = source;
<a name="l00134"></a>00134   <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);  <span class="comment">/* read first char */</span>
<a name="l00135"></a>00135   <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'#'</span>) {
<a name="l00136"></a>00136     <span class="keywordflow">do</span> {  <span class="comment">/* skip first line */</span>
<a name="l00137"></a>00137       <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00138"></a>00138     } <span class="keywordflow">while</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'\n'</span> &amp;&amp; LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <a class="code" href="lzio_8h.html#d6a3438bf06ea3922cb3ab3f5d505cf9">EOZ</a>);
<a name="l00139"></a>00139   }
<a name="l00140"></a>00140 }
<a name="l00141"></a>00141 
<a name="l00142"></a>00142 
<a name="l00143"></a>00143 
<a name="l00144"></a>00144 <span class="comment">/*</span>
<a name="l00145"></a>00145 <span class="comment">** =======================================================</span>
<a name="l00146"></a>00146 <span class="comment">** LEXICAL ANALYZER</span>
<a name="l00147"></a>00147 <span class="comment">** =======================================================</span>
<a name="l00148"></a>00148 <span class="comment">*/</span>
<a name="l00149"></a>00149 
<a name="l00150"></a>00150 
<a name="l00151"></a>00151 <span class="comment">/* use buffer to store names, literal strings and numbers */</span>
<a name="l00152"></a>00152 
<a name="l00153"></a>00153 <span class="comment">/* extra space to allocate when growing buffer */</span>
<a name="l00154"></a><a class="code" href="llex_8c.html#eae52d27999cec06ad74f349990297c2">00154</a> <span class="preprocessor">#define EXTRABUFF       32</span>
<a name="l00155"></a>00155 <span class="preprocessor"></span>
<a name="l00156"></a>00156 <span class="comment">/* maximum number of chars that can be read without checking buffer size */</span>
<a name="l00157"></a><a class="code" href="llex_8c.html#4f1e4c12cffd947c2f1e9c6549ed3332">00157</a> <span class="preprocessor">#define MAXNOCHECK      5</span>
<a name="l00158"></a>00158 <span class="preprocessor"></span>
<a name="l00159"></a><a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">00159</a> <span class="preprocessor">#define checkbuffer(LS, len)    \</span>
<a name="l00160"></a>00160 <span class="preprocessor">    if (((len)+MAXNOCHECK)*sizeof(char) &gt; luaZ_sizebuffer((LS)-&gt;buff)) \</span>
<a name="l00161"></a>00161 <span class="preprocessor">      luaZ_openspace((LS)-&gt;L, (LS)-&gt;buff, (len)+EXTRABUFF)</span>
<a name="l00162"></a>00162 <span class="preprocessor"></span>
<a name="l00163"></a><a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">00163</a> <span class="preprocessor">#define save(LS, c, l) \</span>
<a name="l00164"></a>00164 <span class="preprocessor">        (luaZ_buffer((LS)-&gt;buff)[l++] = cast(char, c))</span>
<a name="l00165"></a><a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">00165</a> <span class="preprocessor"></span><span class="preprocessor">#define save_and_next(LS, l)  (save(LS, LS-&gt;current, l), next(LS))</span>
<a name="l00166"></a>00166 <span class="preprocessor"></span>
<a name="l00167"></a>00167 
<a name="l00168"></a><a class="code" href="llex_8c.html#2d450d63d4527e25d7fc6d0ee3caf9c7">00168</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="llex_8c.html#2d450d63d4527e25d7fc6d0ee3caf9c7">readname</a> (<a class="code" href="structLexState.html">LexState</a> *LS)
<a name="l00169"></a>00169         <span class="comment">/*@modifies LS @*/</span>
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171   <span class="keywordtype">size_t</span> l = 0;
<a name="l00172"></a>00172   <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00173"></a>00173   <span class="keywordflow">do</span> {
<a name="l00174"></a>00174     <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00175"></a>00175     <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00176"></a>00176   } <span class="keywordflow">while</span> (isalnum(LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>) || LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'_'</span>);
<a name="l00177"></a>00177   <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00178"></a>00178   <span class="keywordflow">return</span> l-1;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="comment">/* LUA_NUMBER */</span>
<a name="l00183"></a><a class="code" href="llex_8c.html#f26b854253f4e65a68c9025767cb44d8">00183</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#f26b854253f4e65a68c9025767cb44d8">read_numeral</a> (<a class="code" href="structLexState.html">LexState</a> *LS, <span class="keywordtype">int</span> comma, <a class="code" href="unionSemInfo.html">SemInfo</a> *seminfo)
<a name="l00184"></a>00184         <span class="comment">/*@modifies LS, seminfo @*/</span>
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186   <span class="keywordtype">size_t</span> l = 0;
<a name="l00187"></a>00187   <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00188"></a>00188   <span class="keywordflow">if</span> (comma) <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'.'</span>, l);
<a name="l00189"></a>00189   <span class="keywordflow">while</span> (isdigit(LS-&gt;current)) {
<a name="l00190"></a>00190     <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00191"></a>00191     <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00192"></a>00192   }
<a name="l00193"></a>00193   <span class="keywordflow">if</span> (LS-&gt;current == <span class="charliteral">'.'</span>) {
<a name="l00194"></a>00194     <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (LS-&gt;current == <span class="charliteral">'.'</span>) {
<a name="l00196"></a>00196       <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00197"></a>00197       <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00198"></a>00198       <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a>(LS,
<a name="l00199"></a>00199                  <span class="stringliteral">"ambiguous syntax (decimal point x string concatenation)"</span>,
<a name="l00200"></a>00200                  <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea370611aa50ca19b2d7bbbdc35de8dd8a3566">TK_NUMBER</a>);
<a name="l00201"></a>00201     }
<a name="l00202"></a>00202   }
<a name="l00203"></a>00203   <span class="keywordflow">while</span> (isdigit(LS-&gt;current)) {
<a name="l00204"></a>00204     <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00205"></a>00205     <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00206"></a>00206   }
<a name="l00207"></a>00207   <span class="keywordflow">if</span> (LS-&gt;current == <span class="charliteral">'e'</span> || LS-&gt;current == <span class="charliteral">'E'</span>) {
<a name="l00208"></a>00208     <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);  <span class="comment">/* read `E' */</span>
<a name="l00209"></a>00209     <span class="keywordflow">if</span> (LS-&gt;current == <span class="charliteral">'+'</span> || LS-&gt;current == <span class="charliteral">'-'</span>)
<a name="l00210"></a>00210       <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);  <span class="comment">/* optional exponent sign */</span>
<a name="l00211"></a>00211     <span class="keywordflow">while</span> (isdigit(LS-&gt;current)) {
<a name="l00212"></a>00212       <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00213"></a>00213       <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00214"></a>00214     }
<a name="l00215"></a>00215   }
<a name="l00216"></a>00216   <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00217"></a>00217   <span class="keywordflow">if</span> (!<a class="code" href="lobject_8c.html#db07135af6385173b9734da85a1c709b">luaO_str2d</a>(<a class="code" href="lzio_8h.html#8452a6574c720d56368e0d01147a8ff8">luaZ_buffer</a>(LS-&gt;buff), &amp;seminfo-&gt;<a class="code" href="unionSemInfo.html#8b446064b6aaf7034dedfc1a3f7504ab">r</a>))
<a name="l00218"></a>00218     <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a>(LS, <span class="stringliteral">"malformed number"</span>, <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea370611aa50ca19b2d7bbbdc35de8dd8a3566">TK_NUMBER</a>);
<a name="l00219"></a>00219 }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221 
<a name="l00222"></a><a class="code" href="llex_8c.html#d4926a4dbc3a3c7004d22f3a7beb48e2">00222</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#d4926a4dbc3a3c7004d22f3a7beb48e2">read_long_string</a> (<a class="code" href="structLexState.html">LexState</a> *LS, <span class="comment">/*@null@*/</span> <a class="code" href="unionSemInfo.html">SemInfo</a> *seminfo)
<a name="l00223"></a>00223         <span class="comment">/*@modifies LS, seminfo @*/</span>
<a name="l00224"></a>00224 {
<a name="l00225"></a>00225   <span class="keywordtype">int</span> cont = 0;
<a name="l00226"></a>00226   <span class="keywordtype">size_t</span> l = 0;
<a name="l00227"></a>00227   <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00228"></a>00228   <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'['</span>, l);  <span class="comment">/* save first `[' */</span>
<a name="l00229"></a>00229   <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);  <span class="comment">/* pass the second `[' */</span>
<a name="l00230"></a>00230   <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'\n'</span>)  <span class="comment">/* string starts with a newline? */</span>
<a name="l00231"></a>00231     <a class="code" href="llex_8c.html#bfa30bb8e9f98fe9818089e6d94f758f">inclinenumber</a>(LS);  <span class="comment">/* skip it */</span>
<a name="l00232"></a>00232   <span class="keywordflow">for</span> (;;) {
<a name="l00233"></a>00233     <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00234"></a>00234     <span class="keywordflow">switch</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>) {
<a name="l00235"></a>00235       <span class="keywordflow">case</span> <a class="code" href="lzio_8h.html#d6a3438bf06ea3922cb3ab3f5d505cf9">EOZ</a>:
<a name="l00236"></a>00236         <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00237"></a>00237         <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a>(LS, (seminfo) ? <span class="stringliteral">"unfinished long string"</span> :
<a name="l00238"></a>00238                                    <span class="stringliteral">"unfinished long comment"</span>, <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706d098fce4afd73fd61ac03701e376d70c">TK_EOS</a>);
<a name="l00239"></a>00239         <span class="keywordflow">break</span>;  <span class="comment">/* to avoid warnings */</span>
<a name="l00240"></a>00240       <span class="keywordflow">case</span> <span class="charliteral">'['</span>:
<a name="l00241"></a>00241         <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00242"></a>00242         <span class="keywordflow">if</span> (LS-&gt;current == <span class="charliteral">'['</span>) {
<a name="l00243"></a>00243           cont++;
<a name="l00244"></a>00244           <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00245"></a>00245         }
<a name="l00246"></a>00246         <span class="keywordflow">continue</span>;
<a name="l00247"></a>00247       <span class="keywordflow">case</span> <span class="charliteral">']'</span>:
<a name="l00248"></a>00248         <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00249"></a>00249         <span class="keywordflow">if</span> (LS-&gt;current == <span class="charliteral">']'</span>) {
<a name="l00250"></a>00250           <span class="keywordflow">if</span> (cont == 0) <span class="keywordflow">goto</span> endloop;
<a name="l00251"></a>00251           cont--;
<a name="l00252"></a>00252           <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00253"></a>00253         }
<a name="l00254"></a>00254         <span class="keywordflow">continue</span>;
<a name="l00255"></a>00255       <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
<a name="l00256"></a>00256         <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\n'</span>, l);
<a name="l00257"></a>00257         <a class="code" href="llex_8c.html#bfa30bb8e9f98fe9818089e6d94f758f">inclinenumber</a>(LS);
<a name="l00258"></a>00258         <span class="keywordflow">if</span> (!seminfo) l = 0;  <span class="comment">/* reset buffer to avoid wasting space */</span>
<a name="l00259"></a>00259         <span class="keywordflow">continue</span>;
<a name="l00260"></a>00260       <span class="keywordflow">default</span>:
<a name="l00261"></a>00261         <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00262"></a>00262     }
<a name="l00263"></a>00263   } endloop:
<a name="l00264"></a>00264   <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);  <span class="comment">/* skip the second `]' */</span>
<a name="l00265"></a>00265   <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00266"></a>00266   <span class="keywordflow">if</span> (seminfo)
<a name="l00267"></a>00267     seminfo-&gt;ts = <a class="code" href="lstring_8c.html#63764b86a26ae664d57e9e8e546f3729">luaS_newlstr</a>(LS-&gt;L, <a class="code" href="lzio_8h.html#8452a6574c720d56368e0d01147a8ff8">luaZ_buffer</a>(LS-&gt;buff) + 2, l - 5);
<a name="l00268"></a>00268 }
<a name="l00269"></a>00269 
<a name="l00270"></a>00270 
<a name="l00271"></a><a class="code" href="llex_8c.html#0be33d58ad0a0b26e86768e3d4932987">00271</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="llex_8c.html#0be33d58ad0a0b26e86768e3d4932987">read_string</a> (<a class="code" href="structLexState.html">LexState</a> *LS, <span class="keywordtype">int</span> del, <a class="code" href="unionSemInfo.html">SemInfo</a> *seminfo)
<a name="l00272"></a>00272         <span class="comment">/*@modifies LS, seminfo @*/</span>
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274   <span class="keywordtype">size_t</span> l = 0;
<a name="l00275"></a>00275   <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00276"></a>00276   <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00277"></a>00277   <span class="keywordflow">while</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != del) {
<a name="l00278"></a>00278     <a class="code" href="llex_8c.html#9bcd88d9d4a29ee0208a668a77f51402">checkbuffer</a>(LS, l);
<a name="l00279"></a>00279     <span class="keywordflow">switch</span> (LS-&gt;current) {
<a name="l00280"></a>00280       <span class="keywordflow">case</span> <a class="code" href="lzio_8h.html#d6a3438bf06ea3922cb3ab3f5d505cf9">EOZ</a>:
<a name="l00281"></a>00281         <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00282"></a>00282         <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a>(LS, <span class="stringliteral">"unfinished string"</span>, <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706d098fce4afd73fd61ac03701e376d70c">TK_EOS</a>);
<a name="l00283"></a>00283         <span class="keywordflow">break</span>;  <span class="comment">/* to avoid warnings */</span>
<a name="l00284"></a>00284       <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
<a name="l00285"></a>00285         <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00286"></a>00286         <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a>(LS, <span class="stringliteral">"unfinished string"</span>, <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37066626a54da0f9520781755ab232575de6">TK_STRING</a>);
<a name="l00287"></a>00287         <span class="keywordflow">break</span>;  <span class="comment">/* to avoid warnings */</span>
<a name="l00288"></a>00288       <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
<a name="l00289"></a>00289         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);  <span class="comment">/* do not save the `\' */</span>
<a name="l00290"></a>00290         <span class="keywordflow">switch</span> (LS-&gt;current) {
<a name="l00291"></a>00291           <span class="keywordflow">case</span> <span class="charliteral">'a'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\a'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00292"></a>00292           <span class="keywordflow">case</span> <span class="charliteral">'b'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\b'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00293"></a>00293           <span class="keywordflow">case</span> <span class="charliteral">'f'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\f'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00294"></a>00294           <span class="keywordflow">case</span> <span class="charliteral">'n'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\n'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00295"></a>00295           <span class="keywordflow">case</span> <span class="charliteral">'r'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\r'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00296"></a>00296           <span class="keywordflow">case</span> <span class="charliteral">'t'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\t'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00297"></a>00297           <span class="keywordflow">case</span> <span class="charliteral">'v'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\v'</span>, l); <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">break</span>;
<a name="l00298"></a>00298           <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>: <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\n'</span>, l); <a class="code" href="llex_8c.html#bfa30bb8e9f98fe9818089e6d94f758f">inclinenumber</a>(LS); <span class="keywordflow">break</span>;
<a name="l00299"></a>00299           <span class="keywordflow">case</span> <a class="code" href="lzio_8h.html#d6a3438bf06ea3922cb3ab3f5d505cf9">EOZ</a>: <span class="keywordflow">break</span>;  <span class="comment">/* will raise an error next loop */</span>
<a name="l00300"></a>00300           <span class="keywordflow">default</span>: {
<a name="l00301"></a>00301             <span class="keywordflow">if</span> (!isdigit(LS-&gt;current))
<a name="l00302"></a>00302               <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);  <span class="comment">/* handles \\, \", \', and \? */</span>
<a name="l00303"></a>00303             <span class="keywordflow">else</span> {  <span class="comment">/* \xxx */</span>
<a name="l00304"></a>00304               <span class="keywordtype">int</span> c = 0;
<a name="l00305"></a>00305               <span class="keywordtype">int</span> i = 0;
<a name="l00306"></a>00306               <span class="keywordflow">do</span> {
<a name="l00307"></a>00307                 c = 10*c + (LS-&gt;current-<span class="charliteral">'0'</span>);
<a name="l00308"></a>00308                 <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00309"></a>00309               } <span class="keywordflow">while</span> (++i&lt;3 &amp;&amp; isdigit(LS-&gt;current));
<a name="l00310"></a>00310               <span class="keywordflow">if</span> (c &gt; UCHAR_MAX) {
<a name="l00311"></a>00311                 <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00312"></a>00312                 <a class="code" href="llex_8c.html#d24fa99cc5093ed19a0aeeb491207441">luaX_lexerror</a>(LS, <span class="stringliteral">"escape sequence too large"</span>, <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37066626a54da0f9520781755ab232575de6">TK_STRING</a>);
<a name="l00313"></a>00313               }
<a name="l00314"></a>00314               <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, c, l);
<a name="l00315"></a>00315             }
<a name="l00316"></a>00316           }
<a name="l00317"></a>00317         }
<a name="l00318"></a>00318         <span class="keywordflow">break</span>;
<a name="l00319"></a>00319       <span class="keywordflow">default</span>:
<a name="l00320"></a>00320         <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322   }
<a name="l00323"></a>00323   <a class="code" href="llex_8c.html#5be983f5b6d82db40f4b34a24ad72d9a">save_and_next</a>(LS, l);  <span class="comment">/* skip delimiter */</span>
<a name="l00324"></a>00324   <a class="code" href="llex_8c.html#1b8933058aa7295a6ac9354f8fa7ef18">save</a>(LS, <span class="charliteral">'\0'</span>, l);
<a name="l00325"></a>00325   seminfo-&gt;<a class="code" href="unionSemInfo.html#896c42bfe6c5f6d3d0a53b6dd49a1a27">ts</a> = <a class="code" href="lstring_8c.html#63764b86a26ae664d57e9e8e546f3729">luaS_newlstr</a>(LS-&gt;<a class="code" href="structLexState.html#246330fb40f867efd283df9d770cbc91">L</a>, <a class="code" href="lzio_8h.html#8452a6574c720d56368e0d01147a8ff8">luaZ_buffer</a>(LS-&gt;<a class="code" href="structLexState.html#8c1e40147b887dfacafaecad027ea428">buff</a>) + 1, l - 3);
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 
<a name="l00329"></a><a class="code" href="llex_8h.html#d629883556f73d2dcbabc2d641f86096">00329</a> <span class="keywordtype">int</span> <a class="code" href="llex_8c.html#d629883556f73d2dcbabc2d641f86096">luaX_lex</a> (<a class="code" href="structLexState.html">LexState</a> *LS, <a class="code" href="unionSemInfo.html">SemInfo</a> *seminfo) {
<a name="l00330"></a>00330   <span class="keywordflow">for</span> (;;) {
<a name="l00331"></a>00331     <span class="keywordflow">switch</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>) {
<a name="l00332"></a>00332 
<a name="l00333"></a>00333       <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>: {
<a name="l00334"></a>00334         <a class="code" href="llex_8c.html#bfa30bb8e9f98fe9818089e6d94f758f">inclinenumber</a>(LS);
<a name="l00335"></a>00335         <span class="keywordflow">continue</span>;
<a name="l00336"></a>00336       }
<a name="l00337"></a>00337       <span class="keywordflow">case</span> <span class="charliteral">'-'</span>: {
<a name="l00338"></a>00338         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00339"></a>00339         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'-'</span>) <span class="keywordflow">return</span> <span class="charliteral">'-'</span>;
<a name="l00340"></a>00340         <span class="comment">/* else is a comment */</span>
<a name="l00341"></a>00341         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00342"></a>00342         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'['</span> &amp;&amp; (<a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS), LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'['</span>))
<a name="l00343"></a>00343           <a class="code" href="llex_8c.html#d4926a4dbc3a3c7004d22f3a7beb48e2">read_long_string</a>(LS, NULL);  <span class="comment">/* long comment */</span>
<a name="l00344"></a>00344         <span class="keywordflow">else</span>  <span class="comment">/* short comment */</span>
<a name="l00345"></a>00345           <span class="keywordflow">while</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'\n'</span> &amp;&amp; LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <a class="code" href="lzio_8h.html#d6a3438bf06ea3922cb3ab3f5d505cf9">EOZ</a>)
<a name="l00346"></a>00346             <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00347"></a>00347         <span class="keywordflow">continue</span>;
<a name="l00348"></a>00348       }
<a name="l00349"></a>00349       <span class="keywordflow">case</span> <span class="charliteral">'['</span>: {
<a name="l00350"></a>00350         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00351"></a>00351         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'['</span>) <span class="keywordflow">return</span> <span class="charliteral">'['</span>;
<a name="l00352"></a>00352         <span class="keywordflow">else</span> {
<a name="l00353"></a>00353           <a class="code" href="llex_8c.html#d4926a4dbc3a3c7004d22f3a7beb48e2">read_long_string</a>(LS, seminfo);
<a name="l00354"></a>00354           <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37066626a54da0f9520781755ab232575de6">TK_STRING</a>;
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356       }
<a name="l00357"></a>00357       <span class="keywordflow">case</span> <span class="charliteral">'='</span>: {
<a name="l00358"></a>00358         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00359"></a>00359         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'='</span>) <span class="keywordflow">return</span> <span class="charliteral">'='</span>;
<a name="l00360"></a>00360         <span class="keywordflow">else</span> { <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706a0a7c797f03977146d8997bda9a62b3d">TK_EQ</a>; }
<a name="l00361"></a>00361       }
<a name="l00362"></a>00362       <span class="keywordflow">case</span> <span class="charliteral">'&lt;'</span>: {
<a name="l00363"></a>00363         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00364"></a>00364         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'='</span>) <span class="keywordflow">return</span> <span class="charliteral">'&lt;'</span>;
<a name="l00365"></a>00365         <span class="keywordflow">else</span> { <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37068cb6c017d94e10cb43fd22f4a4e22b78">TK_LE</a>; }
<a name="l00366"></a>00366       }
<a name="l00367"></a>00367       <span class="keywordflow">case</span> <span class="charliteral">'&gt;'</span>: {
<a name="l00368"></a>00368         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00369"></a>00369         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'='</span>) <span class="keywordflow">return</span> <span class="charliteral">'&gt;'</span>;
<a name="l00370"></a>00370         <span class="keywordflow">else</span> { <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37069183c9f4dd72317ab8ec4825db920205">TK_GE</a>; }
<a name="l00371"></a>00371       }
<a name="l00372"></a>00372       <span class="keywordflow">case</span> <span class="charliteral">'~'</span>: {
<a name="l00373"></a>00373         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00374"></a>00374         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> != <span class="charliteral">'='</span>) <span class="keywordflow">return</span> <span class="charliteral">'~'</span>;
<a name="l00375"></a>00375         <span class="keywordflow">else</span> { <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS); <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37062a9bbf8bea081dcfe93591fa1dc32894">TK_NE</a>; }
<a name="l00376"></a>00376       }
<a name="l00377"></a>00377       <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
<a name="l00378"></a>00378       <span class="keywordflow">case</span> <span class="charliteral">'\''</span>: {
<a name="l00379"></a>00379         <a class="code" href="llex_8c.html#0be33d58ad0a0b26e86768e3d4932987">read_string</a>(LS, LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>, seminfo);
<a name="l00380"></a>00380         <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37066626a54da0f9520781755ab232575de6">TK_STRING</a>;
<a name="l00381"></a>00381       }
<a name="l00382"></a>00382       <span class="keywordflow">case</span> <span class="charliteral">'.'</span>: {
<a name="l00383"></a>00383         <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00384"></a>00384         <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'.'</span>) {
<a name="l00385"></a>00385           <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00386"></a>00386           <span class="keywordflow">if</span> (LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'.'</span>) {
<a name="l00387"></a>00387             <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00388"></a>00388             <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea370678d14e02e621becd28e83a37f762f382">TK_DOTS</a>;   <span class="comment">/* ... */</span>
<a name="l00389"></a>00389           }
<a name="l00390"></a>00390           <span class="keywordflow">else</span> <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea37067956b896041ceec82c942af2366ea593">TK_CONCAT</a>;   <span class="comment">/* .. */</span>
<a name="l00391"></a>00391         }
<a name="l00392"></a>00392         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!isdigit(LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>)) <span class="keywordflow">return</span> <span class="charliteral">'.'</span>;
<a name="l00393"></a>00393         <span class="keywordflow">else</span> {
<a name="l00394"></a>00394           <a class="code" href="llex_8c.html#f26b854253f4e65a68c9025767cb44d8">read_numeral</a>(LS, 1, seminfo);
<a name="l00395"></a>00395           <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea370611aa50ca19b2d7bbbdc35de8dd8a3566">TK_NUMBER</a>;
<a name="l00396"></a>00396         }
<a name="l00397"></a>00397       }
<a name="l00398"></a>00398       <span class="keywordflow">case</span> <a class="code" href="lzio_8h.html#d6a3438bf06ea3922cb3ab3f5d505cf9">EOZ</a>: {
<a name="l00399"></a>00399         <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706d098fce4afd73fd61ac03701e376d70c">TK_EOS</a>;
<a name="l00400"></a>00400       }
<a name="l00401"></a>00401       <span class="keywordflow">default</span>: {
<a name="l00402"></a>00402         <span class="keywordflow">if</span> (isspace(LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>)) {
<a name="l00403"></a>00403           <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00404"></a>00404           <span class="keywordflow">continue</span>;
<a name="l00405"></a>00405         }
<a name="l00406"></a>00406         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isdigit(LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>)) {
<a name="l00407"></a>00407           <a class="code" href="llex_8c.html#f26b854253f4e65a68c9025767cb44d8">read_numeral</a>(LS, 0, seminfo);
<a name="l00408"></a>00408           <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea370611aa50ca19b2d7bbbdc35de8dd8a3566">TK_NUMBER</a>;
<a name="l00409"></a>00409         }
<a name="l00410"></a>00410         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isalpha(LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>) || LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a> == <span class="charliteral">'_'</span>) {
<a name="l00411"></a>00411           <span class="comment">/* identifier or reserved word */</span>
<a name="l00412"></a>00412           <span class="keywordtype">size_t</span> l = <a class="code" href="llex_8c.html#2d450d63d4527e25d7fc6d0ee3caf9c7">readname</a>(LS);
<a name="l00413"></a>00413           <a class="code" href="unionTString.html">TString</a> *ts = <a class="code" href="lstring_8c.html#63764b86a26ae664d57e9e8e546f3729">luaS_newlstr</a>(LS-&gt;<a class="code" href="structLexState.html#246330fb40f867efd283df9d770cbc91">L</a>, <a class="code" href="lzio_8h.html#8452a6574c720d56368e0d01147a8ff8">luaZ_buffer</a>(LS-&gt;<a class="code" href="structLexState.html#8c1e40147b887dfacafaecad027ea428">buff</a>), l);
<a name="l00414"></a>00414           <span class="keywordflow">if</span> (ts-&gt;<a class="code" href="unionTString.html#5b5f3aab62cfc3aeaae8c437156d62b1">tsv</a>.<a class="code" href="unionTString.html#d5f46597f3f42f40362c9970e3183134">reserved</a> &gt; 0)  <span class="comment">/* reserved word? */</span>
<a name="l00415"></a>00415             <span class="keywordflow">return</span> ts-&gt;<a class="code" href="unionTString.html#5b5f3aab62cfc3aeaae8c437156d62b1">tsv</a>.<a class="code" href="unionTString.html#d5f46597f3f42f40362c9970e3183134">reserved</a> - 1 + <a class="code" href="llex_8h.html#879bc134fd18ed5e313b7811f8cbfcbc">FIRST_RESERVED</a>;
<a name="l00416"></a>00416           seminfo-&gt;<a class="code" href="unionSemInfo.html#896c42bfe6c5f6d3d0a53b6dd49a1a27">ts</a> = ts;
<a name="l00417"></a>00417           <span class="keywordflow">return</span> <a class="code" href="llex_8h.html#52114b9f7f613784ebe09e8d3fea3706fda51513df891a39681d90039ecbde7b">TK_NAME</a>;
<a name="l00418"></a>00418         }
<a name="l00419"></a>00419         <span class="keywordflow">else</span> {
<a name="l00420"></a>00420           <span class="keywordtype">int</span> c = LS-&gt;<a class="code" href="structLexState.html#7657cc70fafeadab6f9864592887a8d1">current</a>;
<a name="l00421"></a>00421           <span class="keywordflow">if</span> (iscntrl(c))
<a name="l00422"></a>00422             <a class="code" href="llex_8c.html#af2041ad98462a8d8bd73a16de087356">luaX_error</a>(LS, <span class="stringliteral">"invalid control char"</span>,
<a name="l00423"></a>00423                            <a class="code" href="lobject_8c.html#4c19cabd9ff2d10824ec51b2b331fd39">luaO_pushfstring</a>(LS-&gt;L, <span class="stringliteral">"char(%d)"</span>, c));
<a name="l00424"></a>00424           <a class="code" href="llex_8c.html#f55fa8f513a47b3ba8e7b575418e6d9e">next</a>(LS);
<a name="l00425"></a>00425           <span class="keywordflow">return</span> c;  <span class="comment">/* single-char tokens (+ - / ...) */</span>
<a name="l00426"></a>00426         }
<a name="l00427"></a>00427       }
<a name="l00428"></a>00428     }
<a name="l00429"></a>00429   }
<a name="l00430"></a>00430 }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432 <span class="preprocessor">#undef next</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:54 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
