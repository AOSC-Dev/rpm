<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: build/reqprov.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>build/reqprov.c</h1><a href="reqprov_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include "<a class="code" href="rpmbuild_8h.html" title="This is the *only* module users of librpmbuild should need to include.">rpmbuild.h</a>"</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00010"></a>00010 
<a name="l00011"></a><a class="code" href="group__rpmbuild.html#gb2b9e4e91ceb4222ef46d87631054d77">00011</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmbuild.html#gb2b9e4e91ceb4222ef46d87631054d77" title="Add dependency to header, filtering duplicates.">addReqProv</a>(<span class="comment">/*@unused@*/</span> <a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec, <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <span class="comment">/*@unused@*/</span> <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> tagN,
<a name="l00012"></a>00012                 <span class="keyword">const</span> <span class="keywordtype">char</span> * N, <span class="keyword">const</span> <span class="keywordtype">char</span> * EVR, <a class="code" href="rpmlib_8h.html#59d9132cc8d54f9ff20570cc67438071" title="Dependency Attributes.">rpmsenseFlags</a> Flags,
<a name="l00013"></a>00013                 <span class="keywordtype">int</span> index)
<a name="l00014"></a>00014 {
<a name="l00015"></a>00015     <a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a> hge = (<a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a>)<a class="code" href="group__header.html#g29996e73fee54b49b34246121494cbf1" title="Retrieve tag value using header internal array.">headerGetEntryMinMemory</a>;
<a name="l00016"></a>00016     <a class="code" href="rpmlib_8h.html#b1e25001ce073d55e9fa97a3ad2213e8" title="Prototype for headerFreeData() vector.">HFD_t</a> hfd = <a class="code" href="group__header.html#ga2c977519b09cb7bf16f9765ec29d079" title="Free data allocated when retrieved from header.">headerFreeData</a>;
<a name="l00017"></a>00017     <span class="keyword">const</span> <span class="keywordtype">char</span> ** <a class="code" href="structnames.html">names</a>;
<a name="l00018"></a>00018     <a class="code" href="group__header.html#g30546f70b72fe13929f6e388dfd29b16" title="The basic types of data in tags from headers.">rpmTagType</a> dnt;
<a name="l00019"></a>00019     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> nametag = 0;
<a name="l00020"></a>00020     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> versiontag = 0;
<a name="l00021"></a>00021     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> flagtag = 0;
<a name="l00022"></a>00022     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> indextag = 0;
<a name="l00023"></a>00023     <span class="keywordtype">int</span> len;
<a name="l00024"></a>00024     <a class="code" href="rpmlib_8h.html#59d9132cc8d54f9ff20570cc67438071" title="Dependency Attributes.">rpmsenseFlags</a> extra = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095cc820446dae032500d79201d59b1d824">RPMSENSE_ANY</a>;
<a name="l00025"></a>00025     <span class="keywordtype">int</span> xx;
<a name="l00026"></a>00026     
<a name="l00027"></a>00027     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270953bf45f6629498a93a815b84dfa0a3bcf">RPMSENSE_PROVIDES</a>) {
<a name="l00028"></a>00028         nametag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>;
<a name="l00029"></a>00029         versiontag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>;
<a name="l00030"></a>00030         flagtag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>;
<a name="l00031"></a>00031         extra = Flags &amp; <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095dbd5b2fcf70d1ef8863e13c9b8fe9da2">RPMSENSE_FIND_PROVIDES</a>;
<a name="l00032"></a>00032     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b2709511304d5fb8cc9556826c8a10643018e8">RPMSENSE_OBSOLETES</a>) {
<a name="l00033"></a>00033         nametag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591b4aea8941447979f094490786cd123f2">RPMTAG_OBSOLETENAME</a>;
<a name="l00034"></a>00034         versiontag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335919ce8eb8b8d020404a89c143702b1d0f2">RPMTAG_OBSOLETEVERSION</a>;
<a name="l00035"></a>00035         flagtag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910530bb31e4ac82ce3420877ae4d804da">RPMTAG_OBSOLETEFLAGS</a>;
<a name="l00036"></a>00036     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095ff9f00c850b90355dbee15ce798ed945">RPMSENSE_CONFLICTS</a>) {
<a name="l00037"></a>00037         nametag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591ff092fdc32a41f427c85147b5d398f01">RPMTAG_CONFLICTNAME</a>;
<a name="l00038"></a>00038         versiontag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910c673289c984893c8faa002c61738b25">RPMTAG_CONFLICTVERSION</a>;
<a name="l00039"></a>00039         flagtag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335916eaf5be45f3dc264b228280e42e0208a">RPMTAG_CONFLICTFLAGS</a>;
<a name="l00040"></a>00040     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095fb0834643e81a8f0c9859fb173361f3d">RPMSENSE_PREREQ</a>) {
<a name="l00041"></a>00041         nametag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>;
<a name="l00042"></a>00042         versiontag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910b5bfa4be0f375cd3d8f6e778a7827ef">RPMTAG_REQUIREVERSION</a>;
<a name="l00043"></a>00043         flagtag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>;
<a name="l00044"></a>00044         extra = Flags &amp; <a class="code" href="rpmlib_8h.html#6faab8aa54ea37822e0f3c6bd5da551b">_ALL_REQUIRES_MASK</a>;
<a name="l00045"></a>00045     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="rpmlib_8h.html#a838ee87cf6d5af67148f6179760d724">RPMSENSE_TRIGGER</a>) {
<a name="l00046"></a>00046         nametag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591965d9f601733399f29bcf9f40b0e72b0">RPMTAG_TRIGGERNAME</a>;
<a name="l00047"></a>00047         versiontag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d966d913992b20fb715d25a59a169ea4">RPMTAG_TRIGGERVERSION</a>;
<a name="l00048"></a>00048         flagtag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591947252beb36a2f39551378231f93ef36">RPMTAG_TRIGGERFLAGS</a>;
<a name="l00049"></a>00049         indextag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591133412f31234ebf8e275efa30561cf1b">RPMTAG_TRIGGERINDEX</a>;
<a name="l00050"></a>00050         extra = Flags &amp; RPMSENSE_TRIGGER;
<a name="l00051"></a>00051     } <span class="keywordflow">else</span> {
<a name="l00052"></a>00052         nametag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>;
<a name="l00053"></a>00053         versiontag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910b5bfa4be0f375cd3d8f6e778a7827ef">RPMTAG_REQUIREVERSION</a>;
<a name="l00054"></a>00054         flagtag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>;
<a name="l00055"></a>00055         extra = Flags &amp; <a class="code" href="rpmlib_8h.html#6faab8aa54ea37822e0f3c6bd5da551b">_ALL_REQUIRES_MASK</a>;
<a name="l00056"></a>00056     }
<a name="l00057"></a>00057 
<a name="l00058"></a>00058     Flags = (Flags &amp; <a class="code" href="rpmlib_8h.html#8baa9e28c748975cd6672a36e5d8e23d">RPMSENSE_SENSEMASK</a>) | extra;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     <span class="comment">/*@-branchstate@*/</span>
<a name="l00061"></a>00061     <span class="keywordflow">if</span> (EVR == NULL)
<a name="l00062"></a>00062         EVR = <span class="stringliteral">""</span>;
<a name="l00063"></a>00063     <span class="comment">/*@=branchstate@*/</span>
<a name="l00064"></a>00064     
<a name="l00065"></a>00065     <span class="comment">/* Check for duplicate dependencies. */</span>
<a name="l00066"></a>00066     <span class="keywordflow">if</span> (hge(h, nametag, &amp;dnt, (<span class="keywordtype">void</span> **) &amp;names, &amp;len)) {
<a name="l00067"></a>00067         <span class="keyword">const</span> <span class="keywordtype">char</span> ** versions = NULL;
<a name="l00068"></a>00068         <a class="code" href="group__header.html#g30546f70b72fe13929f6e388dfd29b16" title="The basic types of data in tags from headers.">rpmTagType</a> dvt = <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>;
<a name="l00069"></a>00069         <span class="keywordtype">int</span> *flags = NULL;
<a name="l00070"></a>00070         <span class="keywordtype">int</span> *indexes = NULL;
<a name="l00071"></a>00071         <span class="keywordtype">int</span> duplicate = 0;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073         <span class="keywordflow">if</span> (flagtag) {
<a name="l00074"></a>00074             xx = hge(h, versiontag, &amp;dvt, (<span class="keywordtype">void</span> **) &amp;versions, NULL);
<a name="l00075"></a>00075             xx = hge(h, flagtag, NULL, (<span class="keywordtype">void</span> **) &amp;flags, NULL);
<a name="l00076"></a>00076         }
<a name="l00077"></a>00077         <span class="keywordflow">if</span> (indextag)
<a name="l00078"></a>00078             xx = hge(h, indextag, NULL, (<span class="keywordtype">void</span> **) &amp;indexes, NULL);
<a name="l00079"></a>00079 
<a name="l00080"></a>00080 <span class="comment">/*@-boundsread@*/</span>
<a name="l00081"></a>00081         <span class="keywordflow">while</span> (len &gt; 0) {
<a name="l00082"></a>00082             len--;
<a name="l00083"></a>00083             <span class="keywordflow">if</span> (strcmp(names[len], N))
<a name="l00084"></a>00084                 <span class="keywordflow">continue</span>;
<a name="l00085"></a>00085             <span class="keywordflow">if</span> (flagtag &amp;&amp; versions != NULL &amp;&amp;
<a name="l00086"></a>00086                 (strcmp(versions[len], EVR) || flags[len] != Flags))
<a name="l00087"></a>00087                 <span class="keywordflow">continue</span>;
<a name="l00088"></a>00088             <span class="keywordflow">if</span> (indextag &amp;&amp; indexes != NULL &amp;&amp; indexes[len] != index)
<a name="l00089"></a>00089                 <span class="keywordflow">continue</span>;
<a name="l00090"></a>00090 
<a name="l00091"></a>00091             <span class="comment">/* This is a duplicate dependency. */</span>
<a name="l00092"></a>00092             duplicate = 1;
<a name="l00093"></a>00093 
<a name="l00094"></a>00094             <span class="keywordflow">break</span>;
<a name="l00095"></a>00095         }
<a name="l00096"></a>00096 <span class="comment">/*@=boundsread@*/</span>
<a name="l00097"></a>00097         names = hfd(names, dnt);
<a name="l00098"></a>00098         versions = hfd(versions, dvt);
<a name="l00099"></a>00099         <span class="keywordflow">if</span> (duplicate)
<a name="l00100"></a>00100             <span class="keywordflow">return</span> 0;
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103     <span class="comment">/* Add this dependency. */</span>
<a name="l00104"></a>00104     xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, nametag, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>, &amp;N, 1);
<a name="l00105"></a>00105     <span class="keywordflow">if</span> (flagtag) {
<a name="l00106"></a>00106         xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, versiontag,
<a name="l00107"></a>00107                                <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>, &amp;EVR, 1);
<a name="l00108"></a>00108         xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, flagtag,
<a name="l00109"></a>00109                                <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>, &amp;Flags, 1);
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111     <span class="keywordflow">if</span> (indextag)
<a name="l00112"></a>00112         xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, indextag, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>, &amp;index, 1);
<a name="l00113"></a>00113 
<a name="l00114"></a>00114     <span class="keywordflow">return</span> 0;
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a>00117 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00118"></a><a class="code" href="group__rpmbuild.html#g9caff7daba6598c0896127b7b48eb52e">00118</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmbuild.html#g9caff7daba6598c0896127b7b48eb52e" title="Add rpmlib feature dependency.">rpmlibNeedsFeature</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <span class="keyword">const</span> <span class="keywordtype">char</span> * feature, <span class="keyword">const</span> <span class="keywordtype">char</span> * featureEVR)
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120     <span class="keywordtype">char</span> * reqname = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(<span class="keyword">sizeof</span>(<span class="stringliteral">"rpmlib()"</span>) + strlen(feature));
<a name="l00121"></a>00121 
<a name="l00122"></a>00122     (void) <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(reqname, <span class="stringliteral">"rpmlib("</span>), feature), <span class="stringliteral">")"</span>);
<a name="l00123"></a>00123 
<a name="l00124"></a>00124     <span class="comment">/* XXX 1st arg is unused */</span>
<a name="l00125"></a>00125    <span class="keywordflow">return</span> <a class="code" href="group__rpmbuild.html#gb2b9e4e91ceb4222ef46d87631054d77" title="Add dependency to header, filtering duplicates.">addReqProv</a>(NULL, h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, reqname, featureEVR,
<a name="l00126"></a>00126         <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095885ce24fb4e9a92be55275f533362f76">RPMSENSE_RPMLIB</a>|(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095e22dbb27e00aad5fb0295e17620b2690">RPMSENSE_LESS</a>|<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a>), 0);
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 <span class="comment">/*@=boundswrite@*/</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:53 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
