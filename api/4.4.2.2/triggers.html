<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: Trigger scriptlets</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<h1><a class="anchor" name="triggers">Trigger scriptlets</a></h1>Triggers provide a well-defined method for packages to interact with one another at package install and uninstall time. They are an extension of the normal installation scripts (i.e. pre) which allows one package (the "source" of the trigger package [which I often think of as the "triggered package"]) to execute an action when the installation status of another package (the "target" of the trigger) changes.<p>
Say the package "mymailer" needs an /etc/mymailer/mailer symlink which points to the mail transport agent to use. If sendmail is installed, the <a class="el" href="structlink.html">link</a> should point to /usr/bin/sendmail, but it vmail is installed, the <a class="el" href="structlink.html">link</a> should instead point to /usr/bin/vmail. If both packages are present, we don't care where the <a class="el" href="structlink.html">link</a> points (realistically, sendmail and vmail should conflict with one another), while if neither package is installed the <a class="el" href="structlink.html">link</a> should not exist at all.<p>
This can be accomplished by mymailer providing trigger scripts which move the symlink when any of the following occurs:<p>
<div class="fragment"><pre class="fragment">
	1) sendmail is installed
	2) vmail is installed
	3) sendmail is removed
	4) vmail is removed
</pre></div><p>
The first two of these scripts would look like this:<p>
<div class="fragment"><pre class="fragment">
	%triggerin -- sendmail
	ln -sf /usr/bin/sendmail /etc/mymailer/mailer

	%triggerin -- vmail
	ln -sf /usr/bin/vmail /etc/mymailer/mailer
</pre></div><p>
These are two installation triggers, triggered by one of sendmail or vmail. They are run when:<p>
<div class="fragment"><pre class="fragment">
	1) mymailer is already installed, and sendmail is installed or
	   upgraded
	2) mymailer is already installed, and vmail is installed or
	   upgraded
	3) sendmail is already installed, and mymailer is installed or
	   upgraded
	4) vmail is already installed, and mymailer is installed or
	   upgraded
</pre></div><p>
For the upgrading, the strategy is a little different. Rather then setting the <a class="el" href="structlink.html">link</a> to point to the trigger, the <a class="el" href="structlink.html">link</a> is set to point to the *other* mailer (if it exists), as follows:<p>
<div class="fragment"><pre class="fragment">
	%triggerun -- sendmail
	[ $2 = 0 ] || exit 0
	if [ -f /usr/bin/vmail ]; then
		ln -sf /usr/bin/vmail /etc/mymailer/mailer
	else
		rm -f /etc/mymailer/mailer

	fi

	%triggerun -- vmail
	[ $2 = 0 ] || exit 0
	if [ -f /usr/bin/sendmail ]; then
		ln -sf /usr/bin/sendmail /etc/mymailer/mailer
	else
		rm -f /etc/mymailer/mailer

	fi

	%postun
	[ $1 = 0 ] &amp;&amp; rm -f /etc/mymailer/mailer
</pre></div><p>
These trigger scripts get run when:<p>
<div class="fragment"><pre class="fragment">
	1) sendmail is installed, and mymailer is removed
	2) vmail is installed, and mymailer is removed
	3) mymailer is installed, and sendmail gets removed
	4) mymailer is installed, and vmail gets removed
</pre></div><p>
The postun insures that /etc/mymailer/mailer is removed when mymailer is removed (triggers get run at the same time as preun scripts, so doing this in the postun is safe). Note that the triggers are testing $2 to see if any action should occur. Recall that the $1 passed to regular scripts contains the number of instances of the package which will be installed when the operation has completed. $1 for triggers is exactly the same -- it is the number of instances of the source (or triggered) package which will remain when the trigger has completed. Similarly, $2 is the number of instances of the target package which will remain. In this case, if any of the targets will remain after the uninstall, the trigger doesn't do anything (as it's probably being triggered by an upgrade).<p>
Trigger specifications are of the form:<p>
<div class="fragment"><pre class="fragment">
	%trigger{un|in|postun} [[-n] &lt;subpackage&gt;] [-p &lt;program&gt;] -- &lt;trigger&gt;
</pre></div><p>
The -n and -p arguments are the same as for post scripts. The &lt;trigger&gt; portion is syntactically equivalent to a "Requires" specification (version numbers may be used). If multiple items are given (comma separated), the trigger is run when *any* of those conditions becomes true (the , can be read as "or"). For example:<p>
<div class="fragment"><pre class="fragment">
	%triggerin -n package -p /usr/bin/perl -- fileutils &gt; 3.0, perl &lt; 1.2
	print "I'm in my trigger!\n";
</pre></div><p>
Will put a trigger in package 'package' which runs when the installation status of either fileutils &gt; 3.0 or perl &lt; 1.2 is changed. The script will be run through /usr/bin/perl rather then /bin/sh (which is the default).<p>
There is one other type of trigger available -- triggerpostun. These are triggers that are run after their target package has been removed; they will never be run when the package containing the trigger is removed.<p>
While this type of trigger is almost never useful, they allow a package to fix errors introduced by the postun of another package (or by an earlier version of that package).<p>
For reference, here's the order in which scripts are executed on a single package upgrade:<p>
<div class="fragment"><pre class="fragment">
  new-%pre	for new version of package being installed
  ...		(all new files are installed)
  new-%post	for new version of package being installed

  any-%triggerin (%triggerin from other packages set off by new install)
  new-%triggerin
  old-%triggerun
  any-%triggerun (%triggerun from other packages set off by old uninstall)

  old-%preun	for old version of package being removed
  ...		(all old files are removed)
  old-%postun	for old version of package being removed

  old-%triggerpostun
  any-%triggerpostun (%triggerpostun from other packages set off by old un
		install)
</pre></div> <hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:57 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
