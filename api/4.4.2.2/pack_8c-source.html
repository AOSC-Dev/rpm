<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: build/pack.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>build/pack.c</h1><a href="pack_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;<a class="code" href="rpmio__internal_8h.html">rpmio_internal.h</a>&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;<a class="code" href="rpmbuild_8h.html" title="This is the *only* module users of librpmbuild should need to include.">rpmbuild.h</a>&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="rpmps_8h.html" title="Structures and prototypes used for an "rpmps" problem set.">rpmps.h</a>"</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="cpio_8h.html" title="Structures used to handle cpio payloads within rpm packages.">cpio.h</a>"</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="fsm_8h.html" title="File state machine to handle a payload within an rpm package.">fsm.h</a>"</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="psm_8h.html" title="Package state machine to handle a package from a transaction set.">psm.h</a>"</span>
<a name="l00016"></a>00016 
<a name="l00017"></a><a class="code" href="pack_8c.html#23b390a0b6abdc14c30d53d89a40fd7f">00017</a> <span class="preprocessor">#define _RPMFI_INTERNAL         </span><span class="comment">/* XXX fi-&gt;fsm */</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include "<a class="code" href="rpmfi_8h.html" title="Structure(s) used for file info tag sets.">rpmfi.h</a>"</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include "<a class="code" href="rpmts_8h.html" title="Structures and prototypes used for an "rpmts" transaction set.">rpmts.h</a>"</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="buildio_8h.html" title="Routines to read and write packages.">buildio.h</a>"</span>
<a name="l00022"></a>00022 
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="legacy_8h.html">legacy.h</a>"</span>     <span class="comment">/* XXX providePackageNVR */</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="signature_8h.html" title="Generate and verify signatures.">signature.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="rpmlead_8h.html" title="Routines to read and write an rpm lead structure for a a package.">rpmlead.h</a>"</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/*@access rpmts @*/</span>
<a name="l00029"></a>00029 <span class="comment">/*@access rpmfi @*/</span>     <span class="comment">/* compared with NULL */</span>
<a name="l00030"></a>00030 <span class="comment">/*@access Header @*/</span>    <span class="comment">/* compared with NULL */</span>
<a name="l00031"></a>00031 <span class="comment">/*@access FD_t @*/</span>      <span class="comment">/* compared with NULL */</span>
<a name="l00032"></a>00032 <span class="comment">/*@access StringBuf @*/</span> <span class="comment">/* compared with NULL */</span>
<a name="l00033"></a>00033 <span class="comment">/*@access CSA_t @*/</span>
<a name="l00034"></a>00034 
<a name="l00037"></a><a class="code" href="pack_8c.html#1aaf62bc9b13b7d870536baa37cd4344">00037</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#1aaf62bc9b13b7d870536baa37cd4344">genSourceRpmName</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec)
<a name="l00038"></a>00038         <span class="comment">/*@modifies spec-&gt;sourceRpmName @*/</span>
<a name="l00039"></a>00039 {
<a name="l00040"></a>00040     <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="structSpec__s.html#6ed780920ce83bf828282dbbb104ddb2">sourceRpmName</a> == NULL) {
<a name="l00041"></a>00041         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structname.html">name</a>, *version, *release;
<a name="l00042"></a>00042         <span class="keywordtype">char</span> fileName[BUFSIZ];
<a name="l00043"></a>00043 
<a name="l00044"></a>00044         (void) <a class="code" href="group__header.html#g53462b3c5298a60fa2a43162deb4f41a" title="Return name, version, release strings from header.">headerNVR</a>(spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a>-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, &amp;name, &amp;version, &amp;release);
<a name="l00045"></a>00045         sprintf(fileName, <span class="stringliteral">"%s-%s-%s.%ssrc.rpm"</span>, name, version, release,
<a name="l00046"></a>00046             spec-&gt;<a class="code" href="structSpec__s.html#d45cb391c7d503d8988d31bfa444ea36">noSource</a> ? <span class="stringliteral">"no"</span> : <span class="stringliteral">""</span>);
<a name="l00047"></a>00047         spec-&gt;<a class="code" href="structSpec__s.html#6ed780920ce83bf828282dbbb104ddb2">sourceRpmName</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fileName);
<a name="l00048"></a>00048     }
<a name="l00049"></a>00049 
<a name="l00050"></a>00050     <span class="keywordflow">return</span> 0;
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00056"></a><a class="code" href="pack_8c.html#560327b8e3f9ef3344516ff95a720b01">00056</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#560327b8e3f9ef3344516ff95a720b01">cpio_doio</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fdo, <span class="comment">/*@unused@*/</span> <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <a class="code" href="structcpioSourceArchive__s.html">CSA_t</a> csa,
<a name="l00057"></a>00057                 <span class="keyword">const</span> <span class="keywordtype">char</span> * fmodeMacro)
<a name="l00058"></a>00058         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00059"></a>00059         <span class="comment">/*@modifies fdo, csa, rpmGlobalMacroContext,</span>
<a name="l00060"></a>00060 <span class="comment">                fileSystem, internalState @*/</span>
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062     <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="group__rpmts.html#gea8dfc313aaafce2c6e9ee3caabce8b5" title="Create an empty transaction set.">rpmtsCreate</a>();
<a name="l00063"></a>00063     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#7f22220153ce631ff8176f5462cd8e5c">cpioList</a>;
<a name="l00064"></a>00064     <span class="keyword">const</span> <span class="keywordtype">char</span> *failedFile = NULL;
<a name="l00065"></a>00065     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> cfd;
<a name="l00066"></a>00066     <span class="keywordtype">int</span> rc, ec;
<a name="l00067"></a>00067 
<a name="l00068"></a>00068 <span class="comment">/*@-boundsread@*/</span>
<a name="l00069"></a>00069     {   <span class="keyword">const</span> <span class="keywordtype">char</span> *fmode = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(fmodeMacro, NULL);
<a name="l00070"></a>00070         <span class="keywordflow">if</span> (!(fmode &amp;&amp; fmode[0] == <span class="charliteral">'w'</span>))
<a name="l00071"></a>00071             fmode = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(<span class="stringliteral">"w9.gzdio"</span>);
<a name="l00072"></a>00072         <span class="comment">/*@-nullpass@*/</span>
<a name="l00073"></a>00073         (void) <a class="code" href="rpmio_8c.html#151331b54e01d3b4ebe94382603ad609" title="fflush(3) clone.">Fflush</a>(fdo);
<a name="l00074"></a>00074         cfd = <a class="code" href="rpmio_8c.html#43d8e90a91a7bb3b9873be26b2e7b6a3">Fdopen</a>(<a class="code" href="rpmio_8c.html#671e4056425535bd1421347a5bcdacf9">fdDup</a>(<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(fdo)), fmode);
<a name="l00075"></a>00075         <span class="comment">/*@=nullpass@*/</span>
<a name="l00076"></a>00076         fmode = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fmode);
<a name="l00077"></a>00077     }
<a name="l00078"></a>00078 <span class="comment">/*@=boundsread@*/</span>
<a name="l00079"></a>00079     <span class="keywordflow">if</span> (cfd == NULL)
<a name="l00080"></a>00080         <span class="keywordflow">return</span> 1;
<a name="l00081"></a>00081 
<a name="l00082"></a>00082     rc = <a class="code" href="fsm_8c.html#6e6fb0ed805d1c2d07ede70f4947dcef" title="Load external data into file state machine.">fsmSetup</a>(fi-&gt;fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>, ts, fi, cfd,
<a name="l00083"></a>00083                 &amp;csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#0847e30f0352f0f43065460e7063c168">cpioArchiveSize</a>, &amp;failedFile);
<a name="l00084"></a>00084     (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(cfd);
<a name="l00085"></a>00085     ec = <a class="code" href="fsm_8c.html#0c1d23991daeaa4b7adddf3901cc6f01" title="Clean file state machine.">fsmTeardown</a>(fi-&gt;fsm);
<a name="l00086"></a>00086     <span class="keywordflow">if</span> (!rc) rc = ec;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (rc) {
<a name="l00089"></a>00089         <span class="keywordflow">if</span> (failedFile)
<a name="l00090"></a>00090             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae7bd348a35cf29f1d3ed20b2c0ad9831">RPMERR_CPIO</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"create archive failed on file %s: %s\n"</span>),
<a name="l00091"></a>00091                 failedFile, <a class="code" href="group__payload.html#g662f242398346a77fd1d9933053f11ac" title="Return formatted error message on payload handling failure.">cpioStrerror</a>(rc));
<a name="l00092"></a>00092         <span class="keywordflow">else</span>
<a name="l00093"></a>00093             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(RPMERR_CPIO, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"create archive failed: %s\n"</span>),
<a name="l00094"></a>00094                 <a class="code" href="group__payload.html#g662f242398346a77fd1d9933053f11ac" title="Return formatted error message on payload handling failure.">cpioStrerror</a>(rc));
<a name="l00095"></a>00095       rc = 1;
<a name="l00096"></a>00096     }
<a name="l00097"></a>00097 
<a name="l00098"></a>00098     failedFile = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(failedFile);
<a name="l00099"></a>00099     ts = <a class="code" href="group__rpmts.html#g95515319c5194d997d6cb84a1e1938c2" title="Destroy transaction set, closing the database as well.">rpmtsFree</a>(ts);
<a name="l00100"></a>00100 
<a name="l00101"></a>00101     <span class="keywordflow">return</span> rc;
<a name="l00102"></a>00102 }
<a name="l00103"></a>00103 
<a name="l00106"></a><a class="code" href="pack_8c.html#3d6da85450cf84b241341a5d3ce614fd">00106</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#3d6da85450cf84b241341a5d3ce614fd">cpio_copy</a>(<a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fdo, <a class="code" href="structcpioSourceArchive__s.html">CSA_t</a> csa)
<a name="l00107"></a>00107         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l00108"></a>00108         <span class="comment">/*@modifies fdo, csa, fileSystem, internalState @*/</span>
<a name="l00109"></a>00109 {
<a name="l00110"></a>00110     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00111"></a>00111     <span class="keywordtype">size_t</span> nb;
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="keywordflow">while</span>((nb = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(buf, <span class="keyword">sizeof</span>(buf[0]), <span class="keyword">sizeof</span>(buf), csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>)) &gt; 0) {
<a name="l00114"></a>00114         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#0b66d10b5a0e926d57e86327f4e9dcc6" title="fwrite(3) clone.">Fwrite</a>(buf, <span class="keyword">sizeof</span>(buf[0]), nb, fdo) != nb) {
<a name="l00115"></a>00115             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae7bd348a35cf29f1d3ed20b2c0ad9831">RPMERR_CPIO</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"cpio_copy write failed: %s\n"</span>),
<a name="l00116"></a>00116                         <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fdo));
<a name="l00117"></a>00117             <span class="keywordflow">return</span> 1;
<a name="l00118"></a>00118         }
<a name="l00119"></a>00119         csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#0847e30f0352f0f43065460e7063c168">cpioArchiveSize</a> += nb;
<a name="l00120"></a>00120     }
<a name="l00121"></a>00121     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>)) {
<a name="l00122"></a>00122         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae7bd348a35cf29f1d3ed20b2c0ad9831">RPMERR_CPIO</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"cpio_copy read failed: %s\n"</span>),
<a name="l00123"></a>00123                 <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>));
<a name="l00124"></a>00124         <span class="keywordflow">return</span> 1;
<a name="l00125"></a>00125     }
<a name="l00126"></a>00126     <span class="keywordflow">return</span> 0;
<a name="l00127"></a>00127 }
<a name="l00128"></a>00128 
<a name="l00131"></a><a class="code" href="pack_8c.html#c1b9667325a7fa7de0a01c78cb449f1b">00131</a> <span class="keyword">static</span> <span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span> <a class="code" href="structStringBufRec.html">StringBuf</a> <a class="code" href="pack_8c.html#c1b9667325a7fa7de0a01c78cb449f1b">addFileToTagAux</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec,
<a name="l00132"></a>00132                 <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <span class="comment">/*@only@*/</span> <a class="code" href="structStringBufRec.html">StringBuf</a> sb)
<a name="l00133"></a>00133         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00134"></a>00134         <span class="comment">/*@modifies rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00137"></a>00137     <span class="keyword">const</span> <span class="keywordtype">char</span> * fn = buf;
<a name="l00138"></a>00138     FILE * f;
<a name="l00139"></a>00139     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     fn = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(<span class="stringliteral">"%{_builddir}/%{?buildsubdir:%{buildsubdir}/}"</span>, file, NULL);
<a name="l00142"></a>00142 
<a name="l00143"></a>00143     fd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fn, <span class="stringliteral">"r.ufdio"</span>);
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (fn != buf) fn = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fn);
<a name="l00145"></a>00145     <span class="keywordflow">if</span> (fd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd)) {
<a name="l00146"></a>00146         sb = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb);
<a name="l00147"></a>00147         <span class="keywordflow">return</span> NULL;
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <span class="comment">/*@-type@*/</span> <span class="comment">/* FIX: cast? */</span>
<a name="l00150"></a>00150     <span class="keywordflow">if</span> ((f = <a class="code" href="group__rpmio.html#g721f2ee7a9b2241f694f1b08e63f1590">fdGetFp</a>(fd)) != NULL)
<a name="l00151"></a>00151     <span class="comment">/*@=type@*/</span>
<a name="l00152"></a>00152     <span class="keywordflow">while</span> (fgets(buf, <span class="keyword">sizeof</span>(buf), f)) {
<a name="l00153"></a>00153         <span class="comment">/* XXX display fn in error msg */</span>
<a name="l00154"></a>00154         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#cada855232974c4a3985847565be312e" title="Expand macro into buffer.">expandMacros</a>(spec, spec-&gt;<a class="code" href="structSpec__s.html#a6ba79a7deb05c10860fc4870fd7434d">macros</a>, buf, <span class="keyword">sizeof</span>(buf))) {
<a name="l00155"></a>00155             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"line: %s\n"</span>), buf);
<a name="l00156"></a>00156             sb = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb);
<a name="l00157"></a>00157             <span class="keywordflow">break</span>;
<a name="l00158"></a>00158         }
<a name="l00159"></a>00159         <a class="code" href="stringbuf_8h.html#d0b42a09f04feb6aaf5fe853a1e35f8f">appendStringBuf</a>(sb, buf);
<a name="l00160"></a>00160     }
<a name="l00161"></a>00161     (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163     <span class="keywordflow">return</span> sb;
<a name="l00164"></a>00164 }
<a name="l00165"></a>00165 
<a name="l00168"></a><a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">00168</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <span class="keywordtype">int</span> tag)
<a name="l00169"></a>00169         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00170"></a>00170         <span class="comment">/*@modifies h, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00171"></a>00171 {
<a name="l00172"></a>00172     <a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a> hge = (<a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a>)<a class="code" href="group__header.html#g29996e73fee54b49b34246121494cbf1" title="Retrieve tag value using header internal array.">headerGetEntryMinMemory</a>;
<a name="l00173"></a>00173     <a class="code" href="structStringBufRec.html">StringBuf</a> sb = <a class="code" href="stringbuf_8c.html#7597277ee043fedfe21a058b32c08e0d">newStringBuf</a>();
<a name="l00174"></a>00174     <span class="keywordtype">char</span> *s;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176     <span class="keywordflow">if</span> (hge(h, tag, NULL, (<span class="keywordtype">void</span> **)&amp;s, NULL)) {
<a name="l00177"></a>00177         <a class="code" href="stringbuf_8h.html#ece7923b4b1b19fdc5b99ec7a8856360">appendLineStringBuf</a>(sb, s);
<a name="l00178"></a>00178         (void) <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(h, tag);
<a name="l00179"></a>00179     }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="keywordflow">if</span> ((sb = <a class="code" href="pack_8c.html#c1b9667325a7fa7de0a01c78cb449f1b">addFileToTagAux</a>(spec, file, sb)) == NULL)
<a name="l00182"></a>00182         <span class="keywordflow">return</span> 1;
<a name="l00183"></a>00183     
<a name="l00184"></a>00184     (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, tag, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, <a class="code" href="stringbuf_8c.html#fa51085c621ad9b0abc05c629a826440">getStringBuf</a>(sb), 1);
<a name="l00185"></a>00185 
<a name="l00186"></a>00186     sb = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb);
<a name="l00187"></a>00187     <span class="keywordflow">return</span> 0;
<a name="l00188"></a>00188 }
<a name="l00189"></a>00189 
<a name="l00192"></a><a class="code" href="pack_8c.html#2174248dc429bd12624c1f00b094e050">00192</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#2174248dc429bd12624c1f00b094e050">addFileToArrayTag</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <span class="keywordtype">int</span> tag)
<a name="l00193"></a>00193         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00194"></a>00194         <span class="comment">/*@modifies h, rpmGlobalMacroContext, fileSystem, internalState  @*/</span>
<a name="l00195"></a>00195 {
<a name="l00196"></a>00196     <a class="code" href="structStringBufRec.html">StringBuf</a> sb = <a class="code" href="stringbuf_8c.html#7597277ee043fedfe21a058b32c08e0d">newStringBuf</a>();
<a name="l00197"></a>00197     <span class="keywordtype">char</span> *s;
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="keywordflow">if</span> ((sb = <a class="code" href="pack_8c.html#c1b9667325a7fa7de0a01c78cb449f1b">addFileToTagAux</a>(spec, file, sb)) == NULL)
<a name="l00200"></a>00200         <span class="keywordflow">return</span> 1;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     s = <a class="code" href="stringbuf_8c.html#fa51085c621ad9b0abc05c629a826440">getStringBuf</a>(sb);
<a name="l00203"></a>00203     (void) <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, tag, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>, &amp;s, 1);
<a name="l00204"></a>00204 
<a name="l00205"></a>00205     sb = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb);
<a name="l00206"></a>00206     <span class="keywordflow">return</span> 0;
<a name="l00207"></a>00207 }
<a name="l00208"></a>00208 
<a name="l00211"></a><a class="code" href="pack_8c.html#51b39a5825912b06c814123cb6fb26cd">00211</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#51b39a5825912b06c814123cb6fb26cd">processScriptFiles</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec, <a class="code" href="structPackage__s.html" title="The structure used to store values for a package.">Package</a> pkg)
<a name="l00212"></a>00212         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00213"></a>00213         <span class="comment">/*@modifies pkg-&gt;header, rpmGlobalMacroContext,</span>
<a name="l00214"></a>00214 <span class="comment">                fileSystem, internalState @*/</span>
<a name="l00215"></a>00215 {
<a name="l00216"></a>00216     <span class="keyword">struct </span><a class="code" href="structTriggerFileEntry.html">TriggerFileEntry</a> *p;
<a name="l00217"></a>00217     
<a name="l00218"></a>00218     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#b92ee209f1670231174077e52d18878f">preInFile</a>) {
<a name="l00219"></a>00219         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#b92ee209f1670231174077e52d18878f">preInFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335919ff63a36053806fa3b2e78bc0cc617be">RPMTAG_PREIN</a>)) {
<a name="l00220"></a>00220             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00221"></a>00221                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open PreIn file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#b92ee209f1670231174077e52d18878f">preInFile</a>);
<a name="l00222"></a>00222             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00223"></a>00223         }
<a name="l00224"></a>00224     }
<a name="l00225"></a>00225     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#2944211b7a9c8ec4df69b9711d37e22b">preUnFile</a>) {
<a name="l00226"></a>00226         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#2944211b7a9c8ec4df69b9711d37e22b">preUnFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915adc0889abdf630390e6e3ad8c0d6ca5">RPMTAG_PREUN</a>)) {
<a name="l00227"></a>00227             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00228"></a>00228                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open PreUn file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#2944211b7a9c8ec4df69b9711d37e22b">preUnFile</a>);
<a name="l00229"></a>00229             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00230"></a>00230         }
<a name="l00231"></a>00231     }
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#e790c6795b83076541861b8f38bfa7ba">preTransFile</a>) {
<a name="l00233"></a>00233         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#e790c6795b83076541861b8f38bfa7ba">preTransFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591a4d7dcbb7eaf2c56b5d72fa98e06ca64">RPMTAG_PRETRANS</a>)) {
<a name="l00234"></a>00234             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00235"></a>00235                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open PreIn file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#e790c6795b83076541861b8f38bfa7ba">preTransFile</a>);
<a name="l00236"></a>00236             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00237"></a>00237         }
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#b0b88d9cfa36b5c3299cb4ac38550e35">postInFile</a>) {
<a name="l00240"></a>00240         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#b0b88d9cfa36b5c3299cb4ac38550e35">postInFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359199fcdad58f670cbc79d016be0aad9e39">RPMTAG_POSTIN</a>)) {
<a name="l00241"></a>00241             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00242"></a>00242                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open PostIn file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#b0b88d9cfa36b5c3299cb4ac38550e35">postInFile</a>);
<a name="l00243"></a>00243             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00244"></a>00244         }
<a name="l00245"></a>00245     }
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#a76922c2a4f2bf881fcc6ab354160b6b">postUnFile</a>) {
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#a76922c2a4f2bf881fcc6ab354160b6b">postUnFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335913b7eaac160707fb71fd3b078f02c7920">RPMTAG_POSTUN</a>)) {
<a name="l00248"></a>00248             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00249"></a>00249                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open PostUn file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#a76922c2a4f2bf881fcc6ab354160b6b">postUnFile</a>);
<a name="l00250"></a>00250             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#b1d71c9c690bea00982d22ed6abef924">postTransFile</a>) {
<a name="l00254"></a>00254         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#b1d71c9c690bea00982d22ed6abef924">postTransFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d0bfaff63602e4c8a4e76e755602078f">RPMTAG_POSTTRANS</a>)) {
<a name="l00255"></a>00255             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00256"></a>00256                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open PostUn file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#b1d71c9c690bea00982d22ed6abef924">postTransFile</a>);
<a name="l00257"></a>00257             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00258"></a>00258         }
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260     <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#c6e6f617081a7bab3d0ef6b8c0938130">verifyFile</a>) {
<a name="l00261"></a>00261         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7fb8c758086c5aeac3317541c857313f">addFileToTag</a>(spec, pkg-&gt;<a class="code" href="structPackage__s.html#c6e6f617081a7bab3d0ef6b8c0938130">verifyFile</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>,
<a name="l00262"></a>00262                          <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591de13fe7a31fb26b80a3472ff4fed35a3">RPMTAG_VERIFYSCRIPT</a>)) {
<a name="l00263"></a>00263             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00264"></a>00264                      <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open VerifyScript file: %s\n"</span>), pkg-&gt;<a class="code" href="structPackage__s.html#c6e6f617081a7bab3d0ef6b8c0938130">verifyFile</a>);
<a name="l00265"></a>00265             <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00266"></a>00266         }
<a name="l00267"></a>00267     }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">for</span> (p = pkg-&gt;<a class="code" href="structPackage__s.html#b2cde5bdd0eabefb349d3ce0fe0a889d">triggerFiles</a>; p != NULL; p = p-&gt;<a class="code" href="structTriggerFileEntry.html#6152285c8b90c4324c0d0ff4a9350bf5">next</a>) {
<a name="l00270"></a>00270         (void) <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591a95f25bf3042073719b720e065909e67">RPMTAG_TRIGGERSCRIPTPROG</a>,
<a name="l00271"></a>00271                                <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>, &amp;(p-&gt;<a class="code" href="structTriggerFileEntry.html#23a20757e3298c88397a7b3a905273da">prog</a>), 1);
<a name="l00272"></a>00272         <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structTriggerFileEntry.html#e6edb81e46136ade6743c41fdb23a597">script</a>) {
<a name="l00273"></a>00273             (void) <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fa74e5332e1322fbbfc159b6439bd22f">RPMTAG_TRIGGERSCRIPTS</a>,
<a name="l00274"></a>00274                                    <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>, &amp;(p-&gt;<a class="code" href="structTriggerFileEntry.html#e6edb81e46136ade6743c41fdb23a597">script</a>), 1);
<a name="l00275"></a>00275         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structTriggerFileEntry.html#663d905a035b9600b11050eb39edd482">fileName</a>) {
<a name="l00276"></a>00276             <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#2174248dc429bd12624c1f00b094e050">addFileToArrayTag</a>(spec, p-&gt;<a class="code" href="structTriggerFileEntry.html#663d905a035b9600b11050eb39edd482">fileName</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>,
<a name="l00277"></a>00277                                   <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fa74e5332e1322fbbfc159b6439bd22f">RPMTAG_TRIGGERSCRIPTS</a>)) {
<a name="l00278"></a>00278                 <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,
<a name="l00279"></a>00279                          <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open Trigger script file: %s\n"</span>),
<a name="l00280"></a>00280                          p-&gt;<a class="code" href="structTriggerFileEntry.html#663d905a035b9600b11050eb39edd482">fileName</a>);
<a name="l00281"></a>00281                 <span class="keywordflow">return</span> RPMERR_BADFILENAME;
<a name="l00282"></a>00282             }
<a name="l00283"></a>00283         } <span class="keywordflow">else</span> {
<a name="l00284"></a>00284             <span class="comment">/* This is dumb.  When the header supports NULL string */</span>
<a name="l00285"></a>00285             <span class="comment">/* this will go away.                                  */</span>
<a name="l00286"></a>00286             <span class="keywordtype">char</span> *bull = <span class="stringliteral">""</span>;
<a name="l00287"></a>00287             (void) <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fa74e5332e1322fbbfc159b6439bd22f">RPMTAG_TRIGGERSCRIPTS</a>,
<a name="l00288"></a>00288                                    <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>, &amp;bull, 1);
<a name="l00289"></a>00289         }
<a name="l00290"></a>00290     }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     <span class="keywordflow">return</span> 0;
<a name="l00293"></a>00293 }
<a name="l00294"></a>00294 
<a name="l00295"></a>00295 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00296"></a><a class="code" href="pack_8c.html#0b1fbb2d33d98447ecb4facccb901765">00296</a> <span class="keywordtype">int</span> <a class="code" href="buildio_8h.html#0b1fbb2d33d98447ecb4facccb901765" title="Read rpm package components from file.">readRPM</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structTriggerFileEntry.html#663d905a035b9600b11050eb39edd482">fileName</a>, <a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> *specp, <span class="keyword">struct</span> <a class="code" href="structrpmlead.html" title="The lead data structure.">rpmlead</a> *lead,
<a name="l00297"></a>00297                 <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> *sigs, <a class="code" href="structcpioSourceArchive__s.html">CSA_t</a> csa)
<a name="l00298"></a>00298 {
<a name="l00299"></a>00299     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fdi;
<a name="l00300"></a>00300     <a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec;
<a name="l00301"></a>00301     <a class="code" href="rpmlib_8h.html#f1718b0bac61cc03eaf3e3cb02806fb3" title="Package read return codes.">rpmRC</a> rc;
<a name="l00302"></a>00302 
<a name="l00303"></a>00303     fdi = (fileName != NULL)
<a name="l00304"></a>00304         ? <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fileName, <span class="stringliteral">"r.ufdio"</span>)
<a name="l00305"></a>00305         : <a class="code" href="rpmio_8c.html#671e4056425535bd1421347a5bcdacf9">fdDup</a>(STDIN_FILENO);
<a name="l00306"></a>00306 
<a name="l00307"></a>00307     <span class="keywordflow">if</span> (fdi == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fdi)) {
<a name="l00308"></a>00308         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf1b99fca1f6fe3402cfce3ef10596473">RPMERR_BADMAGIC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"readRPM: open %s: %s\n"</span>),
<a name="l00309"></a>00309                 (fileName ? fileName : <span class="stringliteral">"&lt;stdin&gt;"</span>),
<a name="l00310"></a>00310                 <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fdi));
<a name="l00311"></a>00311         <span class="keywordflow">if</span> (fdi) (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fdi);
<a name="l00312"></a>00312         <span class="keywordflow">return</span> RPMERR_BADMAGIC;
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315     <span class="comment">/* Get copy of lead */</span>
<a name="l00316"></a>00316     <span class="comment">/*@-sizeoftype@*/</span>
<a name="l00317"></a>00317     <span class="keywordflow">if</span> ((rc = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(lead, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), <span class="keyword">sizeof</span>(*lead), fdi)) != <span class="keyword">sizeof</span>(*lead)) {
<a name="l00318"></a>00318         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf1b99fca1f6fe3402cfce3ef10596473">RPMERR_BADMAGIC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"readRPM: read %s: %s\n"</span>),
<a name="l00319"></a>00319                 (fileName ? fileName : <span class="stringliteral">"&lt;stdin&gt;"</span>),
<a name="l00320"></a>00320                 <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fdi));
<a name="l00321"></a>00321         <span class="keywordflow">return</span> RPMERR_BADMAGIC;
<a name="l00322"></a>00322     }
<a name="l00323"></a>00323     <span class="comment">/*@=sizeoftype@*/</span>
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="comment">/* XXX FIXME: EPIPE on &lt;stdin&gt; */</span>
<a name="l00326"></a>00326     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#401ed5293490b3f87058f2aad606844a" title="fseek(3) clone.">Fseek</a>(fdi, 0, <a class="code" href="system_8h.html#954c557843ed1d409b42275993fd1e21">SEEK_SET</a>) == -1) {
<a name="l00327"></a>00327         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba532bc33e87183474b2533822f408b0db">RPMERR_FSEEK</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s: Fseek failed: %s\n"</span>),
<a name="l00328"></a>00328                         (fileName ? fileName : <span class="stringliteral">"&lt;stdin&gt;"</span>), <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fdi));
<a name="l00329"></a>00329         <span class="keywordflow">return</span> <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba532bc33e87183474b2533822f408b0db">RPMERR_FSEEK</a>;
<a name="l00330"></a>00330     }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332     <span class="comment">/* Reallocate build data structures */</span>
<a name="l00333"></a>00333     spec = <a class="code" href="group__rpmbuild.html#gd03c676c9e184124684f6f170bec8712" title="Create and initialize Spec structure.">newSpec</a>();
<a name="l00334"></a>00334     spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a> = <a class="code" href="group__rpmbuild.html#g5ce0668d7200e6b064f2f28986065326" title="Create and initialize package control structure.">newPackage</a>(spec);
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="comment">/* XXX the header just allocated will be allocated again */</span>
<a name="l00337"></a>00337     spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a>-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a> = <a class="code" href="group__header.html#g7edd0b8c6a0e7e98632181b9390af930" title="Dereference a header instance.">headerFree</a>(spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a>-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339     <span class="comment">/* Read the rpm lead, signatures, and header */</span>
<a name="l00340"></a>00340     {   <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="group__rpmts.html#gea8dfc313aaafce2c6e9ee3caabce8b5" title="Create an empty transaction set.">rpmtsCreate</a>();
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         <span class="comment">/* XXX W2DO? pass fileName? */</span>
<a name="l00343"></a>00343         <span class="comment">/*@-mustmod@*/</span>      <span class="comment">/* LCL: segfault */</span>
<a name="l00344"></a>00344         rc = <a class="code" href="package_8c.html#6c5d130a0a25cf475d18a269e3438cee" title="Return package header from file handle, verifying digests/signatures.">rpmReadPackageFile</a>(ts, fdi, <span class="stringliteral">"readRPM"</span>,
<a name="l00345"></a>00345                          &amp;spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a>-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>);
<a name="l00346"></a>00346         <span class="comment">/*@=mustmod@*/</span>
<a name="l00347"></a>00347 
<a name="l00348"></a>00348         ts = <a class="code" href="group__rpmts.html#g95515319c5194d997d6cb84a1e1938c2" title="Destroy transaction set, closing the database as well.">rpmtsFree</a>(ts);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350         <span class="keywordflow">if</span> (sigs) *sigs = NULL;                 <span class="comment">/* XXX HACK */</span>
<a name="l00351"></a>00351     }
<a name="l00352"></a>00352 
<a name="l00353"></a>00353     <span class="keywordflow">switch</span> (rc) {
<a name="l00354"></a>00354     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#a3efb42b35b1d32213a359cc1540d183a68d4a0d9b05947f08369e28db2d34b6">RPMRC_OK</a>:
<a name="l00355"></a>00355     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#a3efb42b35b1d32213a359cc1540d183b6f17d5d9a9dc0941156b385450c2b1e">RPMRC_NOKEY</a>:
<a name="l00356"></a>00356     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#a3efb42b35b1d32213a359cc1540d1836cce8620ea15698128aa6f50f37e33c8">RPMRC_NOTTRUSTED</a>:
<a name="l00357"></a>00357         <span class="keywordflow">break</span>;
<a name="l00358"></a>00358     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#a3efb42b35b1d32213a359cc1540d183cbe81dea33d18b34520f06576c858672">RPMRC_NOTFOUND</a>:
<a name="l00359"></a>00359         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf1b99fca1f6fe3402cfce3ef10596473">RPMERR_BADMAGIC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"readRPM: %s is not an RPM package\n"</span>),
<a name="l00360"></a>00360                 (fileName ? fileName : <span class="stringliteral">"&lt;stdin&gt;"</span>));
<a name="l00361"></a>00361         <span class="keywordflow">return</span> <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf1b99fca1f6fe3402cfce3ef10596473">RPMERR_BADMAGIC</a>;
<a name="l00362"></a>00362     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#a3efb42b35b1d32213a359cc1540d183b3fa19bd3426cadb2bd64d899acac620">RPMRC_FAIL</a>:
<a name="l00363"></a>00363     <span class="keywordflow">default</span>:
<a name="l00364"></a>00364         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf1b99fca1f6fe3402cfce3ef10596473">RPMERR_BADMAGIC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"readRPM: reading header from %s\n"</span>),
<a name="l00365"></a>00365                 (fileName ? fileName : <span class="stringliteral">"&lt;stdin&gt;"</span>));
<a name="l00366"></a>00366         <span class="keywordflow">return</span> <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf1b99fca1f6fe3402cfce3ef10596473">RPMERR_BADMAGIC</a>;
<a name="l00367"></a>00367         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="comment">/*@-branchstate@*/</span>
<a name="l00371"></a>00371     <span class="keywordflow">if</span> (specp)
<a name="l00372"></a>00372         *specp = spec;
<a name="l00373"></a>00373     <span class="keywordflow">else</span>
<a name="l00374"></a>00374         spec = <a class="code" href="group__rpmbuild.html#g60c3eb1a791318201e7497ca162217c2" title="Destroy Spec structure.">freeSpec</a>(spec);
<a name="l00375"></a>00375     <span class="comment">/*@=branchstate@*/</span>
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (csa != NULL)
<a name="l00378"></a>00378         csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a> = fdi;
<a name="l00379"></a>00379     <span class="keywordflow">else</span>
<a name="l00380"></a>00380         (<span class="keywordtype">void</span>) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fdi);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382     <span class="keywordflow">return</span> 0;
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00385"></a>00385 
<a name="l00386"></a>00386 <span class="preprocessor">#ifdef  DYING</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00388"></a>00388 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="package_8c.html#739b796ffa0a2e9218383068dc83b215">header_magic</a>[8] = {
<a name="l00389"></a>00389         0x8e, 0xad, 0xe8, 0x01, 0x00, 0x00, 0x00, 0x00
<a name="l00390"></a>00390 };
<a name="l00391"></a>00391 <span class="preprocessor">#endif</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>
<a name="l00393"></a><a class="code" href="pack_8c.html#80e1c19272601990b5112b39cdcb9bbb">00393</a> <span class="preprocessor">#define RPMPKGVERSION_MIN       30004</span>
<a name="l00394"></a><a class="code" href="pack_8c.html#2ef8715001e0862c156cafed74652ea6">00394</a> <span class="preprocessor"></span><span class="preprocessor">#define RPMPKGVERSION_MAX       40003</span>
<a name="l00395"></a>00395 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00396"></a><a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">00396</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> = -1;
<a name="l00397"></a>00397 
<a name="l00398"></a><a class="code" href="pack_8c.html#fa823f14541a3113be762abe07310c38">00398</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pack_8c.html#fa823f14541a3113be762abe07310c38">rpmLeadVersion</a>(<span class="keywordtype">void</span>)
<a name="l00399"></a>00399         <span class="comment">/*@globals rpmpkg_version, rpmGlobalMacroContext, h_errno @*/</span>
<a name="l00400"></a>00400         <span class="comment">/*@modifies rpmpkg_version, rpmGlobalMacroContext @*/</span>
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402     <span class="keywordtype">int</span> rpmlead_version;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/* Intitialize packaging version from macro configuration. */</span>
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> &lt; 0) {
<a name="l00406"></a>00406         <a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> = <a class="code" href="macro_8c.html#2e43f3dd86c8e646243de9f051f36f6a" title="Return macro expansion as a numeric value.">rpmExpandNumeric</a>(<span class="stringliteral">"%{_package_version}"</span>);
<a name="l00407"></a>00407         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> &lt; <a class="code" href="pack_8c.html#80e1c19272601990b5112b39cdcb9bbb">RPMPKGVERSION_MIN</a>)
<a name="l00408"></a>00408             <a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> = <a class="code" href="pack_8c.html#80e1c19272601990b5112b39cdcb9bbb">RPMPKGVERSION_MIN</a>;
<a name="l00409"></a>00409         <span class="keywordflow">if</span> (<a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> &gt; <a class="code" href="pack_8c.html#2ef8715001e0862c156cafed74652ea6">RPMPKGVERSION_MAX</a>)
<a name="l00410"></a>00410             <a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> = <a class="code" href="pack_8c.html#2ef8715001e0862c156cafed74652ea6">RPMPKGVERSION_MAX</a>;
<a name="l00411"></a>00411     }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413     rpmlead_version = <a class="code" href="pack_8c.html#7983bd060460a70092bbb6b570b0822e">rpmpkg_version</a> / 10000;
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (<a class="code" href="group__rpmcli.html#g684c24e565b576a81ada33525f7c07ce" title="Should version 3 packages be produced?">_noDirTokens</a> || (rpmlead_version &lt; 3 || rpmlead_version &gt; 4))
<a name="l00415"></a>00415         rpmlead_version = 3;
<a name="l00416"></a>00416     <span class="keywordflow">return</span> rpmlead_version;
<a name="l00417"></a>00417 }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00420"></a><a class="code" href="pack_8c.html#99fe89674dc3339d3620bee258428b67">00420</a> <span class="keywordtype">int</span> <a class="code" href="buildio_8h.html#99fe89674dc3339d3620bee258428b67" title="Write rpm package to file.">writeRPM</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> *hdrp, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ** pkgidp, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structTriggerFileEntry.html#663d905a035b9600b11050eb39edd482">fileName</a>,
<a name="l00421"></a>00421                 <span class="keywordtype">int</span> type, <a class="code" href="structcpioSourceArchive__s.html">CSA_t</a> csa, <span class="keywordtype">char</span> *passPhrase, <span class="keyword">const</span> <span class="keywordtype">char</span> **cookie)
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = NULL;
<a name="l00424"></a>00424     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> ifd = NULL;
<a name="l00425"></a>00425     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> count, sigtag;
<a name="l00426"></a>00426     <span class="keyword">const</span> <span class="keywordtype">char</span> * sigtarget;
<a name="l00427"></a>00427     <span class="keyword">const</span> <span class="keywordtype">char</span> * rpmio_flags = NULL;
<a name="l00428"></a>00428     <span class="keyword">const</span> <span class="keywordtype">char</span> * SHA1 = NULL;
<a name="l00429"></a>00429     <span class="keywordtype">char</span> *s;
<a name="l00430"></a>00430     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00431"></a>00431     <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h;
<a name="l00432"></a>00432     <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> sig = NULL;
<a name="l00433"></a>00433     <span class="keywordtype">int</span> rc = 0;
<a name="l00434"></a>00434 
<a name="l00435"></a>00435     <span class="comment">/* Transfer header reference form *hdrp to h. */</span>
<a name="l00436"></a>00436     h = <a class="code" href="group__header.html#gb4e7acde75845c15b46baecaf616566c" title="Reference a header instance.">headerLink</a>(*hdrp);
<a name="l00437"></a>00437     *hdrp = <a class="code" href="group__header.html#g7edd0b8c6a0e7e98632181b9390af930" title="Dereference a header instance.">headerFree</a>(*hdrp);
<a name="l00438"></a>00438 
<a name="l00439"></a>00439     <span class="keywordflow">if</span> (pkgidp)
<a name="l00440"></a>00440         *pkgidp = NULL;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442 <span class="preprocessor">#ifdef  DYING</span>
<a name="l00443"></a>00443 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>) &lt; 0) {
<a name="l00444"></a>00444         csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#0847e30f0352f0f43065460e7063c168">cpioArchiveSize</a> = 0;
<a name="l00445"></a>00445         <span class="comment">/* Add a bogus archive size to the Header */</span>
<a name="l00446"></a>00446         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335911d228f3e55df1725be9b874f676b1ae7">RPMTAG_ARCHIVESIZE</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l00447"></a>00447                 &amp;csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#0847e30f0352f0f43065460e7063c168">cpioArchiveSize</a>, 1);
<a name="l00448"></a>00448     }
<a name="l00449"></a>00449 <span class="preprocessor">#endif</span>
<a name="l00450"></a>00450 <span class="preprocessor"></span>
<a name="l00451"></a>00451     <span class="comment">/* Binary packages now have explicit Provides: name = version-release. */</span>
<a name="l00452"></a>00452     <span class="keywordflow">if</span> (type == <a class="code" href="rpmlib_8h.html#090941049e017f2cbe4174a760afec6a">RPMLEAD_BINARY</a>)
<a name="l00453"></a>00453         <a class="code" href="legacy_8c.html#5a9645dfd465c75595ec043f85c70a47" title="Retrofit a Provides: name = version-release dependency into legacy package headers...">providePackageNVR</a>(h);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     <span class="comment">/* Save payload information */</span>
<a name="l00456"></a>00456     <span class="comment">/*@-branchstate@*/</span>
<a name="l00457"></a>00457     <span class="keywordflow">switch</span>(type) {
<a name="l00458"></a>00458     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#71b6c1984783d95751b7e938ede4a234">RPMLEAD_SOURCE</a>:
<a name="l00459"></a>00459         rpmio_flags = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{?_source_payload}"</span>, NULL);
<a name="l00460"></a>00460         <span class="keywordflow">break</span>;
<a name="l00461"></a>00461     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#090941049e017f2cbe4174a760afec6a">RPMLEAD_BINARY</a>:
<a name="l00462"></a>00462         rpmio_flags = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{?_binary_payload}"</span>, NULL);
<a name="l00463"></a>00463         <span class="keywordflow">break</span>;
<a name="l00464"></a>00464     }
<a name="l00465"></a>00465     <span class="comment">/*@=branchstate@*/</span>
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (!(rpmio_flags &amp;&amp; *rpmio_flags)) {
<a name="l00467"></a>00467         rpmio_flags = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(rpmio_flags);
<a name="l00468"></a>00468         rpmio_flags = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(<span class="stringliteral">"w9.gzdio"</span>);
<a name="l00469"></a>00469     }
<a name="l00470"></a>00470     s = strchr(rpmio_flags, <span class="charliteral">'.'</span>);
<a name="l00471"></a>00471     <span class="keywordflow">if</span> (s) {
<a name="l00472"></a>00472         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591efbd580d628cd031e3be4def8d57c567">RPMTAG_PAYLOADFORMAT</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, <span class="stringliteral">"cpio"</span>, 1);
<a name="l00473"></a>00473         <span class="keywordflow">if</span> (s[1] == <span class="charliteral">'g'</span> &amp;&amp; s[2] == <span class="charliteral">'z'</span>)
<a name="l00474"></a>00474             (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591e2c729056409612f051b86e124f6042a">RPMTAG_PAYLOADCOMPRESSOR</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>,
<a name="l00475"></a>00475                 <span class="stringliteral">"gzip"</span>, 1);
<a name="l00476"></a>00476         <span class="keywordflow">if</span> (s[1] == <span class="charliteral">'b'</span> &amp;&amp; s[2] == <span class="charliteral">'z'</span>) {
<a name="l00477"></a>00477             (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591e2c729056409612f051b86e124f6042a">RPMTAG_PAYLOADCOMPRESSOR</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>,
<a name="l00478"></a>00478                 <span class="stringliteral">"bzip2"</span>, 1);
<a name="l00479"></a>00479             <span class="comment">/* Add prereq on rpm version that understands bzip2 payloads */</span>
<a name="l00480"></a>00480             (void) <a class="code" href="group__rpmbuild.html#g9caff7daba6598c0896127b7b48eb52e" title="Add rpmlib feature dependency.">rpmlibNeedsFeature</a>(h, <span class="stringliteral">"PayloadIsBzip2"</span>, <span class="stringliteral">"3.0.5-1"</span>);
<a name="l00481"></a>00481         }
<a name="l00482"></a>00482         strcpy(buf, rpmio_flags);
<a name="l00483"></a>00483         buf[s - rpmio_flags] = <span class="charliteral">'\0'</span>;
<a name="l00484"></a>00484         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591128906a21d65c54d67b20bf7e970a376">RPMTAG_PAYLOADFLAGS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, buf+1, 1);
<a name="l00485"></a>00485     }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487     <span class="comment">/* Create and add the cookie */</span>
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (cookie) {
<a name="l00489"></a>00489         sprintf(buf, <span class="stringliteral">"%s %d"</span>, <a class="code" href="group__rpmbuild.html#gdd5e851a60303e7ff7263428daecadb0" title="Return build hostname.">buildHost</a>(), (<span class="keywordtype">int</span>) (*<a class="code" href="group__rpmbuild.html#g2149d4cbf95cc58219a5c1ab126a4133" title="Return build time stamp.">getBuildTime</a>()));
<a name="l00490"></a>00490         *cookie = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(buf);
<a name="l00491"></a>00491         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591a0db3fdec234a954f3af96cfd2a42247">RPMTAG_COOKIE</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, *cookie, 1);
<a name="l00492"></a>00492     }
<a name="l00493"></a>00493     
<a name="l00494"></a>00494     <span class="comment">/* Reallocate the header into one contiguous region. */</span>
<a name="l00495"></a>00495     h = <a class="code" href="group__header.html#g1d394bbf675dbe18962c6b582fdfe83e" title="Convert header to on-disk representation, and then reload.">headerReload</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359127f3aa83a02028dc629872c8fb867ea0">RPMTAG_HEADERIMMUTABLE</a>);
<a name="l00496"></a>00496     <span class="keywordflow">if</span> (h == NULL) {    <span class="comment">/* XXX can't happen */</span>
<a name="l00497"></a>00497         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba2dd0c9caa67fb78a608fe67590f9ec6d">RPMERR_RELOAD</a>;
<a name="l00498"></a>00498         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba2dd0c9caa67fb78a608fe67590f9ec6d">RPMERR_RELOAD</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to create immutable header region.\n"</span>));
<a name="l00499"></a>00499         <span class="keywordflow">goto</span> exit;
<a name="l00500"></a>00500     }
<a name="l00501"></a>00501     <span class="comment">/* Re-reference reallocated header. */</span>
<a name="l00502"></a>00502     *hdrp = <a class="code" href="group__header.html#gb4e7acde75845c15b46baecaf616566c" title="Reference a header instance.">headerLink</a>(h);
<a name="l00503"></a>00503 
<a name="l00504"></a>00504     <span class="comment">/*</span>
<a name="l00505"></a>00505 <span class="comment">     * Write the header+archive into a temp file so that the size of</span>
<a name="l00506"></a>00506 <span class="comment">     * archive (after compression) can be added to the header.</span>
<a name="l00507"></a>00507 <span class="comment">     */</span>
<a name="l00508"></a>00508     <span class="keywordflow">if</span> (<a class="code" href="lib_2misc_8c.html#91eceeb306a44f66e8ee51144cd2593b" title="Return file handle for a temporaray file.">makeTempFile</a>(NULL, &amp;sigtarget, &amp;fd)) {
<a name="l00509"></a>00509         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4fd122923f054494815e6abff8daa63a">RPMERR_CREATE</a>;
<a name="l00510"></a>00510         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4fd122923f054494815e6abff8daa63a">RPMERR_CREATE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to open temp file.\n"</span>));
<a name="l00511"></a>00511         <span class="keywordflow">goto</span> exit;
<a name="l00512"></a>00512     }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514     <a class="code" href="group__rpmio.html#g507e26c37b2d2441527b979d6f02de23" title="Attach digest to fd.">fdInitDigest</a>(fd, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d710b23bd7fa0d33da7662fa85fa38887e">PGPHASHALGO_SHA1</a>, 0);
<a name="l00515"></a>00515     <span class="keywordflow">if</span> (<a class="code" href="group__header.html#gca409cc1795fb0661e693d22344af6c4" title="Write (with unload) header to file handle.">headerWrite</a>(fd, h, <a class="code" href="group__header.html#gged70b986e0a7083b87974734a93dcfac2a65f7f8f3fb943035aa021a9f27d2a1">HEADER_MAGIC_YES</a>)) {
<a name="l00516"></a>00516         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>;
<a name="l00517"></a>00517         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to write temp header\n"</span>));
<a name="l00518"></a>00518     } <span class="keywordflow">else</span> { <span class="comment">/* Write the archive and get the size */</span>
<a name="l00519"></a>00519         (void) <a class="code" href="rpmio_8c.html#151331b54e01d3b4ebe94382603ad609" title="fflush(3) clone.">Fflush</a>(fd);
<a name="l00520"></a>00520         <a class="code" href="group__rpmio.html#g222eae57c03fb1e4ed9b32c6a1396b13">fdFiniDigest</a>(fd, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d710b23bd7fa0d33da7662fa85fa38887e">PGPHASHALGO_SHA1</a>, (<span class="keywordtype">void</span> **)&amp;SHA1, NULL, 1);
<a name="l00521"></a>00521         <span class="keywordflow">if</span> (csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#7f22220153ce631ff8176f5462cd8e5c">cpioList</a> != NULL) {
<a name="l00522"></a>00522             rc = <a class="code" href="pack_8c.html#560327b8e3f9ef3344516ff95a720b01">cpio_doio</a>(fd, h, csa, rpmio_flags);
<a name="l00523"></a>00523         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>) &gt;= 0) {
<a name="l00524"></a>00524             rc = <a class="code" href="pack_8c.html#3d6da85450cf84b241341a5d3ce614fd">cpio_copy</a>(fd, csa);
<a name="l00525"></a>00525         } <span class="keywordflow">else</span> {
<a name="l00526"></a>00526             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baa97ef3e479e5903916068d02e0a60805">RPMERR_BADARG</a>;
<a name="l00527"></a>00527             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baa97ef3e479e5903916068d02e0a60805">RPMERR_BADARG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Bad CSA data\n"</span>));
<a name="l00528"></a>00528         }
<a name="l00529"></a>00529     }
<a name="l00530"></a>00530     rpmio_flags = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(rpmio_flags);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">if</span> (rc)
<a name="l00533"></a>00533         <span class="keywordflow">goto</span> exit;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535 <span class="preprocessor">#ifdef  DYING</span>
<a name="l00536"></a>00536 <span class="preprocessor"></span>    <span class="comment">/*</span>
<a name="l00537"></a>00537 <span class="comment">     * Set the actual archive size, and rewrite the header.</span>
<a name="l00538"></a>00538 <span class="comment">     * This used to be done using headerModifyEntry(), but now that headers</span>
<a name="l00539"></a>00539 <span class="comment">     * have regions, the value is scribbled directly into the header data</span>
<a name="l00540"></a>00540 <span class="comment">     * area. Some new scheme for adding the final archive size will have</span>
<a name="l00541"></a>00541 <span class="comment">     * to be devised if headerGetEntryMinMemory() ever changes to return</span>
<a name="l00542"></a>00542 <span class="comment">     * a pointer to memory not in the region, probably by appending</span>
<a name="l00543"></a>00543 <span class="comment">     * the archive size to the header region rather than including the</span>
<a name="l00544"></a>00544 <span class="comment">     * archive size within the header region.</span>
<a name="l00545"></a>00545 <span class="comment">     */</span>
<a name="l00546"></a>00546     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>) &lt; 0) {
<a name="l00547"></a>00547         <a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a> hge = (<a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a>)<a class="code" href="group__header.html#g29996e73fee54b49b34246121494cbf1" title="Retrieve tag value using header internal array.">headerGetEntryMinMemory</a>;
<a name="l00548"></a>00548         <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> * archiveSize;
<a name="l00549"></a>00549         <span class="keywordflow">if</span> (hge(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335911d228f3e55df1725be9b874f676b1ae7">RPMTAG_ARCHIVESIZE</a>, NULL, (<span class="keywordtype">void</span> *)&amp;archiveSize, NULL))
<a name="l00550"></a>00550             *archiveSize = csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#0847e30f0352f0f43065460e7063c168">cpioArchiveSize</a>;
<a name="l00551"></a>00551     }
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     (void) <a class="code" href="rpmio_8c.html#151331b54e01d3b4ebe94382603ad609" title="fflush(3) clone.">Fflush</a>(fd);
<a name="l00554"></a>00554     <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#401ed5293490b3f87058f2aad606844a" title="fseek(3) clone.">Fseek</a>(fd, 0, <a class="code" href="system_8h.html#954c557843ed1d409b42275993fd1e21">SEEK_SET</a>) == -1) {
<a name="l00555"></a>00555         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba532bc33e87183474b2533822f408b0db">RPMERR_FSEEK</a>;
<a name="l00556"></a>00556         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba532bc33e87183474b2533822f408b0db">RPMERR_FSEEK</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s: Fseek failed: %s\n"</span>),
<a name="l00557"></a>00557                         sigtarget, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l00558"></a>00558     }
<a name="l00559"></a>00559 
<a name="l00560"></a>00560     <a class="code" href="group__rpmio.html#g507e26c37b2d2441527b979d6f02de23" title="Attach digest to fd.">fdInitDigest</a>(fd, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d710b23bd7fa0d33da7662fa85fa38887e">PGPHASHALGO_SHA1</a>, 0);
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (<a class="code" href="group__header.html#gca409cc1795fb0661e693d22344af6c4" title="Write (with unload) header to file handle.">headerWrite</a>(fd, h, <a class="code" href="group__header.html#gged70b986e0a7083b87974734a93dcfac2a65f7f8f3fb943035aa021a9f27d2a1">HEADER_MAGIC_YES</a>)) {
<a name="l00562"></a>00562         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>;
<a name="l00563"></a>00563         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to write final header\n"</span>));
<a name="l00564"></a>00564     }
<a name="l00565"></a>00565     (void) <a class="code" href="rpmio_8c.html#151331b54e01d3b4ebe94382603ad609" title="fflush(3) clone.">Fflush</a>(fd);
<a name="l00566"></a>00566     <a class="code" href="group__rpmio.html#g222eae57c03fb1e4ed9b32c6a1396b13">fdFiniDigest</a>(fd, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d710b23bd7fa0d33da7662fa85fa38887e">PGPHASHALGO_SHA1</a>, (<span class="keywordtype">void</span> **)&amp;SHA1, NULL, 1);
<a name="l00567"></a>00567 <span class="preprocessor">#endif</span>
<a name="l00568"></a>00568 <span class="preprocessor"></span>
<a name="l00569"></a>00569     (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l00570"></a>00570     fd = NULL;
<a name="l00571"></a>00571     (void) <a class="code" href="rpmio_8h.html#1c789f4e5cf1fb0106ec85ebad2406ad" title="unlink(2) clone.">Unlink</a>(fileName);
<a name="l00572"></a>00572 
<a name="l00573"></a>00573     <span class="keywordflow">if</span> (rc)
<a name="l00574"></a>00574         <span class="keywordflow">goto</span> exit;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576     <span class="comment">/* Generate the signature */</span>
<a name="l00577"></a>00577     (void) fflush(stdout);
<a name="l00578"></a>00578     sig = <a class="code" href="group__signature.html#g7b8d13bd83797ed4e64684d4f128004e" title="Return new, empty (signature) header instance.">rpmNewSignature</a>();
<a name="l00579"></a>00579     (void) <a class="code" href="group__signature.html#g83c70b3fbfde7ba29cdde61689bbb29f" title="Generate signature(s) from a header+payload file, save in signature header.">rpmAddSignature</a>(sig, sigtarget, <a class="code" href="group__signature.html#gg2c705e9138aa336a57ab3198bf40c931bf2c0cb8b00afc9be9c2ef44c744773e">RPMSIGTAG_SIZE</a>, passPhrase);
<a name="l00580"></a>00580     (void) <a class="code" href="group__signature.html#g83c70b3fbfde7ba29cdde61689bbb29f" title="Generate signature(s) from a header+payload file, save in signature header.">rpmAddSignature</a>(sig, sigtarget, <a class="code" href="group__signature.html#gg2c705e9138aa336a57ab3198bf40c931771f9e86ff018c23e1ba924deb6d0a2d">RPMSIGTAG_MD5</a>, passPhrase);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582     <span class="keywordflow">if</span> ((sigtag = <a class="code" href="group__signature.html#g2ff1c79a477fc07e2f8fc46f6f043d2f" title="Return type of signature needed for signing/building.">rpmLookupSignatureType</a>(<a class="code" href="signature_8h.html#ea312a86d4018151e51d4205f0f15626" title="Possible actions for rpmLookupSignatureType().">RPMLOOKUPSIG_QUERY</a>)) &gt; 0) {
<a name="l00583"></a>00583         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Generating signature: %d\n"</span>), sigtag);
<a name="l00584"></a>00584         (void) <a class="code" href="group__signature.html#g83c70b3fbfde7ba29cdde61689bbb29f" title="Generate signature(s) from a header+payload file, save in signature header.">rpmAddSignature</a>(sig, sigtarget, sigtag, passPhrase);
<a name="l00585"></a>00585     }
<a name="l00586"></a>00586     
<a name="l00587"></a>00587     <span class="keywordflow">if</span> (SHA1) {
<a name="l00588"></a>00588         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(sig, <a class="code" href="group__signature.html#gg2c705e9138aa336a57ab3198bf40c931ab3ad30e0cccc2b4cab52d3fda68a6b7">RPMSIGTAG_SHA1</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, SHA1, 1);
<a name="l00589"></a>00589         SHA1 = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(SHA1);
<a name="l00590"></a>00590     }
<a name="l00591"></a>00591 
<a name="l00592"></a>00592     {   <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> payloadSize = csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#0847e30f0352f0f43065460e7063c168">cpioArchiveSize</a>;
<a name="l00593"></a>00593         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(sig, <a class="code" href="group__signature.html#gg2c705e9138aa336a57ab3198bf40c93105739f171824a615714ff2e056616c60">RPMSIGTAG_PAYLOADSIZE</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l00594"></a>00594                         &amp;payloadSize, 1);
<a name="l00595"></a>00595     }
<a name="l00596"></a>00596 
<a name="l00597"></a>00597     <span class="comment">/* Reallocate the signature into one contiguous region. */</span>
<a name="l00598"></a>00598     sig = <a class="code" href="group__header.html#g1d394bbf675dbe18962c6b582fdfe83e" title="Convert header to on-disk representation, and then reload.">headerReload</a>(sig, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f90dd65b4db471cf409310ff2b1cae78">RPMTAG_HEADERSIGNATURES</a>);
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (sig == NULL) {  <span class="comment">/* XXX can't happen */</span>
<a name="l00600"></a>00600         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba2dd0c9caa67fb78a608fe67590f9ec6d">RPMERR_RELOAD</a>;
<a name="l00601"></a>00601         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba2dd0c9caa67fb78a608fe67590f9ec6d">RPMERR_RELOAD</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to reload signature header.\n"</span>));
<a name="l00602"></a>00602         <span class="keywordflow">goto</span> exit;
<a name="l00603"></a>00603     }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605     <span class="comment">/* Open the output file */</span>
<a name="l00606"></a>00606     fd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fileName, <span class="stringliteral">"w.ufdio"</span>);
<a name="l00607"></a>00607     <span class="keywordflow">if</span> (fd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd)) {
<a name="l00608"></a>00608         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4fd122923f054494815e6abff8daa63a">RPMERR_CREATE</a>;
<a name="l00609"></a>00609         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4fd122923f054494815e6abff8daa63a">RPMERR_CREATE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not open %s: %s\n"</span>),
<a name="l00610"></a>00610                 fileName, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l00611"></a>00611         <span class="keywordflow">goto</span> exit;
<a name="l00612"></a>00612     }
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     <span class="comment">/* Write the lead section into the package. */</span>
<a name="l00615"></a>00615     {   <span class="keywordtype">int</span> archnum = -1;
<a name="l00616"></a>00616         <span class="keywordtype">int</span> osnum = -1;
<a name="l00617"></a>00617         <span class="keyword">struct </span><a class="code" href="structrpmlead.html" title="The lead data structure.">rpmlead</a> lead;
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#22dab80dc8fe7d52348404600e58a571">cpioFdIn</a>) &lt; 0) {
<a name="l00620"></a>00620 <span class="preprocessor">#ifndef DYING</span>
<a name="l00621"></a>00621 <span class="preprocessor"></span>            <a class="code" href="group__rpmrc.html#g2b4cfbbe4bda6838539b5b34be47abc8" title="Return current arch name and/or number.">rpmGetArchInfo</a>(NULL, &amp;archnum);
<a name="l00622"></a>00622             <a class="code" href="group__rpmrc.html#g62b6de6717b6dfbdbfe2a338cacda5ea" title="Return current os name and/or number.">rpmGetOsInfo</a>(NULL, &amp;osnum);
<a name="l00623"></a>00623 <span class="preprocessor">#endif</span>
<a name="l00624"></a>00624 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#a44995bf01002bf63d07aa62953a4064">lead</a> != NULL) {
<a name="l00625"></a>00625             archnum = csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#a44995bf01002bf63d07aa62953a4064">lead</a>-&gt;<a class="code" href="structrpmlead.html#248fb47b509bae2469b4bda92e5f8723">archnum</a>;
<a name="l00626"></a>00626             osnum = csa-&gt;<a class="code" href="structcpioSourceArchive__s.html#a44995bf01002bf63d07aa62953a4064">lead</a>-&gt;<a class="code" href="structrpmlead.html#25cbc5de18aba8ad1167b646ccf3ae45">osnum</a>;
<a name="l00627"></a>00627         }
<a name="l00628"></a>00628 
<a name="l00629"></a>00629         memset(&amp;lead, 0, <span class="keyword">sizeof</span>(lead));
<a name="l00630"></a>00630         lead.major = <a class="code" href="pack_8c.html#fa823f14541a3113be762abe07310c38">rpmLeadVersion</a>();
<a name="l00631"></a>00631         lead.minor = 0;
<a name="l00632"></a>00632         lead.type = type;
<a name="l00633"></a>00633         lead.archnum = archnum;
<a name="l00634"></a>00634         lead.osnum = osnum;
<a name="l00635"></a>00635         lead.signature_type = <a class="code" href="group__signature.html#gg756c202de50032237c4268d4e27af15bd4fee221c06b291b91af2dd0f52ed04a">RPMSIGTYPE_HEADERSIG</a>;
<a name="l00636"></a>00636 
<a name="l00637"></a>00637         {   <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structname.html">name</a>, *version, *release;
<a name="l00638"></a>00638             (void) <a class="code" href="group__header.html#g53462b3c5298a60fa2a43162deb4f41a" title="Return name, version, release strings from header.">headerNVR</a>(h, &amp;name, &amp;version, &amp;release);
<a name="l00639"></a>00639             sprintf(buf, <span class="stringliteral">"%s-%s-%s"</span>, name, version, release);
<a name="l00640"></a>00640             strncpy(lead.name, buf, <span class="keyword">sizeof</span>(lead.name));
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642 
<a name="l00643"></a>00643         <span class="keywordflow">if</span> (<a class="code" href="group__lead.html#gb850951b8dc46ae9318e4bf5b90e2e73" title="Write lead to file handle.">writeLead</a>(fd, &amp;lead) != <a class="code" href="rpmlib_8h.html#a3efb42b35b1d32213a359cc1540d183a68d4a0d9b05947f08369e28db2d34b6">RPMRC_OK</a>) {
<a name="l00644"></a>00644             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>;
<a name="l00645"></a>00645             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to write package: %s\n"</span>),
<a name="l00646"></a>00646                  <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l00647"></a>00647             <span class="keywordflow">goto</span> exit;
<a name="l00648"></a>00648         }
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650 
<a name="l00651"></a>00651     <span class="comment">/* Write the signature section into the package. */</span>
<a name="l00652"></a>00652     rc = <a class="code" href="group__signature.html#gaa40d7f97708b8badc11deabb0f35207" title="Write signature header.">rpmWriteSignature</a>(fd, sig);
<a name="l00653"></a>00653     <span class="keywordflow">if</span> (rc)
<a name="l00654"></a>00654         <span class="keywordflow">goto</span> exit;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="comment">/* Append the header and archive */</span>
<a name="l00657"></a>00657     ifd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(sigtarget, <span class="stringliteral">"r.ufdio"</span>);
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (ifd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(ifd)) {
<a name="l00659"></a>00659         rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf6b4667188d955c3f0d7637ca9914305">RPMERR_READ</a>;
<a name="l00660"></a>00660         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf6b4667188d955c3f0d7637ca9914305">RPMERR_READ</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to open sigtarget %s: %s\n"</span>),
<a name="l00661"></a>00661                 sigtarget, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(ifd));
<a name="l00662"></a>00662         <span class="keywordflow">goto</span> exit;
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="comment">/* Add signatures to header, and write header into the package. */</span>
<a name="l00666"></a>00666     <span class="comment">/* XXX header+payload digests/signatures might be checked again here. */</span>
<a name="l00667"></a>00667     {   <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> nh = <a class="code" href="group__header.html#gd7de19e98b333bc6748d52c92655e258" title="Read (and load) header from file handle.">headerRead</a>(ifd, <a class="code" href="group__header.html#gged70b986e0a7083b87974734a93dcfac2a65f7f8f3fb943035aa021a9f27d2a1">HEADER_MAGIC_YES</a>);
<a name="l00668"></a>00668 
<a name="l00669"></a>00669         <span class="keywordflow">if</span> (nh == NULL) {
<a name="l00670"></a>00670             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf6b4667188d955c3f0d7637ca9914305">RPMERR_READ</a>;
<a name="l00671"></a>00671             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf6b4667188d955c3f0d7637ca9914305">RPMERR_READ</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to read header from %s: %s\n"</span>),
<a name="l00672"></a>00672                         sigtarget, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(ifd));
<a name="l00673"></a>00673             <span class="keywordflow">goto</span> exit;
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="preprocessor">#ifdef  NOTYET</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span>        (void) <a class="code" href="group__header.html#gb0d069249abe3ae321f175e32f353164" title="Translate and merge legacy signature tags into header.">headerMergeLegacySigs</a>(nh, sig);
<a name="l00678"></a>00678 <span class="preprocessor">#endif</span>
<a name="l00679"></a>00679 <span class="preprocessor"></span>
<a name="l00680"></a>00680         rc = <a class="code" href="group__header.html#gca409cc1795fb0661e693d22344af6c4" title="Write (with unload) header to file handle.">headerWrite</a>(fd, nh, <a class="code" href="group__header.html#gged70b986e0a7083b87974734a93dcfac2a65f7f8f3fb943035aa021a9f27d2a1">HEADER_MAGIC_YES</a>);
<a name="l00681"></a>00681         nh = <a class="code" href="group__header.html#g7edd0b8c6a0e7e98632181b9390af930" title="Dereference a header instance.">headerFree</a>(nh);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683         <span class="keywordflow">if</span> (rc) {
<a name="l00684"></a>00684             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>;
<a name="l00685"></a>00685             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to write header to %s: %s\n"</span>),
<a name="l00686"></a>00686                         fileName, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l00687"></a>00687             <span class="keywordflow">goto</span> exit;
<a name="l00688"></a>00688         }
<a name="l00689"></a>00689     }
<a name="l00690"></a>00690         
<a name="l00691"></a>00691     <span class="comment">/* Write the payload into the package. */</span>
<a name="l00692"></a>00692     <span class="keywordflow">while</span> ((count = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(buf, <span class="keyword">sizeof</span>(buf[0]), <span class="keyword">sizeof</span>(buf), ifd)) &gt; 0) {
<a name="l00693"></a>00693         <span class="keywordflow">if</span> (count == -1) {
<a name="l00694"></a>00694             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf6b4667188d955c3f0d7637ca9914305">RPMERR_READ</a>;
<a name="l00695"></a>00695             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf6b4667188d955c3f0d7637ca9914305">RPMERR_READ</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to read payload from %s: %s\n"</span>),
<a name="l00696"></a>00696                      sigtarget, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(ifd));
<a name="l00697"></a>00697             <span class="keywordflow">goto</span> exit;
<a name="l00698"></a>00698         }
<a name="l00699"></a>00699         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#0b66d10b5a0e926d57e86327f4e9dcc6" title="fwrite(3) clone.">Fwrite</a>(buf, <span class="keyword">sizeof</span>(buf[0]), count, fd) != count) {
<a name="l00700"></a>00700             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>;
<a name="l00701"></a>00701             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba4013a952f89839ec8a1528b3f7bc732f">RPMERR_NOSPACE</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unable to write payload to %s: %s\n"</span>),
<a name="l00702"></a>00702                      fileName, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l00703"></a>00703             <span class="keywordflow">goto</span> exit;
<a name="l00704"></a>00704         }
<a name="l00705"></a>00705     }
<a name="l00706"></a>00706     rc = 0;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708 exit:
<a name="l00709"></a>00709     SHA1 = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(SHA1);
<a name="l00710"></a>00710     h = <a class="code" href="group__header.html#g7edd0b8c6a0e7e98632181b9390af930" title="Dereference a header instance.">headerFree</a>(h);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712     <span class="comment">/* XXX Fish the pkgid out of the signature header. */</span>
<a name="l00713"></a>00713     <span class="keywordflow">if</span> (sig != NULL &amp;&amp; pkgidp != NULL) {
<a name="l00714"></a>00714         <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> <a class="code" href="rpmlib_8h.html#a8f2cbfb136b786036d9045b3e66aed4" title="Return tag data type from value.">tagType</a>;
<a name="l00715"></a>00715         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * MD5 = NULL;
<a name="l00716"></a>00716         <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> c;
<a name="l00717"></a>00717         <span class="keywordtype">int</span> xx;
<a name="l00718"></a>00718         xx = <a class="code" href="group__header.html#gddebc5eb6a9605829e11a5b356b36d33" title="Retrieve tag value.">headerGetEntry</a>(sig, <a class="code" href="group__signature.html#gg2c705e9138aa336a57ab3198bf40c931771f9e86ff018c23e1ba924deb6d0a2d">RPMSIGTAG_MD5</a>, &amp;tagType, (<span class="keywordtype">void</span> **)&amp;MD5, &amp;c);
<a name="l00719"></a>00719         <span class="keywordflow">if</span> (tagType == <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43ce200877bfddf86d67887ae94caa2ab20">RPM_BIN_TYPE</a> &amp;&amp; MD5 != NULL &amp;&amp; c == 16)
<a name="l00720"></a>00720             *pkgidp = MD5;
<a name="l00721"></a>00721     }
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     sig = <a class="code" href="group__signature.html#gc8c1b815975de5d320d36eb5d6ae032d" title="Destroy signature header from package.">rpmFreeSignature</a>(sig);
<a name="l00724"></a>00724     <span class="keywordflow">if</span> (ifd) {
<a name="l00725"></a>00725         (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(ifd);
<a name="l00726"></a>00726         ifd = NULL;
<a name="l00727"></a>00727     }
<a name="l00728"></a>00728     <span class="keywordflow">if</span> (fd) {
<a name="l00729"></a>00729         (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l00730"></a>00730         fd = NULL;
<a name="l00731"></a>00731     }
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (sigtarget) {
<a name="l00733"></a>00733         (void) <a class="code" href="rpmio_8h.html#1c789f4e5cf1fb0106ec85ebad2406ad" title="unlink(2) clone.">Unlink</a>(sigtarget);
<a name="l00734"></a>00734         sigtarget = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(sigtarget);
<a name="l00735"></a>00735     }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (rc == 0)
<a name="l00738"></a>00738         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Wrote: %s\n"</span>), fileName);
<a name="l00739"></a>00739     <span class="keywordflow">else</span>
<a name="l00740"></a>00740         (<span class="keywordtype">void</span>) <a class="code" href="rpmio_8h.html#1c789f4e5cf1fb0106ec85ebad2406ad" title="unlink(2) clone.">Unlink</a>(fileName);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="keywordflow">return</span> rc;
<a name="l00743"></a>00743 }
<a name="l00744"></a>00744 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00745"></a>00745 
<a name="l00746"></a>00746 <span class="comment">/*@unchecked@*/</span>
<a name="l00747"></a><a class="code" href="pack_8c.html#38dfe6e00dcf041e75c533078877b3e5">00747</a> <span class="keyword">static</span> <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> <a class="code" href="pack_8c.html#38dfe6e00dcf041e75c533078877b3e5">copyTags</a>[] = {
<a name="l00748"></a>00748     <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917c54bb450d2f49c53fc00e6f9b2da7ee">RPMTAG_CHANGELOGTIME</a>,
<a name="l00749"></a>00749     <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f13b28c7907b2b9a95d6714f1c450c2f">RPMTAG_CHANGELOGNAME</a>,
<a name="l00750"></a>00750     <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591e3ebb7f80b999bd09ca7c885d5548001">RPMTAG_CHANGELOGTEXT</a>,
<a name="l00751"></a>00751     0
<a name="l00752"></a>00752 };
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00755"></a><a class="code" href="group__rpmbuild.html#g560452ca4ffc4bbfa4c04ef984acee48">00755</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmbuild.html#g560452ca4ffc4bbfa4c04ef984acee48" title="Generate binary package(s).">packageBinaries</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec)
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757     <span class="keyword">struct </span><a class="code" href="structcpioSourceArchive__s.html">cpioSourceArchive_s</a> csabuf;
<a name="l00758"></a>00758     <a class="code" href="structcpioSourceArchive__s.html">CSA_t</a> csa = &amp;csabuf;
<a name="l00759"></a>00759     <span class="keywordtype">int</span> rc;
<a name="l00760"></a>00760     <span class="keyword">const</span> <span class="keywordtype">char</span> *errorString;
<a name="l00761"></a>00761     <a class="code" href="structPackage__s.html" title="The structure used to store values for a package.">Package</a> pkg;
<a name="l00762"></a>00762 
<a name="l00763"></a>00763     <span class="keywordflow">for</span> (pkg = spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a>; pkg != NULL; pkg = pkg-&gt;<a class="code" href="structPackage__s.html#13605bf6a2ed28fa86c892c7c0f31a3f">next</a>) {
<a name="l00764"></a>00764         <span class="keyword">const</span> <span class="keywordtype">char</span> *fn;
<a name="l00765"></a>00765 
<a name="l00766"></a>00766         <span class="keywordflow">if</span> (pkg-&gt;<a class="code" href="structPackage__s.html#4c91fdb06ead8b6bc0ebda1c41b06297">fileList</a> == NULL)
<a name="l00767"></a>00767             <span class="keywordflow">continue</span>;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">if</span> ((rc = <a class="code" href="pack_8c.html#51b39a5825912b06c814123cb6fb26cd">processScriptFiles</a>(spec, pkg)))
<a name="l00770"></a>00770             <span class="keywordflow">return</span> rc;
<a name="l00771"></a>00771         
<a name="l00772"></a>00772         <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="structSpec__s.html#6bb9ca036787a5cf51573f8178e4b70a">cookie</a>) {
<a name="l00773"></a>00773             (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591a0db3fdec234a954f3af96cfd2a42247">RPMTAG_COOKIE</a>,
<a name="l00774"></a>00774                            <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, spec-&gt;<a class="code" href="structSpec__s.html#6bb9ca036787a5cf51573f8178e4b70a">cookie</a>, 1);
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         <span class="comment">/* Copy changelog from src rpm */</span>
<a name="l00778"></a>00778         <a class="code" href="group__header.html#g80bcb9a0a690803099cbdd3778db8138" title="Duplicate tag values from one header into another.">headerCopyTags</a>(spec-&gt;<a class="code" href="structSpec__s.html#ffcee259f7ea1e815853ac3ae9f643c2">packages</a>-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="pack_8c.html#38dfe6e00dcf041e75c533078877b3e5">copyTags</a>);
<a name="l00779"></a>00779         
<a name="l00780"></a>00780         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591ef77e88a37ae8b474a5eba827d165230">RPMTAG_RPMVERSION</a>,
<a name="l00781"></a>00781                        <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, <a class="code" href="config_8h.html#d50944c12fe46b051e56ecff63a08c17">VERSION</a>, 1);
<a name="l00782"></a>00782         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591e443b308465ad92786f20cd11acc9e51">RPMTAG_BUILDHOST</a>,
<a name="l00783"></a>00783                        <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, <a class="code" href="group__rpmbuild.html#gdd5e851a60303e7ff7263428daecadb0" title="Return build hostname.">buildHost</a>(), 1);
<a name="l00784"></a>00784         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917fe1cd37eb83784a5bc4fc043ebfb481">RPMTAG_BUILDTIME</a>,
<a name="l00785"></a>00785                        <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>, <a class="code" href="group__rpmbuild.html#g2149d4cbf95cc58219a5c1ab126a4133" title="Return build time stamp.">getBuildTime</a>(), 1);
<a name="l00786"></a>00786 
<a name="l00787"></a>00787         <a class="code" href="legacy_8c.html#5a9645dfd465c75595ec043f85c70a47" title="Retrofit a Provides: name = version-release dependency into legacy package headers...">providePackageNVR</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>);
<a name="l00788"></a>00788 
<a name="l00789"></a>00789     {   <span class="keyword">const</span> <span class="keywordtype">char</span> * optflags = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{optflags}"</span>, NULL);
<a name="l00790"></a>00790         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591c9622b906945b9d15041ba8aa311ff02">RPMTAG_OPTFLAGS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>,
<a name="l00791"></a>00791                         optflags, 1);
<a name="l00792"></a>00792         optflags = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(optflags);
<a name="l00793"></a>00793     }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795         (void) <a class="code" href="pack_8c.html#1aaf62bc9b13b7d870536baa37cd4344">genSourceRpmName</a>(spec);
<a name="l00796"></a>00796         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591bc0978d965831e1493b51ddd193bc56d">RPMTAG_SOURCERPM</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>,
<a name="l00797"></a>00797                        spec-&gt;<a class="code" href="structSpec__s.html#6ed780920ce83bf828282dbbb104ddb2">sourceRpmName</a>, 1);
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (spec-&gt;<a class="code" href="structSpec__s.html#8d2536ae77469160111a1b4ad7c9c2d6">sourcePkgId</a> != NULL) {
<a name="l00799"></a>00799         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591e2700892cf3d6dc639c98c804d6230fa">RPMTAG_SOURCEPKGID</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43ce200877bfddf86d67887ae94caa2ab20">RPM_BIN_TYPE</a>,
<a name="l00800"></a>00800                        spec-&gt;<a class="code" href="structSpec__s.html#8d2536ae77469160111a1b4ad7c9c2d6">sourcePkgId</a>, 16);
<a name="l00801"></a>00801         }
<a name="l00802"></a>00802         
<a name="l00803"></a>00803         {   <span class="keyword">const</span> <span class="keywordtype">char</span> *binFormat = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(<span class="stringliteral">"%{_rpmfilename}"</span>, NULL);
<a name="l00804"></a>00804             <span class="keywordtype">char</span> *binRpm, *binDir;
<a name="l00805"></a>00805             binRpm = <a class="code" href="group__header.html#g7d710c2a50e88fefe8faae6efce8b039" title="Return formatted output string from header tags.">headerSprintf</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, binFormat, <a class="code" href="rpmlib_8h.html#a9352d22ad9fd8a7c4d699516fc015ca" title="Automatically generated table of tag name/value pairs.">rpmTagTable</a>,
<a name="l00806"></a>00806                                <a class="code" href="formats_8c.html#8c497f85ccf3d1b4ee014be46e3e4b5e" title="Table of query format extensions.">rpmHeaderFormats</a>, &amp;errorString);
<a name="l00807"></a>00807             binFormat = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(binFormat);
<a name="l00808"></a>00808             <span class="keywordflow">if</span> (binRpm == NULL) {
<a name="l00809"></a>00809                 <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structname.html">name</a>;
<a name="l00810"></a>00810                 (void) <a class="code" href="group__header.html#g53462b3c5298a60fa2a43162deb4f41a" title="Return name, version, release strings from header.">headerNVR</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, &amp;name, NULL, NULL);
<a name="l00811"></a>00811                 <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Could not generate output "</span>
<a name="l00812"></a>00812                      <span class="stringliteral">"filename for package %s: %s\n"</span>), name, errorString);
<a name="l00813"></a>00813                 <span class="keywordflow">return</span> <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>;
<a name="l00814"></a>00814             }
<a name="l00815"></a>00815             fn = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(<span class="stringliteral">"%{_rpmdir}/"</span>, binRpm, NULL);
<a name="l00816"></a>00816             <span class="keywordflow">if</span> ((binDir = strchr(binRpm, <span class="charliteral">'/'</span>)) != NULL) {
<a name="l00817"></a>00817                 <span class="keyword">struct </span>stat st;
<a name="l00818"></a>00818                 <span class="keyword">const</span> <span class="keywordtype">char</span> *dn;
<a name="l00819"></a>00819                 *binDir = <span class="charliteral">'\0'</span>;
<a name="l00820"></a>00820                 dn = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(<span class="stringliteral">"%{_rpmdir}/"</span>, binRpm, NULL);
<a name="l00821"></a>00821                 <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#dc0189fecdf5b08ae2d6b7c7f7906f87" title="stat(2) clone.">Stat</a>(dn, &amp;st) &lt; 0) {
<a name="l00822"></a>00822                     <span class="keywordflow">switch</span>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>) {
<a name="l00823"></a>00823                     <span class="keywordflow">case</span>  ENOENT:
<a name="l00824"></a>00824                         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#4faa989db577f600d6a7ffdc73d779e6" title="mkdir(2) clone.">Mkdir</a>(dn, 0755) == 0)
<a name="l00825"></a>00825                             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00826"></a>00826                         <span class="comment">/*@fallthrough@*/</span>
<a name="l00827"></a>00827                     <span class="keywordflow">default</span>:
<a name="l00828"></a>00828                         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66baf0bc948ebef64f39be16826309dc2daf">RPMERR_BADFILENAME</a>,<a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"cannot create %s: %s\n"</span>),
<a name="l00829"></a>00829                             dn, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l00830"></a>00830                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00831"></a>00831                     }
<a name="l00832"></a>00832                 }
<a name="l00833"></a>00833                 dn = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(dn);
<a name="l00834"></a>00834             }
<a name="l00835"></a>00835             binRpm = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(binRpm);
<a name="l00836"></a>00836         }
<a name="l00837"></a>00837 
<a name="l00838"></a>00838         memset(csa, 0, <span class="keyword">sizeof</span>(*csa));
<a name="l00839"></a>00839         csa-&gt;cpioArchiveSize = 0;
<a name="l00840"></a>00840         <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l00841"></a>00841         csa-&gt;cpioFdIn = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"init (packageBinaries)"</span>);
<a name="l00842"></a>00842         <span class="comment">/*@-assignexpose -newreftrans@*/</span>
<a name="l00843"></a>00843         csa-&gt;cpioList = <a class="code" href="rpmfi_8h.html#4345738dd5db5084d0875c2d9a7354b4">rpmfiLink</a>(pkg-&gt;<a class="code" href="structPackage__s.html#22895a51d58ee7526cb78e88653726c0">cpioList</a>, <span class="stringliteral">"packageBinaries"</span>);
<a name="l00844"></a>00844         <span class="comment">/*@=assignexpose =newreftrans@*/</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846         rc = <a class="code" href="buildio_8h.html#99fe89674dc3339d3620bee258428b67" title="Write rpm package to file.">writeRPM</a>(&amp;pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, NULL, fn, <a class="code" href="rpmlib_8h.html#090941049e017f2cbe4174a760afec6a">RPMLEAD_BINARY</a>,
<a name="l00847"></a>00847                     csa, spec-&gt;<a class="code" href="structSpec__s.html#5089a1911121bb12f28bfcbebfb88036">passPhrase</a>, NULL);
<a name="l00848"></a>00848 
<a name="l00849"></a>00849         csa-&gt;cpioList = <a class="code" href="rpmfi_8c.html#577687ae390b322e982251d7c07deb50" title="Destroy a file info set.">rpmfiFree</a>(csa-&gt;cpioList);
<a name="l00850"></a>00850         csa-&gt;cpioFdIn = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(csa-&gt;cpioFdIn, <span class="stringliteral">"init (packageBinaries)"</span>);
<a name="l00851"></a>00851         <span class="comment">/*@=type@*/</span>
<a name="l00852"></a>00852         fn = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fn);
<a name="l00853"></a>00853         <span class="keywordflow">if</span> (rc)
<a name="l00854"></a>00854             <span class="keywordflow">return</span> rc;
<a name="l00855"></a>00855     }
<a name="l00856"></a>00856     
<a name="l00857"></a>00857     <span class="keywordflow">return</span> 0;
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00860"></a>00860 
<a name="l00861"></a>00861 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00862"></a><a class="code" href="group__rpmbuild.html#gc634c6e6f9f7aa7145b2fc1eb897747a">00862</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmbuild.html#gc634c6e6f9f7aa7145b2fc1eb897747a" title="Generate source package.">packageSources</a>(<a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec)
<a name="l00863"></a>00863 {
<a name="l00864"></a>00864     <span class="keyword">struct </span><a class="code" href="structcpioSourceArchive__s.html">cpioSourceArchive_s</a> csabuf;
<a name="l00865"></a>00865     <a class="code" href="structcpioSourceArchive__s.html">CSA_t</a> csa = &amp;csabuf;
<a name="l00866"></a>00866     <span class="keywordtype">int</span> rc;
<a name="l00867"></a>00867 
<a name="l00868"></a>00868     <span class="comment">/* Add some cruft */</span>
<a name="l00869"></a>00869     (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(spec-&gt;<a class="code" href="structSpec__s.html#43682f939205985b1d28e31117f8f095">sourceHeader</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591ef77e88a37ae8b474a5eba827d165230">RPMTAG_RPMVERSION</a>,
<a name="l00870"></a>00870                    <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, <a class="code" href="config_8h.html#d50944c12fe46b051e56ecff63a08c17">VERSION</a>, 1);
<a name="l00871"></a>00871     (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(spec-&gt;<a class="code" href="structSpec__s.html#43682f939205985b1d28e31117f8f095">sourceHeader</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591e443b308465ad92786f20cd11acc9e51">RPMTAG_BUILDHOST</a>,
<a name="l00872"></a>00872                    <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43cfe25304f92990326ba5c31d4ced5a84d">RPM_STRING_TYPE</a>, <a class="code" href="group__rpmbuild.html#gdd5e851a60303e7ff7263428daecadb0" title="Return build hostname.">buildHost</a>(), 1);
<a name="l00873"></a>00873     (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(spec-&gt;<a class="code" href="structSpec__s.html#43682f939205985b1d28e31117f8f095">sourceHeader</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917fe1cd37eb83784a5bc4fc043ebfb481">RPMTAG_BUILDTIME</a>,
<a name="l00874"></a>00874                    <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>, <a class="code" href="group__rpmbuild.html#g2149d4cbf95cc58219a5c1ab126a4133" title="Return build time stamp.">getBuildTime</a>(), 1);
<a name="l00875"></a>00875 
<a name="l00876"></a>00876     (void) <a class="code" href="pack_8c.html#1aaf62bc9b13b7d870536baa37cd4344">genSourceRpmName</a>(spec);
<a name="l00877"></a>00877 
<a name="l00878"></a>00878     spec-&gt;<a class="code" href="structSpec__s.html#6bb9ca036787a5cf51573f8178e4b70a">cookie</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(spec-&gt;<a class="code" href="structSpec__s.html#6bb9ca036787a5cf51573f8178e4b70a">cookie</a>);
<a name="l00879"></a>00879     
<a name="l00880"></a>00880     <span class="comment">/* XXX this should be %_srpmdir */</span>
<a name="l00881"></a>00881     {   <span class="keyword">const</span> <span class="keywordtype">char</span> *fn = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(<span class="stringliteral">"%{_srcrpmdir}/"</span>, spec-&gt;<a class="code" href="structSpec__s.html#6ed780920ce83bf828282dbbb104ddb2">sourceRpmName</a>,NULL);
<a name="l00882"></a>00882 
<a name="l00883"></a>00883         memset(csa, 0, <span class="keyword">sizeof</span>(*csa));
<a name="l00884"></a>00884         csa-&gt;cpioArchiveSize = 0;
<a name="l00885"></a>00885         <span class="comment">/*@-type@*/</span> <span class="comment">/* LCL: function typedefs */</span>
<a name="l00886"></a>00886         csa-&gt;cpioFdIn = <a class="code" href="rpmio_8h.html#61b095e9014d2d9c84623a800f51527e">fdNew</a>(<span class="stringliteral">"init (packageSources)"</span>);
<a name="l00887"></a>00887         <span class="comment">/*@-assignexpose -newreftrans@*/</span>
<a name="l00888"></a>00888         csa-&gt;cpioList = <a class="code" href="rpmfi_8h.html#4345738dd5db5084d0875c2d9a7354b4">rpmfiLink</a>(spec-&gt;<a class="code" href="structSpec__s.html#27343ea7c214826328688010f54b1968">sourceCpioList</a>, <span class="stringliteral">"packageSources"</span>);
<a name="l00889"></a>00889         <span class="comment">/*@=assignexpose =newreftrans@*/</span>
<a name="l00890"></a>00890 
<a name="l00891"></a>00891         spec-&gt;<a class="code" href="structSpec__s.html#8d2536ae77469160111a1b4ad7c9c2d6">sourcePkgId</a> = NULL;
<a name="l00892"></a>00892         rc = <a class="code" href="buildio_8h.html#99fe89674dc3339d3620bee258428b67" title="Write rpm package to file.">writeRPM</a>(&amp;spec-&gt;<a class="code" href="structSpec__s.html#43682f939205985b1d28e31117f8f095">sourceHeader</a>, &amp;spec-&gt;<a class="code" href="structSpec__s.html#8d2536ae77469160111a1b4ad7c9c2d6">sourcePkgId</a>, fn, <a class="code" href="rpmlib_8h.html#71b6c1984783d95751b7e938ede4a234">RPMLEAD_SOURCE</a>,
<a name="l00893"></a>00893                 csa, spec-&gt;<a class="code" href="structSpec__s.html#5089a1911121bb12f28bfcbebfb88036">passPhrase</a>, &amp;(spec-&gt;<a class="code" href="structSpec__s.html#6bb9ca036787a5cf51573f8178e4b70a">cookie</a>));
<a name="l00894"></a>00894 
<a name="l00895"></a>00895         csa-&gt;cpioList = <a class="code" href="rpmfi_8c.html#577687ae390b322e982251d7c07deb50" title="Destroy a file info set.">rpmfiFree</a>(csa-&gt;cpioList);
<a name="l00896"></a>00896         csa-&gt;cpioFdIn = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(csa-&gt;cpioFdIn, <span class="stringliteral">"init (packageSources)"</span>);
<a name="l00897"></a>00897         <span class="comment">/*@=type@*/</span>
<a name="l00898"></a>00898         fn = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fn);
<a name="l00899"></a>00899     }
<a name="l00900"></a>00900     <span class="keywordflow">return</span> rc;
<a name="l00901"></a>00901 }
<a name="l00902"></a>00902 <span class="comment">/*@=boundswrite@*/</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:53 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
