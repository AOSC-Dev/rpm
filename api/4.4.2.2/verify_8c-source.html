<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: lib/verify.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>lib/verify.c</h1><a href="verify_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;<a class="code" href="rpmcli_8h.html">rpmcli.h</a>&gt;</span>
<a name="l00009"></a>00009 
<a name="l00010"></a>00010 <span class="preprocessor">#include "<a class="code" href="psm_8h.html" title="Package state machine to handle a package from a transaction set.">psm.h</a>"</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="rpmfi_8h.html" title="Structure(s) used for file info tag sets.">rpmfi.h</a>"</span>
<a name="l00012"></a>00012 <span class="preprocessor">#include "<a class="code" href="rpmts_8h.html" title="Structures and prototypes used for an "rpmts" transaction set.">rpmts.h</a>"</span>
<a name="l00013"></a>00013 
<a name="l00014"></a>00014 <span class="preprocessor">#include "<a class="code" href="legacy_8h.html">legacy.h</a>"</span>     <span class="comment">/* XXX domd5(), uidToUname(), gnameToGid */</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include "<a class="code" href="ugid_8h.html">ugid.h</a>"</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 <span class="comment">/*@access rpmps @*/</span>
<a name="l00019"></a>00019 <span class="comment">/*@access rpmProblem @*/</span>
<a name="l00020"></a>00020 <span class="comment">/*@access rpmpsm @*/</span>    <span class="comment">/* XXX for %verifyscript through rpmpsmStage() */</span>
<a name="l00021"></a>00021 
<a name="l00022"></a><a class="code" href="verify_8c.html#f6b2cad166b22864effd2d512ee3b7e9">00022</a> <span class="preprocessor">#define S_ISDEV(m) (S_ISBLK((m)) || S_ISCHR((m)))</span>
<a name="l00023"></a>00023 <span class="preprocessor"></span>
<a name="l00024"></a>00024 <span class="comment">/*@unchecked@*/</span>
<a name="l00025"></a>00025 <span class="keyword">extern</span> <span class="keywordtype">int</span> <a class="code" href="rpmds_8c.html#67c004f2ccdaf02436ce000ec9e38955">_rpmds_unspecified_epoch_noise</a>;
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="group__rpmcli.html#g8be922aa2e849e5a063ea590b9054cf2">00027</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmcli.html#g8be922aa2e849e5a063ea590b9054cf2" title="Verify file attributes (including MD5 sum).">rpmVerifyFile</a>(<span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts, <span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi,
<a name="l00028"></a>00028                 <a class="code" href="group__rpmcli.html#ga7fb2a2f2e20671c828c4826a59262c2" title="Bit(s) for rpmVerifyFile() attributes and result.">rpmVerifyAttrs</a> * res, <a class="code" href="group__rpmcli.html#ga7fb2a2f2e20671c828c4826a59262c2" title="Bit(s) for rpmVerifyFile() attributes and result.">rpmVerifyAttrs</a> omitMask)
<a name="l00029"></a>00029 {
<a name="l00030"></a>00030     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> fmode = <a class="code" href="rpmfi_8c.html#67eaa88c525f6ab4fa6bd2abb2176334" title="Return current file mode from file info set.">rpmfiFMode</a>(fi);
<a name="l00031"></a>00031     <a class="code" href="rpmlib_8h.html#42e3d1e008de3a88813533b101cc9649" title="File Attributes.">rpmfileAttrs</a> fileAttrs = <a class="code" href="rpmfi_8c.html#f1595e307312796aa9baff1862877b98" title="Return current file flags from file info set.">rpmfiFFlags</a>(fi);
<a name="l00032"></a>00032     <a class="code" href="group__rpmcli.html#ga7fb2a2f2e20671c828c4826a59262c2" title="Bit(s) for rpmVerifyFile() attributes and result.">rpmVerifyAttrs</a> flags = <a class="code" href="rpmfi_8c.html#fe662ae664f94ba5d11dc8d0ec973f58" title="Return current file verify flags from file info set.">rpmfiVFlags</a>(fi);
<a name="l00033"></a>00033     <span class="keyword">const</span> <span class="keywordtype">char</span> * fn = <a class="code" href="rpmfi_8c.html#f6262c3acd5122d1d73a81da25044bde" title="Return current file name from file info set.">rpmfiFN</a>(fi);
<a name="l00034"></a>00034     <span class="keyword">const</span> <span class="keywordtype">char</span> * rootDir = <a class="code" href="group__rpmts.html#gc92f3c6b2822fc041c7946f89b1cde72" title="Get transaction rootDir, i.e.">rpmtsRootDir</a>(ts);
<a name="l00035"></a>00035     <span class="keywordtype">int</span> selinuxEnabled = <a class="code" href="group__rpmts.html#g2e0f222f70e2e2017f8d6c37de090957" title="Get selinuxEnabled flag, i.e.">rpmtsSELinuxEnabled</a>(ts);
<a name="l00036"></a>00036     <span class="keyword">struct </span>stat sb;
<a name="l00037"></a>00037     <span class="keywordtype">int</span> rc;
<a name="l00038"></a>00038 
<a name="l00039"></a>00039     <span class="comment">/* Prepend the path to root (if specified). */</span>
<a name="l00040"></a>00040 <span class="comment">/*@-bounds@*/</span>
<a name="l00041"></a>00041     <span class="keywordflow">if</span> (rootDir &amp;&amp; *rootDir != <span class="charliteral">'\0'</span>
<a name="l00042"></a>00042      &amp;&amp; !(rootDir[0] == <span class="charliteral">'/'</span> &amp;&amp; rootDir[1] == <span class="charliteral">'\0'</span>))
<a name="l00043"></a>00043     {
<a name="l00044"></a>00044         <span class="keywordtype">int</span> nb = strlen(fn) + strlen(rootDir) + 1;
<a name="l00045"></a>00045         <span class="keywordtype">char</span> * tb = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(nb);
<a name="l00046"></a>00046         <span class="keywordtype">char</span> * t;
<a name="l00047"></a>00047 
<a name="l00048"></a>00048         t = tb;
<a name="l00049"></a>00049         *t = <span class="charliteral">'\0'</span>;
<a name="l00050"></a>00050         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, rootDir);
<a name="l00051"></a>00051         <span class="keywordflow">while</span> (t &gt; tb &amp;&amp; t[-1] == <span class="charliteral">'/'</span>) {
<a name="l00052"></a>00052             --t;
<a name="l00053"></a>00053             *t = <span class="charliteral">'\0'</span>;
<a name="l00054"></a>00054         }
<a name="l00055"></a>00055         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, fn);
<a name="l00056"></a>00056         fn = tb;
<a name="l00057"></a>00057     }
<a name="l00058"></a>00058 <span class="comment">/*@=bounds@*/</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060     *res = <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd305d57d1efeb585dd97d4e066406d8d5">RPMVERIFY_NONE</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     <span class="comment">/*</span>
<a name="l00063"></a>00063 <span class="comment">     * Check to see if the file was installed - if not pretend all is OK.</span>
<a name="l00064"></a>00064 <span class="comment">     */</span>
<a name="l00065"></a>00065     <span class="keywordflow">switch</span> (<a class="code" href="rpmfi_8c.html#b7039d3deb64569366569345a6342ec5" title="Return current file state from file info set.">rpmfiFState</a>(fi)) {
<a name="l00066"></a>00066     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d44422280430234e88d5ffff1c452c5ba1fccb">RPMFILE_STATE_NETSHARED</a>:
<a name="l00067"></a>00067     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d44422b2fcc5be0f2d5cf441e2617d6223ab5b">RPMFILE_STATE_REPLACED</a>:
<a name="l00068"></a>00068     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d44422dd88bd354fa1c6935ef40a667693a2dd">RPMFILE_STATE_NOTINSTALLED</a>:
<a name="l00069"></a>00069     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d444220dfc8bec92232f3092959fed108b177c">RPMFILE_STATE_WRONGCOLOR</a>:
<a name="l00070"></a>00070         <span class="keywordflow">return</span> 0;
<a name="l00071"></a>00071         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l00072"></a>00072     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d44422fba3c703afcdb645a0dedb0241d5b39b">RPMFILE_STATE_NORMAL</a>:
<a name="l00073"></a>00073         <span class="keywordflow">break</span>;
<a name="l00074"></a>00074     }
<a name="l00075"></a>00075 
<a name="l00076"></a>00076     <span class="keywordflow">if</span> (fn == NULL || <a class="code" href="rpmio_8h.html#ee2e08f0e6b4ae4b948c20020760a449" title="lstat(2) clone.">Lstat</a>(fn, &amp;sb) != 0) {
<a name="l00077"></a>00077         *res |= <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700ddc404346c760333f29257b5437f021f14">RPMVERIFY_LSTATFAIL</a>;
<a name="l00078"></a>00078         <span class="keywordflow">return</span> 1;
<a name="l00079"></a>00079     }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081     <span class="comment">/*</span>
<a name="l00082"></a>00082 <span class="comment">     * Not all attributes of non-regular files can be verified.</span>
<a name="l00083"></a>00083 <span class="comment">     */</span>
<a name="l00084"></a>00084     <span class="keywordflow">if</span> (S_ISDIR(sb.st_mode))
<a name="l00085"></a>00085         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a> | 
<a name="l00086"></a>00086                         <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>);
<a name="l00087"></a>00087     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(sb.st_mode)) {
<a name="l00088"></a>00088         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a> |
<a name="l00089"></a>00089                 <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0fc8b2f50af2bffb1f5d7ee6d510409e">RPMVERIFY_MODE</a>);
<a name="l00090"></a>00090 <span class="preprocessor">#if CHOWN_FOLLOWS_SYMLINK</span>
<a name="l00091"></a>00091 <span class="preprocessor"></span>            flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd99d85a7054239cd787d6998015c817f9">RPMVERIFY_USER</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd7d76a97ded17bde8ca1d3996d0e5910e">RPMVERIFY_GROUP</a>);
<a name="l00092"></a>00092 <span class="preprocessor">#endif</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span>    }
<a name="l00094"></a>00094     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISFIFO(sb.st_mode))
<a name="l00095"></a>00095         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a> | 
<a name="l00096"></a>00096                         <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>);
<a name="l00097"></a>00097     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISCHR(sb.st_mode))
<a name="l00098"></a>00098         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a> | 
<a name="l00099"></a>00099                         <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>);
<a name="l00100"></a>00100     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISBLK(sb.st_mode))
<a name="l00101"></a>00101         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a> | 
<a name="l00102"></a>00102                         <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>);
<a name="l00103"></a>00103     <span class="keywordflow">else</span> 
<a name="l00104"></a>00104         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>);
<a name="l00105"></a>00105 
<a name="l00106"></a>00106     <span class="comment">/*</span>
<a name="l00107"></a>00107 <span class="comment">     * Content checks of %ghost files are meaningless.</span>
<a name="l00108"></a>00108 <span class="comment">     */</span>
<a name="l00109"></a>00109     <span class="keywordflow">if</span> (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>)
<a name="l00110"></a>00110         flags &amp;= ~(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a> | <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a> | 
<a name="l00111"></a>00111                         <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     <span class="comment">/*</span>
<a name="l00114"></a>00114 <span class="comment">     * Don't verify any features in omitMask.</span>
<a name="l00115"></a>00115 <span class="comment">     */</span>
<a name="l00116"></a>00116     flags &amp;= ~(omitMask | <a class="code" href="rpmcli_8h.html#87b6f840d575b3640826260ef79f9ec5">RPMVERIFY_FAILURES</a>);
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="comment">/*@=branchstate@*/</span>
<a name="l00119"></a>00119 
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a>) {
<a name="l00121"></a>00121         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> md5sum[16];
<a name="l00122"></a>00122         <span class="keywordtype">size_t</span> fsize;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124         <span class="comment">/* XXX If --nomd5, then prelinked library sizes are not corrected. */</span>
<a name="l00125"></a>00125         rc = <a class="code" href="legacy_8c.html#1d4686e95c90e1a91f016655fbe85ece" title="Return MD5 sum and size of a file.">domd5</a>(fn, md5sum, 0, &amp;fsize);
<a name="l00126"></a>00126         sb.st_size = fsize;
<a name="l00127"></a>00127         <span class="keywordflow">if</span> (rc)
<a name="l00128"></a>00128             *res |= (<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700ddf72f8eb5b85f6e1176be6dd4225ee75b">RPMVERIFY_READFAIL</a>|RPMVERIFY_MD5);
<a name="l00129"></a>00129         <span class="keywordflow">else</span> {
<a name="l00130"></a>00130             <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * MD5 = <a class="code" href="rpmfi_8c.html#731dd16e75b4741f2d0e81127e2e0e93" title="Return current file (binary) md5 digest from file info set.">rpmfiMD5</a>(fi);
<a name="l00131"></a>00131             <span class="keywordflow">if</span> (MD5 == NULL || memcmp(md5sum, MD5, <span class="keyword">sizeof</span>(md5sum)))
<a name="l00132"></a>00132                 *res |= RPMVERIFY_MD5;
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134     } 
<a name="l00135"></a>00135 
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>) {
<a name="l00137"></a>00137         <span class="keywordtype">char</span> linkto[1024+1];
<a name="l00138"></a>00138         <span class="keywordtype">int</span> size = 0;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140         <span class="keywordflow">if</span> ((size = <a class="code" href="rpmio_8h.html#c91f92d5fe048feda9fb07dfee22b625" title="readlink(2) clone.">Readlink</a>(fn, linkto, <span class="keyword">sizeof</span>(linkto)-1)) == -1)
<a name="l00141"></a>00141             *res |= (<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700ddc909895cb3b56a36851f14e8d3a7ad00">RPMVERIFY_READLINKFAIL</a>|RPMVERIFY_LINKTO);
<a name="l00142"></a>00142         <span class="keywordflow">else</span> {
<a name="l00143"></a>00143             <span class="keyword">const</span> <span class="keywordtype">char</span> * flink = <a class="code" href="rpmfi_8c.html#d49f1566cffe3a5dede2cd4ebbd001c7" title="Return current file linkto (i.e.">rpmfiFLink</a>(fi);
<a name="l00144"></a>00144             linkto[size] = <span class="charliteral">'\0'</span>;
<a name="l00145"></a>00145             <span class="keywordflow">if</span> (flink == NULL || strcmp(linkto, flink))
<a name="l00146"></a>00146                 *res |= RPMVERIFY_LINKTO;
<a name="l00147"></a>00147         }
<a name="l00148"></a>00148     } 
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a>) {
<a name="l00151"></a>00151         <span class="keywordflow">if</span> (sb.st_size != <a class="code" href="rpmfi_8c.html#6e76008c544e35438e9334ec7d9ead34" title="Return current file size from file info set.">rpmfiFSize</a>(fi))
<a name="l00152"></a>00152             *res |= RPMVERIFY_FILESIZE;
<a name="l00153"></a>00153     } 
<a name="l00154"></a>00154 
<a name="l00155"></a>00155     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0fc8b2f50af2bffb1f5d7ee6d510409e">RPMVERIFY_MODE</a>) {
<a name="l00156"></a>00156         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> metamode = fmode;
<a name="l00157"></a>00157         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> filemode;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159         <span class="comment">/*</span>
<a name="l00160"></a>00160 <span class="comment">         * Platforms (like AIX) where sizeof(unsigned short) != sizeof(mode_t)</span>
<a name="l00161"></a>00161 <span class="comment">         * need the (unsigned short) cast here. </span>
<a name="l00162"></a>00162 <span class="comment">         */</span>
<a name="l00163"></a>00163         filemode = (<span class="keywordtype">unsigned</span> short)sb.st_mode;
<a name="l00164"></a>00164 
<a name="l00165"></a>00165         <span class="comment">/*</span>
<a name="l00166"></a>00166 <span class="comment">         * Comparing the type of %ghost files is meaningless, but perms are OK.</span>
<a name="l00167"></a>00167 <span class="comment">         */</span>
<a name="l00168"></a>00168         if (fileAttrs &amp; RPMFILE_GHOST) {
<a name="l00169"></a>00169             metamode &amp;= ~0xf000;
<a name="l00170"></a>00170             filemode &amp;= ~0xf000;
<a name="l00171"></a>00171         }
<a name="l00172"></a>00172 
<a name="l00173"></a>00173         <span class="keywordflow">if</span> (metamode != filemode)
<a name="l00174"></a>00174             *res |= RPMVERIFY_MODE;
<a name="l00175"></a>00175     }
<a name="l00176"></a>00176 
<a name="l00177"></a>00177     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd358d2cfa41da73adbc157f7a0b0b1893">RPMVERIFY_RDEV</a>) {
<a name="l00178"></a>00178         <span class="keywordflow">if</span> (S_ISCHR(fmode) != S_ISCHR(sb.st_mode)
<a name="l00179"></a>00179          || S_ISBLK(fmode) != S_ISBLK(sb.st_mode))
<a name="l00180"></a>00180         {
<a name="l00181"></a>00181             *res |= RPMVERIFY_RDEV;
<a name="l00182"></a>00182         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="verify_8c.html#f6b2cad166b22864effd2d512ee3b7e9">S_ISDEV</a>(fmode) &amp;&amp; <a class="code" href="verify_8c.html#f6b2cad166b22864effd2d512ee3b7e9">S_ISDEV</a>(sb.st_mode)) {
<a name="l00183"></a>00183             <a class="code" href="header_8h.html#2eed8fa2bf2987b2c269939d341d3b25">uint_16</a> st_rdev = (sb.st_rdev &amp; 0xffff);
<a name="l00184"></a>00184             <a class="code" href="header_8h.html#2eed8fa2bf2987b2c269939d341d3b25">uint_16</a> frdev = (<a class="code" href="rpmfi_8c.html#0cc18d23977b5c20db8d55108dce5aa3" title="Return current file rdev from file info set.">rpmfiFRdev</a>(fi) &amp; 0xffff);
<a name="l00185"></a>00185             <span class="keywordflow">if</span> (st_rdev != frdev)
<a name="l00186"></a>00186                 *res |= RPMVERIFY_RDEV;
<a name="l00187"></a>00187         } 
<a name="l00188"></a>00188     }
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a>) {
<a name="l00191"></a>00191         <span class="keywordflow">if</span> (sb.st_mtime != <a class="code" href="rpmfi_8c.html#58a612ca06387ee35632feadb9067c27" title="Return current file modify time from file info set.">rpmfiFMtime</a>(fi))
<a name="l00192"></a>00192             *res |= RPMVERIFY_MTIME;
<a name="l00193"></a>00193     }
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd99d85a7054239cd787d6998015c817f9">RPMVERIFY_USER</a>) {
<a name="l00196"></a>00196         <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structname.html">name</a> = <a class="code" href="ugid_8c.html#cf0cc39ff59615e575922093e52da022">uidToUname</a>(sb.st_uid);
<a name="l00197"></a>00197         <span class="keyword">const</span> <span class="keywordtype">char</span> * fuser = <a class="code" href="rpmfi_8c.html#f146ca5542a12b011e5263caa0e4737e" title="Return current file owner from file info set.">rpmfiFUser</a>(fi);
<a name="l00198"></a>00198         <span class="keywordflow">if</span> (name == NULL || fuser == NULL || strcmp(name, fuser))
<a name="l00199"></a>00199             *res |= RPMVERIFY_USER;
<a name="l00200"></a>00200     }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <span class="keywordflow">if</span> (flags &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd7d76a97ded17bde8ca1d3996d0e5910e">RPMVERIFY_GROUP</a>) {
<a name="l00203"></a>00203         <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structname.html">name</a> = <a class="code" href="ugid_8c.html#4a88939881542f93d6f62e40592627b9">gidToGname</a>(sb.st_gid);
<a name="l00204"></a>00204         <span class="keyword">const</span> <span class="keywordtype">char</span> * fgroup = <a class="code" href="rpmfi_8c.html#1af5c8bd4134962a6d46ce5bfa25ae66" title="Return current file group from file info set.">rpmfiFGroup</a>(fi);
<a name="l00205"></a>00205         <span class="keywordflow">if</span> (name == NULL || fgroup == NULL || strcmp(name, fgroup))
<a name="l00206"></a>00206             *res |= RPMVERIFY_GROUP;
<a name="l00207"></a>00207     }
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">return</span> 0;
<a name="l00210"></a>00210 }
<a name="l00211"></a>00211 
<a name="l00221"></a><a class="code" href="verify_8c.html#c7495acc1413b63c9b197b02fd450464">00221</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="verify_8c.html#c7495acc1413b63c9b197b02fd450464" title="Return exit code from running verify script from header.">rpmVerifyScript</a>(<span class="comment">/*@unused@*/</span> <a class="code" href="structrpmQVKArguments__s.html" title="Describe query/verify/signature command line operation.">QVA_t</a> qva, <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts,
<a name="l00222"></a>00222                 <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi, <span class="comment">/*@null@*/</span> <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> scriptFd)
<a name="l00223"></a>00223         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00224"></a>00224         <span class="comment">/*@modifies ts, fi, scriptFd, rpmGlobalMacroContext,</span>
<a name="l00225"></a>00225 <span class="comment">                fileSystem, internalState @*/</span>
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     <a class="code" href="structrpmpsm__s.html">rpmpsm</a> psm = <a class="code" href="psm_8c.html#81b9bae945250db05ce68d990bc80511" title="Create and load a package state machine.">rpmpsmNew</a>(ts, NULL, fi);
<a name="l00228"></a>00228     <span class="keywordtype">int</span> rc = 0;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keywordflow">if</span> (psm == NULL)    <span class="comment">/* XXX can't happen */</span>
<a name="l00231"></a>00231         <span class="keywordflow">return</span> rc;
<a name="l00232"></a>00232 
<a name="l00233"></a>00233     <span class="keywordflow">if</span> (scriptFd != NULL)
<a name="l00234"></a>00234         <a class="code" href="group__rpmts.html#g3e9dfca7ad97a03af2c9eef355cb07cf" title="Set transaction script file handle, i.e.">rpmtsSetScriptFd</a>(psm-&gt;<a class="code" href="structrpmpsm__s.html#09a3c1c4fc7b8c892f0f91822a54091d">ts</a>, scriptFd);
<a name="l00235"></a>00235 
<a name="l00236"></a>00236     psm-&gt;<a class="code" href="structrpmpsm__s.html#83294fd48a388b10f90183c1f4883b7b">stepName</a> = <span class="stringliteral">"verify"</span>;
<a name="l00237"></a>00237     psm-&gt;<a class="code" href="structrpmpsm__s.html#68aaebc64f38e30920e6def405d8286d">scriptTag</a> = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591de13fe7a31fb26b80a3472ff4fed35a3">RPMTAG_VERIFYSCRIPT</a>;
<a name="l00238"></a>00238     psm-&gt;<a class="code" href="structrpmpsm__s.html#6d08d5555aebb94e20860d401e399fd5">progTag</a> = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f9b7457fb001325ec0373647a2e7327f">RPMTAG_VERIFYSCRIPTPROG</a>;
<a name="l00239"></a>00239     rc = <a class="code" href="psm_8c.html#b88cdc4aec4947089e9fd7ea5b0f96d5" title="Package state machine driver.">rpmpsmStage</a>(psm, <a class="code" href="psm_8h.html#0109351d3159a533681094ee278a15c6c5ccb555ea14269c2e123260fefcbb5d">PSM_SCRIPT</a>);
<a name="l00240"></a>00240 
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (scriptFd != NULL)
<a name="l00242"></a>00242         <a class="code" href="group__rpmts.html#g3e9dfca7ad97a03af2c9eef355cb07cf" title="Set transaction script file handle, i.e.">rpmtsSetScriptFd</a>(psm-&gt;<a class="code" href="structrpmpsm__s.html#09a3c1c4fc7b8c892f0f91822a54091d">ts</a>, NULL);
<a name="l00243"></a>00243 
<a name="l00244"></a>00244     psm = <a class="code" href="psm_8c.html#a1e982938a6245f0c96d479dfc114037" title="Destroy a package state machine.">rpmpsmFree</a>(psm);
<a name="l00245"></a>00245 
<a name="l00246"></a>00246     <span class="keywordflow">return</span> rc;
<a name="l00247"></a>00247 }
<a name="l00248"></a>00248 
<a name="l00256"></a><a class="code" href="verify_8c.html#37bda9f6c3f8c3931b3921862be1a1fe">00256</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="verify_8c.html#37bda9f6c3f8c3931b3921862be1a1fe" title="Check file info from header against what's actually installed.">verifyHeader</a>(<a class="code" href="structrpmQVKArguments__s.html" title="Describe query/verify/signature command line operation.">QVA_t</a> qva, <span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts, <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi)
<a name="l00257"></a>00257         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00258"></a>00258         <span class="comment">/*@modifies ts, fi, fileSystem, internalState  @*/</span>
<a name="l00259"></a>00259 {
<a name="l00260"></a>00260     <span class="keywordtype">int</span> selinuxEnabled = <a class="code" href="group__rpmts.html#g2e0f222f70e2e2017f8d6c37de090957" title="Get selinuxEnabled flag, i.e.">rpmtsSELinuxEnabled</a>(ts);
<a name="l00261"></a>00261     <a class="code" href="group__rpmcli.html#ga7fb2a2f2e20671c828c4826a59262c2" title="Bit(s) for rpmVerifyFile() attributes and result.">rpmVerifyAttrs</a> verifyResult = 0;
<a name="l00262"></a>00262     <span class="comment">/*@-type@*/</span> <span class="comment">/* FIX: union? */</span>
<a name="l00263"></a>00263     <a class="code" href="group__rpmcli.html#ga7fb2a2f2e20671c828c4826a59262c2" title="Bit(s) for rpmVerifyFile() attributes and result.">rpmVerifyAttrs</a> omitMask = ((qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="rpmcli_8h.html#4091a64c581c2447f0f556f1778fe3b0">VERIFY_ATTRS</a>) ^ <a class="code" href="rpmcli_8h.html#4091a64c581c2447f0f556f1778fe3b0">VERIFY_ATTRS</a>);
<a name="l00264"></a>00264     <span class="comment">/*@=type@*/</span>
<a name="l00265"></a>00265     <span class="keywordtype">int</span> ec = 0;         <span class="comment">/* assume no problems */</span>
<a name="l00266"></a>00266     <span class="keywordtype">char</span> * t, * te;
<a name="l00267"></a>00267     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00268"></a>00268     <span class="keywordtype">int</span> i;
<a name="l00269"></a>00269 
<a name="l00270"></a>00270     te = t = buf;
<a name="l00271"></a>00271     *te = <span class="charliteral">'\0'</span>;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     fi = <a class="code" href="rpmfi_8h.html#4345738dd5db5084d0875c2d9a7354b4">rpmfiLink</a>(fi, <span class="stringliteral">"verifyHeader"</span>);
<a name="l00274"></a>00274     fi = <a class="code" href="rpmfi_8c.html#3e9bb5cb07bf98264190ef67dbc88973" title="Initialize file iterator index.">rpmfiInit</a>(fi, 0);
<a name="l00275"></a>00275     <span class="keywordflow">if</span> (fi != NULL)     <span class="comment">/* XXX lclint */</span>
<a name="l00276"></a>00276     <span class="keywordflow">while</span> ((i = <a class="code" href="rpmfi_8c.html#f091d4c79bd7708322bc798e1db1160b" title="Return next file iterator index.">rpmfiNext</a>(fi)) &gt;= 0) {
<a name="l00277"></a>00277         <a class="code" href="rpmlib_8h.html#42e3d1e008de3a88813533b101cc9649" title="File Attributes.">rpmfileAttrs</a> fileAttrs;
<a name="l00278"></a>00278         <span class="keywordtype">int</span> rc;
<a name="l00279"></a>00279 
<a name="l00280"></a>00280         fileAttrs = <a class="code" href="rpmfi_8c.html#f1595e307312796aa9baff1862877b98" title="Return current file flags from file info set.">rpmfiFFlags</a>(fi);
<a name="l00281"></a>00281 
<a name="l00282"></a>00282         <span class="comment">/* If not verifying %ghost, skip ghost files. */</span>
<a name="l00283"></a>00283         <span class="keywordflow">if</span> (!(qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#a12401c6b70e561c135accc5ecf25456">qva_fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>)
<a name="l00284"></a>00284         &amp;&amp; (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>))
<a name="l00285"></a>00285             <span class="keywordflow">continue</span>;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00288"></a>00288         rc = <a class="code" href="group__rpmcli.html#g8be922aa2e849e5a063ea590b9054cf2" title="Verify file attributes (including MD5 sum).">rpmVerifyFile</a>(ts, fi, &amp;verifyResult, omitMask);
<a name="l00289"></a>00289 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (rc) {
<a name="l00291"></a>00291             <span class="keywordflow">if</span> (!(fileAttrs &amp; (<a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6364dd4b075b80d72ff5e066d9f1cbf6ad">RPMFILE_MISSINGOK</a>|RPMFILE_GHOST)) || <a class="code" href="rpmmessages_8h.html#27e9ca69465ed215147b0ec1a018a7fa">rpmIsVerbose</a>()) {
<a name="l00292"></a>00292                 sprintf(te, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"missing   %c %s"</span>),
<a name="l00293"></a>00293                         ((fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df630defccf24ceaa0c28114df156bc7b891">RPMFILE_CONFIG</a>)   ? <span class="charliteral">'c'</span> :
<a name="l00294"></a>00294                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df637102d3a7a8b21e88a5275231a1f14eaf">RPMFILE_DOC</a>)      ? <span class="charliteral">'d'</span> :
<a name="l00295"></a>00295                          (fileAttrs &amp; RPMFILE_GHOST)    ? <span class="charliteral">'g'</span> :
<a name="l00296"></a>00296                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df632cf86b56bc6190403f5c9529fe2357e5">RPMFILE_LICENSE</a>)  ? <span class="charliteral">'l'</span> :
<a name="l00297"></a>00297                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6329ffaf4b4c6fc5235665594db829eb6e">RPMFILE_PUBKEY</a>)   ? <span class="charliteral">'P'</span> :
<a name="l00298"></a>00298                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6356f8e2d26cfdb6a2323a6df0c3070579">RPMFILE_README</a>)   ? <span class="charliteral">'r'</span> : <span class="charliteral">' '</span>), 
<a name="l00299"></a>00299                         <a class="code" href="rpmfi_8c.html#f6262c3acd5122d1d73a81da25044bde" title="Return current file name from file info set.">rpmfiFN</a>(fi));
<a name="l00300"></a>00300                 te += strlen(te);
<a name="l00301"></a>00301                 <span class="keywordflow">if</span> ((verifyResult &amp; <a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700ddc404346c760333f29257b5437f021f14">RPMVERIFY_LSTATFAIL</a>) != 0 &amp;&amp;
<a name="l00302"></a>00302                     <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> != ENOENT) {
<a name="l00303"></a>00303                     sprintf(te, <span class="stringliteral">" (%s)"</span>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l00304"></a>00304                     te += strlen(te);
<a name="l00305"></a>00305                 }
<a name="l00306"></a>00306                 ec = rc;
<a name="l00307"></a>00307             }
<a name="l00308"></a>00308         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (verifyResult || <a class="code" href="rpmmessages_8h.html#27e9ca69465ed215147b0ec1a018a7fa">rpmIsVerbose</a>()) {
<a name="l00309"></a>00309             <span class="keyword">const</span> <span class="keywordtype">char</span> * size, * MD5, * <a class="code" href="structlink.html">link</a>, * mtime, * mode;
<a name="l00310"></a>00310             <span class="keyword">const</span> <span class="keywordtype">char</span> * group, * user, * rdev;
<a name="l00311"></a>00311             <span class="comment">/*@observer@*/</span> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> aok = <span class="stringliteral">"."</span>;
<a name="l00312"></a>00312             <span class="comment">/*@observer@*/</span> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> unknown = <span class="stringliteral">"?"</span>;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314             ec = 1;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316 <span class="preprocessor">#define _verify(_RPMVERIFY_F, _C)       \</span>
<a name="l00317"></a>00317 <span class="preprocessor">        ((verifyResult &amp; _RPMVERIFY_F) ? _C : aok)</span>
<a name="l00318"></a>00318 <span class="preprocessor"></span><span class="preprocessor">#define _verifylink(_RPMVERIFY_F, _C)   \</span>
<a name="l00319"></a>00319 <span class="preprocessor">        ((verifyResult &amp; RPMVERIFY_READLINKFAIL) ? unknown : \</span>
<a name="l00320"></a>00320 <span class="preprocessor">         (verifyResult &amp; _RPMVERIFY_F) ? _C : aok)</span>
<a name="l00321"></a>00321 <span class="preprocessor"></span><span class="preprocessor">#define _verifyfile(_RPMVERIFY_F, _C)   \</span>
<a name="l00322"></a>00322 <span class="preprocessor">        ((verifyResult &amp; RPMVERIFY_READFAIL) ? unknown : \</span>
<a name="l00323"></a>00323 <span class="preprocessor">         (verifyResult &amp; _RPMVERIFY_F) ? _C : aok)</span>
<a name="l00324"></a>00324 <span class="preprocessor"></span>        
<a name="l00325"></a>00325             MD5 = <a class="code" href="verify_8c.html#2924d8413bc33e5f01ecc41d4b4bc19d">_verifyfile</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0dd0b3f0bdd15cc290c2c08f90f68077">RPMVERIFY_MD5</a>, <span class="stringliteral">"5"</span>);
<a name="l00326"></a>00326             size = <a class="code" href="verify_8c.html#105eed57736303afcfa1ffe707ed77bf">_verify</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd3f3836290f936c3910dc6210e3dc1b98">RPMVERIFY_FILESIZE</a>, <span class="stringliteral">"S"</span>);
<a name="l00327"></a>00327             link = <a class="code" href="verify_8c.html#1e8f28911443336d32ae782ec79ef329">_verifylink</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dde954446fe0bb9fbf1c3f6b4b8ff52bf4">RPMVERIFY_LINKTO</a>, <span class="stringliteral">"L"</span>);
<a name="l00328"></a>00328             mtime = <a class="code" href="verify_8c.html#105eed57736303afcfa1ffe707ed77bf">_verify</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd76c516b8604724a143ab9b4fd7531f60">RPMVERIFY_MTIME</a>, <span class="stringliteral">"T"</span>);
<a name="l00329"></a>00329             rdev = <a class="code" href="verify_8c.html#105eed57736303afcfa1ffe707ed77bf">_verify</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd358d2cfa41da73adbc157f7a0b0b1893">RPMVERIFY_RDEV</a>, <span class="stringliteral">"D"</span>);
<a name="l00330"></a>00330             user = <a class="code" href="verify_8c.html#105eed57736303afcfa1ffe707ed77bf">_verify</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd99d85a7054239cd787d6998015c817f9">RPMVERIFY_USER</a>, <span class="stringliteral">"U"</span>);
<a name="l00331"></a>00331             group = <a class="code" href="verify_8c.html#105eed57736303afcfa1ffe707ed77bf">_verify</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd7d76a97ded17bde8ca1d3996d0e5910e">RPMVERIFY_GROUP</a>, <span class="stringliteral">"G"</span>);
<a name="l00332"></a>00332             mode = <a class="code" href="verify_8c.html#105eed57736303afcfa1ffe707ed77bf">_verify</a>(<a class="code" href="group__rpmcli.html#ggb0bebc342333807c65018825e89700dd0fc8b2f50af2bffb1f5d7ee6d510409e">RPMVERIFY_MODE</a>, <span class="stringliteral">"M"</span>);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="preprocessor">#undef _verifyfile</span>
<a name="l00335"></a>00335 <span class="preprocessor"></span><span class="preprocessor">#undef _verifylink</span>
<a name="l00336"></a>00336 <span class="preprocessor"></span><span class="preprocessor">#undef _verify</span>
<a name="l00337"></a>00337 <span class="preprocessor"></span>
<a name="l00338"></a>00338             sprintf(te, <span class="stringliteral">"%s%s%s%s%s%s%s%s %c %s"</span>,
<a name="l00339"></a>00339                         size, mode, MD5, rdev, link, user, group, mtime,
<a name="l00340"></a>00340                         ((fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df630defccf24ceaa0c28114df156bc7b891">RPMFILE_CONFIG</a>)   ? <span class="charliteral">'c'</span> :
<a name="l00341"></a>00341                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df637102d3a7a8b21e88a5275231a1f14eaf">RPMFILE_DOC</a>)      ? <span class="charliteral">'d'</span> :
<a name="l00342"></a>00342                          (fileAttrs &amp; RPMFILE_GHOST)    ? <span class="charliteral">'g'</span> :
<a name="l00343"></a>00343                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df632cf86b56bc6190403f5c9529fe2357e5">RPMFILE_LICENSE</a>)  ? <span class="charliteral">'l'</span> :
<a name="l00344"></a>00344                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6329ffaf4b4c6fc5235665594db829eb6e">RPMFILE_PUBKEY</a>)   ? <span class="charliteral">'P'</span> :
<a name="l00345"></a>00345                          (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6356f8e2d26cfdb6a2323a6df0c3070579">RPMFILE_README</a>)   ? <span class="charliteral">'r'</span> : <span class="charliteral">' '</span>), 
<a name="l00346"></a>00346                         <a class="code" href="rpmfi_8c.html#f6262c3acd5122d1d73a81da25044bde" title="Return current file name from file info set.">rpmfiFN</a>(fi));
<a name="l00347"></a>00347             te += strlen(te);
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00351"></a>00351         <span class="keywordflow">if</span> (te &gt; t) {
<a name="l00352"></a>00352             *te++ = <span class="charliteral">'\n'</span>;
<a name="l00353"></a>00353             *te = <span class="charliteral">'\0'</span>;
<a name="l00354"></a>00354             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <span class="stringliteral">"%s"</span>, t);
<a name="l00355"></a>00355             te = t = buf;
<a name="l00356"></a>00356             *t = <span class="charliteral">'\0'</span>;
<a name="l00357"></a>00357         }
<a name="l00358"></a>00358 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     fi = <a class="code" href="rpmfi_8h.html#05611d9693039309f1778f3a45368a1a">rpmfiUnlink</a>(fi, <span class="stringliteral">"verifyHeader"</span>);
<a name="l00361"></a>00361         
<a name="l00362"></a>00362     <span class="keywordflow">return</span> ec;
<a name="l00363"></a>00363 }
<a name="l00364"></a>00364 
<a name="l00372"></a><a class="code" href="verify_8c.html#5181398f73a5aed9be86c44388c0471b">00372</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="verify_8c.html#5181398f73a5aed9be86c44388c0471b" title="Check installed package dependencies for problems.">verifyDependencies</a>(<span class="comment">/*@unused@*/</span> <a class="code" href="structrpmQVKArguments__s.html" title="Describe query/verify/signature command line operation.">QVA_t</a> qva, <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts,
<a name="l00373"></a>00373                 <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h)
<a name="l00374"></a>00374         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00375"></a>00375         <span class="comment">/*@modifies ts, h, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00376"></a>00376 {
<a name="l00377"></a>00377     <a class="code" href="structrpmps__s.html">rpmps</a> ps;
<a name="l00378"></a>00378     <span class="keywordtype">int</span> numProblems;
<a name="l00379"></a>00379     <span class="keywordtype">int</span> rc = 0;         <span class="comment">/* assume no problems */</span>
<a name="l00380"></a>00380     <span class="keywordtype">int</span> xx;
<a name="l00381"></a>00381     <span class="keywordtype">int</span> i;
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <a class="code" href="group__rpmts.html#ga4d67c0606cb761be396eac5d9466666" title="Re-create an empty transaction set.">rpmtsEmpty</a>(ts);
<a name="l00384"></a>00384     (void) <a class="code" href="group__rpmts.html#gf498b70b7df2dda0d4cf83df9da5b1ef" title="Add package to be installed to transaction set.">rpmtsAddInstallElement</a>(ts, h, NULL, 0, NULL);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386     xx = <a class="code" href="group__rpmts.html#g2e14cca734e0c295056ce05e1d23991e" title="Check that all dependencies can be resolved.">rpmtsCheck</a>(ts);
<a name="l00387"></a>00387     ps = <a class="code" href="rpmts_8c.html#f100aa5b07188ddfdb360e8913148f00" title="Return current transaction set problems.">rpmtsProblems</a>(ts);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389     numProblems = <a class="code" href="rpmps_8c.html#b5dfcbd05dd6e9b859edf7a122efb079" title="Return number of problems in set.">rpmpsNumProblems</a>(ps);
<a name="l00390"></a>00390     <span class="comment">/*@-branchstate@*/</span>
<a name="l00391"></a>00391     <span class="keywordflow">if</span> (ps != NULL &amp;&amp; numProblems &gt; 0) {
<a name="l00392"></a>00392         <span class="keyword">const</span> <span class="keywordtype">char</span> * pkgNEVR, * altNEVR;
<a name="l00393"></a>00393         <a class="code" href="structrpmProblem__s.html">rpmProblem</a> p;
<a name="l00394"></a>00394         <span class="keywordtype">char</span> * t, * te;
<a name="l00395"></a>00395         <span class="keywordtype">int</span> nb = 512;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397         <span class="keywordflow">for</span> (i = 0; i &lt; numProblems; i++) {
<a name="l00398"></a>00398             p = ps-&gt;<a class="code" href="structrpmps__s.html#1f004c4a565780541fadb5fdff9436a3">probs</a> + i;
<a name="l00399"></a>00399             altNEVR = (p-&gt;<a class="code" href="structrpmProblem__s.html#5ace6170ea69f6cc67118f7feedd1ef7">altNEVR</a> ? p-&gt;<a class="code" href="structrpmProblem__s.html#5ace6170ea69f6cc67118f7feedd1ef7">altNEVR</a> : <span class="stringliteral">"? ?altNEVR?"</span>);
<a name="l00400"></a>00400             nb += strlen(altNEVR+2) + <span class="keyword">sizeof</span>(<span class="stringliteral">", "</span>) - 1;
<a name="l00401"></a>00401         }
<a name="l00402"></a>00402         te = t = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(nb);
<a name="l00403"></a>00403 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00404"></a>00404         *te = <span class="charliteral">'\0'</span>;
<a name="l00405"></a>00405         pkgNEVR = (ps-&gt;<a class="code" href="structrpmps__s.html#1f004c4a565780541fadb5fdff9436a3">probs</a>-&gt;<a class="code" href="structrpmProblem__s.html#b714e2ee899981138c49c3cde9faba85">pkgNEVR</a> ? ps-&gt;<a class="code" href="structrpmps__s.html#1f004c4a565780541fadb5fdff9436a3">probs</a>-&gt;<a class="code" href="structrpmProblem__s.html#b714e2ee899981138c49c3cde9faba85">pkgNEVR</a> : <span class="stringliteral">"?pkgNEVR?"</span>);
<a name="l00406"></a>00406         sprintf(te, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unsatisfied dependencies for %s: "</span>), pkgNEVR);
<a name="l00407"></a>00407         te += strlen(te);
<a name="l00408"></a>00408         <span class="keywordflow">for</span> (i = 0; i &lt; numProblems; i++) {
<a name="l00409"></a>00409             p = ps-&gt;<a class="code" href="structrpmps__s.html#1f004c4a565780541fadb5fdff9436a3">probs</a> + i;
<a name="l00410"></a>00410             altNEVR = (p-&gt;<a class="code" href="structrpmProblem__s.html#5ace6170ea69f6cc67118f7feedd1ef7">altNEVR</a> ? p-&gt;<a class="code" href="structrpmProblem__s.html#5ace6170ea69f6cc67118f7feedd1ef7">altNEVR</a> : <span class="stringliteral">"? ?altNEVR?"</span>);
<a name="l00411"></a>00411             if (i) te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(te, <span class="stringliteral">", "</span>);
<a name="l00412"></a>00412             <span class="comment">/* XXX FIXME: should probably supply the "[R|C] " type prefix */</span>
<a name="l00413"></a>00413             te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(te, altNEVR+2);
<a name="l00414"></a>00414         }
<a name="l00415"></a>00415 
<a name="l00416"></a>00416         <span class="keywordflow">if</span> (te &gt; t) {
<a name="l00417"></a>00417             *te++ = <span class="charliteral">'\n'</span>;
<a name="l00418"></a>00418             *te = <span class="charliteral">'\0'</span>;
<a name="l00419"></a>00419             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <span class="stringliteral">"%s"</span>, t);
<a name="l00420"></a>00420             te = t;
<a name="l00421"></a>00421             *t = <span class="charliteral">'\0'</span>;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00424"></a>00424         rc = 1;
<a name="l00425"></a>00425     }
<a name="l00426"></a>00426     <span class="comment">/*@=branchstate@*/</span>
<a name="l00427"></a>00427 
<a name="l00428"></a>00428     ps = <a class="code" href="rpmps_8c.html#247ffca99ff6e3d64edba3a81d6029b8" title="Destroy a problem set.">rpmpsFree</a>(ps);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <a class="code" href="group__rpmts.html#ga4d67c0606cb761be396eac5d9466666" title="Re-create an empty transaction set.">rpmtsEmpty</a>(ts);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <span class="keywordflow">return</span> rc;
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 
<a name="l00435"></a><a class="code" href="group__rpmcli.html#g7c219fd4c5fa0b18cf010d9279478422">00435</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmcli.html#g7c219fd4c5fa0b18cf010d9279478422" title="Display results of package verify.">showVerifyPackage</a>(<a class="code" href="structrpmQVKArguments__s.html" title="Describe query/verify/signature command line operation.">QVA_t</a> qva, <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts, <a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h)
<a name="l00436"></a>00436 {
<a name="l00437"></a>00437     <span class="keywordtype">int</span> scareMem = 1;   <span class="comment">/* XXX only rpmVerifyScript needs now */</span>
<a name="l00438"></a>00438     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi;
<a name="l00439"></a>00439     <span class="keywordtype">int</span> ec = 0;
<a name="l00440"></a>00440     <span class="keywordtype">int</span> rc;
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     fi = <a class="code" href="rpmfi_8c.html#7be3dd0af7bab1e4b324c891f76dc42b" title="Create and load a file info set.">rpmfiNew</a>(ts, h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359180a05d979f4bcc4aed2cc1f735c76aff">RPMTAG_BASENAMES</a>, scareMem);
<a name="l00443"></a>00443     <span class="keywordflow">if</span> (fi != NULL) {
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="keywordflow">if</span> (qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="group__rpmcli.html#gge57534cde3e9032b6b0aa7e27bfe9e7193f12960426b60e33a5b5d8f7add1671">VERIFY_DEPS</a>) {
<a name="l00446"></a>00446             <span class="keywordtype">int</span> save_noise = <a class="code" href="rpmds_8c.html#67c004f2ccdaf02436ce000ec9e38955">_rpmds_unspecified_epoch_noise</a>;
<a name="l00447"></a>00447 <span class="comment">/*@-mods@*/</span>
<a name="l00448"></a>00448             <span class="keywordflow">if</span> (<a class="code" href="rpmmessages_8h.html#27e9ca69465ed215147b0ec1a018a7fa">rpmIsVerbose</a>())
<a name="l00449"></a>00449                 <a class="code" href="rpmds_8c.html#67c004f2ccdaf02436ce000ec9e38955">_rpmds_unspecified_epoch_noise</a> = 1;
<a name="l00450"></a>00450             <span class="keywordflow">if</span> ((rc = <a class="code" href="verify_8c.html#5181398f73a5aed9be86c44388c0471b" title="Check installed package dependencies for problems.">verifyDependencies</a>(qva, ts, h)) != 0)
<a name="l00451"></a>00451                 ec = rc;
<a name="l00452"></a>00452             <a class="code" href="rpmds_8c.html#67c004f2ccdaf02436ce000ec9e38955">_rpmds_unspecified_epoch_noise</a> = save_noise;
<a name="l00453"></a>00453 <span class="comment">/*@=mods@*/</span>
<a name="l00454"></a>00454         }
<a name="l00455"></a>00455         <span class="keywordflow">if</span> (qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="group__rpmcli.html#gge57534cde3e9032b6b0aa7e27bfe9e718df4eda335fe6aa2c6a8119078e4ba4c">VERIFY_FILES</a>) {
<a name="l00456"></a>00456             <span class="keywordflow">if</span> ((rc = <a class="code" href="verify_8c.html#37bda9f6c3f8c3931b3921862be1a1fe" title="Check file info from header against what's actually installed.">verifyHeader</a>(qva, ts, fi)) != 0)
<a name="l00457"></a>00457                 ec = rc;
<a name="l00458"></a>00458         }
<a name="l00459"></a>00459         <span class="keywordflow">if</span> ((qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="group__rpmcli.html#gge57534cde3e9032b6b0aa7e27bfe9e7113417c18852a2cac65d02157c469a5f0">VERIFY_SCRIPT</a>)
<a name="l00460"></a>00460          &amp;&amp; <a class="code" href="group__header.html#g66b9abc5d3555279d547656ec0a2f245" title="Check if tag is in header.">headerIsEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591de13fe7a31fb26b80a3472ff4fed35a3">RPMTAG_VERIFYSCRIPT</a>))
<a name="l00461"></a>00461         {
<a name="l00462"></a>00462             <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fdo = <a class="code" href="rpmio_8c.html#671e4056425535bd1421347a5bcdacf9">fdDup</a>(STDOUT_FILENO);
<a name="l00463"></a>00463             <span class="keywordflow">if</span> ((rc = <a class="code" href="verify_8c.html#c7495acc1413b63c9b197b02fd450464" title="Return exit code from running verify script from header.">rpmVerifyScript</a>(qva, ts, fi, fdo)) != 0)
<a name="l00464"></a>00464                 ec = rc;
<a name="l00465"></a>00465             <span class="keywordflow">if</span> (fdo != NULL)
<a name="l00466"></a>00466                 rc = <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fdo);
<a name="l00467"></a>00467         }
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         fi = <a class="code" href="rpmfi_8c.html#577687ae390b322e982251d7c07deb50" title="Destroy a file info set.">rpmfiFree</a>(fi);
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <span class="keywordflow">return</span> ec;
<a name="l00473"></a>00473 }
<a name="l00474"></a>00474 
<a name="l00475"></a><a class="code" href="group__rpmcli.html#g8260db9435f2688c52de712d13fd7af8">00475</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmcli.html#g8260db9435f2688c52de712d13fd7af8" title="Verify package install.">rpmcliVerify</a>(<a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts, <a class="code" href="structrpmQVKArguments__s.html" title="Describe query/verify/signature command line operation.">QVA_t</a> qva, <span class="keyword">const</span> <span class="keywordtype">char</span> ** <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>)
<a name="l00476"></a>00476 {
<a name="l00477"></a>00477     <span class="keyword">const</span> <span class="keywordtype">char</span> * arg;
<a name="l00478"></a>00478     <a class="code" href="rpmts_8h.html#81f9b6e0b2512e082e5c9cb106261449" title="Bit(s) to control digest and signature verification.">rpmVSFlags</a> <a class="code" href="rpmcache_8c.html#8338952a29222460c2bc12c9545e5241">vsflags</a>, ovsflags;
<a name="l00479"></a>00479     <span class="keywordtype">int</span> ec = 0;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#28de627d3b58aec1f382a26c466e4e64">qva_showPackage</a> == NULL)
<a name="l00482"></a>00482         qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#28de627d3b58aec1f382a26c466e4e64">qva_showPackage</a> = <a class="code" href="group__rpmcli.html#g7c219fd4c5fa0b18cf010d9279478422" title="Display results of package verify.">showVerifyPackage</a>;
<a name="l00483"></a>00483 
<a name="l00484"></a>00484     <span class="comment">/* XXX verify flags are inverted from query. */</span>
<a name="l00485"></a>00485     vsflags = <a class="code" href="macro_8c.html#2e43f3dd86c8e646243de9f051f36f6a" title="Return macro expansion as a numeric value.">rpmExpandNumeric</a>(<span class="stringliteral">"%{?_vsflags_verify}"</span>);
<a name="l00486"></a>00486     <span class="keywordflow">if</span> (!(qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="group__rpmcli.html#gge57534cde3e9032b6b0aa7e27bfe9e71125165395e4d9d505c88cb532d564cdf">VERIFY_DIGEST</a>))
<a name="l00487"></a>00487         vsflags |= <a class="code" href="rpmts_8h.html#6583df29610ae7f15725f31c72206bd2">_RPMVSF_NODIGESTS</a>;
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (!(qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="group__rpmcli.html#gge57534cde3e9032b6b0aa7e27bfe9e71d180f7d9e674d6b3abeca381f18fb082">VERIFY_SIGNATURE</a>))
<a name="l00489"></a>00489         vsflags |= <a class="code" href="rpmts_8h.html#c23e7c09aeec6adb628e5d8c5eeee628">_RPMVSF_NOSIGNATURES</a>;
<a name="l00490"></a>00490     <span class="keywordflow">if</span> (!(qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#cc945d709a159ce1dec392ba52750ab4">qva_flags</a> &amp; <a class="code" href="group__rpmcli.html#gge57534cde3e9032b6b0aa7e27bfe9e71b0ba43f5af74f906251c75b6a3c5247e">VERIFY_HDRCHK</a>))
<a name="l00491"></a>00491         vsflags |= <a class="code" href="rpmts_8h.html#fc1205ee0cb2823a3f14eecc2be47595f04f76ba06bbfb3eac820b09bf7e0349">RPMVSF_NOHDRCHK</a>;
<a name="l00492"></a>00492     vsflags &amp;= ~<a class="code" href="rpmts_8h.html#fc1205ee0cb2823a3f14eecc2be47595584590c94db6efba20aa1af6e8699b70">RPMVSF_NEEDPAYLOAD</a>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     ovsflags = <a class="code" href="group__rpmts.html#gff981dca4017713bfffba1260802a601" title="Set verify signatures flag(s).">rpmtsSetVSFlags</a>(ts, vsflags);
<a name="l00495"></a>00495     ec = <a class="code" href="group__rpmcli.html#g47877ecbb4f5ed61193c3ead45150577" title="Iterate over query/verify arg list.">rpmcliArgIter</a>(ts, qva, argv);
<a name="l00496"></a>00496     vsflags = <a class="code" href="group__rpmts.html#gff981dca4017713bfffba1260802a601" title="Set verify signatures flag(s).">rpmtsSetVSFlags</a>(ts, ovsflags);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498     <span class="keywordflow">if</span> (qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#28de627d3b58aec1f382a26c466e4e64">qva_showPackage</a> == <a class="code" href="group__rpmcli.html#g7c219fd4c5fa0b18cf010d9279478422" title="Display results of package verify.">showVerifyPackage</a>)
<a name="l00499"></a>00499         qva-&gt;<a class="code" href="structrpmQVKArguments__s.html#28de627d3b58aec1f382a26c466e4e64">qva_showPackage</a> = NULL;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <a class="code" href="group__rpmts.html#ga4d67c0606cb761be396eac5d9466666" title="Re-create an empty transaction set.">rpmtsEmpty</a>(ts);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="keywordflow">return</span> ec;
<a name="l00504"></a>00504 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:54 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
