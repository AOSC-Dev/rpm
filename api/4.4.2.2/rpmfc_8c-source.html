<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: build/rpmfc.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>build/rpmfc.c</h1><a href="rpmfc_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00002"></a>00002 
<a name="l00003"></a>00003 <span class="preprocessor">#include &lt;signal.h&gt;</span>     <span class="comment">/* getOutputFrom() */</span>
<a name="l00004"></a>00004 
<a name="l00005"></a>00005 <span class="preprocessor">#include &lt;<a class="code" href="rpmbuild_8h.html" title="This is the *only* module users of librpmbuild should need to include.">rpmbuild.h</a>&gt;</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include &lt;<a class="code" href="argv_8h.html">argv.h</a>&gt;</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;<a class="code" href="rpmfc_8h.html">rpmfc.h</a>&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a><a class="code" href="rpmfc_8c.html#b5f5a956f5923f5aa62fad4e570675f7">00009</a> <span class="preprocessor">#define _RPMDS_INTERNAL</span>
<a name="l00010"></a>00010 <span class="preprocessor"></span><span class="preprocessor">#include &lt;<a class="code" href="rpmds_8h.html" title="Structure(s) used for dependency tag sets.">rpmds.h</a>&gt;</span>
<a name="l00011"></a>00011 <span class="preprocessor">#include &lt;<a class="code" href="rpmfi_8h.html" title="Structure(s) used for file info tag sets.">rpmfi.h</a>&gt;</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#if HAVE_GELF_H</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#include &lt;gelf.h&gt;</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#if !defined(DT_GNU_HASH)</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#define DT_GNU_HASH             0x6ffffef5</span>
<a name="l00018"></a>00018 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span>
<a name="l00020"></a>00020 <span class="preprocessor">#endif</span>
<a name="l00021"></a>00021 <span class="preprocessor"></span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="comment">/*@access rpmds @*/</span>
<a name="l00025"></a>00025 
<a name="l00028"></a><a class="code" href="rpmfc_8c.html#72c41e62e652988634c3de11a2caf52d">00028</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#72c41e62e652988634c3de11a2caf52d">rpmfcExpandAppend</a>(<span class="comment">/*@out@*/</span> <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> * argvp, <span class="keyword">const</span> <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> av)
<a name="l00029"></a>00029         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno @*/</span>
<a name="l00030"></a>00030         <span class="comment">/*@modifies *argvp, rpmGlobalMacroContext @*/</span>
<a name="l00031"></a>00031         <span class="comment">/*@requires maxRead(argvp) &gt;= 0 @*/</span>
<a name="l00032"></a>00032 {
<a name="l00033"></a>00033     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a> = *argvp;
<a name="l00034"></a>00034     <span class="keywordtype">int</span> argc = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(argv);
<a name="l00035"></a>00035     <span class="keywordtype">int</span> ac = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(av);
<a name="l00036"></a>00036     <span class="keywordtype">int</span> i;
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="comment">/*@-bounds@*/</span>   <span class="comment">/* LCL: internal error */</span>
<a name="l00039"></a>00039     argv = <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(argv, (argc + ac + 1) * <span class="keyword">sizeof</span>(*argv));
<a name="l00040"></a>00040 <span class="comment">/*@=bounds@*/</span>
<a name="l00041"></a>00041     <span class="keywordflow">for</span> (i = 0; i &lt; ac; i++)
<a name="l00042"></a>00042         argv[argc + i] = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(av[i], NULL);
<a name="l00043"></a>00043     argv[argc + ac] = NULL;
<a name="l00044"></a>00044     *argvp = argv;
<a name="l00045"></a>00045     <span class="keywordflow">return</span> 0;
<a name="l00046"></a>00046 }
<a name="l00047"></a>00047 
<a name="l00058"></a>00058 <span class="comment">/*@null@*/</span>
<a name="l00059"></a><a class="code" href="group__rpmbuild.html#g297807843458fe41007b6b4a877b08fa">00059</a> <span class="keyword">static</span> <a class="code" href="structStringBufRec.html">StringBuf</a> <a class="code" href="group__rpmbuild.html#g297807843458fe41007b6b4a877b08fa" title="Return output from helper script.">getOutputFrom</a>(<span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * dir, <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>,
<a name="l00060"></a>00060                         <span class="keyword">const</span> <span class="keywordtype">char</span> * writePtr, <span class="keywordtype">int</span> writeBytesLeft,
<a name="l00061"></a>00061                         <span class="keywordtype">int</span> failNonZero)
<a name="l00062"></a>00062         <span class="comment">/*@globals fileSystem, internalState@*/</span>
<a name="l00063"></a>00063         <span class="comment">/*@modifies fileSystem, internalState@*/</span>
<a name="l00064"></a>00064 {
<a name="l00065"></a>00065     pid_t child, reaped;
<a name="l00066"></a>00066     <span class="keywordtype">int</span> toProg[2];
<a name="l00067"></a>00067     <span class="keywordtype">int</span> fromProg[2];
<a name="l00068"></a>00068     <span class="keywordtype">int</span> status;
<a name="l00069"></a>00069     <span class="keywordtype">void</span> *oldhandler;
<a name="l00070"></a>00070     <a class="code" href="structStringBufRec.html">StringBuf</a> readBuff;
<a name="l00071"></a>00071     <span class="keywordtype">int</span> done;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073     <span class="comment">/*@-type@*/</span> <span class="comment">/* FIX: cast? */</span>
<a name="l00074"></a>00074     oldhandler = signal(SIGPIPE, SIG_IGN);
<a name="l00075"></a>00075     <span class="comment">/*@=type@*/</span>
<a name="l00076"></a>00076 
<a name="l00077"></a>00077     toProg[0] = toProg[1] = 0;
<a name="l00078"></a>00078     (void) pipe(toProg);
<a name="l00079"></a>00079     fromProg[0] = fromProg[1] = 0;
<a name="l00080"></a>00080     (void) pipe(fromProg);
<a name="l00081"></a>00081     
<a name="l00082"></a>00082     <span class="keywordflow">if</span> (!(child = fork())) {
<a name="l00083"></a>00083         (void) close(toProg[1]);
<a name="l00084"></a>00084         (void) close(fromProg[0]);
<a name="l00085"></a>00085         
<a name="l00086"></a>00086         (void) dup2(toProg[0], STDIN_FILENO);   <span class="comment">/* Make stdin the in pipe */</span>
<a name="l00087"></a>00087         (void) dup2(fromProg[1], STDOUT_FILENO); <span class="comment">/* Make stdout the out pipe */</span>
<a name="l00088"></a>00088 
<a name="l00089"></a>00089         (void) close(toProg[0]);
<a name="l00090"></a>00090         (void) close(fromProg[1]);
<a name="l00091"></a>00091 
<a name="l00092"></a>00092         <span class="keywordflow">if</span> (dir) {
<a name="l00093"></a>00093             (void) chdir(dir);
<a name="l00094"></a>00094         }
<a name="l00095"></a>00095         
<a name="l00096"></a>00096         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"\texecv(%s) pid %d\n"</span>),
<a name="l00097"></a>00097                         argv[0], (<span class="keywordtype">unsigned</span>)getpid());
<a name="l00098"></a>00098 
<a name="l00099"></a>00099         <a class="code" href="system_8h.html#440dcd7dd71b4d668d8b9112643b9e0a">unsetenv</a>(<span class="stringliteral">"MALLOC_CHECK_"</span>);
<a name="l00100"></a>00100         (void) execvp(argv[0], (<span class="keywordtype">char</span> *<span class="keyword">const</span> *)argv);
<a name="l00101"></a>00101         <span class="comment">/* XXX this error message is probably not seen. */</span>
<a name="l00102"></a>00102         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Couldn't exec %s: %s\n"</span>),
<a name="l00103"></a>00103                 argv[0], <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l00104"></a>00104         _exit(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>);
<a name="l00105"></a>00105     }
<a name="l00106"></a>00106     <span class="keywordflow">if</span> (child &lt; 0) {
<a name="l00107"></a>00107         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba9eb4a538cf595f48d9ca9e3914dc56d1">RPMERR_FORK</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Couldn't fork %s: %s\n"</span>),
<a name="l00108"></a>00108                 argv[0], <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l00109"></a>00109         <span class="keywordflow">return</span> NULL;
<a name="l00110"></a>00110     }
<a name="l00111"></a>00111 
<a name="l00112"></a>00112     (void) close(toProg[0]);
<a name="l00113"></a>00113     (void) close(fromProg[1]);
<a name="l00114"></a>00114 
<a name="l00115"></a>00115     <span class="comment">/* Do not block reading or writing from/to prog. */</span>
<a name="l00116"></a>00116     (void) fcntl(fromProg[0], F_SETFL, O_NONBLOCK);
<a name="l00117"></a>00117     (void) fcntl(toProg[1], F_SETFL, O_NONBLOCK);
<a name="l00118"></a>00118     
<a name="l00119"></a>00119     readBuff = <a class="code" href="stringbuf_8c.html#7597277ee043fedfe21a058b32c08e0d">newStringBuf</a>();
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="keywordflow">do</span> {
<a name="l00122"></a>00122         fd_set <a class="code" href="rpmtool_8c.html#e6e898319493b10f2710a2b8e9b57938">ibits</a>, <a class="code" href="rpmtool_8c.html#97763ec2385ba4938884addd3a552865">obits</a>;
<a name="l00123"></a>00123         <span class="keyword">struct </span>timeval tv;
<a name="l00124"></a>00124         <span class="keywordtype">int</span> nfd, nbw, nbr;
<a name="l00125"></a>00125         <span class="keywordtype">int</span> rc;
<a name="l00126"></a>00126 
<a name="l00127"></a>00127         done = 0;
<a name="l00128"></a>00128 top:
<a name="l00129"></a>00129         FD_ZERO(&amp;ibits);
<a name="l00130"></a>00130         FD_ZERO(&amp;obits);
<a name="l00131"></a>00131         <span class="keywordflow">if</span> (fromProg[0] &gt;= 0) {
<a name="l00132"></a>00132             FD_SET(fromProg[0], &amp;ibits);
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134         <span class="keywordflow">if</span> (toProg[1] &gt;= 0) {
<a name="l00135"></a>00135             FD_SET(toProg[1], &amp;obits);
<a name="l00136"></a>00136         }
<a name="l00137"></a>00137         <span class="comment">/* XXX values set to limit spinning with perl doing ~100 forks/sec. */</span>
<a name="l00138"></a>00138         tv.tv_sec = 0;
<a name="l00139"></a>00139         tv.tv_usec = 10000;
<a name="l00140"></a>00140         nfd = ((fromProg[0] &gt; toProg[1]) ? fromProg[0] : toProg[1]);
<a name="l00141"></a>00141         <span class="keywordflow">if</span> ((rc = select(nfd, &amp;ibits, &amp;obits, NULL, &amp;tv)) &lt; 0) {
<a name="l00142"></a>00142             <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == EINTR)
<a name="l00143"></a>00143                 <span class="keywordflow">goto</span> top;
<a name="l00144"></a>00144             <span class="keywordflow">break</span>;
<a name="l00145"></a>00145         }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147         <span class="comment">/* Write any data to program */</span>
<a name="l00148"></a>00148         <span class="keywordflow">if</span> (toProg[1] &gt;= 0 &amp;&amp; FD_ISSET(toProg[1], &amp;obits)) {
<a name="l00149"></a>00149           <span class="keywordflow">if</span> (writePtr &amp;&amp; writeBytesLeft &gt; 0) {
<a name="l00150"></a>00150             <span class="keywordflow">if</span> ((nbw = write(toProg[1], writePtr,
<a name="l00151"></a>00151                     (1024&lt;writeBytesLeft) ? 1024 : writeBytesLeft)) &lt; 0) {
<a name="l00152"></a>00152                 <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> != EAGAIN) {
<a name="l00153"></a>00153                     perror(<span class="stringliteral">"getOutputFrom()"</span>);
<a name="l00154"></a>00154                     exit(<a class="code" href="system_8h.html#d851a8925c3675478e7dbb01d23a4dfa">EXIT_FAILURE</a>);
<a name="l00155"></a>00155                 }
<a name="l00156"></a>00156                 nbw = 0;
<a name="l00157"></a>00157             }
<a name="l00158"></a>00158             writeBytesLeft -= nbw;
<a name="l00159"></a>00159             writePtr += nbw;
<a name="l00160"></a>00160           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (toProg[1] &gt;= 0) {  <span class="comment">/* close write fd */</span>
<a name="l00161"></a>00161             (void) close(toProg[1]);
<a name="l00162"></a>00162             toProg[1] = -1;
<a name="l00163"></a>00163           }
<a name="l00164"></a>00164         }
<a name="l00165"></a>00165         
<a name="l00166"></a>00166         <span class="comment">/* Read any data from prog */</span>
<a name="l00167"></a>00167 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00168"></a>00168         {   <span class="keywordtype">char</span> buf[BUFSIZ+1];
<a name="l00169"></a>00169             <span class="keywordflow">while</span> ((nbr = read(fromProg[0], buf, <span class="keyword">sizeof</span>(buf)-1)) &gt; 0) {
<a name="l00170"></a>00170                 buf[nbr] = <span class="charliteral">'\0'</span>;
<a name="l00171"></a>00171                 <a class="code" href="stringbuf_8h.html#d0b42a09f04feb6aaf5fe853a1e35f8f">appendStringBuf</a>(readBuff, buf);
<a name="l00172"></a>00172             }
<a name="l00173"></a>00173         }
<a name="l00174"></a>00174 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00175"></a>00175 
<a name="l00176"></a>00176         <span class="comment">/* terminate on (non-blocking) EOF or error */</span>
<a name="l00177"></a>00177         done = (nbr == 0 || (nbr &lt; 0 &amp;&amp; <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> != EAGAIN));
<a name="l00178"></a>00178 
<a name="l00179"></a>00179     } <span class="keywordflow">while</span> (!done);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181     <span class="comment">/* Clean up */</span>
<a name="l00182"></a>00182     <span class="keywordflow">if</span> (toProg[1] &gt;= 0)
<a name="l00183"></a>00183         (void) close(toProg[1]);
<a name="l00184"></a>00184     <span class="keywordflow">if</span> (fromProg[0] &gt;= 0)
<a name="l00185"></a>00185         (void) close(fromProg[0]);
<a name="l00186"></a>00186     <span class="comment">/*@-type@*/</span> <span class="comment">/* FIX: cast? */</span>
<a name="l00187"></a>00187     (void) signal(SIGPIPE, oldhandler);
<a name="l00188"></a>00188     <span class="comment">/*@=type@*/</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="comment">/* Collect status from prog */</span>
<a name="l00191"></a>00191     reaped = waitpid(child, &amp;status, 0);
<a name="l00192"></a>00192     <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"\twaitpid(%d) rc %d status %x\n"</span>),
<a name="l00193"></a>00193         (<span class="keywordtype">unsigned</span>)child, (<span class="keywordtype">unsigned</span>)reaped, status);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     <span class="keywordflow">if</span> (failNonZero &amp;&amp; (!WIFEXITED(status) || WEXITSTATUS(status))) {
<a name="l00196"></a>00196         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s failed\n"</span>), argv[0]);
<a name="l00197"></a>00197         <span class="keywordflow">return</span> NULL;
<a name="l00198"></a>00198     }
<a name="l00199"></a>00199     <span class="keywordflow">if</span> (writeBytesLeft) {
<a name="l00200"></a>00200         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"failed to write all data to %s\n"</span>), argv[0]);
<a name="l00201"></a>00201         <span class="keywordflow">return</span> NULL;
<a name="l00202"></a>00202     }
<a name="l00203"></a>00203     <span class="keywordflow">return</span> readBuff;
<a name="l00204"></a>00204 }
<a name="l00205"></a>00205 
<a name="l00206"></a><a class="code" href="rpmfc_8h.html#a52c84c0e2191ee7f37e8e97171fdd97">00206</a> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#a52c84c0e2191ee7f37e8e97171fdd97" title="Return helper output.">rpmfcExec</a>(<a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> av, <a class="code" href="structStringBufRec.html">StringBuf</a> sb_stdin, <a class="code" href="structStringBufRec.html">StringBuf</a> * sb_stdoutp,
<a name="l00207"></a>00207                 <span class="keywordtype">int</span> failnonzero)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209     <span class="keyword">const</span> <span class="keywordtype">char</span> * s = NULL;
<a name="l00210"></a>00210     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> xav = NULL;
<a name="l00211"></a>00211     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> pav = NULL;
<a name="l00212"></a>00212     <span class="keywordtype">int</span> pac = 0;
<a name="l00213"></a>00213     <span class="keywordtype">int</span> ec = -1;
<a name="l00214"></a>00214     <a class="code" href="structStringBufRec.html">StringBuf</a> sb = NULL;
<a name="l00215"></a>00215     <span class="keyword">const</span> <span class="keywordtype">char</span> * buf_stdin = NULL;
<a name="l00216"></a>00216     <span class="keywordtype">int</span> buf_stdin_len = 0;
<a name="l00217"></a>00217     <span class="keywordtype">int</span> xx;
<a name="l00218"></a>00218 
<a name="l00219"></a>00219     <span class="keywordflow">if</span> (sb_stdoutp)
<a name="l00220"></a>00220         *sb_stdoutp = NULL;
<a name="l00221"></a>00221     <span class="keywordflow">if</span> (!(av &amp;&amp; *av))
<a name="l00222"></a>00222         <span class="keywordflow">goto</span> exit;
<a name="l00223"></a>00223 
<a name="l00224"></a>00224     <span class="comment">/* Find path to executable with (possible) args. */</span>
<a name="l00225"></a>00225     s = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(av[0], NULL);
<a name="l00226"></a>00226     <span class="keywordflow">if</span> (!(s &amp;&amp; *s))
<a name="l00227"></a>00227         <span class="keywordflow">goto</span> exit;
<a name="l00228"></a>00228 
<a name="l00229"></a>00229     <span class="comment">/* Parse args buried within expanded exacutable. */</span>
<a name="l00230"></a>00230     pac = 0;
<a name="l00231"></a>00231     xx = poptParseArgvString(s, &amp;pac, (<span class="keyword">const</span> <span class="keywordtype">char</span> ***)&amp;pav);
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (!(xx == 0 &amp;&amp; pac &gt; 0 &amp;&amp; pav != NULL))
<a name="l00233"></a>00233         <span class="keywordflow">goto</span> exit;
<a name="l00234"></a>00234 
<a name="l00235"></a>00235     <span class="comment">/* Build argv, appending args to the executable args. */</span>
<a name="l00236"></a>00236     xav = NULL;
<a name="l00237"></a>00237 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00238"></a>00238     xx = <a class="code" href="argv_8c.html#9a883a74780dce84ccad233b487c250c" title="Append one argv array to another.">argvAppend</a>(&amp;xav, pav);
<a name="l00239"></a>00239     <span class="keywordflow">if</span> (av[1])
<a name="l00240"></a>00240         xx = <a class="code" href="rpmfc_8c.html#72c41e62e652988634c3de11a2caf52d">rpmfcExpandAppend</a>(&amp;xav, av + 1);
<a name="l00241"></a>00241 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="keywordflow">if</span> (sb_stdin != NULL) {
<a name="l00244"></a>00244         buf_stdin = <a class="code" href="stringbuf_8c.html#fa51085c621ad9b0abc05c629a826440">getStringBuf</a>(sb_stdin);
<a name="l00245"></a>00245         buf_stdin_len = strlen(buf_stdin);
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <span class="comment">/* Read output from exec'd helper. */</span>
<a name="l00249"></a>00249     sb = <a class="code" href="group__rpmbuild.html#g297807843458fe41007b6b4a877b08fa" title="Return output from helper script.">getOutputFrom</a>(NULL, xav, buf_stdin, buf_stdin_len, failnonzero);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="comment">/*@-branchstate@*/</span>
<a name="l00252"></a>00252     <span class="keywordflow">if</span> (sb_stdoutp != NULL) {
<a name="l00253"></a>00253         *sb_stdoutp = sb;
<a name="l00254"></a>00254         sb = NULL;      <span class="comment">/* XXX don't free */</span>
<a name="l00255"></a>00255     }
<a name="l00256"></a>00256 <span class="comment">/*@=branchstate@*/</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258     ec = 0;
<a name="l00259"></a>00259 
<a name="l00260"></a>00260 exit:
<a name="l00261"></a>00261     sb = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb);
<a name="l00262"></a>00262     xav = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(xav);
<a name="l00263"></a>00263     pav = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(pav);   <span class="comment">/* XXX popt mallocs in single blob. */</span>
<a name="l00264"></a>00264     s = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(s);
<a name="l00265"></a>00265     <span class="keywordflow">return</span> ec;
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 
<a name="l00270"></a><a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">00270</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(<span class="comment">/*@out@*/</span> <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> * argvp, <span class="keyword">const</span> <span class="keywordtype">char</span> * key)
<a name="l00271"></a>00271         <span class="comment">/*@modifies *argvp @*/</span>
<a name="l00272"></a>00272         <span class="comment">/*@requires maxSet(argvp) &gt;= 0 @*/</span>
<a name="l00273"></a>00273 {
<a name="l00274"></a>00274     <span class="keywordtype">int</span> rc = 0;
<a name="l00275"></a>00275 
<a name="l00276"></a>00276     <span class="keywordflow">if</span> (<a class="code" href="argv_8c.html#30eda845f3d71e5fd196272b077ead75" title="Find an element in an argv array.">argvSearch</a>(*argvp, key, NULL) == NULL) {
<a name="l00277"></a>00277         rc = <a class="code" href="argv_8c.html#72323478dc4967ef21899e9c48221721" title="Add a string to an argv array.">argvAdd</a>(argvp, key);
<a name="l00278"></a>00278         rc = <a class="code" href="argv_8c.html#92b256d456ce6aa425a0a5abaf81474c" title="Sort an argv array.">argvSort</a>(*argvp, NULL);
<a name="l00279"></a>00279     }
<a name="l00280"></a>00280     <span class="keywordflow">return</span> rc;
<a name="l00281"></a>00281 }
<a name="l00282"></a>00282 
<a name="l00283"></a><a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">00283</a> <span class="keyword">static</span> <span class="keywordtype">char</span> * <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(<span class="comment">/*@returned@*/</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">int</span> ix,
<a name="l00284"></a>00284                 <span class="comment">/*@null@*/</span> <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds)
<a name="l00285"></a>00285         <span class="comment">/*@modifies buf @*/</span>
<a name="l00286"></a>00286         <span class="comment">/*@requires maxSet(buf) &gt;= 0 @*/</span>
<a name="l00287"></a>00287         <span class="comment">/*@ensures maxRead(buf) == 0 @*/</span>
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> tagN = <a class="code" href="rpmds_8c.html#0b19281760024ba3a094527c4772ea3f" title="Return current dependency type.">rpmdsTagN</a>(ds);
<a name="l00290"></a>00290     <span class="keywordtype">char</span> deptype = <span class="charliteral">'X'</span>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l00293"></a>00293     <span class="keywordflow">switch</span> (tagN) {
<a name="l00294"></a>00294     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>:
<a name="l00295"></a>00295         deptype = <span class="charliteral">'P'</span>;
<a name="l00296"></a>00296         <span class="keywordflow">break</span>;
<a name="l00297"></a>00297     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>:
<a name="l00298"></a>00298         deptype = <span class="charliteral">'R'</span>;
<a name="l00299"></a>00299         <span class="keywordflow">break</span>;
<a name="l00300"></a>00300     }
<a name="l00301"></a>00301 <span class="comment">/*@-nullpass@*/</span>
<a name="l00302"></a>00302     <span class="keywordflow">if</span> (ds != NULL)
<a name="l00303"></a>00303         sprintf(buf, <span class="stringliteral">"%08d%c %s %s 0x%08x"</span>, ix, deptype,
<a name="l00304"></a>00304                 <a class="code" href="rpmds_8c.html#5dbfffb989198fcbaca885d946f0aa51" title="Return current dependency name.">rpmdsN</a>(ds), <a class="code" href="rpmds_8c.html#1c898f2226abecb32b16e5b08bb776bb" title="Return current dependency epoch-version-release.">rpmdsEVR</a>(ds), <a class="code" href="rpmds_8c.html#012c824694e1c625b6880a4f8da88ce6" title="Return current dependency flags.">rpmdsFlags</a>(ds));
<a name="l00305"></a>00305 <span class="comment">/*@=nullpass@*/</span>
<a name="l00306"></a>00306     <span class="keywordflow">return</span> buf;
<a name="l00307"></a>00307 };
<a name="l00308"></a>00308 
<a name="l00316"></a><a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21">00316</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> deptype, <span class="keyword">const</span> <span class="keywordtype">char</span> * nsdep)
<a name="l00317"></a>00317         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00318"></a>00318         <span class="comment">/*@modifies fc, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00319"></a>00319 {
<a name="l00320"></a>00320     <span class="keyword">const</span> <span class="keywordtype">char</span> * fn = fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>];
<a name="l00321"></a>00321     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00322"></a>00322     <a class="code" href="structStringBufRec.html">StringBuf</a> sb_stdout = NULL;
<a name="l00323"></a>00323     <a class="code" href="structStringBufRec.html">StringBuf</a> sb_stdin;
<a name="l00324"></a>00324     <span class="keyword">const</span> <span class="keywordtype">char</span> *av[2];
<a name="l00325"></a>00325     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> * depsp, ds;
<a name="l00326"></a>00326     <span class="keyword">const</span> <span class="keywordtype">char</span> * N;
<a name="l00327"></a>00327     <span class="keyword">const</span> <span class="keywordtype">char</span> * EVR;
<a name="l00328"></a>00328     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> Flags, dsContext, tagN;
<a name="l00329"></a>00329     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> pav;
<a name="l00330"></a>00330     <span class="keyword">const</span> <span class="keywordtype">char</span> * s;
<a name="l00331"></a>00331     <span class="keywordtype">int</span> pac;
<a name="l00332"></a>00332     <span class="keywordtype">int</span> xx;
<a name="l00333"></a>00333     <span class="keywordtype">int</span> i;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="keywordflow">switch</span> (deptype) {
<a name="l00336"></a>00336     <span class="keywordflow">default</span>:
<a name="l00337"></a>00337         <span class="keywordflow">return</span> -1;
<a name="l00338"></a>00338         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l00339"></a>00339     <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
<a name="l00340"></a>00340         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a>)
<a name="l00341"></a>00341             <span class="keywordflow">return</span> 0;
<a name="l00342"></a>00342         xx = <a class="code" href="rpmps_8c.html#a5feb80af7b48ec2df594a19a2c499a9">snprintf</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%%{?__%s_provides}"</span>, nsdep);
<a name="l00343"></a>00343         depsp = &amp;fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>;
<a name="l00344"></a>00344         dsContext = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095dbd5b2fcf70d1ef8863e13c9b8fe9da2">RPMSENSE_FIND_PROVIDES</a>;
<a name="l00345"></a>00345         tagN = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>;
<a name="l00346"></a>00346         <span class="keywordflow">break</span>;
<a name="l00347"></a>00347     <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
<a name="l00348"></a>00348         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a>)
<a name="l00349"></a>00349             <span class="keywordflow">return</span> 0;
<a name="l00350"></a>00350         xx = <a class="code" href="rpmps_8c.html#a5feb80af7b48ec2df594a19a2c499a9">snprintf</a>(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">"%%{?__%s_requires}"</span>, nsdep);
<a name="l00351"></a>00351         depsp = &amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>;
<a name="l00352"></a>00352         dsContext = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>;
<a name="l00353"></a>00353         tagN = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>;
<a name="l00354"></a>00354         <span class="keywordflow">break</span>;
<a name="l00355"></a>00355     }
<a name="l00356"></a>00356     buf[<span class="keyword">sizeof</span>(buf)-1] = <span class="charliteral">'\0'</span>;
<a name="l00357"></a>00357     av[0] = buf;
<a name="l00358"></a>00358     av[1] = NULL;
<a name="l00359"></a>00359 
<a name="l00360"></a>00360     sb_stdin = <a class="code" href="stringbuf_8c.html#7597277ee043fedfe21a058b32c08e0d">newStringBuf</a>();
<a name="l00361"></a>00361     <a class="code" href="stringbuf_8h.html#ece7923b4b1b19fdc5b99ec7a8856360">appendLineStringBuf</a>(sb_stdin, fn);
<a name="l00362"></a>00362     sb_stdout = NULL;
<a name="l00363"></a>00363 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00364"></a>00364     xx = <a class="code" href="rpmfc_8c.html#a52c84c0e2191ee7f37e8e97171fdd97" title="Return helper output.">rpmfcExec</a>(av, sb_stdin, &amp;sb_stdout, 0);
<a name="l00365"></a>00365 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00366"></a>00366     sb_stdin = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb_stdin);
<a name="l00367"></a>00367 
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (xx == 0 &amp;&amp; sb_stdout != NULL) {
<a name="l00369"></a>00369         pav = NULL;
<a name="l00370"></a>00370         xx = <a class="code" href="argv_8c.html#27aa73bb1b273779de7dd3dac638e872" title="Split a string into an argv array.">argvSplit</a>(&amp;pav, <a class="code" href="stringbuf_8c.html#fa51085c621ad9b0abc05c629a826440">getStringBuf</a>(sb_stdout), <span class="stringliteral">" \t\n\r"</span>);
<a name="l00371"></a>00371         pac = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(pav);
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (pav)
<a name="l00373"></a>00373         <span class="keywordflow">for</span> (i = 0; i &lt; pac; i++) {
<a name="l00374"></a>00374             N = pav[i];
<a name="l00375"></a>00375             EVR = <span class="stringliteral">""</span>;
<a name="l00376"></a>00376             Flags = dsContext;
<a name="l00377"></a>00377 <span class="comment">/*@-branchstate@*/</span>
<a name="l00378"></a>00378             <span class="keywordflow">if</span> (pav[i+1] &amp;&amp; strchr(<span class="stringliteral">"=&lt;&gt;"</span>, *pav[i+1])) {
<a name="l00379"></a>00379                 i++;
<a name="l00380"></a>00380                 <span class="keywordflow">for</span> (s = pav[i]; *s; s++) {
<a name="l00381"></a>00381                     <span class="keywordflow">switch</span>(*s) {
<a name="l00382"></a>00382                     <span class="keywordflow">default</span>:
<a name="l00383"></a>00383 assert(*s != <span class="charliteral">'\0'</span>);
<a name="l00384"></a>00384                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00385"></a>00385                     <span class="keywordflow">case</span> <span class="charliteral">'='</span>:
<a name="l00386"></a>00386                         Flags |= <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a>;
<a name="l00387"></a>00387                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00388"></a>00388                     <span class="keywordflow">case</span> <span class="charliteral">'&lt;'</span>:
<a name="l00389"></a>00389                         Flags |= <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095e22dbb27e00aad5fb0295e17620b2690">RPMSENSE_LESS</a>;
<a name="l00390"></a>00390                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00391"></a>00391                     <span class="keywordflow">case</span> <span class="charliteral">'&gt;'</span>:
<a name="l00392"></a>00392                         Flags |= <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b2709591c6dd1a4b6f3abf7cc0c3689445c4c0">RPMSENSE_GREATER</a>;
<a name="l00393"></a>00393                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00394"></a>00394                     }
<a name="l00395"></a>00395                 }
<a name="l00396"></a>00396                 i++;
<a name="l00397"></a>00397                 EVR = pav[i];
<a name="l00398"></a>00398 assert(EVR != NULL);
<a name="l00399"></a>00399             }
<a name="l00400"></a>00400 <span class="comment">/*@=branchstate@*/</span>
<a name="l00401"></a>00401 
<a name="l00402"></a>00402 
<a name="l00403"></a>00403             <span class="comment">/* Add tracking dependency for versioned Provides: */</span>
<a name="l00404"></a>00404             <span class="keywordflow">if</span> (!fc-&gt;<a class="code" href="structrpmfc__s.html#1ca96220f7dc2095036bca6fc7a7cbbf">tracked</a> &amp;&amp; deptype == <span class="charliteral">'P'</span> &amp;&amp; *EVR != <span class="charliteral">'\0'</span>) {
<a name="l00405"></a>00405                 ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>,
<a name="l00406"></a>00406                         <span class="stringliteral">"rpmlib(VersionedDependencies)"</span>, <span class="stringliteral">"3.0.3-1"</span>,
<a name="l00407"></a>00407                         <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095885ce24fb4e9a92be55275f533362f76">RPMSENSE_RPMLIB</a>|(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095e22dbb27e00aad5fb0295e17620b2690">RPMSENSE_LESS</a>|<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a>));
<a name="l00408"></a>00408                 xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l00409"></a>00409                 ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l00410"></a>00410                 fc-&gt;<a class="code" href="structrpmfc__s.html#1ca96220f7dc2095036bca6fc7a7cbbf">tracked</a> = 1;
<a name="l00411"></a>00411             }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(tagN, N, EVR, Flags);
<a name="l00414"></a>00414 
<a name="l00415"></a>00415             <span class="comment">/* Add to package dependencies. */</span>
<a name="l00416"></a>00416             xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(depsp, ds);
<a name="l00417"></a>00417 
<a name="l00418"></a>00418             <span class="comment">/* Add to file dependencies. */</span>
<a name="l00419"></a>00419 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00420"></a>00420             xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>, <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(buf, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, ds));
<a name="l00421"></a>00421 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00422"></a>00422 
<a name="l00423"></a>00423             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l00424"></a>00424         }
<a name="l00425"></a>00425 
<a name="l00426"></a>00426         pav = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(pav);
<a name="l00427"></a>00427     }
<a name="l00428"></a>00428     sb_stdout = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb_stdout);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430     <span class="keywordflow">return</span> 0;
<a name="l00431"></a>00431 }
<a name="l00432"></a>00432 
<a name="l00435"></a>00435 <span class="comment">/*@unchecked@*/</span> <span class="comment">/*@observer@*/</span>
<a name="l00436"></a><a class="code" href="rpmfc_8c.html#33323cd7406ebcfecb0bd7a7b0d9566f">00436</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structrpmfcTokens__s.html">rpmfcTokens_s</a> <a class="code" href="rpmfc_8c.html#33323cd7406ebcfecb0bd7a7b0d9566f">rpmfcTokens</a>[] = {
<a name="l00437"></a>00437   { <span class="stringliteral">"directory"</span>,                <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c472e2d0cb8f566280e4eac243a9a9ea6b4">RPMFC_DIRECTORY</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00438"></a>00438 
<a name="l00439"></a>00439   { <span class="stringliteral">" shared object"</span>,           <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785930f8c914030a02bd973e51372fbf4">RPMFC_LIBRARY</a> },
<a name="l00440"></a>00440   { <span class="stringliteral">" executable"</span>,              <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47627f7ca52062de859a49eb34550d63fa">RPMFC_EXECUTABLE</a> },
<a name="l00441"></a>00441   { <span class="stringliteral">" statically linked"</span>,       <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47872d9e952ea82f36dcdc5302fa5df5bd">RPMFC_STATIC</a> },
<a name="l00442"></a>00442   { <span class="stringliteral">" not stripped"</span>,            <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47b2f3e71601000cddb01c4a068107c6be">RPMFC_NOTSTRIPPED</a> },
<a name="l00443"></a>00443   { <span class="stringliteral">" archive"</span>,                 <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a> },
<a name="l00444"></a>00444 
<a name="l00445"></a>00445   { <span class="stringliteral">"ELF 32-bit"</span>,               <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47c38058c40cfb03bf4b16f46791af3de0">RPMFC_ELF32</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00446"></a>00446   { <span class="stringliteral">"ELF 64-bit"</span>,               <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47dbf78c435f27bf56c3bbb8020c7f30e4">RPMFC_ELF64</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00447"></a>00447 
<a name="l00448"></a>00448   { <span class="stringliteral">" script"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47cea134e03e17e45c0a0307a656f1207f">RPMFC_SCRIPT</a> },
<a name="l00449"></a>00449   { <span class="stringliteral">" text"</span>,                    <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c477e51fb36b2e48be2f9ee868ba982588f">RPMFC_TEXT</a> },
<a name="l00450"></a>00450   { <span class="stringliteral">" document"</span>,                <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47f224f798651de1757b8d62231c535c20">RPMFC_DOCUMENT</a> },
<a name="l00451"></a>00451 
<a name="l00452"></a>00452   { <span class="stringliteral">" compressed"</span>,              <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4724f2ad1d564a1a92567e107f43208bfe">RPMFC_COMPRESSED</a> },
<a name="l00453"></a>00453 
<a name="l00454"></a>00454   { <span class="stringliteral">"troff or preprocessor input"</span>,      <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47b6f3dda82feab2027c70b8b7daf43811">RPMFC_MANPAGE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00455"></a>00455   { <span class="stringliteral">"GNU Info"</span>,                 <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47b6f3dda82feab2027c70b8b7daf43811">RPMFC_MANPAGE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00456"></a>00456 
<a name="l00457"></a>00457   { <span class="stringliteral">"perl script text"</span>,         <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e6ce254bc313528f92d2c838f1bcc4f0">RPMFC_PERL</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00458"></a>00458   { <span class="stringliteral">"Perl5 module source text"</span>, <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e6ce254bc313528f92d2c838f1bcc4f0">RPMFC_PERL</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47a685010dd10b4f288f3196910d0536b4">RPMFC_MODULE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00459"></a>00459 
<a name="l00460"></a>00460   { <span class="stringliteral">" /usr/bin/python"</span>,         <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e7db0456ed2d6eea97458cdb9af704da">RPMFC_PYTHON</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   <span class="comment">/* XXX "a /usr/bin/python -t script text executable" */</span>
<a name="l00463"></a>00463   <span class="comment">/* XXX "python 2.3 byte-compiled" */</span>
<a name="l00464"></a>00464   { <span class="stringliteral">"python "</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e7db0456ed2d6eea97458cdb9af704da">RPMFC_PYTHON</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00465"></a>00465 
<a name="l00466"></a>00466   <span class="comment">/* XXX .NET executables and libraries.  file(1) cannot differ from win32 </span>
<a name="l00467"></a>00467 <span class="comment">   * executables unfortunately :( */</span>
<a name="l00468"></a>00468   { <span class="stringliteral">"PE executable"</span>,            <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4755d4385669144850ca114703efb0dffc">RPMFC_MONO</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00469"></a>00469 
<a name="l00470"></a>00470   { <span class="stringliteral">"current ar archive"</span>,       <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47872d9e952ea82f36dcdc5302fa5df5bd">RPMFC_STATIC</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785930f8c914030a02bd973e51372fbf4">RPMFC_LIBRARY</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00471"></a>00471 
<a name="l00472"></a>00472   { <span class="stringliteral">"Zip archive data"</span>,         <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4724f2ad1d564a1a92567e107f43208bfe">RPMFC_COMPRESSED</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00473"></a>00473   { <span class="stringliteral">"tar archive"</span>,              <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00474"></a>00474   { <span class="stringliteral">"cpio archive"</span>,             <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00475"></a>00475   { <span class="stringliteral">"RPM v3"</span>,                   <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00476"></a>00476   { <span class="stringliteral">"RPM v4"</span>,                   <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4738c1c136dc7d819a4d35f1476b32ae5f">RPMFC_ARCHIVE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00477"></a>00477 
<a name="l00478"></a>00478   { <span class="stringliteral">" image"</span>,                   <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c471b8252fa81ee9423daa0976c9670fb5e">RPMFC_IMAGE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00479"></a>00479   { <span class="stringliteral">" font"</span>,                    <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ecadd8f857228b74009158207d4434a0">RPMFC_FONT</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00480"></a>00480   { <span class="stringliteral">" Font"</span>,                    <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ecadd8f857228b74009158207d4434a0">RPMFC_FONT</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00481"></a>00481 
<a name="l00482"></a>00482   { <span class="stringliteral">" commands"</span>,                <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47cea134e03e17e45c0a0307a656f1207f">RPMFC_SCRIPT</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00483"></a>00483   { <span class="stringliteral">" script"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47cea134e03e17e45c0a0307a656f1207f">RPMFC_SCRIPT</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00484"></a>00484 
<a name="l00485"></a>00485   { <span class="stringliteral">"empty"</span>,                    <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00486"></a>00486 
<a name="l00487"></a>00487   { <span class="stringliteral">"HTML"</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00488"></a>00488   { <span class="stringliteral">"SGML"</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00489"></a>00489   { <span class="stringliteral">"XML"</span>,                      <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00490"></a>00490 
<a name="l00491"></a>00491   { <span class="stringliteral">" program text"</span>,            <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00492"></a>00492   { <span class="stringliteral">" source"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00493"></a>00493   { <span class="stringliteral">"GLS_BINARY_LSB_FIRST"</span>,     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00494"></a>00494   { <span class="stringliteral">" DB "</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00495"></a>00495 
<a name="l00496"></a>00496   { <span class="stringliteral">"ASCII English text"</span>,       <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00497"></a>00497   { <span class="stringliteral">"ASCII text"</span>,               <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00498"></a>00498   { <span class="stringliteral">"ISO-8859 text"</span>,            <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00499"></a>00499 
<a name="l00500"></a>00500   { <span class="stringliteral">"symbolic link to"</span>,         <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ad94991b8ac141927fba4c3e21be05bf">RPMFC_SYMLINK</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a> },
<a name="l00501"></a>00501   { <span class="stringliteral">"socket"</span>,                   <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4763b7eaa7ba4554c8b65ea6d567e4bf4e">RPMFC_DEVICE</a> },
<a name="l00502"></a>00502   { <span class="stringliteral">"special"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4763b7eaa7ba4554c8b65ea6d567e4bf4e">RPMFC_DEVICE</a> },
<a name="l00503"></a>00503 
<a name="l00504"></a>00504   { <span class="stringliteral">"ASCII"</span>,                    <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00505"></a>00505   { <span class="stringliteral">"ISO-8859"</span>,                 <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00506"></a>00506 
<a name="l00507"></a>00507   { <span class="stringliteral">"data"</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00508"></a>00508 
<a name="l00509"></a>00509   { <span class="stringliteral">"application"</span>,              <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00510"></a>00510   { <span class="stringliteral">"boot"</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00511"></a>00511   { <span class="stringliteral">"catalog"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00512"></a>00512   { <span class="stringliteral">"code"</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00513"></a>00513   { <span class="stringliteral">"file"</span>,                     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00514"></a>00514   { <span class="stringliteral">"format"</span>,                   <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00515"></a>00515   { <span class="stringliteral">"message"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00516"></a>00516   { <span class="stringliteral">"program"</span>,                  <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> },
<a name="l00517"></a>00517 
<a name="l00518"></a>00518   { <span class="stringliteral">"broken symbolic link to "</span>, <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ffbee8c3aa2068363550fcdfa1e673dc">RPMFC_ERROR</a> },
<a name="l00519"></a>00519   { <span class="stringliteral">"can't read"</span>,               <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ffbee8c3aa2068363550fcdfa1e673dc">RPMFC_ERROR</a> },
<a name="l00520"></a>00520   { <span class="stringliteral">"can't stat"</span>,               <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ffbee8c3aa2068363550fcdfa1e673dc">RPMFC_ERROR</a> },
<a name="l00521"></a>00521   { <span class="stringliteral">"executable, can't read"</span>,   <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ffbee8c3aa2068363550fcdfa1e673dc">RPMFC_ERROR</a> },
<a name="l00522"></a>00522   { <span class="stringliteral">"core file"</span>,                <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ffbee8c3aa2068363550fcdfa1e673dc">RPMFC_ERROR</a> },
<a name="l00523"></a>00523 
<a name="l00524"></a>00524   { NULL,                       <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47a4f92a894090f6c6e7f30272e91d174a">RPMFC_BLACK</a> }
<a name="l00525"></a>00525 };
<a name="l00526"></a>00526 
<a name="l00527"></a><a class="code" href="rpmfc_8h.html#27dbddd78d9613ce88f08cb75b0b8957">00527</a> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#27dbddd78d9613ce88f08cb75b0b8957" title="Return file color given file(1) string.">rpmfcColoring</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * fmstr)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <a class="code" href="structrpmfcTokens__s.html">rpmfcToken</a> fct;
<a name="l00530"></a>00530     <span class="keywordtype">int</span> fcolor = <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47a4f92a894090f6c6e7f30272e91d174a">RPMFC_BLACK</a>;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="keywordflow">for</span> (fct = <a class="code" href="rpmfc_8c.html#33323cd7406ebcfecb0bd7a7b0d9566f">rpmfcTokens</a>; fct-&gt;<a class="code" href="structrpmfcTokens__s.html#ee25a3346e6afa5bece6f7a43a16709c">token</a> != NULL; fct++) {
<a name="l00533"></a>00533         <span class="keywordflow">if</span> (strstr(fmstr, fct-&gt;<a class="code" href="structrpmfcTokens__s.html#ee25a3346e6afa5bece6f7a43a16709c">token</a>) == NULL)
<a name="l00534"></a>00534             <span class="keywordflow">continue</span>;
<a name="l00535"></a>00535         fcolor |= fct-&gt;<a class="code" href="structrpmfcTokens__s.html#89234a76cd32334af0ee5cfbe89136fe">colors</a>;
<a name="l00536"></a>00536         if (fcolor &amp; <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a>)
<a name="l00537"></a>00537             <span class="keywordflow">return</span> fcolor;
<a name="l00538"></a>00538     }
<a name="l00539"></a>00539     <span class="keywordflow">return</span> fcolor;
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="rpmfc_8h.html#1590ab56e344f35ffc8804e6cc2fd267">00542</a> <span class="keywordtype">void</span> <a class="code" href="rpmfc_8c.html#1590ab56e344f35ffc8804e6cc2fd267" title="Print results of file classification.">rpmfcPrint</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * msg, <a class="code" href="structrpmfc__s.html">rpmfc</a> fc, FILE * fp)
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544     <span class="keywordtype">int</span> fcolor;
<a name="l00545"></a>00545     <span class="keywordtype">int</span> ndx;
<a name="l00546"></a>00546     <span class="keywordtype">int</span> cx;
<a name="l00547"></a>00547     <span class="keywordtype">int</span> dx;
<a name="l00548"></a>00548     <span class="keywordtype">int</span> fx;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <span class="keywordtype">int</span> nprovides;
<a name="l00551"></a>00551 <span class="keywordtype">int</span> nrequires;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     <span class="keywordflow">if</span> (fp == NULL) fp = stderr;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555     <span class="keywordflow">if</span> (msg)
<a name="l00556"></a>00556         fprintf(fp, <span class="stringliteral">"===================================== %s\n"</span>, msg);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558 nprovides = <a class="code" href="rpmds_8c.html#bb7ace7e37397f7643d201b055997a87" title="Return dependency set count.">rpmdsCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>);
<a name="l00559"></a>00559 nrequires = <a class="code" href="rpmds_8c.html#bb7ace7e37397f7643d201b055997a87" title="Return dependency set count.">rpmdsCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <span class="keywordflow">if</span> (fc)
<a name="l00562"></a>00562     <span class="keywordflow">for</span> (fx = 0; fx &lt; fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>; fx++) {
<a name="l00563"></a>00563 assert(fx &lt; fc-&gt;fcdictx-&gt;nvals);
<a name="l00564"></a>00564         cx = fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fx];
<a name="l00565"></a>00565 assert(fx &lt; fc-&gt;fcolor-&gt;nvals);
<a name="l00566"></a>00566         fcolor = fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fx];
<a name="l00567"></a>00567 
<a name="l00568"></a>00568         fprintf(fp, <span class="stringliteral">"%3d %s"</span>, fx, fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fx]);
<a name="l00569"></a>00569         if (fcolor != <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47a4f92a894090f6c6e7f30272e91d174a">RPMFC_BLACK</a>)
<a name="l00570"></a>00570                 fprintf(fp, <span class="stringliteral">"\t0x%x"</span>, fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fx]);
<a name="l00571"></a>00571         <span class="keywordflow">else</span>
<a name="l00572"></a>00572                 fprintf(fp, <span class="stringliteral">"\t%s"</span>, fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>[cx]);
<a name="l00573"></a>00573         fprintf(fp, <span class="stringliteral">"\n"</span>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a> == NULL || fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a> == NULL)
<a name="l00576"></a>00576             <span class="keywordflow">continue</span>;
<a name="l00577"></a>00577 
<a name="l00578"></a>00578 assert(fx &lt; fc-&gt;fddictx-&gt;nvals);
<a name="l00579"></a>00579         dx = fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fx];
<a name="l00580"></a>00580 assert(fx &lt; fc-&gt;fddictn-&gt;nvals);
<a name="l00581"></a>00581         ndx = fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fx];
<a name="l00582"></a>00582 
<a name="l00583"></a>00583         while (ndx-- &gt; 0) {
<a name="l00584"></a>00584             <span class="keyword">const</span> <span class="keywordtype">char</span> * depval;
<a name="l00585"></a>00585             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> deptype;
<a name="l00586"></a>00586             <span class="keywordtype">unsigned</span> ix;
<a name="l00587"></a>00587 
<a name="l00588"></a>00588             ix = fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[dx++];
<a name="l00589"></a>00589             deptype = ((ix &gt;&gt; 24) &amp; 0xff);
<a name="l00590"></a>00590             ix &amp;= 0x00ffffff;
<a name="l00591"></a>00591             depval = NULL;
<a name="l00592"></a>00592             <span class="keywordflow">switch</span> (deptype) {
<a name="l00593"></a>00593             <span class="keywordflow">default</span>:
<a name="l00594"></a>00594 assert(depval != NULL);
<a name="l00595"></a>00595                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00596"></a>00596             <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:
<a name="l00597"></a>00597                 <span class="keywordflow">if</span> (nprovides &gt; 0) {
<a name="l00598"></a>00598 assert(ix &lt; nprovides);
<a name="l00599"></a>00599                     (void) <a class="code" href="rpmds_8c.html#24c9ae1ba6014bfbf6d4db0cc6769bc4" title="Set dependency set index.">rpmdsSetIx</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>, ix-1);
<a name="l00600"></a>00600                     <span class="keywordflow">if</span> (<a class="code" href="rpmds_8c.html#e2b07afdbac562e3f1445fc0dd9bd77c" title="Return next dependency set iterator index.">rpmdsNext</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>) &gt;= 0)
<a name="l00601"></a>00601                         depval = <a class="code" href="rpmds_8c.html#469513a3255575fe259677606a7feffb" title="Return current formatted dependency string.">rpmdsDNEVR</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>);
<a name="l00602"></a>00602                 }
<a name="l00603"></a>00603                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00604"></a>00604             <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
<a name="l00605"></a>00605                 <span class="keywordflow">if</span> (nrequires &gt; 0) {
<a name="l00606"></a>00606 assert(ix &lt; nrequires);
<a name="l00607"></a>00607                     (void) <a class="code" href="rpmds_8c.html#24c9ae1ba6014bfbf6d4db0cc6769bc4" title="Set dependency set index.">rpmdsSetIx</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ix-1);
<a name="l00608"></a>00608                     <span class="keywordflow">if</span> (<a class="code" href="rpmds_8c.html#e2b07afdbac562e3f1445fc0dd9bd77c" title="Return next dependency set iterator index.">rpmdsNext</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>) &gt;= 0)
<a name="l00609"></a>00609                         depval = <a class="code" href="rpmds_8c.html#469513a3255575fe259677606a7feffb" title="Return current formatted dependency string.">rpmdsDNEVR</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>);
<a name="l00610"></a>00610                 }
<a name="l00611"></a>00611                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00612"></a>00612             }
<a name="l00613"></a>00613             <span class="keywordflow">if</span> (depval)
<a name="l00614"></a>00614                 fprintf(fp, <span class="stringliteral">"\t%s\n"</span>, depval);
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616     }
<a name="l00617"></a>00617 }
<a name="l00618"></a>00618 
<a name="l00619"></a><a class="code" href="rpmfc_8h.html#7e5626c2f41e6cdf4ab167e90586f260">00619</a> <a class="code" href="structrpmfc__s.html">rpmfc</a> <a class="code" href="rpmfc_8c.html#7e5626c2f41e6cdf4ab167e90586f260" title="Destroy a file classifier.">rpmfcFree</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc)
<a name="l00620"></a>00620 {
<a name="l00621"></a>00621     <span class="keywordflow">if</span> (fc) {
<a name="l00622"></a>00622         fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a> = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>);
<a name="l00623"></a>00623         fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a> = <a class="code" href="argv_8c.html#7e6a4def1740182c77f45617ec8ad893" title="Destroy an argi array.">argiFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>);
<a name="l00624"></a>00624         fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a> = <a class="code" href="argv_8c.html#7e6a4def1740182c77f45617ec8ad893" title="Destroy an argi array.">argiFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a>);
<a name="l00625"></a>00625         fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a> = <a class="code" href="argv_8c.html#7e6a4def1740182c77f45617ec8ad893" title="Destroy an argi array.">argiFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a>);
<a name="l00626"></a>00626         fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a> = <a class="code" href="argv_8c.html#7e6a4def1740182c77f45617ec8ad893" title="Destroy an argi array.">argiFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>);
<a name="l00627"></a>00627         fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a> = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>);
<a name="l00628"></a>00628         fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a> = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>);
<a name="l00629"></a>00629         fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a> = <a class="code" href="argv_8c.html#7e6a4def1740182c77f45617ec8ad893" title="Destroy an argi array.">argiFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a> = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>);
<a name="l00632"></a>00632         fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a> = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634         fc-&gt;<a class="code" href="structrpmfc__s.html#28de35029e8ba57e603ca2ab092da2aa">sb_java</a> = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#28de35029e8ba57e603ca2ab092da2aa">sb_java</a>);
<a name="l00635"></a>00635         fc-&gt;<a class="code" href="structrpmfc__s.html#678f3c06744967e133a8c3a2e97ca01e">sb_perl</a> = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#678f3c06744967e133a8c3a2e97ca01e">sb_perl</a>);
<a name="l00636"></a>00636         fc-&gt;<a class="code" href="structrpmfc__s.html#6623cf4186aefeeb4a37fbd83020746a">sb_python</a> = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#6623cf4186aefeeb4a37fbd83020746a">sb_python</a>);
<a name="l00637"></a>00637 
<a name="l00638"></a>00638     }
<a name="l00639"></a>00639     fc = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fc);
<a name="l00640"></a>00640     <span class="keywordflow">return</span> NULL;
<a name="l00641"></a>00641 }
<a name="l00642"></a>00642 
<a name="l00643"></a><a class="code" href="rpmfc_8h.html#7e13b4f31e457a3b79cb94049d410d7c">00643</a> <a class="code" href="structrpmfc__s.html">rpmfc</a> <a class="code" href="rpmfc_8c.html#7e13b4f31e457a3b79cb94049d410d7c" title="Create a file classifier.">rpmfcNew</a>(<span class="keywordtype">void</span>)
<a name="l00644"></a>00644 {
<a name="l00645"></a>00645     <a class="code" href="structrpmfc__s.html">rpmfc</a> fc = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*fc));
<a name="l00646"></a>00646     <span class="keywordflow">return</span> fc;
<a name="l00647"></a>00647 }
<a name="l00648"></a>00648 
<a name="l00654"></a><a class="code" href="rpmfc_8c.html#06d4fc60ec5c7ca77a308a5038026ae9">00654</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#06d4fc60ec5c7ca77a308a5038026ae9" title="Ensure that symlinks for shared libs generate a dep on the shared lib.">rpmfcSYMLINK</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc)
<a name="l00655"></a>00655 {
<a name="l00656"></a>00656     <span class="keyword">const</span> <span class="keywordtype">char</span> * fn = fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>];
<a name="l00657"></a>00657     <span class="keyword">struct </span>stat sb;
<a name="l00658"></a>00658     <span class="keywordtype">int</span> fdno;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660     <span class="keywordflow">if</span> (stat(fn, &amp;sb) &lt; 0)
<a name="l00661"></a>00661         <span class="keywordflow">return</span> -1;
<a name="l00662"></a>00662     <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(sb.st_mode))
<a name="l00663"></a>00663         <span class="keywordflow">return</span> -1;
<a name="l00664"></a>00664     
<a name="l00665"></a>00665     fdno = open(fn, O_RDONLY);
<a name="l00666"></a>00666     <span class="keywordflow">if</span> (fdno &lt; 0) {
<a name="l00667"></a>00667         <span class="keywordflow">return</span> fdno;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670 <span class="preprocessor">#if HAVE_GELF_H &amp;&amp; HAVE_LIBELF</span>
<a name="l00671"></a>00671 <span class="preprocessor"></span>    Elf * elf = NULL;
<a name="l00672"></a>00672     GElf_Ehdr ehdr_mem, * ehdr;
<a name="l00673"></a>00673     <span class="keywordtype">int</span> isElf64;
<a name="l00674"></a>00674     <span class="keywordtype">int</span> i, cnt;
<a name="l00675"></a>00675     <span class="keywordtype">char</span> * soname = NULL;
<a name="l00676"></a>00676     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00677"></a>00677     <span class="keywordtype">char</span> * t;
<a name="l00678"></a>00678     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     (void) elf_version(EV_CURRENT);
<a name="l00681"></a>00681     elf = NULL;
<a name="l00682"></a>00682     <span class="keywordflow">if</span> ((elf = elf_begin (fdno, ELF_C_READ_MMAP, NULL)) == NULL
<a name="l00683"></a>00683         || elf_kind(elf) != ELF_K_ELF
<a name="l00684"></a>00684         || (ehdr = gelf_getehdr(elf, &amp;ehdr_mem)) == NULL
<a name="l00685"></a>00685         || ehdr-&gt;e_type != ET_DYN)
<a name="l00686"></a>00686         <span class="keywordflow">goto</span> exit;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688     isElf64 = ehdr-&gt;e_ident[<a class="code" href="readelf_8h.html#95e3653fa558cb3c913f9706ffea2e03">EI_CLASS</a>] == <a class="code" href="readelf_8h.html#d1985372d271e0cb6dfa038273177cf9">ELFCLASS64</a>;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="keywordflow">for</span> (i = 0; i &lt; ehdr-&gt;e_phnum; ++i) {
<a name="l00691"></a>00691       GElf_Phdr phdr_mem;
<a name="l00692"></a>00692       GElf_Phdr *phdr = gelf_getphdr (elf, i, &amp;phdr_mem);
<a name="l00693"></a>00693       GElf_Shdr shdr_mem;
<a name="l00694"></a>00694       Elf_Data * data = NULL;
<a name="l00695"></a>00695       Elf_Scn * scn;
<a name="l00696"></a>00696       GElf_Shdr *shdr;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698       <span class="keywordflow">if</span> (phdr == NULL || phdr-&gt;p_type != <a class="code" href="readelf_8h.html#e047190f80b06212f9f25f3be4ebe532">PT_DYNAMIC</a>)
<a name="l00699"></a>00699           <span class="keywordflow">continue</span>;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701       scn = gelf_offscn(elf, phdr-&gt;p_offset);
<a name="l00702"></a>00702       shdr = gelf_getshdr(scn, &amp;shdr_mem);
<a name="l00703"></a>00703 
<a name="l00704"></a>00704       <span class="keywordflow">if</span> (shdr != NULL &amp;&amp; shdr-&gt;sh_type == SHT_DYNAMIC)
<a name="l00705"></a>00705           data = elf_getdata (scn, NULL);
<a name="l00706"></a>00706       <span class="keywordflow">if</span> (data == NULL)
<a name="l00707"></a>00707           <span class="keywordflow">continue</span>; 
<a name="l00708"></a>00708           
<a name="l00709"></a>00709       <span class="keywordflow">for</span> (cnt = 0; cnt &lt; shdr-&gt;sh_size / shdr-&gt;sh_entsize; ++cnt) {
<a name="l00710"></a>00710           GElf_Dyn dynmem;
<a name="l00711"></a>00711           GElf_Dyn *dyn = gelf_getdyn (data, cnt, &amp;dynmem);
<a name="l00712"></a>00712           <span class="keywordflow">if</span> (dyn == NULL)
<a name="l00713"></a>00713               <span class="keywordflow">break</span>;
<a name="l00714"></a>00714           <span class="keywordflow">if</span> (dyn-&gt;d_tag != DT_SONAME)
<a name="l00715"></a>00715               <span class="keywordflow">continue</span>;
<a name="l00716"></a>00716 
<a name="l00717"></a>00717           <span class="comment">/* add the soname to package deps */</span>
<a name="l00718"></a>00718           soname = elf_strptr(elf, shdr-&gt;sh_link, dyn-&gt;d_un.d_val);
<a name="l00719"></a>00719           <span class="keywordflow">if</span> (soname == NULL)
<a name="l00720"></a>00720               <span class="keywordflow">break</span>;
<a name="l00721"></a>00721           buf[0] = <span class="charliteral">'\0'</span>;
<a name="l00722"></a>00722           t = buf;
<a name="l00723"></a>00723           t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, soname);
<a name="l00724"></a>00724 <span class="preprocessor">#if !defined(__alpha__)</span>
<a name="l00725"></a>00725 <span class="preprocessor"></span>          <span class="keywordflow">if</span> (isElf64)
<a name="l00726"></a>00726               t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, <span class="stringliteral">"()(64bit)"</span>);
<a name="l00727"></a>00727 <span class="preprocessor">#endif</span>
<a name="l00728"></a>00728 <span class="preprocessor"></span>          t++;
<a name="l00729"></a>00729           <span class="comment">/* Add to package dependencies. */</span>
<a name="l00730"></a>00730           <span class="keywordflow">if</span> (!fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a>) {
<a name="l00731"></a>00731               ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>,
<a name="l00732"></a>00732                            buf, <span class="stringliteral">""</span>, <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>);
<a name="l00733"></a>00733               <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l00734"></a>00734               <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>, <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(t, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, ds));
<a name="l00735"></a>00735               ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l00736"></a>00736           }
<a name="l00737"></a>00737           <span class="keywordflow">break</span>;
<a name="l00738"></a>00738       }
<a name="l00739"></a>00739     }
<a name="l00740"></a>00740 exit:
<a name="l00741"></a>00741     <span class="keywordflow">if</span> (elf) (void) elf_end(elf);
<a name="l00742"></a>00742     close(fdno);
<a name="l00743"></a>00743     <span class="keywordflow">return</span> 0;
<a name="l00744"></a>00744 <span class="preprocessor">#endif</span>
<a name="l00745"></a>00745 <span class="preprocessor"></span>    <span class="keywordflow">return</span> -1;
<a name="l00746"></a>00746 }
<a name="l00747"></a>00747 
<a name="l00753"></a><a class="code" href="rpmfc_8c.html#09dec405d455f023061d080592fe9022">00753</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#09dec405d455f023061d080592fe9022" title="Extract script dependencies.">rpmfcSCRIPT</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc)
<a name="l00754"></a>00754         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00755"></a>00755         <span class="comment">/*@modifies fc, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757     <span class="keyword">const</span> <span class="keywordtype">char</span> * fn = fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>];
<a name="l00758"></a>00758     <span class="keyword">const</span> <span class="keywordtype">char</span> * bn;
<a name="l00759"></a>00759     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds;
<a name="l00760"></a>00760     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00761"></a>00761     FILE * fp;
<a name="l00762"></a>00762     <span class="keywordtype">char</span> * s, * se;
<a name="l00763"></a>00763     <span class="keywordtype">int</span> i;
<a name="l00764"></a>00764     <span class="keyword">struct </span>stat sb, * st = &amp;sb;
<a name="l00765"></a>00765     <span class="keywordtype">int</span> is_executable;
<a name="l00766"></a>00766     <span class="keywordtype">int</span> xx;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768     <span class="comment">/* Only executable scripts are searched. */</span>
<a name="l00769"></a>00769     <span class="keywordflow">if</span> (stat(fn, st) &lt; 0)
<a name="l00770"></a>00770         <span class="keywordflow">return</span> -1;
<a name="l00771"></a>00771     is_executable = (st-&gt;st_mode &amp; (S_IXUSR|S_IXGRP|S_IXOTH));
<a name="l00772"></a>00772 
<a name="l00773"></a>00773     fp = fopen(fn, <span class="stringliteral">"r"</span>);
<a name="l00774"></a>00774     <span class="keywordflow">if</span> (fp == NULL || ferror(fp)) {
<a name="l00775"></a>00775         <span class="keywordflow">if</span> (fp) (void) fclose(fp);
<a name="l00776"></a>00776         <span class="keywordflow">return</span> -1;
<a name="l00777"></a>00777     }
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <span class="comment">/* Look for #! interpreter in first 10 lines. */</span>
<a name="l00780"></a>00780 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00781"></a>00781     <span class="keywordflow">for</span> (i = 0; i &lt; 10; i++) {
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         s = fgets(buf, <span class="keyword">sizeof</span>(buf) - 1, fp);
<a name="l00784"></a>00784         <span class="keywordflow">if</span> (s == NULL || ferror(fp) || feof(fp))
<a name="l00785"></a>00785             <span class="keywordflow">break</span>;
<a name="l00786"></a>00786         s[<span class="keyword">sizeof</span>(buf)-1] = <span class="charliteral">'\0'</span>;
<a name="l00787"></a>00787         <span class="keywordflow">if</span> (!(s[0] == <span class="charliteral">'#'</span> &amp;&amp; s[1] == <span class="charliteral">'!'</span>))
<a name="l00788"></a>00788             <span class="keywordflow">continue</span>;
<a name="l00789"></a>00789         s += 2;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791         <span class="keywordflow">while</span> (*s &amp;&amp; strchr(<span class="stringliteral">" \t\n\r"</span>, *s) != NULL)
<a name="l00792"></a>00792             s++;
<a name="l00793"></a>00793         <span class="keywordflow">if</span> (*s == <span class="charliteral">'\0'</span>)
<a name="l00794"></a>00794             <span class="keywordflow">continue</span>;
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (*s != <span class="charliteral">'/'</span>)
<a name="l00796"></a>00796             <span class="keywordflow">continue</span>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         <span class="keywordflow">for</span> (se = s+1; *se; se++) {
<a name="l00799"></a>00799             <span class="keywordflow">if</span> (strchr(<span class="stringliteral">" \t\n\r"</span>, *se) != NULL)
<a name="l00800"></a>00800                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00801"></a>00801         }
<a name="l00802"></a>00802         *se = <span class="charliteral">'\0'</span>;
<a name="l00803"></a>00803         se++;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805         <span class="keywordflow">if</span> (is_executable) {
<a name="l00806"></a>00806             <span class="comment">/* Add to package requires. */</span>
<a name="l00807"></a>00807             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, s, <span class="stringliteral">""</span>, <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>);
<a name="l00808"></a>00808             xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l00809"></a>00809 
<a name="l00810"></a>00810             <span class="comment">/* Add to file requires. */</span>
<a name="l00811"></a>00811             xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>, <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(se, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, ds));
<a name="l00812"></a>00812 
<a name="l00813"></a>00813             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l00814"></a>00814         }
<a name="l00815"></a>00815 
<a name="l00816"></a>00816         <span class="comment">/* Set color based on interpreter name. */</span>
<a name="l00817"></a>00817         bn = basename(s);
<a name="l00818"></a>00818         <span class="keywordflow">if</span> (!strcmp(bn, <span class="stringliteral">"perl"</span>))
<a name="l00819"></a>00819             fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] |= <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e6ce254bc313528f92d2c838f1bcc4f0">RPMFC_PERL</a>;
<a name="l00820"></a>00820         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(bn, <span class="stringliteral">"python"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"python"</span>)-1))
<a name="l00821"></a>00821             fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] |= <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e7db0456ed2d6eea97458cdb9af704da">RPMFC_PYTHON</a>;
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         <span class="keywordflow">break</span>;
<a name="l00824"></a>00824     }
<a name="l00825"></a>00825 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     (void) fclose(fp);
<a name="l00828"></a>00828 
<a name="l00829"></a>00829     <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] &amp; <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e6ce254bc313528f92d2c838f1bcc4f0">RPMFC_PERL</a>) {
<a name="l00830"></a>00830         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] &amp; <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47a685010dd10b4f288f3196910d0536b4">RPMFC_MODULE</a>)
<a name="l00831"></a>00831             xx = <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(fc, <span class="charliteral">'P'</span>, <span class="stringliteral">"perl"</span>);
<a name="l00832"></a>00832         <span class="keywordflow">if</span> (is_executable || (fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] &amp; RPMFC_MODULE))
<a name="l00833"></a>00833             xx = <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(fc, <span class="charliteral">'R'</span>, <span class="stringliteral">"perl"</span>);
<a name="l00834"></a>00834     }
<a name="l00835"></a>00835     <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] &amp; <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e7db0456ed2d6eea97458cdb9af704da">RPMFC_PYTHON</a>) {
<a name="l00836"></a>00836         xx = <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(fc, <span class="charliteral">'P'</span>, <span class="stringliteral">"python"</span>);
<a name="l00837"></a>00837 <span class="preprocessor">#ifdef  NOTYET</span>
<a name="l00838"></a>00838 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (is_executable)
<a name="l00839"></a>00839 <span class="preprocessor">#endif</span>
<a name="l00840"></a>00840 <span class="preprocessor"></span>            xx = <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(fc, <span class="charliteral">'R'</span>, <span class="stringliteral">"python"</span>);
<a name="l00841"></a>00841     }
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] &amp; <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4755d4385669144850ca114703efb0dffc">RPMFC_MONO</a>) {
<a name="l00843"></a>00843         xx = <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(fc, <span class="charliteral">'P'</span>, <span class="stringliteral">"mono"</span>);
<a name="l00844"></a>00844         <span class="keywordflow">if</span> (is_executable)
<a name="l00845"></a>00845             xx = <a class="code" href="rpmfc_8c.html#98d9b2822014fa82430437fb22e01c21" title="Run per-interpreter dependency helper.">rpmfcHelper</a>(fc, <span class="charliteral">'R'</span>, <span class="stringliteral">"mono"</span>);
<a name="l00846"></a>00846     }
<a name="l00847"></a>00847 
<a name="l00848"></a>00848     <span class="keywordflow">return</span> 0;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00856"></a><a class="code" href="rpmfc_8c.html#21b455161503cc8b1fcc8ec2c8bf187a">00856</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#21b455161503cc8b1fcc8ec2c8bf187a" title="Extract Elf dependencies.">rpmfcELF</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc)
<a name="l00857"></a>00857         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00858"></a>00858         <span class="comment">/*@modifies fc, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l00859"></a>00859 {
<a name="l00860"></a>00860 <span class="preprocessor">#if HAVE_GELF_H &amp;&amp; HAVE_LIBELF</span>
<a name="l00861"></a>00861 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span> * fn = fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>];
<a name="l00862"></a>00862     Elf * elf;
<a name="l00863"></a>00863     Elf_Scn * scn;
<a name="l00864"></a>00864     Elf_Data * data;
<a name="l00865"></a>00865     GElf_Ehdr ehdr_mem, * ehdr;
<a name="l00866"></a>00866     GElf_Shdr shdr_mem, * shdr;
<a name="l00867"></a>00867     GElf_Verdef def_mem, * def;
<a name="l00868"></a>00868     GElf_Verneed need_mem, * need;
<a name="l00869"></a>00869     GElf_Dyn dyn_mem, * dyn;
<a name="l00870"></a>00870     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> auxoffset;
<a name="l00871"></a>00871     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset;
<a name="l00872"></a>00872     <span class="keywordtype">int</span> fdno;
<a name="l00873"></a>00873     <span class="keywordtype">int</span> cnt2;
<a name="l00874"></a>00874     <span class="keywordtype">int</span> cnt;
<a name="l00875"></a>00875     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l00876"></a>00876     <span class="keyword">const</span> <span class="keywordtype">char</span> * s;
<a name="l00877"></a>00877     <span class="keyword">struct </span>stat sb, * st = &amp;sb;
<a name="l00878"></a>00878     <span class="keyword">const</span> <span class="keywordtype">char</span> * soname = NULL;
<a name="l00879"></a>00879     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> * depsp, ds;
<a name="l00880"></a>00880     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> tagN, dsContext;
<a name="l00881"></a>00881     <span class="keywordtype">char</span> * t;
<a name="l00882"></a>00882     <span class="keywordtype">int</span> xx;
<a name="l00883"></a>00883     <span class="keywordtype">int</span> isElf64;
<a name="l00884"></a>00884     <span class="keywordtype">int</span> isDSO;
<a name="l00885"></a>00885     <span class="keywordtype">int</span> gotSONAME = 0;
<a name="l00886"></a>00886     <span class="keywordtype">int</span> gotDEBUG = 0;
<a name="l00887"></a>00887     <span class="keywordtype">int</span> gotHASH = 0;
<a name="l00888"></a>00888     <span class="keywordtype">int</span> gotGNUHASH = 0;
<a name="l00889"></a>00889     <span class="keyword">static</span> <span class="keywordtype">int</span> filter_GLIBC_PRIVATE = 0;
<a name="l00890"></a>00890     <span class="keyword">static</span> <span class="keywordtype">int</span> oneshot = 0;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892     <span class="keywordflow">if</span> (oneshot == 0) {
<a name="l00893"></a>00893         oneshot = 1;
<a name="l00894"></a>00894         filter_GLIBC_PRIVATE = <a class="code" href="macro_8c.html#2e43f3dd86c8e646243de9f051f36f6a" title="Return macro expansion as a numeric value.">rpmExpandNumeric</a>(<span class="stringliteral">"%{?_filter_GLIBC_PRIVATE}"</span>);
<a name="l00895"></a>00895     }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="comment">/* Files with executable bit set only. */</span>
<a name="l00898"></a>00898     <span class="keywordflow">if</span> (stat(fn, st) != 0)
<a name="l00899"></a>00899         <span class="keywordflow">return</span>(-1);
<a name="l00900"></a>00900 
<a name="l00901"></a>00901     fdno = open(fn, O_RDONLY);
<a name="l00902"></a>00902     <span class="keywordflow">if</span> (fdno &lt; 0)
<a name="l00903"></a>00903         <span class="keywordflow">return</span> fdno;
<a name="l00904"></a>00904 
<a name="l00905"></a>00905     (void) elf_version(EV_CURRENT);
<a name="l00906"></a>00906 
<a name="l00907"></a>00907 <span class="comment">/*@-evalorder@*/</span>
<a name="l00908"></a>00908     elf = NULL;
<a name="l00909"></a>00909     <span class="keywordflow">if</span> ((elf = elf_begin (fdno, ELF_C_READ, NULL)) == NULL
<a name="l00910"></a>00910      || elf_kind(elf) != ELF_K_ELF
<a name="l00911"></a>00911      || (ehdr = gelf_getehdr(elf, &amp;ehdr_mem)) == NULL
<a name="l00912"></a>00912      || !(ehdr-&gt;e_type == ET_DYN || ehdr-&gt;e_type == <a class="code" href="readelf_8h.html#279e9391d18792b3a4e2b0a0fecc7418">ET_EXEC</a>))
<a name="l00913"></a>00913         <span class="keywordflow">goto</span> exit;
<a name="l00914"></a>00914 <span class="comment">/*@=evalorder@*/</span>
<a name="l00915"></a>00915 
<a name="l00916"></a>00916     isElf64 = ehdr-&gt;e_ident[<a class="code" href="readelf_8h.html#95e3653fa558cb3c913f9706ffea2e03">EI_CLASS</a>] == <a class="code" href="readelf_8h.html#d1985372d271e0cb6dfa038273177cf9">ELFCLASS64</a>;
<a name="l00917"></a>00917     isDSO = ehdr-&gt;e_type == ET_DYN;
<a name="l00918"></a>00918 
<a name="l00919"></a>00919     <span class="comment">/*@-branchstate -uniondef @*/</span>
<a name="l00920"></a>00920     scn = NULL;
<a name="l00921"></a>00921     <span class="keywordflow">while</span> ((scn = elf_nextscn(elf, scn)) != NULL) {
<a name="l00922"></a>00922         shdr = gelf_getshdr(scn, &amp;shdr_mem);
<a name="l00923"></a>00923         <span class="keywordflow">if</span> (shdr == NULL)
<a name="l00924"></a>00924             <span class="keywordflow">break</span>;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926         soname = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(soname);
<a name="l00927"></a>00927         <span class="keywordflow">switch</span> (shdr-&gt;sh_type) {
<a name="l00928"></a>00928         <span class="keywordflow">default</span>:
<a name="l00929"></a>00929             <span class="keywordflow">continue</span>;
<a name="l00930"></a>00930             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00931"></a>00931         <span class="keywordflow">case</span> SHT_GNU_verdef:
<a name="l00932"></a>00932             data = NULL;
<a name="l00933"></a>00933             <span class="keywordflow">if</span> (!fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a>)
<a name="l00934"></a>00934             <span class="keywordflow">while</span> ((data = elf_getdata (scn, data)) != NULL) {
<a name="l00935"></a>00935                 offset = 0;
<a name="l00936"></a>00936                 <span class="keywordflow">for</span> (cnt = shdr-&gt;sh_info; --cnt &gt;= 0; ) {
<a name="l00937"></a>00937                 
<a name="l00938"></a>00938                     def = gelf_getverdef (data, offset, &amp;def_mem);
<a name="l00939"></a>00939                     <span class="keywordflow">if</span> (def == NULL)
<a name="l00940"></a>00940                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00941"></a>00941                     auxoffset = offset + def-&gt;vd_aux;
<a name="l00942"></a>00942                     <span class="keywordflow">for</span> (cnt2 = def-&gt;vd_cnt; --cnt2 &gt;= 0; ) {
<a name="l00943"></a>00943                         GElf_Verdaux aux_mem, * aux;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945                         aux = gelf_getverdaux (data, auxoffset, &amp;aux_mem);
<a name="l00946"></a>00946                         <span class="keywordflow">if</span> (aux == NULL)
<a name="l00947"></a>00947                             <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00948"></a>00948 
<a name="l00949"></a>00949                         s = elf_strptr(elf, shdr-&gt;sh_link, aux-&gt;vda_name);
<a name="l00950"></a>00950                         <span class="keywordflow">if</span> (s == NULL)
<a name="l00951"></a>00951                             <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00952"></a>00952                         <span class="keywordflow">if</span> (def-&gt;vd_flags &amp; VER_FLG_BASE) {
<a name="l00953"></a>00953                             soname = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(soname);
<a name="l00954"></a>00954                             soname = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(s);
<a name="l00955"></a>00955                             auxoffset += aux-&gt;vda_next;
<a name="l00956"></a>00956                             <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00957"></a>00957                         } <span class="keywordflow">else</span>
<a name="l00958"></a>00958                         <span class="keywordflow">if</span> (soname != NULL
<a name="l00959"></a>00959                          &amp;&amp; !(filter_GLIBC_PRIVATE != 0
<a name="l00960"></a>00960                                 &amp;&amp; !strcmp(s, <span class="stringliteral">"GLIBC_PRIVATE"</span>)))
<a name="l00961"></a>00961                         {
<a name="l00962"></a>00962                             buf[0] = <span class="charliteral">'\0'</span>;
<a name="l00963"></a>00963                             t = buf;
<a name="l00964"></a>00964                             t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, soname), <span class="stringliteral">"("</span>), s), <span class="stringliteral">")"</span>);
<a name="l00965"></a>00965 
<a name="l00966"></a>00966 <span class="preprocessor">#if !defined(__alpha__)</span>
<a name="l00967"></a>00967 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (isElf64)
<a name="l00968"></a>00968                                 t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, <span class="stringliteral">"(64bit)"</span>);
<a name="l00969"></a>00969 <span class="preprocessor">#endif</span>
<a name="l00970"></a>00970 <span class="preprocessor"></span>                            t++;
<a name="l00971"></a>00971 
<a name="l00972"></a>00972                             <span class="comment">/* Add to package provides. */</span>
<a name="l00973"></a>00973                             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#067dcd3f881f213087ae32193daabae8">RPMTAG_PROVIDES</a>,
<a name="l00974"></a>00974                                         buf, <span class="stringliteral">""</span>, <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095dbd5b2fcf70d1ef8863e13c9b8fe9da2">RPMSENSE_FIND_PROVIDES</a>);
<a name="l00975"></a>00975                             xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>, ds);
<a name="l00976"></a>00976 
<a name="l00977"></a>00977                             <span class="comment">/* Add to file dependencies. */</span>
<a name="l00978"></a>00978                             xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>,
<a name="l00979"></a>00979                                         <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(t, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, ds));
<a name="l00980"></a>00980 
<a name="l00981"></a>00981                             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l00982"></a>00982                         }
<a name="l00983"></a>00983                         auxoffset += aux-&gt;vda_next;
<a name="l00984"></a>00984                     }
<a name="l00985"></a>00985                     offset += def-&gt;vd_next;
<a name="l00986"></a>00986                 }
<a name="l00987"></a>00987             }
<a name="l00988"></a>00988             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00989"></a>00989         <span class="keywordflow">case</span> SHT_GNU_verneed:
<a name="l00990"></a>00990             data = NULL;
<a name="l00991"></a>00991             <span class="comment">/* Files with executable bit set only. */</span>
<a name="l00992"></a>00992             <span class="keywordflow">if</span> (!fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a> &amp;&amp; (st-&gt;st_mode &amp; (S_IXUSR|S_IXGRP|S_IXOTH)))
<a name="l00993"></a>00993             <span class="keywordflow">while</span> ((data = elf_getdata (scn, data)) != NULL) {
<a name="l00994"></a>00994                 offset = 0;
<a name="l00995"></a>00995                 <span class="keywordflow">for</span> (cnt = shdr-&gt;sh_info; --cnt &gt;= 0; ) {
<a name="l00996"></a>00996                     need = gelf_getverneed (data, offset, &amp;need_mem);
<a name="l00997"></a>00997                     <span class="keywordflow">if</span> (need == NULL)
<a name="l00998"></a>00998                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000                     s = elf_strptr(elf, shdr-&gt;sh_link, need-&gt;vn_file);
<a name="l01001"></a>01001                     <span class="keywordflow">if</span> (s == NULL)
<a name="l01002"></a>01002                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01003"></a>01003                     soname = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(soname);
<a name="l01004"></a>01004                     soname = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(s);
<a name="l01005"></a>01005                     auxoffset = offset + need-&gt;vn_aux;
<a name="l01006"></a>01006                     <span class="keywordflow">for</span> (cnt2 = need-&gt;vn_cnt; --cnt2 &gt;= 0; ) {
<a name="l01007"></a>01007                         GElf_Vernaux aux_mem, * aux;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009                         aux = gelf_getvernaux (data, auxoffset, &amp;aux_mem);
<a name="l01010"></a>01010                         <span class="keywordflow">if</span> (aux == NULL)
<a name="l01011"></a>01011                             <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01012"></a>01012 
<a name="l01013"></a>01013                         s = elf_strptr(elf, shdr-&gt;sh_link, aux-&gt;vna_name);
<a name="l01014"></a>01014                         <span class="keywordflow">if</span> (s == NULL)
<a name="l01015"></a>01015                             <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017                         <span class="comment">/* Filter dependencies that contain GLIBC_PRIVATE */</span>
<a name="l01018"></a>01018                         <span class="keywordflow">if</span> (soname != NULL
<a name="l01019"></a>01019                          &amp;&amp; !(filter_GLIBC_PRIVATE != 0
<a name="l01020"></a>01020                                 &amp;&amp; !strcmp(s, <span class="stringliteral">"GLIBC_PRIVATE"</span>)))
<a name="l01021"></a>01021                         {
<a name="l01022"></a>01022                             buf[0] = <span class="charliteral">'\0'</span>;
<a name="l01023"></a>01023                             t = buf;
<a name="l01024"></a>01024                             t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, soname), <span class="stringliteral">"("</span>), s), <span class="stringliteral">")"</span>);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026 <span class="preprocessor">#if !defined(__alpha__)</span>
<a name="l01027"></a>01027 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (isElf64)
<a name="l01028"></a>01028                                 t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, <span class="stringliteral">"(64bit)"</span>);
<a name="l01029"></a>01029 <span class="preprocessor">#endif</span>
<a name="l01030"></a>01030 <span class="preprocessor"></span>                            t++;
<a name="l01031"></a>01031 
<a name="l01032"></a>01032                             <span class="comment">/* Add to package dependencies. */</span>
<a name="l01033"></a>01033                             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>,
<a name="l01034"></a>01034                                         buf, <span class="stringliteral">""</span>, <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>);
<a name="l01035"></a>01035                             xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037                             <span class="comment">/* Add to file dependencies. */</span>
<a name="l01038"></a>01038                             xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>,
<a name="l01039"></a>01039                                         <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(t, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, ds));
<a name="l01040"></a>01040                             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01041"></a>01041                         }
<a name="l01042"></a>01042                         auxoffset += aux-&gt;vna_next;
<a name="l01043"></a>01043                     }
<a name="l01044"></a>01044                     offset += need-&gt;vn_next;
<a name="l01045"></a>01045                 }
<a name="l01046"></a>01046             }
<a name="l01047"></a>01047             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01048"></a>01048         <span class="keywordflow">case</span> SHT_DYNAMIC:
<a name="l01049"></a>01049             data = NULL;
<a name="l01050"></a>01050             <span class="keywordflow">while</span> ((data = elf_getdata (scn, data)) != NULL) {
<a name="l01051"></a>01051 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01052"></a>01052                 <span class="keywordflow">for</span> (cnt = 0; cnt &lt; (shdr-&gt;sh_size / shdr-&gt;sh_entsize); ++cnt) {
<a name="l01053"></a>01053                     dyn = gelf_getdyn (data, cnt, &amp;dyn_mem);
<a name="l01054"></a>01054                     <span class="keywordflow">if</span> (dyn == NULL)
<a name="l01055"></a>01055                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01056"></a>01056                     s = NULL;
<a name="l01057"></a>01057                     <span class="keywordflow">switch</span> (dyn-&gt;d_tag) {
<a name="l01058"></a>01058                     <span class="keywordflow">default</span>:
<a name="l01059"></a>01059                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01060"></a>01060                         <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01061"></a>01061                     <span class="keywordflow">case</span> DT_HASH:    
<a name="l01062"></a>01062                         gotHASH= 1;
<a name="l01063"></a>01063                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01064"></a>01064                     <span class="keywordflow">case</span> DT_GNU_HASH:
<a name="l01065"></a>01065                         gotGNUHASH= 1;
<a name="l01066"></a>01066                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01067"></a>01067                     <span class="keywordflow">case</span> DT_DEBUG:    
<a name="l01068"></a>01068                         gotDEBUG = 1;
<a name="l01069"></a>01069                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01070"></a>01070                     <span class="keywordflow">case</span> DT_NEEDED:
<a name="l01071"></a>01071                         <span class="comment">/* Files with executable bit set only. */</span>
<a name="l01072"></a>01072                         if (fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a> || !(st-&gt;st_mode &amp; (S_IXUSR|S_IXGRP|S_IXOTH)))
<a name="l01073"></a>01073                             <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01074"></a>01074                         <span class="comment">/* Add to package requires. */</span>
<a name="l01075"></a>01075                         depsp = &amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>;
<a name="l01076"></a>01076                         tagN = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>;
<a name="l01077"></a>01077                         dsContext = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>;
<a name="l01078"></a>01078                         s = elf_strptr(elf, shdr-&gt;sh_link, dyn-&gt;d_un.d_val);
<a name="l01079"></a>01079 assert(s != NULL);
<a name="l01080"></a>01080                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01081"></a>01081                     <span class="keywordflow">case</span> DT_SONAME:
<a name="l01082"></a>01082                         gotSONAME = 1;
<a name="l01083"></a>01083                         <span class="comment">/* Add to package provides. */</span>
<a name="l01084"></a>01084                         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a>)
<a name="l01085"></a>01085                             <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01086"></a>01086                         depsp = &amp;fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>;
<a name="l01087"></a>01087                         tagN = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>;
<a name="l01088"></a>01088                         dsContext = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095dbd5b2fcf70d1ef8863e13c9b8fe9da2">RPMSENSE_FIND_PROVIDES</a>;
<a name="l01089"></a>01089                         s = elf_strptr(elf, shdr-&gt;sh_link, dyn-&gt;d_un.d_val);
<a name="l01090"></a>01090 assert(s != NULL);
<a name="l01091"></a>01091                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01092"></a>01092                     }
<a name="l01093"></a>01093                     <span class="keywordflow">if</span> (s == NULL)
<a name="l01094"></a>01094                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096                     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l01097"></a>01097                     t = buf;
<a name="l01098"></a>01098                     t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, s);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100 <span class="preprocessor">#if !defined(__alpha__)</span>
<a name="l01101"></a>01101 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (isElf64)
<a name="l01102"></a>01102                         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, <span class="stringliteral">"()(64bit)"</span>);
<a name="l01103"></a>01103 <span class="preprocessor">#endif</span>
<a name="l01104"></a>01104 <span class="preprocessor"></span>                    t++;
<a name="l01105"></a>01105 
<a name="l01106"></a>01106                     <span class="comment">/* Add to package dependencies. */</span>
<a name="l01107"></a>01107                     ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(tagN, buf, <span class="stringliteral">""</span>, dsContext);
<a name="l01108"></a>01108                     xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(depsp, ds);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                     <span class="comment">/* Add to file dependencies. */</span>
<a name="l01111"></a>01111                     xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>,
<a name="l01112"></a>01112                                         <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(t, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, ds));
<a name="l01113"></a>01113 
<a name="l01114"></a>01114                     ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01115"></a>01115                 }
<a name="l01116"></a>01116 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01117"></a>01117             }
<a name="l01118"></a>01118             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01119"></a>01119         }
<a name="l01120"></a>01120     }
<a name="l01121"></a>01121     <span class="comment">/*@=branchstate =uniondef @*/</span>
<a name="l01122"></a>01122 
<a name="l01123"></a>01123     <span class="comment">/* For DSOs which use the .gnu_hash section and don't have a .hash</span>
<a name="l01124"></a>01124 <span class="comment">     * section, we need to ensure that we have a new enough glibc. */</span> 
<a name="l01125"></a>01125     <span class="keywordflow">if</span> (gotGNUHASH &amp;&amp; !gotHASH) {
<a name="l01126"></a>01126         ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, <span class="stringliteral">"rtld(GNU_HASH)"</span>, <span class="stringliteral">""</span>, 
<a name="l01127"></a>01127                          <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>);
<a name="l01128"></a>01128         <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;requires, ds);
<a name="l01129"></a>01129         buf[0] = <span class="charliteral">'\0'</span>;
<a name="l01130"></a>01130         t = buf;
<a name="l01131"></a>01131         <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;ddict, <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(t, fc-&gt;ix, ds));
<a name="l01132"></a>01132         ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01133"></a>01133     }
<a name="l01134"></a>01134 
<a name="l01135"></a>01135     <span class="comment">/* For DSO's, provide the basename of the file if DT_SONAME not found. */</span>
<a name="l01136"></a>01136     <span class="keywordflow">if</span> (!fc-&gt;skipProv &amp;&amp; isDSO &amp;&amp; !gotDEBUG &amp;&amp; !gotSONAME) {
<a name="l01137"></a>01137         depsp = &amp;fc-&gt;provides;
<a name="l01138"></a>01138         tagN = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>;
<a name="l01139"></a>01139         dsContext = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095dbd5b2fcf70d1ef8863e13c9b8fe9da2">RPMSENSE_FIND_PROVIDES</a>;
<a name="l01140"></a>01140 
<a name="l01141"></a>01141         s = strrchr(fn, <span class="charliteral">'/'</span>);
<a name="l01142"></a>01142         <span class="keywordflow">if</span> (s)
<a name="l01143"></a>01143             s++;
<a name="l01144"></a>01144         <span class="keywordflow">else</span>
<a name="l01145"></a>01145             s = fn;
<a name="l01146"></a>01146 
<a name="l01147"></a>01147 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01148"></a>01148         buf[0] = <span class="charliteral">'\0'</span>;
<a name="l01149"></a>01149         t = buf;
<a name="l01150"></a>01150 <span class="comment">/*@-nullpass@*/</span> <span class="comment">/* LCL: s is not null. */</span>
<a name="l01151"></a>01151         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, s);
<a name="l01152"></a>01152 <span class="comment">/*@=nullpass@*/</span>
<a name="l01153"></a>01153 
<a name="l01154"></a>01154 <span class="preprocessor">#if !defined(__alpha__)</span>
<a name="l01155"></a>01155 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (isElf64)
<a name="l01156"></a>01156             t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, <span class="stringliteral">"()(64bit)"</span>);
<a name="l01157"></a>01157 <span class="preprocessor">#endif</span>
<a name="l01158"></a>01158 <span class="preprocessor"></span><span class="comment">/*@=boundswrite@*/</span>
<a name="l01159"></a>01159         t++;
<a name="l01160"></a>01160 
<a name="l01161"></a>01161         <span class="comment">/* Add to package dependencies. */</span>
<a name="l01162"></a>01162         ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(tagN, buf, <span class="stringliteral">""</span>, dsContext);
<a name="l01163"></a>01163         xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(depsp, ds);
<a name="l01164"></a>01164 
<a name="l01165"></a>01165         <span class="comment">/* Add to file dependencies. */</span>
<a name="l01166"></a>01166 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01167"></a>01167         xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;ddict, <a class="code" href="rpmfc_8c.html#cef1a7f8944117c8fe85af8150be068e">rpmfcFileDep</a>(t, fc-&gt;ix, ds));
<a name="l01168"></a>01168 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01169"></a>01169 
<a name="l01170"></a>01170         ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 exit:
<a name="l01174"></a>01174     soname = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(soname);
<a name="l01175"></a>01175     <span class="keywordflow">if</span> (elf) (void) elf_end(elf);
<a name="l01176"></a>01176     xx = close(fdno);
<a name="l01177"></a>01177     <span class="keywordflow">return</span> 0;
<a name="l01178"></a>01178 <span class="preprocessor">#else</span>
<a name="l01179"></a>01179 <span class="preprocessor"></span>    <span class="keywordflow">return</span> -1;
<a name="l01180"></a>01180 <span class="preprocessor">#endif</span>
<a name="l01181"></a>01181 <span class="preprocessor"></span>}
<a name="l01182"></a>01182 
<a name="l01183"></a><a class="code" href="structrpmfcApplyTbl__s.html">01183</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structrpmfcApplyTbl__s.html">rpmfcApplyTbl_s</a> {
<a name="l01184"></a>01184     int (*<a class="code" href="structrpmfcApplyTbl__s.html#6cbf8838fe7d7bb2ec947a7b23a8f218">func</a>) (<a class="code" href="structrpmfc__s.html">rpmfc</a> fc);
<a name="l01185"></a><a class="code" href="structrpmfcApplyTbl__s.html#fbcef0483b0af6a81ed72d1badb4a5a3">01185</a>     <span class="keywordtype">int</span> <a class="code" href="structrpmfcApplyTbl__s.html#fbcef0483b0af6a81ed72d1badb4a5a3">colormask</a>;
<a name="l01186"></a>01186 } * <a class="code" href="structrpmfcApplyTbl__s.html">rpmfcApplyTbl</a>;
<a name="l01187"></a>01187 
<a name="l01190"></a>01190 <span class="comment">/*@unchecked@*/</span>
<a name="l01191"></a><a class="code" href="rpmfc_8c.html#f97331584f11799e74a78f9c1f27dcdf">01191</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structrpmfcApplyTbl__s.html">rpmfcApplyTbl_s</a> <a class="code" href="rpmfc_8c.html#f97331584f11799e74a78f9c1f27dcdf">rpmfcApplyTable</a>[] = {
<a name="l01192"></a>01192     { <a class="code" href="rpmfc_8c.html#21b455161503cc8b1fcc8ec2c8bf187a" title="Extract Elf dependencies.">rpmfcELF</a>,         <a class="code" href="rpmfc_8h.html#2a1df785565110f0585418a5db33982e">RPMFC_ELF</a> },
<a name="l01193"></a>01193     { <a class="code" href="rpmfc_8c.html#09dec405d455f023061d080592fe9022" title="Extract script dependencies.">rpmfcSCRIPT</a>,      (<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47cea134e03e17e45c0a0307a656f1207f">RPMFC_SCRIPT</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e6ce254bc313528f92d2c838f1bcc4f0">RPMFC_PERL</a>) },
<a name="l01194"></a>01194     { <a class="code" href="rpmfc_8c.html#09dec405d455f023061d080592fe9022" title="Extract script dependencies.">rpmfcSCRIPT</a>,      (<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47cea134e03e17e45c0a0307a656f1207f">RPMFC_SCRIPT</a>|<a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e7db0456ed2d6eea97458cdb9af704da">RPMFC_PYTHON</a>) },
<a name="l01195"></a>01195     { <a class="code" href="rpmfc_8c.html#09dec405d455f023061d080592fe9022" title="Extract script dependencies.">rpmfcSCRIPT</a>,      <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4755d4385669144850ca114703efb0dffc">RPMFC_MONO</a> },
<a name="l01196"></a>01196     { <a class="code" href="rpmfc_8c.html#06d4fc60ec5c7ca77a308a5038026ae9" title="Ensure that symlinks for shared libs generate a dep on the shared lib.">rpmfcSYMLINK</a>,     <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47ad94991b8ac141927fba4c3e21be05bf">RPMFC_SYMLINK</a> },
<a name="l01197"></a>01197     { NULL, 0 }
<a name="l01198"></a>01198 };
<a name="l01199"></a>01199 
<a name="l01200"></a><a class="code" href="rpmfc_8h.html#ad428557e9ea4f79296dec422e737000">01200</a> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#ad428557e9ea4f79296dec422e737000" title="Build file/package dependency dictionary and mappings.">rpmfcApply</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc)
<a name="l01201"></a>01201 {
<a name="l01202"></a>01202     <a class="code" href="structrpmfcApplyTbl__s.html">rpmfcApplyTbl</a> fcat;
<a name="l01203"></a>01203     <span class="keyword">const</span> <span class="keywordtype">char</span> * s;
<a name="l01204"></a>01204     <span class="keywordtype">char</span> * se;
<a name="l01205"></a>01205     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds;
<a name="l01206"></a>01206     <span class="keyword">const</span> <span class="keywordtype">char</span> * N;
<a name="l01207"></a>01207     <span class="keyword">const</span> <span class="keywordtype">char</span> * EVR;
<a name="l01208"></a>01208     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> Flags;
<a name="l01209"></a>01209     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> deptype;
<a name="l01210"></a>01210     <span class="keywordtype">int</span> nddict;
<a name="l01211"></a>01211     <span class="keywordtype">int</span> previx;
<a name="l01212"></a>01212     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> val;
<a name="l01213"></a>01213     <span class="keywordtype">int</span> dix;
<a name="l01214"></a>01214     <span class="keywordtype">int</span> ix;
<a name="l01215"></a>01215     <span class="keywordtype">int</span> i;
<a name="l01216"></a>01216     <span class="keywordtype">int</span> xx;
<a name="l01217"></a>01217     <span class="keywordtype">int</span> skipping;
<a name="l01218"></a>01218 
<a name="l01219"></a>01219     <span class="comment">/* Generate package and per-file dependencies. */</span>
<a name="l01220"></a>01220     <span class="keywordflow">for</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a> = 0; fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] != NULL; fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>++) {
<a name="l01221"></a>01221 
<a name="l01222"></a>01222         <span class="comment">/* XXX Insure that /usr/lib{,64}/python files are marked RPMFC_PYTHON */</span>
<a name="l01223"></a>01223         <span class="comment">/* XXX HACK: classification by path is intrinsically stupid. */</span>
<a name="l01224"></a>01224         {   <span class="keyword">const</span> <span class="keywordtype">char</span> *fn = strstr(fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>], <span class="stringliteral">"/usr/lib"</span>);
<a name="l01225"></a>01225             <span class="keywordflow">if</span> (fn) {
<a name="l01226"></a>01226                 fn += <span class="keyword">sizeof</span>(<span class="stringliteral">"/usr/lib"</span>)-1;
<a name="l01227"></a>01227                 <span class="keywordflow">if</span> (fn[0] == <span class="charliteral">'6'</span> &amp;&amp; fn[1] == <span class="charliteral">'4'</span>)
<a name="l01228"></a>01228                     fn += 2;
<a name="l01229"></a>01229                 <span class="keywordflow">if</span> (!strncmp(fn, <span class="stringliteral">"/python"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"/python"</span>)-1))
<a name="l01230"></a>01230                     fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] |= <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c47e7db0456ed2d6eea97458cdb9af704da">RPMFC_PYTHON</a>;
<a name="l01231"></a>01231             }
<a name="l01232"></a>01232         }
<a name="l01233"></a>01233 
<a name="l01234"></a>01234         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>])
<a name="l01235"></a>01235         <span class="keywordflow">for</span> (fcat = <a class="code" href="rpmfc_8c.html#f97331584f11799e74a78f9c1f27dcdf">rpmfcApplyTable</a>; fcat-&gt;<a class="code" href="structrpmfcApplyTbl__s.html#6cbf8838fe7d7bb2ec947a7b23a8f218">func</a> != NULL; fcat++) {
<a name="l01236"></a>01236             <span class="keywordflow">if</span> (!(fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] &amp; fcat-&gt;<a class="code" href="structrpmfcApplyTbl__s.html#fbcef0483b0af6a81ed72d1badb4a5a3">colormask</a>))
<a name="l01237"></a>01237                 <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01238"></a>01238             xx = (*fcat-&gt;<a class="code" href="structrpmfcApplyTbl__s.html#6cbf8838fe7d7bb2ec947a7b23a8f218">func</a>) (fc);
<a name="l01239"></a>01239         }
<a name="l01240"></a>01240     }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01243"></a>01243     <span class="comment">/* Generate per-file indices into package dependencies. */</span>
<a name="l01244"></a>01244     nddict = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>);
<a name="l01245"></a>01245     previx = -1;
<a name="l01246"></a>01246     <span class="keywordflow">for</span> (i = 0; i &lt; nddict; i++) {
<a name="l01247"></a>01247         s = fc-&gt;<a class="code" href="structrpmfc__s.html#060c665a14cc55217b429320c4140bcb">ddict</a>[i];
<a name="l01248"></a>01248 
<a name="l01249"></a>01249         <span class="comment">/* Parse out (file#,deptype,N,EVR,Flags) */</span>
<a name="l01250"></a>01250         ix = strtol(s, &amp;se, 10);
<a name="l01251"></a>01251 assert(se != NULL);
<a name="l01252"></a>01252         deptype = *se++;
<a name="l01253"></a>01253         se++;
<a name="l01254"></a>01254         N = se;
<a name="l01255"></a>01255         <span class="keywordflow">while</span> (*se &amp;&amp; *se != <span class="charliteral">' '</span>)
<a name="l01256"></a>01256             se++;
<a name="l01257"></a>01257         *se++ = <span class="charliteral">'\0'</span>;
<a name="l01258"></a>01258         EVR = se;
<a name="l01259"></a>01259         <span class="keywordflow">while</span> (*se &amp;&amp; *se != <span class="charliteral">' '</span>)
<a name="l01260"></a>01260             se++;
<a name="l01261"></a>01261         *se++ = <span class="charliteral">'\0'</span>;
<a name="l01262"></a>01262         Flags = strtol(se, NULL, 16);
<a name="l01263"></a>01263 
<a name="l01264"></a>01264         dix = -1;
<a name="l01265"></a>01265         skipping = 0;
<a name="l01266"></a>01266         <span class="keywordflow">switch</span> (deptype) {
<a name="l01267"></a>01267         <span class="keywordflow">default</span>:
<a name="l01268"></a>01268             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01269"></a>01269         <span class="keywordflow">case</span> <span class="charliteral">'P'</span>:       
<a name="l01270"></a>01270             skipping = fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a>;
<a name="l01271"></a>01271             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, N, EVR, Flags);
<a name="l01272"></a>01272             dix = <a class="code" href="rpmds_8c.html#793384cb71b1f0de21996e1c836107b4" title="Find a dependency set element using binary search.">rpmdsFind</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>, ds);
<a name="l01273"></a>01273             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01274"></a>01274             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01275"></a>01275         <span class="keywordflow">case</span> <span class="charliteral">'R'</span>:
<a name="l01276"></a>01276             skipping = fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a>;
<a name="l01277"></a>01277             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, N, EVR, Flags);
<a name="l01278"></a>01278             dix = <a class="code" href="rpmds_8c.html#793384cb71b1f0de21996e1c836107b4" title="Find a dependency set element using binary search.">rpmdsFind</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l01279"></a>01279             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01280"></a>01280             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01281"></a>01281         }
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="comment">/* XXX assertion incorrect while generating -debuginfo deps. */</span>
<a name="l01284"></a>01284 <span class="preprocessor">#if 0</span>
<a name="l01285"></a>01285 <span class="preprocessor"></span>assert(dix &gt;= 0);
<a name="l01286"></a>01286 <span class="preprocessor">#else</span>
<a name="l01287"></a>01287 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (dix &lt; 0)
<a name="l01288"></a>01288             <span class="keywordflow">continue</span>;
<a name="l01289"></a>01289 <span class="preprocessor">#endif</span>
<a name="l01290"></a>01290 <span class="preprocessor"></span>
<a name="l01291"></a>01291         val = (deptype &lt;&lt; 24) | (dix &amp; 0x00ffffff);
<a name="l01292"></a>01292         xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>, -1, val);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294         <span class="keywordflow">if</span> (previx != ix) {
<a name="l01295"></a>01295             previx = ix;
<a name="l01296"></a>01296             xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a>, ix, <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>)-1);
<a name="l01297"></a>01297         }
<a name="l01298"></a>01298         <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a> &amp;&amp; fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a> &amp;&amp; !skipping)
<a name="l01299"></a>01299             fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>-&gt;<a class="code" href="structARGI__s.html#102786633918210af3fb208406872dfc">vals</a>[ix]++;
<a name="l01300"></a>01300     }
<a name="l01301"></a>01301 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01302"></a>01302 
<a name="l01303"></a>01303     <span class="keywordflow">return</span> 0;
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 
<a name="l01306"></a><a class="code" href="rpmfc_8c.html#1d2f8f13da156a0f85921fd15e4bb9a8">01306</a> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#1d2f8f13da156a0f85921fd15e4bb9a8">rpmfcClassify</a>(<a class="code" href="structrpmfc__s.html">rpmfc</a> fc, <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>, <a class="code" href="header_8h.html#b6a208567758c1b3a414d16609a553e6">int_16</a> * fmode)
<a name="l01307"></a>01307 {
<a name="l01308"></a>01308     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> fcav = NULL;
<a name="l01309"></a>01309     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> dav;
<a name="l01310"></a>01310     <span class="keyword">const</span> <span class="keywordtype">char</span> * s, * se;
<a name="l01311"></a>01311     <span class="keywordtype">size_t</span> slen;
<a name="l01312"></a>01312     <span class="keywordtype">int</span> fcolor;
<a name="l01313"></a>01313     <span class="keywordtype">int</span> xx;
<a name="l01314"></a>01314 <span class="comment">/*@observer@*/</span>
<a name="l01315"></a>01315     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="file_8c.html#a1ffb826acdcdd6e09f80c702d2e86a7">magicfile</a> = <span class="stringliteral">"/usr/lib/rpm/magic"</span>;
<a name="l01316"></a>01316     <span class="keywordtype">int</span> msflags = MAGIC_CHECK;  <span class="comment">/* XXX MAGIC_COMPRESS flag? */</span>
<a name="l01317"></a>01317     magic_t ms = NULL;
<a name="l01318"></a>01318 
<a name="l01319"></a>01319     <span class="keywordflow">if</span> (fc == NULL || argv == NULL)
<a name="l01320"></a>01320         <span class="keywordflow">return</span> 0;
<a name="l01321"></a>01321 
<a name="l01322"></a>01322     fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a> = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(argv);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324     <span class="comment">/* Initialize the per-file dictionary indices. */</span>
<a name="l01325"></a>01325     xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a>, fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>-1, 0);
<a name="l01326"></a>01326     xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>, fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>-1, 0);
<a name="l01327"></a>01327 
<a name="l01328"></a>01328     <span class="comment">/* Build (sorted) file class dictionary. */</span>
<a name="l01329"></a>01329     xx = <a class="code" href="argv_8c.html#72323478dc4967ef21899e9c48221721" title="Add a string to an argv array.">argvAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>, <span class="stringliteral">""</span>);
<a name="l01330"></a>01330     xx = <a class="code" href="argv_8c.html#72323478dc4967ef21899e9c48221721" title="Add a string to an argv array.">argvAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>, <span class="stringliteral">"directory"</span>);
<a name="l01331"></a>01331 
<a name="l01332"></a>01332     ms = magic_open(msflags);
<a name="l01333"></a>01333     <span class="keywordflow">if</span> (ms == NULL) {
<a name="l01334"></a>01334         xx = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>;
<a name="l01335"></a>01335         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(xx, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"magic_open(0x%x) failed: %s\n"</span>),
<a name="l01336"></a>01336                 msflags, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l01337"></a>01337 assert(ms != NULL);     <span class="comment">/* XXX figger a proper return path. */</span>
<a name="l01338"></a>01338     }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340     xx = magic_load(ms, magicfile);
<a name="l01341"></a>01341     <span class="keywordflow">if</span> (xx == -1) {
<a name="l01342"></a>01342         xx = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>;
<a name="l01343"></a>01343         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(xx, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"magic_load(ms, \"%s\") failed: %s\n"</span>),
<a name="l01344"></a>01344                 magicfile, magic_error(ms));
<a name="l01345"></a>01345 assert(xx != -1);       <span class="comment">/* XXX figger a proper return path. */</span>
<a name="l01346"></a>01346     }
<a name="l01347"></a>01347 
<a name="l01348"></a>01348     <span class="keywordflow">for</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a> = 0; fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a> &lt; fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>; fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>++) {
<a name="l01349"></a>01349         <span class="keyword">const</span> <span class="keywordtype">char</span> * ftype;
<a name="l01350"></a>01350         <a class="code" href="header_8h.html#b6a208567758c1b3a414d16609a553e6">int_16</a> mode = (fmode ? fmode[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>] : 0);
<a name="l01351"></a>01351         <span class="keywordtype">char</span> dbuf[1024];
<a name="l01352"></a>01352 
<a name="l01353"></a>01353         s = argv[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>];
<a name="l01354"></a>01354 assert(s != NULL);
<a name="l01355"></a>01355         slen = strlen(s);
<a name="l01356"></a>01356 
<a name="l01357"></a>01357         <span class="keywordflow">switch</span> (mode &amp; S_IFMT) {
<a name="l01358"></a>01358         <span class="keywordflow">case</span> S_IFCHR:   ftype = <span class="stringliteral">"character special"</span>;    <span class="keywordflow">break</span>;
<a name="l01359"></a>01359         <span class="keywordflow">case</span> S_IFBLK:   ftype = <span class="stringliteral">"block special"</span>;        <span class="keywordflow">break</span>;
<a name="l01360"></a>01360         <span class="keywordflow">case</span> S_IFIFO:   ftype = <span class="stringliteral">"fifo (named pipe)"</span>;    <span class="keywordflow">break</span>;
<a name="l01361"></a>01361         <span class="keywordflow">case</span> <a class="code" href="system_8h.html#80021768fa48b50ffe94b8cae83270ad">S_IFSOCK</a>:  ftype = <span class="stringliteral">"socket"</span>;               <span class="keywordflow">break</span>;
<a name="l01362"></a>01362         <span class="keywordflow">case</span> S_IFDIR:
<a name="l01363"></a>01363         <span class="keywordflow">case</span> S_IFLNK:
<a name="l01364"></a>01364         <span class="keywordflow">case</span> S_IFREG:
<a name="l01365"></a>01365         <span class="keywordflow">default</span>:
<a name="l01366"></a>01366             <span class="comment">/* XXX all files with extension ".pm" are perl modules for now. */</span>
<a name="l01367"></a>01367 <span class="comment">/*@-branchstate@*/</span>
<a name="l01368"></a>01368             <span class="keywordflow">if</span> (slen &gt;= <span class="keyword">sizeof</span>(<span class="stringliteral">".pm"</span>) &amp;&amp; !strcmp(s+slen-(<span class="keyword">sizeof</span>(<span class="stringliteral">".pm"</span>)-1), <span class="stringliteral">".pm"</span>))
<a name="l01369"></a>01369                 ftype = <span class="stringliteral">"Perl5 module source text"</span>;
<a name="l01370"></a>01370             <span class="comment">/* XXX skip all files in /dev/ which are (or should be) %dev dummies. */</span>
<a name="l01371"></a>01371             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (slen &gt;= fc-&gt;<a class="code" href="structrpmfc__s.html#cc235f964bff2dafba3ce858851346fb">brlen</a>+<span class="keyword">sizeof</span>(<span class="stringliteral">"/dev/"</span>) &amp;&amp; !strncmp(s+fc-&gt;<a class="code" href="structrpmfc__s.html#cc235f964bff2dafba3ce858851346fb">brlen</a>, <span class="stringliteral">"/dev/"</span>, <span class="keyword">sizeof</span>(<span class="stringliteral">"/dev/"</span>)-1))
<a name="l01372"></a>01372                 ftype = <span class="stringliteral">""</span>;
<a name="l01373"></a>01373             <span class="keywordflow">else</span>
<a name="l01374"></a>01374                 ftype = magic_file(ms, s);
<a name="l01375"></a>01375 
<a name="l01376"></a>01376             <span class="keywordflow">if</span> (ftype == NULL) {
<a name="l01377"></a>01377                 xx = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>;
<a name="l01378"></a>01378                 <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(xx, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"magic_file(ms, \"%s\") failed: mode %06o %s\n"</span>),
<a name="l01379"></a>01379                         s, mode, magic_error(ms));
<a name="l01380"></a>01380 assert(ftype != NULL);  <span class="comment">/* XXX figger a proper return path. */</span>
<a name="l01381"></a>01381             }
<a name="l01382"></a>01382         }
<a name="l01383"></a>01383 <span class="comment">/*@=branchstate@*/</span>
<a name="l01384"></a>01384 
<a name="l01385"></a>01385         se = ftype;
<a name="l01386"></a>01386         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <span class="stringliteral">"%s: %s\n"</span>, s, se);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388         <span class="comment">/* Save the path. */</span>
<a name="l01389"></a>01389         xx = <a class="code" href="argv_8c.html#72323478dc4967ef21899e9c48221721" title="Add a string to an argv array.">argvAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#25de1dfe7bac5af0982276b9c7c8f972">fn</a>, s);
<a name="l01390"></a>01390 
<a name="l01391"></a>01391         <span class="comment">/* Save the file type string. */</span>
<a name="l01392"></a>01392         xx = <a class="code" href="argv_8c.html#72323478dc4967ef21899e9c48221721" title="Add a string to an argv array.">argvAdd</a>(&amp;fcav, se);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394         <span class="comment">/* Add (filtered) entry to sorted class dictionary. */</span>
<a name="l01395"></a>01395         fcolor = <a class="code" href="rpmfc_8c.html#27dbddd78d9613ce88f08cb75b0b8957" title="Return file color given file(1) string.">rpmfcColoring</a>(se);
<a name="l01396"></a>01396         xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, fcolor);
<a name="l01397"></a>01397 
<a name="l01398"></a>01398 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01399"></a>01399         <span class="keywordflow">if</span> (fcolor != <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c473d0dfe5d3b6e3a1585455f3eec3be705">RPMFC_WHITE</a> &amp;&amp; (fcolor &amp; <a class="code" href="rpmfc_8h.html#2b00429fed44ab9cf09558469eac2c4785b7b9ba230be981f5c3d6ce6c966462">RPMFC_INCLUDE</a>))
<a name="l01400"></a>01400             xx = <a class="code" href="rpmfc_8c.html#4e0a9bc8c542cafa6ca4e306c367dbae">rpmfcSaveArg</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>, se);
<a name="l01401"></a>01401 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01402"></a>01402     }
<a name="l01403"></a>01403 
<a name="l01404"></a>01404     <span class="comment">/* Build per-file class index array. */</span>
<a name="l01405"></a>01405     fc-&gt;<a class="code" href="structrpmfc__s.html#669d14f9a2d946da731544851cbdc1fc">fknown</a> = 0;
<a name="l01406"></a>01406     <span class="keywordflow">for</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a> = 0; fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a> &lt; fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>; fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>++) {
<a name="l01407"></a>01407         se = fcav[fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>];
<a name="l01408"></a>01408 assert(se != NULL);
<a name="l01409"></a>01409 
<a name="l01410"></a>01410         dav = <a class="code" href="argv_8c.html#30eda845f3d71e5fd196272b077ead75" title="Find an element in an argv array.">argvSearch</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>, se, NULL);
<a name="l01411"></a>01411         <span class="keywordflow">if</span> (dav) {
<a name="l01412"></a>01412             xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a>, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, (dav - fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>));
<a name="l01413"></a>01413             fc-&gt;<a class="code" href="structrpmfc__s.html#669d14f9a2d946da731544851cbdc1fc">fknown</a>++;
<a name="l01414"></a>01414         } <span class="keywordflow">else</span> {
<a name="l01415"></a>01415             xx = <a class="code" href="argv_8c.html#f5f7e95ecee530a49458f3cdfaa87207" title="Add an int to an argi array.">argiAdd</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a>, fc-&gt;<a class="code" href="structrpmfc__s.html#eb6bef2a692421bbaabed7b7449a714f">ix</a>, 0);
<a name="l01416"></a>01416             fc-&gt;<a class="code" href="structrpmfc__s.html#8343206d39f01de2b7ad9bcbbf722a15">fwhite</a>++;
<a name="l01417"></a>01417         }
<a name="l01418"></a>01418     }
<a name="l01419"></a>01419 
<a name="l01420"></a>01420     fcav = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(fcav);
<a name="l01421"></a>01421 
<a name="l01422"></a>01422     <span class="keywordflow">if</span> (ms != NULL)
<a name="l01423"></a>01423         magic_close(ms);
<a name="l01424"></a>01424 
<a name="l01425"></a>01425     <span class="keywordflow">return</span> 0;
<a name="l01426"></a>01426 }
<a name="l01427"></a>01427 
<a name="l01430"></a><a class="code" href="rpmfc_8c.html#5d1a2f1bfba5bd041b90f1f94e489aba">01430</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structDepMsg__s.html">DepMsg_s</a> * <a class="code" href="structDepMsg__s.html">DepMsg_t</a>;
<a name="l01431"></a>01431 
<a name="l01434"></a><a class="code" href="structDepMsg__s.html">01434</a> <span class="keyword">struct </span><a class="code" href="structDepMsg__s.html">DepMsg_s</a> {
<a name="l01435"></a>01435 <span class="comment">/*@observer@*/</span> <span class="comment">/*@null@*/</span>
<a name="l01436"></a><a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">01436</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a>;
<a name="l01437"></a>01437 <span class="comment">/*@observer@*/</span>
<a name="l01438"></a><a class="code" href="structDepMsg__s.html#b26dd17ce0365058832e8f098bdb99a5">01438</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structDepMsg__s.html#b26dd17ce0365058832e8f098bdb99a5">argv</a>[4];
<a name="l01439"></a><a class="code" href="structDepMsg__s.html#72ac0193c75d6d9292d15ec31c5ad63b">01439</a>     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> <a class="code" href="structDepMsg__s.html#72ac0193c75d6d9292d15ec31c5ad63b">ntag</a>;
<a name="l01440"></a><a class="code" href="structDepMsg__s.html#638d4b39b57da892dcab32481f2faecf">01440</a>     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> <a class="code" href="structDepMsg__s.html#638d4b39b57da892dcab32481f2faecf">vtag</a>;
<a name="l01441"></a><a class="code" href="structDepMsg__s.html#e24a2ff9f11a0b3cc01384660e301cde">01441</a>     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> <a class="code" href="structDepMsg__s.html#e24a2ff9f11a0b3cc01384660e301cde">ftag</a>;
<a name="l01442"></a><a class="code" href="structDepMsg__s.html#bf1c2d8b79049d41606995ea513a1962">01442</a>     <span class="keywordtype">int</span> <a class="code" href="structDepMsg__s.html#bf1c2d8b79049d41606995ea513a1962">mask</a>;
<a name="l01443"></a><a class="code" href="structDepMsg__s.html#8cdfc09051fc92e689428c8f858e5507">01443</a>     <span class="keywordtype">int</span> <a class="code" href="structDepMsg__s.html#8cdfc09051fc92e689428c8f858e5507">xor</a>;
<a name="l01444"></a>01444 };
<a name="l01445"></a>01445 
<a name="l01448"></a>01448 <span class="comment">/*@unchecked@*/</span>
<a name="l01449"></a><a class="code" href="rpmfc_8c.html#2bac19c0544ca69663ec0a50727b821f">01449</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structDepMsg__s.html">DepMsg_s</a> <a class="code" href="rpmfc_8c.html#2bac19c0544ca69663ec0a50727b821f">depMsgs</a>[] = {
<a name="l01450"></a>01450   { <span class="stringliteral">"Provides"</span>,         { <span class="stringliteral">"%{?__find_provides}"</span>, NULL, NULL, NULL },
<a name="l01451"></a>01451         <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>,
<a name="l01452"></a>01452         0, -1 },
<a name="l01453"></a>01453 <span class="preprocessor">#ifdef  DYING</span>
<a name="l01454"></a>01454 <span class="preprocessor"></span>  { <span class="stringliteral">"PreReq"</span>,           { NULL, NULL, NULL, NULL },
<a name="l01455"></a>01455         <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910b5bfa4be0f375cd3d8f6e778a7827ef">RPMTAG_REQUIREVERSION</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01456"></a>01456         <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095fb0834643e81a8f0c9859fb173361f3d">RPMSENSE_PREREQ</a>, 0 },
<a name="l01457"></a>01457   { <span class="stringliteral">"Requires(interp)"</span>, { NULL, <span class="stringliteral">"interp"</span>, NULL, NULL },
<a name="l01458"></a>01458         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01459"></a>01459         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095437a1f60dc287c4799619404458b0cc1">RPMSENSE_INTERP</a>), 0 },
<a name="l01460"></a>01460 <span class="preprocessor">#else</span>
<a name="l01461"></a>01461 <span class="preprocessor"></span>  { <span class="stringliteral">"Requires(interp)"</span>, { NULL, <span class="stringliteral">"interp"</span>, NULL, NULL },
<a name="l01462"></a>01462         <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910b5bfa4be0f375cd3d8f6e778a7827ef">RPMTAG_REQUIREVERSION</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01463"></a>01463         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095437a1f60dc287c4799619404458b0cc1">RPMSENSE_INTERP</a>), 0 },
<a name="l01464"></a>01464 <span class="preprocessor">#endif</span>
<a name="l01465"></a>01465 <span class="preprocessor"></span>  { <span class="stringliteral">"Requires(rpmlib)"</span>, { NULL, <span class="stringliteral">"rpmlib"</span>, NULL, NULL },
<a name="l01466"></a>01466         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01467"></a>01467         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095885ce24fb4e9a92be55275f533362f76">RPMSENSE_RPMLIB</a>), 0 },
<a name="l01468"></a>01468   { <span class="stringliteral">"Requires(verify)"</span>, { NULL, <span class="stringliteral">"verify"</span>, NULL, NULL },
<a name="l01469"></a>01469         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01470"></a>01470         <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270952a8ae6e71283ee2963de18d4f9afa08f">RPMSENSE_SCRIPT_VERIFY</a>, 0 },
<a name="l01471"></a>01471   { <span class="stringliteral">"Requires(pre)"</span>,    { NULL, <span class="stringliteral">"pre"</span>, NULL, NULL },
<a name="l01472"></a>01472         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01473"></a>01473         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095fb1591704e0e310209b112ed60bcedf4">RPMSENSE_SCRIPT_PRE</a>), 0 },
<a name="l01474"></a>01474   { <span class="stringliteral">"Requires(post)"</span>,   { NULL, <span class="stringliteral">"post"</span>, NULL, NULL },
<a name="l01475"></a>01475         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01476"></a>01476         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b2709521ea0f711a1905522e450b1be7d72617">RPMSENSE_SCRIPT_POST</a>), 0 },
<a name="l01477"></a>01477   { <span class="stringliteral">"Requires(preun)"</span>,  { NULL, <span class="stringliteral">"preun"</span>, NULL, NULL },
<a name="l01478"></a>01478         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01479"></a>01479         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095a9dcfed7db2fe22892e2669eca9cea19">RPMSENSE_SCRIPT_PREUN</a>), 0 },
<a name="l01480"></a>01480   { <span class="stringliteral">"Requires(postun)"</span>, { NULL, <span class="stringliteral">"postun"</span>, NULL, NULL },
<a name="l01481"></a>01481         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,
<a name="l01482"></a>01482         <a class="code" href="rpmlib_8h.html#01da23cb38f79fac9b738d55bc0805d2">_notpre</a>(<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270959ab8b382fc5c2abc49b898e83be59c72">RPMSENSE_SCRIPT_POSTUN</a>), 0 },
<a name="l01483"></a>01483   { <span class="stringliteral">"Requires"</span>,         { <span class="stringliteral">"%{?__find_requires}"</span>, NULL, NULL, NULL },
<a name="l01484"></a>01484         -1, -1, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>,    <span class="comment">/* XXX inherit name/version arrays */</span>
<a name="l01485"></a>01485         <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095fb0834643e81a8f0c9859fb173361f3d">RPMSENSE_PREREQ</a>, RPMSENSE_PREREQ },
<a name="l01486"></a>01486   { <span class="stringliteral">"Conflicts"</span>,        { <span class="stringliteral">"%{?__find_conflicts}"</span>, NULL, NULL, NULL },
<a name="l01487"></a>01487         <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591ff092fdc32a41f427c85147b5d398f01">RPMTAG_CONFLICTNAME</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910c673289c984893c8faa002c61738b25">RPMTAG_CONFLICTVERSION</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335916eaf5be45f3dc264b228280e42e0208a">RPMTAG_CONFLICTFLAGS</a>,
<a name="l01488"></a>01488         0, -1 },
<a name="l01489"></a>01489   { <span class="stringliteral">"Obsoletes"</span>,        { <span class="stringliteral">"%{?__find_obsoletes}"</span>, NULL, NULL, NULL },
<a name="l01490"></a>01490         <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591b4aea8941447979f094490786cd123f2">RPMTAG_OBSOLETENAME</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335919ce8eb8b8d020404a89c143702b1d0f2">RPMTAG_OBSOLETEVERSION</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910530bb31e4ac82ce3420877ae4d804da">RPMTAG_OBSOLETEFLAGS</a>,
<a name="l01491"></a>01491         0, -1 },
<a name="l01492"></a>01492   { NULL,               { NULL, NULL, NULL, NULL },     0, 0, 0, 0, 0 }
<a name="l01493"></a>01493 };
<a name="l01494"></a>01494 
<a name="l01495"></a>01495 <span class="comment">/*@unchecked@*/</span>
<a name="l01496"></a><a class="code" href="rpmfc_8c.html#c952ac5896c827d383e12685e94f6101">01496</a> <span class="keyword">static</span> <a class="code" href="rpmfc_8c.html#5d1a2f1bfba5bd041b90f1f94e489aba">DepMsg_t</a> <a class="code" href="rpmfc_8c.html#c952ac5896c827d383e12685e94f6101">DepMsgs</a> = <a class="code" href="rpmfc_8c.html#2bac19c0544ca69663ec0a50727b821f">depMsgs</a>;
<a name="l01497"></a>01497 
<a name="l01500"></a><a class="code" href="rpmfc_8c.html#80d241bd8450ddafcd821b5930ab9cfd">01500</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rpmfc_8c.html#80d241bd8450ddafcd821b5930ab9cfd">printDeps</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h)
<a name="l01501"></a>01501         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l01502"></a>01502         <span class="comment">/*@modifies h, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l01503"></a>01503 {
<a name="l01504"></a>01504     <a class="code" href="rpmfc_8c.html#5d1a2f1bfba5bd041b90f1f94e489aba">DepMsg_t</a> dm;
<a name="l01505"></a>01505     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds = NULL;
<a name="l01506"></a>01506     <span class="keywordtype">int</span> flags = 0x2;    <span class="comment">/* XXX no filtering, !scareMem */</span>
<a name="l01507"></a>01507     <span class="keyword">const</span> <span class="keywordtype">char</span> * DNEVR;
<a name="l01508"></a>01508     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> Flags;
<a name="l01509"></a>01509     <span class="keywordtype">int</span> bingo = 0;
<a name="l01510"></a>01510 
<a name="l01511"></a>01511     <span class="keywordflow">for</span> (dm = <a class="code" href="rpmfc_8c.html#c952ac5896c827d383e12685e94f6101">DepMsgs</a>; dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a> != NULL; dm++) {
<a name="l01512"></a>01512         <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="structDepMsg__s.html#72ac0193c75d6d9292d15ec31c5ad63b">ntag</a> != -1) {
<a name="l01513"></a>01513             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01514"></a>01514             ds = <a class="code" href="rpmds_8c.html#7f4d44e2c0882dd14ea4831b9c5b09f8" title="Create and load a dependency set.">rpmdsNew</a>(h, dm-&gt;<a class="code" href="structDepMsg__s.html#72ac0193c75d6d9292d15ec31c5ad63b">ntag</a>, flags);
<a name="l01515"></a>01515         }
<a name="l01516"></a>01516         <span class="keywordflow">if</span> (dm-&gt;<a class="code" href="structDepMsg__s.html#e24a2ff9f11a0b3cc01384660e301cde">ftag</a> == 0)
<a name="l01517"></a>01517             <span class="keywordflow">continue</span>;
<a name="l01518"></a>01518 
<a name="l01519"></a>01519         ds = <a class="code" href="rpmds_8c.html#9c00e325e03679279e436bd010ee3b6a" title="Initialize dependency set iterator.">rpmdsInit</a>(ds);
<a name="l01520"></a>01520         <span class="keywordflow">if</span> (ds == NULL)
<a name="l01521"></a>01521             <span class="keywordflow">continue</span>;   <span class="comment">/* XXX can't happen */</span>
<a name="l01522"></a>01522 
<a name="l01523"></a>01523         bingo = 0;
<a name="l01524"></a>01524         <span class="keywordflow">while</span> (<a class="code" href="rpmds_8c.html#e2b07afdbac562e3f1445fc0dd9bd77c" title="Return next dependency set iterator index.">rpmdsNext</a>(ds) &gt;= 0) {
<a name="l01525"></a>01525 
<a name="l01526"></a>01526             Flags = <a class="code" href="rpmds_8c.html#012c824694e1c625b6880a4f8da88ce6" title="Return current dependency flags.">rpmdsFlags</a>(ds);
<a name="l01527"></a>01527         
<a name="l01528"></a>01528             <span class="keywordflow">if</span> (!((Flags &amp; dm-&gt;<a class="code" href="structDepMsg__s.html#bf1c2d8b79049d41606995ea513a1962">mask</a>) ^ dm-&gt;<a class="code" href="structDepMsg__s.html#8cdfc09051fc92e689428c8f858e5507">xor</a>))
<a name="l01529"></a>01529                 <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01530"></a>01530             <span class="keywordflow">if</span> (bingo == 0) {
<a name="l01531"></a>01531                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <span class="stringliteral">"%s:"</span>, (dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a> ? dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a> : <span class="stringliteral">""</span>));
<a name="l01532"></a>01532                 bingo = 1;
<a name="l01533"></a>01533             }
<a name="l01534"></a>01534             <span class="keywordflow">if</span> ((DNEVR = <a class="code" href="rpmds_8c.html#469513a3255575fe259677606a7feffb" title="Return current formatted dependency string.">rpmdsDNEVR</a>(ds)) == NULL)
<a name="l01535"></a>01535                 <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;   <span class="comment">/* XXX can't happen */</span>
<a name="l01536"></a>01536             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <span class="stringliteral">" %s"</span>, DNEVR+2);
<a name="l01537"></a>01537         }
<a name="l01538"></a>01538         <span class="keywordflow">if</span> (bingo)
<a name="l01539"></a>01539             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <span class="stringliteral">"\n"</span>);
<a name="l01540"></a>01540     }
<a name="l01541"></a>01541     ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01542"></a>01542 }
<a name="l01543"></a>01543 
<a name="l01546"></a><a class="code" href="rpmfc_8c.html#3af1392786b392e53ab69774f333f0c6">01546</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#3af1392786b392e53ab69774f333f0c6">rpmfcGenerateDependsHelper</a>(<span class="keyword">const</span> <a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec, <a class="code" href="structPackage__s.html" title="The structure used to store values for a package.">Package</a> pkg, <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi)
<a name="l01547"></a>01547         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l01548"></a>01548         <span class="comment">/*@modifies fi, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l01549"></a>01549 {
<a name="l01550"></a>01550     <a class="code" href="structStringBufRec.html">StringBuf</a> sb_stdin;
<a name="l01551"></a>01551     <a class="code" href="structStringBufRec.html">StringBuf</a> sb_stdout;
<a name="l01552"></a>01552     <a class="code" href="structDepMsg__s.html">DepMsg_t</a> dm;
<a name="l01553"></a>01553     <span class="keywordtype">int</span> failnonzero = 0;
<a name="l01554"></a>01554     <span class="keywordtype">int</span> rc = 0;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556     <span class="comment">/*</span>
<a name="l01557"></a>01557 <span class="comment">     * Create file manifest buffer to deliver to dependency finder.</span>
<a name="l01558"></a>01558 <span class="comment">     */</span>
<a name="l01559"></a>01559     sb_stdin = <a class="code" href="stringbuf_8c.html#7597277ee043fedfe21a058b32c08e0d">newStringBuf</a>();
<a name="l01560"></a>01560     fi = <a class="code" href="rpmfi_8c.html#3e9bb5cb07bf98264190ef67dbc88973" title="Initialize file iterator index.">rpmfiInit</a>(fi, 0);
<a name="l01561"></a>01561     <span class="keywordflow">if</span> (fi != NULL)
<a name="l01562"></a>01562     <span class="keywordflow">while</span> (<a class="code" href="rpmfi_8c.html#f091d4c79bd7708322bc798e1db1160b" title="Return next file iterator index.">rpmfiNext</a>(fi) &gt;= 0)
<a name="l01563"></a>01563         <a class="code" href="stringbuf_8h.html#ece7923b4b1b19fdc5b99ec7a8856360">appendLineStringBuf</a>(sb_stdin, <a class="code" href="rpmfi_8c.html#f6262c3acd5122d1d73a81da25044bde" title="Return current file name from file info set.">rpmfiFN</a>(fi));
<a name="l01564"></a>01564 
<a name="l01565"></a>01565     <span class="keywordflow">for</span> (dm = <a class="code" href="rpmfc_8c.html#c952ac5896c827d383e12685e94f6101">DepMsgs</a>; dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a> != NULL; dm++) {
<a name="l01566"></a>01566         <span class="keywordtype">int</span> tag, tagflags;
<a name="l01567"></a>01567         <span class="keywordtype">char</span> * s;
<a name="l01568"></a>01568         <span class="keywordtype">int</span> xx;
<a name="l01569"></a>01569 
<a name="l01570"></a>01570         tag = (dm-&gt;<a class="code" href="structDepMsg__s.html#e24a2ff9f11a0b3cc01384660e301cde">ftag</a> &gt; 0) ? dm-&gt;<a class="code" href="structDepMsg__s.html#e24a2ff9f11a0b3cc01384660e301cde">ftag</a> : dm-&gt;<a class="code" href="structDepMsg__s.html#72ac0193c75d6d9292d15ec31c5ad63b">ntag</a>;
<a name="l01571"></a>01571         tagflags = 0;
<a name="l01572"></a>01572         s = NULL;
<a name="l01573"></a>01573 
<a name="l01574"></a>01574         <span class="keywordflow">switch</span>(tag) {
<a name="l01575"></a>01575         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>:
<a name="l01576"></a>01576             if (!pkg-&gt;<a class="code" href="structPackage__s.html#6e5a9a8c2f50bcf63577bde592887525">autoProv</a>)
<a name="l01577"></a>01577                 <span class="keywordflow">continue</span>;
<a name="l01578"></a>01578             failnonzero = 1;
<a name="l01579"></a>01579             tagflags = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095dbd5b2fcf70d1ef8863e13c9b8fe9da2">RPMSENSE_FIND_PROVIDES</a>;
<a name="l01580"></a>01580             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01581"></a>01581         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>:
<a name="l01582"></a>01582             if (!pkg-&gt;<a class="code" href="structPackage__s.html#e2a33ee5b7d6e7999205ee82a5d4a6fc">autoReq</a>)
<a name="l01583"></a>01583                 <span class="keywordflow">continue</span>;
<a name="l01584"></a>01584             failnonzero = 0;
<a name="l01585"></a>01585             tagflags = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095f5339d17b0a1f1febaa9a85a824e2012">RPMSENSE_FIND_REQUIRES</a>;
<a name="l01586"></a>01586             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01587"></a>01587         <span class="keywordflow">default</span>:
<a name="l01588"></a>01588             <span class="keywordflow">continue</span>;
<a name="l01589"></a>01589             <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01590"></a>01590         }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01593"></a>01593         xx = <a class="code" href="rpmfc_8c.html#a52c84c0e2191ee7f37e8e97171fdd97" title="Return helper output.">rpmfcExec</a>(dm-&gt;<a class="code" href="structDepMsg__s.html#b26dd17ce0365058832e8f098bdb99a5">argv</a>, sb_stdin, &amp;sb_stdout, failnonzero);
<a name="l01594"></a>01594 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01595"></a>01595         <span class="keywordflow">if</span> (xx == -1)
<a name="l01596"></a>01596             <span class="keywordflow">continue</span>;
<a name="l01597"></a>01597 
<a name="l01598"></a>01598         s = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(dm-&gt;<a class="code" href="structDepMsg__s.html#b26dd17ce0365058832e8f098bdb99a5">argv</a>[0], NULL);
<a name="l01599"></a>01599         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#60521ccf51c65929828788d73762004f">RPMMESS_NORMAL</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Finding  %s: %s\n"</span>), dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a>,
<a name="l01600"></a>01600                 (s ? s : <span class="stringliteral">""</span>));
<a name="l01601"></a>01601         s = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(s);
<a name="l01602"></a>01602 
<a name="l01603"></a>01603         <span class="keywordflow">if</span> (sb_stdout == NULL) {
<a name="l01604"></a>01604             rc = <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba04e9635da8a50be2fd81370b134f4f83">RPMERR_EXEC</a>;
<a name="l01605"></a>01605             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(rc, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Failed to find %s:\n"</span>), dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a>);
<a name="l01606"></a>01606             <span class="keywordflow">break</span>;
<a name="l01607"></a>01607         }
<a name="l01608"></a>01608 
<a name="l01609"></a>01609         <span class="comment">/* Parse dependencies into header */</span>
<a name="l01610"></a>01610         rc = <a class="code" href="group__rpmbuild.html#ga3bab230780101f25a02c435f08b87ba" title="Parse dependency relations from spec file and/or autogenerated output buffer.">parseRCPOT</a>(spec, pkg, <a class="code" href="stringbuf_8c.html#fa51085c621ad9b0abc05c629a826440">getStringBuf</a>(sb_stdout), tag, 0, tagflags);
<a name="l01611"></a>01611         sb_stdout = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb_stdout);
<a name="l01612"></a>01612 
<a name="l01613"></a>01613         <span class="keywordflow">if</span> (rc) {
<a name="l01614"></a>01614             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(rc, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Failed to find %s:\n"</span>), dm-&gt;<a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a>);
<a name="l01615"></a>01615             <span class="keywordflow">break</span>;
<a name="l01616"></a>01616         }
<a name="l01617"></a>01617     }
<a name="l01618"></a>01618 
<a name="l01619"></a>01619     sb_stdin = <a class="code" href="stringbuf_8c.html#567493f29b7cd54c9df0598612a45511">freeStringBuf</a>(sb_stdin);
<a name="l01620"></a>01620 
<a name="l01621"></a>01621     <span class="keywordflow">return</span> rc;
<a name="l01622"></a>01622 }
<a name="l01623"></a>01623 
<a name="l01624"></a><a class="code" href="rpmfc_8h.html#cbe2832944bf644539d7bb73eca930a4">01624</a> <span class="keywordtype">int</span> <a class="code" href="rpmfc_8c.html#cbe2832944bf644539d7bb73eca930a4" title="Generate package dependencies.">rpmfcGenerateDepends</a>(<span class="keyword">const</span> <a class="code" href="structSpec__s.html" title="The structure used to store values parsed from a spec file.">Spec</a> spec, <a class="code" href="structPackage__s.html" title="The structure used to store values for a package.">Package</a> pkg)
<a name="l01625"></a>01625 {
<a name="l01626"></a>01626     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = pkg-&gt;<a class="code" href="structPackage__s.html#22895a51d58ee7526cb78e88653726c0">cpioList</a>;
<a name="l01627"></a>01627     <a class="code" href="structrpmfc__s.html">rpmfc</a> fc = NULL;
<a name="l01628"></a>01628     <a class="code" href="rpmlib_8h.html#5fc71e97b294a4217519cef21eb6d837" title="Dependency tag sets from a header, so that a header can be discarded early.">rpmds</a> ds;
<a name="l01629"></a>01629     <span class="keywordtype">int</span> flags = 0x2;    <span class="comment">/* XXX no filtering, !scareMem */</span>
<a name="l01630"></a>01630     <a class="code" href="argv_8h.html#854f868964d07862a6aae60deffe92a1">ARGV_t</a> av;
<a name="l01631"></a>01631     <a class="code" href="header_8h.html#b6a208567758c1b3a414d16609a553e6">int_16</a> * fmode;
<a name="l01632"></a>01632     <span class="keywordtype">int</span> ac = <a class="code" href="rpmfi_8c.html#0a43c555ff11e3bf78bd31830c2baafd" title="Return file count from file info set.">rpmfiFC</a>(fi);
<a name="l01633"></a>01633     <span class="keyword">const</span> <span class="keywordtype">void</span> ** p;
<a name="l01634"></a>01634     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l01635"></a>01635     <span class="keyword">const</span> <span class="keywordtype">char</span> * N;
<a name="l01636"></a>01636     <span class="keyword">const</span> <span class="keywordtype">char</span> * EVR;
<a name="l01637"></a>01637     <span class="keywordtype">int</span> genConfigDeps;
<a name="l01638"></a>01638     <span class="keywordtype">int</span> c;
<a name="l01639"></a>01639     <span class="keywordtype">int</span> rc = 0;
<a name="l01640"></a>01640     <span class="keywordtype">int</span> xx;
<a name="l01641"></a>01641 
<a name="l01642"></a>01642     <span class="comment">/* Skip packages with no files. */</span>
<a name="l01643"></a>01643     <span class="keywordflow">if</span> (ac &lt;= 0)
<a name="l01644"></a>01644         <span class="keywordflow">return</span> 0;
<a name="l01645"></a>01645 
<a name="l01646"></a>01646     <span class="comment">/* Skip packages that have dependency generation disabled. */</span>
<a name="l01647"></a>01647     <span class="keywordflow">if</span> (! (pkg-&gt;<a class="code" href="structPackage__s.html#e2a33ee5b7d6e7999205ee82a5d4a6fc">autoReq</a> || pkg-&gt;<a class="code" href="structPackage__s.html#6e5a9a8c2f50bcf63577bde592887525">autoProv</a>))
<a name="l01648"></a>01648         <span class="keywordflow">return</span> 0;
<a name="l01649"></a>01649 
<a name="l01650"></a>01650     <span class="comment">/* If new-fangled dependency generation is disabled ... */</span>
<a name="l01651"></a>01651     <span class="keywordflow">if</span> (!<a class="code" href="macro_8c.html#2e43f3dd86c8e646243de9f051f36f6a" title="Return macro expansion as a numeric value.">rpmExpandNumeric</a>(<span class="stringliteral">"%{?_use_internal_dependency_generator}"</span>)) {
<a name="l01652"></a>01652         <span class="comment">/* ... then generate dependencies using %{__find_requires} et al. */</span>
<a name="l01653"></a>01653         rc = <a class="code" href="rpmfc_8c.html#3af1392786b392e53ab69774f333f0c6">rpmfcGenerateDependsHelper</a>(spec, pkg, fi);
<a name="l01654"></a>01654         <a class="code" href="rpmfc_8c.html#80d241bd8450ddafcd821b5930ab9cfd">printDeps</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>);
<a name="l01655"></a>01655         <span class="keywordflow">return</span> rc;
<a name="l01656"></a>01656     }
<a name="l01657"></a>01657 
<a name="l01658"></a>01658     <span class="comment">/* Extract absolute file paths in argv format. */</span>
<a name="l01659"></a>01659     av = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(ac+1, <span class="keyword">sizeof</span>(*av));
<a name="l01660"></a>01660     fmode = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(ac+1, <span class="keyword">sizeof</span>(*fmode));
<a name="l01661"></a>01661 
<a name="l01662"></a>01662 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01663"></a>01663     genConfigDeps = 0;
<a name="l01664"></a>01664     fi = <a class="code" href="rpmfi_8c.html#3e9bb5cb07bf98264190ef67dbc88973" title="Initialize file iterator index.">rpmfiInit</a>(fi, 0);
<a name="l01665"></a>01665     <span class="keywordflow">if</span> (fi != NULL)
<a name="l01666"></a>01666     <span class="keywordflow">while</span> ((c = <a class="code" href="rpmfi_8c.html#f091d4c79bd7708322bc798e1db1160b" title="Return next file iterator index.">rpmfiNext</a>(fi)) &gt;= 0) {
<a name="l01667"></a>01667         <a class="code" href="rpmlib_8h.html#42e3d1e008de3a88813533b101cc9649" title="File Attributes.">rpmfileAttrs</a> fileAttrs;
<a name="l01668"></a>01668 
<a name="l01669"></a>01669         <span class="comment">/* Does package have any %config files? */</span>
<a name="l01670"></a>01670         fileAttrs = <a class="code" href="rpmfi_8c.html#f1595e307312796aa9baff1862877b98" title="Return current file flags from file info set.">rpmfiFFlags</a>(fi);
<a name="l01671"></a>01671         genConfigDeps |= (fileAttrs &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df630defccf24ceaa0c28114df156bc7b891">RPMFILE_CONFIG</a>);
<a name="l01672"></a>01672 
<a name="l01673"></a>01673         av[c] = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(<a class="code" href="rpmfi_8c.html#f6262c3acd5122d1d73a81da25044bde" title="Return current file name from file info set.">rpmfiFN</a>(fi));
<a name="l01674"></a>01674         fmode[c] = <a class="code" href="rpmfi_8c.html#67eaa88c525f6ab4fa6bd2abb2176334" title="Return current file mode from file info set.">rpmfiFMode</a>(fi);
<a name="l01675"></a>01675     }
<a name="l01676"></a>01676     av[ac] = NULL;
<a name="l01677"></a>01677 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     fc = <a class="code" href="rpmfc_8c.html#7e13b4f31e457a3b79cb94049d410d7c" title="Create a file classifier.">rpmfcNew</a>();
<a name="l01680"></a>01680     fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a> = !pkg-&gt;<a class="code" href="structPackage__s.html#6e5a9a8c2f50bcf63577bde592887525">autoProv</a>;
<a name="l01681"></a>01681     fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a> = !pkg-&gt;<a class="code" href="structPackage__s.html#e2a33ee5b7d6e7999205ee82a5d4a6fc">autoReq</a>;
<a name="l01682"></a>01682     fc-&gt;<a class="code" href="structrpmfc__s.html#1ca96220f7dc2095036bca6fc7a7cbbf">tracked</a> = 0;
<a name="l01683"></a>01683     fc-&gt;<a class="code" href="structrpmfc__s.html#cc235f964bff2dafba3ce858851346fb">brlen</a> = (spec-&gt;<a class="code" href="structSpec__s.html#e5e372fa94803e9d0ca3a75b74925f6f">buildRootURL</a> ? strlen(spec-&gt;<a class="code" href="structSpec__s.html#e5e372fa94803e9d0ca3a75b74925f6f">buildRootURL</a>) : 0);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685     <span class="comment">/* Copy (and delete) manually generated dependencies to dictionary. */</span>
<a name="l01686"></a>01686     <span class="keywordflow">if</span> (!fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a>) {
<a name="l01687"></a>01687         ds = <a class="code" href="rpmds_8c.html#7f4d44e2c0882dd14ea4831b9c5b09f8" title="Create and load a dependency set.">rpmdsNew</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, flags);
<a name="l01688"></a>01688         xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>, ds);
<a name="l01689"></a>01689         ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01690"></a>01690         xx = <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>);
<a name="l01691"></a>01691         xx = <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>);
<a name="l01692"></a>01692         xx = <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>);
<a name="l01693"></a>01693 
<a name="l01694"></a>01694         <span class="comment">/* Add config dependency, Provides: config(N) = EVR */</span>
<a name="l01695"></a>01695         <span class="keywordflow">if</span> (genConfigDeps) {
<a name="l01696"></a>01696             N = <a class="code" href="rpmds_8c.html#5dbfffb989198fcbaca885d946f0aa51" title="Return current dependency name.">rpmdsN</a>(pkg-&gt;<a class="code" href="structPackage__s.html#fac4777e99424dd25fe8ba062cf66026">ds</a>);
<a name="l01697"></a>01697 assert(N != NULL);
<a name="l01698"></a>01698             EVR = <a class="code" href="rpmds_8c.html#1c898f2226abecb32b16e5b08bb776bb" title="Return current dependency epoch-version-release.">rpmdsEVR</a>(pkg-&gt;<a class="code" href="structPackage__s.html#fac4777e99424dd25fe8ba062cf66026">ds</a>);
<a name="l01699"></a>01699 assert(EVR != NULL);
<a name="l01700"></a>01700             sprintf(buf, <span class="stringliteral">"config(%s)"</span>, N);
<a name="l01701"></a>01701             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, buf, EVR,
<a name="l01702"></a>01702                         (<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a>|<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095a95c4e4edcf242c966bdfa0c34889bb4">RPMSENSE_CONFIG</a>));
<a name="l01703"></a>01703             xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>, ds);
<a name="l01704"></a>01704             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01705"></a>01705         }
<a name="l01706"></a>01706     }
<a name="l01707"></a>01707 
<a name="l01708"></a>01708     <span class="keywordflow">if</span> (!fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a>) {
<a name="l01709"></a>01709         ds = <a class="code" href="rpmds_8c.html#7f4d44e2c0882dd14ea4831b9c5b09f8" title="Create and load a dependency set.">rpmdsNew</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, flags);
<a name="l01710"></a>01710         xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l01711"></a>01711         ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01712"></a>01712         xx = <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>);
<a name="l01713"></a>01713         xx = <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910b5bfa4be0f375cd3d8f6e778a7827ef">RPMTAG_REQUIREVERSION</a>);
<a name="l01714"></a>01714         xx = <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>);
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         <span class="comment">/* Add config dependency,  Requires: config(N) = EVR */</span>
<a name="l01717"></a>01717         <span class="keywordflow">if</span> (genConfigDeps) {
<a name="l01718"></a>01718             N = <a class="code" href="rpmds_8c.html#5dbfffb989198fcbaca885d946f0aa51" title="Return current dependency name.">rpmdsN</a>(pkg-&gt;<a class="code" href="structPackage__s.html#fac4777e99424dd25fe8ba062cf66026">ds</a>);
<a name="l01719"></a>01719 assert(N != NULL);
<a name="l01720"></a>01720             EVR = <a class="code" href="rpmds_8c.html#1c898f2226abecb32b16e5b08bb776bb" title="Return current dependency epoch-version-release.">rpmdsEVR</a>(pkg-&gt;<a class="code" href="structPackage__s.html#fac4777e99424dd25fe8ba062cf66026">ds</a>);
<a name="l01721"></a>01721 assert(EVR != NULL);
<a name="l01722"></a>01722             sprintf(buf, <span class="stringliteral">"config(%s)"</span>, N);
<a name="l01723"></a>01723             ds = <a class="code" href="rpmds_8c.html#1f8e35b792f94715d6d4d9f1ff1368ed" title="Create, load and initialize a dependency set of size 1.">rpmdsSingle</a>(<a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, buf, EVR,
<a name="l01724"></a>01724                         (<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a>|<a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095a95c4e4edcf242c966bdfa0c34889bb4">RPMSENSE_CONFIG</a>));
<a name="l01725"></a>01725             xx = <a class="code" href="rpmds_8c.html#535a4e545ed3a54d6e342a1f84453afb" title="Merge a dependency set maintaining (N,EVR,Flags) sorted order.">rpmdsMerge</a>(&amp;fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>, ds);
<a name="l01726"></a>01726             ds = <a class="code" href="rpmds_8c.html#d4f6e653b9867dafe662f57cf08431f6" title="Destroy a dependency set.">rpmdsFree</a>(ds);
<a name="l01727"></a>01727         }
<a name="l01728"></a>01728     }
<a name="l01729"></a>01729 
<a name="l01730"></a>01730     <span class="comment">/* Build file class dictionary. */</span>
<a name="l01731"></a>01731     xx = <a class="code" href="rpmfc_8c.html#1d2f8f13da156a0f85921fd15e4bb9a8">rpmfcClassify</a>(fc, av, fmode);
<a name="l01732"></a>01732 
<a name="l01733"></a>01733     <span class="comment">/* Build file/package dependency dictionary. */</span>
<a name="l01734"></a>01734     xx = <a class="code" href="rpmfc_8c.html#ad428557e9ea4f79296dec422e737000" title="Build file/package dependency dictionary and mappings.">rpmfcApply</a>(fc);
<a name="l01735"></a>01735 
<a name="l01736"></a>01736     <span class="comment">/* Add per-file colors(#files) */</span>
<a name="l01737"></a>01737     p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) <a class="code" href="argv_8c.html#3372c7c0749bb34809eead1145a02f11" title="Return data from argi array.">argiData</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>);
<a name="l01738"></a>01738     c = <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#45e57c26cbae721e22cfb926330d67be">fcolor</a>);
<a name="l01739"></a>01739 assert(ac == c);
<a name="l01740"></a>01740     <span class="keywordflow">if</span> (p != NULL &amp;&amp; c &gt; 0) {
<a name="l01741"></a>01741         <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> * fcolors = (<a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> *)p;
<a name="l01742"></a>01742         <span class="keywordtype">int</span> i;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744         <span class="comment">/* XXX Make sure only primary (i.e. Elf32/Elf64) colors are added. */</span>
<a name="l01745"></a>01745         <span class="keywordflow">for</span> (i = 0; i &lt; c; i++)
<a name="l01746"></a>01746             fcolors[i] &amp;= 0x0f;
<a name="l01747"></a>01747         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591763a2ac0ce3831457fa6ad8e3deab546">RPMTAG_FILECOLORS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01748"></a>01748                         p, c);
<a name="l01749"></a>01749     }
<a name="l01750"></a>01750 
<a name="l01751"></a>01751     <span class="comment">/* Add classes(#classes) */</span>
<a name="l01752"></a>01752     p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) <a class="code" href="argv_8c.html#f4a073c2786cac43b239b9733eb15aeb" title="Return data from argv array.">argvData</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>);
<a name="l01753"></a>01753     c = <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>);
<a name="l01754"></a>01754     <span class="keywordflow">if</span> (p != NULL &amp;&amp; c &gt; 0)
<a name="l01755"></a>01755         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591547c232cb83a054577691133deea09bd">RPMTAG_CLASSDICT</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l01756"></a>01756                         p, c);
<a name="l01757"></a>01757 
<a name="l01758"></a>01758     <span class="comment">/* Add per-file classes(#files) */</span>
<a name="l01759"></a>01759     p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) <a class="code" href="argv_8c.html#3372c7c0749bb34809eead1145a02f11" title="Return data from argi array.">argiData</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a>);
<a name="l01760"></a>01760     c = <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#27f7af7b83a329a1c8b1a34a3be03cc4">fcdictx</a>);
<a name="l01761"></a>01761 assert(ac == c);
<a name="l01762"></a>01762     <span class="keywordflow">if</span> (p != NULL &amp;&amp; c &gt; 0)
<a name="l01763"></a>01763         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591b42b378a1c9fcf346b0b16805443247a">RPMTAG_FILECLASS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01764"></a>01764                         p, c);
<a name="l01765"></a>01765 
<a name="l01766"></a>01766     <span class="comment">/* Add Provides: */</span>
<a name="l01767"></a>01767 <span class="comment">/*@-branchstate@*/</span>
<a name="l01768"></a>01768     <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a> != NULL &amp;&amp; (c = <a class="code" href="rpmds_8c.html#bb7ace7e37397f7643d201b055997a87" title="Return dependency set count.">rpmdsCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>)) &gt; 0 &amp;&amp; !fc-&gt;<a class="code" href="structrpmfc__s.html#7b99f0209996084784ca043488ba9cb5">skipProv</a>) {
<a name="l01769"></a>01769         p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>-&gt;N;
<a name="l01770"></a>01770         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l01771"></a>01771                         p, c);
<a name="l01772"></a>01772         <span class="comment">/* XXX rpm prior to 3.0.2 did not always supply EVR and Flags. */</span>
<a name="l01773"></a>01773 <span class="comment">/*@-nullpass@*/</span>
<a name="l01774"></a>01774         p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>-&gt;EVR;
<a name="l01775"></a>01775 assert(p != NULL);
<a name="l01776"></a>01776         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l01777"></a>01777                         p, c);
<a name="l01778"></a>01778         p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) fc-&gt;<a class="code" href="structrpmfc__s.html#b35362e86660bb4d79dfce17a8954a90">provides</a>-&gt;Flags;
<a name="l01779"></a>01779 assert(p != NULL);
<a name="l01780"></a>01780         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01781"></a>01781                         p, c);
<a name="l01782"></a>01782 <span class="comment">/*@=nullpass@*/</span>
<a name="l01783"></a>01783     }
<a name="l01784"></a>01784 <span class="comment">/*@=branchstate@*/</span>
<a name="l01785"></a>01785 
<a name="l01786"></a>01786     <span class="comment">/* Add Requires: */</span>
<a name="l01787"></a>01787 <span class="comment">/*@-branchstate@*/</span>
<a name="l01788"></a>01788     <span class="keywordflow">if</span> (fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a> != NULL &amp;&amp; (c = <a class="code" href="rpmds_8c.html#bb7ace7e37397f7643d201b055997a87" title="Return dependency set count.">rpmdsCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>)) &gt; 0 &amp;&amp; !fc-&gt;<a class="code" href="structrpmfc__s.html#680ba5457a8839310a88d0dca63a5016">skipReq</a>) {
<a name="l01789"></a>01789         p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>-&gt;N;
<a name="l01790"></a>01790         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d5b9a70ce44f572f43dcf15ada5f4313">RPMTAG_REQUIRENAME</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l01791"></a>01791                         p, c);
<a name="l01792"></a>01792         <span class="comment">/* XXX rpm prior to 3.0.2 did not always supply EVR and Flags. */</span>
<a name="l01793"></a>01793 <span class="comment">/*@-nullpass@*/</span>
<a name="l01794"></a>01794         p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>-&gt;EVR;
<a name="l01795"></a>01795 assert(p != NULL);
<a name="l01796"></a>01796         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335910b5bfa4be0f375cd3d8f6e778a7827ef">RPMTAG_REQUIREVERSION</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l01797"></a>01797                         p, c);
<a name="l01798"></a>01798         p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) fc-&gt;<a class="code" href="structrpmfc__s.html#3b26f2458bef14b7c4cde26aae455fe6">requires</a>-&gt;Flags;
<a name="l01799"></a>01799 assert(p != NULL);
<a name="l01800"></a>01800         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591f764b8ea5b8eafbe12dcfff1d303c8e9">RPMTAG_REQUIREFLAGS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01801"></a>01801                         p, c);
<a name="l01802"></a>01802 <span class="comment">/*@=nullpass@*/</span>
<a name="l01803"></a>01803     }
<a name="l01804"></a>01804 <span class="comment">/*@=branchstate@*/</span>
<a name="l01805"></a>01805 
<a name="l01806"></a>01806     <span class="comment">/* Add dependency dictionary(#dependencies) */</span>
<a name="l01807"></a>01807     p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) <a class="code" href="argv_8c.html#3372c7c0749bb34809eead1145a02f11" title="Return data from argi array.">argiData</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>);
<a name="l01808"></a>01808     c = <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>);
<a name="l01809"></a>01809     <span class="keywordflow">if</span> (p != NULL)
<a name="l01810"></a>01810         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359135b64744cae2bc4ab8352df4e7dc6c8c">RPMTAG_DEPENDSDICT</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01811"></a>01811                         p, c);
<a name="l01812"></a>01812 
<a name="l01813"></a>01813     <span class="comment">/* Add per-file dependency (start,number) pairs (#files) */</span>
<a name="l01814"></a>01814     p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) <a class="code" href="argv_8c.html#3372c7c0749bb34809eead1145a02f11" title="Return data from argi array.">argiData</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a>);
<a name="l01815"></a>01815     c = <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9fa6e74c916bf8efafa47cb2e5d3cc44">fddictx</a>);
<a name="l01816"></a>01816 assert(ac == c);
<a name="l01817"></a>01817     <span class="keywordflow">if</span> (p != NULL)
<a name="l01818"></a>01818         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335911799c437fd464a06d99477b8f51531c0">RPMTAG_FILEDEPENDSX</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01819"></a>01819                         p, c);
<a name="l01820"></a>01820 
<a name="l01821"></a>01821     p = (<span class="keyword">const</span> <span class="keywordtype">void</span> **) <a class="code" href="argv_8c.html#3372c7c0749bb34809eead1145a02f11" title="Return data from argi array.">argiData</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>);
<a name="l01822"></a>01822     c = <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#221f99d744b651a36612ae5d93ba65f6">fddictn</a>);
<a name="l01823"></a>01823 assert(ac == c);
<a name="l01824"></a>01824     <span class="keywordflow">if</span> (p != NULL)
<a name="l01825"></a>01825         xx = <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591c9f4a68c380f16c01ae00eccd8e18bf5">RPMTAG_FILEDEPENDSN</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l01826"></a>01826                         p, c);
<a name="l01827"></a>01827 
<a name="l01828"></a>01828     <a class="code" href="rpmfc_8c.html#80d241bd8450ddafcd821b5930ab9cfd">printDeps</a>(pkg-&gt;<a class="code" href="structPackage__s.html#57b7df476d0d3dfa63453ea5c460ca20">header</a>);
<a name="l01829"></a>01829 
<a name="l01830"></a>01830 <span class="keywordflow">if</span> (fc != NULL &amp;&amp; <a class="code" href="rpmfc_8h.html#608c14cadb7aa2256b7f0577df313971">_rpmfc_debug</a>) {
<a name="l01831"></a>01831 <span class="keywordtype">char</span> <a class="code" href="structDepMsg__s.html#e5bb6f082434c6bbc36acf81c1f95b81">msg</a>[BUFSIZ];
<a name="l01832"></a>01832 sprintf(msg, <span class="stringliteral">"final: files %d cdict[%d] %d%% ddictx[%d]"</span>, fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>, <a class="code" href="argv_8c.html#6fb0ea246204fd99dcc203b3aa598bca" title="Return no.">argvCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#9b32ff7da9a50979bf7593a75e612824">cdict</a>), ((100 * fc-&gt;<a class="code" href="structrpmfc__s.html#669d14f9a2d946da731544851cbdc1fc">fknown</a>)/fc-&gt;<a class="code" href="structrpmfc__s.html#cbe4230ab3550616d48cf578650e9132">nfiles</a>), <a class="code" href="argv_8c.html#3c3622abedf0f31779483bcaa0dcfa52" title="Return no.">argiCount</a>(fc-&gt;<a class="code" href="structrpmfc__s.html#7ab7f03a0aa56da051be5d5bc755e5d6">ddictx</a>));
<a name="l01833"></a>01833 <a class="code" href="rpmfc_8c.html#1590ab56e344f35ffc8804e6cc2fd267" title="Print results of file classification.">rpmfcPrint</a>(msg, fc, NULL);
<a name="l01834"></a>01834 }
<a name="l01835"></a>01835 
<a name="l01836"></a>01836     <span class="comment">/* Clean up. */</span>
<a name="l01837"></a>01837     fmode = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fmode);
<a name="l01838"></a>01838     fc = <a class="code" href="rpmfc_8c.html#7e5626c2f41e6cdf4ab167e90586f260" title="Destroy a file classifier.">rpmfcFree</a>(fc);
<a name="l01839"></a>01839     av = <a class="code" href="argv_8c.html#12855d8df0add9f458925a9fc4326a29" title="Destroy an argv array.">argvFree</a>(av);
<a name="l01840"></a>01840 
<a name="l01841"></a>01841     <span class="keywordflow">return</span> rc;
<a name="l01842"></a>01842 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:53 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
