<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: Package format</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<h1><a class="anchor" name="pkgformat">Package format</a></h1>This document describes the RPM file format version 3.0, which is used by RPM versions 2.1 and greater. The format is subject to change, and you should not assume that this document is kept up to date with the latest RPM code. That said, the 3.0 format should not change for quite a while, and when it does, it will not be 3.0 anymore :-).<p>
<dl class="warning" compact><dt><b>Warning:</b></dt><dd>In any case, THE PROPER WAY TO ACCESS THESE STRUCTURES IS THROUGH THE RPM LIBRARY!!</dd></dl>
The RPM file format covers both source and binary packages. An RPM package file is divided in 4 logical sections:<p>
<div class="fragment"><pre class="fragment">
. Lead      -- 96 bytes of "magic" and other info
. Signature -- collection of "digital signatures"
. Header    -- holding area for all the package information (aka "metadata")
. Payload   -- compressed archive of the file(s) in the package (aka "payload")
</pre></div><p>
All 2 and 4 byte "integer" quantities (int16 and int32) are stored in network byte order. When data is presented, the first number is the byte number, or address, in hex, followed by the byte values in hex, followed by character "translations" (where appropriate).<p>
The Lead is basically for file(1). All the information contained in the Lead is duplicated or superceded by information in the Header. Much of the info in the Lead was used in old versions of RPM but is now ignored. The Lead is stored as a C structure:<p>
<div class="fragment"><pre class="fragment"><span class="keyword">struct </span><a class="code" href="structrpmlead.html" title="The lead data structure.">rpmlead</a> {
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structmagic.html">magic</a>[4];
    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="system_8h.html#9dbd022804b9875969f8fe1226c13f94">major</a>, <a class="code" href="system_8h.html#34b528207b48e5d10558dd7c3e83f574">minor</a>;
    <span class="keywordtype">short</span> type;
    <span class="keywordtype">short</span> archnum;
    <span class="keywordtype">char</span> <a class="code" href="structname.html">name</a>[66];
    <span class="keywordtype">short</span> osnum;
    <span class="keywordtype">short</span> signature_type;
    <span class="keywordtype">char</span> reserved[16];
};
</pre></div><p>
and is illustrated with one pulled from the rpm-2.1.2-1.i386.rpm package:<p>
<div class="fragment"><pre class="fragment">
00000000: ed ab ee db 03 00 00 00
</pre></div><p>
The first 4 bytes (0-3) are "magic" used to uniquely identify an RPM package. It is used by RPM and file(1). The next two bytes (4, 5) are int8 quantities denoting the "major" and "minor" RPM file format version. This package is in 3.0 format. The following 2 bytes (6-7) form an int16 which indicates the package type. As of this writing there are only two types: 0 == binary, 1 == source.<p>
<div class="fragment"><pre class="fragment">
00000008: 00 01 72 70 6d 2d 32 2e    ..rpm-2.
</pre></div><p>
The next two bytes (8-9) form an int16 that indicates the architecture the package was built for. While this is used by file(1), the true architecture is stored as a string in the Header. See, <a class="el" href="lib_2misc_8c.html">lib/misc.c</a> for a list of architecture-&gt;int16 translations. In this case, 1 == i386. Starting with byte 10 and extending to byte 75, are 65 characters and a null byte which contain the familiar "name-version-release" of the package, padded with null (0) bytes.<p>
<div class="fragment"><pre class="fragment">
00000010: 31 2e 32 2d 31 00 00 00    1.2-1...
00000018: 00 00 00 00 00 00 00 00    ........
00000020: 00 00 00 00 00 00 00 00    ........
00000028: 00 00 00 00 00 00 00 00    ........
00000030: 00 00 00 00 00 00 00 00    ........
00000038: 00 00 00 00 00 00 00 00    ........
00000040: 00 00 00 00 00 00 00 00    ........
00000048: 00 00 00 00 00 01 00 05    ........
</pre></div><p>
Bytes 76-77 ("00 01" above) form an int16 that indicates the OS the package was built for. In this case, 1 == Linux. The next 2 bytes (78-79) form an int16 that indicates the signature type. This tells RPM what to expect in the Signature. For version 3.0 packages, this is 5, which indicates the new "Header-style" signatures.<p>
<div class="fragment"><pre class="fragment">
00000050: 04 00 00 00 68 e6 ff bf    ........
00000058: ab ad 00 08 3c eb ff bf    ........
</pre></div><p>
The remaining 16 bytes (80-95) are currently unused and are reserved for future expansion.<p>
A 3.0 format signature (denoted by signature type 5 in the Lead), uses the same structure as the Header. For historical reasons, this structure is called a "header structure", which can be confusing since it is used for both the Header and the Signature. The details of the header structure are given below, and you'll want to read them so the rest of this makes sense. The tags for the Signature are defined in <a class="el" href="signature_8h.html" title="Generate and verify signatures.">lib/signature.h</a>.<p>
The Signature can contain multiple signatures, of different types. There are currently only three types, each with its own tag in the header structure:<p>
<div class="fragment"><pre class="fragment">
	Name	Tag	Header Type
	----	----	-----------
	SIZE	1000	INT_32
	MD5	1001	BIN
	PGP	1002	BIN
</pre></div><p>
The MD5 signature is 16 bytes, and the PGP signature varies with the size of the PGP key used to sign the package.<p>
As of RPM 2.1, all packages carry at least SIZE and MD5 signatures, and the Signature section is padded to a multiple of 8 bytes.<p>
The Header contains all the information about a package: <a class="el" href="structname.html">name</a>, version, file list, etc. It uses the same "header structure" as the Signature, which is described in detail below. A complete list of the tags for the Header would take too much space to list here, and the list grows fairly frequently. For the complete list see <a class="el" href="rpmlib_8h.html" title="In Memoriam: Steve Taylor &lt;staylor@redhat.com&gt; was here, now he's not.">lib/rpmlib.h</a> in the RPM sources.<p>
The Payload is currently a gzipped cpio archive. The cpio archive type used is SVR4 with a CRC checksum.<p>
The header structure is a little complicated, but actually performs a very simple function. It acts almost like a small database in that it allows you to store and retrieve arbitrary data with a key called a "tag". When a header structure is written to disk, the data is written in network byte order, and when it is read from disk, is is converted to host byte order.<p>
Along with the tag and the data, a data "type" is stored, which indicates, obviously, the type of the data associated with the tag. There are currently 9 types:<p>
<div class="fragment"><pre class="fragment">
	Type		Number
	----		------
	NULL		0
	CHAR		1
	INT8		2
	INT16		3
	INT32		4
	INT64		5
	STRING		6
	BIN		7
	STRING_ARRAY	8
	I18NSTRING_TYPE	9
</pre></div><p>
One final piece of information is a "count" which is stored with each tag, and indicates the number of items of the associated type that are stored. As a special case, the STRING type is not allowed to have a count greater than 1. To store more than one string you must use a STRING_ARRAY.<p>
Altogether, the tag, type, count, and data are called an "Entry" or "Header Entry".<p>
<div class="fragment"><pre class="fragment">
00000000: 8e ad e8 01 00 00 00 00    ........
</pre></div><p>
A header begins with 3 bytes of <a class="el" href="structmagic.html">magic</a> "8e ad e8" and a single byte to indicate the header version. The next four bytes (4-7) are reserved.<p>
<div class="fragment"><pre class="fragment">
00000008: 00 00 00 20 00 00 07 77    ........
</pre></div><p>
The next four bytes (8-11) form an int32 that is a count of the number of entries stored (in this case, 32). Bytes 12-15 form an int32 that is a count of the number of bytes of data stored (that is, the number of bytes made up by the data portion of each entry). In this case it is 1911 bytes.<p>
<div class="fragment"><pre class="fragment">
00000010: 00 00 03 e8 00 00 00 06 00 00 00 00 00 00 00 01    ................
</pre></div><p>
Following the first 16 bytes is the part of the header called the "index". The index is made of up "index entries", one for each entry in the header. Each index entry contains four int32 quantities. In order, they are: tag, type, offset, count. In the above example, we have tag=1000, type=6, offset=0, count=1. By looking up the the tag in <a class="el" href="rpmlib_8h.html" title="In Memoriam: Steve Taylor &lt;staylor@redhat.com&gt; was here, now he's not.">lib/rpmlib.h</a> we can see that this entry is for the package <a class="el" href="structname.html">name</a>. The type of the entry is a STRING. The offset is an offset from the start of the data part of the header to the data associated with this entry. The count indicates that there is only one string associated with the entry (which we really already knew since STRING types are not allowed to have a count greater than 1).<p>
In our example there would be 32 such 16-byte index entries, followed by the data section:<p>
<div class="fragment"><pre class="fragment">
00000210: 72 70 6d 00 32 2e 31 2e 32 00 31 00 52 65 64 20    rpm.2.1.2.1.Red 
00000220: 48 61 74 20 50 61 63 6b 61 67 65 20 4d 61 6e 61    Hat Package Mana
00000230: 67 65 72 00 31 e7 cb b4 73 63 68 72 6f 65 64 65    ger.1...schroede
00000240: 72 2e 72 65 64 68 61 74 2e 63 6f 6d 00 00 00 00    r.redhat.com....
...
00000970: 6c 69 62 63 2e 73 6f 2e 35 00 6c 69 62 64 62 2e    libc.so.5.libdb.
00000980: 73 6f 2e 32 00 00                                  so.2..
</pre></div><p>
The data section begins at byte 528 (4 <a class="el" href="structmagic.html">magic</a>, 4 reserved, 4 index entry count, 4 data byte count, 16 * 32 index entries). At offset 0, bytes 528-531 are "rpm" plus a null byte, which is the data for the first index entry (the package <a class="el" href="structname.html">name</a>). Following is is the data for each of the other entries. Each string is null terminated, the strings in a STRING_ARRAY are also null terminated and are place one after another. The integer types are aligned to appropriate byte boundaries, so that the data of INT64 type starts on an 8 byte boundary, INT32 type starts on a 4 byte boundary, and an INT16 type starts on a 2 byte boundary. For example:<p>
<div class="fragment"><pre class="fragment">
00000060: 00 00 03 ef 00 00 00 06 00 00 00 28 00 00 00 01    ................
00000070: 00 00 03 f1 00 00 00 04 00 00 00 40 00 00 00 01    ................
...
00000240: 72 2e 72 65 64 68 61 74 2e 63 6f 6d 00 00 00 00    r.redhat.com....
00000250: 00 09 9b 31 52 65 64 20 48 61 74 20 4c 69 6e 75    ....Red Hat Linu
</pre></div><p>
Index entry number 6 is the BUILDHOST, of type STRING. Index entry number 7 is the SIZE, of type INT32. The corresponding data for entry 6 end at byte 588 with "....redhat.com\0". The next piece of data could start at byte 589, byte that is an improper boundary for an INT32. As a result, 3 null bytes are inserted and the date for the SIZE actually starts at byte 592: "00 09 9b 31", which is 629553).<p>
The tools directory in the RPM sources contains a number of small programs that use the RPM library to pick apart packages. These tools are mostly used for debugging, but can also be used to help you understand the internals of the RPM package format.<p>
<div class="fragment"><pre class="fragment">
	rpmlead		- extracts the Lead from a package
	rpmsignature	- extracts the Signature from a package
	rpmheader	- extracts the Header from a package
	rpmarchive	- extracts the Archive from a package
	dump		- displays a header structure in readable format
</pre></div><p>
Given a package foo.rpm you might try:<p>
<div class="fragment"><pre class="fragment">
	rpmlead foo.rpm | od -x
	rpmsignature foo.rpm | dump
	rpmheader foo.rpm | dump
	rpmarchive foo.rpm | zcat | cpio --list
</pre></div> <hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:57 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
