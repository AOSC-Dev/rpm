<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: rpmio/macro.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>rpmio/macro.c</h1><a href="macro_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*@-boundsread@*/</span>
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00007"></a>00007 <span class="preprocessor">#include &lt;stdarg.h&gt;</span>
<a name="l00008"></a>00008 
<a name="l00009"></a>00009 <span class="preprocessor">#if !defined(isblank)</span>
<a name="l00010"></a><a class="code" href="macro_8c.html#71b921c86d024ec3342964ac68dffc64">00010</a> <span class="preprocessor"></span><span class="preprocessor">#define isblank(_c)     ((_c) == ' ' || (_c) == '\t')</span>
<a name="l00011"></a>00011 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00012"></a><a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">00012</a> <span class="preprocessor"></span><span class="preprocessor">#define iseol(_c)       ((_c) == '\n' || (_c) == '\r')</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span>
<a name="l00014"></a><a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">00014</a> <span class="preprocessor">#define STREQ(_t, _f, _fn)      ((_fn) == (sizeof(_t)-1) &amp;&amp; !strncmp((_t), (_f), (_fn)))</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span>
<a name="l00016"></a>00016 <span class="preprocessor">#ifdef DEBUG_MACROS</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/types.h&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;getopt.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#define rpmError fprintf</span>
<a name="l00025"></a>00025 <span class="preprocessor"></span><span class="preprocessor">#define RPMERR_BADSPEC stderr</span>
<a name="l00026"></a>00026 <span class="preprocessor"></span><span class="preprocessor">#undef  _</span>
<a name="l00027"></a>00027 <span class="preprocessor"></span><span class="preprocessor">#define _(x)    x</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a>00029 <span class="preprocessor">#define vmefail()               (exit(1), NULL)</span>
<a name="l00030"></a>00030 <span class="preprocessor"></span><span class="preprocessor">#define urlPath(_xr, _r)        *(_r) = (_xr)</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="keyword">typedef</span> FILE * <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a>;
<a name="l00033"></a>00033 <span class="preprocessor">#define Fopen(_path, _fmode)    fopen(_path, "r");</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#define Ferror                  ferror</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span><span class="preprocessor">#define Fstrerror(_fd)          strerror(errno)</span>
<a name="l00036"></a>00036 <span class="preprocessor"></span><span class="preprocessor">#define Fread                   fread</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#define Fclose                  fclose</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span>
<a name="l00039"></a>00039 <span class="preprocessor">#define fdGetFILE(_fd)          (_fd)</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span>
<a name="l00041"></a>00041 <span class="preprocessor">#else</span>
<a name="l00042"></a>00042 <span class="preprocessor"></span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &lt;<a class="code" href="rpmio__internal_8h.html">rpmio_internal.h</a>&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;<a class="code" href="rpmmessages_8h.html">rpmmessages.h</a>&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;<a class="code" href="rpmerr_8h.html">rpmerr.h</a>&gt;</span>
<a name="l00046"></a>00046 
<a name="l00047"></a>00047 <span class="preprocessor">#ifdef  WITH_LUA</span>
<a name="l00048"></a>00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;rpmlua.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#endif</span>
<a name="l00050"></a>00050 <span class="preprocessor"></span>
<a name="l00051"></a>00051 <span class="preprocessor">#endif</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;<a class="code" href="rpmmacro_8h.html">rpmmacro.h</a>&gt;</span>
<a name="l00054"></a>00054 
<a name="l00055"></a>00055 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00056"></a>00056 
<a name="l00057"></a>00057 <span class="preprocessor">#if defined(__LCLINT__)</span>
<a name="l00058"></a>00058 <span class="preprocessor"></span><span class="comment">/*@-exportheader@*/</span>
<a name="l00059"></a>00059 <span class="keyword">extern</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> **__ctype_b_loc (<span class="keywordtype">void</span>) <span class="comment">/*@*/</span>;
<a name="l00060"></a>00060 <span class="comment">/*@=exportheader@*/</span>
<a name="l00061"></a>00061 <span class="preprocessor">#endif</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00063"></a>00063 <span class="comment">/*@access FD_t@*/</span>               <span class="comment">/* XXX compared with NULL */</span>
<a name="l00064"></a>00064 <span class="comment">/*@access MacroContext@*/</span>
<a name="l00065"></a>00065 <span class="comment">/*@access MacroEntry@*/</span>
<a name="l00066"></a>00066 <span class="comment">/*@access rpmlua @*/</span>
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="macro_8c.html#f1a4a6419e2d381ef3dc51df7f2ed076">00068</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structMacroContext__s.html">MacroContext_s</a> <a class="code" href="macro_8c.html#f1a4a6419e2d381ef3dc51df7f2ed076">rpmGlobalMacroContext_s</a>;
<a name="l00069"></a>00069 <span class="comment">/*@-compmempass@*/</span>
<a name="l00070"></a><a class="code" href="rpmmacro_8h.html#3aecac57afea2383fc94133066421800">00070</a> <a class="code" href="structMacroContext__s.html">MacroContext</a> <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a> = &amp;<a class="code" href="macro_8c.html#f1a4a6419e2d381ef3dc51df7f2ed076">rpmGlobalMacroContext_s</a>;
<a name="l00071"></a>00071 <span class="comment">/*@=compmempass@*/</span>
<a name="l00072"></a>00072 
<a name="l00073"></a><a class="code" href="macro_8c.html#c467ab83ef6590841b0eefd34b00712b">00073</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structMacroContext__s.html">MacroContext_s</a> <a class="code" href="macro_8c.html#c467ab83ef6590841b0eefd34b00712b">rpmCLIMacroContext_s</a>;
<a name="l00074"></a>00074 <span class="comment">/*@-compmempass@*/</span>
<a name="l00075"></a><a class="code" href="rpmmacro_8h.html#ba0e176696e6cf629f6af10b2200c48c">00075</a> <a class="code" href="structMacroContext__s.html">MacroContext</a> <a class="code" href="rpmlib_8h.html#8006c2dbfafa9d855483d850e26c52d8">rpmCLIMacroContext</a> = &amp;<a class="code" href="macro_8c.html#c467ab83ef6590841b0eefd34b00712b">rpmCLIMacroContext_s</a>;
<a name="l00076"></a>00076 <span class="comment">/*@=compmempass@*/</span>
<a name="l00077"></a>00077 
<a name="l00081"></a><a class="code" href="structMacroBuf__s.html">00081</a> <span class="keyword">typedef</span> <span class="comment">/*@abstract@*/</span> <span class="keyword">struct </span><a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf_s</a> {
<a name="l00082"></a>00082 <span class="comment">/*@kept@*/</span> <span class="comment">/*@exposed@*/</span>
<a name="l00083"></a><a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">00083</a>     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a>;             
<a name="l00084"></a>00084 <span class="comment">/*@shared@*/</span>
<a name="l00085"></a><a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">00085</a>     <span class="keywordtype">char</span> * <a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>;                   
<a name="l00086"></a><a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">00086</a>     <span class="keywordtype">size_t</span> <a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a>;                  
<a name="l00087"></a><a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">00087</a>     <span class="keywordtype">int</span> <a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>;                  
<a name="l00088"></a><a class="code" href="structMacroBuf__s.html#e67c77fd343e3232dabc479f8fcac3a4">00088</a>     <span class="keywordtype">int</span> <a class="code" href="structMacroBuf__s.html#e67c77fd343e3232dabc479f8fcac3a4">macro_trace</a>;            
<a name="l00089"></a><a class="code" href="structMacroBuf__s.html#216bd6ec2d68169c494124edfd12a384">00089</a>     <span class="keywordtype">int</span> <a class="code" href="structMacroBuf__s.html#216bd6ec2d68169c494124edfd12a384">expand_trace</a>;           
<a name="l00090"></a>00090 <span class="comment">/*@kept@*/</span> <span class="comment">/*@exposed@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00091"></a><a class="code" href="structMacroBuf__s.html#bdb178947746610a25f466b3f461613b">00091</a>     <span class="keywordtype">void</span> * <a class="code" href="structMacroBuf__s.html#bdb178947746610a25f466b3f461613b">spec</a>;                
<a name="l00092"></a>00092 <span class="comment">/*@kept@*/</span> <span class="comment">/*@exposed@*/</span>
<a name="l00093"></a><a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">00093</a>     <a class="code" href="structMacroContext__s.html">MacroContext</a> <a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>;
<a name="l00094"></a>00094 } * <a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a>;
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="macro_8c.html#0bf86a73152948baeb778eff132508f9">00096</a> <span class="preprocessor">#define SAVECHAR(_mb, _c) { *(_mb)-&gt;t = (_c), (_mb)-&gt;t++, (_mb)-&gt;nb--; }</span>
<a name="l00097"></a>00097 <span class="preprocessor"></span>
<a name="l00098"></a>00098 <span class="comment">/*@-exportlocal -exportheadervar@*/</span>
<a name="l00099"></a>00099 
<a name="l00100"></a><a class="code" href="macro_8c.html#479ff5787e7843bb68aac97693874220">00100</a> <span class="preprocessor">#define _MAX_MACRO_DEPTH        16</span>
<a name="l00101"></a>00101 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00102"></a><a class="code" href="macro_8c.html#8351a2449d4ccc57c8e5c1451af359ed">00102</a> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#8351a2449d4ccc57c8e5c1451af359ed">max_macro_depth</a> = <a class="code" href="macro_8c.html#479ff5787e7843bb68aac97693874220">_MAX_MACRO_DEPTH</a>;
<a name="l00103"></a>00103 
<a name="l00104"></a><a class="code" href="macro_8c.html#7a7a9a5151859483873fddaea20f8528">00104</a> <span class="preprocessor">#define _PRINT_MACRO_TRACE      0</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00106"></a><a class="code" href="macro_8c.html#69c82ff03bf0a250cd73e00eb2059897">00106</a> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#69c82ff03bf0a250cd73e00eb2059897">print_macro_trace</a> = <a class="code" href="macro_8c.html#7a7a9a5151859483873fddaea20f8528">_PRINT_MACRO_TRACE</a>;
<a name="l00107"></a>00107 
<a name="l00108"></a><a class="code" href="macro_8c.html#31dd0a01753e973884451bd241cdf459">00108</a> <span class="preprocessor">#define _PRINT_EXPAND_TRACE     0</span>
<a name="l00109"></a>00109 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00110"></a><a class="code" href="macro_8c.html#1e97e767636425e2fbe9b7578ca48cd0">00110</a> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#1e97e767636425e2fbe9b7578ca48cd0">print_expand_trace</a> = <a class="code" href="macro_8c.html#31dd0a01753e973884451bd241cdf459">_PRINT_EXPAND_TRACE</a>;
<a name="l00111"></a>00111 <span class="comment">/*@=exportlocal =exportheadervar@*/</span>
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="macro_8c.html#80ea16f3bbc9b989b472afb2ca98ab92">00113</a> <span class="preprocessor">#define MACRO_CHUNK_SIZE        16</span>
<a name="l00114"></a>00114 <span class="preprocessor"></span>
<a name="l00115"></a>00115 <span class="comment">/* forward ref */</span>
<a name="l00116"></a>00116 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb)
<a name="l00117"></a>00117         <span class="comment">/*@globals rpmGlobalMacroContext,</span>
<a name="l00118"></a>00118 <span class="comment">                print_macro_trace, print_expand_trace, h_errno, fileSystem @*/</span>
<a name="l00119"></a>00119         <span class="comment">/*@modifies mb, rpmGlobalMacroContext,</span>
<a name="l00120"></a>00120 <span class="comment">                print_macro_trace, print_expand_trace, fileSystem @*/</span>;
<a name="l00121"></a>00121 
<a name="l00127"></a>00127 <span class="comment">/*@unused@*/</span> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> *
<a name="l00128"></a><a class="code" href="macro_8c.html#d608c2923552dbeeb832133a9a289bb7">00128</a> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(<span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">void</span> * p)
<a name="l00129"></a>00129         <span class="comment">/*@modifies p@*/</span>
<a name="l00130"></a>00130 {
<a name="l00131"></a>00131     <span class="keywordflow">if</span> (p != NULL)      free((<span class="keywordtype">void</span> *)p);
<a name="l00132"></a>00132     <span class="keywordflow">return</span> NULL;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a>00135 <span class="comment">/* =============================================================== */</span>
<a name="l00136"></a>00136 
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00144"></a><a class="code" href="macro_8c.html#2f39dd8a89854ef04cd431a6f0d3c139">00144</a> <a class="code" href="macro_8c.html#2f39dd8a89854ef04cd431a6f0d3c139" title="Compare macro entries by name (qsort/bsearch).">compareMacroName</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * ap, <span class="keyword">const</span> <span class="keywordtype">void</span> * bp)
<a name="l00145"></a>00145         <span class="comment">/*@*/</span>
<a name="l00146"></a>00146 {
<a name="l00147"></a>00147     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> ame = *((<a class="code" href="structMacroEntry__s.html">MacroEntry</a> *)ap);
<a name="l00148"></a>00148     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> bme = *((<a class="code" href="structMacroEntry__s.html">MacroEntry</a> *)bp);
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="keywordflow">if</span> (ame == NULL &amp;&amp; bme == NULL)
<a name="l00151"></a>00151         <span class="keywordflow">return</span> 0;
<a name="l00152"></a>00152     <span class="keywordflow">if</span> (ame == NULL)
<a name="l00153"></a>00153         <span class="keywordflow">return</span> 1;
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (bme == NULL)
<a name="l00155"></a>00155         <span class="keywordflow">return</span> -1;
<a name="l00156"></a>00156     <span class="keywordflow">return</span> strcmp(ame-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, bme-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>);
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00163"></a>00163 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00164"></a>00164 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00165"></a><a class="code" href="macro_8c.html#15ee0f5f86ab8580678dd446367c22bf">00165</a> <a class="code" href="macro_8c.html#15ee0f5f86ab8580678dd446367c22bf" title="Enlarge macro table.">expandMacroTable</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc)
<a name="l00166"></a>00166         <span class="comment">/*@modifies mc @*/</span>
<a name="l00167"></a>00167 {
<a name="l00168"></a>00168     <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> == NULL) {
<a name="l00169"></a>00169         mc-&gt;<a class="code" href="structMacroContext__s.html#fe73871ef47a02cf23b2fa193182f4bc">macrosAllocated</a> = <a class="code" href="macro_8c.html#80ea16f3bbc9b989b472afb2ca98ab92">MACRO_CHUNK_SIZE</a>;
<a name="l00170"></a>00170         mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> = (<a class="code" href="structMacroEntry__s.html">MacroEntry</a> *)
<a name="l00171"></a>00171             <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(<span class="keyword">sizeof</span>(*(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>)) * mc-&gt;<a class="code" href="structMacroContext__s.html#fe73871ef47a02cf23b2fa193182f4bc">macrosAllocated</a>);
<a name="l00172"></a>00172         mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a> = 0;
<a name="l00173"></a>00173     } <span class="keywordflow">else</span> {
<a name="l00174"></a>00174         mc-&gt;<a class="code" href="structMacroContext__s.html#fe73871ef47a02cf23b2fa193182f4bc">macrosAllocated</a> += <a class="code" href="macro_8c.html#80ea16f3bbc9b989b472afb2ca98ab92">MACRO_CHUNK_SIZE</a>;
<a name="l00175"></a>00175         mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> = (<a class="code" href="structMacroEntry__s.html">MacroEntry</a> *)
<a name="l00176"></a>00176             <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>, <span class="keyword">sizeof</span>(*(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>)) *
<a name="l00177"></a>00177                         mc-&gt;<a class="code" href="structMacroContext__s.html#fe73871ef47a02cf23b2fa193182f4bc">macrosAllocated</a>);
<a name="l00178"></a>00178     }
<a name="l00179"></a>00179     memset(&amp;mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>], 0, <a class="code" href="macro_8c.html#80ea16f3bbc9b989b472afb2ca98ab92">MACRO_CHUNK_SIZE</a> * <span class="keyword">sizeof</span>(*(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>)));
<a name="l00180"></a>00180 }
<a name="l00181"></a>00181 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00182"></a>00182 
<a name="l00187"></a>00187 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00188"></a><a class="code" href="macro_8c.html#41b48bc6dda66614c6d072c631b948ea">00188</a> <a class="code" href="macro_8c.html#41b48bc6dda66614c6d072c631b948ea" title="Sort entries in macro table.">sortMacroTable</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc)
<a name="l00189"></a>00189         <span class="comment">/*@modifies mc @*/</span>
<a name="l00190"></a>00190 {
<a name="l00191"></a>00191     <span class="keywordtype">int</span> i;
<a name="l00192"></a>00192 
<a name="l00193"></a>00193     <span class="keywordflow">if</span> (mc == NULL || mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> == NULL)
<a name="l00194"></a>00194         <span class="keywordflow">return</span>;
<a name="l00195"></a>00195 
<a name="l00196"></a>00196     qsort(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>, mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>, <span class="keyword">sizeof</span>(*(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>)),
<a name="l00197"></a>00197                 <a class="code" href="macro_8c.html#2f39dd8a89854ef04cd431a6f0d3c139" title="Compare macro entries by name (qsort/bsearch).">compareMacroName</a>);
<a name="l00198"></a>00198 
<a name="l00199"></a>00199     <span class="comment">/* Empty pointers are now at end of table. Reset first free index. */</span>
<a name="l00200"></a>00200     <span class="keywordflow">for</span> (i = 0; i &lt; mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>; i++) {
<a name="l00201"></a>00201         <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[i] != NULL)
<a name="l00202"></a>00202             <span class="keywordflow">continue</span>;
<a name="l00203"></a>00203         mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a> = i;
<a name="l00204"></a>00204         <span class="keywordflow">break</span>;
<a name="l00205"></a>00205     }
<a name="l00206"></a>00206 }
<a name="l00207"></a>00207 
<a name="l00208"></a>00208 <span class="keywordtype">void</span>
<a name="l00209"></a><a class="code" href="rpmmacro_8h.html#f075388010eeb8d8decdc1978fd7db24">00209</a> <a class="code" href="macro_8c.html#f075388010eeb8d8decdc1978fd7db24" title="Print macros to file stream.">rpmDumpMacroTable</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, FILE * fp)
<a name="l00210"></a>00210 {
<a name="l00211"></a>00211     <span class="keywordtype">int</span> nempty = 0;
<a name="l00212"></a>00212     <span class="keywordtype">int</span> nactive = 0;
<a name="l00213"></a>00213 
<a name="l00214"></a>00214     <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l00215"></a>00215     <span class="keywordflow">if</span> (fp == NULL) fp = stderr;
<a name="l00216"></a>00216     
<a name="l00217"></a>00217     fprintf(fp, <span class="stringliteral">"========================\n"</span>);
<a name="l00218"></a>00218     <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> != NULL) {
<a name="l00219"></a>00219         <span class="keywordtype">int</span> i;
<a name="l00220"></a>00220         <span class="keywordflow">for</span> (i = 0; i &lt; mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>; i++) {
<a name="l00221"></a>00221             <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me;
<a name="l00222"></a>00222             <span class="keywordflow">if</span> ((me = mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[i]) == NULL) {
<a name="l00223"></a>00223                 <span class="comment">/* XXX this should never happen */</span>
<a name="l00224"></a>00224                 nempty++;
<a name="l00225"></a>00225                 <span class="keywordflow">continue</span>;
<a name="l00226"></a>00226             }
<a name="l00227"></a>00227             fprintf(fp, <span class="stringliteral">"%3d%c %s"</span>, me-&gt;level,
<a name="l00228"></a>00228                         (me-&gt;used &gt; 0 ? <span class="charliteral">'='</span> : <span class="charliteral">':'</span>), me-&gt;name);
<a name="l00229"></a>00229             <span class="keywordflow">if</span> (me-&gt;opts &amp;&amp; *me-&gt;opts)
<a name="l00230"></a>00230                     fprintf(fp, <span class="stringliteral">"(%s)"</span>, me-&gt;opts);
<a name="l00231"></a>00231             <span class="keywordflow">if</span> (me-&gt;body &amp;&amp; *me-&gt;body)
<a name="l00232"></a>00232                     fprintf(fp, <span class="stringliteral">"\t%s"</span>, me-&gt;body);
<a name="l00233"></a>00233             fprintf(fp, <span class="stringliteral">"\n"</span>);
<a name="l00234"></a>00234             nactive++;
<a name="l00235"></a>00235         }
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237     fprintf(fp, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"======================== active %d empty %d\n"</span>),
<a name="l00238"></a>00238                 nactive, nempty);
<a name="l00239"></a>00239 }
<a name="l00240"></a>00240 
<a name="l00248"></a>00248 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00249"></a>00249 <span class="comment">/*@dependent@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00250"></a>00250 <span class="keyword">static</span> <a class="code" href="structMacroEntry__s.html">MacroEntry</a> *
<a name="l00251"></a><a class="code" href="macro_8c.html#a096c2ac6fe9be131a8ae6be3fbe0a4d">00251</a> <a class="code" href="header_8c.html#822829bcd46d0c6e9e1ea68927351f1d" title="Find matching (tag,type) entry in header.">findEntry</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="structname.html">name</a>, <span class="keywordtype">size_t</span> namelen)
<a name="l00252"></a>00252         <span class="comment">/*@*/</span>
<a name="l00253"></a>00253 {
<a name="l00254"></a>00254     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> key, *ret;
<a name="l00255"></a>00255     <span class="keyword">struct </span><a class="code" href="structMacroEntry__s.html">MacroEntry_s</a> keybuf;
<a name="l00256"></a>00256     <span class="keywordtype">char</span> *namebuf = NULL;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258 <span class="comment">/*@-globs@*/</span>
<a name="l00259"></a>00259     <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l00260"></a>00260 <span class="comment">/*@=globs@*/</span>
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> == NULL || mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a> == 0)
<a name="l00262"></a>00262         <span class="keywordflow">return</span> NULL;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264 <span class="comment">/*@-branchstate@*/</span>
<a name="l00265"></a>00265     <span class="keywordflow">if</span> (namelen &gt; 0) {
<a name="l00266"></a>00266         namebuf = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(namelen + 1);
<a name="l00267"></a>00267         memset(namebuf, 0, (namelen + 1));
<a name="l00268"></a>00268         strncpy(namebuf, name, namelen);
<a name="l00269"></a>00269         namebuf[namelen] = <span class="charliteral">'\0'</span>;
<a name="l00270"></a>00270         name = namebuf;
<a name="l00271"></a>00271     }
<a name="l00272"></a>00272 <span class="comment">/*@=branchstate@*/</span>
<a name="l00273"></a>00273     
<a name="l00274"></a>00274     key = &amp;keybuf;
<a name="l00275"></a>00275     memset(key, 0, <span class="keyword">sizeof</span>(*key));
<a name="l00276"></a>00276     <span class="comment">/*@-temptrans -assignexpose@*/</span>
<a name="l00277"></a>00277     key-&gt;name = (<span class="keywordtype">char</span> *)name;
<a name="l00278"></a>00278     <span class="comment">/*@=temptrans =assignexpose@*/</span>
<a name="l00279"></a>00279     ret = (<a class="code" href="structMacroEntry__s.html">MacroEntry</a> *) bsearch(&amp;key, mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>, mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>,
<a name="l00280"></a>00280                         <span class="keyword">sizeof</span>(*(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>)), <a class="code" href="macro_8c.html#2f39dd8a89854ef04cd431a6f0d3c139" title="Compare macro entries by name (qsort/bsearch).">compareMacroName</a>);
<a name="l00281"></a>00281     <span class="comment">/* XXX TODO: find 1st empty slot and return that */</span>
<a name="l00282"></a>00282     <span class="keywordflow">return</span> ret;
<a name="l00283"></a>00283 }
<a name="l00284"></a>00284 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="comment">/* =============================================================== */</span>
<a name="l00287"></a>00287 
<a name="l00295"></a>00295 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00296"></a>00296 <span class="comment">/*@null@*/</span>
<a name="l00297"></a>00297 <span class="keyword">static</span> <span class="keywordtype">char</span> *
<a name="l00298"></a><a class="code" href="macro_8c.html#c9f1be5e4270f95d099e04074c229c7f">00298</a> <a class="code" href="macro_8c.html#c9f1be5e4270f95d099e04074c229c7f" title="fgets(3) analogue that reads \ continuations.">rdcl</a>(<span class="comment">/*@returned@*/</span> <span class="keywordtype">char</span> * buf, <span class="keywordtype">size_t</span> size, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd)
<a name="l00299"></a>00299         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l00300"></a>00300         <span class="comment">/*@modifies buf, fileSystem @*/</span>
<a name="l00301"></a>00301 {
<a name="l00302"></a>00302     <span class="keywordtype">char</span> *q = buf - 1;          <span class="comment">/* initialize just before buffer. */</span>
<a name="l00303"></a>00303     <span class="keywordtype">size_t</span> nb = 0;
<a name="l00304"></a>00304     <span class="keywordtype">size_t</span> nread = 0;
<a name="l00305"></a>00305     FILE * f = <a class="code" href="rpmio_8c.html#8494818d4d91a45e8ecf1a18fffa4b9a">fdGetFILE</a>(fd);
<a name="l00306"></a>00306     <span class="keywordtype">int</span> pc = 0, bc = 0;
<a name="l00307"></a>00307     <span class="keywordtype">char</span> *p = buf;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309     <span class="keywordflow">if</span> (f != NULL)
<a name="l00310"></a>00310     <span class="keywordflow">do</span> {
<a name="l00311"></a>00311         *(++q) = <span class="charliteral">'\0'</span>;                  <span class="comment">/* terminate and move forward. */</span>
<a name="l00312"></a>00312         <span class="keywordflow">if</span> (fgets(q, size, f) == NULL)  <span class="comment">/* read next line. */</span>
<a name="l00313"></a>00313             <span class="keywordflow">break</span>;
<a name="l00314"></a>00314         nb = strlen(q);
<a name="l00315"></a>00315         nread += nb;                    <span class="comment">/* trim trailing \r and \n */</span>
<a name="l00316"></a>00316         <span class="keywordflow">for</span> (q += nb - 1; nb &gt; 0 &amp;&amp; <a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(*q); q--)
<a name="l00317"></a>00317             nb--;
<a name="l00318"></a>00318         <span class="keywordflow">for</span> (; p &lt;= q; p++) {
<a name="l00319"></a>00319             <span class="keywordflow">switch</span> (*p) {
<a name="l00320"></a>00320                 <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
<a name="l00321"></a>00321                     <span class="keywordflow">switch</span> (*(p+1)) {
<a name="l00322"></a>00322                         <span class="keywordflow">case</span> <span class="charliteral">'\0'</span>: <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00323"></a>00323                         <span class="keywordflow">default</span>: p++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00324"></a>00324                     }
<a name="l00325"></a>00325                     <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00326"></a>00326                 <span class="keywordflow">case</span> <span class="charliteral">'%'</span>:
<a name="l00327"></a>00327                     <span class="keywordflow">switch</span> (*(p+1)) {
<a name="l00328"></a>00328                         <span class="keywordflow">case</span> <span class="charliteral">'{'</span>: p++, bc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00329"></a>00329                         <span class="keywordflow">case</span> <span class="charliteral">'('</span>: p++, pc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00330"></a>00330                         <span class="keywordflow">case</span> <span class="charliteral">'%'</span>: p++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00331"></a>00331                     }
<a name="l00332"></a>00332                     <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00333"></a>00333                 <span class="keywordflow">case</span> <span class="charliteral">'{'</span>: <span class="keywordflow">if</span> (bc &gt; 0) bc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00334"></a>00334                 <span class="keywordflow">case</span> <span class="charliteral">'}'</span>: <span class="keywordflow">if</span> (bc &gt; 0) bc--; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00335"></a>00335                 <span class="keywordflow">case</span> <span class="charliteral">'('</span>: <span class="keywordflow">if</span> (pc &gt; 0) pc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00336"></a>00336                 <span class="keywordflow">case</span> <span class="charliteral">')'</span>: <span class="keywordflow">if</span> (pc &gt; 0) pc--; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00337"></a>00337             }
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339         <span class="keywordflow">if</span> (nb == 0 || (*q != <span class="charliteral">'\\'</span> &amp;&amp; !bc &amp;&amp; !pc) || *(q+1) == <span class="charliteral">'\0'</span>) {
<a name="l00340"></a>00340             *(++q) = <span class="charliteral">'\0'</span>;              <span class="comment">/* trim trailing \r, \n */</span>
<a name="l00341"></a>00341             <span class="keywordflow">break</span>;
<a name="l00342"></a>00342         }
<a name="l00343"></a>00343         q++; p++; nb++;                 <span class="comment">/* copy newline too */</span>
<a name="l00344"></a>00344         size -= nb;
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (*q == <span class="charliteral">'\r'</span>)                 <span class="comment">/* XXX avoid \r madness */</span>
<a name="l00346"></a>00346             *q = <span class="charliteral">'\n'</span>;
<a name="l00347"></a>00347     } <span class="keywordflow">while</span> (size &gt; 0);
<a name="l00348"></a>00348     <span class="keywordflow">return</span> (nread &gt; 0 ? buf : NULL);
<a name="l00349"></a>00349 }
<a name="l00350"></a>00350 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00351"></a>00351 
<a name="l00359"></a>00359 <span class="comment">/*@null@*/</span>
<a name="l00360"></a>00360 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00361"></a><a class="code" href="macro_8c.html#f1b5b252eab18ae1b8437773be437797">00361</a> <a class="code" href="macro_8c.html#f1b5b252eab18ae1b8437773be437797" title="Return text between pl and matching pr characters.">matchchar</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * p, <span class="keywordtype">char</span> pl, <span class="keywordtype">char</span> pr)
<a name="l00362"></a>00362         <span class="comment">/*@*/</span>
<a name="l00363"></a>00363 {
<a name="l00364"></a>00364     <span class="keywordtype">int</span> lvl = 0;
<a name="l00365"></a>00365     <span class="keywordtype">char</span> c;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="keywordflow">while</span> ((c = *p++) != <span class="charliteral">'\0'</span>) {
<a name="l00368"></a>00368         <span class="keywordflow">if</span> (c == <span class="charliteral">'\\'</span>) {                <span class="comment">/* Ignore escaped chars */</span>
<a name="l00369"></a>00369             p++;
<a name="l00370"></a>00370             <span class="keywordflow">continue</span>;
<a name="l00371"></a>00371         }
<a name="l00372"></a>00372         <span class="keywordflow">if</span> (c == pr) {
<a name="l00373"></a>00373             <span class="keywordflow">if</span> (--lvl &lt;= 0)     <span class="keywordflow">return</span> --p;
<a name="l00374"></a>00374         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c == pl)
<a name="l00375"></a>00375             lvl++;
<a name="l00376"></a>00376     }
<a name="l00377"></a>00377     <span class="keywordflow">return</span> (<span class="keyword">const</span> <span class="keywordtype">char</span> *)NULL;
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00386"></a>00386 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00387"></a><a class="code" href="macro_8c.html#d2f1aafd4f16bd7ac83eb96f85a212a1">00387</a> <a class="code" href="macro_8c.html#d2f1aafd4f16bd7ac83eb96f85a212a1" title="Pre-print macro expression to be expanded.">printMacro</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keyword">const</span> <span class="keywordtype">char</span> * s, <span class="keyword">const</span> <span class="keywordtype">char</span> * se)
<a name="l00388"></a>00388         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l00389"></a>00389         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391     <span class="keyword">const</span> <span class="keywordtype">char</span> *senl;
<a name="l00392"></a>00392     <span class="keyword">const</span> <span class="keywordtype">char</span> *ellipsis;
<a name="l00393"></a>00393     <span class="keywordtype">int</span> choplen;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="keywordflow">if</span> (s &gt;= se) {      <span class="comment">/* XXX just in case */</span>
<a name="l00396"></a>00396         fprintf(stderr, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%3d&gt;%*s(empty)"</span>), mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>,
<a name="l00397"></a>00397                 (2 * mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> + 1), <span class="stringliteral">""</span>);
<a name="l00398"></a>00398         <span class="keywordflow">return</span>;
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="keywordflow">if</span> (s[-1] == <span class="charliteral">'{'</span>)
<a name="l00402"></a>00402         s--;
<a name="l00403"></a>00403 
<a name="l00404"></a>00404     <span class="comment">/* Print only to first end-of-line (or end-of-string). */</span>
<a name="l00405"></a>00405     <span class="keywordflow">for</span> (senl = se; *senl &amp;&amp; !<a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(*senl); senl++)
<a name="l00406"></a>00406         {};
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <span class="comment">/* Limit trailing non-trace output */</span>
<a name="l00409"></a>00409     choplen = 61 - (2 * mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l00410"></a>00410     <span class="keywordflow">if</span> ((senl - s) &gt; choplen) {
<a name="l00411"></a>00411         senl = s + choplen;
<a name="l00412"></a>00412         ellipsis = <span class="stringliteral">"..."</span>;
<a name="l00413"></a>00413     } <span class="keywordflow">else</span>
<a name="l00414"></a>00414         ellipsis = <span class="stringliteral">""</span>;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     <span class="comment">/* Substitute caret at end-of-macro position */</span>
<a name="l00417"></a>00417     fprintf(stderr, <span class="stringliteral">"%3d&gt;%*s%%%.*s^"</span>, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>,
<a name="l00418"></a>00418         (2 * mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> + 1), <span class="stringliteral">""</span>, (<span class="keywordtype">int</span>)(se - s), s);
<a name="l00419"></a>00419     <span class="keywordflow">if</span> (se[1] != <span class="charliteral">'\0'</span> &amp;&amp; (senl - (se+1)) &gt; 0)
<a name="l00420"></a>00420         fprintf(stderr, <span class="stringliteral">"%-.*s%s"</span>, (<span class="keywordtype">int</span>)(senl - (se+1)), se+1, ellipsis);
<a name="l00421"></a>00421     fprintf(stderr, <span class="stringliteral">"\n"</span>);
<a name="l00422"></a>00422 }
<a name="l00423"></a>00423 
<a name="l00430"></a>00430 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00431"></a><a class="code" href="macro_8c.html#c0c4968e7a33292fdd060e004ba2d100">00431</a> <a class="code" href="macro_8c.html#c0c4968e7a33292fdd060e004ba2d100" title="Post-print expanded macro expression.">printExpansion</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keyword">const</span> <span class="keywordtype">char</span> * t, <span class="keyword">const</span> <span class="keywordtype">char</span> * te)
<a name="l00432"></a>00432         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l00433"></a>00433         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l00434"></a>00434 {
<a name="l00435"></a>00435     <span class="keyword">const</span> <span class="keywordtype">char</span> *ellipsis;
<a name="l00436"></a>00436     <span class="keywordtype">int</span> choplen;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438     <span class="keywordflow">if</span> (!(te &gt; t)) {
<a name="l00439"></a>00439         fprintf(stderr, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%3d&lt;%*s(empty)\n"</span>), mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>, (2 * mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> + 1), <span class="stringliteral">""</span>);
<a name="l00440"></a>00440         <span class="keywordflow">return</span>;
<a name="l00441"></a>00441     }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443     <span class="comment">/* Shorten output which contains newlines */</span>
<a name="l00444"></a>00444     <span class="keywordflow">while</span> (te &gt; t &amp;&amp; <a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(te[-1]))
<a name="l00445"></a>00445         te--;
<a name="l00446"></a>00446     ellipsis = <span class="stringliteral">""</span>;
<a name="l00447"></a>00447     <span class="keywordflow">if</span> (mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> &gt; 0) {
<a name="l00448"></a>00448         <span class="keyword">const</span> <span class="keywordtype">char</span> *tenl;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         <span class="comment">/* Skip to last line of expansion */</span>
<a name="l00451"></a>00451         <span class="keywordflow">while</span> ((tenl = strchr(t, <span class="charliteral">'\n'</span>)) &amp;&amp; tenl &lt; te)
<a name="l00452"></a>00452             t = ++tenl;
<a name="l00453"></a>00453 
<a name="l00454"></a>00454         <span class="comment">/* Limit expand output */</span>
<a name="l00455"></a>00455         choplen = 61 - (2 * mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l00456"></a>00456         <span class="keywordflow">if</span> ((te - t) &gt; choplen) {
<a name="l00457"></a>00457             te = t + choplen;
<a name="l00458"></a>00458             ellipsis = <span class="stringliteral">"..."</span>;
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460     }
<a name="l00461"></a>00461 
<a name="l00462"></a>00462     fprintf(stderr, <span class="stringliteral">"%3d&lt;%*s"</span>, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>, (2 * mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> + 1), <span class="stringliteral">""</span>);
<a name="l00463"></a>00463     <span class="keywordflow">if</span> (te &gt; t)
<a name="l00464"></a>00464         fprintf(stderr, <span class="stringliteral">"%.*s%s"</span>, (<span class="keywordtype">int</span>)(te - t), t, ellipsis);
<a name="l00465"></a>00465     fprintf(stderr, <span class="stringliteral">"\n"</span>);
<a name="l00466"></a>00466 }
<a name="l00467"></a>00467 
<a name="l00468"></a><a class="code" href="macro_8c.html#98b7074538fdb646782dba735da571ec">00468</a> <span class="preprocessor">#define SKIPBLANK(_s, _c)       \</span>
<a name="l00469"></a>00469 <span class="preprocessor">        </span><span class="comment">/*@-globs@*/</span>    <span class="comment">/* FIX: __ctype_b */</span> \
<a name="l00470"></a>00470         while (((_c) = *(_s)) &amp;&amp; isblank(_c)) \
<a name="l00471"></a>00471                 (_s)++;         \
<a name="l00472"></a>00472         <span class="comment">/*@=globs@*/</span>
<a name="l00473"></a>00473 
<a name="l00474"></a><a class="code" href="macro_8c.html#5579d5c031e4a534f6afcae00a680f69">00474</a> <span class="preprocessor">#define SKIPNONBLANK(_s, _c)    \</span>
<a name="l00475"></a>00475 <span class="preprocessor">        </span><span class="comment">/*@-globs@*/</span>    <span class="comment">/* FIX: __ctype_b */</span> \
<a name="l00476"></a>00476         while (((_c) = *(_s)) &amp;&amp; !(isblank(_c) || iseol(_c))) \
<a name="l00477"></a>00477                 (_s)++;         \
<a name="l00478"></a>00478         <span class="comment">/*@=globs@*/</span>
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="macro_8c.html#af35754467c03fcb8afeaee4db65515d">00480</a> <span class="preprocessor">#define COPYNAME(_ne, _s, _c)   \</span>
<a name="l00481"></a>00481 <span class="preprocessor">    {   SKIPBLANK(_s,_c);       \</span>
<a name="l00482"></a>00482 <span class="preprocessor">        </span><span class="comment">/*@-boundswrite@*/</span>      \
<a name="l00483"></a>00483         while(((_c) = *(_s)) &amp;&amp; (xisalnum(_c) || (_c) == '_')) \
<a name="l00484"></a>00484                 *(_ne)++ = *(_s)++; \
<a name="l00485"></a>00485         *(_ne) = '\0';          \
<a name="l00486"></a>00486         <span class="comment">/*@=boundswrite@*/</span>      \
<a name="l00487"></a>00487     }
<a name="l00488"></a>00488 
<a name="l00489"></a><a class="code" href="macro_8c.html#205cc1318c8501123a2635c18ff8ac38">00489</a> <span class="preprocessor">#define COPYOPTS(_oe, _s, _c)   \</span>
<a name="l00490"></a>00490 <span class="preprocessor">    {   </span><span class="comment">/*@-boundswrite@*/</span>      \
<a name="l00491"></a>00491         while(((_c) = *(_s)) &amp;&amp; (_c) != ')') \
<a name="l00492"></a>00492                 *(_oe)++ = *(_s)++; \
<a name="l00493"></a>00493         *(_oe) = '\0';          \
<a name="l00494"></a>00494         <span class="comment">/*@=boundswrite@*/</span>      \
<a name="l00495"></a>00495     }
<a name="l00496"></a>00496 
<a name="l00504"></a>00504 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00505"></a><a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b">00505</a> <a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b" title="Save source and expand field into target.">expandT</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keyword">const</span> <span class="keywordtype">char</span> * f, <span class="keywordtype">size_t</span> flen)
<a name="l00506"></a>00506         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem@*/</span>
<a name="l00507"></a>00507         <span class="comment">/*@modifies mb, rpmGlobalMacroContext, fileSystem @*/</span>
<a name="l00508"></a>00508 {
<a name="l00509"></a>00509     <span class="keywordtype">char</span> *sbuf;
<a name="l00510"></a>00510     <span class="keyword">const</span> <span class="keywordtype">char</span> *s = mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a>;
<a name="l00511"></a>00511     <span class="keywordtype">int</span> rc;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513     sbuf = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(flen + 1);
<a name="l00514"></a>00514     memset(sbuf, 0, (flen + 1));
<a name="l00515"></a>00515 
<a name="l00516"></a>00516     strncpy(sbuf, f, flen);
<a name="l00517"></a>00517     sbuf[flen] = <span class="charliteral">'\0'</span>;
<a name="l00518"></a>00518     mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a> = sbuf;
<a name="l00519"></a>00519     rc = <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(mb);
<a name="l00520"></a>00520     mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a> = s;
<a name="l00521"></a>00521     <span class="keywordflow">return</span> rc;
<a name="l00522"></a>00522 }
<a name="l00523"></a>00523 
<a name="l00524"></a>00524 <span class="preprocessor">#if 0</span>
<a name="l00525"></a>00525 <span class="preprocessor"></span>
<a name="l00532"></a>00532 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00533"></a>00533 expandS(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keywordtype">char</span> * tbuf, <span class="keywordtype">size_t</span> tbuflen)
<a name="l00534"></a>00534         <span class="comment">/*@globals rpmGlobalMacroContext, fileSystem@*/</span>
<a name="l00535"></a>00535         <span class="comment">/*@modifies mb, *tbuf, rpmGlobalMacroContext, fileSystem @*/</span>
<a name="l00536"></a>00536 {
<a name="l00537"></a>00537     <span class="keyword">const</span> <span class="keywordtype">char</span> *t = mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>;
<a name="l00538"></a>00538     <span class="keywordtype">size_t</span> nb = mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a>;
<a name="l00539"></a>00539     <span class="keywordtype">int</span> rc;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541     mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a> = tbuf;
<a name="l00542"></a>00542     mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> = tbuflen;
<a name="l00543"></a>00543     rc = <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(mb);
<a name="l00544"></a>00544     mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a> = t;
<a name="l00545"></a>00545     mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> = nb;
<a name="l00546"></a>00546     <span class="keywordflow">return</span> rc;
<a name="l00547"></a>00547 }
<a name="l00548"></a>00548 <span class="preprocessor">#endif</span>
<a name="l00549"></a>00549 <span class="preprocessor"></span>
<a name="l00557"></a>00557 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00558"></a>00558 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00559"></a><a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7">00559</a> <a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7" title="Save source/target and expand macro in u.">expandU</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keywordtype">char</span> * u, <span class="keywordtype">size_t</span> ulen)
<a name="l00560"></a>00560         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem@*/</span>
<a name="l00561"></a>00561         <span class="comment">/*@modifies mb, *u, rpmGlobalMacroContext, fileSystem @*/</span>
<a name="l00562"></a>00562 {
<a name="l00563"></a>00563     <span class="keyword">const</span> <span class="keywordtype">char</span> *s = mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a>;
<a name="l00564"></a>00564     <span class="keywordtype">char</span> *t = mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>;
<a name="l00565"></a>00565     <span class="keywordtype">size_t</span> nb = mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a>;
<a name="l00566"></a>00566     <span class="keywordtype">char</span> *tbuf;
<a name="l00567"></a>00567     <span class="keywordtype">int</span> rc;
<a name="l00568"></a>00568 
<a name="l00569"></a>00569     tbuf = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(ulen + 1);
<a name="l00570"></a>00570     memset(tbuf, 0, (ulen + 1));
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a> = u;
<a name="l00573"></a>00573     mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a> = tbuf;
<a name="l00574"></a>00574     mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> = ulen;
<a name="l00575"></a>00575     rc = <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(mb);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     tbuf[ulen] = <span class="charliteral">'\0'</span>;  <span class="comment">/* XXX just in case */</span>
<a name="l00578"></a>00578     <span class="keywordflow">if</span> (ulen &gt; mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a>)
<a name="l00579"></a>00579         strncpy(u, tbuf, (ulen - mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> + 1));
<a name="l00580"></a>00580 
<a name="l00581"></a>00581     mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a> = s;
<a name="l00582"></a>00582     mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a> = t;
<a name="l00583"></a>00583     mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> = nb;
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="keywordflow">return</span> rc;
<a name="l00586"></a>00586 }
<a name="l00587"></a>00587 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00588"></a>00588 
<a name="l00596"></a>00596 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00597"></a>00597 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00598"></a><a class="code" href="macro_8c.html#812b62764f4d597b56f87eb826f86bda">00598</a> <a class="code" href="macro_8c.html#812b62764f4d597b56f87eb826f86bda" title="Expand output of shell command into target buffer.">doShellEscape</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keyword">const</span> <span class="keywordtype">char</span> * cmd, <span class="keywordtype">size_t</span> clen)
<a name="l00599"></a>00599         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem @*/</span>
<a name="l00600"></a>00600         <span class="comment">/*@modifies mb, rpmGlobalMacroContext, fileSystem @*/</span>
<a name="l00601"></a>00601 {
<a name="l00602"></a>00602     <span class="keywordtype">char</span> pcmd[BUFSIZ];
<a name="l00603"></a>00603     FILE *shf;
<a name="l00604"></a>00604     <span class="keywordtype">int</span> rc;
<a name="l00605"></a>00605     <span class="keywordtype">int</span> c;
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">if</span> (clen &gt;= <span class="keyword">sizeof</span>(pcmd)) {
<a name="l00608"></a>00608         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Target buffer overflow\n"</span>));
<a name="l00609"></a>00609         <span class="keywordflow">return</span> 1;
<a name="l00610"></a>00610     }
<a name="l00611"></a>00611 
<a name="l00612"></a>00612     strncpy(pcmd, cmd, clen);
<a name="l00613"></a>00613     pcmd[clen] = <span class="charliteral">'\0'</span>;
<a name="l00614"></a>00614     rc = <a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7" title="Save source/target and expand macro in u.">expandU</a>(mb, pcmd, <span class="keyword">sizeof</span>(pcmd));
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (rc)
<a name="l00616"></a>00616         <span class="keywordflow">return</span> rc;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618     <span class="keywordflow">if</span> ((shf = popen(pcmd, <span class="stringliteral">"r"</span>)) == NULL)
<a name="l00619"></a>00619         <span class="keywordflow">return</span> 1;
<a name="l00620"></a>00620     <span class="keywordflow">while</span>(mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> &gt; 0 &amp;&amp; (c = fgetc(shf)) != EOF)
<a name="l00621"></a>00621         <a class="code" href="macro_8c.html#0bf86a73152948baeb778eff132508f9">SAVECHAR</a>(mb, c);
<a name="l00622"></a>00622     (void) pclose(shf);
<a name="l00623"></a>00623 
<a name="l00624"></a>00624     <span class="comment">/* XXX delete trailing \r \n */</span>
<a name="l00625"></a>00625     <span class="keywordflow">while</span> (<a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(mb-&gt;t[-1])) {
<a name="l00626"></a>00626         *(mb-&gt;t--) = <span class="charliteral">'\0'</span>;
<a name="l00627"></a>00627         mb-&gt;nb++;
<a name="l00628"></a>00628     }
<a name="l00629"></a>00629     <span class="keywordflow">return</span> 0;
<a name="l00630"></a>00630 }
<a name="l00631"></a>00631 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00632"></a>00632 
<a name="l00641"></a>00641 <span class="comment">/*@dependent@*/</span> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00642"></a><a class="code" href="macro_8c.html#a282776f7081c9e47a0299cf2a103edf">00642</a> <a class="code" href="macro_8c.html#a282776f7081c9e47a0299cf2a103edf" title="Parse (and execute) new macro definition.">doDefine</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="comment">/*@returned@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * se, <span class="keywordtype">int</span> <a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a>, <span class="keywordtype">int</span> expandbody)
<a name="l00643"></a>00643         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno @*/</span>
<a name="l00644"></a>00644         <span class="comment">/*@modifies mb, rpmGlobalMacroContext @*/</span>
<a name="l00645"></a>00645 {
<a name="l00646"></a>00646     <span class="keyword">const</span> <span class="keywordtype">char</span> *s = se;
<a name="l00647"></a>00647     <span class="keywordtype">char</span> buf[BUFSIZ], *n = buf, *ne = n;
<a name="l00648"></a>00648     <span class="keywordtype">char</span> *o = NULL, *oe;
<a name="l00649"></a>00649     <span class="keywordtype">char</span> *b, *be;
<a name="l00650"></a>00650     <span class="keywordtype">int</span> c;
<a name="l00651"></a>00651     <span class="keywordtype">int</span> oc = <span class="charliteral">')'</span>;
<a name="l00652"></a>00652 
<a name="l00653"></a>00653     <span class="comment">/* Copy name */</span>
<a name="l00654"></a>00654     <a class="code" href="macro_8c.html#af35754467c03fcb8afeaee4db65515d">COPYNAME</a>(ne, s, c);
<a name="l00655"></a>00655 
<a name="l00656"></a>00656     <span class="comment">/* Copy opts (if present) */</span>
<a name="l00657"></a>00657     oe = ne + 1;
<a name="l00658"></a>00658     <span class="keywordflow">if</span> (*s == <span class="charliteral">'('</span>) {
<a name="l00659"></a>00659         s++;    <span class="comment">/* skip ( */</span>
<a name="l00660"></a>00660         o = oe;
<a name="l00661"></a>00661         <a class="code" href="macro_8c.html#205cc1318c8501123a2635c18ff8ac38">COPYOPTS</a>(oe, s, oc);
<a name="l00662"></a>00662         s++;    <span class="comment">/* skip ) */</span>
<a name="l00663"></a>00663     }
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     <span class="comment">/* Copy body, skipping over escaped newlines */</span>
<a name="l00666"></a>00666     b = be = oe + 1;
<a name="l00667"></a>00667     <a class="code" href="macro_8c.html#98b7074538fdb646782dba735da571ec">SKIPBLANK</a>(s, c);
<a name="l00668"></a>00668     <span class="keywordflow">if</span> (c == <span class="charliteral">'{'</span>) {     <span class="comment">/* XXX permit silent {...} grouping */</span>
<a name="l00669"></a>00669         <span class="keywordflow">if</span> ((se = <a class="code" href="macro_8c.html#f1b5b252eab18ae1b8437773be437797" title="Return text between pl and matching pr characters.">matchchar</a>(s, c, <span class="charliteral">'}'</span>)) == NULL) {
<a name="l00670"></a>00670             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l00671"></a>00671                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s has unterminated body\n"</span>), n);
<a name="l00672"></a>00672             se = s;     <span class="comment">/* XXX W2DO? */</span>
<a name="l00673"></a>00673             <span class="keywordflow">return</span> se;
<a name="l00674"></a>00674         }
<a name="l00675"></a>00675         s++;    <span class="comment">/* XXX skip { */</span>
<a name="l00676"></a>00676 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00677"></a>00677         strncpy(b, s, (se - s));
<a name="l00678"></a>00678         b[se - s] = <span class="charliteral">'\0'</span>;
<a name="l00679"></a>00679 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00680"></a>00680         be += strlen(b);
<a name="l00681"></a>00681         se++;   <span class="comment">/* XXX skip } */</span>
<a name="l00682"></a>00682         s = se; <span class="comment">/* move scan forward */</span>
<a name="l00683"></a>00683     } <span class="keywordflow">else</span> {    <span class="comment">/* otherwise free-field */</span>
<a name="l00684"></a>00684 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00685"></a>00685         <span class="keywordtype">int</span> bc = 0, pc = 0;
<a name="l00686"></a>00686         <span class="keywordflow">while</span> (*s &amp;&amp; (bc || pc || !<a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(*s))) {
<a name="l00687"></a>00687             <span class="keywordflow">switch</span> (*s) {
<a name="l00688"></a>00688                 <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
<a name="l00689"></a>00689                     <span class="keywordflow">switch</span> (*(s+1)) {
<a name="l00690"></a>00690                         <span class="keywordflow">case</span> <span class="charliteral">'\0'</span>: <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00691"></a>00691                         <span class="keywordflow">default</span>: s++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00692"></a>00692                     }
<a name="l00693"></a>00693                     <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00694"></a>00694                 <span class="keywordflow">case</span> <span class="charliteral">'%'</span>:
<a name="l00695"></a>00695                     <span class="keywordflow">switch</span> (*(s+1)) {
<a name="l00696"></a>00696                         <span class="keywordflow">case</span> <span class="charliteral">'{'</span>: *be++ = *s++; bc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00697"></a>00697                         <span class="keywordflow">case</span> <span class="charliteral">'('</span>: *be++ = *s++; pc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00698"></a>00698                         <span class="keywordflow">case</span> <span class="charliteral">'%'</span>: *be++ = *s++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00699"></a>00699                     }
<a name="l00700"></a>00700                     <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00701"></a>00701                 <span class="keywordflow">case</span> <span class="charliteral">'{'</span>: <span class="keywordflow">if</span> (bc &gt; 0) bc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00702"></a>00702                 <span class="keywordflow">case</span> <span class="charliteral">'}'</span>: <span class="keywordflow">if</span> (bc &gt; 0) bc--; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00703"></a>00703                 <span class="keywordflow">case</span> <span class="charliteral">'('</span>: <span class="keywordflow">if</span> (pc &gt; 0) pc++; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00704"></a>00704                 <span class="keywordflow">case</span> <span class="charliteral">')'</span>: <span class="keywordflow">if</span> (pc &gt; 0) pc--; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00705"></a>00705             }
<a name="l00706"></a>00706             *be++ = *s++;
<a name="l00707"></a>00707         }
<a name="l00708"></a>00708         *be = <span class="charliteral">'\0'</span>;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710         <span class="keywordflow">if</span> (bc || pc) {
<a name="l00711"></a>00711             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l00712"></a>00712                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s has unterminated body\n"</span>), n);
<a name="l00713"></a>00713             se = s;     <span class="comment">/* XXX W2DO? */</span>
<a name="l00714"></a>00714             <span class="keywordflow">return</span> se;
<a name="l00715"></a>00715         }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717         <span class="comment">/* Trim trailing blanks/newlines */</span>
<a name="l00718"></a>00718 <span class="comment">/*@-globs@*/</span>
<a name="l00719"></a>00719         <span class="keywordflow">while</span> (--be &gt;= b &amp;&amp; (c = *be) &amp;&amp; (<a class="code" href="macro_8c.html#71b921c86d024ec3342964ac68dffc64">isblank</a>(c) || <a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(c)))
<a name="l00720"></a>00720             {};
<a name="l00721"></a>00721 <span class="comment">/*@=globs@*/</span>
<a name="l00722"></a>00722         *(++be) = <span class="charliteral">'\0'</span>; <span class="comment">/* one too far */</span>
<a name="l00723"></a>00723 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="comment">/* Move scan over body */</span>
<a name="l00727"></a>00727     <span class="keywordflow">while</span> (<a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(*s))
<a name="l00728"></a>00728         s++;
<a name="l00729"></a>00729     se = s;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="comment">/* Names must start with alphabetic or _ and be at least 3 chars */</span>
<a name="l00732"></a>00732     <span class="keywordflow">if</span> (!((c = *n) &amp;&amp; (<a class="code" href="rpmio_8h.html#a910cf932e70fbf9fb60c074cb30baec">xisalpha</a>(c) || c == <span class="charliteral">'_'</span>) &amp;&amp; (ne - n) &gt; 2)) {
<a name="l00733"></a>00733         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l00734"></a>00734                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s has illegal name (%%define)\n"</span>), n);
<a name="l00735"></a>00735         <span class="keywordflow">return</span> se;
<a name="l00736"></a>00736     }
<a name="l00737"></a>00737 
<a name="l00738"></a>00738     <span class="comment">/* Options must be terminated with ')' */</span>
<a name="l00739"></a>00739     <span class="keywordflow">if</span> (o &amp;&amp; oc != <span class="charliteral">')'</span>) {
<a name="l00740"></a>00740         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s has unterminated opts\n"</span>), n);
<a name="l00741"></a>00741         <span class="keywordflow">return</span> se;
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="keywordflow">if</span> ((be - b) &lt; 1) {
<a name="l00745"></a>00745         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s has empty body\n"</span>), n);
<a name="l00746"></a>00746         <span class="keywordflow">return</span> se;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748 
<a name="l00749"></a>00749 <span class="comment">/*@-modfilesys@*/</span>
<a name="l00750"></a>00750     <span class="keywordflow">if</span> (expandbody &amp;&amp; <a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7" title="Save source/target and expand macro in u.">expandU</a>(mb, b, (&amp;buf[<span class="keyword">sizeof</span>(buf)] - b))) {
<a name="l00751"></a>00751         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s failed to expand\n"</span>), n);
<a name="l00752"></a>00752         <span class="keywordflow">return</span> se;
<a name="l00753"></a>00753     }
<a name="l00754"></a>00754 <span class="comment">/*@=modfilesys@*/</span>
<a name="l00755"></a>00755 
<a name="l00756"></a>00756     <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, n, o, b, (level - 1));
<a name="l00757"></a>00757 
<a name="l00758"></a>00758     <span class="keywordflow">return</span> se;
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00767"></a>00767 <span class="comment">/*@dependent@*/</span> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00768"></a><a class="code" href="macro_8c.html#5110a6d78f9f2aeb8577ce94d33b4b1d">00768</a> <a class="code" href="macro_8c.html#5110a6d78f9f2aeb8577ce94d33b4b1d" title="Parse (and execute) macro undefinition.">doUndefine</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="comment">/*@returned@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * se)
<a name="l00769"></a>00769         <span class="comment">/*@globals rpmGlobalMacroContext @*/</span>
<a name="l00770"></a>00770         <span class="comment">/*@modifies mc, rpmGlobalMacroContext @*/</span>
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772     <span class="keyword">const</span> <span class="keywordtype">char</span> *s = se;
<a name="l00773"></a>00773     <span class="keywordtype">char</span> buf[BUFSIZ], *n = buf, *ne = n;
<a name="l00774"></a>00774     <span class="keywordtype">int</span> c;
<a name="l00775"></a>00775 
<a name="l00776"></a>00776     <a class="code" href="macro_8c.html#af35754467c03fcb8afeaee4db65515d">COPYNAME</a>(ne, s, c);
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="comment">/* Move scan over body */</span>
<a name="l00779"></a>00779     <span class="keywordflow">while</span> (<a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(*s))
<a name="l00780"></a>00780         s++;
<a name="l00781"></a>00781     se = s;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783     <span class="comment">/* Names must start with alphabetic or _ and be at least 3 chars */</span>
<a name="l00784"></a>00784     <span class="keywordflow">if</span> (!((c = *n) &amp;&amp; (<a class="code" href="rpmio_8h.html#a910cf932e70fbf9fb60c074cb30baec">xisalpha</a>(c) || c == <span class="charliteral">'_'</span>) &amp;&amp; (ne - n) &gt; 2)) {
<a name="l00785"></a>00785         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l00786"></a>00786                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s has illegal name (%%undefine)\n"</span>), n);
<a name="l00787"></a>00787         <span class="keywordflow">return</span> se;
<a name="l00788"></a>00788     }
<a name="l00789"></a>00789 
<a name="l00790"></a>00790     <a class="code" href="macro_8c.html#6a0c98bd34099103b42dcbae343d8366" title="Delete macro from context.">delMacro</a>(mc, n);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792     <span class="keywordflow">return</span> se;
<a name="l00793"></a>00793 }
<a name="l00794"></a>00794 
<a name="l00795"></a>00795 <span class="preprocessor">#ifdef  DYING</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00797"></a>00797 dumpME(<span class="keyword">const</span> <span class="keywordtype">char</span> * msg, <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me)
<a name="l00798"></a>00798         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l00799"></a>00799         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801     <span class="keywordflow">if</span> (msg)
<a name="l00802"></a>00802         fprintf(stderr, <span class="stringliteral">"%s"</span>, msg);
<a name="l00803"></a>00803     fprintf(stderr, <span class="stringliteral">"\tme %p"</span>, me);
<a name="l00804"></a>00804     <span class="keywordflow">if</span> (me)
<a name="l00805"></a>00805         fprintf(stderr,<span class="stringliteral">"\tname %p(%s) prev %p"</span>,
<a name="l00806"></a>00806                 me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, me-&gt;<a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a>);
<a name="l00807"></a>00807     fprintf(stderr, <span class="stringliteral">"\n"</span>);
<a name="l00808"></a>00808 }
<a name="l00809"></a>00809 <span class="preprocessor">#endif</span>
<a name="l00810"></a>00810 <span class="preprocessor"></span>
<a name="l00819"></a>00819 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00820"></a><a class="code" href="macro_8c.html#1d34891b83f459aa258da314398c6dc2">00820</a> <a class="code" href="macro_8c.html#1d34891b83f459aa258da314398c6dc2" title="Push new macro definition onto macro entry stack.">pushMacro</a>(<span class="comment">/*@out@*/</span> <a class="code" href="structMacroEntry__s.html">MacroEntry</a> * mep,
<a name="l00821"></a>00821                 <span class="keyword">const</span> <span class="keywordtype">char</span> * n, <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * o,
<a name="l00822"></a>00822                 <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * b, <span class="keywordtype">int</span> <a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a>)
<a name="l00823"></a>00823         <span class="comment">/*@modifies *mep @*/</span>
<a name="l00824"></a>00824 {
<a name="l00825"></a>00825     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> <a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a> = (mep &amp;&amp; *mep ? *mep : NULL);
<a name="l00826"></a>00826     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me = (<a class="code" href="structMacroEntry__s.html">MacroEntry</a>) <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(<span class="keyword">sizeof</span>(*me));
<a name="l00827"></a>00827 
<a name="l00828"></a>00828     <span class="comment">/*@-assignexpose@*/</span>
<a name="l00829"></a>00829     me-&gt;prev = <a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a>;
<a name="l00830"></a>00830     <span class="comment">/*@=assignexpose@*/</span>
<a name="l00831"></a>00831     me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a> = (<a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a> ? <a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a>-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a> : <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(n));
<a name="l00832"></a>00832     me-&gt;opts = (o ? <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(o) : NULL);
<a name="l00833"></a>00833     me-&gt;body = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(b ? b : <span class="stringliteral">""</span>);
<a name="l00834"></a>00834     me-&gt;used = 0;
<a name="l00835"></a>00835     me-&gt;level = level;
<a name="l00836"></a>00836 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00837"></a>00837 <span class="comment">/*@-branchstate@*/</span>
<a name="l00838"></a>00838     <span class="keywordflow">if</span> (mep)
<a name="l00839"></a>00839         *mep = me;
<a name="l00840"></a>00840     <span class="keywordflow">else</span>
<a name="l00841"></a>00841         me = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me);
<a name="l00842"></a>00842 <span class="comment">/*@=branchstate@*/</span>
<a name="l00843"></a>00843 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00850"></a>00850 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00851"></a><a class="code" href="macro_8c.html#de97f1374f70353bbc573ee4f8c5b6df">00851</a> <a class="code" href="macro_8c.html#de97f1374f70353bbc573ee4f8c5b6df" title="Pop macro definition from macro entry stack.">popMacro</a>(<a class="code" href="structMacroEntry__s.html">MacroEntry</a> * mep)
<a name="l00852"></a>00852         <span class="comment">/*@modifies *mep @*/</span>
<a name="l00853"></a>00853 {
<a name="l00854"></a>00854         <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me = (*mep ? *mep : NULL);
<a name="l00855"></a>00855 
<a name="l00856"></a>00856 <span class="comment">/*@-branchstate@*/</span>
<a name="l00857"></a>00857         <span class="keywordflow">if</span> (me) {
<a name="l00858"></a>00858                 <span class="comment">/* XXX cast to workaround const */</span>
<a name="l00859"></a>00859                 <span class="comment">/*@-onlytrans@*/</span>
<a name="l00860"></a>00860 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00861"></a>00861                 <span class="keywordflow">if</span> ((*mep = me-&gt;<a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a>) == NULL)
<a name="l00862"></a>00862                         me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>);
<a name="l00863"></a>00863 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00864"></a>00864                 me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a>);
<a name="l00865"></a>00865                 me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>);
<a name="l00866"></a>00866                 me = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me);
<a name="l00867"></a>00867                 <span class="comment">/*@=onlytrans@*/</span>
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869 <span class="comment">/*@=branchstate@*/</span>
<a name="l00870"></a>00870 }
<a name="l00871"></a>00871 
<a name="l00876"></a>00876 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l00877"></a><a class="code" href="macro_8c.html#b5c4b77d14ec0ffebaa1d0ad09d30c26">00877</a> <a class="code" href="macro_8c.html#b5c4b77d14ec0ffebaa1d0ad09d30c26" title="Free parsed arguments for parameterized macro.">freeArgs</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb)
<a name="l00878"></a>00878         <span class="comment">/*@modifies mb @*/</span>
<a name="l00879"></a>00879 {
<a name="l00880"></a>00880     <a class="code" href="structMacroContext__s.html">MacroContext</a> mc = mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>;
<a name="l00881"></a>00881     <span class="keywordtype">int</span> ndeleted = 0;
<a name="l00882"></a>00882     <span class="keywordtype">int</span> i;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884     <span class="keywordflow">if</span> (mc == NULL || mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> == NULL)
<a name="l00885"></a>00885         <span class="keywordflow">return</span>;
<a name="l00886"></a>00886 
<a name="l00887"></a>00887     <span class="comment">/* Delete dynamic macro definitions */</span>
<a name="l00888"></a>00888     <span class="keywordflow">for</span> (i = 0; i &lt; mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>; i++) {
<a name="l00889"></a>00889         <a class="code" href="structMacroEntry__s.html">MacroEntry</a> *mep, me;
<a name="l00890"></a>00890         <span class="keywordtype">int</span> skiptest = 0;
<a name="l00891"></a>00891         mep = &amp;mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[i];
<a name="l00892"></a>00892         me = *mep;
<a name="l00893"></a>00893 
<a name="l00894"></a>00894         <span class="keywordflow">if</span> (me == NULL)         <span class="comment">/* XXX this should never happen */</span>
<a name="l00895"></a>00895             <span class="keywordflow">continue</span>;
<a name="l00896"></a>00896         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a> &lt; mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>)
<a name="l00897"></a>00897             <span class="keywordflow">continue</span>;
<a name="l00898"></a>00898         if (strlen(me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>) == 1 &amp;&amp; strchr(<span class="stringliteral">"#*0"</span>, *me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>)) {
<a name="l00899"></a>00899             if (*me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a> == <span class="charliteral">'*'</span> &amp;&amp; me-&gt;<a class="code" href="structMacroEntry__s.html#db171f6db8fc31e50da77e9e6e460416">used</a> &gt; 0)
<a name="l00900"></a>00900                 skiptest = 1; <span class="comment">/* XXX skip test for %# %* %0 */</span>
<a name="l00901"></a>00901         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!skiptest &amp;&amp; me-&gt;<a class="code" href="structMacroEntry__s.html#db171f6db8fc31e50da77e9e6e460416">used</a> &lt;= 0) {
<a name="l00902"></a>00902 #<span class="keywordflow">if</span> NOTYET
<a name="l00903"></a>00903             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l00904"></a>00904                         <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%s (%s) was not used below level %d\n"</span>),
<a name="l00905"></a>00905                         me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>, me-&gt;<a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a>);
<a name="l00906"></a>00906 #endif
<a name="l00907"></a>00907         }
<a name="l00908"></a>00908         <a class="code" href="macro_8c.html#de97f1374f70353bbc573ee4f8c5b6df" title="Pop macro definition from macro entry stack.">popMacro</a>(mep);
<a name="l00909"></a>00909         <span class="keywordflow">if</span> (!(mep &amp;&amp; *mep))
<a name="l00910"></a>00910             ndeleted++;
<a name="l00911"></a>00911     }
<a name="l00912"></a>00912 
<a name="l00913"></a>00913     <span class="comment">/* If any deleted macros, sort macro table */</span>
<a name="l00914"></a>00914     <span class="keywordflow">if</span> (ndeleted)
<a name="l00915"></a>00915         <a class="code" href="macro_8c.html#41b48bc6dda66614c6d072c631b948ea" title="Sort entries in macro table.">sortMacroTable</a>(mc);
<a name="l00916"></a>00916 }
<a name="l00917"></a>00917 
<a name="l00927"></a>00927 <span class="comment">/*@-bounds@*/</span>
<a name="l00928"></a>00928 <span class="comment">/*@dependent@*/</span> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l00929"></a><a class="code" href="macro_8c.html#8f6890158b634b075b87b42cd8422da9">00929</a> <a class="code" href="macro_8c.html#8f6890158b634b075b87b42cd8422da9" title="Parse arguments (to next new line) for parameterized macro.">grabArgs</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keyword">const</span> <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me, <span class="comment">/*@returned@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * se,
<a name="l00930"></a>00930                 <span class="keyword">const</span> <span class="keywordtype">char</span> * lastc)
<a name="l00931"></a>00931         <span class="comment">/*@globals rpmGlobalMacroContext @*/</span>
<a name="l00932"></a>00932         <span class="comment">/*@modifies mb, rpmGlobalMacroContext @*/</span>
<a name="l00933"></a>00933 {
<a name="l00934"></a>00934     <span class="keywordtype">char</span> buf[BUFSIZ], *b, *be;
<a name="l00935"></a>00935     <span class="keywordtype">char</span> aname[16];
<a name="l00936"></a>00936     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a>, *o;
<a name="l00937"></a>00937     <span class="keywordtype">int</span> argc = 0;
<a name="l00938"></a>00938     <span class="keyword">const</span> <span class="keywordtype">char</span> **<a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>;
<a name="l00939"></a>00939     <span class="keywordtype">int</span> c;
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="comment">/* Copy macro name as argv[0], save beginning of args.  */</span>
<a name="l00942"></a>00942     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l00943"></a>00943     b = be = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(buf, me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>);
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"0"</span>, NULL, buf, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l00946"></a>00946     
<a name="l00947"></a>00947     argc = 1;   <span class="comment">/* XXX count argv[0] */</span>
<a name="l00948"></a>00948 
<a name="l00949"></a>00949     <span class="comment">/* Copy args into buf until lastc */</span>
<a name="l00950"></a>00950     *be++ = <span class="charliteral">' '</span>;
<a name="l00951"></a>00951     <span class="keywordflow">while</span> ((c = *se++) != <span class="charliteral">'\0'</span> &amp;&amp; (se-1) != lastc) {
<a name="l00952"></a>00952 <span class="comment">/*@-globs@*/</span>
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (!<a class="code" href="macro_8c.html#71b921c86d024ec3342964ac68dffc64">isblank</a>(c)) {
<a name="l00954"></a>00954             *be++ = c;
<a name="l00955"></a>00955             <span class="keywordflow">continue</span>;
<a name="l00956"></a>00956         }
<a name="l00957"></a>00957 <span class="comment">/*@=globs@*/</span>
<a name="l00958"></a>00958         <span class="comment">/* c is blank */</span>
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (be[-1] == <span class="charliteral">' '</span>)
<a name="l00960"></a>00960             <span class="keywordflow">continue</span>;
<a name="l00961"></a>00961         <span class="comment">/* a word has ended */</span>
<a name="l00962"></a>00962         *be++ = <span class="charliteral">' '</span>;
<a name="l00963"></a>00963         argc++;
<a name="l00964"></a>00964     }
<a name="l00965"></a>00965     <span class="keywordflow">if</span> (c == <span class="charliteral">'\0'</span>) se--;        <span class="comment">/* one too far */</span>
<a name="l00966"></a>00966     <span class="keywordflow">if</span> (be[-1] != <span class="charliteral">' '</span>)
<a name="l00967"></a>00967         argc++, be++;           <span class="comment">/* last word has not trailing ' ' */</span>
<a name="l00968"></a>00968     be[-1] = <span class="charliteral">'\0'</span>;
<a name="l00969"></a>00969     <span class="keywordflow">if</span> (*b == <span class="charliteral">' '</span>) b++;         <span class="comment">/* skip the leading ' ' */</span>
<a name="l00970"></a>00970 
<a name="l00971"></a>00971 <span class="comment">/*</span>
<a name="l00972"></a>00972 <span class="comment"> * The macro %* analoguous to the shell's $* means "Pass all non-macro</span>
<a name="l00973"></a>00973 <span class="comment"> * parameters." Consequently, there needs to be a macro that means "Pass all</span>
<a name="l00974"></a>00974 <span class="comment"> * (including macro parameters) options". This is useful for verifying</span>
<a name="l00975"></a>00975 <span class="comment"> * parameters during expansion and yet transparently passing all parameters</span>
<a name="l00976"></a>00976 <span class="comment"> * through for higher level processing (e.g. %description and/or %setup).</span>
<a name="l00977"></a>00977 <span class="comment"> * This is the (potential) justification for %{**} ...</span>
<a name="l00978"></a>00978 <span class="comment"> */</span>
<a name="l00979"></a>00979     <span class="comment">/* Add unexpanded args as macro */</span>
<a name="l00980"></a>00980     <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"**"</span>, NULL, b, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l00981"></a>00981 
<a name="l00982"></a>00982 <span class="preprocessor">#ifdef NOTYET</span>
<a name="l00983"></a>00983 <span class="preprocessor"></span>    <span class="comment">/* XXX if macros can be passed as args ... */</span>
<a name="l00984"></a>00984     <a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7" title="Save source/target and expand macro in u.">expandU</a>(mb, buf, <span class="keyword">sizeof</span>(buf));
<a name="l00985"></a>00985 <span class="preprocessor">#endif</span>
<a name="l00986"></a>00986 <span class="preprocessor"></span>
<a name="l00987"></a>00987     <span class="comment">/* Build argv array */</span>
<a name="l00988"></a>00988     argv = (<span class="keyword">const</span> <span class="keywordtype">char</span> **) <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>((argc + 1) * <span class="keyword">sizeof</span>(*argv));
<a name="l00989"></a>00989     be[-1] = <span class="charliteral">' '</span>; <span class="comment">/* assert((be - 1) == (b + strlen(b) == buf + strlen(buf))) */</span>
<a name="l00990"></a>00990     be[0] = <span class="charliteral">'\0'</span>;
<a name="l00991"></a>00991     b = buf;
<a name="l00992"></a>00992     <span class="keywordflow">for</span> (c = 0; c &lt; argc; c++) {
<a name="l00993"></a>00993         argv[c] = b;
<a name="l00994"></a>00994         b = strchr(b, <span class="charliteral">' '</span>);
<a name="l00995"></a>00995         *b++ = <span class="charliteral">'\0'</span>;
<a name="l00996"></a>00996     }
<a name="l00997"></a>00997     <span class="comment">/* assert(b == be);  */</span>
<a name="l00998"></a>00998     argv[argc] = NULL;
<a name="l00999"></a>00999 
<a name="l01000"></a>01000     <span class="comment">/* Citation from glibc/posix/getopt.c:</span>
<a name="l01001"></a>01001 <span class="comment">     *    Index in ARGV of the next element to be scanned.</span>
<a name="l01002"></a>01002 <span class="comment">     *    This is used for communication to and from the caller</span>
<a name="l01003"></a>01003 <span class="comment">     *    and for communication between successive calls to `getopt'.</span>
<a name="l01004"></a>01004 <span class="comment">     *</span>
<a name="l01005"></a>01005 <span class="comment">     *    On entry to `getopt', zero means this is the first call; initialize.</span>
<a name="l01006"></a>01006 <span class="comment">     *</span>
<a name="l01007"></a>01007 <span class="comment">     *    When `getopt' returns -1, this is the index of the first of the</span>
<a name="l01008"></a>01008 <span class="comment">     *    non-option elements that the caller should itself scan.</span>
<a name="l01009"></a>01009 <span class="comment">     *</span>
<a name="l01010"></a>01010 <span class="comment">     *    Otherwise, `optind' communicates from one call to the next</span>
<a name="l01011"></a>01011 <span class="comment">     *    how much of ARGV has been scanned so far.</span>
<a name="l01012"></a>01012 <span class="comment">     */</span>
<a name="l01013"></a>01013     <span class="comment">/* 1003.2 says this must be 1 before any call.  */</span>
<a name="l01014"></a>01014 
<a name="l01015"></a>01015 <span class="preprocessor">#ifdef __GLIBC__</span>
<a name="l01016"></a>01016 <span class="preprocessor"></span>    <span class="comment">/*@-mods@*/</span>
<a name="l01017"></a>01017     optind = 0;         <span class="comment">/* XXX but posix != glibc */</span>
<a name="l01018"></a>01018     <span class="comment">/*@=mods@*/</span>
<a name="l01019"></a>01019 <span class="preprocessor">#else</span>
<a name="l01020"></a>01020 <span class="preprocessor"></span>    optind = 1;
<a name="l01021"></a>01021 <span class="preprocessor">#endif</span>
<a name="l01022"></a>01022 <span class="preprocessor"></span>
<a name="l01023"></a>01023     opts = me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a>;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     <span class="comment">/* Define option macros. */</span>
<a name="l01026"></a>01026 <span class="comment">/*@-nullstate@*/</span> <span class="comment">/* FIX: argv[] can be NULL */</span>
<a name="l01027"></a>01027     <span class="keywordflow">while</span>((c = getopt(argc, (<span class="keywordtype">char</span> **)argv, opts)) != -1)
<a name="l01028"></a>01028 <span class="comment">/*@=nullstate@*/</span>
<a name="l01029"></a>01029     {
<a name="l01030"></a>01030         <span class="keywordflow">if</span> (c == <span class="charliteral">'?'</span> || (o = strchr(opts, c)) == NULL) {
<a name="l01031"></a>01031             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unknown option %c in %s(%s)\n"</span>),
<a name="l01032"></a>01032                         (<span class="keywordtype">char</span>)c, me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, opts);
<a name="l01033"></a>01033             <span class="keywordflow">return</span> se;
<a name="l01034"></a>01034         }
<a name="l01035"></a>01035         *be++ = <span class="charliteral">'-'</span>;
<a name="l01036"></a>01036         *be++ = c;
<a name="l01037"></a>01037         <span class="keywordflow">if</span> (o[1] == <span class="charliteral">':'</span>) {
<a name="l01038"></a>01038             *be++ = <span class="charliteral">' '</span>;
<a name="l01039"></a>01039             be = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(be, optarg);
<a name="l01040"></a>01040         }
<a name="l01041"></a>01041         *be++ = <span class="charliteral">'\0'</span>;
<a name="l01042"></a>01042         aname[0] = <span class="charliteral">'-'</span>; aname[1] = c; aname[2] = <span class="charliteral">'\0'</span>;
<a name="l01043"></a>01043         <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, aname, NULL, b, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01044"></a>01044         <span class="keywordflow">if</span> (o[1] == <span class="charliteral">':'</span>) {
<a name="l01045"></a>01045             aname[0] = <span class="charliteral">'-'</span>; aname[1] = c; aname[2] = <span class="charliteral">'*'</span>; aname[3] = <span class="charliteral">'\0'</span>;
<a name="l01046"></a>01046             <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, aname, NULL, optarg, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01047"></a>01047         }
<a name="l01048"></a>01048         be = b; <span class="comment">/* reuse the space */</span>
<a name="l01049"></a>01049     }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <span class="comment">/* Add arg count as macro. */</span>
<a name="l01052"></a>01052     sprintf(aname, <span class="stringliteral">"%d"</span>, (argc - optind));
<a name="l01053"></a>01053     <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"#"</span>, NULL, aname, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01054"></a>01054 
<a name="l01055"></a>01055     <span class="comment">/* Add macro for each arg. Concatenate args for %*. */</span>
<a name="l01056"></a>01056     <span class="keywordflow">if</span> (be) {
<a name="l01057"></a>01057         *be = <span class="charliteral">'\0'</span>;
<a name="l01058"></a>01058         <span class="keywordflow">for</span> (c = optind; c &lt; argc; c++) {
<a name="l01059"></a>01059             sprintf(aname, <span class="stringliteral">"%d"</span>, (c - optind + 1));
<a name="l01060"></a>01060             <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, aname, NULL, argv[c], mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01061"></a>01061             <span class="keywordflow">if</span> (be != b) *be++ = <span class="charliteral">' '</span>; <span class="comment">/* Add space between args */</span>
<a name="l01062"></a>01062 <span class="comment">/*@-nullpass@*/</span> <span class="comment">/* FIX: argv[] can be NULL */</span>
<a name="l01063"></a>01063             be = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(be, argv[c]);
<a name="l01064"></a>01064 <span class="comment">/*@=nullpass@*/</span>
<a name="l01065"></a>01065         }
<a name="l01066"></a>01066     }
<a name="l01067"></a>01067 
<a name="l01068"></a>01068     <span class="comment">/* Add unexpanded args as macro. */</span>
<a name="l01069"></a>01069     <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"*"</span>, NULL, b, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01070"></a>01070 
<a name="l01071"></a>01071     <span class="keywordflow">return</span> se;
<a name="l01072"></a>01072 }
<a name="l01073"></a>01073 <span class="comment">/*@=bounds@*/</span>
<a name="l01074"></a>01074 
<a name="l01082"></a>01082 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01083"></a><a class="code" href="macro_8c.html#a902f671031f078e3cb798db8fedc898">01083</a> <a class="code" href="macro_8c.html#a902f671031f078e3cb798db8fedc898" title="Perform macro message output.">doOutput</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keywordtype">int</span> waserror, <span class="keyword">const</span> <span class="keywordtype">char</span> * msg, <span class="keywordtype">size_t</span> msglen)
<a name="l01084"></a>01084         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem @*/</span>
<a name="l01085"></a>01085         <span class="comment">/*@modifies mb, rpmGlobalMacroContext, fileSystem @*/</span>
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <span class="keywordflow">if</span> (msglen &gt;= <span class="keyword">sizeof</span>(buf)) {
<a name="l01090"></a>01090         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Target buffer overflow\n"</span>));
<a name="l01091"></a>01091         msglen = <span class="keyword">sizeof</span>(buf) - 1;
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093     strncpy(buf, msg, msglen);
<a name="l01094"></a>01094     buf[msglen] = <span class="charliteral">'\0'</span>;
<a name="l01095"></a>01095     (void) <a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7" title="Save source/target and expand macro in u.">expandU</a>(mb, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01096"></a>01096     <span class="keywordflow">if</span> (waserror)
<a name="l01097"></a>01097         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <span class="stringliteral">"%s\n"</span>, buf);
<a name="l01098"></a>01098     <span class="keywordflow">else</span>
<a name="l01099"></a>01099         fprintf(stderr, <span class="stringliteral">"%s"</span>, buf);
<a name="l01100"></a>01100 }
<a name="l01101"></a>01101 
<a name="l01111"></a>01111 <span class="keyword">static</span> <span class="keywordtype">void</span>
<a name="l01112"></a><a class="code" href="macro_8c.html#3336f7f09fc4ae14ecadf407b9e17e94">01112</a> <a class="code" href="macro_8c.html#3336f7f09fc4ae14ecadf407b9e17e94" title="Execute macro primitives.">doFoo</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb, <span class="keywordtype">int</span> negate, <span class="keyword">const</span> <span class="keywordtype">char</span> * f, <span class="keywordtype">size_t</span> fn,
<a name="l01113"></a>01113                 <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * g, <span class="keywordtype">size_t</span> gn)
<a name="l01114"></a>01114         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l01115"></a>01115         <span class="comment">/*@modifies mb, rpmGlobalMacroContext, fileSystem, internalState @*/</span>
<a name="l01116"></a>01116 {
<a name="l01117"></a>01117     <span class="keywordtype">char</span> buf[BUFSIZ], *b = NULL, *be;
<a name="l01118"></a>01118     <span class="keywordtype">int</span> c;
<a name="l01119"></a>01119 
<a name="l01120"></a>01120     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l01121"></a>01121     <span class="keywordflow">if</span> (g != NULL) {
<a name="l01122"></a>01122         <span class="keywordflow">if</span> (gn &gt;= <span class="keyword">sizeof</span>(buf)) {
<a name="l01123"></a>01123             <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Target buffer overflow\n"</span>));
<a name="l01124"></a>01124             gn = <span class="keyword">sizeof</span>(buf) - 1;
<a name="l01125"></a>01125         }
<a name="l01126"></a>01126         strncpy(buf, g, gn);
<a name="l01127"></a>01127         buf[gn] = <span class="charliteral">'\0'</span>;
<a name="l01128"></a>01128         (void) <a class="code" href="macro_8c.html#1fd28433338ec64a41b24c4efbcec8d7" title="Save source/target and expand macro in u.">expandU</a>(mb, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01129"></a>01129     }
<a name="l01130"></a>01130     <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"basename"</span>, f, fn)) {
<a name="l01131"></a>01131         <span class="keywordflow">if</span> ((b = strrchr(buf, <span class="charliteral">'/'</span>)) == NULL)
<a name="l01132"></a>01132             b = buf;
<a name="l01133"></a>01133         <span class="keywordflow">else</span>
<a name="l01134"></a>01134             b++;
<a name="l01135"></a>01135 <span class="preprocessor">#if NOTYET</span>
<a name="l01136"></a>01136 <span class="preprocessor"></span>    <span class="comment">/* XXX watchout for conflict with %dir */</span>
<a name="l01137"></a>01137     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"dirname"</span>, f, fn)) {
<a name="l01138"></a>01138         <span class="keywordflow">if</span> ((b = strrchr(buf, <span class="charliteral">'/'</span>)) != NULL)
<a name="l01139"></a>01139             *b = <span class="charliteral">'\0'</span>;
<a name="l01140"></a>01140         b = buf;
<a name="l01141"></a>01141 <span class="preprocessor">#endif</span>
<a name="l01142"></a>01142 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"suffix"</span>, f, fn)) {
<a name="l01143"></a>01143         <span class="keywordflow">if</span> ((b = strrchr(buf, <span class="charliteral">'.'</span>)) != NULL)
<a name="l01144"></a>01144             b++;
<a name="l01145"></a>01145     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"expand"</span>, f, fn)) {
<a name="l01146"></a>01146         b = buf;
<a name="l01147"></a>01147     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"verbose"</span>, f, fn)) {
<a name="l01148"></a>01148         <span class="keywordflow">if</span> (negate)
<a name="l01149"></a>01149             b = (<a class="code" href="rpmmessages_8h.html#27e9ca69465ed215147b0ec1a018a7fa">rpmIsVerbose</a>() ? NULL : buf);
<a name="l01150"></a>01150         <span class="keywordflow">else</span>
<a name="l01151"></a>01151             b = (<a class="code" href="rpmmessages_8h.html#27e9ca69465ed215147b0ec1a018a7fa">rpmIsVerbose</a>() ? buf : NULL);
<a name="l01152"></a>01152     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"url2path"</span>, f, fn) || <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"u2p"</span>, f, fn)) {
<a name="l01153"></a>01153         (void)<a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(buf, (<span class="keyword">const</span> <span class="keywordtype">char</span> **)&amp;b);
<a name="l01154"></a>01154 <span class="comment">/*@-branchstate@*/</span>
<a name="l01155"></a>01155         <span class="keywordflow">if</span> (*b == <span class="charliteral">'\0'</span>) b = <span class="stringliteral">"/"</span>;
<a name="l01156"></a>01156 <span class="comment">/*@=branchstate@*/</span>
<a name="l01157"></a>01157     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"uncompress"</span>, f, fn)) {
<a name="l01158"></a>01158         <a class="code" href="rpmmacro_8h.html#7eb1d040bd267cb5c6188db828d447d1">rpmCompressedMagic</a> compressed = <a class="code" href="rpmmacro_8h.html#8b147c8bfb002dbd493b41a6f9d9e0a3f99341145d1052277a0f45e1c791be7a">COMPRESSED_OTHER</a>;
<a name="l01159"></a>01159 <span class="comment">/*@-globs@*/</span>
<a name="l01160"></a>01160         <span class="keywordflow">for</span> (b = buf; (c = *b) &amp;&amp; <a class="code" href="macro_8c.html#71b921c86d024ec3342964ac68dffc64">isblank</a>(c);)
<a name="l01161"></a>01161             b++;
<a name="l01162"></a>01162         <span class="keywordflow">for</span> (be = b; (c = *be) &amp;&amp; !<a class="code" href="macro_8c.html#71b921c86d024ec3342964ac68dffc64">isblank</a>(c);)
<a name="l01163"></a>01163             be++;
<a name="l01164"></a>01164 <span class="comment">/*@=globs@*/</span>
<a name="l01165"></a>01165         *be++ = <span class="charliteral">'\0'</span>;
<a name="l01166"></a>01166 <span class="preprocessor">#ifndef DEBUG_MACROS</span>
<a name="l01167"></a>01167 <span class="preprocessor"></span>        (void) <a class="code" href="macro_8c.html#1495956d59eccf3a9521661f9fc50890" title="Return type of compression used in file.">isCompressed</a>(b, &amp;compressed);
<a name="l01168"></a>01168 <span class="preprocessor">#endif</span>
<a name="l01169"></a>01169 <span class="preprocessor"></span>        <span class="keywordflow">switch</span>(compressed) {
<a name="l01170"></a>01170         <span class="keywordflow">default</span>:
<a name="l01171"></a>01171         <span class="keywordflow">case</span> 0: <span class="comment">/* COMPRESSED_NOT */</span>
<a name="l01172"></a>01172             sprintf(be, <span class="stringliteral">"%%_cat %s"</span>, b);
<a name="l01173"></a>01173             <span class="keywordflow">break</span>;
<a name="l01174"></a>01174         <span class="keywordflow">case</span> 1: <span class="comment">/* COMPRESSED_OTHER */</span>
<a name="l01175"></a>01175             sprintf(be, <span class="stringliteral">"%%_gzip -dc %s"</span>, b);
<a name="l01176"></a>01176             <span class="keywordflow">break</span>;
<a name="l01177"></a>01177         <span class="keywordflow">case</span> 2: <span class="comment">/* COMPRESSED_BZIP2 */</span>
<a name="l01178"></a>01178             sprintf(be, <span class="stringliteral">"%%_bzip2 %s"</span>, b);
<a name="l01179"></a>01179             <span class="keywordflow">break</span>;
<a name="l01180"></a>01180         <span class="keywordflow">case</span> 3: <span class="comment">/* COMPRESSED_ZIP */</span>
<a name="l01181"></a>01181             sprintf(be, <span class="stringliteral">"%%_unzip %s"</span>, b);
<a name="l01182"></a>01182             <span class="keywordflow">break</span>;
<a name="l01183"></a>01183         }
<a name="l01184"></a>01184         b = be;
<a name="l01185"></a>01185     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"S"</span>, f, fn)) {
<a name="l01186"></a>01186         <span class="keywordflow">for</span> (b = buf; (c = *b) &amp;&amp; <a class="code" href="rpmio_8h.html#65a1599547748acb6ea978146c47043e">xisdigit</a>(c);)
<a name="l01187"></a>01187             b++;
<a name="l01188"></a>01188         <span class="keywordflow">if</span> (!c) {       <span class="comment">/* digit index */</span>
<a name="l01189"></a>01189             b++;
<a name="l01190"></a>01190             sprintf(b, <span class="stringliteral">"%%SOURCE%s"</span>, buf);
<a name="l01191"></a>01191         } <span class="keywordflow">else</span>
<a name="l01192"></a>01192             b = buf;
<a name="l01193"></a>01193     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"P"</span>, f, fn)) {
<a name="l01194"></a>01194         <span class="keywordflow">for</span> (b = buf; (c = *b) &amp;&amp; <a class="code" href="rpmio_8h.html#65a1599547748acb6ea978146c47043e">xisdigit</a>(c);)
<a name="l01195"></a>01195             b++;
<a name="l01196"></a>01196         <span class="keywordflow">if</span> (!c) {       <span class="comment">/* digit index */</span>
<a name="l01197"></a>01197             b++;
<a name="l01198"></a>01198             sprintf(b, <span class="stringliteral">"%%PATCH%s"</span>, buf);
<a name="l01199"></a>01199         } <span class="keywordflow">else</span>
<a name="l01200"></a>01200                         b = buf;
<a name="l01201"></a>01201     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"F"</span>, f, fn)) {
<a name="l01202"></a>01202         b = buf + strlen(buf) + 1;
<a name="l01203"></a>01203         sprintf(b, <span class="stringliteral">"file%s.file"</span>, buf);
<a name="l01204"></a>01204     }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206     <span class="keywordflow">if</span> (b) {
<a name="l01207"></a>01207         (void) <a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b" title="Save source and expand field into target.">expandT</a>(mb, b, strlen(b));
<a name="l01208"></a>01208     }
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01217"></a>01217 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l01218"></a><a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed">01218</a> <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(<a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb)
<a name="l01219"></a>01219         <span class="comment">/*@globals rpmGlobalMacroContext,</span>
<a name="l01220"></a>01220 <span class="comment">                print_macro_trace, print_expand_trace, h_errno, fileSystem @*/</span>
<a name="l01221"></a>01221         <span class="comment">/*@modifies mb, rpmGlobalMacroContext,</span>
<a name="l01222"></a>01222 <span class="comment">                print_macro_trace, print_expand_trace, fileSystem @*/</span>
<a name="l01223"></a>01223 {
<a name="l01224"></a>01224     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> *mep;
<a name="l01225"></a>01225     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me;
<a name="l01226"></a>01226     <span class="keyword">const</span> <span class="keywordtype">char</span> *s = mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a>, *se;
<a name="l01227"></a>01227     <span class="keyword">const</span> <span class="keywordtype">char</span> *f, *fe;
<a name="l01228"></a>01228     <span class="keyword">const</span> <span class="keywordtype">char</span> *g, *ge;
<a name="l01229"></a>01229     <span class="keywordtype">size_t</span> fn, gn;
<a name="l01230"></a>01230     <span class="keywordtype">char</span> *t = mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>;    <span class="comment">/* save expansion pointer for printExpand */</span>
<a name="l01231"></a>01231     <span class="keywordtype">int</span> c;
<a name="l01232"></a>01232     <span class="keywordtype">int</span> rc = 0;
<a name="l01233"></a>01233     <span class="keywordtype">int</span> negate;
<a name="l01234"></a>01234     <span class="keyword">const</span> <span class="keywordtype">char</span> * lastc;
<a name="l01235"></a>01235     <span class="keywordtype">int</span> chkexist;
<a name="l01236"></a>01236 
<a name="l01237"></a>01237     <span class="keywordflow">if</span> (++mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> &gt; <a class="code" href="macro_8c.html#8351a2449d4ccc57c8e5c1451af359ed">max_macro_depth</a>) {
<a name="l01238"></a>01238         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l01239"></a>01239                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Recursion depth(%d) greater than max(%d)\n"</span>),
<a name="l01240"></a>01240                 mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>, <a class="code" href="macro_8c.html#8351a2449d4ccc57c8e5c1451af359ed">max_macro_depth</a>);
<a name="l01241"></a>01241         mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>--;
<a name="l01242"></a>01242         mb-&gt;<a class="code" href="structMacroBuf__s.html#216bd6ec2d68169c494124edfd12a384">expand_trace</a> = 1;
<a name="l01243"></a>01243         <span class="keywordflow">return</span> 1;
<a name="l01244"></a>01244     }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 <span class="comment">/*@-branchstate@*/</span>
<a name="l01247"></a>01247     <span class="keywordflow">while</span> (rc == 0 &amp;&amp; mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> &gt; 0 &amp;&amp; (c = *s) != <span class="charliteral">'\0'</span>) {
<a name="l01248"></a>01248         s++;
<a name="l01249"></a>01249         <span class="comment">/* Copy text until next macro */</span>
<a name="l01250"></a>01250         <span class="keywordflow">switch</span>(c) {
<a name="l01251"></a>01251         <span class="keywordflow">case</span> <span class="charliteral">'%'</span>:
<a name="l01252"></a>01252                 <span class="keywordflow">if</span> (*s) {       <span class="comment">/* Ensure not end-of-string. */</span>
<a name="l01253"></a>01253                     <span class="keywordflow">if</span> (*s != <span class="charliteral">'%'</span>)
<a name="l01254"></a>01254                         <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01255"></a>01255                     s++;        <span class="comment">/* skip first % in %% */</span>
<a name="l01256"></a>01256                 }
<a name="l01257"></a>01257                 <span class="comment">/*@fallthrough@*/</span>
<a name="l01258"></a>01258         <span class="keywordflow">default</span>:
<a name="l01259"></a>01259                 <a class="code" href="macro_8c.html#0bf86a73152948baeb778eff132508f9">SAVECHAR</a>(mb, c);
<a name="l01260"></a>01260                 <span class="keywordflow">continue</span>;
<a name="l01261"></a>01261                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01262"></a>01262         }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264         <span class="comment">/* Expand next macro */</span>
<a name="l01265"></a>01265         f = fe = NULL;
<a name="l01266"></a>01266         g = ge = NULL;
<a name="l01267"></a>01267         <span class="keywordflow">if</span> (mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> &gt; 1)      <span class="comment">/* XXX full expansion for outermost level */</span>
<a name="l01268"></a>01268                 t = mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>;      <span class="comment">/* save expansion pointer for printExpand */</span>
<a name="l01269"></a>01269         negate = 0;
<a name="l01270"></a>01270         lastc = NULL;
<a name="l01271"></a>01271         chkexist = 0;
<a name="l01272"></a>01272         <span class="keywordflow">switch</span> ((c = *s)) {
<a name="l01273"></a>01273         <span class="keywordflow">default</span>:                <span class="comment">/* %name substitution */</span>
<a name="l01274"></a>01274                 <span class="keywordflow">while</span> (strchr(<span class="stringliteral">"!?"</span>, *s) != NULL) {
<a name="l01275"></a>01275                         <span class="keywordflow">switch</span>(*s++) {
<a name="l01276"></a>01276                         <span class="keywordflow">case</span> <span class="charliteral">'!'</span>:
<a name="l01277"></a>01277                                 negate = ((negate + 1) % 2);
<a name="l01278"></a>01278                                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01279"></a>01279                         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
<a name="l01280"></a>01280                                 chkexist++;
<a name="l01281"></a>01281                                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01282"></a>01282                         }
<a name="l01283"></a>01283                 }
<a name="l01284"></a>01284                 f = se = s;
<a name="l01285"></a>01285                 <span class="keywordflow">if</span> (*se == <span class="charliteral">'-'</span>)
<a name="l01286"></a>01286                         se++;
<a name="l01287"></a>01287                 <span class="keywordflow">while</span>((c = *se) &amp;&amp; (<a class="code" href="rpmio_8h.html#f28de95b1aa971532f31be4c04bdb6c4">xisalnum</a>(c) || c == <span class="charliteral">'_'</span>))
<a name="l01288"></a>01288                         se++;
<a name="l01289"></a>01289                 <span class="comment">/* Recognize non-alnum macros too */</span>
<a name="l01290"></a>01290                 <span class="keywordflow">switch</span> (*se) {
<a name="l01291"></a>01291                 <span class="keywordflow">case</span> <span class="charliteral">'*'</span>:
<a name="l01292"></a>01292                         se++;
<a name="l01293"></a>01293                         <span class="keywordflow">if</span> (*se == <span class="charliteral">'*'</span>) se++;
<a name="l01294"></a>01294                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01295"></a>01295                 <span class="keywordflow">case</span> <span class="charliteral">'#'</span>:
<a name="l01296"></a>01296                         se++;
<a name="l01297"></a>01297                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01298"></a>01298                 <span class="keywordflow">default</span>:
<a name="l01299"></a>01299                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01300"></a>01300                 }
<a name="l01301"></a>01301                 fe = se;
<a name="l01302"></a>01302                 <span class="comment">/* For "%name " macros ... */</span>
<a name="l01303"></a>01303 <span class="comment">/*@-globs@*/</span>
<a name="l01304"></a>01304                 <span class="keywordflow">if</span> ((c = *fe) &amp;&amp; <a class="code" href="macro_8c.html#71b921c86d024ec3342964ac68dffc64">isblank</a>(c))
<a name="l01305"></a>01305                         <span class="keywordflow">if</span> ((lastc = strchr(fe,<span class="charliteral">'\n'</span>)) == NULL)
<a name="l01306"></a>01306                 lastc = strchr(fe, <span class="charliteral">'\0'</span>);
<a name="l01307"></a>01307 <span class="comment">/*@=globs@*/</span>
<a name="l01308"></a>01308                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01309"></a>01309         <span class="keywordflow">case</span> <span class="charliteral">'('</span>:               <span class="comment">/* %(...) shell escape */</span>
<a name="l01310"></a>01310                 <span class="keywordflow">if</span> ((se = <a class="code" href="macro_8c.html#f1b5b252eab18ae1b8437773be437797" title="Return text between pl and matching pr characters.">matchchar</a>(s, c, <span class="charliteral">')'</span>)) == NULL) {
<a name="l01311"></a>01311                         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l01312"></a>01312                                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unterminated %c: %s\n"</span>), (<span class="keywordtype">char</span>)c, s);
<a name="l01313"></a>01313                         rc = 1;
<a name="l01314"></a>01314                         <span class="keywordflow">continue</span>;
<a name="l01315"></a>01315                 }
<a name="l01316"></a>01316                 <span class="keywordflow">if</span> (mb-&gt;<a class="code" href="structMacroBuf__s.html#e67c77fd343e3232dabc479f8fcac3a4">macro_trace</a>)
<a name="l01317"></a>01317                         <a class="code" href="macro_8c.html#d2f1aafd4f16bd7ac83eb96f85a212a1" title="Pre-print macro expression to be expanded.">printMacro</a>(mb, s, se+1);
<a name="l01318"></a>01318 
<a name="l01319"></a>01319                 s++;    <span class="comment">/* skip ( */</span>
<a name="l01320"></a>01320                 rc = <a class="code" href="macro_8c.html#812b62764f4d597b56f87eb826f86bda" title="Expand output of shell command into target buffer.">doShellEscape</a>(mb, s, (se - s));
<a name="l01321"></a>01321                 se++;   <span class="comment">/* skip ) */</span>
<a name="l01322"></a>01322 
<a name="l01323"></a>01323                 s = se;
<a name="l01324"></a>01324                 <span class="keywordflow">continue</span>;
<a name="l01325"></a>01325                 <span class="comment">/*@notreached@*/</span> <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01326"></a>01326         <span class="keywordflow">case</span> <span class="charliteral">'{'</span>:               <span class="comment">/* %{...}/%{...:...} substitution */</span>
<a name="l01327"></a>01327                 <span class="keywordflow">if</span> ((se = <a class="code" href="macro_8c.html#f1b5b252eab18ae1b8437773be437797" title="Return text between pl and matching pr characters.">matchchar</a>(s, c, <span class="charliteral">'}'</span>)) == NULL) {
<a name="l01328"></a>01328                         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l01329"></a>01329                                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Unterminated %c: %s\n"</span>), (<span class="keywordtype">char</span>)c, s);
<a name="l01330"></a>01330                         rc = 1;
<a name="l01331"></a>01331                         <span class="keywordflow">continue</span>;
<a name="l01332"></a>01332                 }
<a name="l01333"></a>01333                 f = s+1;<span class="comment">/* skip { */</span>
<a name="l01334"></a>01334                 se++;   <span class="comment">/* skip } */</span>
<a name="l01335"></a>01335                 <span class="keywordflow">while</span> (strchr(<span class="stringliteral">"!?"</span>, *f) != NULL) {
<a name="l01336"></a>01336                         <span class="keywordflow">switch</span>(*f++) {
<a name="l01337"></a>01337                         <span class="keywordflow">case</span> <span class="charliteral">'!'</span>:
<a name="l01338"></a>01338                                 negate = ((negate + 1) % 2);
<a name="l01339"></a>01339                                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01340"></a>01340                         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
<a name="l01341"></a>01341                                 chkexist++;
<a name="l01342"></a>01342                                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01343"></a>01343                         }
<a name="l01344"></a>01344                 }
<a name="l01345"></a>01345                 <span class="keywordflow">for</span> (fe = f; (c = *fe) &amp;&amp; !strchr(<span class="stringliteral">" :}"</span>, c);)
<a name="l01346"></a>01346                         fe++;
<a name="l01347"></a>01347                 <span class="keywordflow">switch</span> (c) {
<a name="l01348"></a>01348                 <span class="keywordflow">case</span> <span class="charliteral">':'</span>:
<a name="l01349"></a>01349                         g = fe + 1;
<a name="l01350"></a>01350                         ge = se - 1;
<a name="l01351"></a>01351                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01352"></a>01352                 <span class="keywordflow">case</span> <span class="charliteral">' '</span>:
<a name="l01353"></a>01353                         lastc = se-1;
<a name="l01354"></a>01354                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01355"></a>01355                 <span class="keywordflow">default</span>:
<a name="l01356"></a>01356                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01357"></a>01357                 }
<a name="l01358"></a>01358                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01359"></a>01359         }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361         <span class="comment">/* XXX Everything below expects fe &gt; f */</span>
<a name="l01362"></a>01362         fn = (fe - f);
<a name="l01363"></a>01363         gn = (ge - g);
<a name="l01364"></a>01364         <span class="keywordflow">if</span> ((fe - f) &lt;= 0) {
<a name="l01365"></a>01365 <span class="comment">/* XXX Process % in unknown context */</span>
<a name="l01366"></a>01366                 c = <span class="charliteral">'%'</span>;        <span class="comment">/* XXX only need to save % */</span>
<a name="l01367"></a>01367                 <a class="code" href="macro_8c.html#0bf86a73152948baeb778eff132508f9">SAVECHAR</a>(mb, c);
<a name="l01368"></a>01368 <span class="preprocessor">#if 0</span>
<a name="l01369"></a>01369 <span class="preprocessor"></span>                <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l01370"></a>01370                         <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"A %% is followed by an unparseable macro\n"</span>));
<a name="l01371"></a>01371 <span class="preprocessor">#endif</span>
<a name="l01372"></a>01372 <span class="preprocessor"></span>                s = se;
<a name="l01373"></a>01373                 <span class="keywordflow">continue</span>;
<a name="l01374"></a>01374         }
<a name="l01375"></a>01375 
<a name="l01376"></a>01376         <span class="keywordflow">if</span> (mb-&gt;<a class="code" href="structMacroBuf__s.html#e67c77fd343e3232dabc479f8fcac3a4">macro_trace</a>)
<a name="l01377"></a>01377                 <a class="code" href="macro_8c.html#d2f1aafd4f16bd7ac83eb96f85a212a1" title="Pre-print macro expression to be expanded.">printMacro</a>(mb, s, se);
<a name="l01378"></a>01378 
<a name="l01379"></a>01379         <span class="comment">/* Expand builtin macros */</span>
<a name="l01380"></a>01380         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"global"</span>, f, fn)) {
<a name="l01381"></a>01381                 s = <a class="code" href="macro_8c.html#a282776f7081c9e47a0299cf2a103edf" title="Parse (and execute) new macro definition.">doDefine</a>(mb, se, <a class="code" href="rpmmacro_8h.html#73f4b4d985059be79769b2a2041d3662">RMIL_GLOBAL</a>, 1);
<a name="l01382"></a>01382                 <span class="keywordflow">continue</span>;
<a name="l01383"></a>01383         }
<a name="l01384"></a>01384         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"define"</span>, f, fn)) {
<a name="l01385"></a>01385                 s = <a class="code" href="macro_8c.html#a282776f7081c9e47a0299cf2a103edf" title="Parse (and execute) new macro definition.">doDefine</a>(mb, se, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>, 0);
<a name="l01386"></a>01386                 <span class="keywordflow">continue</span>;
<a name="l01387"></a>01387         }
<a name="l01388"></a>01388         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"undefine"</span>, f, fn)) {
<a name="l01389"></a>01389                 s = <a class="code" href="macro_8c.html#5110a6d78f9f2aeb8577ce94d33b4b1d" title="Parse (and execute) macro undefinition.">doUndefine</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, se);
<a name="l01390"></a>01390                 <span class="keywordflow">continue</span>;
<a name="l01391"></a>01391         }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"echo"</span>, f, fn) ||
<a name="l01394"></a>01394             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"warn"</span>, f, fn) ||
<a name="l01395"></a>01395             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"error"</span>, f, fn)) {
<a name="l01396"></a>01396                 <span class="keywordtype">int</span> waserror = 0;
<a name="l01397"></a>01397                 <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"error"</span>, f, fn))
<a name="l01398"></a>01398                         waserror = 1;
<a name="l01399"></a>01399                 <span class="keywordflow">if</span> (g != NULL &amp;&amp; g &lt; ge)
<a name="l01400"></a>01400                         <a class="code" href="macro_8c.html#a902f671031f078e3cb798db8fedc898" title="Perform macro message output.">doOutput</a>(mb, waserror, g, gn);
<a name="l01401"></a>01401                 <span class="keywordflow">else</span>
<a name="l01402"></a>01402                         <a class="code" href="macro_8c.html#a902f671031f078e3cb798db8fedc898" title="Perform macro message output.">doOutput</a>(mb, waserror, f, fn);
<a name="l01403"></a>01403                 s = se;
<a name="l01404"></a>01404                 <span class="keywordflow">continue</span>;
<a name="l01405"></a>01405         }
<a name="l01406"></a>01406 
<a name="l01407"></a>01407         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"trace"</span>, f, fn)) {
<a name="l01408"></a>01408                 <span class="comment">/* XXX TODO restore expand_trace/macro_trace to 0 on return */</span>
<a name="l01409"></a>01409                 mb-&gt;<a class="code" href="structMacroBuf__s.html#216bd6ec2d68169c494124edfd12a384">expand_trace</a> = mb-&gt;<a class="code" href="structMacroBuf__s.html#e67c77fd343e3232dabc479f8fcac3a4">macro_trace</a> = (negate ? 0 : mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01410"></a>01410                 <span class="keywordflow">if</span> (mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a> == 1) {
<a name="l01411"></a>01411                         <a class="code" href="macro_8c.html#69c82ff03bf0a250cd73e00eb2059897">print_macro_trace</a> = mb-&gt;<a class="code" href="structMacroBuf__s.html#e67c77fd343e3232dabc479f8fcac3a4">macro_trace</a>;
<a name="l01412"></a>01412                         <a class="code" href="macro_8c.html#1e97e767636425e2fbe9b7578ca48cd0">print_expand_trace</a> = mb-&gt;<a class="code" href="structMacroBuf__s.html#216bd6ec2d68169c494124edfd12a384">expand_trace</a>;
<a name="l01413"></a>01413                 }
<a name="l01414"></a>01414                 s = se;
<a name="l01415"></a>01415                 <span class="keywordflow">continue</span>;
<a name="l01416"></a>01416         }
<a name="l01417"></a>01417 
<a name="l01418"></a>01418         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"dump"</span>, f, fn)) {
<a name="l01419"></a>01419                 <a class="code" href="macro_8c.html#f075388010eeb8d8decdc1978fd7db24" title="Print macros to file stream.">rpmDumpMacroTable</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, NULL);
<a name="l01420"></a>01420                 <span class="keywordflow">while</span> (<a class="code" href="macro_8c.html#36c62318774aada4ed9cb055a06ea85d">iseol</a>(*se))
<a name="l01421"></a>01421                         se++;
<a name="l01422"></a>01422                 s = se;
<a name="l01423"></a>01423                 <span class="keywordflow">continue</span>;
<a name="l01424"></a>01424         }
<a name="l01425"></a>01425 
<a name="l01426"></a>01426 <span class="preprocessor">#ifdef  WITH_LUA</span>
<a name="l01427"></a>01427 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"lua"</span>, f, fn)) {
<a name="l01428"></a>01428                 rpmlua lua = NULL; <span class="comment">/* Global state. */</span>
<a name="l01429"></a>01429                 <span class="keyword">const</span> <span class="keywordtype">char</span> *ls = s+<span class="keyword">sizeof</span>(<span class="stringliteral">"{lua:"</span>)-1;
<a name="l01430"></a>01430                 <span class="keyword">const</span> <span class="keywordtype">char</span> *lse = se-<span class="keyword">sizeof</span>(<span class="stringliteral">"}"</span>)+1;
<a name="l01431"></a>01431                 <span class="keywordtype">char</span> *scriptbuf = (<span class="keywordtype">char</span> *)<a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>((lse-ls)+1);
<a name="l01432"></a>01432                 <span class="keyword">const</span> <span class="keywordtype">char</span> *printbuf;
<a name="l01433"></a>01433                 memcpy(scriptbuf, ls, lse-ls);
<a name="l01434"></a>01434                 scriptbuf[lse-ls] = <span class="charliteral">'\0'</span>;
<a name="l01435"></a>01435                 rpmluaSetPrintBuffer(lua, 1);
<a name="l01436"></a>01436                 <span class="keywordflow">if</span> (rpmluaRunScript(lua, scriptbuf, NULL) == -1)
<a name="l01437"></a>01437                     rc = 1;
<a name="l01438"></a>01438                 printbuf = rpmluaGetPrintBuffer(lua);
<a name="l01439"></a>01439                 <span class="keywordflow">if</span> (printbuf) {
<a name="l01440"></a>01440                     <span class="keywordtype">int</span> len = strlen(printbuf);
<a name="l01441"></a>01441                     <span class="keywordflow">if</span> (len &gt; mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a>)
<a name="l01442"></a>01442                         len = mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a>;
<a name="l01443"></a>01443                     memcpy(mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>, printbuf, len);
<a name="l01444"></a>01444                     mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a> += len;
<a name="l01445"></a>01445                     mb-&gt;<a class="code" href="structMacroBuf__s.html#45931d28b52256de97194c27fec207cf">nb</a> -= len;
<a name="l01446"></a>01446                 }
<a name="l01447"></a>01447                 rpmluaSetPrintBuffer(lua, 0);
<a name="l01448"></a>01448                 free(scriptbuf);
<a name="l01449"></a>01449                 s = se;
<a name="l01450"></a>01450                 <span class="keywordflow">continue</span>;
<a name="l01451"></a>01451         }
<a name="l01452"></a>01452 <span class="preprocessor">#endif</span>
<a name="l01453"></a>01453 <span class="preprocessor"></span>
<a name="l01454"></a>01454         <span class="comment">/* XXX necessary but clunky */</span>
<a name="l01455"></a>01455         <span class="keywordflow">if</span> (<a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"basename"</span>, f, fn) ||
<a name="l01456"></a>01456             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"suffix"</span>, f, fn) ||
<a name="l01457"></a>01457             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"expand"</span>, f, fn) ||
<a name="l01458"></a>01458             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"verbose"</span>, f, fn) ||
<a name="l01459"></a>01459             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"uncompress"</span>, f, fn) ||
<a name="l01460"></a>01460             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"url2path"</span>, f, fn) ||
<a name="l01461"></a>01461             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"u2p"</span>, f, fn) ||
<a name="l01462"></a>01462             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"S"</span>, f, fn) ||
<a name="l01463"></a>01463             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"P"</span>, f, fn) ||
<a name="l01464"></a>01464             <a class="code" href="macro_8c.html#f34557aca3150fc44a341c957df54385">STREQ</a>(<span class="stringliteral">"F"</span>, f, fn)) {
<a name="l01465"></a>01465                 <span class="comment">/*@-internalglobs@*/</span> <span class="comment">/* FIX: verbose may be set */</span>
<a name="l01466"></a>01466                 <a class="code" href="macro_8c.html#3336f7f09fc4ae14ecadf407b9e17e94" title="Execute macro primitives.">doFoo</a>(mb, negate, f, fn, g, gn);
<a name="l01467"></a>01467                 <span class="comment">/*@=internalglobs@*/</span>
<a name="l01468"></a>01468                 s = se;
<a name="l01469"></a>01469                 <span class="keywordflow">continue</span>;
<a name="l01470"></a>01470         }
<a name="l01471"></a>01471 
<a name="l01472"></a>01472         <span class="comment">/* Expand defined macros */</span>
<a name="l01473"></a>01473         mep = <a class="code" href="header_8c.html#822829bcd46d0c6e9e1ea68927351f1d" title="Find matching (tag,type) entry in header.">findEntry</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, f, fn);
<a name="l01474"></a>01474         me = (mep ? *mep : NULL);
<a name="l01475"></a>01475 
<a name="l01476"></a>01476         <span class="comment">/* XXX Special processing for flags */</span>
<a name="l01477"></a>01477         <span class="keywordflow">if</span> (*f == <span class="charliteral">'-'</span>) {
<a name="l01478"></a>01478                 <span class="keywordflow">if</span> (me)
<a name="l01479"></a>01479                         me-&gt;<a class="code" href="structMacroEntry__s.html#db171f6db8fc31e50da77e9e6e460416">used</a>++;     <span class="comment">/* Mark macro as used */</span>
<a name="l01480"></a>01480                 <span class="keywordflow">if</span> ((me == NULL &amp;&amp; !negate) ||  <span class="comment">/* Without -f, skip %{-f...} */</span>
<a name="l01481"></a>01481                     (me != NULL &amp;&amp; negate)) {   <span class="comment">/* With -f, skip %{!-f...} */</span>
<a name="l01482"></a>01482                         s = se;
<a name="l01483"></a>01483                         <span class="keywordflow">continue</span>;
<a name="l01484"></a>01484                 }
<a name="l01485"></a>01485 
<a name="l01486"></a>01486                 <span class="keywordflow">if</span> (g &amp;&amp; g &lt; ge) {              <span class="comment">/* Expand X in %{-f:X} */</span>
<a name="l01487"></a>01487                         rc = <a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b" title="Save source and expand field into target.">expandT</a>(mb, g, gn);
<a name="l01488"></a>01488                 } <span class="keywordflow">else</span>
<a name="l01489"></a>01489                 <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a> &amp;&amp; *me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>) {<span class="comment">/* Expand %{-f}/%{-f*} */</span>
<a name="l01490"></a>01490                         rc = <a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b" title="Save source and expand field into target.">expandT</a>(mb, me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>, strlen(me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>));
<a name="l01491"></a>01491                 }
<a name="l01492"></a>01492                 s = se;
<a name="l01493"></a>01493                 <span class="keywordflow">continue</span>;
<a name="l01494"></a>01494         }
<a name="l01495"></a>01495 
<a name="l01496"></a>01496         <span class="comment">/* XXX Special processing for macro existence */</span>
<a name="l01497"></a>01497         <span class="keywordflow">if</span> (chkexist) {
<a name="l01498"></a>01498                 <span class="keywordflow">if</span> ((me == NULL &amp;&amp; !negate) ||  <span class="comment">/* Without -f, skip %{?f...} */</span>
<a name="l01499"></a>01499                     (me != NULL &amp;&amp; negate)) {   <span class="comment">/* With -f, skip %{!?f...} */</span>
<a name="l01500"></a>01500                         s = se;
<a name="l01501"></a>01501                         <span class="keywordflow">continue</span>;
<a name="l01502"></a>01502                 }
<a name="l01503"></a>01503                 <span class="keywordflow">if</span> (g &amp;&amp; g &lt; ge) {              <span class="comment">/* Expand X in %{?f:X} */</span>
<a name="l01504"></a>01504                         rc = <a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b" title="Save source and expand field into target.">expandT</a>(mb, g, gn);
<a name="l01505"></a>01505                 } <span class="keywordflow">else</span>
<a name="l01506"></a>01506                 <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a> &amp;&amp; *me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>) { <span class="comment">/* Expand %{?f}/%{?f*} */</span>
<a name="l01507"></a>01507                         rc = <a class="code" href="macro_8c.html#964e52ae8f9a0a834f01a5516c1d258b" title="Save source and expand field into target.">expandT</a>(mb, me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>, strlen(me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>));
<a name="l01508"></a>01508                 }
<a name="l01509"></a>01509                 s = se;
<a name="l01510"></a>01510                 <span class="keywordflow">continue</span>;
<a name="l01511"></a>01511         }
<a name="l01512"></a>01512         
<a name="l01513"></a>01513         <span class="keywordflow">if</span> (me == NULL) {       <span class="comment">/* leave unknown %... as is */</span>
<a name="l01514"></a>01514 <span class="preprocessor">#ifndef HACK</span>
<a name="l01515"></a>01515 <span class="preprocessor"></span><span class="preprocessor">#if DEAD</span>
<a name="l01516"></a>01516 <span class="preprocessor"></span>                <span class="comment">/* XXX hack to skip over empty arg list */</span>
<a name="l01517"></a>01517                 <span class="keywordflow">if</span> (fn == 1 &amp;&amp; *f == <span class="charliteral">'*'</span>) {
<a name="l01518"></a>01518                         s = se;
<a name="l01519"></a>01519                         <span class="keywordflow">continue</span>;
<a name="l01520"></a>01520                 }
<a name="l01521"></a>01521 <span class="preprocessor">#endif</span>
<a name="l01522"></a>01522 <span class="preprocessor"></span>                <span class="comment">/* XXX hack to permit non-overloaded %foo to be passed */</span>
<a name="l01523"></a>01523                 c = <span class="charliteral">'%'</span>;        <span class="comment">/* XXX only need to save % */</span>
<a name="l01524"></a>01524                 <a class="code" href="macro_8c.html#0bf86a73152948baeb778eff132508f9">SAVECHAR</a>(mb, c);
<a name="l01525"></a>01525 <span class="preprocessor">#else</span>
<a name="l01526"></a>01526 <span class="preprocessor"></span>                <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>,
<a name="l01527"></a>01527                         <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Macro %%%.*s not found, skipping\n"</span>), fn, f);
<a name="l01528"></a>01528                 s = se;
<a name="l01529"></a>01529 <span class="preprocessor">#endif</span>
<a name="l01530"></a>01530 <span class="preprocessor"></span>                <span class="keywordflow">continue</span>;
<a name="l01531"></a>01531         }
<a name="l01532"></a>01532 
<a name="l01533"></a>01533         <span class="comment">/* Setup args for "%name " macros with opts */</span>
<a name="l01534"></a>01534         <span class="keywordflow">if</span> (me &amp;&amp; me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a> != NULL) {
<a name="l01535"></a>01535                 <span class="keywordflow">if</span> (lastc != NULL) {
<a name="l01536"></a>01536                         se = <a class="code" href="macro_8c.html#8f6890158b634b075b87b42cd8422da9" title="Parse arguments (to next new line) for parameterized macro.">grabArgs</a>(mb, me, fe, lastc);
<a name="l01537"></a>01537                 } <span class="keywordflow">else</span> {
<a name="l01538"></a>01538                         <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"**"</span>, NULL, <span class="stringliteral">""</span>, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01539"></a>01539                         <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"*"</span>, NULL, <span class="stringliteral">""</span>, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01540"></a>01540                         <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"#"</span>, NULL, <span class="stringliteral">"0"</span>, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01541"></a>01541                         <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(mb-&gt;<a class="code" href="structMacroBuf__s.html#73be24485f2a7a470e47850bc60d0fe1">mc</a>, <span class="stringliteral">"0"</span>, NULL, me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>);
<a name="l01542"></a>01542                 }
<a name="l01543"></a>01543         }
<a name="l01544"></a>01544 
<a name="l01545"></a>01545         <span class="comment">/* Recursively expand body of macro */</span>
<a name="l01546"></a>01546         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a> &amp;&amp; *me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>) {
<a name="l01547"></a>01547                 mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a> = me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>;
<a name="l01548"></a>01548                 rc = <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(mb);
<a name="l01549"></a>01549                 <span class="keywordflow">if</span> (rc == 0)
<a name="l01550"></a>01550                         me-&gt;<a class="code" href="structMacroEntry__s.html#db171f6db8fc31e50da77e9e6e460416">used</a>++;     <span class="comment">/* Mark macro as used */</span>
<a name="l01551"></a>01551         }
<a name="l01552"></a>01552 
<a name="l01553"></a>01553         <span class="comment">/* Free args for "%name " macros with opts */</span>
<a name="l01554"></a>01554         <span class="keywordflow">if</span> (me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a> != NULL)
<a name="l01555"></a>01555                 <a class="code" href="macro_8c.html#b5c4b77d14ec0ffebaa1d0ad09d30c26" title="Free parsed arguments for parameterized macro.">freeArgs</a>(mb);
<a name="l01556"></a>01556 
<a name="l01557"></a>01557         s = se;
<a name="l01558"></a>01558     }
<a name="l01559"></a>01559 <span class="comment">/*@=branchstate@*/</span>
<a name="l01560"></a>01560 
<a name="l01561"></a>01561     *mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a> = <span class="charliteral">'\0'</span>;
<a name="l01562"></a>01562     mb-&gt;<a class="code" href="structMacroBuf__s.html#b6e9bf0a0c326f6713336e12bf04a9b1">s</a> = s;
<a name="l01563"></a>01563     mb-&gt;<a class="code" href="structMacroBuf__s.html#427e288e689242e8e2547d9ba4ae05b4">depth</a>--;
<a name="l01564"></a>01564     <span class="keywordflow">if</span> (rc != 0 || mb-&gt;<a class="code" href="structMacroBuf__s.html#216bd6ec2d68169c494124edfd12a384">expand_trace</a>)
<a name="l01565"></a>01565         <a class="code" href="macro_8c.html#c0c4968e7a33292fdd060e004ba2d100" title="Post-print expanded macro expression.">printExpansion</a>(mb, t, mb-&gt;<a class="code" href="structMacroBuf__s.html#096c201e314824a591fe28c2bc1c8bc4">t</a>);
<a name="l01566"></a>01566     <span class="keywordflow">return</span> rc;
<a name="l01567"></a>01567 }
<a name="l01568"></a>01568 
<a name="l01569"></a>01569 <span class="comment">/* =============================================================== */</span>
<a name="l01570"></a>01570 <span class="comment">/* XXX dupe'd to avoid change in linkage conventions. */</span>
<a name="l01571"></a>01571 
<a name="l01572"></a><a class="code" href="macro_8c.html#e7abc14aea35af5c8b612628b348a6f2">01572</a> <span class="preprocessor">#define POPT_ERROR_NOARG        -10     </span>
<a name="l01573"></a><a class="code" href="macro_8c.html#33d51ce6bde091c1bc6711179fbf098f">01573</a> <span class="preprocessor">#define POPT_ERROR_BADQUOTE     -15     </span>
<a name="l01574"></a><a class="code" href="macro_8c.html#a505b06d56c7f646943bf86329f250f4">01574</a> <span class="preprocessor">#define POPT_ERROR_MALLOC       -21     </span>
<a name="l01576"></a><a class="code" href="macro_8c.html#08884d23a737e6bc3050d247bb74cdd5">01576</a> <span class="preprocessor">#define POPT_ARGV_ARRAY_GROW_DELTA 5</span>
<a name="l01577"></a>01577 <span class="preprocessor"></span>
<a name="l01578"></a>01578 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01579"></a><a class="code" href="macro_8c.html#b372d73e5421b21e665bc3f38d829f5c">01579</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#b372d73e5421b21e665bc3f38d829f5c">XpoptDupArgv</a>(<span class="keywordtype">int</span> argc, <span class="keyword">const</span> <span class="keywordtype">char</span> **<a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>,
<a name="l01580"></a>01580                 <span class="keywordtype">int</span> * argcPtr, <span class="keyword">const</span> <span class="keywordtype">char</span> *** argvPtr)
<a name="l01581"></a>01581         <span class="comment">/*@modifies *argcPtr, *argvPtr @*/</span>
<a name="l01582"></a>01582 {
<a name="l01583"></a>01583     <span class="keywordtype">size_t</span> nb = (argc + 1) * <span class="keyword">sizeof</span>(*argv);
<a name="l01584"></a>01584     <span class="keyword">const</span> <span class="keywordtype">char</span> ** argv2;
<a name="l01585"></a>01585     <span class="keywordtype">char</span> * dst;
<a name="l01586"></a>01586     <span class="keywordtype">int</span> i;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588     <span class="keywordflow">if</span> (argc &lt;= 0 || argv == NULL)      <span class="comment">/* XXX can't happen */</span>
<a name="l01589"></a>01589         <span class="keywordflow">return</span> <a class="code" href="macro_8c.html#e7abc14aea35af5c8b612628b348a6f2">POPT_ERROR_NOARG</a>;
<a name="l01590"></a>01590     <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l01591"></a>01591         <span class="keywordflow">if</span> (argv[i] == NULL)
<a name="l01592"></a>01592             <span class="keywordflow">return</span> <a class="code" href="macro_8c.html#e7abc14aea35af5c8b612628b348a6f2">POPT_ERROR_NOARG</a>;
<a name="l01593"></a>01593         nb += strlen(argv[i]) + 1;
<a name="l01594"></a>01594     }
<a name="l01595"></a>01595         
<a name="l01596"></a>01596     dst = malloc(nb);
<a name="l01597"></a>01597     <span class="keywordflow">if</span> (dst == NULL)                    <span class="comment">/* XXX can't happen */</span>
<a name="l01598"></a>01598         <span class="keywordflow">return</span> <a class="code" href="macro_8c.html#a505b06d56c7f646943bf86329f250f4">POPT_ERROR_MALLOC</a>;
<a name="l01599"></a>01599     argv2 = (<span class="keywordtype">void</span> *) dst;
<a name="l01600"></a>01600     dst += (argc + 1) * <span class="keyword">sizeof</span>(*argv);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602     <span class="comment">/*@-branchstate@*/</span>
<a name="l01603"></a>01603     <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l01604"></a>01604         argv2[i] = dst;
<a name="l01605"></a>01605         dst += strlen(strcpy(dst, argv[i])) + 1;
<a name="l01606"></a>01606     }
<a name="l01607"></a>01607     <span class="comment">/*@=branchstate@*/</span>
<a name="l01608"></a>01608     argv2[argc] = NULL;
<a name="l01609"></a>01609 
<a name="l01610"></a>01610     <span class="keywordflow">if</span> (argvPtr) {
<a name="l01611"></a>01611         *argvPtr = argv2;
<a name="l01612"></a>01612     } <span class="keywordflow">else</span> {
<a name="l01613"></a>01613         free(argv2);
<a name="l01614"></a>01614         argv2 = NULL;
<a name="l01615"></a>01615     }
<a name="l01616"></a>01616     <span class="keywordflow">if</span> (argcPtr)
<a name="l01617"></a>01617         *argcPtr = argc;
<a name="l01618"></a>01618     <span class="keywordflow">return</span> 0;
<a name="l01619"></a>01619 }
<a name="l01620"></a>01620 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01621"></a>01621 
<a name="l01622"></a>01622 <span class="comment">/*@-bounds@*/</span>
<a name="l01623"></a><a class="code" href="macro_8c.html#0a2c716b765b8bd681d7b1c033eccd03">01623</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#0a2c716b765b8bd681d7b1c033eccd03">XpoptParseArgvString</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * s, <span class="keywordtype">int</span> * argcPtr, <span class="keyword">const</span> <span class="keywordtype">char</span> *** argvPtr)
<a name="l01624"></a>01624         <span class="comment">/*@modifies *argcPtr, *argvPtr @*/</span>
<a name="l01625"></a>01625 {
<a name="l01626"></a>01626     <span class="keyword">const</span> <span class="keywordtype">char</span> * src;
<a name="l01627"></a>01627     <span class="keywordtype">char</span> quote = <span class="charliteral">'\0'</span>;
<a name="l01628"></a>01628     <span class="keywordtype">int</span> argvAlloced = <a class="code" href="macro_8c.html#08884d23a737e6bc3050d247bb74cdd5">POPT_ARGV_ARRAY_GROW_DELTA</a>;
<a name="l01629"></a>01629     <span class="keyword">const</span> <span class="keywordtype">char</span> ** <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a> = malloc(<span class="keyword">sizeof</span>(*argv) * argvAlloced);
<a name="l01630"></a>01630     <span class="keywordtype">int</span> argc = 0;
<a name="l01631"></a>01631     <span class="keywordtype">int</span> buflen = strlen(s) + 1;
<a name="l01632"></a>01632     <span class="keywordtype">char</span> * buf = memset(<a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(buflen), 0, buflen);
<a name="l01633"></a>01633     <span class="keywordtype">int</span> rc = <a class="code" href="macro_8c.html#a505b06d56c7f646943bf86329f250f4">POPT_ERROR_MALLOC</a>;
<a name="l01634"></a>01634 
<a name="l01635"></a>01635     <span class="keywordflow">if</span> (argv == NULL) <span class="keywordflow">return</span> rc;
<a name="l01636"></a>01636     argv[argc] = buf;
<a name="l01637"></a>01637 
<a name="l01638"></a>01638     <span class="keywordflow">for</span> (src = s; *src != <span class="charliteral">'\0'</span>; src++) {
<a name="l01639"></a>01639         <span class="keywordflow">if</span> (quote == *src) {
<a name="l01640"></a>01640             quote = <span class="charliteral">'\0'</span>;
<a name="l01641"></a>01641         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (quote != <span class="charliteral">'\0'</span>) {
<a name="l01642"></a>01642             <span class="keywordflow">if</span> (*src == <span class="charliteral">'\\'</span>) {
<a name="l01643"></a>01643                 src++;
<a name="l01644"></a>01644                 <span class="keywordflow">if</span> (!*src) {
<a name="l01645"></a>01645                     rc = <a class="code" href="macro_8c.html#33d51ce6bde091c1bc6711179fbf098f">POPT_ERROR_BADQUOTE</a>;
<a name="l01646"></a>01646                     <span class="keywordflow">goto</span> exit;
<a name="l01647"></a>01647                 }
<a name="l01648"></a>01648                 <span class="keywordflow">if</span> (*src != quote) *buf++ = <span class="charliteral">'\\'</span>;
<a name="l01649"></a>01649             }
<a name="l01650"></a>01650             *buf++ = *src;
<a name="l01651"></a>01651         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isspace(*src)) {
<a name="l01652"></a>01652             <span class="keywordflow">if</span> (*argv[argc] != <span class="charliteral">'\0'</span>) {
<a name="l01653"></a>01653                 buf++, argc++;
<a name="l01654"></a>01654                 <span class="keywordflow">if</span> (argc == argvAlloced) {
<a name="l01655"></a>01655                     argvAlloced += <a class="code" href="macro_8c.html#08884d23a737e6bc3050d247bb74cdd5">POPT_ARGV_ARRAY_GROW_DELTA</a>;
<a name="l01656"></a>01656                     argv = realloc(argv, <span class="keyword">sizeof</span>(*argv) * argvAlloced);
<a name="l01657"></a>01657                     <span class="keywordflow">if</span> (argv == NULL) <span class="keywordflow">goto</span> exit;
<a name="l01658"></a>01658                 }
<a name="l01659"></a>01659                 argv[argc] = buf;
<a name="l01660"></a>01660             }
<a name="l01661"></a>01661         } <span class="keywordflow">else</span> <span class="keywordflow">switch</span> (*src) {
<a name="l01662"></a>01662           <span class="keywordflow">case</span> <span class="charliteral">'"'</span>:
<a name="l01663"></a>01663           <span class="keywordflow">case</span> <span class="charliteral">'\''</span>:
<a name="l01664"></a>01664             quote = *src;
<a name="l01665"></a>01665             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01666"></a>01666           <span class="keywordflow">case</span> <span class="charliteral">'\\'</span>:
<a name="l01667"></a>01667             src++;
<a name="l01668"></a>01668             <span class="keywordflow">if</span> (!*src) {
<a name="l01669"></a>01669                 rc = <a class="code" href="macro_8c.html#33d51ce6bde091c1bc6711179fbf098f">POPT_ERROR_BADQUOTE</a>;
<a name="l01670"></a>01670                 <span class="keywordflow">goto</span> exit;
<a name="l01671"></a>01671             }
<a name="l01672"></a>01672             <span class="comment">/*@fallthrough@*/</span>
<a name="l01673"></a>01673           <span class="keywordflow">default</span>:
<a name="l01674"></a>01674             *buf++ = *src;
<a name="l01675"></a>01675             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01676"></a>01676         }
<a name="l01677"></a>01677     }
<a name="l01678"></a>01678 
<a name="l01679"></a>01679     <span class="keywordflow">if</span> (strlen(argv[argc])) {
<a name="l01680"></a>01680         argc++, buf++;
<a name="l01681"></a>01681     }
<a name="l01682"></a>01682 
<a name="l01683"></a>01683     rc = <a class="code" href="macro_8c.html#b372d73e5421b21e665bc3f38d829f5c">XpoptDupArgv</a>(argc, argv, argcPtr, argvPtr);
<a name="l01684"></a>01684 
<a name="l01685"></a>01685 exit:
<a name="l01686"></a>01686     <span class="keywordflow">if</span> (argv) free(argv);
<a name="l01687"></a>01687     <span class="keywordflow">return</span> rc;
<a name="l01688"></a>01688 }
<a name="l01689"></a>01689 <span class="comment">/*@=bounds@*/</span>
<a name="l01690"></a>01690 <span class="comment">/* =============================================================== */</span>
<a name="l01691"></a>01691 <span class="comment">/*@unchecked@*/</span>
<a name="l01692"></a><a class="code" href="macro_8c.html#3f39405c2d7c0f545d6b90051f250c85">01692</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="poptALL_8c.html#3f39405c2d7c0f545d6b90051f250c85">_debug</a> = 0;
<a name="l01693"></a>01693 
<a name="l01694"></a><a class="code" href="rpmmacro_8h.html#23a786648d20cfb9c84b8eb4946c4a40">01694</a> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#23a786648d20cfb9c84b8eb4946c4a40" title="Return URL path(s) from a (URL prefixed) pattern glob.">rpmGlob</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * patterns, <span class="keywordtype">int</span> * argcPtr, <span class="keyword">const</span> <span class="keywordtype">char</span> *** argvPtr)
<a name="l01695"></a>01695 {
<a name="l01696"></a>01696     <span class="keywordtype">int</span> ac = 0;
<a name="l01697"></a>01697     <span class="keyword">const</span> <span class="keywordtype">char</span> ** av = NULL;
<a name="l01698"></a>01698     <span class="keywordtype">int</span> argc = 0;
<a name="l01699"></a>01699     <span class="keyword">const</span> <span class="keywordtype">char</span> ** <a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a> = NULL;
<a name="l01700"></a>01700     <span class="keywordtype">char</span> * globRoot = NULL;
<a name="l01701"></a>01701 <span class="preprocessor">#ifdef ENABLE_NLS</span>
<a name="l01702"></a>01702 <span class="preprocessor"></span>    <span class="keyword">const</span> <span class="keywordtype">char</span> * old_collate = NULL;
<a name="l01703"></a>01703     <span class="keyword">const</span> <span class="keywordtype">char</span> * old_ctype = NULL;
<a name="l01704"></a>01704     <span class="keyword">const</span> <span class="keywordtype">char</span> * t;
<a name="l01705"></a>01705 <span class="preprocessor">#endif</span>
<a name="l01706"></a>01706 <span class="preprocessor"></span>        <span class="keywordtype">size_t</span> maxb, nb;
<a name="l01707"></a>01707     <span class="keywordtype">int</span> i, j;
<a name="l01708"></a>01708     <span class="keywordtype">int</span> rc;
<a name="l01709"></a>01709 
<a name="l01710"></a>01710     rc = <a class="code" href="macro_8c.html#0a2c716b765b8bd681d7b1c033eccd03">XpoptParseArgvString</a>(patterns, &amp;ac, &amp;av);
<a name="l01711"></a>01711     <span class="keywordflow">if</span> (rc)
<a name="l01712"></a>01712         <span class="keywordflow">return</span> rc;
<a name="l01713"></a>01713 <span class="preprocessor">#ifdef ENABLE_NLS</span>
<a name="l01714"></a>01714 <span class="preprocessor"></span><span class="comment">/*@-branchstate@*/</span>
<a name="l01715"></a>01715         t = <a class="code" href="system_8h.html#a47f05250104fa292814ebe43195eaad">setlocale</a>(LC_COLLATE, NULL);
<a name="l01716"></a>01716         <span class="keywordflow">if</span> (t)
<a name="l01717"></a>01717             old_collate = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(t);
<a name="l01718"></a>01718         t = <a class="code" href="system_8h.html#a47f05250104fa292814ebe43195eaad">setlocale</a>(LC_CTYPE, NULL);
<a name="l01719"></a>01719         <span class="keywordflow">if</span> (t)
<a name="l01720"></a>01720             old_ctype = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(t);
<a name="l01721"></a>01721 <span class="comment">/*@=branchstate@*/</span>
<a name="l01722"></a>01722         (void) <a class="code" href="system_8h.html#a47f05250104fa292814ebe43195eaad">setlocale</a>(LC_COLLATE, <span class="stringliteral">"C"</span>);
<a name="l01723"></a>01723         (void) <a class="code" href="system_8h.html#a47f05250104fa292814ebe43195eaad">setlocale</a>(LC_CTYPE, <span class="stringliteral">"C"</span>);
<a name="l01724"></a>01724 <span class="preprocessor">#endif</span>
<a name="l01725"></a>01725 <span class="preprocessor"></span>        
<a name="l01726"></a>01726     <span class="keywordflow">if</span> (av != NULL)
<a name="l01727"></a>01727     <span class="keywordflow">for</span> (j = 0; j &lt; ac; j++) {
<a name="l01728"></a>01728         <span class="keyword">const</span> <span class="keywordtype">char</span> * globURL;
<a name="l01729"></a>01729         <span class="keyword">const</span> <span class="keywordtype">char</span> * path;
<a name="l01730"></a>01730         <span class="keywordtype">int</span> ut = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(av[j], &amp;path);
<a name="l01731"></a>01731         glob_t gl;
<a name="l01732"></a>01732 
<a name="l01733"></a>01733         <span class="keywordflow">if</span> (!<a class="code" href="rpmio_8h.html#d92003483b916d1f9693c28417295380" title="glob_pattern_p(3) clone.">Glob_pattern_p</a>(av[j], 0) &amp;&amp; strchr(path, <span class="charliteral">'~'</span>) == NULL) {
<a name="l01734"></a>01734             argv = <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(argv, (argc+2) * <span class="keyword">sizeof</span>(*argv));
<a name="l01735"></a>01735             argv[argc] = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(av[j]);
<a name="l01736"></a>01736 <span class="keywordflow">if</span> (_debug)
<a name="l01737"></a>01737 fprintf(stderr, <span class="stringliteral">"*** rpmGlob argv[%d] \"%s\"\n"</span>, argc, argv[argc]);
<a name="l01738"></a>01738             argc++;
<a name="l01739"></a>01739             <span class="keywordflow">continue</span>;
<a name="l01740"></a>01740         }
<a name="l01741"></a>01741         
<a name="l01742"></a>01742         gl.gl_pathc = 0;
<a name="l01743"></a>01743         gl.gl_pathv = NULL;
<a name="l01744"></a>01744         rc = <a class="code" href="rpmio_8h.html#8590e46ff15baa94f03af6dadc4176f6" title="glob(3) clone.">Glob</a>(av[j], GLOB_TILDE, <a class="code" href="rpmio_8h.html#f187c00f43de8bc1d0586e6b6ba827f3" title="glob_error(3) clone.">Glob_error</a>, &amp;gl);
<a name="l01745"></a>01745         <span class="keywordflow">if</span> (rc)
<a name="l01746"></a>01746             <span class="keywordflow">goto</span> exit;
<a name="l01747"></a>01747 
<a name="l01748"></a>01748         <span class="comment">/* XXX Prepend the URL leader for globs that have stripped it off */</span>
<a name="l01749"></a>01749         maxb = 0;
<a name="l01750"></a>01750         <span class="keywordflow">for</span> (i = 0; i &lt; gl.gl_pathc; i++) {
<a name="l01751"></a>01751             <span class="keywordflow">if</span> ((nb = strlen(&amp;(gl.gl_pathv[i][0]))) &gt; maxb)
<a name="l01752"></a>01752                 maxb = nb;
<a name="l01753"></a>01753         }
<a name="l01754"></a>01754         
<a name="l01755"></a>01755         nb = ((ut == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>) ? (path - av[j]) : 0);
<a name="l01756"></a>01756         maxb += nb;
<a name="l01757"></a>01757         maxb += 1;
<a name="l01758"></a>01758         globURL = globRoot = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(maxb);
<a name="l01759"></a>01759 
<a name="l01760"></a>01760         <span class="keywordflow">switch</span> (ut) {
<a name="l01761"></a>01761         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l01762"></a>01762         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l01763"></a>01763             strncpy(globRoot, av[j], nb);
<a name="l01764"></a>01764             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01765"></a>01765         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l01766"></a>01766         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l01767"></a>01767         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l01768"></a>01768         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l01769"></a>01769         <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l01770"></a>01770         <span class="keywordflow">default</span>:
<a name="l01771"></a>01771             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01772"></a>01772         }
<a name="l01773"></a>01773         globRoot += nb;
<a name="l01774"></a>01774         *globRoot = <span class="charliteral">'\0'</span>;
<a name="l01775"></a>01775 <span class="keywordflow">if</span> (_debug)
<a name="l01776"></a>01776 fprintf(stderr, <span class="stringliteral">"*** GLOB maxb %d diskURL %d %*s globURL %p %s\n"</span>, (<span class="keywordtype">int</span>)maxb, (<span class="keywordtype">int</span>)nb, (<span class="keywordtype">int</span>)nb, av[j], globURL, globURL);
<a name="l01777"></a>01777         
<a name="l01778"></a>01778         argv = <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(argv, (argc+gl.gl_pathc+1) * <span class="keyword">sizeof</span>(*argv));
<a name="l01779"></a>01779 
<a name="l01780"></a>01780         <span class="keywordflow">if</span> (argv != NULL)
<a name="l01781"></a>01781         <span class="keywordflow">for</span> (i = 0; i &lt; gl.gl_pathc; i++) {
<a name="l01782"></a>01782             <span class="keyword">const</span> <span class="keywordtype">char</span> * globFile = &amp;(gl.gl_pathv[i][0]);
<a name="l01783"></a>01783             if (globRoot &gt; globURL &amp;&amp; globRoot[-1] == <span class="charliteral">'/'</span>)
<a name="l01784"></a>01784                 <span class="keywordflow">while</span> (*globFile == <span class="charliteral">'/'</span>) globFile++;
<a name="l01785"></a>01785             strcpy(globRoot, globFile);
<a name="l01786"></a>01786 <span class="keywordflow">if</span> (_debug)
<a name="l01787"></a>01787 fprintf(stderr, <span class="stringliteral">"*** rpmGlob argv[%d] \"%s\"\n"</span>, argc, globURL);
<a name="l01788"></a>01788             argv[argc++] = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(globURL);
<a name="l01789"></a>01789         }
<a name="l01790"></a>01790         <span class="comment">/*@-immediatetrans@*/</span>
<a name="l01791"></a>01791         <a class="code" href="rpmio_8h.html#71345070319bb45c9b69d0104cf2ca88" title="globfree(3) clone.">Globfree</a>(&amp;gl);
<a name="l01792"></a>01792         <span class="comment">/*@=immediatetrans@*/</span>
<a name="l01793"></a>01793         globURL = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(globURL);
<a name="l01794"></a>01794     }
<a name="l01795"></a>01795 
<a name="l01796"></a>01796     <span class="keywordflow">if</span> (argv != NULL &amp;&amp; argc &gt; 0) {
<a name="l01797"></a>01797         argv[argc] = NULL;
<a name="l01798"></a>01798         <span class="keywordflow">if</span> (argvPtr)
<a name="l01799"></a>01799             *argvPtr = argv;
<a name="l01800"></a>01800         <span class="keywordflow">if</span> (argcPtr)
<a name="l01801"></a>01801             *argcPtr = argc;
<a name="l01802"></a>01802         rc = 0;
<a name="l01803"></a>01803     } <span class="keywordflow">else</span>
<a name="l01804"></a>01804         rc = 1;
<a name="l01805"></a>01805 
<a name="l01806"></a>01806 
<a name="l01807"></a>01807 exit:
<a name="l01808"></a>01808 <span class="preprocessor">#ifdef ENABLE_NLS       </span>
<a name="l01809"></a>01809 <span class="preprocessor"></span><span class="comment">/*@-branchstate@*/</span>
<a name="l01810"></a>01810     <span class="keywordflow">if</span> (old_collate) {
<a name="l01811"></a>01811         (void) <a class="code" href="system_8h.html#a47f05250104fa292814ebe43195eaad">setlocale</a>(LC_COLLATE, old_collate);
<a name="l01812"></a>01812         old_collate = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(old_collate);
<a name="l01813"></a>01813     }
<a name="l01814"></a>01814     <span class="keywordflow">if</span> (old_ctype) {
<a name="l01815"></a>01815         (void) <a class="code" href="system_8h.html#a47f05250104fa292814ebe43195eaad">setlocale</a>(LC_CTYPE, old_ctype);
<a name="l01816"></a>01816         old_ctype = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(old_ctype);
<a name="l01817"></a>01817     }
<a name="l01818"></a>01818 <span class="comment">/*@=branchstate@*/</span>
<a name="l01819"></a>01819 <span class="preprocessor">#endif</span>
<a name="l01820"></a>01820 <span class="preprocessor"></span>    av = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(av);
<a name="l01821"></a>01821 <span class="comment">/*@-branchstate@*/</span>
<a name="l01822"></a>01822     <span class="keywordflow">if</span> (rc || argvPtr == NULL) {
<a name="l01823"></a>01823 <span class="comment">/*@-dependenttrans -unqualifiedtrans@*/</span>
<a name="l01824"></a>01824         <span class="keywordflow">if</span> (argv != NULL)
<a name="l01825"></a>01825         <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++)
<a name="l01826"></a>01826             argv[i] = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(argv[i]);
<a name="l01827"></a>01827         argv = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(argv);
<a name="l01828"></a>01828 <span class="comment">/*@=dependenttrans =unqualifiedtrans@*/</span>
<a name="l01829"></a>01829     }
<a name="l01830"></a>01830 <span class="comment">/*@=branchstate@*/</span>
<a name="l01831"></a>01831     <span class="keywordflow">return</span> rc;
<a name="l01832"></a>01832 }
<a name="l01833"></a>01833 
<a name="l01834"></a>01834 <span class="comment">/* =============================================================== */</span>
<a name="l01835"></a>01835 
<a name="l01836"></a>01836 <span class="keywordtype">int</span>
<a name="l01837"></a><a class="code" href="rpmmacro_8h.html#cada855232974c4a3985847565be312e">01837</a> <a class="code" href="macro_8c.html#cada855232974c4a3985847565be312e" title="Expand macro into buffer.">expandMacros</a>(<span class="keywordtype">void</span> * spec, <a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keywordtype">char</span> * sbuf, <span class="keywordtype">size_t</span> slen)
<a name="l01838"></a>01838 {
<a name="l01839"></a>01839     <a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(<span class="keyword">sizeof</span>(*mb));
<a name="l01840"></a>01840     <span class="keywordtype">char</span> *tbuf;
<a name="l01841"></a>01841     <span class="keywordtype">int</span> rc;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843     <span class="keywordflow">if</span> (sbuf == NULL || slen == 0)
<a name="l01844"></a>01844         <span class="keywordflow">return</span> 0;
<a name="l01845"></a>01845     <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l01846"></a>01846 
<a name="l01847"></a>01847     tbuf = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(slen + 1);
<a name="l01848"></a>01848     memset(tbuf, 0, (slen + 1));
<a name="l01849"></a>01849 
<a name="l01850"></a>01850     mb-&gt;s = sbuf;
<a name="l01851"></a>01851     mb-&gt;t = tbuf;
<a name="l01852"></a>01852     mb-&gt;nb = slen;
<a name="l01853"></a>01853     mb-&gt;depth = 0;
<a name="l01854"></a>01854     mb-&gt;macro_trace = <a class="code" href="macro_8c.html#69c82ff03bf0a250cd73e00eb2059897">print_macro_trace</a>;
<a name="l01855"></a>01855     mb-&gt;expand_trace = <a class="code" href="macro_8c.html#1e97e767636425e2fbe9b7578ca48cd0">print_expand_trace</a>;
<a name="l01856"></a>01856 
<a name="l01857"></a>01857     mb-&gt;spec = spec;    <span class="comment">/* (future) %file expansion info */</span>
<a name="l01858"></a>01858     mb-&gt;mc = mc;
<a name="l01859"></a>01859 
<a name="l01860"></a>01860     rc = <a class="code" href="macro_8c.html#b68634c5902ddbad4b09d062a3f707ed" title="The main macro recursion loop.">expandMacro</a>(mb);
<a name="l01861"></a>01861 
<a name="l01862"></a>01862     <span class="keywordflow">if</span> (mb-&gt;nb == 0)
<a name="l01863"></a>01863         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"Target buffer overflow\n"</span>));
<a name="l01864"></a>01864 
<a name="l01865"></a>01865     tbuf[slen] = <span class="charliteral">'\0'</span>;  <span class="comment">/* XXX just in case */</span>
<a name="l01866"></a>01866     strncpy(sbuf, tbuf, (slen - mb-&gt;nb + 1));
<a name="l01867"></a>01867 
<a name="l01868"></a>01868     <span class="keywordflow">return</span> rc;
<a name="l01869"></a>01869 }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871 <span class="keywordtype">void</span>
<a name="l01872"></a><a class="code" href="rpmmacro_8h.html#3851992697896dc8ed8f0be8ca6ec3e4">01872</a> <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc,
<a name="l01873"></a>01873         <span class="keyword">const</span> <span class="keywordtype">char</span> * n, <span class="keyword">const</span> <span class="keywordtype">char</span> * o, <span class="keyword">const</span> <span class="keywordtype">char</span> * b, <span class="keywordtype">int</span> <a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a>)
<a name="l01874"></a>01874 {
<a name="l01875"></a>01875     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> * mep;
<a name="l01876"></a>01876 
<a name="l01877"></a>01877     <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l01878"></a>01878 
<a name="l01879"></a>01879     <span class="comment">/* If new name, expand macro table */</span>
<a name="l01880"></a>01880     <span class="keywordflow">if</span> ((mep = <a class="code" href="header_8c.html#822829bcd46d0c6e9e1ea68927351f1d" title="Find matching (tag,type) entry in header.">findEntry</a>(mc, n, 0)) == NULL) {
<a name="l01881"></a>01881         <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a> == mc-&gt;<a class="code" href="structMacroContext__s.html#fe73871ef47a02cf23b2fa193182f4bc">macrosAllocated</a>)
<a name="l01882"></a>01882             <a class="code" href="macro_8c.html#15ee0f5f86ab8580678dd446367c22bf" title="Enlarge macro table.">expandMacroTable</a>(mc);
<a name="l01883"></a>01883         <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> != NULL)
<a name="l01884"></a>01884             mep = mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> + mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>++;
<a name="l01885"></a>01885     }
<a name="l01886"></a>01886 
<a name="l01887"></a>01887     <span class="keywordflow">if</span> (mep != NULL) {
<a name="l01888"></a>01888         <span class="comment">/* Push macro over previous definition */</span>
<a name="l01889"></a>01889         <a class="code" href="macro_8c.html#1d34891b83f459aa258da314398c6dc2" title="Push new macro definition onto macro entry stack.">pushMacro</a>(mep, n, o, b, level);
<a name="l01890"></a>01890 
<a name="l01891"></a>01891         <span class="comment">/* If new name, sort macro table */</span>
<a name="l01892"></a>01892         <span class="keywordflow">if</span> ((*mep)-&gt;prev == NULL)
<a name="l01893"></a>01893             <a class="code" href="macro_8c.html#41b48bc6dda66614c6d072c631b948ea" title="Sort entries in macro table.">sortMacroTable</a>(mc);
<a name="l01894"></a>01894     }
<a name="l01895"></a>01895 }
<a name="l01896"></a>01896 
<a name="l01897"></a>01897 <span class="keywordtype">void</span>
<a name="l01898"></a><a class="code" href="rpmmacro_8h.html#6a0c98bd34099103b42dcbae343d8366">01898</a> <a class="code" href="macro_8c.html#6a0c98bd34099103b42dcbae343d8366" title="Delete macro from context.">delMacro</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keyword">const</span> <span class="keywordtype">char</span> * n)
<a name="l01899"></a>01899 {
<a name="l01900"></a>01900     <a class="code" href="structMacroEntry__s.html">MacroEntry</a> * mep;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902     <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l01903"></a>01903     <span class="comment">/* If name exists, pop entry */</span>
<a name="l01904"></a>01904     <span class="keywordflow">if</span> ((mep = <a class="code" href="header_8c.html#822829bcd46d0c6e9e1ea68927351f1d" title="Find matching (tag,type) entry in header.">findEntry</a>(mc, n, 0)) != NULL) {
<a name="l01905"></a>01905         <a class="code" href="macro_8c.html#de97f1374f70353bbc573ee4f8c5b6df" title="Pop macro definition from macro entry stack.">popMacro</a>(mep);
<a name="l01906"></a>01906         <span class="comment">/* If deleted name, sort macro table */</span>
<a name="l01907"></a>01907         <span class="keywordflow">if</span> (!(mep &amp;&amp; *mep))
<a name="l01908"></a>01908             <a class="code" href="macro_8c.html#41b48bc6dda66614c6d072c631b948ea" title="Sort entries in macro table.">sortMacroTable</a>(mc);
<a name="l01909"></a>01909     }
<a name="l01910"></a>01910 }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912 <span class="comment">/*@-mustmod@*/</span> <span class="comment">/* LCL: mc is modified through mb-&gt;mc, mb is abstract */</span>
<a name="l01913"></a>01913 <span class="keywordtype">int</span>
<a name="l01914"></a><a class="code" href="rpmmacro_8h.html#1f883e66bb4e62be1f845a32dfebf909">01914</a> <a class="code" href="macro_8c.html#1f883e66bb4e62be1f845a32dfebf909" title="Define macro in context.">rpmDefineMacro</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keyword">const</span> <span class="keywordtype">char</span> * macro, <span class="keywordtype">int</span> <a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a>)
<a name="l01915"></a>01915 {
<a name="l01916"></a>01916     <a class="code" href="structMacroBuf__s.html" title="Macro expansion state.">MacroBuf</a> mb = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(<span class="keyword">sizeof</span>(*mb));
<a name="l01917"></a>01917 
<a name="l01918"></a>01918     memset(mb, 0, <span class="keyword">sizeof</span>(*mb));
<a name="l01919"></a>01919     <span class="comment">/* XXX just enough to get by */</span>
<a name="l01920"></a>01920     mb-&gt;mc = (mc ? mc : <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>);
<a name="l01921"></a>01921     (void) <a class="code" href="macro_8c.html#a282776f7081c9e47a0299cf2a103edf" title="Parse (and execute) new macro definition.">doDefine</a>(mb, macro, level, 0);
<a name="l01922"></a>01922     <span class="keywordflow">return</span> 0;
<a name="l01923"></a>01923 }
<a name="l01924"></a>01924 <span class="comment">/*@=mustmod@*/</span>
<a name="l01925"></a>01925 
<a name="l01926"></a>01926 <span class="keywordtype">void</span>
<a name="l01927"></a><a class="code" href="rpmmacro_8h.html#7be7c89640e5f467d11c83850daaa561">01927</a> <a class="code" href="macro_8c.html#7be7c89640e5f467d11c83850daaa561" title="Load macros from specific context into global context.">rpmLoadMacros</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keywordtype">int</span> <a class="code" href="structMacroEntry__s.html#a9600899393c6f6d64fc9967eb3d753f">level</a>)
<a name="l01928"></a>01928 {
<a name="l01929"></a>01929 
<a name="l01930"></a>01930     <span class="keywordflow">if</span> (mc == NULL || mc == <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>)
<a name="l01931"></a>01931         <span class="keywordflow">return</span>;
<a name="l01932"></a>01932 
<a name="l01933"></a>01933     <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> != NULL) {
<a name="l01934"></a>01934         <span class="keywordtype">int</span> i;
<a name="l01935"></a>01935         <span class="keywordflow">for</span> (i = 0; i &lt; mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>; i++) {
<a name="l01936"></a>01936             <a class="code" href="structMacroEntry__s.html">MacroEntry</a> *mep, me;
<a name="l01937"></a>01937             mep = &amp;mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[i];
<a name="l01938"></a>01938             me = *mep;
<a name="l01939"></a>01939 
<a name="l01940"></a>01940             <span class="keywordflow">if</span> (me == NULL)             <span class="comment">/* XXX this should never happen */</span>
<a name="l01941"></a>01941                 <span class="keywordflow">continue</span>;
<a name="l01942"></a>01942             <a class="code" href="macro_8c.html#3851992697896dc8ed8f0be8ca6ec3e4" title="Add macro to context.">addMacro</a>(NULL, me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>, me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a>, me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>, (level - 1));
<a name="l01943"></a>01943         }
<a name="l01944"></a>01944     }
<a name="l01945"></a>01945 }
<a name="l01946"></a>01946 
<a name="l01947"></a>01947 <span class="keywordtype">int</span>
<a name="l01948"></a><a class="code" href="rpmmacro_8h.html#c4f124ad466a01f576e64246677fd402">01948</a> <a class="code" href="macro_8c.html#c4f124ad466a01f576e64246677fd402" title="Load macro context from a macro file.">rpmLoadMacroFile</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keyword">const</span> <span class="keywordtype">char</span> * fn)
<a name="l01949"></a>01949 {
<a name="l01950"></a>01950     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fn, <span class="stringliteral">"r.fpio"</span>);
<a name="l01951"></a>01951     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l01952"></a>01952     <span class="keywordtype">int</span> rc = -1;
<a name="l01953"></a>01953 
<a name="l01954"></a>01954     <span class="keywordflow">if</span> (fd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd)) {
<a name="l01955"></a>01955         <span class="keywordflow">if</span> (fd) (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l01956"></a>01956         <span class="keywordflow">return</span> rc;
<a name="l01957"></a>01957     }
<a name="l01958"></a>01958 
<a name="l01959"></a>01959     <span class="comment">/* XXX Assume new fangled macro expansion */</span>
<a name="l01960"></a>01960     <span class="comment">/*@-mods@*/</span>
<a name="l01961"></a>01961     <a class="code" href="macro_8c.html#8351a2449d4ccc57c8e5c1451af359ed">max_macro_depth</a> = 16;
<a name="l01962"></a>01962     <span class="comment">/*@=mods@*/</span>
<a name="l01963"></a>01963 
<a name="l01964"></a>01964     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l01965"></a>01965     <span class="keywordflow">while</span>(<a class="code" href="macro_8c.html#c9f1be5e4270f95d099e04074c229c7f" title="fgets(3) analogue that reads \ continuations.">rdcl</a>(buf, <span class="keyword">sizeof</span>(buf), fd) != NULL) {
<a name="l01966"></a>01966         <span class="keywordtype">char</span> c, *n;
<a name="l01967"></a>01967 
<a name="l01968"></a>01968         n = buf;
<a name="l01969"></a>01969         <a class="code" href="macro_8c.html#98b7074538fdb646782dba735da571ec">SKIPBLANK</a>(n, c);
<a name="l01970"></a>01970 
<a name="l01971"></a>01971         <span class="keywordflow">if</span> (c != <span class="charliteral">'%'</span>)
<a name="l01972"></a>01972                 <span class="keywordflow">continue</span>;
<a name="l01973"></a>01973         n++;    <span class="comment">/* skip % */</span>
<a name="l01974"></a>01974         rc = <a class="code" href="macro_8c.html#1f883e66bb4e62be1f845a32dfebf909" title="Define macro in context.">rpmDefineMacro</a>(mc, n, <a class="code" href="rpmmacro_8h.html#29c8c3f3fa48f674489f701f1af1301b">RMIL_MACROFILES</a>);
<a name="l01975"></a>01975     }
<a name="l01976"></a>01976     rc = <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l01977"></a>01977     <span class="keywordflow">return</span> rc;
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 
<a name="l01980"></a>01980 <span class="keywordtype">void</span>
<a name="l01981"></a><a class="code" href="rpmmacro_8h.html#20f51fff5c09dc3d34a024815dcafc10">01981</a> <a class="code" href="macro_8c.html#20f51fff5c09dc3d34a024815dcafc10" title="Initialize macro context from set of macrofile(s).">rpmInitMacros</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc, <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="group__rpmrc.html#g4ce2e6096bc4567e6aeee576fe8f9f2e" title="List of macro files to read when configuring rpm.">macrofiles</a>)
<a name="l01982"></a>01982 {
<a name="l01983"></a>01983     <span class="keywordtype">char</span> *mfiles, *m, *me;
<a name="l01984"></a>01984 
<a name="l01985"></a>01985     <span class="keywordflow">if</span> (macrofiles == NULL)
<a name="l01986"></a>01986         <span class="keywordflow">return</span>;
<a name="l01987"></a>01987 <span class="preprocessor">#ifdef  DYING</span>
<a name="l01988"></a>01988 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l01989"></a>01989 <span class="preprocessor">#endif</span>
<a name="l01990"></a>01990 <span class="preprocessor"></span>
<a name="l01991"></a>01991     mfiles = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(macrofiles);
<a name="l01992"></a>01992     <span class="keywordflow">for</span> (m = mfiles; m &amp;&amp; *m != <span class="charliteral">'\0'</span>; m = me) {
<a name="l01993"></a>01993         <span class="keyword">const</span> <span class="keywordtype">char</span> ** av;
<a name="l01994"></a>01994         <span class="keywordtype">int</span> ac;
<a name="l01995"></a>01995         <span class="keywordtype">int</span> i;
<a name="l01996"></a>01996 
<a name="l01997"></a>01997         <span class="keywordflow">for</span> (me = m; (me = strchr(me, <span class="charliteral">':'</span>)) != NULL; me++) {
<a name="l01998"></a>01998             <span class="comment">/* Skip over URI's. */</span>
<a name="l01999"></a>01999             <span class="keywordflow">if</span> (!(me[1] == <span class="charliteral">'/'</span> &amp;&amp; me[2] == <span class="charliteral">'/'</span>))
<a name="l02000"></a>02000                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02001"></a>02001         }
<a name="l02002"></a>02002 
<a name="l02003"></a>02003         <span class="keywordflow">if</span> (me &amp;&amp; *me == <span class="charliteral">':'</span>)
<a name="l02004"></a>02004             *me++ = <span class="charliteral">'\0'</span>;
<a name="l02005"></a>02005         <span class="keywordflow">else</span>
<a name="l02006"></a>02006             me = m + strlen(m);
<a name="l02007"></a>02007 
<a name="l02008"></a>02008         <span class="comment">/* Glob expand the macro file path element, expanding ~ to $HOME. */</span>
<a name="l02009"></a>02009         ac = 0;
<a name="l02010"></a>02010         av = NULL;
<a name="l02011"></a>02011         i = <a class="code" href="macro_8c.html#23a786648d20cfb9c84b8eb4946c4a40" title="Return URL path(s) from a (URL prefixed) pattern glob.">rpmGlob</a>(m, &amp;ac, &amp;av);
<a name="l02012"></a>02012         <span class="keywordflow">if</span> (i != 0)
<a name="l02013"></a>02013             <span class="keywordflow">continue</span>;
<a name="l02014"></a>02014 
<a name="l02015"></a>02015         <span class="comment">/* Read macros from each file. */</span>
<a name="l02016"></a>02016         <span class="keywordflow">for</span> (i = 0; i &lt; ac; i++) {
<a name="l02017"></a>02017             <span class="keywordflow">if</span> (strstr(av[i], <span class="stringliteral">".rpmnew"</span>) || 
<a name="l02018"></a>02018                 strstr(av[i], <span class="stringliteral">".rpmsave"</span>) ||
<a name="l02019"></a>02019                 strstr(av[i], <span class="stringliteral">".rpmorig"</span>)) {
<a name="l02020"></a>02020                 <span class="keywordflow">continue</span>;
<a name="l02021"></a>02021             }
<a name="l02022"></a>02022             (void) <a class="code" href="macro_8c.html#c4f124ad466a01f576e64246677fd402" title="Load macro context from a macro file.">rpmLoadMacroFile</a>(mc, av[i]);
<a name="l02023"></a>02023             av[i] = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(av[i]);
<a name="l02024"></a>02024         }
<a name="l02025"></a>02025         av = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(av);
<a name="l02026"></a>02026     }
<a name="l02027"></a>02027     mfiles = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(mfiles);
<a name="l02028"></a>02028 
<a name="l02029"></a>02029     <span class="comment">/* Reload cmdline macros */</span>
<a name="l02030"></a>02030     <span class="comment">/*@-mods@*/</span>
<a name="l02031"></a>02031     <a class="code" href="macro_8c.html#7be7c89640e5f467d11c83850daaa561" title="Load macros from specific context into global context.">rpmLoadMacros</a>(<a class="code" href="rpmlib_8h.html#8006c2dbfafa9d855483d850e26c52d8">rpmCLIMacroContext</a>, <a class="code" href="rpmmacro_8h.html#5b2d68d6400d76546c157105103e51fd">RMIL_CMDLINE</a>);
<a name="l02032"></a>02032     <span class="comment">/*@=mods@*/</span>
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
<a name="l02035"></a>02035 <span class="comment">/*@-globstate@*/</span>
<a name="l02036"></a>02036 <span class="keywordtype">void</span>
<a name="l02037"></a><a class="code" href="rpmmacro_8h.html#b02b0d47ca43105f753852324a44caa9">02037</a> <a class="code" href="macro_8c.html#b02b0d47ca43105f753852324a44caa9" title="Destroy macro context.">rpmFreeMacros</a>(<a class="code" href="structMacroContext__s.html">MacroContext</a> mc)
<a name="l02038"></a>02038 {
<a name="l02039"></a>02039     
<a name="l02040"></a>02040     <span class="keywordflow">if</span> (mc == NULL) mc = <a class="code" href="rpmlib_8h.html#5f1e66bfdc1ff8894d704a5c98fb25f4">rpmGlobalMacroContext</a>;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042     <span class="keywordflow">if</span> (mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> != NULL) {
<a name="l02043"></a>02043         <span class="keywordtype">int</span> i;
<a name="l02044"></a>02044         <span class="keywordflow">for</span> (i = 0; i &lt; mc-&gt;<a class="code" href="structMacroContext__s.html#cf858e6e75c23c0f5ba3e739db265f05">firstFree</a>; i++) {
<a name="l02045"></a>02045             <a class="code" href="structMacroEntry__s.html">MacroEntry</a> me;
<a name="l02046"></a>02046             <span class="keywordflow">while</span> ((me = mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[i]) != NULL) {
<a name="l02047"></a>02047                 <span class="comment">/* XXX cast to workaround const */</span>
<a name="l02048"></a>02048                 <span class="comment">/*@-onlytrans@*/</span>
<a name="l02049"></a>02049                 if ((mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>[i] = me-&gt;<a class="code" href="structMacroEntry__s.html#86899fe1cbe05246411e6fef95387887">prev</a>) == NULL)
<a name="l02050"></a>02050                     me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me-&gt;<a class="code" href="structMacroEntry__s.html#1c49658591b90658ec8f8683582722fb">name</a>);
<a name="l02051"></a>02051                 <span class="comment">/*@=onlytrans@*/</span>
<a name="l02052"></a>02052                 me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me-&gt;<a class="code" href="structMacroEntry__s.html#8f922734d946e85e2560464e81afc22b">opts</a>);
<a name="l02053"></a>02053                 me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me-&gt;<a class="code" href="structMacroEntry__s.html#7da20fe1f3112cb4b940825edbd2fa05">body</a>);
<a name="l02054"></a>02054                 me = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(me);
<a name="l02055"></a>02055             }
<a name="l02056"></a>02056         }
<a name="l02057"></a>02057         mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(mc-&gt;<a class="code" href="structMacroContext__s.html#bebdd2c791d3ecb3e5d529a555aebd1e">macroTable</a>);
<a name="l02058"></a>02058     }
<a name="l02059"></a>02059     memset(mc, 0, <span class="keyword">sizeof</span>(*mc));
<a name="l02060"></a>02060 }
<a name="l02061"></a>02061 <span class="comment">/*@=globstate@*/</span>
<a name="l02062"></a>02062 
<a name="l02063"></a>02063 <span class="comment">/* =============================================================== */</span>
<a name="l02064"></a><a class="code" href="rpmmacro_8h.html#1495956d59eccf3a9521661f9fc50890">02064</a> <span class="keywordtype">int</span> <a class="code" href="macro_8c.html#1495956d59eccf3a9521661f9fc50890" title="Return type of compression used in file.">isCompressed</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a>, <a class="code" href="rpmmacro_8h.html#7eb1d040bd267cb5c6188db828d447d1">rpmCompressedMagic</a> * compressed)
<a name="l02065"></a>02065 {
<a name="l02066"></a>02066     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l02067"></a>02067     ssize_t nb;
<a name="l02068"></a>02068     <span class="keywordtype">int</span> rc = -1;
<a name="l02069"></a>02069     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structmagic.html">magic</a>[4];
<a name="l02070"></a>02070 
<a name="l02071"></a>02071     *compressed = <a class="code" href="rpmmacro_8h.html#8b147c8bfb002dbd493b41a6f9d9e0a3a5fc8adce7e95a067c2194fdb70a1f75">COMPRESSED_NOT</a>;
<a name="l02072"></a>02072 
<a name="l02073"></a>02073     fd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(file, <span class="stringliteral">"r.ufdio"</span>);
<a name="l02074"></a>02074     <span class="keywordflow">if</span> (fd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd)) {
<a name="l02075"></a>02075         <span class="comment">/* XXX Fstrerror */</span>
<a name="l02076"></a>02076         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"File %s: %s\n"</span>), file, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l02077"></a>02077         <span class="keywordflow">if</span> (fd) (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l02078"></a>02078         <span class="keywordflow">return</span> 1;
<a name="l02079"></a>02079     }
<a name="l02080"></a>02080     nb = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(magic, <span class="keyword">sizeof</span>(magic[0]), <span class="keyword">sizeof</span>(magic), fd);
<a name="l02081"></a>02081     <span class="keywordflow">if</span> (nb &lt; 0) {
<a name="l02082"></a>02082         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"File %s: %s\n"</span>), file, <a class="code" href="rpmio_8c.html#89912365365ef408f46a76f2958fc78c" title="strerror(3) clone.">Fstrerror</a>(fd));
<a name="l02083"></a>02083         rc = 1;
<a name="l02084"></a>02084     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nb &lt; <span class="keyword">sizeof</span>(magic)) {
<a name="l02085"></a>02085         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(<a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bae3dd567b831f00df03cb22bceec4ab33">RPMERR_BADSPEC</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"File %s is smaller than %u bytes\n"</span>),
<a name="l02086"></a>02086                 file, (<span class="keywordtype">unsigned</span>)<span class="keyword">sizeof</span>(magic));
<a name="l02087"></a>02087         rc = 0;
<a name="l02088"></a>02088     }
<a name="l02089"></a>02089     (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l02090"></a>02090     <span class="keywordflow">if</span> (rc &gt;= 0)
<a name="l02091"></a>02091         <span class="keywordflow">return</span> rc;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093     rc = 0;
<a name="l02094"></a>02094 
<a name="l02095"></a>02095     <span class="keywordflow">if</span> ((magic[0] == <span class="charliteral">'B'</span>) &amp;&amp; (magic[1] == <span class="charliteral">'Z'</span>)) {
<a name="l02096"></a>02096         *compressed = <a class="code" href="rpmmacro_8h.html#8b147c8bfb002dbd493b41a6f9d9e0a317a1c7ca8719efbcee40fce7d2ccb463">COMPRESSED_BZIP2</a>;
<a name="l02097"></a>02097     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((magic[0] == 0120) &amp;&amp; (magic[1] == 0113) &amp;&amp;
<a name="l02098"></a>02098          (magic[2] == 0003) &amp;&amp; (magic[3] == 0004)) {    <span class="comment">/* pkzip */</span>
<a name="l02099"></a>02099         *compressed = <a class="code" href="rpmmacro_8h.html#8b147c8bfb002dbd493b41a6f9d9e0a37676cb7cb2d5e8dca445f3860683b70e">COMPRESSED_ZIP</a>;
<a name="l02100"></a>02100     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((magic[0] == 0037) &amp;&amp; (magic[1] == 0213)) || <span class="comment">/* gzip */</span>
<a name="l02101"></a>02101         ((magic[0] == 0037) &amp;&amp; (magic[1] == 0236)) ||   <span class="comment">/* old gzip */</span>
<a name="l02102"></a>02102         ((magic[0] == 0037) &amp;&amp; (magic[1] == 0036)) ||   <span class="comment">/* pack */</span>
<a name="l02103"></a>02103         ((magic[0] == 0037) &amp;&amp; (magic[1] == 0240)) ||   <span class="comment">/* SCO lzh */</span>
<a name="l02104"></a>02104         ((magic[0] == 0037) &amp;&amp; (magic[1] == 0235))      <span class="comment">/* compress */</span>
<a name="l02105"></a>02105         ) {
<a name="l02106"></a>02106         *compressed = <a class="code" href="rpmmacro_8h.html#8b147c8bfb002dbd493b41a6f9d9e0a3f99341145d1052277a0f45e1c791be7a">COMPRESSED_OTHER</a>;
<a name="l02107"></a>02107     }
<a name="l02108"></a>02108 
<a name="l02109"></a>02109     <span class="keywordflow">return</span> rc;
<a name="l02110"></a>02110 }
<a name="l02111"></a>02111 
<a name="l02112"></a>02112 <span class="comment">/* =============================================================== */</span>
<a name="l02113"></a>02113 
<a name="l02114"></a>02114 <span class="comment">/*@-modfilesys@*/</span>
<a name="l02115"></a>02115 <span class="keywordtype">char</span> * 
<a name="l02116"></a><a class="code" href="rpmmacro_8h.html#0dba4b275f1c8f96b8dae9537a8aa3cf">02116</a> <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *arg, ...)
<a name="l02117"></a>02117 {
<a name="l02118"></a>02118     <span class="keywordtype">char</span> buf[BUFSIZ], *p, *pe;
<a name="l02119"></a>02119     <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l02120"></a>02120     va_list ap;
<a name="l02121"></a>02121 
<a name="l02122"></a>02122     <span class="keywordflow">if</span> (arg == NULL)
<a name="l02123"></a>02123         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(<span class="stringliteral">""</span>);
<a name="l02124"></a>02124 
<a name="l02125"></a>02125     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l02126"></a>02126     p = buf;
<a name="l02127"></a>02127     pe = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(p, arg);
<a name="l02128"></a>02128 
<a name="l02129"></a>02129     va_start(ap, arg);
<a name="l02130"></a>02130     <span class="keywordflow">while</span> ((s = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)) != NULL)
<a name="l02131"></a>02131         pe = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(pe, s);
<a name="l02132"></a>02132     va_end(ap);
<a name="l02133"></a>02133     (void) <a class="code" href="macro_8c.html#cada855232974c4a3985847565be312e" title="Expand macro into buffer.">expandMacros</a>(NULL, NULL, buf, <span class="keyword">sizeof</span>(buf));
<a name="l02134"></a>02134     <span class="keywordflow">return</span> <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(buf);
<a name="l02135"></a>02135 }
<a name="l02136"></a>02136 <span class="comment">/*@=modfilesys@*/</span>
<a name="l02137"></a>02137 
<a name="l02138"></a>02138 <span class="keywordtype">int</span>
<a name="l02139"></a><a class="code" href="rpmmacro_8h.html#2e43f3dd86c8e646243de9f051f36f6a">02139</a> <a class="code" href="macro_8c.html#2e43f3dd86c8e646243de9f051f36f6a" title="Return macro expansion as a numeric value.">rpmExpandNumeric</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *arg)
<a name="l02140"></a>02140 {
<a name="l02141"></a>02141     <span class="keyword">const</span> <span class="keywordtype">char</span> *val;
<a name="l02142"></a>02142     <span class="keywordtype">int</span> rc;
<a name="l02143"></a>02143 
<a name="l02144"></a>02144     <span class="keywordflow">if</span> (arg == NULL)
<a name="l02145"></a>02145         <span class="keywordflow">return</span> 0;
<a name="l02146"></a>02146 
<a name="l02147"></a>02147     val = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(arg, NULL);
<a name="l02148"></a>02148     <span class="keywordflow">if</span> (!(val &amp;&amp; *val != <span class="charliteral">'%'</span>))
<a name="l02149"></a>02149         rc = 0;
<a name="l02150"></a>02150     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*val == <span class="charliteral">'Y'</span> || *val == <span class="charliteral">'y'</span>)
<a name="l02151"></a>02151         rc = 1;
<a name="l02152"></a>02152     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*val == <span class="charliteral">'N'</span> || *val == <span class="charliteral">'n'</span>)
<a name="l02153"></a>02153         rc = 0;
<a name="l02154"></a>02154     <span class="keywordflow">else</span> {
<a name="l02155"></a>02155         <span class="keywordtype">char</span> *end;
<a name="l02156"></a>02156         rc = strtol(val, &amp;end, 0);
<a name="l02157"></a>02157         <span class="keywordflow">if</span> (!(end &amp;&amp; *end == <span class="charliteral">'\0'</span>))
<a name="l02158"></a>02158             rc = 0;
<a name="l02159"></a>02159     }
<a name="l02160"></a>02160     val = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(val);
<a name="l02161"></a>02161 
<a name="l02162"></a>02162     <span class="keywordflow">return</span> rc;
<a name="l02163"></a>02163 }
<a name="l02164"></a>02164 
<a name="l02165"></a>02165 <span class="comment">/* @todo "../sbin/./../bin/" not correct. */</span>
<a name="l02166"></a><a class="code" href="rpmmacro_8h.html#02c5e42e23aca300936bea1154f3c991">02166</a> <span class="keywordtype">char</span> *<a class="code" href="macro_8c.html#02c5e42e23aca300936bea1154f3c991" title="Canonicalize file path.">rpmCleanPath</a>(<span class="keywordtype">char</span> * path)
<a name="l02167"></a>02167 {
<a name="l02168"></a>02168     <span class="keyword">const</span> <span class="keywordtype">char</span> *s;
<a name="l02169"></a>02169     <span class="keywordtype">char</span> *se, *t, *te;
<a name="l02170"></a>02170     <span class="keywordtype">int</span> begin = 1;
<a name="l02171"></a>02171 
<a name="l02172"></a>02172     <span class="keywordflow">if</span> (path == NULL)
<a name="l02173"></a>02173         <span class="keywordflow">return</span> NULL;
<a name="l02174"></a>02174 
<a name="l02175"></a>02175 <span class="comment">/*fprintf(stderr, "*** RCP %s -&gt;\n", path); */</span>
<a name="l02176"></a>02176     s = t = te = path;
<a name="l02177"></a>02177     <span class="keywordflow">while</span> (*s != <span class="charliteral">'\0'</span>) {
<a name="l02178"></a>02178 <span class="comment">/*fprintf(stderr, "*** got \"%.*s\"\trest \"%s\"\n", (t-path), path, s); */</span>
<a name="l02179"></a>02179         <span class="keywordflow">switch</span>(*s) {
<a name="l02180"></a>02180         <span class="keywordflow">case</span> <span class="charliteral">':'</span>:                       <span class="comment">/* handle url's */</span>
<a name="l02181"></a>02181             <span class="keywordflow">if</span> (s[1] == <span class="charliteral">'/'</span> &amp;&amp; s[2] == <span class="charliteral">'/'</span>) {
<a name="l02182"></a>02182                 *t++ = *s++;
<a name="l02183"></a>02183                 *t++ = *s++;
<a name="l02184"></a>02184                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02185"></a>02185             }
<a name="l02186"></a>02186             begin=1;
<a name="l02187"></a>02187             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02188"></a>02188         <span class="keywordflow">case</span> <span class="charliteral">'/'</span>:
<a name="l02189"></a>02189             <span class="comment">/* Move parent dir forward */</span>
<a name="l02190"></a>02190             <span class="keywordflow">for</span> (se = te + 1; se &lt; t &amp;&amp; *se != <span class="charliteral">'/'</span>; se++)
<a name="l02191"></a>02191                 {};
<a name="l02192"></a>02192             <span class="keywordflow">if</span> (se &lt; t &amp;&amp; *se == <span class="charliteral">'/'</span>) {
<a name="l02193"></a>02193                 te = se;
<a name="l02194"></a>02194 <span class="comment">/*fprintf(stderr, "*** next pdir \"%.*s\"\n", (te-path), path); */</span>
<a name="l02195"></a>02195             }
<a name="l02196"></a>02196             <span class="keywordflow">while</span> (s[1] == <span class="charliteral">'/'</span>)
<a name="l02197"></a>02197                 s++;
<a name="l02198"></a>02198             <span class="keywordflow">while</span> (t &gt; path &amp;&amp; t[-1] == <span class="charliteral">'/'</span>)
<a name="l02199"></a>02199                 t--;
<a name="l02200"></a>02200             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02201"></a>02201         <span class="keywordflow">case</span> <span class="charliteral">'.'</span>:
<a name="l02202"></a>02202             <span class="comment">/* Leading .. is special */</span>
<a name="l02203"></a>02203             <span class="comment">/* Check that it is ../, so that we don't interpret */</span>
<a name="l02204"></a>02204             <span class="comment">/* ..?(i.e. "...") or ..* (i.e. "..bogus") as "..". */</span>
<a name="l02205"></a>02205             <span class="comment">/* in the case of "...", this ends up being processed*/</span>
<a name="l02206"></a>02206             <span class="comment">/* as "../.", and the last '.' is stripped.  This   */</span>
<a name="l02207"></a>02207             <span class="comment">/* would not be correct processing.                 */</span>
<a name="l02208"></a>02208             <span class="keywordflow">if</span> (begin &amp;&amp; s[1] == <span class="charliteral">'.'</span> &amp;&amp; (s[2] == <span class="charliteral">'/'</span> || s[2] == <span class="charliteral">'\0'</span>)) {
<a name="l02209"></a>02209 <span class="comment">/*fprintf(stderr, "    leading \"..\"\n"); */</span>
<a name="l02210"></a>02210                 *t++ = *s++;
<a name="l02211"></a>02211                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02212"></a>02212             }
<a name="l02213"></a>02213             <span class="comment">/* Single . is special */</span>
<a name="l02214"></a>02214             <span class="keywordflow">if</span> (begin &amp;&amp; s[1] == <span class="charliteral">'\0'</span>) {
<a name="l02215"></a>02215                 <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02216"></a>02216             }
<a name="l02217"></a>02217             <span class="comment">/* Trim embedded ./ , trailing /. */</span>
<a name="l02218"></a>02218             <span class="keywordflow">if</span> ((t[-1] == <span class="charliteral">'/'</span> &amp;&amp; s[1] == <span class="charliteral">'\0'</span>) || (t &gt; path &amp;&amp; t[-1] == <span class="charliteral">'/'</span> &amp;&amp; s[1] == <span class="charliteral">'/'</span>)) {
<a name="l02219"></a>02219                 s++;
<a name="l02220"></a>02220                 <span class="keywordflow">continue</span>;
<a name="l02221"></a>02221             }
<a name="l02222"></a>02222             <span class="comment">/* Trim embedded /../ and trailing /.. */</span>
<a name="l02223"></a>02223             <span class="keywordflow">if</span> (!begin &amp;&amp; t &gt; path &amp;&amp; t[-1] == <span class="charliteral">'/'</span> &amp;&amp; s[1] == <span class="charliteral">'.'</span> &amp;&amp; (s[2] == <span class="charliteral">'/'</span> || s[2] == <span class="charliteral">'\0'</span>)) {
<a name="l02224"></a>02224                 t = te;
<a name="l02225"></a>02225                 <span class="comment">/* Move parent dir forward */</span>
<a name="l02226"></a>02226                 <span class="keywordflow">if</span> (te &gt; path)
<a name="l02227"></a>02227                     <span class="keywordflow">for</span> (--te; te &gt; path &amp;&amp; *te != <span class="charliteral">'/'</span>; te--)
<a name="l02228"></a>02228                         {};
<a name="l02229"></a>02229 <span class="comment">/*fprintf(stderr, "*** prev pdir \"%.*s\"\n", (te-path), path); */</span>
<a name="l02230"></a>02230                 s++;
<a name="l02231"></a>02231                 s++;
<a name="l02232"></a>02232                 <span class="keywordflow">continue</span>;
<a name="l02233"></a>02233             }
<a name="l02234"></a>02234             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02235"></a>02235         <span class="keywordflow">default</span>:
<a name="l02236"></a>02236             begin = 0;
<a name="l02237"></a>02237             <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02238"></a>02238         }
<a name="l02239"></a>02239         *t++ = *s++;
<a name="l02240"></a>02240     }
<a name="l02241"></a>02241 
<a name="l02242"></a>02242     <span class="comment">/* Trim trailing / (but leave single / alone) */</span>
<a name="l02243"></a>02243     <span class="keywordflow">if</span> (t &gt; &amp;path[1] &amp;&amp; t[-1] == <span class="charliteral">'/'</span>)
<a name="l02244"></a>02244         t--;
<a name="l02245"></a>02245     *t = <span class="charliteral">'\0'</span>;
<a name="l02246"></a>02246 
<a name="l02247"></a>02247 <span class="comment">/*fprintf(stderr, "\t%s\n", path); */</span>
<a name="l02248"></a>02248     <span class="keywordflow">return</span> path;
<a name="l02249"></a>02249 }
<a name="l02250"></a>02250 
<a name="l02251"></a>02251 <span class="comment">/* Return concatenated and expanded canonical path. */</span>
<a name="l02252"></a>02252 
<a name="l02253"></a>02253 <span class="keyword">const</span> <span class="keywordtype">char</span> *
<a name="l02254"></a><a class="code" href="rpmmacro_8h.html#1bce9a7d7c5c5833d2eda2dcaa761bd5">02254</a> <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path, ...)
<a name="l02255"></a>02255 {
<a name="l02256"></a>02256     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l02257"></a>02257     <span class="keyword">const</span> <span class="keywordtype">char</span> * s;
<a name="l02258"></a>02258     <span class="keywordtype">char</span> * t, * te;
<a name="l02259"></a>02259     va_list ap;
<a name="l02260"></a>02260 
<a name="l02261"></a>02261     <span class="keywordflow">if</span> (path == NULL)
<a name="l02262"></a>02262         <span class="keywordflow">return</span> <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(<span class="stringliteral">""</span>);
<a name="l02263"></a>02263 
<a name="l02264"></a>02264     buf[0] = <span class="charliteral">'\0'</span>;
<a name="l02265"></a>02265     t = buf;
<a name="l02266"></a>02266     te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, path);
<a name="l02267"></a>02267     *te = <span class="charliteral">'\0'</span>;
<a name="l02268"></a>02268 
<a name="l02269"></a>02269     va_start(ap, path);
<a name="l02270"></a>02270     <span class="keywordflow">while</span> ((s = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)) != NULL) {
<a name="l02271"></a>02271         te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(te, s);
<a name="l02272"></a>02272         *te = <span class="charliteral">'\0'</span>;
<a name="l02273"></a>02273     }
<a name="l02274"></a>02274     va_end(ap);
<a name="l02275"></a>02275 <span class="comment">/*@-modfilesys@*/</span>
<a name="l02276"></a>02276     (void) <a class="code" href="macro_8c.html#cada855232974c4a3985847565be312e" title="Expand macro into buffer.">expandMacros</a>(NULL, NULL, buf, <span class="keyword">sizeof</span>(buf));
<a name="l02277"></a>02277 <span class="comment">/*@=modfilesys@*/</span>
<a name="l02278"></a>02278 
<a name="l02279"></a>02279     (void) <a class="code" href="macro_8c.html#02c5e42e23aca300936bea1154f3c991" title="Canonicalize file path.">rpmCleanPath</a>(buf);
<a name="l02280"></a>02280     <span class="keywordflow">return</span> <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(buf);        <span class="comment">/* XXX xstrdup has side effects. */</span>
<a name="l02281"></a>02281 }
<a name="l02282"></a>02282 
<a name="l02283"></a>02283 <span class="comment">/* Merge 3 args into path, any or all of which may be a url. */</span>
<a name="l02284"></a>02284 
<a name="l02285"></a><a class="code" href="rpmmacro_8h.html#5705f5a076ff34aeb4966048adafd360">02285</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="macro_8c.html#5705f5a076ff34aeb4966048adafd360" title="Merge 3 args into path, any or all of which may be a url.">rpmGenPath</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * urlroot, <span class="keyword">const</span> <span class="keywordtype">char</span> * urlmdir,
<a name="l02286"></a>02286                 <span class="keyword">const</span> <span class="keywordtype">char</span> *urlfile)
<a name="l02287"></a>02287 {
<a name="l02288"></a>02288 <span class="comment">/*@owned@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * xroot = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(urlroot, NULL);
<a name="l02289"></a>02289 <span class="comment">/*@dependent@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * root = xroot;
<a name="l02290"></a>02290 <span class="comment">/*@owned@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * xmdir = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(urlmdir, NULL);
<a name="l02291"></a>02291 <span class="comment">/*@dependent@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * mdir = xmdir;
<a name="l02292"></a>02292 <span class="comment">/*@owned@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * xfile = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(urlfile, NULL);
<a name="l02293"></a>02293 <span class="comment">/*@dependent@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="parseFiles_8c.html#4f4da8b93048dccc588f5ddc4d7e1561">file</a> = xfile;
<a name="l02294"></a>02294     <span class="keyword">const</span> <span class="keywordtype">char</span> * result;
<a name="l02295"></a>02295     <span class="keyword">const</span> <span class="keywordtype">char</span> * url = NULL;
<a name="l02296"></a>02296     <span class="keywordtype">int</span> nurl = 0;
<a name="l02297"></a>02297     <span class="keywordtype">int</span> ut;
<a name="l02298"></a>02298 
<a name="l02299"></a>02299 <span class="preprocessor">#if 0</span>
<a name="l02300"></a>02300 <span class="preprocessor"></span><span class="keywordflow">if</span> (_debug) fprintf(stderr, <span class="stringliteral">"*** RGP xroot %s xmdir %s xfile %s\n"</span>, xroot, xmdir, xfile);
<a name="l02301"></a>02301 <span class="preprocessor">#endif</span>
<a name="l02302"></a>02302 <span class="preprocessor"></span>    ut = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(xroot, &amp;root);
<a name="l02303"></a>02303     <span class="keywordflow">if</span> (url == NULL &amp;&amp; ut &gt; <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>) {
<a name="l02304"></a>02304         url = xroot;
<a name="l02305"></a>02305         nurl = root - xroot;
<a name="l02306"></a>02306 <span class="preprocessor">#if 0</span>
<a name="l02307"></a>02307 <span class="preprocessor"></span><span class="keywordflow">if</span> (_debug) fprintf(stderr, <span class="stringliteral">"*** RGP ut %d root %s nurl %d\n"</span>, ut, root, nurl);
<a name="l02308"></a>02308 <span class="preprocessor">#endif</span>
<a name="l02309"></a>02309 <span class="preprocessor"></span>    }
<a name="l02310"></a>02310     <span class="keywordflow">if</span> (root == NULL || *root == <span class="charliteral">'\0'</span>) root = <span class="stringliteral">"/"</span>;
<a name="l02311"></a>02311 
<a name="l02312"></a>02312     ut = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(xmdir, &amp;mdir);
<a name="l02313"></a>02313     <span class="keywordflow">if</span> (url == NULL &amp;&amp; ut &gt; <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>) {
<a name="l02314"></a>02314         url = xmdir;
<a name="l02315"></a>02315         nurl = mdir - xmdir;
<a name="l02316"></a>02316 <span class="preprocessor">#if 0</span>
<a name="l02317"></a>02317 <span class="preprocessor"></span><span class="keywordflow">if</span> (_debug) fprintf(stderr, <span class="stringliteral">"*** RGP ut %d mdir %s nurl %d\n"</span>, ut, mdir, nurl);
<a name="l02318"></a>02318 <span class="preprocessor">#endif</span>
<a name="l02319"></a>02319 <span class="preprocessor"></span>    }
<a name="l02320"></a>02320     <span class="keywordflow">if</span> (mdir == NULL || *mdir == <span class="charliteral">'\0'</span>) mdir = <span class="stringliteral">"/"</span>;
<a name="l02321"></a>02321 
<a name="l02322"></a>02322     ut = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(xfile, &amp;file);
<a name="l02323"></a>02323     <span class="keywordflow">if</span> (url == NULL &amp;&amp; ut &gt; <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>) {
<a name="l02324"></a>02324         url = xfile;
<a name="l02325"></a>02325         nurl = file - xfile;
<a name="l02326"></a>02326 <span class="preprocessor">#if 0</span>
<a name="l02327"></a>02327 <span class="preprocessor"></span><span class="keywordflow">if</span> (_debug) fprintf(stderr, <span class="stringliteral">"*** RGP ut %d file %s nurl %d\n"</span>, ut, file, nurl);
<a name="l02328"></a>02328 <span class="preprocessor">#endif</span>
<a name="l02329"></a>02329 <span class="preprocessor"></span>    }
<a name="l02330"></a>02330 
<a name="l02331"></a>02331 <span class="comment">/*@-branchstate@*/</span>
<a name="l02332"></a>02332     <span class="keywordflow">if</span> (url &amp;&amp; nurl &gt; 0) {
<a name="l02333"></a>02333         <span class="keywordtype">char</span> *t = strncpy(<a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(nurl+1), url, nurl);
<a name="l02334"></a>02334         t[nurl] = <span class="charliteral">'\0'</span>;
<a name="l02335"></a>02335         url = t;
<a name="l02336"></a>02336     } <span class="keywordflow">else</span>
<a name="l02337"></a>02337         url = <span class="stringliteral">""</span>;
<a name="l02338"></a>02338 <span class="comment">/*@=branchstate@*/</span>
<a name="l02339"></a>02339 
<a name="l02340"></a>02340     result = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(url, root, <span class="stringliteral">"/"</span>, mdir, <span class="stringliteral">"/"</span>, file, NULL);
<a name="l02341"></a>02341 
<a name="l02342"></a>02342     xroot = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(xroot);
<a name="l02343"></a>02343     xmdir = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(xmdir);
<a name="l02344"></a>02344     xfile = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(xfile);
<a name="l02345"></a>02345 <span class="preprocessor">#if 0</span>
<a name="l02346"></a>02346 <span class="preprocessor"></span><span class="keywordflow">if</span> (_debug) fprintf(stderr, <span class="stringliteral">"*** RGP result %s\n"</span>, result);
<a name="l02347"></a>02347 <span class="preprocessor">#endif</span>
<a name="l02348"></a>02348 <span class="preprocessor"></span>    <span class="keywordflow">return</span> result;
<a name="l02349"></a>02349 }
<a name="l02350"></a>02350 
<a name="l02351"></a>02351 <span class="comment">/* =============================================================== */</span>
<a name="l02352"></a>02352 
<a name="l02353"></a>02353 <span class="preprocessor">#if defined(DEBUG_MACROS)</span>
<a name="l02354"></a>02354 <span class="preprocessor"></span>
<a name="l02355"></a>02355 <span class="preprocessor">#if defined(EVAL_MACROS)</span>
<a name="l02356"></a>02356 <span class="preprocessor"></span>
<a name="l02357"></a>02357 <span class="keywordtype">char</span> *<a class="code" href="group__rpmrc.html#g4ce2e6096bc4567e6aeee576fe8f9f2e" title="List of macro files to read when configuring rpm.">macrofiles</a> = <span class="stringliteral">"/usr/lib/rpm/macros:/etc/rpm/macros:~/.rpmmacros"</span>;
<a name="l02358"></a>02358 
<a name="l02359"></a>02359 <span class="keywordtype">int</span>
<a name="l02360"></a>02360 <a class="code" href="rpmqv_8c.html#3d04ca28ed34f9e8632ffe35e03177b1">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *<a class="code" href="compress_8c.html#a06161d5bbbc977dc1ad9e6669902c5e">argv</a>[])
<a name="l02361"></a>02361 {
<a name="l02362"></a>02362     <span class="keywordtype">int</span> c;
<a name="l02363"></a>02363     <span class="keywordtype">int</span> errflg = 0;
<a name="l02364"></a>02364     <span class="keyword">extern</span> <span class="keywordtype">char</span> *optarg;
<a name="l02365"></a>02365     <span class="keyword">extern</span> <span class="keywordtype">int</span> optind;
<a name="l02366"></a>02366 
<a name="l02367"></a>02367     <span class="keywordflow">while</span> ((c = getopt(argc, argv, <span class="stringliteral">"f:"</span>)) != EOF ) {
<a name="l02368"></a>02368         <span class="keywordflow">switch</span> (c) {
<a name="l02369"></a>02369         <span class="keywordflow">case</span> <span class="charliteral">'f'</span>:
<a name="l02370"></a>02370             macrofiles = optarg;
<a name="l02371"></a>02371             <span class="keywordflow">break</span>;
<a name="l02372"></a>02372         <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
<a name="l02373"></a>02373         <span class="keywordflow">default</span>:
<a name="l02374"></a>02374             errflg++;
<a name="l02375"></a>02375             <span class="keywordflow">break</span>;
<a name="l02376"></a>02376         }
<a name="l02377"></a>02377     }
<a name="l02378"></a>02378     <span class="keywordflow">if</span> (errflg || optind &gt;= argc) {
<a name="l02379"></a>02379         fprintf(stderr, <span class="stringliteral">"Usage: %s [-f macropath ] macro ...\n"</span>, argv[0]);
<a name="l02380"></a>02380         exit(1);
<a name="l02381"></a>02381     }
<a name="l02382"></a>02382 
<a name="l02383"></a>02383     <a class="code" href="macro_8c.html#20f51fff5c09dc3d34a024815dcafc10" title="Initialize macro context from set of macrofile(s).">rpmInitMacros</a>(NULL, macrofiles);
<a name="l02384"></a>02384     <span class="keywordflow">for</span> ( ; optind &lt; argc; optind++) {
<a name="l02385"></a>02385         <span class="keyword">const</span> <span class="keywordtype">char</span> *val;
<a name="l02386"></a>02386 
<a name="l02387"></a>02387         val = <a class="code" href="macro_8c.html#1bce9a7d7c5c5833d2eda2dcaa761bd5" title="Return (malloc'ed) expanded, canonicalized, file path.">rpmGetPath</a>(argv[optind], NULL);
<a name="l02388"></a>02388         <span class="keywordflow">if</span> (val) {
<a name="l02389"></a>02389             fprintf(stdout, <span class="stringliteral">"%s:\t%s\n"</span>, argv[optind], val);
<a name="l02390"></a>02390             val = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(val);
<a name="l02391"></a>02391         }
<a name="l02392"></a>02392     }
<a name="l02393"></a>02393     <a class="code" href="macro_8c.html#b02b0d47ca43105f753852324a44caa9" title="Destroy macro context.">rpmFreeMacros</a>(NULL);
<a name="l02394"></a>02394     <span class="keywordflow">return</span> 0;
<a name="l02395"></a>02395 }
<a name="l02396"></a>02396 
<a name="l02397"></a>02397 <span class="preprocessor">#else   </span><span class="comment">/* !EVAL_MACROS */</span>
<a name="l02398"></a>02398 
<a name="l02399"></a>02399 <span class="keywordtype">char</span> *macrofiles = <span class="stringliteral">"../macros:./testmacros"</span>;
<a name="l02400"></a>02400 <span class="keywordtype">char</span> *testfile = <span class="stringliteral">"./test"</span>;
<a name="l02401"></a>02401 
<a name="l02402"></a>02402 <span class="keywordtype">int</span>
<a name="l02403"></a>02403 <a class="code" href="rpmqv_8c.html#3d04ca28ed34f9e8632ffe35e03177b1">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l02404"></a>02404 {
<a name="l02405"></a>02405     <span class="keywordtype">char</span> buf[BUFSIZ];
<a name="l02406"></a>02406     FILE *fp;
<a name="l02407"></a>02407     <span class="keywordtype">int</span> x;
<a name="l02408"></a>02408 
<a name="l02409"></a>02409     <a class="code" href="macro_8c.html#20f51fff5c09dc3d34a024815dcafc10" title="Initialize macro context from set of macrofile(s).">rpmInitMacros</a>(NULL, macrofiles);
<a name="l02410"></a>02410     <a class="code" href="macro_8c.html#f075388010eeb8d8decdc1978fd7db24" title="Print macros to file stream.">rpmDumpMacroTable</a>(NULL, NULL);
<a name="l02411"></a>02411 
<a name="l02412"></a>02412     <span class="keywordflow">if</span> ((fp = fopen(testfile, <span class="stringliteral">"r"</span>)) != NULL) {
<a name="l02413"></a>02413         <span class="keywordflow">while</span>(<a class="code" href="macro_8c.html#c9f1be5e4270f95d099e04074c229c7f" title="fgets(3) analogue that reads \ continuations.">rdcl</a>(buf, <span class="keyword">sizeof</span>(buf), fp)) {
<a name="l02414"></a>02414             x = <a class="code" href="macro_8c.html#cada855232974c4a3985847565be312e" title="Expand macro into buffer.">expandMacros</a>(NULL, NULL, buf, <span class="keyword">sizeof</span>(buf));
<a name="l02415"></a>02415             fprintf(stderr, <span class="stringliteral">"%d-&gt;%s\n"</span>, x, buf);
<a name="l02416"></a>02416             memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l02417"></a>02417         }
<a name="l02418"></a>02418         fclose(fp);
<a name="l02419"></a>02419     }
<a name="l02420"></a>02420 
<a name="l02421"></a>02421     <span class="keywordflow">while</span>(<a class="code" href="macro_8c.html#c9f1be5e4270f95d099e04074c229c7f" title="fgets(3) analogue that reads \ continuations.">rdcl</a>(buf, <span class="keyword">sizeof</span>(buf), stdin)) {
<a name="l02422"></a>02422         x = <a class="code" href="macro_8c.html#cada855232974c4a3985847565be312e" title="Expand macro into buffer.">expandMacros</a>(NULL, NULL, buf, <span class="keyword">sizeof</span>(buf));
<a name="l02423"></a>02423         fprintf(stderr, <span class="stringliteral">"%d-&gt;%s\n &lt;-\n"</span>, x, buf);
<a name="l02424"></a>02424         memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l02425"></a>02425     }
<a name="l02426"></a>02426     <a class="code" href="macro_8c.html#b02b0d47ca43105f753852324a44caa9" title="Destroy macro context.">rpmFreeMacros</a>(NULL);
<a name="l02427"></a>02427 
<a name="l02428"></a>02428     <span class="keywordflow">return</span> 0;
<a name="l02429"></a>02429 }
<a name="l02430"></a>02430 <span class="preprocessor">#endif  </span><span class="comment">/* EVAL_MACROS */</span>
<a name="l02431"></a>02431 <span class="preprocessor">#endif  </span><span class="comment">/* DEBUG_MACROS */</span>
<a name="l02432"></a>02432 <span class="comment">/*@=boundsread@*/</span>
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:54 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
