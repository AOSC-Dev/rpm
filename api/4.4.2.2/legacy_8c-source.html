<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: rpmdb/legacy.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>rpmdb/legacy.c</h1><a href="legacy_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00005"></a>00005 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00006"></a>00006 
<a name="l00007"></a>00007 <span class="preprocessor">#if HAVE_GELF_H</span>
<a name="l00008"></a>00008 <span class="preprocessor"></span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;gelf.h&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#if !defined(DT_GNU_PRELINKED)</span>
<a name="l00012"></a>00012 <span class="preprocessor"></span><span class="preprocessor">#define DT_GNU_PRELINKED        0x6ffffdf5</span>
<a name="l00013"></a>00013 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00014"></a>00014 <span class="preprocessor"></span><span class="preprocessor">#if !defined(DT_GNU_LIBLIST)</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span><span class="preprocessor">#define DT_GNU_LIBLIST          0x6ffffef9</span>
<a name="l00016"></a>00016 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00017"></a>00017 <span class="preprocessor"></span>
<a name="l00018"></a>00018 <span class="preprocessor">#endif</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="rpmio__internal_8h.html">rpmio_internal.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;<a class="code" href="rpmlib_8h.html" title="In Memoriam: Steve Taylor &lt;staylor@redhat.com&gt; was here, now he's not.">rpmlib.h</a>&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;<a class="code" href="rpmmacro_8h.html">rpmmacro.h</a>&gt;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include "<a class="code" href="misc_8h.html">misc.h</a>"</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="legacy_8h.html">legacy.h</a>"</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00026"></a>00026 
<a name="l00027"></a><a class="code" href="legacy_8c.html#0e6c36aa207979a118f67d4ddb341fce">00027</a> <span class="preprocessor">#define alloca_strdup(_s)       strcpy(alloca(strlen(_s)+1), (_s))</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="legacy_8c.html#b3832114edf6afb9433ef5a6113d0ba8">00036</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="legacy_8c.html#b3832114edf6afb9433ef5a6113d0ba8" title="Open a file descriptor to verify file MD5 and size.">open_dso</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * path, <span class="comment">/*@null@*/</span> pid_t * pidp, <span class="comment">/*@null@*/</span> <span class="keywordtype">size_t</span> *fsizep)
<a name="l00037"></a>00037         <span class="comment">/*@globals rpmGlobalMacroContext, h_errno, fileSystem, internalState @*/</span>
<a name="l00038"></a>00038         <span class="comment">/*@modifies *pidp, *fsizep, rpmGlobalMacroContext,</span>
<a name="l00039"></a>00039 <span class="comment">                fileSystem, internalState @*/</span>
<a name="l00040"></a>00040 {
<a name="l00041"></a>00041 <span class="comment">/*@only@*/</span>
<a name="l00042"></a>00042     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * cmd = NULL;
<a name="l00043"></a>00043     <span class="keyword">static</span> <span class="keywordtype">int</span> initted = 0;
<a name="l00044"></a>00044     <span class="keywordtype">int</span> fdno;
<a name="l00045"></a>00045 
<a name="l00046"></a>00046     <span class="keywordflow">if</span> (!initted) {
<a name="l00047"></a>00047         cmd = <a class="code" href="macro_8c.html#0dba4b275f1c8f96b8dae9537a8aa3cf" title="Return (malloc'ed) concatenated macro expansion(s).">rpmExpand</a>(<span class="stringliteral">"%{?__prelink_undo_cmd}"</span>, NULL);
<a name="l00048"></a>00048         initted++;
<a name="l00049"></a>00049     }
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00052"></a>00052     <span class="keywordflow">if</span> (pidp) *pidp = 0;
<a name="l00053"></a>00053 
<a name="l00054"></a>00054     <span class="keywordflow">if</span> (fsizep) {
<a name="l00055"></a>00055         <span class="keyword">struct </span>stat sb, * st = &amp;sb;
<a name="l00056"></a>00056         <span class="keywordflow">if</span> (stat(path, st) &lt; 0)
<a name="l00057"></a>00057             <span class="keywordflow">return</span> -1;
<a name="l00058"></a>00058         *fsizep = st-&gt;st_size;
<a name="l00059"></a>00059     }
<a name="l00060"></a>00060 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062     fdno = open(path, O_RDONLY);
<a name="l00063"></a>00063     <span class="keywordflow">if</span> (fdno &lt; 0)
<a name="l00064"></a>00064         <span class="keywordflow">return</span> fdno;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">/*@-boundsread@*/</span>
<a name="l00067"></a>00067     <span class="keywordflow">if</span> (!(cmd &amp;&amp; *cmd))
<a name="l00068"></a>00068         <span class="keywordflow">return</span> fdno;
<a name="l00069"></a>00069 <span class="comment">/*@=boundsread@*/</span>
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="preprocessor">#if HAVE_GELF_H &amp;&amp; HAVE_LIBELF</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span> {  Elf *elf = NULL;
<a name="l00073"></a>00073     Elf_Scn *scn = NULL;
<a name="l00074"></a>00074     Elf_Data *data = NULL;
<a name="l00075"></a>00075     GElf_Ehdr ehdr;
<a name="l00076"></a>00076     GElf_Shdr shdr;
<a name="l00077"></a>00077     GElf_Dyn dyn;
<a name="l00078"></a>00078     <span class="keywordtype">int</span> bingo;
<a name="l00079"></a>00079 
<a name="l00080"></a>00080     (void) elf_version(EV_CURRENT);
<a name="l00081"></a>00081 
<a name="l00082"></a>00082 <span class="comment">/*@-evalorder@*/</span>
<a name="l00083"></a>00083     <span class="keywordflow">if</span> ((elf = elf_begin (fdno, ELF_C_READ, NULL)) == NULL
<a name="l00084"></a>00084      || elf_kind(elf) != ELF_K_ELF
<a name="l00085"></a>00085      || gelf_getehdr(elf, &amp;ehdr) == NULL
<a name="l00086"></a>00086      || !(ehdr.e_type == ET_DYN || ehdr.e_type == <a class="code" href="readelf_8h.html#279e9391d18792b3a4e2b0a0fecc7418">ET_EXEC</a>))
<a name="l00087"></a>00087         <span class="keywordflow">goto</span> exit;
<a name="l00088"></a>00088 <span class="comment">/*@=evalorder@*/</span>
<a name="l00089"></a>00089 
<a name="l00090"></a>00090     bingo = 0;
<a name="l00091"></a>00091     <span class="comment">/*@-branchstate -uniondef @*/</span>
<a name="l00092"></a>00092     <span class="keywordflow">while</span> (!bingo &amp;&amp; (scn = elf_nextscn(elf, scn)) != NULL) {
<a name="l00093"></a>00093         (void) gelf_getshdr(scn, &amp;shdr);
<a name="l00094"></a>00094         <span class="keywordflow">if</span> (shdr.sh_type != SHT_DYNAMIC)
<a name="l00095"></a>00095             <span class="keywordflow">continue</span>;
<a name="l00096"></a>00096         <span class="keywordflow">while</span> (!bingo &amp;&amp; (data = elf_getdata (scn, data)) != NULL) {
<a name="l00097"></a>00097             <span class="keywordtype">int</span> maxndx = data-&gt;d_size / shdr.sh_entsize;
<a name="l00098"></a>00098             <span class="keywordtype">int</span> ndx;
<a name="l00099"></a>00099 
<a name="l00100"></a>00100             <span class="keywordflow">for</span> (ndx = 0; ndx &lt; maxndx; ++ndx) {
<a name="l00101"></a>00101                 (<span class="keywordtype">void</span>) gelf_getdyn (data, ndx, &amp;dyn);
<a name="l00102"></a>00102                 <span class="keywordflow">if</span> (!(dyn.d_tag == DT_GNU_PRELINKED || dyn.d_tag == DT_GNU_LIBLIST))
<a name="l00103"></a>00103                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00104"></a>00104                 bingo = 1;
<a name="l00105"></a>00105                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00106"></a>00106             }
<a name="l00107"></a>00107         }
<a name="l00108"></a>00108     }
<a name="l00109"></a>00109     <span class="comment">/*@=branchstate =uniondef @*/</span>
<a name="l00110"></a>00110 
<a name="l00111"></a>00111 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00112"></a>00112     <span class="keywordflow">if</span> (pidp != NULL &amp;&amp; bingo) {
<a name="l00113"></a>00113         <span class="keywordtype">int</span> pipes[2];
<a name="l00114"></a>00114         pid_t pid;
<a name="l00115"></a>00115         <span class="keywordtype">int</span> xx;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117         xx = close(fdno);
<a name="l00118"></a>00118         pipes[0] = pipes[1] = -1;
<a name="l00119"></a>00119         xx = pipe(pipes);
<a name="l00120"></a>00120         <span class="keywordflow">if</span> (!(pid = fork())) {
<a name="l00121"></a>00121             <span class="keyword">const</span> <span class="keywordtype">char</span> ** av;
<a name="l00122"></a>00122             <span class="keywordtype">int</span> ac;
<a name="l00123"></a>00123             xx = close(pipes[0]);
<a name="l00124"></a>00124             xx = dup2(pipes[1], STDOUT_FILENO);
<a name="l00125"></a>00125             xx = close(pipes[1]);
<a name="l00126"></a>00126             <span class="keywordflow">if</span> (!poptParseArgvString(cmd, &amp;ac, &amp;av)) {
<a name="l00127"></a>00127                 av[ac-1] = path;
<a name="l00128"></a>00128                 av[ac] = NULL;
<a name="l00129"></a>00129                 <a class="code" href="system_8h.html#440dcd7dd71b4d668d8b9112643b9e0a">unsetenv</a>(<span class="stringliteral">"MALLOC_CHECK_"</span>);
<a name="l00130"></a>00130                 xx = execve(av[0], (<span class="keywordtype">char</span> *<span class="keyword">const</span> *)av+1, <a class="code" href="signature_8c.html#26d345f5cb95c9000b59e3add5fc5a94">environ</a>);
<a name="l00131"></a>00131             }
<a name="l00132"></a>00132             _exit(127);
<a name="l00133"></a>00133         }
<a name="l00134"></a>00134         *pidp = pid;
<a name="l00135"></a>00135         fdno = pipes[0];
<a name="l00136"></a>00136         xx = close(pipes[1]);
<a name="l00137"></a>00137     }
<a name="l00138"></a>00138 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 exit:
<a name="l00141"></a>00141     <span class="keywordflow">if</span> (elf) (void) elf_end(elf);
<a name="l00142"></a>00142  }
<a name="l00143"></a>00143 <span class="preprocessor">#endif</span>
<a name="l00144"></a>00144 <span class="preprocessor"></span>
<a name="l00145"></a>00145     <span class="keywordflow">return</span> fdno;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00148"></a><a class="code" href="legacy_8h.html#1d4686e95c90e1a91f016655fbe85ece">00148</a> <span class="keywordtype">int</span> <a class="code" href="legacy_8c.html#1d4686e95c90e1a91f016655fbe85ece" title="Return MD5 sum and size of a file.">domd5</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> * fn, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * digest, <span class="keywordtype">int</span> asAscii, <span class="keywordtype">size_t</span> *fsizep)
<a name="l00149"></a>00149 {
<a name="l00150"></a>00150     <span class="keyword">const</span> <span class="keywordtype">char</span> * path;
<a name="l00151"></a>00151     <a class="code" href="rpmurl_8h.html#8fc34597e828d3067e3844b571922d2d" title="Supported URL types.">urltype</a> ut = <a class="code" href="rpmurl_8h.html#35492e2be1d0a9376b9b0d29512dab4d" title="Return path component of URL.">urlPath</a>(fn, &amp;path);
<a name="l00152"></a>00152     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> * md5sum = NULL;
<a name="l00153"></a>00153     <span class="keywordtype">size_t</span> md5len;
<a name="l00154"></a>00154     <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[32*BUFSIZ];
<a name="l00155"></a>00155     <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> fd;
<a name="l00156"></a>00156     <span class="keywordtype">size_t</span> fsize = 0;
<a name="l00157"></a>00157     pid_t pid = 0;
<a name="l00158"></a>00158     <span class="keywordtype">int</span> rc = 0;
<a name="l00159"></a>00159     <span class="keywordtype">int</span> fdno;
<a name="l00160"></a>00160     <span class="keywordtype">int</span> xx;
<a name="l00161"></a>00161 
<a name="l00162"></a>00162 <span class="comment">/*@-globs -internalglobs -mods @*/</span>
<a name="l00163"></a>00163     fdno = <a class="code" href="legacy_8c.html#b3832114edf6afb9433ef5a6113d0ba8" title="Open a file descriptor to verify file MD5 and size.">open_dso</a>(path, &amp;pid, &amp;fsize);
<a name="l00164"></a>00164 <span class="comment">/*@=globs =internalglobs =mods @*/</span>
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (fdno &lt; 0) {
<a name="l00166"></a>00166         rc = 1;
<a name="l00167"></a>00167         <span class="keywordflow">goto</span> exit;
<a name="l00168"></a>00168     }
<a name="l00169"></a>00169 
<a name="l00170"></a>00170     <span class="comment">/* file to large (32 MB), do not mmap file */</span>
<a name="l00171"></a>00171     <span class="keywordflow">if</span> (fsize &gt; (<span class="keywordtype">size_t</span>) 32*1024*1024)
<a name="l00172"></a>00172       <span class="keywordflow">if</span> (ut == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a> || ut == <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>)
<a name="l00173"></a>00173         ut = <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>; <span class="comment">/* force fd io */</span>
<a name="l00174"></a>00174 
<a name="l00175"></a>00175     <span class="keywordflow">switch</span>(ut) {
<a name="l00176"></a>00176     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab1678b3df63ff0b36ad1210e79e9ea07e">URL_IS_PATH</a>:
<a name="l00177"></a>00177     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabc46cb197ad2431b66a788485740c5c9d">URL_IS_UNKNOWN</a>:
<a name="l00178"></a>00178 <span class="preprocessor">#ifdef HAVE_MMAP</span>
<a name="l00179"></a>00179 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (pid == 0) {
<a name="l00180"></a>00180         <a class="code" href="structDIGEST__CTX__s.html" title="MD5/SHA1 digest private data.">DIGEST_CTX</a> ctx;
<a name="l00181"></a>00181         <span class="keywordtype">void</span> * mapped;
<a name="l00182"></a>00182 
<a name="l00183"></a>00183         <span class="keywordflow">if</span> (fsize) {
<a name="l00184"></a>00184             mapped = mmap(NULL, fsize, PROT_READ, MAP_SHARED, fdno, 0);
<a name="l00185"></a>00185             <span class="keywordflow">if</span> (mapped == (<span class="keywordtype">void</span> *)-1) {
<a name="l00186"></a>00186                 xx = close(fdno);
<a name="l00187"></a>00187                 rc = 1;
<a name="l00188"></a>00188                 <span class="keywordflow">break</span>;
<a name="l00189"></a>00189             }
<a name="l00190"></a>00190 
<a name="l00191"></a>00191 <span class="preprocessor">#ifdef  MADV_SEQUENTIAL</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>            xx = madvise(mapped, fsize, MADV_SEQUENTIAL);
<a name="l00193"></a>00193 <span class="preprocessor">#endif</span>
<a name="l00194"></a>00194 <span class="preprocessor"></span>        }
<a name="l00195"></a>00195 
<a name="l00196"></a>00196         ctx = <a class="code" href="group__rpmio.html#g1bf3358eacb67980206c555665c1882e" title="Initialize digest.">rpmDigestInit</a>(<a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d7e4badf8c607e5c6bd188cc1e48ac8619">PGPHASHALGO_MD5</a>, <a class="code" href="group__rpmio.html#ggbb11b2c3a26633bdb882c7c7f3093f3f5032ccccb0a608673cad27f20318b815">RPMDIGEST_NONE</a>);
<a name="l00197"></a>00197         <span class="keywordflow">if</span> (fsize)
<a name="l00198"></a>00198             xx = <a class="code" href="group__rpmio.html#g1fdf08b78d0473f033f9a4348be66d7a" title="Update context with next plain text buffer.">rpmDigestUpdate</a>(ctx, mapped, fsize);
<a name="l00199"></a>00199         xx = <a class="code" href="group__rpmio.html#g13dcad611d1f0c8d57f8464ccff955f6" title="Return digest and destroy context.">rpmDigestFinal</a>(ctx, (<span class="keywordtype">void</span> **)&amp;md5sum, &amp;md5len, asAscii);
<a name="l00200"></a>00200         <span class="keywordflow">if</span> (fsize)
<a name="l00201"></a>00201             xx = munmap(mapped, fsize);
<a name="l00202"></a>00202         xx = close(fdno);
<a name="l00203"></a>00203         <span class="keywordflow">break</span>;
<a name="l00204"></a>00204       } <span class="comment">/*@fallthrough@*/</span>
<a name="l00205"></a>00205 <span class="preprocessor">#endif</span>
<a name="l00206"></a>00206 <span class="preprocessor"></span>    <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab4aa1fd0b4630b445ae0cef00c801e98a">URL_IS_HTTPS</a>:
<a name="l00207"></a>00207     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab6b27cbcf8e16f87b37a7bda96bc6355f">URL_IS_HTTP</a>:
<a name="l00208"></a>00208     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dabb28cd018ed03df4577fb04430daeb4c0">URL_IS_FTP</a>:
<a name="l00209"></a>00209     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156daba6ec8ab80e64bfcc38e7e58949d87019">URL_IS_HKP</a>:
<a name="l00210"></a>00210     <span class="keywordflow">case</span> <a class="code" href="rpmurl_8h.html#2e76e00c963b73c23690b5ebfe156dab3a0f7f0b3abe9b3674da9b21df3e541f">URL_IS_DASH</a>:
<a name="l00211"></a>00211     <span class="keywordflow">default</span>:
<a name="l00212"></a>00212         <span class="comment">/* Either use the pipe to prelink -y or open the URL. */</span>
<a name="l00213"></a>00213         fd = (pid != 0) ? <a class="code" href="rpmio_8c.html#671e4056425535bd1421347a5bcdacf9">fdDup</a>(fdno) : <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fn, <span class="stringliteral">"r.ufdio"</span>);
<a name="l00214"></a>00214         (void) close(fdno);
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (fd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd)) {
<a name="l00216"></a>00216             rc = 1;
<a name="l00217"></a>00217             <span class="keywordflow">if</span> (fd != NULL)
<a name="l00218"></a>00218                 (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l00219"></a>00219             <span class="keywordflow">break</span>;
<a name="l00220"></a>00220         }
<a name="l00221"></a>00221         
<a name="l00222"></a>00222         <a class="code" href="group__rpmio.html#g507e26c37b2d2441527b979d6f02de23" title="Attach digest to fd.">fdInitDigest</a>(fd, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d7e4badf8c607e5c6bd188cc1e48ac8619">PGPHASHALGO_MD5</a>, 0);
<a name="l00223"></a>00223         fsize = 0;
<a name="l00224"></a>00224         <span class="keywordflow">while</span> ((rc = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(buf, <span class="keyword">sizeof</span>(buf[0]), <span class="keyword">sizeof</span>(buf), fd)) &gt; 0)
<a name="l00225"></a>00225             fsize += rc;
<a name="l00226"></a>00226         <a class="code" href="group__rpmio.html#g222eae57c03fb1e4ed9b32c6a1396b13">fdFiniDigest</a>(fd, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d7e4badf8c607e5c6bd188cc1e48ac8619">PGPHASHALGO_MD5</a>, (<span class="keywordtype">void</span> **)&amp;md5sum, &amp;md5len, asAscii);
<a name="l00227"></a>00227         <span class="keywordflow">if</span> (<a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fd))
<a name="l00228"></a>00228             rc = 1;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230         (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fd);
<a name="l00231"></a>00231         <span class="keywordflow">break</span>;
<a name="l00232"></a>00232     }
<a name="l00233"></a>00233 
<a name="l00234"></a>00234     <span class="comment">/* Reap the prelink -y helper. */</span>
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (pid) {
<a name="l00236"></a>00236         <span class="keywordtype">int</span> status;
<a name="l00237"></a>00237         (void) waitpid(pid, &amp;status, 0);
<a name="l00238"></a>00238         <span class="keywordflow">if</span> (!WIFEXITED(status) || WEXITSTATUS(status))
<a name="l00239"></a>00239             rc = 1;
<a name="l00240"></a>00240     }
<a name="l00241"></a>00241 
<a name="l00242"></a>00242 exit:
<a name="l00243"></a>00243 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (fsizep)
<a name="l00245"></a>00245         *fsizep = fsize;
<a name="l00246"></a>00246     <span class="keywordflow">if</span> (!rc)
<a name="l00247"></a>00247         memcpy(digest, md5sum, md5len);
<a name="l00248"></a>00248 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00249"></a>00249     md5sum = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(md5sum);
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordflow">return</span> rc;
<a name="l00252"></a>00252 }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254 <span class="comment">/*@-exportheadervar@*/</span>
<a name="l00255"></a>00255 <span class="comment">/*@unchecked@*/</span>
<a name="l00256"></a><a class="code" href="group__rpmcli.html#g684c24e565b576a81ada33525f7c07ce">00256</a> <span class="keywordtype">int</span> <a class="code" href="group__rpmcli.html#g684c24e565b576a81ada33525f7c07ce" title="Should version 3 packages be produced?">_noDirTokens</a> = 0;
<a name="l00257"></a>00257 <span class="comment">/*@=exportheadervar@*/</span>
<a name="l00258"></a>00258 
<a name="l00259"></a>00259 <span class="comment">/*@-boundsread@*/</span>
<a name="l00260"></a><a class="code" href="legacy_8c.html#2a848c199866818d4aee993910742935">00260</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="legacy_8c.html#2a848c199866818d4aee993910742935">dncmp</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * a, <span class="keyword">const</span> <span class="keywordtype">void</span> * b)
<a name="l00261"></a>00261         <span class="comment">/*@*/</span>
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> * first = a;
<a name="l00264"></a>00264     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> * second = b;
<a name="l00265"></a>00265     <span class="keywordflow">return</span> strcmp(*first, *second);
<a name="l00266"></a>00266 }
<a name="l00267"></a>00267 <span class="comment">/*@=boundsread@*/</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="comment">/*@-bounds@*/</span>
<a name="l00270"></a><a class="code" href="legacy_8h.html#e6ab95bc495931e0733868b30143e252">00270</a> <span class="keywordtype">void</span> <a class="code" href="legacy_8c.html#e6ab95bc495931e0733868b30143e252" title="Convert absolute path tag to (dirname,basename,dirindex) tags.">compressFilelist</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h)
<a name="l00271"></a>00271 {
<a name="l00272"></a>00272     <a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a> hge = (<a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a>)<a class="code" href="group__header.html#g29996e73fee54b49b34246121494cbf1" title="Retrieve tag value using header internal array.">headerGetEntryMinMemory</a>;
<a name="l00273"></a>00273     <a class="code" href="rpmlib_8h.html#e215c4769da8ab9ed84b0512f4dae89e" title="Prototype for headerAddEntry() vector.">HAE_t</a> hae = (<a class="code" href="rpmlib_8h.html#e215c4769da8ab9ed84b0512f4dae89e" title="Prototype for headerAddEntry() vector.">HAE_t</a>)<a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>;
<a name="l00274"></a>00274     <a class="code" href="rpmlib_8h.html#55156ad1a62e07a87f6636261bb95536" title="Prototype for headerRemoveEntry() vector.">HRE_t</a> hre = (<a class="code" href="rpmlib_8h.html#55156ad1a62e07a87f6636261bb95536" title="Prototype for headerRemoveEntry() vector.">HRE_t</a>)<a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>;
<a name="l00275"></a>00275     <a class="code" href="rpmlib_8h.html#b1e25001ce073d55e9fa97a3ad2213e8" title="Prototype for headerFreeData() vector.">HFD_t</a> hfd = <a class="code" href="group__header.html#ga2c977519b09cb7bf16f9765ec29d079" title="Free data allocated when retrieved from header.">headerFreeData</a>;
<a name="l00276"></a>00276     <span class="keywordtype">char</span> ** fileNames;
<a name="l00277"></a>00277     <span class="keyword">const</span> <span class="keywordtype">char</span> ** dirNames;
<a name="l00278"></a>00278     <span class="keyword">const</span> <span class="keywordtype">char</span> ** baseNames;
<a name="l00279"></a>00279     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> * dirIndexes;
<a name="l00280"></a>00280     <a class="code" href="group__header.html#g30546f70b72fe13929f6e388dfd29b16" title="The basic types of data in tags from headers.">rpmTagType</a> fnt;
<a name="l00281"></a>00281     <span class="keywordtype">int</span> count;
<a name="l00282"></a>00282     <span class="keywordtype">int</span> i, xx;
<a name="l00283"></a>00283     <span class="keywordtype">int</span> dirIndex = -1;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285     <span class="comment">/*</span>
<a name="l00286"></a>00286 <span class="comment">     * This assumes the file list is already sorted, and begins with a</span>
<a name="l00287"></a>00287 <span class="comment">     * single '/'. That assumption isn't critical, but it makes things go</span>
<a name="l00288"></a>00288 <span class="comment">     * a bit faster.</span>
<a name="l00289"></a>00289 <span class="comment">     */</span>
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (<a class="code" href="group__header.html#g66b9abc5d3555279d547656ec0a2f245" title="Check if tag is in header.">headerIsEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591eea50c17fff1c983c3a3ce3d773c87bd">RPMTAG_DIRNAMES</a>)) {
<a name="l00292"></a>00292         xx = hre(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917ef46a3645037c481c357f61d01f57d9">RPMTAG_OLDFILENAMES</a>);
<a name="l00293"></a>00293         <span class="keywordflow">return</span>;         <span class="comment">/* Already converted. */</span>
<a name="l00294"></a>00294     }
<a name="l00295"></a>00295 
<a name="l00296"></a>00296     <span class="keywordflow">if</span> (!hge(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917ef46a3645037c481c357f61d01f57d9">RPMTAG_OLDFILENAMES</a>, &amp;fnt, (<span class="keywordtype">void</span> **) &amp;fileNames, &amp;count))
<a name="l00297"></a>00297         <span class="keywordflow">return</span>;         <span class="comment">/* no file list */</span>
<a name="l00298"></a>00298     <span class="keywordflow">if</span> (fileNames == NULL || count &lt;= 0)
<a name="l00299"></a>00299         <span class="keywordflow">return</span>;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301     dirNames = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(<span class="keyword">sizeof</span>(*dirNames) * count);       <span class="comment">/* worst case */</span>
<a name="l00302"></a>00302     baseNames = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(<span class="keyword">sizeof</span>(*dirNames) * count);
<a name="l00303"></a>00303     dirIndexes = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(<span class="keyword">sizeof</span>(*dirIndexes) * count);
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (fileNames[0][0] != <span class="charliteral">'/'</span>) {
<a name="l00306"></a>00306         <span class="comment">/* HACK. Source RPM, so just do things differently */</span>
<a name="l00307"></a>00307         dirIndex = 0;
<a name="l00308"></a>00308         dirNames[dirIndex] = <span class="stringliteral">""</span>;
<a name="l00309"></a>00309         <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l00310"></a>00310             dirIndexes[i] = dirIndex;
<a name="l00311"></a>00311             baseNames[i] = fileNames[i];
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313         <span class="keywordflow">goto</span> exit;
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">/*@-branchstate@*/</span>
<a name="l00317"></a>00317     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l00318"></a>00318         <span class="keyword">const</span> <span class="keywordtype">char</span> ** needle;
<a name="l00319"></a>00319         <span class="keywordtype">char</span> savechar;
<a name="l00320"></a>00320         <span class="keywordtype">char</span> * baseName;
<a name="l00321"></a>00321         <span class="keywordtype">int</span> len;
<a name="l00322"></a>00322 
<a name="l00323"></a>00323         <span class="keywordflow">if</span> (fileNames[i] == NULL)       <span class="comment">/* XXX can't happen */</span>
<a name="l00324"></a>00324             <span class="keywordflow">continue</span>;
<a name="l00325"></a>00325         baseName = strrchr(fileNames[i], <span class="charliteral">'/'</span>) + 1;
<a name="l00326"></a>00326         len = baseName - fileNames[i];
<a name="l00327"></a>00327         needle = dirNames;
<a name="l00328"></a>00328         savechar = *baseName;
<a name="l00329"></a>00329         *baseName = <span class="charliteral">'\0'</span>;
<a name="l00330"></a>00330 <span class="comment">/*@-compdef@*/</span>
<a name="l00331"></a>00331         <span class="keywordflow">if</span> (dirIndex &lt; 0 ||
<a name="l00332"></a>00332             (needle = bsearch(&amp;fileNames[i], dirNames, dirIndex + 1, <span class="keyword">sizeof</span>(dirNames[0]), <a class="code" href="legacy_8c.html#2a848c199866818d4aee993910742935">dncmp</a>)) == NULL) {
<a name="l00333"></a>00333             <span class="keywordtype">char</span> *s = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(len + 1);
<a name="l00334"></a>00334             memcpy(s, fileNames[i], len + 1);
<a name="l00335"></a>00335             s[len] = <span class="charliteral">'\0'</span>;
<a name="l00336"></a>00336             dirIndexes[i] = ++dirIndex;
<a name="l00337"></a>00337             dirNames[dirIndex] = s;
<a name="l00338"></a>00338         } <span class="keywordflow">else</span>
<a name="l00339"></a>00339             dirIndexes[i] = needle - dirNames;
<a name="l00340"></a>00340 <span class="comment">/*@=compdef@*/</span>
<a name="l00341"></a>00341 
<a name="l00342"></a>00342         *baseName = savechar;
<a name="l00343"></a>00343         baseNames[i] = baseName;
<a name="l00344"></a>00344     }
<a name="l00345"></a>00345     <span class="comment">/*@=branchstate@*/</span>
<a name="l00346"></a>00346 
<a name="l00347"></a>00347 exit:
<a name="l00348"></a>00348     <span class="keywordflow">if</span> (count &gt; 0) {
<a name="l00349"></a>00349         xx = hae(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d54a77407b42789192b9763ae70921e7">RPMTAG_DIRINDEXES</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>, dirIndexes, count);
<a name="l00350"></a>00350         xx = hae(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359180a05d979f4bcc4aed2cc1f735c76aff">RPMTAG_BASENAMES</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00351"></a>00351                         baseNames, count);
<a name="l00352"></a>00352         xx = hae(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591eea50c17fff1c983c3a3ce3d773c87bd">RPMTAG_DIRNAMES</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00353"></a>00353                         dirNames, dirIndex + 1);
<a name="l00354"></a>00354     }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356     fileNames = hfd(fileNames, fnt);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358     xx = hre(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917ef46a3645037c481c357f61d01f57d9">RPMTAG_OLDFILENAMES</a>);
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 <span class="comment">/*@=bounds@*/</span>
<a name="l00361"></a>00361 
<a name="l00362"></a><a class="code" href="legacy_8h.html#7a3747cee9eef44f62969af9b8d4d390">00362</a> <span class="keywordtype">void</span> <a class="code" href="legacy_8c.html#7a3747cee9eef44f62969af9b8d4d390" title="Retrieve file names from header.">rpmfiBuildFNames</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> tagN,
<a name="l00363"></a>00363         <span class="comment">/*@out@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *** fnp, <span class="comment">/*@out@*/</span> <span class="keywordtype">int</span> * fcp)
<a name="l00364"></a>00364 {
<a name="l00365"></a>00365     <a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a> hge = (<a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a>)<a class="code" href="group__header.html#g29996e73fee54b49b34246121494cbf1" title="Retrieve tag value using header internal array.">headerGetEntryMinMemory</a>;
<a name="l00366"></a>00366     <a class="code" href="rpmlib_8h.html#b1e25001ce073d55e9fa97a3ad2213e8" title="Prototype for headerFreeData() vector.">HFD_t</a> hfd = <a class="code" href="group__header.html#ga2c977519b09cb7bf16f9765ec29d079" title="Free data allocated when retrieved from header.">headerFreeData</a>;
<a name="l00367"></a>00367     <span class="keyword">const</span> <span class="keywordtype">char</span> ** baseNames;
<a name="l00368"></a>00368     <span class="keyword">const</span> <span class="keywordtype">char</span> ** dirNames;
<a name="l00369"></a>00369     <span class="keywordtype">int</span> * dirIndexes;
<a name="l00370"></a>00370     <span class="keywordtype">int</span> count;
<a name="l00371"></a>00371     <span class="keyword">const</span> <span class="keywordtype">char</span> ** fileNames;
<a name="l00372"></a>00372     <span class="keywordtype">int</span> size;
<a name="l00373"></a>00373     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> dirNameTag = 0;
<a name="l00374"></a>00374     <a class="code" href="rpmlib_8h.html#4f08fde948b5511f2a904dc92e39e211">rpmTag</a> dirIndexesTag = 0;
<a name="l00375"></a>00375     <a class="code" href="group__header.html#g30546f70b72fe13929f6e388dfd29b16" title="The basic types of data in tags from headers.">rpmTagType</a> bnt, dnt;
<a name="l00376"></a>00376     <span class="keywordtype">char</span> * t;
<a name="l00377"></a>00377     <span class="keywordtype">int</span> i, xx;
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="keywordflow">if</span> (tagN == <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359180a05d979f4bcc4aed2cc1f735c76aff">RPMTAG_BASENAMES</a>) {
<a name="l00380"></a>00380         dirNameTag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591eea50c17fff1c983c3a3ce3d773c87bd">RPMTAG_DIRNAMES</a>;
<a name="l00381"></a>00381         dirIndexesTag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d54a77407b42789192b9763ae70921e7">RPMTAG_DIRINDEXES</a>;
<a name="l00382"></a>00382     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tagN == <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914890c21e6c586736f27f632fffbe5fbb">RPMTAG_ORIGBASENAMES</a>) {
<a name="l00383"></a>00383         dirNameTag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d2c139f5208fb2338ac0fc5e975f84f4">RPMTAG_ORIGDIRNAMES</a>;
<a name="l00384"></a>00384         dirIndexesTag = <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359180e62f6026a6b243a6bfb01048b03a88">RPMTAG_ORIGDIRINDEXES</a>;
<a name="l00385"></a>00385     }
<a name="l00386"></a>00386 
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (!hge(h, tagN, &amp;bnt, (<span class="keywordtype">void</span> **) &amp;baseNames, &amp;count)) {
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (fnp) *fnp = NULL;
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (fcp) *fcp = 0;
<a name="l00390"></a>00390         <span class="keywordflow">return</span>;         <span class="comment">/* no file list */</span>
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392 
<a name="l00393"></a>00393     xx = hge(h, dirNameTag, &amp;dnt, (<span class="keywordtype">void</span> **) &amp;dirNames, NULL);
<a name="l00394"></a>00394     xx = hge(h, dirIndexesTag, NULL, (<span class="keywordtype">void</span> **) &amp;dirIndexes, &amp;count);
<a name="l00395"></a>00395 
<a name="l00396"></a>00396     size = <span class="keyword">sizeof</span>(*fileNames) * count;
<a name="l00397"></a>00397     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++)
<a name="l00398"></a>00398         size += strlen(baseNames[i]) + strlen(dirNames[dirIndexes[i]]) + 1;
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     fileNames = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(size);
<a name="l00401"></a>00401     t = ((<span class="keywordtype">char</span> *) fileNames) + (<span class="keyword">sizeof</span>(*fileNames) * count);
<a name="l00402"></a>00402     <span class="comment">/*@-branchstate@*/</span>
<a name="l00403"></a>00403     <span class="keywordflow">for</span> (i = 0; i &lt; count; i++) {
<a name="l00404"></a>00404         fileNames[i] = t;
<a name="l00405"></a>00405         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, dirNames[dirIndexes[i]]), baseNames[i]);
<a name="l00406"></a>00406         *t++ = <span class="charliteral">'\0'</span>;
<a name="l00407"></a>00407     }
<a name="l00408"></a>00408     <span class="comment">/*@=branchstate@*/</span>
<a name="l00409"></a>00409     baseNames = hfd(baseNames, bnt);
<a name="l00410"></a>00410     dirNames = hfd(dirNames, dnt);
<a name="l00411"></a>00411 
<a name="l00412"></a>00412     <span class="comment">/*@-branchstate@*/</span>
<a name="l00413"></a>00413     <span class="keywordflow">if</span> (fnp)
<a name="l00414"></a>00414         *fnp = fileNames;
<a name="l00415"></a>00415     <span class="keywordflow">else</span>
<a name="l00416"></a>00416         fileNames = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fileNames);
<a name="l00417"></a>00417     <span class="comment">/*@=branchstate@*/</span>
<a name="l00418"></a>00418     <span class="keywordflow">if</span> (fcp) *fcp = count;
<a name="l00419"></a>00419 }
<a name="l00420"></a>00420 
<a name="l00421"></a><a class="code" href="legacy_8h.html#b2d4f783dd7c3fb997d180a34d851a1b">00421</a> <span class="keywordtype">void</span> <a class="code" href="legacy_8c.html#b2d4f783dd7c3fb997d180a34d851a1b" title="Convert (dirname,basename,dirindex) tags to absolute path tag.">expandFilelist</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h)
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423     <a class="code" href="rpmlib_8h.html#e215c4769da8ab9ed84b0512f4dae89e" title="Prototype for headerAddEntry() vector.">HAE_t</a> hae = (<a class="code" href="rpmlib_8h.html#e215c4769da8ab9ed84b0512f4dae89e" title="Prototype for headerAddEntry() vector.">HAE_t</a>)<a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>;
<a name="l00424"></a>00424     <a class="code" href="rpmlib_8h.html#55156ad1a62e07a87f6636261bb95536" title="Prototype for headerRemoveEntry() vector.">HRE_t</a> hre = (<a class="code" href="rpmlib_8h.html#55156ad1a62e07a87f6636261bb95536" title="Prototype for headerRemoveEntry() vector.">HRE_t</a>)<a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>;
<a name="l00425"></a>00425     <span class="keyword">const</span> <span class="keywordtype">char</span> ** fileNames = NULL;
<a name="l00426"></a>00426     <span class="keywordtype">int</span> count = 0;
<a name="l00427"></a>00427     <span class="keywordtype">int</span> xx;
<a name="l00428"></a>00428 
<a name="l00429"></a>00429     <span class="comment">/*@-branchstate@*/</span>
<a name="l00430"></a>00430     <span class="keywordflow">if</span> (!<a class="code" href="group__header.html#g66b9abc5d3555279d547656ec0a2f245" title="Check if tag is in header.">headerIsEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917ef46a3645037c481c357f61d01f57d9">RPMTAG_OLDFILENAMES</a>)) {
<a name="l00431"></a>00431         <a class="code" href="legacy_8c.html#7a3747cee9eef44f62969af9b8d4d390" title="Retrieve file names from header.">rpmfiBuildFNames</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359180a05d979f4bcc4aed2cc1f735c76aff">RPMTAG_BASENAMES</a>, &amp;fileNames, &amp;count);
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (fileNames == NULL || count &lt;= 0)
<a name="l00433"></a>00433             <span class="keywordflow">return</span>;
<a name="l00434"></a>00434         xx = hae(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917ef46a3645037c481c357f61d01f57d9">RPMTAG_OLDFILENAMES</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00435"></a>00435                         fileNames, count);
<a name="l00436"></a>00436         fileNames = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fileNames);
<a name="l00437"></a>00437     }
<a name="l00438"></a>00438     <span class="comment">/*@=branchstate@*/</span>
<a name="l00439"></a>00439 
<a name="l00440"></a>00440     xx = hre(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591eea50c17fff1c983c3a3ce3d773c87bd">RPMTAG_DIRNAMES</a>);
<a name="l00441"></a>00441     xx = hre(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359180a05d979f4bcc4aed2cc1f735c76aff">RPMTAG_BASENAMES</a>);
<a name="l00442"></a>00442     xx = hre(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591d54a77407b42789192b9763ae70921e7">RPMTAG_DIRINDEXES</a>);
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a>00445 <span class="comment">/*</span>
<a name="l00446"></a>00446 <span class="comment"> * Up to rpm 3.0.4, packages implicitly provided their own name-version-release.</span>
<a name="l00447"></a>00447 <span class="comment"> * Retrofit an explicit "Provides: name = epoch:version-release.</span>
<a name="l00448"></a>00448 <span class="comment"> */</span>
<a name="l00449"></a><a class="code" href="legacy_8h.html#5a9645dfd465c75595ec043f85c70a47">00449</a> <span class="keywordtype">void</span> <a class="code" href="legacy_8c.html#5a9645dfd465c75595ec043f85c70a47" title="Retrofit a Provides: name = version-release dependency into legacy package headers...">providePackageNVR</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h)
<a name="l00450"></a>00450 {
<a name="l00451"></a>00451     <a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a> hge = (<a class="code" href="rpmlib_8h.html#96d4b4739a1c6b1f0d1d73229a4ed1bf" title="Prototype for headerGetEntry() vector.">HGE_t</a>)<a class="code" href="group__header.html#g29996e73fee54b49b34246121494cbf1" title="Retrieve tag value using header internal array.">headerGetEntryMinMemory</a>;
<a name="l00452"></a>00452     <a class="code" href="rpmlib_8h.html#b1e25001ce073d55e9fa97a3ad2213e8" title="Prototype for headerFreeData() vector.">HFD_t</a> hfd = <a class="code" href="group__header.html#ga2c977519b09cb7bf16f9765ec29d079" title="Free data allocated when retrieved from header.">headerFreeData</a>;
<a name="l00453"></a>00453     <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structname.html">name</a>, *version, *release;
<a name="l00454"></a>00454     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> * epoch;
<a name="l00455"></a>00455     <span class="keyword">const</span> <span class="keywordtype">char</span> *pEVR;
<a name="l00456"></a>00456     <span class="keywordtype">char</span> *p;
<a name="l00457"></a>00457     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> pFlags = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a>;
<a name="l00458"></a>00458     <span class="keyword">const</span> <span class="keywordtype">char</span> ** provides = NULL;
<a name="l00459"></a>00459     <span class="keyword">const</span> <span class="keywordtype">char</span> ** providesEVR = NULL;
<a name="l00460"></a>00460     <a class="code" href="group__header.html#g30546f70b72fe13929f6e388dfd29b16" title="The basic types of data in tags from headers.">rpmTagType</a> pnt, pvt;
<a name="l00461"></a>00461     <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> * provideFlags = NULL;
<a name="l00462"></a>00462     <span class="keywordtype">int</span> providesCount;
<a name="l00463"></a>00463     <span class="keywordtype">int</span> i, xx;
<a name="l00464"></a>00464     <span class="keywordtype">int</span> bingo = 1;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466     <span class="comment">/* Generate provides for this package name-version-release. */</span>
<a name="l00467"></a>00467     xx = <a class="code" href="group__header.html#g53462b3c5298a60fa2a43162deb4f41a" title="Return name, version, release strings from header.">headerNVR</a>(h, &amp;name, &amp;version, &amp;release);
<a name="l00468"></a>00468     <span class="keywordflow">if</span> (!(name &amp;&amp; version &amp;&amp; release))
<a name="l00469"></a>00469         <span class="keywordflow">return</span>;
<a name="l00470"></a>00470     pEVR = p = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(21 + strlen(version) + 1 + strlen(release) + 1);
<a name="l00471"></a>00471     *p = <span class="charliteral">'\0'</span>;
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (hge(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359165eb02d228815f698f37657343fede4a">RPMTAG_EPOCH</a>, NULL, (<span class="keywordtype">void</span> **) &amp;epoch, NULL)) {
<a name="l00473"></a>00473         sprintf(p, <span class="stringliteral">"%d:"</span>, *epoch);
<a name="l00474"></a>00474         <span class="keywordflow">while</span> (*p != <span class="charliteral">'\0'</span>)
<a name="l00475"></a>00475             p++;
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477     (void) <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(p, version) , <span class="stringliteral">"-"</span>) , release);
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="comment">/*</span>
<a name="l00480"></a>00480 <span class="comment">     * Rpm prior to 3.0.3 does not have versioned provides.</span>
<a name="l00481"></a>00481 <span class="comment">     * If no provides at all are available, we can just add.</span>
<a name="l00482"></a>00482 <span class="comment">     */</span>
<a name="l00483"></a>00483     <span class="keywordflow">if</span> (!hge(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, &amp;pnt, (<span class="keywordtype">void</span> **) &amp;provides, &amp;providesCount))
<a name="l00484"></a>00484         <span class="keywordflow">goto</span> exit;
<a name="l00485"></a>00485 
<a name="l00486"></a>00486     <span class="comment">/*</span>
<a name="l00487"></a>00487 <span class="comment">     * Otherwise, fill in entries on legacy packages.</span>
<a name="l00488"></a>00488 <span class="comment">     */</span>
<a name="l00489"></a>00489     <span class="keywordflow">if</span> (!hge(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>, &amp;pvt, (<span class="keywordtype">void</span> **) &amp;providesEVR, NULL)) {
<a name="l00490"></a>00490         <span class="keywordflow">for</span> (i = 0; i &lt; providesCount; i++) {
<a name="l00491"></a>00491             <span class="keywordtype">char</span> * vdummy = <span class="stringliteral">""</span>;
<a name="l00492"></a>00492             <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> fdummy = <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b27095cc820446dae032500d79201d59b1d824">RPMSENSE_ANY</a>;
<a name="l00493"></a>00493             xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00494"></a>00494                         &amp;vdummy, 1);
<a name="l00495"></a>00495             xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l00496"></a>00496                         &amp;fdummy, 1);
<a name="l00497"></a>00497         }
<a name="l00498"></a>00498         <span class="keywordflow">goto</span> exit;
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     xx = hge(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>, NULL, (<span class="keywordtype">void</span> **) &amp;provideFlags, NULL);
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="comment">/*@-nullderef@*/</span>    <span class="comment">/* LCL: providesEVR is not NULL */</span>
<a name="l00504"></a>00504     <span class="keywordflow">if</span> (provides &amp;&amp; providesEVR &amp;&amp; provideFlags)
<a name="l00505"></a>00505     <span class="keywordflow">for</span> (i = 0; i &lt; providesCount; i++) {
<a name="l00506"></a>00506         <span class="keywordflow">if</span> (!(provides[i] &amp;&amp; providesEVR[i]))
<a name="l00507"></a>00507             <span class="keywordflow">continue</span>;
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (!(provideFlags[i] == <a class="code" href="rpmlib_8h.html#4e838340e1a594afcd39d47b94b270954d816be7cb1f462af0337fd4acb1985e">RPMSENSE_EQUAL</a> &amp;&amp;
<a name="l00509"></a>00509             !strcmp(name, provides[i]) &amp;&amp; !strcmp(pEVR, providesEVR[i])))
<a name="l00510"></a>00510             <span class="keywordflow">continue</span>;
<a name="l00511"></a>00511         bingo = 0;
<a name="l00512"></a>00512         <span class="keywordflow">break</span>;
<a name="l00513"></a>00513     }
<a name="l00514"></a>00514     <span class="comment">/*@=nullderef@*/</span>
<a name="l00515"></a>00515 
<a name="l00516"></a>00516 exit:
<a name="l00517"></a>00517     provides = hfd(provides, pnt);
<a name="l00518"></a>00518     providesEVR = hfd(providesEVR, pvt);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520     <span class="keywordflow">if</span> (bingo) {
<a name="l00521"></a>00521         xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335915130263c2b394d9793ac3a651d59d3e4">RPMTAG_PROVIDENAME</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00522"></a>00522                 &amp;name, 1);
<a name="l00523"></a>00523         xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335914ae180b9c5d2dae07fdfd3a172114e62">RPMTAG_PROVIDEFLAGS</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l00524"></a>00524                 &amp;pFlags, 1);
<a name="l00525"></a>00525         xx = <a class="code" href="group__header.html#g35f1f3d2f8a07673bcb012331efde0aa" title="Add or append element to tag array in header.">headerAddOrAppendEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591fbf743107fc3628c36d27237709e2f31">RPMTAG_PROVIDEVERSION</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00526"></a>00526                 &amp;pEVR, 1);
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a><a class="code" href="legacy_8h.html#3e79dc4647f033f73a7b4c6237875b67">00530</a> <span class="keywordtype">void</span> <a class="code" href="legacy_8c.html#3e79dc4647f033f73a7b4c6237875b67" title="Do all necessary retorfits for a package header.">legacyRetrofit</a>(<a class="code" href="structheaderToken__s.html" title="The Header data structure.">Header</a> h, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structrpmlead.html" title="The lead data structure.">rpmlead</a> * lead)
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532     <span class="keyword">const</span> <span class="keywordtype">char</span> * prefix;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534     <span class="comment">/*</span>
<a name="l00535"></a>00535 <span class="comment">     * We don't use these entries (and rpm &gt;= 2 never has) and they are</span>
<a name="l00536"></a>00536 <span class="comment">     * pretty misleading. Let's just get rid of them so they don't confuse</span>
<a name="l00537"></a>00537 <span class="comment">     * anyone.</span>
<a name="l00538"></a>00538 <span class="comment">     */</span>
<a name="l00539"></a>00539     <span class="keywordflow">if</span> (<a class="code" href="group__header.html#g66b9abc5d3555279d547656ec0a2f245" title="Check if tag is in header.">headerIsEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359132ae70437ae1fae1c230518f639fdd66">RPMTAG_FILEUSERNAME</a>))
<a name="l00540"></a>00540         (void) <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335918a451691905d257396e8321de172f015">RPMTAG_FILEUIDS</a>);
<a name="l00541"></a>00541     <span class="keywordflow">if</span> (<a class="code" href="group__header.html#g66b9abc5d3555279d547656ec0a2f245" title="Check if tag is in header.">headerIsEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591cd1406e8cd0a3637c9004d01bbf1d68c">RPMTAG_FILEGROUPNAME</a>))
<a name="l00542"></a>00542         (void) <a class="code" href="group__header.html#g42344f48a6e110c628e5be801da5aa9c" title="Delete tag in header.">headerRemoveEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc33591a3bf4ab9a20247eff548b8e332ec37df">RPMTAG_FILEGIDS</a>);
<a name="l00543"></a>00543 
<a name="l00544"></a>00544     <span class="comment">/*</span>
<a name="l00545"></a>00545 <span class="comment">     * We switched the way we do relocatable packages. We fix some of</span>
<a name="l00546"></a>00546 <span class="comment">     * it up here, though the install code still has to be a bit </span>
<a name="l00547"></a>00547 <span class="comment">     * careful. This fixup makes queries give the new values though,</span>
<a name="l00548"></a>00548 <span class="comment">     * which is quite handy.</span>
<a name="l00549"></a>00549 <span class="comment">     */</span>
<a name="l00550"></a>00550     <span class="comment">/*@=branchstate@*/</span>
<a name="l00551"></a>00551     <span class="keywordflow">if</span> (<a class="code" href="group__header.html#gddebc5eb6a9605829e11a5b356b36d33" title="Retrieve tag value.">headerGetEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc3359136afd840dc0d19e3b3cb0a507d1ebdc9">RPMTAG_DEFAULTPREFIX</a>, NULL, (<span class="keywordtype">void</span> **) &amp;prefix, NULL))
<a name="l00552"></a>00552     {
<a name="l00553"></a>00553         <span class="keyword">const</span> <span class="keywordtype">char</span> * nprefix = <a class="code" href="misc_8h.html#d22ad36a3b1d054f4839eb2655279a3b" title="Remove occurences of trailing character from string.">stripTrailingChar</a>(<a class="code" href="fsm_8c.html#0e6c36aa207979a118f67d4ddb341fce">alloca_strdup</a>(prefix), <span class="charliteral">'/'</span>);
<a name="l00554"></a>00554         (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335917d24d8fd69ef9e2343d9b84ee95141a6">RPMTAG_PREFIXES</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c5de16ab5e977fbbb00fff7a70a0ff033">RPM_STRING_ARRAY_TYPE</a>,
<a name="l00555"></a>00555                 &amp;nprefix, 1); 
<a name="l00556"></a>00556     }
<a name="l00557"></a>00557     <span class="comment">/*@=branchstate@*/</span>
<a name="l00558"></a>00558 
<a name="l00559"></a>00559     <span class="comment">/*</span>
<a name="l00560"></a>00560 <span class="comment">     * The file list was moved to a more compressed format which not</span>
<a name="l00561"></a>00561 <span class="comment">     * only saves memory (nice), but gives fingerprinting a nice, fat</span>
<a name="l00562"></a>00562 <span class="comment">     * speed boost (very nice). Go ahead and convert old headers to</span>
<a name="l00563"></a>00563 <span class="comment">     * the new style (this is a noop for new headers).</span>
<a name="l00564"></a>00564 <span class="comment">     */</span>
<a name="l00565"></a>00565     <span class="keywordflow">if</span> (lead-&gt;<a class="code" href="structrpmlead.html#4e826f3eb80bb40144e8ac2cc6af4ca4">major</a> &lt; 4)
<a name="l00566"></a>00566         <a class="code" href="legacy_8c.html#e6ab95bc495931e0733868b30143e252" title="Convert absolute path tag to (dirname,basename,dirindex) tags.">compressFilelist</a>(h);
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="comment">/* XXX binary rpms always have RPMTAG_SOURCERPM, source rpms do not */</span>
<a name="l00569"></a>00569     <span class="keywordflow">if</span> (lead-&gt;<a class="code" href="structrpmlead.html#52b1d71aadea5dfaa3e46ac324b7ae43">type</a> == <a class="code" href="rpmlib_8h.html#71b6c1984783d95751b7e938ede4a234">RPMLEAD_SOURCE</a>) {
<a name="l00570"></a>00570         <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> one = 1;
<a name="l00571"></a>00571         <span class="keywordflow">if</span> (!<a class="code" href="group__header.html#g66b9abc5d3555279d547656ec0a2f245" title="Check if tag is in header.">headerIsEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335918f4700b1de11e9f4df9d6fde0dd6ec59">RPMTAG_SOURCEPACKAGE</a>))
<a name="l00572"></a>00572             (void) <a class="code" href="group__header.html#g176a0175a522214ae4fffa162728a5f8" title="Add tag to header.">headerAddEntry</a>(h, <a class="code" href="rpmlib_8h.html#d1edbc08d3fcb1a7678eb956cfc335918f4700b1de11e9f4df9d6fde0dd6ec59">RPMTAG_SOURCEPACKAGE</a>, <a class="code" href="group__header.html#gg4342aae7379e715a6b927663b340f43c0f09132d2e6b1b080b7d26b68309b031">RPM_INT32_TYPE</a>,
<a name="l00573"></a>00573                                 &amp;one, 1);
<a name="l00574"></a>00574     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lead-&gt;<a class="code" href="structrpmlead.html#4e826f3eb80bb40144e8ac2cc6af4ca4">major</a> &lt; 4) {
<a name="l00575"></a>00575         <span class="comment">/* Retrofit "Provide: name = EVR" for binary packages. */</span>
<a name="l00576"></a>00576         <a class="code" href="legacy_8c.html#5a9645dfd465c75595ec043f85c70a47" title="Retrofit a Provides: name = version-release dependency into legacy package headers...">providePackageNVR</a>(h);
<a name="l00577"></a>00577     }
<a name="l00578"></a>00578 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:54 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
