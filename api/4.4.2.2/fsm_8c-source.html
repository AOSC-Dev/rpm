<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>rpm: lib/fsm.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.2 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul>
</div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>Globals</span></a></li>
  </ul>
</div>
<h1>lib/fsm.c</h1><a href="fsm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00006"></a>00006 <span class="preprocessor">#include "<a class="code" href="system_8h.html">system.h</a>"</span>
<a name="l00007"></a>00007 
<a name="l00008"></a>00008 <span class="preprocessor">#include &lt;<a class="code" href="rpmio__internal_8h.html">rpmio_internal.h</a>&gt;</span>
<a name="l00009"></a>00009 <span class="preprocessor">#include &lt;<a class="code" href="rpmlib_8h.html" title="In Memoriam: Steve Taylor &lt;staylor@redhat.com&gt; was here, now he's not.">rpmlib.h</a>&gt;</span>
<a name="l00010"></a>00010 
<a name="l00011"></a>00011 <span class="preprocessor">#include "<a class="code" href="cpio_8h.html" title="Structures used to handle cpio payloads within rpm packages.">cpio.h</a>"</span>
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include "<a class="code" href="fsm_8h.html" title="File state machine to handle a payload within an rpm package.">fsm.h</a>"</span>
<a name="l00014"></a><a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">00014</a> <span class="preprocessor">#define fsmUNSAFE       fsmStage</span>
<a name="l00015"></a>00015 <span class="preprocessor"></span>
<a name="l00016"></a>00016 <span class="preprocessor">#include "<a class="code" href="rpmerr_8h.html">rpmerr.h</a>"</span>
<a name="l00017"></a>00017 
<a name="l00018"></a><a class="code" href="fsm_8c.html#23b390a0b6abdc14c30d53d89a40fd7f">00018</a> <span class="preprocessor">#define _RPMFI_INTERNAL</span>
<a name="l00019"></a>00019 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="rpmfi_8h.html" title="Structure(s) used for file info tag sets.">rpmfi.h</a>"</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include "<a class="code" href="rpmte_8h.html" title="Structures used for an "rpmte" transaction element.">rpmte.h</a>"</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include "<a class="code" href="rpmts_8h.html" title="Structures and prototypes used for an "rpmts" transaction set.">rpmts.h</a>"</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include "<a class="code" href="rpmsq_8h.html">rpmsq.h</a>"</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include "<a class="code" href="ugid_8h.html">ugid.h</a>"</span>               <span class="comment">/* XXX unameToUid() and gnameToGid() */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include "<a class="code" href="debug_8h.html">debug.h</a>"</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="comment">/*@access FD_t @*/</span>      <span class="comment">/* XXX void ptr args */</span>
<a name="l00029"></a>00029 <span class="comment">/*@access FSMI_t @*/</span>
<a name="l00030"></a>00030 <span class="comment">/*@access FSM_t @*/</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">/*@access rpmfi @*/</span>
<a name="l00033"></a>00033 
<a name="l00034"></a><a class="code" href="fsm_8c.html#0e6c36aa207979a118f67d4ddb341fce">00034</a> <span class="preprocessor">#define alloca_strdup(_s)       strcpy(alloca(strlen(_s)+1), (_s))</span>
<a name="l00035"></a>00035 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="fsm_8c.html#6a0b22c3779c91ef8dc780a1d8298119">00036</a> <span class="preprocessor">#define _FSM_DEBUG      0</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="comment">/*@unchecked@*/</span>
<a name="l00038"></a><a class="code" href="poptALL_8c.html#76ef6b61d6c034d5d7a84280e388f483">00038</a> <span class="keywordtype">int</span> <a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> = <a class="code" href="fsm_8c.html#6a0b22c3779c91ef8dc780a1d8298119">_FSM_DEBUG</a>;
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="comment">/*@-exportheadervar@*/</span>
<a name="l00041"></a>00041 <span class="comment">/*@unchecked@*/</span>
<a name="l00042"></a><a class="code" href="poptALL_8c.html#bd2f72dd5fff0183f3a3392c943ed9c3">00042</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#bd2f72dd5fff0183f3a3392c943ed9c3">_fsm_threads</a> = 0;
<a name="l00043"></a>00043 <span class="comment">/*@=exportheadervar@*/</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="comment">/* XXX Failure to remove is not (yet) cause for failure. */</span>
<a name="l00046"></a>00046 <span class="comment">/*@-exportlocal -exportheadervar@*/</span>
<a name="l00047"></a>00047 <span class="comment">/*@unchecked@*/</span>
<a name="l00048"></a><a class="code" href="fsm_8c.html#b5626c987420c6ab48ddb9541d6a5181">00048</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#b5626c987420c6ab48ddb9541d6a5181">strict_erasures</a> = 0;
<a name="l00049"></a>00049 <span class="comment">/*@=exportlocal =exportheadervar@*/</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="fsm_8h.html#79af3076ba347b7d1fea192fb7bf911e">00051</a> <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> <a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(<span class="keyword">const</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm) {
<a name="l00052"></a>00052     <span class="keyword">const</span> <a class="code" href="structfsmIterator__s.html" title="Iterator across package file info, forward on install, backward on erase.">FSMI_t</a> iter = fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a>;
<a name="l00053"></a>00053     <span class="comment">/*@-compdef -refcounttrans -retexpose -usereleased @*/</span>
<a name="l00054"></a>00054     <span class="keywordflow">return</span> (iter ? iter-&gt;<a class="code" href="structfsmIterator__s.html#e96f740751a13957cab24103029dd19a">ts</a> : NULL);
<a name="l00055"></a>00055     <span class="comment">/*@=compdef =refcounttrans =retexpose =usereleased @*/</span>
<a name="l00056"></a>00056 }
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="fsm_8h.html#a372483e106d9a40cdff9929008331a3">00058</a> <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(<span class="keyword">const</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00059"></a>00059 {
<a name="l00060"></a>00060     <span class="keyword">const</span> <a class="code" href="structfsmIterator__s.html" title="Iterator across package file info, forward on install, backward on erase.">FSMI_t</a> iter = fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a>;
<a name="l00061"></a>00061     <span class="comment">/*@-compdef -refcounttrans -retexpose -usereleased @*/</span>
<a name="l00062"></a>00062     <span class="keywordflow">return</span> (iter ? iter-&gt;<a class="code" href="structfsmIterator__s.html#bf57c80e6163e4f9bdd7dbe570a46463">fi</a> : NULL);
<a name="l00063"></a>00063     <span class="comment">/*@=compdef =refcounttrans =retexpose =usereleased @*/</span>
<a name="l00064"></a>00064 }
<a name="l00065"></a>00065 
<a name="l00066"></a><a class="code" href="fsm_8c.html#e3f9813e414018874da312f62dba6abf">00066</a> <span class="preprocessor">#define SUFFIX_RPMORIG  ".rpmorig"</span>
<a name="l00067"></a><a class="code" href="fsm_8c.html#5d20ad06b1b5013d721500a60c3f7a5f">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define SUFFIX_RPMSAVE  ".rpmsave"</span>
<a name="l00068"></a><a class="code" href="fsm_8c.html#b3bef1d63c9c102d9f0502d967228e62">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define SUFFIX_RPMNEW   ".rpmnew"</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span>
<a name="l00078"></a>00078 <span class="keyword">static</span> <span class="comment">/*@only@*/</span><span class="comment">/*@null@*/</span>
<a name="l00079"></a><a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d">00079</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm,
<a name="l00080"></a>00080                 <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keyword">struct</span> stat * st,
<a name="l00081"></a>00081                 <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * subdir,
<a name="l00082"></a>00082                 <span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> * suffix)
<a name="l00083"></a>00083         <span class="comment">/*@uses fsm-&gt;dirName, fsm-&gt;baseName */</span>
<a name="l00084"></a>00084         <span class="comment">/*@*/</span>
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086     <span class="keyword">const</span> <span class="keywordtype">char</span> * s = NULL;
<a name="l00087"></a>00087 
<a name="l00088"></a>00088     <span class="keywordflow">if</span> (fsm) {
<a name="l00089"></a>00089         <span class="keywordtype">int</span> nb;
<a name="l00090"></a>00090         <span class="keywordtype">char</span> * t;
<a name="l00091"></a>00091         nb = strlen(fsm-&gt;<a class="code" href="structfsm__s.html#311bd72c333f118e811508411ac483cb">dirName</a>) +
<a name="l00092"></a>00092             (st &amp;&amp; !S_ISDIR(st-&gt;st_mode) ? (subdir ? strlen(subdir) : 0) : 0) +
<a name="l00093"></a>00093             (st &amp;&amp; !S_ISDIR(st-&gt;st_mode) ? (suffix ? strlen(suffix) : 0) : 0) +
<a name="l00094"></a>00094             strlen(fsm-&gt;<a class="code" href="structfsm__s.html#5e07c45abe2d972bd5b9a3e43838af7e">baseName</a>) + 1;
<a name="l00095"></a>00095 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00096"></a>00096         s = t = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(nb);
<a name="l00097"></a>00097         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, fsm-&gt;<a class="code" href="structfsm__s.html#311bd72c333f118e811508411ac483cb">dirName</a>);
<a name="l00098"></a>00098         <span class="keywordflow">if</span> (st &amp;&amp; !S_ISDIR(st-&gt;st_mode))
<a name="l00099"></a>00099             <span class="keywordflow">if</span> (subdir) t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, subdir);
<a name="l00100"></a>00100         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, fsm-&gt;<a class="code" href="structfsm__s.html#5e07c45abe2d972bd5b9a3e43838af7e">baseName</a>);
<a name="l00101"></a>00101         <span class="keywordflow">if</span> (st &amp;&amp; !S_ISDIR(st-&gt;st_mode))
<a name="l00102"></a>00102             <span class="keywordflow">if</span> (suffix) t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, suffix);
<a name="l00103"></a>00103 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     <span class="keywordflow">return</span> s;
<a name="l00106"></a>00106 }
<a name="l00107"></a>00107 
<a name="l00113"></a><a class="code" href="group__payload.html#g1fd05286dfa9848e8c26c25764623e8f">00113</a> <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> * <a class="code" href="group__payload.html#g1fd05286dfa9848e8c26c25764623e8f" title="Destroy file info iterator.">mapFreeIterator</a>(<span class="comment">/*@only@*/</span><span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> * p)
<a name="l00114"></a>00114         <span class="comment">/*@globals fileSystem @*/</span>
<a name="l00115"></a>00115         <span class="comment">/*@modifies fileSystem @*/</span>
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117     <a class="code" href="structfsmIterator__s.html" title="Iterator across package file info, forward on install, backward on erase.">FSMI_t</a> iter = p;
<a name="l00118"></a>00118     <span class="keywordflow">if</span> (iter) {
<a name="l00119"></a>00119 <span class="comment">/*@-internalglobs@*/</span> <span class="comment">/* XXX rpmswExit() */</span>
<a name="l00120"></a>00120         iter-&gt;<a class="code" href="structfsmIterator__s.html#e96f740751a13957cab24103029dd19a">ts</a> = <a class="code" href="group__rpmts.html#g95515319c5194d997d6cb84a1e1938c2" title="Destroy transaction set, closing the database as well.">rpmtsFree</a>(iter-&gt;<a class="code" href="structfsmIterator__s.html#e96f740751a13957cab24103029dd19a">ts</a>);
<a name="l00121"></a>00121 <span class="comment">/*@=internalglobs@*/</span>
<a name="l00122"></a>00122         iter-&gt;<a class="code" href="structfsmIterator__s.html#bf57c80e6163e4f9bdd7dbe570a46463">fi</a> = <a class="code" href="rpmfi_8h.html#05611d9693039309f1778f3a45368a1a">rpmfiUnlink</a>(iter-&gt;<a class="code" href="structfsmIterator__s.html#bf57c80e6163e4f9bdd7dbe570a46463">fi</a>, <span class="stringliteral">"mapIterator"</span>);
<a name="l00123"></a>00123     }
<a name="l00124"></a>00124     <span class="keywordflow">return</span> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(p);
<a name="l00125"></a>00125 }
<a name="l00126"></a>00126 
<a name="l00133"></a>00133 <span class="keyword">static</span> <span class="keywordtype">void</span> *
<a name="l00134"></a><a class="code" href="group__payload.html#ge8aa1c0ca3352e8c71c816c9b9684971">00134</a> <a class="code" href="group__payload.html#ge8aa1c0ca3352e8c71c816c9b9684971" title="Create file info iterator.">mapInitIterator</a>(<a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts, <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi)
<a name="l00135"></a>00135         <span class="comment">/*@modifies ts, fi @*/</span>
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137     <a class="code" href="structfsmIterator__s.html" title="Iterator across package file info, forward on install, backward on erase.">FSMI_t</a> iter = NULL;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139     iter = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*iter));
<a name="l00140"></a>00140     iter-&gt;ts = <a class="code" href="rpmts_8h.html#346f18c7cabbef6b51374da7fb14c546">rpmtsLink</a>(ts, <span class="stringliteral">"mapIterator"</span>);
<a name="l00141"></a>00141     iter-&gt;fi = <a class="code" href="rpmfi_8h.html#4345738dd5db5084d0875c2d9a7354b4">rpmfiLink</a>(fi, <span class="stringliteral">"mapIterator"</span>);
<a name="l00142"></a>00142     iter-&gt;reverse = (<a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e20429d7556bc1510e6d739288ab336dd0157">TR_REMOVED</a> &amp;&amp; fi-&gt;action != <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef957be9542b973695e13c1733094d77ba8">FA_COPYOUT</a>);
<a name="l00143"></a>00143     iter-&gt;i = (iter-&gt;reverse ? (fi-&gt;fc - 1) : 0);
<a name="l00144"></a>00144     iter-&gt;isave = iter-&gt;i;
<a name="l00145"></a>00145     <span class="keywordflow">return</span> iter;
<a name="l00146"></a>00146 }
<a name="l00147"></a>00147 
<a name="l00153"></a><a class="code" href="group__payload.html#gc3e7c71c0c5c6614af0567c5d986843d">00153</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#gc3e7c71c0c5c6614af0567c5d986843d" title="Return next index into file info.">mapNextIterator</a>(<span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> * a)
<a name="l00154"></a>00154         <span class="comment">/*@*/</span>
<a name="l00155"></a>00155 {
<a name="l00156"></a>00156     <a class="code" href="structfsmIterator__s.html" title="Iterator across package file info, forward on install, backward on erase.">FSMI_t</a> iter = a;
<a name="l00157"></a>00157     <span class="keywordtype">int</span> i = -1;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (iter) {
<a name="l00160"></a>00160         <span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = iter-&gt;<a class="code" href="structfsmIterator__s.html#bf57c80e6163e4f9bdd7dbe570a46463">fi</a>;
<a name="l00161"></a>00161         <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="structfsmIterator__s.html#53cdb46aa5d5909d3705dc5211b29bfa">reverse</a>) {
<a name="l00162"></a>00162             <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="structfsmIterator__s.html#f7ba11e47a3255d86a7642819027e28c">i</a> &gt;= 0)   i = iter-&gt;<a class="code" href="structfsmIterator__s.html#f7ba11e47a3255d86a7642819027e28c">i</a>--;
<a name="l00163"></a>00163         } <span class="keywordflow">else</span> {
<a name="l00164"></a>00164             <span class="keywordflow">if</span> (iter-&gt;<a class="code" href="structfsmIterator__s.html#f7ba11e47a3255d86a7642819027e28c">i</a> &lt; fi-&gt;fc)       i = iter-&gt;<a class="code" href="structfsmIterator__s.html#f7ba11e47a3255d86a7642819027e28c">i</a>++;
<a name="l00165"></a>00165         }
<a name="l00166"></a>00166         iter-&gt;<a class="code" href="structfsmIterator__s.html#793e63be9f7c77afd7e8866ad654c062">isave</a> = i;
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="keywordflow">return</span> i;
<a name="l00169"></a>00169 }
<a name="l00170"></a>00170 
<a name="l00173"></a>00173 <span class="comment">/*@-boundsread@*/</span>
<a name="l00174"></a><a class="code" href="group__payload.html#g37c749b5ff0d983ab45e9a14990cbddc">00174</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#g37c749b5ff0d983ab45e9a14990cbddc">cpioStrCmp</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> * a, <span class="keyword">const</span> <span class="keywordtype">void</span> * b)
<a name="l00175"></a>00175         <span class="comment">/*@*/</span>
<a name="l00176"></a>00176 {
<a name="l00177"></a>00177     <span class="keyword">const</span> <span class="keywordtype">char</span> * afn = *(<span class="keyword">const</span> <span class="keywordtype">char</span> **)a;
<a name="l00178"></a>00178     <span class="keyword">const</span> <span class="keywordtype">char</span> * bfn = *(<span class="keyword">const</span> <span class="keywordtype">char</span> **)b;
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">/* XXX Some 4+ year old rpm packages have basename only in payloads. */</span>
<a name="l00181"></a>00181 <span class="preprocessor">#ifdef  VERY_OLD_BUGGY_RPM_PACKAGES</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (strchr(afn, <span class="charliteral">'/'</span>) == NULL)
<a name="l00183"></a>00183         bfn = strrchr(bfn, <span class="charliteral">'/'</span>) + 1;
<a name="l00184"></a>00184 <span class="preprocessor">#endif</span>
<a name="l00185"></a>00185 <span class="preprocessor"></span>
<a name="l00186"></a>00186     <span class="comment">/* Match rpm-4.0 payloads with ./ prefixes. */</span>
<a name="l00187"></a>00187     <span class="keywordflow">if</span> (afn[0] == <span class="charliteral">'.'</span> &amp;&amp; afn[1] == <span class="charliteral">'/'</span>) afn += 2;
<a name="l00188"></a>00188     <span class="keywordflow">if</span> (bfn[0] == <span class="charliteral">'.'</span> &amp;&amp; bfn[1] == <span class="charliteral">'/'</span>) bfn += 2;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <span class="comment">/* If either path is absolute, make it relative. */</span>
<a name="l00191"></a>00191     <span class="keywordflow">if</span> (afn[0] == <span class="charliteral">'/'</span>)  afn += 1;
<a name="l00192"></a>00192     <span class="keywordflow">if</span> (bfn[0] == <span class="charliteral">'/'</span>)  bfn += 1;
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="keywordflow">return</span> strcmp(afn, bfn);
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 <span class="comment">/*@=boundsread@*/</span>
<a name="l00197"></a>00197 
<a name="l00204"></a>00204 <span class="comment">/*@-boundsread@*/</span>
<a name="l00205"></a><a class="code" href="group__payload.html#gdffbdd1164605996bec9620e6acbe8b1">00205</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#gdffbdd1164605996bec9620e6acbe8b1" title="Locate archive path in file info.">mapFind</a>(<span class="comment">/*@null@*/</span> <a class="code" href="structfsmIterator__s.html" title="Iterator across package file info, forward on install, backward on erase.">FSMI_t</a> iter, <span class="keyword">const</span> <span class="keywordtype">char</span> * fsmPath)
<a name="l00206"></a>00206         <span class="comment">/*@modifies iter @*/</span>
<a name="l00207"></a>00207 {
<a name="l00208"></a>00208     <span class="keywordtype">int</span> ix = -1;
<a name="l00209"></a>00209 
<a name="l00210"></a>00210     <span class="keywordflow">if</span> (iter) {
<a name="l00211"></a>00211         <span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = iter-&gt;<a class="code" href="structfsmIterator__s.html#bf57c80e6163e4f9bdd7dbe570a46463">fi</a>;
<a name="l00212"></a>00212         <span class="keywordflow">if</span> (fi &amp;&amp; fi-&gt;fc &gt; 0 &amp;&amp; fi-&gt;apath &amp;&amp; fsmPath &amp;&amp; *fsmPath) {
<a name="l00213"></a>00213             <span class="keyword">const</span> <span class="keywordtype">char</span> ** p = NULL;
<a name="l00214"></a>00214 
<a name="l00215"></a>00215 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00216"></a>00216             <span class="keywordflow">if</span> (fi-&gt;apath != NULL)
<a name="l00217"></a>00217                 p = bsearch(&amp;fsmPath, fi-&gt;apath, fi-&gt;fc, <span class="keyword">sizeof</span>(fsmPath),
<a name="l00218"></a>00218                         <a class="code" href="group__payload.html#g37c749b5ff0d983ab45e9a14990cbddc">cpioStrCmp</a>);
<a name="l00219"></a>00219 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00220"></a>00220             <span class="keywordflow">if</span> (p) {
<a name="l00221"></a>00221                 iter-&gt;<a class="code" href="structfsmIterator__s.html#f7ba11e47a3255d86a7642819027e28c">i</a> = p - fi-&gt;apath;
<a name="l00222"></a>00222                 ix = <a class="code" href="group__payload.html#gc3e7c71c0c5c6614af0567c5d986843d" title="Return next index into file info.">mapNextIterator</a>(iter);
<a name="l00223"></a>00223             }
<a name="l00224"></a>00224         }
<a name="l00225"></a>00225     }
<a name="l00226"></a>00226     <span class="keywordflow">return</span> ix;
<a name="l00227"></a>00227 }
<a name="l00228"></a>00228 <span class="comment">/*@=boundsread@*/</span>
<a name="l00229"></a>00229 
<a name="l00233"></a><a class="code" href="structdnli__s.html">00233</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structdnli__s.html" title="Directory name iterator.">dnli_s</a> {
<a name="l00234"></a><a class="code" href="structdnli__s.html#a2ad2febd64827c824b74075fc9eb872">00234</a>     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> <a class="code" href="structdnli__s.html#a2ad2febd64827c824b74075fc9eb872">fi</a>;
<a name="l00235"></a>00235 <span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00236"></a><a class="code" href="structdnli__s.html#9ea9c575774a7b1a0cb379e4a2daf29b">00236</a>     <span class="keywordtype">char</span> * <a class="code" href="structdnli__s.html#9ea9c575774a7b1a0cb379e4a2daf29b">active</a>;
<a name="l00237"></a><a class="code" href="structdnli__s.html#59ecfdc1022513f14a5a59ba7a12795a">00237</a>     <span class="keywordtype">int</span> <a class="code" href="structdnli__s.html#59ecfdc1022513f14a5a59ba7a12795a">reverse</a>;
<a name="l00238"></a><a class="code" href="structdnli__s.html#36f3405e7bcbaca5f729a6dadda12df3">00238</a>     <span class="keywordtype">int</span> <a class="code" href="structdnli__s.html#36f3405e7bcbaca5f729a6dadda12df3">isave</a>;
<a name="l00239"></a><a class="code" href="structdnli__s.html#0244b5b69d47fc48df79ea95ce11a22f">00239</a>     <span class="keywordtype">int</span> <a class="code" href="structdnli__s.html#0244b5b69d47fc48df79ea95ce11a22f">i</a>;
<a name="l00240"></a>00240 } * <a class="code" href="structdnli__s.html" title="Directory name iterator.">DNLI_t</a>;
<a name="l00241"></a>00241 
<a name="l00247"></a><a class="code" href="group__payload.html#gb360bb38b118640228af9fb4bd6d067d">00247</a> <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> * <a class="code" href="group__payload.html#gb360bb38b118640228af9fb4bd6d067d" title="Destroy directory name iterator.">dnlFreeIterator</a>(<span class="comment">/*@only@*/</span><span class="comment">/*@null@*/</span> <span class="keyword">const</span> <span class="keywordtype">void</span> * a)
<a name="l00248"></a>00248         <span class="comment">/*@modifies a @*/</span>
<a name="l00249"></a>00249 {
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (a) {
<a name="l00251"></a>00251         <a class="code" href="structdnli__s.html" title="Directory name iterator.">DNLI_t</a> dnli = (<span class="keywordtype">void</span> *)a;
<a name="l00252"></a>00252         <span class="keywordflow">if</span> (dnli-&gt;<a class="code" href="structdnli__s.html#9ea9c575774a7b1a0cb379e4a2daf29b">active</a>) free(dnli-&gt;<a class="code" href="structdnli__s.html#9ea9c575774a7b1a0cb379e4a2daf29b">active</a>);
<a name="l00253"></a>00253     }
<a name="l00254"></a>00254     <span class="keywordflow">return</span> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(a);
<a name="l00255"></a>00255 }
<a name="l00256"></a>00256 
<a name="l00259"></a><a class="code" href="group__payload.html#ge7fb0a21248265e78d8e9fc06b4cf708">00259</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#ge7fb0a21248265e78d8e9fc06b4cf708">dnlCount</a>(<span class="comment">/*@null@*/</span> <span class="keyword">const</span> <a class="code" href="structdnli__s.html" title="Directory name iterator.">DNLI_t</a> dnli)
<a name="l00260"></a>00260         <span class="comment">/*@*/</span>
<a name="l00261"></a>00261 {
<a name="l00262"></a>00262     <span class="keywordflow">return</span> (dnli ? dnli-&gt;<a class="code" href="structdnli__s.html#a2ad2febd64827c824b74075fc9eb872">fi</a>-&gt;dc : 0);
<a name="l00263"></a>00263 }
<a name="l00264"></a>00264 
<a name="l00267"></a><a class="code" href="group__payload.html#gba4a4ab97a1721b54010195e06543159">00267</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#gba4a4ab97a1721b54010195e06543159">dnlIndex</a>(<span class="comment">/*@null@*/</span> <span class="keyword">const</span> <a class="code" href="structdnli__s.html" title="Directory name iterator.">DNLI_t</a> dnli)
<a name="l00268"></a>00268         <span class="comment">/*@*/</span>
<a name="l00269"></a>00269 {
<a name="l00270"></a>00270     <span class="keywordflow">return</span> (dnli ? dnli-&gt;<a class="code" href="structdnli__s.html#36f3405e7bcbaca5f729a6dadda12df3">isave</a> : -1);
<a name="l00271"></a>00271 }
<a name="l00272"></a>00272 
<a name="l00279"></a>00279 <span class="comment">/*@-boundsread@*/</span>
<a name="l00280"></a>00280 <span class="comment">/*@-usereleased@*/</span>
<a name="l00281"></a>00281 <span class="keyword">static</span> <span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00282"></a><a class="code" href="group__payload.html#g9c78bfa42b2036abb3a0cb98aaa24b13">00282</a> <span class="keywordtype">void</span> * <a class="code" href="group__payload.html#g9c78bfa42b2036abb3a0cb98aaa24b13" title="Create directory name iterator.">dnlInitIterator</a>(<span class="comment">/*@special@*/</span> <span class="keyword">const</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm,
<a name="l00283"></a>00283                 <span class="keywordtype">int</span> <a class="code" href="merge_8c.html#6f9b4228ebb63811a6089656bec42dce">reverse</a>)
<a name="l00284"></a>00284         <span class="comment">/*@uses fsm-&gt;iter @*/</span> 
<a name="l00285"></a>00285         <span class="comment">/*@*/</span>
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l00288"></a>00288     <a class="code" href="structdnli__s.html" title="Directory name iterator.">DNLI_t</a> dnli;
<a name="l00289"></a>00289     <span class="keywordtype">int</span> i, j;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291     <span class="keywordflow">if</span> (fi == NULL)
<a name="l00292"></a>00292         <span class="keywordflow">return</span> NULL;
<a name="l00293"></a>00293     dnli = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*dnli));
<a name="l00294"></a>00294     dnli-&gt;fi = fi;
<a name="l00295"></a>00295     dnli-&gt;reverse = reverse;
<a name="l00296"></a>00296     <span class="comment">/*@-branchstate@*/</span>
<a name="l00297"></a>00297     dnli-&gt;i = (reverse ? fi-&gt;dc : 0);
<a name="l00298"></a>00298     <span class="comment">/*@=branchstate@*/</span>
<a name="l00299"></a>00299 
<a name="l00300"></a>00300     <span class="keywordflow">if</span> (fi-&gt;dc) {
<a name="l00301"></a>00301         dnli-&gt;active = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(fi-&gt;dc, <span class="keyword">sizeof</span>(*dnli-&gt;active));
<a name="l00302"></a>00302 
<a name="l00303"></a>00303         <span class="comment">/* Identify parent directories not skipped. */</span>
<a name="l00304"></a>00304 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00305"></a>00305         <span class="keywordflow">for</span> (i = 0; i &lt; fi-&gt;fc; i++)
<a name="l00306"></a>00306             <span class="keywordflow">if</span> (!<a class="code" href="rpmlib_8h.html#2ed895afbe3c80bdfb7275869c487104">XFA_SKIPPING</a>(fi-&gt;actions[i])) dnli-&gt;active[fi-&gt;dil[i]] = 1;
<a name="l00307"></a>00307 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         <span class="comment">/* Exclude parent directories that are explicitly included. */</span>
<a name="l00310"></a>00310         for (i = 0; i &lt; fi-&gt;fc; i++) {
<a name="l00311"></a>00311             <span class="keywordtype">int</span> dil, dnlen, bnlen;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313             <span class="keywordflow">if</span> (!S_ISDIR(fi-&gt;fmodes[i]))
<a name="l00314"></a>00314                 <span class="keywordflow">continue</span>;
<a name="l00315"></a>00315 
<a name="l00316"></a>00316             dil = fi-&gt;dil[i];
<a name="l00317"></a>00317             dnlen = strlen(fi-&gt;dnl[dil]);
<a name="l00318"></a>00318             bnlen = strlen(fi-&gt;bnl[i]);
<a name="l00319"></a>00319 
<a name="l00320"></a>00320             for (j = 0; j &lt; fi-&gt;dc; j++) {
<a name="l00321"></a>00321                 <span class="keyword">const</span> <span class="keywordtype">char</span> * dnl;
<a name="l00322"></a>00322                 <span class="keywordtype">int</span> jlen;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324                 <span class="keywordflow">if</span> (!dnli-&gt;active[j] || j == dil)
<a name="l00325"></a>00325                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00326"></a>00326                 dnl = fi-&gt;dnl[j];
<a name="l00327"></a>00327                 jlen = strlen(dnl);
<a name="l00328"></a>00328                 <span class="keywordflow">if</span> (jlen != (dnlen+bnlen+1))
<a name="l00329"></a>00329                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00330"></a>00330                 <span class="keywordflow">if</span> (strncmp(dnl, fi-&gt;dnl[dil], dnlen))
<a name="l00331"></a>00331                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00332"></a>00332                 if (strncmp(dnl+dnlen, fi-&gt;bnl[i], bnlen))
<a name="l00333"></a>00333                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00334"></a>00334                 if (dnl[dnlen+bnlen] != <span class="charliteral">'/'</span> || dnl[dnlen+bnlen+1] != <span class="charliteral">'\0'</span>)
<a name="l00335"></a>00335                     <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l00336"></a>00336                 <span class="comment">/* This directory is included in the package. */</span>
<a name="l00337"></a>00337 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00338"></a>00338                 dnli-&gt;active[j] = 0;
<a name="l00339"></a>00339 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00340"></a>00340                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00341"></a>00341             }
<a name="l00342"></a>00342         }
<a name="l00343"></a>00343 
<a name="l00344"></a>00344         <span class="comment">/* Print only once per package. */</span>
<a name="l00345"></a>00345         <span class="keywordflow">if</span> (!reverse) {
<a name="l00346"></a>00346             j = 0;
<a name="l00347"></a>00347             <span class="keywordflow">for</span> (i = 0; i &lt; fi-&gt;dc; i++) {
<a name="l00348"></a>00348                 <span class="keywordflow">if</span> (!dnli-&gt;active[i]) <span class="keywordflow">continue</span>;
<a name="l00349"></a>00349                 if (j == 0) {
<a name="l00350"></a>00350                     j = 1;
<a name="l00351"></a>00351                     <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>,
<a name="l00352"></a>00352         <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"========== Directories not explicitly included in package:\n"</span>));
<a name="l00353"></a>00353                 }
<a name="l00354"></a>00354                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%10d %s\n"</span>), i, fi-&gt;dnl[i]);
<a name="l00355"></a>00355             }
<a name="l00356"></a>00356             <span class="keywordflow">if</span> (j)
<a name="l00357"></a>00357                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <span class="stringliteral">"==========\n"</span>);
<a name="l00358"></a>00358         }
<a name="l00359"></a>00359     }
<a name="l00360"></a>00360     <span class="keywordflow">return</span> dnli;
<a name="l00361"></a>00361 }
<a name="l00362"></a>00362 <span class="comment">/*@=usereleased@*/</span>
<a name="l00363"></a>00363 <span class="comment">/*@=boundsread@*/</span>
<a name="l00364"></a>00364 
<a name="l00370"></a>00370 <span class="comment">/*@-boundsread@*/</span>
<a name="l00371"></a>00371 <span class="keyword">static</span> <span class="comment">/*@observer@*/</span> <span class="comment">/*@null@*/</span>
<a name="l00372"></a><a class="code" href="group__payload.html#g3a778746d4887e03063a884ff6414e57">00372</a> <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="group__payload.html#g3a778746d4887e03063a884ff6414e57" title="Return next directory name (from file info).">dnlNextIterator</a>(<span class="comment">/*@null@*/</span> <a class="code" href="structdnli__s.html" title="Directory name iterator.">DNLI_t</a> dnli)
<a name="l00373"></a>00373         <span class="comment">/*@modifies dnli @*/</span>
<a name="l00374"></a>00374 {
<a name="l00375"></a>00375     <span class="keyword">const</span> <span class="keywordtype">char</span> * dn = NULL;
<a name="l00376"></a>00376 
<a name="l00377"></a>00377     <span class="keywordflow">if</span> (dnli) {
<a name="l00378"></a>00378         <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = dnli-&gt;<a class="code" href="structdnli__s.html#a2ad2febd64827c824b74075fc9eb872">fi</a>;
<a name="l00379"></a>00379         <span class="keywordtype">int</span> i = -1;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381         <span class="keywordflow">if</span> (dnli-&gt;<a class="code" href="structdnli__s.html#9ea9c575774a7b1a0cb379e4a2daf29b">active</a>)
<a name="l00382"></a>00382         <span class="keywordflow">do</span> {
<a name="l00383"></a>00383             i = (!dnli-&gt;<a class="code" href="structdnli__s.html#59ecfdc1022513f14a5a59ba7a12795a">reverse</a> ? dnli-&gt;<a class="code" href="structdnli__s.html#0244b5b69d47fc48df79ea95ce11a22f">i</a>++ : --dnli-&gt;<a class="code" href="structdnli__s.html#0244b5b69d47fc48df79ea95ce11a22f">i</a>);
<a name="l00384"></a>00384         } <span class="keywordflow">while</span> (i &gt;= 0 &amp;&amp; i &lt; fi-&gt;dc &amp;&amp; !dnli-&gt;<a class="code" href="structdnli__s.html#9ea9c575774a7b1a0cb379e4a2daf29b">active</a>[i]);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386         <span class="keywordflow">if</span> (i &gt;= 0 &amp;&amp; i &lt; fi-&gt;dc)
<a name="l00387"></a>00387             dn = fi-&gt;dnl[i];
<a name="l00388"></a>00388         <span class="keywordflow">else</span>
<a name="l00389"></a>00389             i = -1;
<a name="l00390"></a>00390         dnli-&gt;<a class="code" href="structdnli__s.html#36f3405e7bcbaca5f729a6dadda12df3">isave</a> = i;
<a name="l00391"></a>00391     }
<a name="l00392"></a>00392     <span class="keywordflow">return</span> dn;
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 <span class="comment">/*@=boundsread@*/</span>
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="fsm_8c.html#3d7e1301915e79d5eccf84be83adfc79">00396</a> <span class="keyword">static</span> <span class="keywordtype">void</span> * <a class="code" href="fsm_8c.html#3d7e1301915e79d5eccf84be83adfc79">fsmThread</a>(<span class="keywordtype">void</span> * arg)
<a name="l00397"></a>00397         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00398"></a>00398         <span class="comment">/*@modifies arg, fileSystem, internalState @*/</span>
<a name="l00399"></a>00399 {
<a name="l00400"></a>00400     <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm = arg;
<a name="l00401"></a>00401 <span class="comment">/*@-unqualifiedtrans@*/</span>
<a name="l00402"></a>00402     <span class="keywordflow">return</span> ((<span class="keywordtype">void</span> *) <a class="code" href="fsm_8c.html#ad84b5d64310b6ed28dcd49746a2506f" title="File state machine driver.">fsmStage</a>(fsm, fsm-&gt;<a class="code" href="structfsm__s.html#8210f9d566805b7891bc5331463fe6e4">nstage</a>));
<a name="l00403"></a>00403 <span class="comment">/*@=unqualifiedtrans@*/</span>
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00406"></a><a class="code" href="fsm_8h.html#5cd1965aa3d5448685dfc97fd6d183ff">00406</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm, <a class="code" href="fsm_8h.html#42d68171cc4a6c0495fae9cddb9066d5">fileStage</a> nstage)
<a name="l00407"></a>00407         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00408"></a>00408         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l00409"></a>00409 {
<a name="l00410"></a>00410     fsm-&gt;<a class="code" href="structfsm__s.html#8210f9d566805b7891bc5331463fe6e4">nstage</a> = nstage;
<a name="l00411"></a>00411     <span class="keywordflow">if</span> (<a class="code" href="fsm_8c.html#bd2f72dd5fff0183f3a3392c943ed9c3">_fsm_threads</a>)
<a name="l00412"></a>00412         <span class="keywordflow">return</span> <a class="code" href="rpmsq_8c.html#75a46086c1b03bdc42ec058aeac2840d" title="Wait for thread to terminate.">rpmsqJoin</a>( <a class="code" href="rpmsq_8c.html#144095ad8653fc52152e44ff91585c99" title="Call a function in a thread.">rpmsqThread</a>(<a class="code" href="fsm_8c.html#3d7e1301915e79d5eccf84be83adfc79">fsmThread</a>, fsm) );
<a name="l00413"></a>00413     <span class="keywordflow">return</span> <a class="code" href="fsm_8c.html#ad84b5d64310b6ed28dcd49746a2506f" title="File state machine driver.">fsmStage</a>(fsm, fsm-&gt;<a class="code" href="structfsm__s.html#8210f9d566805b7891bc5331463fe6e4">nstage</a>);
<a name="l00414"></a>00414 }
<a name="l00415"></a>00415 
<a name="l00421"></a>00421 <span class="comment">/*@-boundsread@*/</span>
<a name="l00422"></a><a class="code" href="group__payload.html#gb91f1cf1a421c6c9c565ec9a4f45b658">00422</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#gb91f1cf1a421c6c9c565ec9a4f45b658" title="Save hard link in chain.">saveHardLink</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00423"></a>00423         <span class="comment">/*@uses fsm-&gt;links, fsm-&gt;ix, fsm-&gt;sb, fsm-&gt;goal, fsm-&gt;nsuffix @*/</span>
<a name="l00424"></a>00424         <span class="comment">/*@defines fsm-&gt;li @*/</span>
<a name="l00425"></a>00425         <span class="comment">/*@releases fsm-&gt;path @*/</span>
<a name="l00426"></a>00426         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00427"></a>00427         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l00428"></a>00428 {
<a name="l00429"></a>00429     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l00430"></a>00430     <span class="keywordtype">int</span> rc = 0;
<a name="l00431"></a>00431     <span class="keywordtype">int</span> ix = -1;
<a name="l00432"></a>00432     <span class="keywordtype">int</span> j;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     <span class="comment">/* Find hard link set. */</span>
<a name="l00435"></a>00435     <span class="comment">/*@-branchstate@*/</span>
<a name="l00436"></a>00436     <span class="keywordflow">for</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>) {
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a>.st_ino == st-&gt;st_ino &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a>.st_dev == st-&gt;st_dev)
<a name="l00438"></a>00438             <span class="keywordflow">break</span>;
<a name="l00439"></a>00439     }
<a name="l00440"></a>00440     <span class="comment">/*@=branchstate@*/</span>
<a name="l00441"></a>00441 
<a name="l00442"></a>00442     <span class="comment">/* New hard link encountered, add new link to set. */</span>
<a name="l00443"></a>00443 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00444"></a>00444     <span class="comment">/*@-branchstate@*/</span>
<a name="l00445"></a>00445     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> == NULL) {
<a name="l00446"></a>00446         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>));
<a name="l00447"></a>00447         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = NULL;
<a name="l00448"></a>00448         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a> = *st;      <span class="comment">/* structure assignment */</span>
<a name="l00449"></a>00449         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#92ac50d8eb3f05209d1000c9ab92b868">nlink</a> = st-&gt;st_nlink;
<a name="l00450"></a>00450         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#c5e41b006a6a3b4effea6f17fdf2e790">linkIndex</a> = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l00451"></a>00451         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#8e26ef91a7b84a55308456007f54dcb9">createdPath</a> = -1;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a> = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(st-&gt;st_nlink, <span class="keyword">sizeof</span>(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[0]));
<a name="l00454"></a>00454         memset(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>, -1, (st-&gt;st_nlink * <span class="keyword">sizeof</span>(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[0])));
<a name="l00455"></a>00455         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#0d827aa0091cb2d5d5d9c636a8ab5509">nsuffix</a> = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(st-&gt;st_nlink, <span class="keyword">sizeof</span>(*fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#0d827aa0091cb2d5d5d9c636a8ab5509">nsuffix</a>));
<a name="l00456"></a>00456 
<a name="l00457"></a>00457         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>)
<a name="l00458"></a>00458             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a> = st-&gt;st_nlink;
<a name="l00459"></a>00459         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l00460"></a>00460             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a> = 0;
<a name="l00461"></a>00461 
<a name="l00462"></a>00462         <span class="comment">/*@-kepttrans@*/</span>
<a name="l00463"></a>00463         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>;
<a name="l00464"></a>00464         <span class="comment">/*@=kepttrans@*/</span>
<a name="l00465"></a>00465         fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>;
<a name="l00466"></a>00466     }
<a name="l00467"></a>00467     <span class="comment">/*@=branchstate@*/</span>
<a name="l00468"></a>00468 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00469"></a>00469 
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>) --fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>;
<a name="l00471"></a>00471 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00472"></a>00472     fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>] = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l00473"></a>00473     <span class="comment">/*@-observertrans -dependenttrans@*/</span>
<a name="l00474"></a>00474     fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#0d827aa0091cb2d5d5d9c636a8ab5509">nsuffix</a>[fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>] = fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>;
<a name="l00475"></a>00475     <span class="comment">/*@=observertrans =dependenttrans@*/</span>
<a name="l00476"></a>00476 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>++;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>)
<a name="l00480"></a>00480         <span class="keywordflow">return</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a> &gt; 0);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> != <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l00483"></a>00483         <span class="keywordflow">return</span> 0;
<a name="l00484"></a>00484 
<a name="l00485"></a>00485     <span class="keywordflow">if</span> (!(st-&gt;st_size || fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a> == st-&gt;st_nlink))
<a name="l00486"></a>00486         <span class="keywordflow">return</span> 1;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488     <span class="comment">/* Here come the bits, time to choose a non-skipped file name. */</span>
<a name="l00489"></a>00489     {   <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491         <span class="keywordflow">for</span> (j = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a> - 1; j &gt;= 0; j--) {
<a name="l00492"></a>00492             ix = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[j];
<a name="l00493"></a>00493             <span class="keywordflow">if</span> (ix &lt; 0 || <a class="code" href="rpmlib_8h.html#2ed895afbe3c80bdfb7275869c487104">XFA_SKIPPING</a>(fi-&gt;actions[ix]))
<a name="l00494"></a>00494                 <span class="keywordflow">continue</span>;
<a name="l00495"></a>00495             <span class="keywordflow">break</span>;
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="comment">/* Are all links skipped or not encountered yet? */</span>
<a name="l00500"></a>00500     <span class="keywordflow">if</span> (ix &lt; 0 || j &lt; 0)
<a name="l00501"></a>00501         <span class="keywordflow">return</span> 1;       <span class="comment">/* XXX W2DO? */</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503     <span class="comment">/* Save the non-skipped file name and map index. */</span>
<a name="l00504"></a>00504     fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#c5e41b006a6a3b4effea6f17fdf2e790">linkIndex</a> = j;
<a name="l00505"></a>00505     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l00506"></a>00506     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = ix;
<a name="l00507"></a>00507     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>);
<a name="l00508"></a>00508     <span class="keywordflow">return</span> rc;
<a name="l00509"></a>00509 }
<a name="l00510"></a>00510 <span class="comment">/*@=boundsread@*/</span>
<a name="l00511"></a>00511 
<a name="l00517"></a><a class="code" href="group__payload.html#g9ab8b32638e9b9bce798ff8a8cdb100f">00517</a> <span class="keyword">static</span> <span class="comment">/*@null@*/</span> <span class="keywordtype">void</span> * <a class="code" href="group__payload.html#g9ab8b32638e9b9bce798ff8a8cdb100f" title="Destroy set of hard links.">freeHardLink</a>(<span class="comment">/*@only@*/</span> <span class="comment">/*@null@*/</span> <span class="keyword">struct</span> <a class="code" href="structhardLink__s.html" title="Keeps track of the set of all hard links to a file in an archive.">hardLink_s</a> * li)
<a name="l00518"></a>00518         <span class="comment">/*@modifies li @*/</span>
<a name="l00519"></a>00519 {
<a name="l00520"></a>00520     <span class="keywordflow">if</span> (li) {
<a name="l00521"></a>00521         li-&gt;<a class="code" href="structhardLink__s.html#0d827aa0091cb2d5d5d9c636a8ab5509">nsuffix</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(li-&gt;<a class="code" href="structhardLink__s.html#0d827aa0091cb2d5d5d9c636a8ab5509">nsuffix</a>);       <span class="comment">/* XXX elements are shared */</span>
<a name="l00522"></a>00522         li-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(li-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>);
<a name="l00523"></a>00523     }
<a name="l00524"></a>00524     <span class="keywordflow">return</span> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(li);
<a name="l00525"></a>00525 }
<a name="l00526"></a>00526 
<a name="l00527"></a><a class="code" href="fsm_8h.html#77f09b9b5a7d08b3e85caf7d201fa843">00527</a> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> <a class="code" href="fsm_8c.html#77f09b9b5a7d08b3e85caf7d201fa843" title="Create file state machine instance.">newFSM</a>(<span class="keywordtype">void</span>)
<a name="l00528"></a>00528 {
<a name="l00529"></a>00529     <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm = <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(1, <span class="keyword">sizeof</span>(*fsm));
<a name="l00530"></a>00530     <span class="keywordflow">return</span> fsm;
<a name="l00531"></a>00531 }
<a name="l00532"></a>00532 
<a name="l00533"></a><a class="code" href="fsm_8h.html#08c4a7eb02d4f91e545f90d070d4104c">00533</a> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> <a class="code" href="fsm_8c.html#08c4a7eb02d4f91e545f90d070d4104c" title="Destroy file state machine instance.">freeFSM</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00534"></a>00534 {
<a name="l00535"></a>00535     <span class="keywordflow">if</span> (fsm) {
<a name="l00536"></a>00536         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l00537"></a>00537         <span class="comment">/*@-branchstate@*/</span>
<a name="l00538"></a>00538         <span class="keywordflow">while</span> ((fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>) != NULL) {
<a name="l00539"></a>00539             fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>;
<a name="l00540"></a>00540             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = NULL;
<a name="l00541"></a>00541             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = <a class="code" href="group__payload.html#g9ab8b32638e9b9bce798ff8a8cdb100f" title="Destroy set of hard links.">freeHardLink</a>(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>);
<a name="l00542"></a>00542         }
<a name="l00543"></a>00543         <span class="comment">/*@=branchstate@*/</span>
<a name="l00544"></a>00544         fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>);
<a name="l00545"></a>00545         fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>);
<a name="l00546"></a>00546         fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a> = <a class="code" href="group__payload.html#g1fd05286dfa9848e8c26c25764623e8f" title="Destroy file info iterator.">mapFreeIterator</a>(fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a>);
<a name="l00547"></a>00547     }
<a name="l00548"></a>00548     <span class="keywordflow">return</span> <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm);
<a name="l00549"></a>00549 }
<a name="l00550"></a>00550 
<a name="l00551"></a><a class="code" href="fsm_8h.html#6e6fb0ed805d1c2d07ede70f4947dcef">00551</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#6e6fb0ed805d1c2d07ede70f4947dcef" title="Load external data into file state machine.">fsmSetup</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm, <a class="code" href="fsm_8h.html#42d68171cc4a6c0495fae9cddb9066d5">fileStage</a> goal,
<a name="l00552"></a>00552                 <span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts, <span class="keyword">const</span> <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi, <a class="code" href="struct__FD__s.html" title="The FD_t File Handle data structure.">FD_t</a> cfd,
<a name="l00553"></a>00553                 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> * archiveSize, <span class="keyword">const</span> <span class="keywordtype">char</span> ** failedFile)
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555     <span class="keywordtype">size_t</span> pos = 0;
<a name="l00556"></a>00556     <span class="keywordtype">int</span> rc, ec = 0;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558     fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> = goal;
<a name="l00559"></a>00559     <span class="keywordflow">if</span> (cfd != NULL) {
<a name="l00560"></a>00560         fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a> = <a class="code" href="rpmio_8h.html#f173e51590aa10ebc734ae14235030b4">fdLink</a>(cfd, <span class="stringliteral">"persist (fsm)"</span>);
<a name="l00561"></a>00561         pos = <a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a>);
<a name="l00562"></a>00562         <a class="code" href="group__rpmio.html#g4f690c6f8e8816af70283a7eec02b7f5">fdSetCpioPos</a>(fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a>, 0);
<a name="l00563"></a>00563     }
<a name="l00564"></a>00564     fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a> = <a class="code" href="group__payload.html#ge8aa1c0ca3352e8c71c816c9b9684971" title="Create file info iterator.">mapInitIterator</a>(ts, fi);
<a name="l00565"></a>00565 
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> || fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>) {
<a name="l00567"></a>00567         <span class="keywordtype">void</span> * ptr;
<a name="l00568"></a>00568         fi-&gt;archivePos = 0;
<a name="l00569"></a>00569         ptr = <a class="code" href="rpmts_8c.html#ed33324d0c6a4d1d6c3961caf112ee0c" title="Perform transaction progress notify callback.">rpmtsNotify</a>(ts, fi-&gt;te,
<a name="l00570"></a>00570                 <a class="code" href="rpmmessages_8h.html#ee1ee0900a6f9abe699d626b5490c4e33f201cd9b127544dee550d47353b8680">RPMCALLBACK_INST_START</a>, fi-&gt;archivePos, fi-&gt;archiveSize);
<a name="l00571"></a>00571     }
<a name="l00572"></a>00572 
<a name="l00573"></a>00573 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00574"></a>00574     <span class="comment">/*@-assignexpose@*/</span>
<a name="l00575"></a>00575     fsm-&gt;<a class="code" href="structfsm__s.html#9c526c3c81b2576efa21d017d2a15811">archiveSize</a> = archiveSize;
<a name="l00576"></a>00576     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#9c526c3c81b2576efa21d017d2a15811">archiveSize</a>)
<a name="l00577"></a>00577         *fsm-&gt;<a class="code" href="structfsm__s.html#9c526c3c81b2576efa21d017d2a15811">archiveSize</a> = 0;
<a name="l00578"></a>00578     fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = failedFile;
<a name="l00579"></a>00579     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a>)
<a name="l00580"></a>00580         *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = NULL;
<a name="l00581"></a>00581     <span class="comment">/*@=assignexpose@*/</span>
<a name="l00582"></a>00582 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     memset(fsm-&gt;<a class="code" href="structfsm__s.html#19740d94560dc4b38c782d8246a3c832">sufbuf</a>, 0, <span class="keyword">sizeof</span>(fsm-&gt;<a class="code" href="structfsm__s.html#19740d94560dc4b38c782d8246a3c832">sufbuf</a>));
<a name="l00585"></a>00585     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) {
<a name="l00586"></a>00586         <span class="keywordflow">if</span> (ts &amp;&amp; <a class="code" href="group__rpmts.html#gf19c61737f0749e64537d68f9ac0ed1b" title="Get transaction id, i.e.">rpmtsGetTid</a>(ts) &gt; 0)
<a name="l00587"></a>00587             sprintf(fsm-&gt;<a class="code" href="structfsm__s.html#19740d94560dc4b38c782d8246a3c832">sufbuf</a>, <span class="stringliteral">";%08x"</span>, (<span class="keywordtype">unsigned</span>)<a class="code" href="group__rpmts.html#gf19c61737f0749e64537d68f9ac0ed1b" title="Get transaction id, i.e.">rpmtsGetTid</a>(ts));
<a name="l00588"></a>00588     }
<a name="l00589"></a>00589 
<a name="l00590"></a>00590     ec = fsm-&gt;<a class="code" href="structfsm__s.html#939f7c265139079eee800d47014b05c3">rc</a> = 0;
<a name="l00591"></a>00591     rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526995a48127c97a657880f596f22570a2">FSM_CREATE</a>);
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (rc &amp;&amp; !ec) ec = rc;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594     rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a>);
<a name="l00595"></a>00595     <span class="keywordflow">if</span> (rc &amp;&amp; !ec) ec = rc;
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00598"></a>00598     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#9c526c3c81b2576efa21d017d2a15811">archiveSize</a> &amp;&amp; ec == 0)
<a name="l00599"></a>00599         *fsm-&gt;<a class="code" href="structfsm__s.html#9c526c3c81b2576efa21d017d2a15811">archiveSize</a> = (<a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a>) - pos);
<a name="l00600"></a>00600 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00601"></a>00601 
<a name="l00602"></a>00602 <span class="comment">/*@-nullstate@*/</span> <span class="comment">/* FIX: *fsm-&gt;failedFile may be NULL */</span>
<a name="l00603"></a>00603    <span class="keywordflow">return</span> ec;
<a name="l00604"></a>00604 <span class="comment">/*@=nullstate@*/</span>
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a><a class="code" href="fsm_8h.html#0c1d23991daeaa4b7adddf3901cc6f01">00607</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#0c1d23991daeaa4b7adddf3901cc6f01" title="Clean file state machine.">fsmTeardown</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609     <span class="keywordtype">int</span> rc = fsm-&gt;<a class="code" href="structfsm__s.html#939f7c265139079eee800d47014b05c3">rc</a>;
<a name="l00610"></a>00610 
<a name="l00611"></a>00611     <span class="keywordflow">if</span> (!rc)
<a name="l00612"></a>00612         rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45241ef66ff78867ee0e0bab88c2d973294">FSM_DESTROY</a>);
<a name="l00613"></a>00613 
<a name="l00614"></a>00614     fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a> = <a class="code" href="group__payload.html#g1fd05286dfa9848e8c26c25764623e8f" title="Destroy file info iterator.">mapFreeIterator</a>(fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a>);
<a name="l00615"></a>00615     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a> != NULL) {
<a name="l00616"></a>00616         fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a> = <a class="code" href="rpmio_8h.html#76489f7094b08cf307e44d4f2f770cc7">fdFree</a>(fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a>, <span class="stringliteral">"persist (fsm)"</span>);
<a name="l00617"></a>00617         fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a> = NULL;
<a name="l00618"></a>00618     }
<a name="l00619"></a>00619     fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = NULL;
<a name="l00620"></a>00620     <span class="keywordflow">return</span> rc;
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a><a class="code" href="fsm_8c.html#cc6456db2a1c0155226b18fe0d343079">00623</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#cc6456db2a1c0155226b18fe0d343079">fsmMapFContext</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00624"></a>00624         <span class="comment">/*@modifies fsm @*/</span>
<a name="l00625"></a>00625 {
<a name="l00626"></a>00626     <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm);
<a name="l00627"></a>00627     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l00628"></a>00628     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     <span class="comment">/*</span>
<a name="l00631"></a>00631 <span class="comment">     * Find file security context (if not disabled).</span>
<a name="l00632"></a>00632 <span class="comment">     */</span>
<a name="l00633"></a>00633     fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> = NULL;
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (ts != NULL &amp;&amp; <a class="code" href="group__rpmts.html#g2e0f222f70e2e2017f8d6c37de090957" title="Get selinuxEnabled flag, i.e.">rpmtsSELinuxEnabled</a>(ts) == 1 &amp;&amp;
<a name="l00635"></a>00635         !(<a class="code" href="group__rpmts.html#g4e8995f22601eb9d5d3e264fa005e167" title="Get transaction flags, i.e.">rpmtsFlags</a>(ts) &amp; <a class="code" href="rpmlib_8h.html#451385c9472c6ccc583867853442e2ef1bffb895a3de9927dc70d9e48aaf5d1e">RPMTRANS_FLAG_NOCONTEXTS</a>))
<a name="l00636"></a>00636     {
<a name="l00637"></a>00637         <a class="code" href="system_8h.html#7cb29f84b9b9b1042bb9d0de949f888b">security_context_t</a> scon = NULL;
<a name="l00638"></a>00638 
<a name="l00639"></a>00639         <span class="keywordflow">if</span> ( matchpathcon(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, st-&gt;st_mode, &amp;scon) == 0 &amp;&amp; scon != NULL) {
<a name="l00640"></a>00640             <span class="comment">/* Get file security context from patterns. */</span>
<a name="l00641"></a>00641             fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> = scon;
<a name="l00642"></a>00642         } <span class="keywordflow">else</span> {
<a name="l00643"></a>00643             <span class="keywordtype">int</span> i = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645             <span class="comment">/* Get file security context from package. */</span>
<a name="l00646"></a>00646             <span class="keywordflow">if</span> (fi &amp;&amp; i &gt;= 0 &amp;&amp; i &lt; fi-&gt;fc)
<a name="l00647"></a>00647                 fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> = (fi-&gt;fcontexts ? fi-&gt;fcontexts[i] : NULL);
<a name="l00648"></a>00648         }
<a name="l00649"></a>00649     }
<a name="l00650"></a>00650     <span class="keywordflow">return</span> 0;
<a name="l00651"></a>00651 }
<a name="l00652"></a>00652 
<a name="l00653"></a><a class="code" href="fsm_8h.html#b5ec0917e40a7ef6bf78edc5ffdde5bd">00653</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#b5ec0917e40a7ef6bf78edc5ffdde5bd" title="Map next file path and action.">fsmMapPath</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00654"></a>00654 {
<a name="l00655"></a>00655     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);   <span class="comment">/* XXX const except for fstates */</span>
<a name="l00656"></a>00656     <span class="keywordtype">int</span> rc = 0;
<a name="l00657"></a>00657     <span class="keywordtype">int</span> i;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a> = NULL;
<a name="l00660"></a>00660     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = NULL;
<a name="l00661"></a>00661     fsm-&gt;<a class="code" href="structfsm__s.html#d213d00dd62b29f9c96e34c26c2a5c5c">astriplen</a> = 0;
<a name="l00662"></a>00662     fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a> = <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9921def1a5a9da9556fbaa0120e3e18c3">FA_UNKNOWN</a>;
<a name="l00663"></a>00663     fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> = 0;
<a name="l00664"></a>00664 
<a name="l00665"></a>00665     i = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l00666"></a>00666     <span class="keywordflow">if</span> (fi &amp;&amp; i &gt;= 0 &amp;&amp; i &lt; fi-&gt;fc) {
<a name="l00667"></a>00667 
<a name="l00668"></a>00668 <span class="comment">/*@-boundsread@*/</span>
<a name="l00669"></a>00669         fsm-&gt;<a class="code" href="structfsm__s.html#d213d00dd62b29f9c96e34c26c2a5c5c">astriplen</a> = fi-&gt;astriplen;
<a name="l00670"></a>00670         fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a> = (fi-&gt;actions ? fi-&gt;actions[i] : fi-&gt;action);
<a name="l00671"></a>00671         fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> = (fi-&gt;fflags ? fi-&gt;fflags[i] : fi-&gt;flags);
<a name="l00672"></a>00672         fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> = (fi-&gt;fmapflags ? fi-&gt;fmapflags[i] : fi-&gt;mapflags);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674         <span class="comment">/* src rpms have simple base name in payload. */</span>
<a name="l00675"></a>00675         fsm-&gt;<a class="code" href="structfsm__s.html#311bd72c333f118e811508411ac483cb">dirName</a> = fi-&gt;dnl[fi-&gt;dil[i]];
<a name="l00676"></a>00676         fsm-&gt;<a class="code" href="structfsm__s.html#5e07c45abe2d972bd5b9a3e43838af7e">baseName</a> = fi-&gt;bnl[i];
<a name="l00677"></a>00677 <span class="comment">/*@=boundsread@*/</span>
<a name="l00678"></a>00678 
<a name="l00679"></a>00679 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00680"></a>00680         <span class="keywordflow">switch</span> (fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a>) {
<a name="l00681"></a>00681         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef919269a620de20c363e810c731325846a">FA_SKIP</a>:
<a name="l00682"></a>00682             <span class="keywordflow">break</span>;
<a name="l00683"></a>00683         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9921def1a5a9da9556fbaa0120e3e18c3">FA_UNKNOWN</a>:
<a name="l00684"></a>00684             <span class="keywordflow">break</span>;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef957be9542b973695e13c1733094d77ba8">FA_COPYOUT</a>:
<a name="l00687"></a>00687             <span class="keywordflow">break</span>;
<a name="l00688"></a>00688         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9219135e7b158ab710ed01f0bb9e19888">FA_COPYIN</a>:
<a name="l00689"></a>00689         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef947c55521a08d7eed68cbb9b1406334ca">FA_CREATE</a>:
<a name="l00690"></a>00690 assert(<a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>);
<a name="l00691"></a>00691             <span class="keywordflow">break</span>;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9a3882a6b11b46e69c2d19d171e65170f">FA_SKIPNSTATE</a>:
<a name="l00694"></a>00694             <span class="keywordflow">if</span> (fi-&gt;fstates &amp;&amp; <a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>)
<a name="l00695"></a>00695                 fi-&gt;fstates[i] = <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d44422dd88bd354fa1c6935ef40a667693a2dd">RPMFILE_STATE_NOTINSTALLED</a>;
<a name="l00696"></a>00696             <span class="keywordflow">break</span>;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9d6f66a763673c78d1f0737381b923772">FA_SKIPNETSHARED</a>:
<a name="l00699"></a>00699             <span class="keywordflow">if</span> (fi-&gt;fstates &amp;&amp; <a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>)
<a name="l00700"></a>00700                 fi-&gt;fstates[i] = <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d44422280430234e88d5ffff1c452c5ba1fccb">RPMFILE_STATE_NETSHARED</a>;
<a name="l00701"></a>00701             <span class="keywordflow">break</span>;
<a name="l00702"></a>00702 
<a name="l00703"></a>00703         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9cc0c5b0b6d9872ea87b8b3b8c035c373">FA_SKIPCOLOR</a>:
<a name="l00704"></a>00704             <span class="keywordflow">if</span> (fi-&gt;fstates &amp;&amp; <a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>)
<a name="l00705"></a>00705                 fi-&gt;fstates[i] = <a class="code" href="rpmlib_8h.html#56e4ff0190c16071b121849ab9d444220dfc8bec92232f3092959fed108b177c">RPMFILE_STATE_WRONGCOLOR</a>;
<a name="l00706"></a>00706             <span class="keywordflow">break</span>;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9ed9be5c788aa54c9b5ce47780865d06f">FA_BACKUP</a>:
<a name="l00709"></a>00709             <span class="keywordflow">if</span> (!(fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>)) <span class="comment">/* XXX Don't if %ghost file. */</span>
<a name="l00710"></a>00710             <span class="keywordflow">switch</span> (<a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te)) {
<a name="l00711"></a>00711             <span class="keywordflow">case</span> <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>:
<a name="l00712"></a>00712                 fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a> = <a class="code" href="fsm_8c.html#e3f9813e414018874da312f62dba6abf">SUFFIX_RPMORIG</a>;
<a name="l00713"></a>00713                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00714"></a>00714             <span class="keywordflow">case</span> <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e20429d7556bc1510e6d739288ab336dd0157">TR_REMOVED</a>:
<a name="l00715"></a>00715                 fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a> = <a class="code" href="fsm_8c.html#5d20ad06b1b5013d721500a60c3f7a5f">SUFFIX_RPMSAVE</a>;
<a name="l00716"></a>00716                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l00717"></a>00717             }
<a name="l00718"></a>00718             <span class="keywordflow">break</span>;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9084a19c84c61532dc3c8135f8877ebd6">FA_ALTNAME</a>:
<a name="l00721"></a>00721 assert(<a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>);
<a name="l00722"></a>00722             <span class="keywordflow">if</span> (!(fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>)) <span class="comment">/* XXX Don't if %ghost file. */</span>
<a name="l00723"></a>00723                 fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = <a class="code" href="fsm_8c.html#b3bef1d63c9c102d9f0502d967228e62">SUFFIX_RPMNEW</a>;
<a name="l00724"></a>00724             <span class="keywordflow">break</span>;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9ade30ac387d38766fe8b7a62617df7e1">FA_SAVE</a>:
<a name="l00727"></a>00727 assert(<a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e204284f6f5a295233289a8cc2aba9700e349">TR_ADDED</a>);
<a name="l00728"></a>00728             <span class="keywordflow">if</span> (!(fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>)) <span class="comment">/* XXX Don't if %ghost file. */</span>
<a name="l00729"></a>00729                 fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a> = <a class="code" href="fsm_8c.html#5d20ad06b1b5013d721500a60c3f7a5f">SUFFIX_RPMSAVE</a>;
<a name="l00730"></a>00730             <span class="keywordflow">break</span>;
<a name="l00731"></a>00731         <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef96d7eb8b200bfb8a40319085ee6cda356">FA_ERASE</a>:
<a name="l00732"></a>00732 <span class="preprocessor">#if 0   </span><span class="comment">/* XXX is this a genhdlist fix? */</span>
<a name="l00733"></a>00733             assert(<a class="code" href="rpmte_8c.html#c9fdf47ba1602814a0f82d7da9e7aff4" title="Retrieve type of transaction element.">rpmteType</a>(fi-&gt;te) == <a class="code" href="group__rpmte.html#ggc0ffa29a3b387b1bcbc8a8c6cf6e20429d7556bc1510e6d739288ab336dd0157">TR_REMOVED</a>);
<a name="l00734"></a>00734 <span class="preprocessor">#endif</span>
<a name="l00735"></a>00735 <span class="preprocessor"></span>            <span class="comment">/*</span>
<a name="l00736"></a>00736 <span class="comment">             * XXX TODO: %ghost probably shouldn't be removed, but that changes</span>
<a name="l00737"></a>00737 <span class="comment">             * legacy rpm behavior.</span>
<a name="l00738"></a>00738 <span class="comment">             */</span>
<a name="l00739"></a>00739             <span class="keywordflow">break</span>;
<a name="l00740"></a>00740         <span class="keywordflow">default</span>:
<a name="l00741"></a>00741             <span class="keywordflow">break</span>;
<a name="l00742"></a>00742         }
<a name="l00743"></a>00743 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         <span class="keywordflow">if</span> ((fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f469671e9f4719f9a298252f908f72c707">CPIO_MAP_PATH</a>) || fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>) {
<a name="l00746"></a>00746             <span class="keyword">const</span> <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l00747"></a>00747             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l00748"></a>00748             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, fsm-&gt;<a class="code" href="structfsm__s.html#38c9ded5d4c71f23d5752dfdb658c57c">subdir</a>,
<a name="l00749"></a>00749                 (fsm-&gt;<a class="code" href="structfsm__s.html#bdc06f0fea77931224a320be06315c3c">suffix</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#bdc06f0fea77931224a320be06315c3c">suffix</a> : fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>));
<a name="l00750"></a>00750         }
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752     <span class="keywordflow">return</span> rc;
<a name="l00753"></a>00753 }
<a name="l00754"></a>00754 
<a name="l00755"></a><a class="code" href="fsm_8h.html#224238bdc8ab4145c31943f6ddf2e3fb">00755</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#224238bdc8ab4145c31943f6ddf2e3fb" title="Map file stat(2) info.">fsmMapAttrs</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00756"></a>00756 {
<a name="l00757"></a>00757     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l00758"></a>00758     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l00759"></a>00759     <span class="keywordtype">int</span> i = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761     <span class="keywordflow">if</span> (fi &amp;&amp; i &gt;= 0 &amp;&amp; i &lt; fi-&gt;fc) {
<a name="l00762"></a>00762         mode_t perms = (S_ISDIR(st-&gt;st_mode) ? fi-&gt;dperms : fi-&gt;fperms);
<a name="l00763"></a>00763         mode_t finalMode = (fi-&gt;fmodes ? fi-&gt;fmodes[i] : perms);
<a name="l00764"></a>00764         dev_t finalRdev = (fi-&gt;frdevs ? fi-&gt;frdevs[i] : 0);
<a name="l00765"></a>00765         <a class="code" href="header_8h.html#ec881c85645bc01204441cbc24e9c025">int_32</a> finalMtime = (fi-&gt;fmtimes ? fi-&gt;fmtimes[i] : 0);
<a name="l00766"></a>00766         uid_t uid = fi-&gt;uid;
<a name="l00767"></a>00767         gid_t gid = fi-&gt;gid;
<a name="l00768"></a>00768 
<a name="l00769"></a>00769         <span class="keywordflow">if</span> (fi-&gt;fuser &amp;&amp; <a class="code" href="ugid_8c.html#bdb9a08d2fd59ad1111b63eb06e47d9f">unameToUid</a>(fi-&gt;fuser[i], &amp;uid)) {
<a name="l00770"></a>00770             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l00771"></a>00771                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#0429b81ac9dd6a698b6da81be7e9a0b3">RPMMESS_WARNING</a>,
<a name="l00772"></a>00772                     <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"user %s does not exist - using root\n"</span>), fi-&gt;fuser[i]);
<a name="l00773"></a>00773             uid = 0;
<a name="l00774"></a>00774             finalMode &amp;= ~S_ISUID;      <span class="comment">/* turn off suid bit */</span>
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         <span class="keywordflow">if</span> (fi-&gt;fgroup &amp;&amp; <a class="code" href="ugid_8c.html#efffaa74d358318ffd2d46ba60ed0c1b">gnameToGid</a>(fi-&gt;fgroup[i], &amp;gid)) {
<a name="l00778"></a>00778             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l00779"></a>00779                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#0429b81ac9dd6a698b6da81be7e9a0b3">RPMMESS_WARNING</a>,
<a name="l00780"></a>00780                     <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"group %s does not exist - using root\n"</span>), fi-&gt;fgroup[i]);
<a name="l00781"></a>00781             gid = 0;
<a name="l00782"></a>00782             finalMode &amp;= ~S_ISGID;      <span class="comment">/* turn off sgid bit */</span>
<a name="l00783"></a>00783         }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4ce662854a351978b15e7d49c46d5dc94">CPIO_MAP_MODE</a>)
<a name="l00786"></a>00786             st-&gt;st_mode = (st-&gt;st_mode &amp; S_IFMT) | (finalMode &amp; ~S_IFMT);
<a name="l00787"></a>00787         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f402fe0a87ce23ecf3251585ba2fff8ffd">CPIO_MAP_TYPE</a>) {
<a name="l00788"></a>00788             st-&gt;st_mode = (st-&gt;st_mode &amp; ~S_IFMT) | (finalMode &amp; S_IFMT);
<a name="l00789"></a>00789             <span class="keywordflow">if</span> ((S_ISCHR(st-&gt;st_mode) || S_ISBLK(st-&gt;st_mode))
<a name="l00790"></a>00790             &amp;&amp; st-&gt;st_nlink == 0)
<a name="l00791"></a>00791                 st-&gt;st_nlink = 1;
<a name="l00792"></a>00792             st-&gt;st_rdev = finalRdev;
<a name="l00793"></a>00793             st-&gt;st_mtime = finalMtime;
<a name="l00794"></a>00794         }
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f40a3c9b3aabf789894e5688520eea87e2">CPIO_MAP_UID</a>)
<a name="l00796"></a>00796             st-&gt;st_uid = uid;
<a name="l00797"></a>00797         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4d841effb2ead0ec888b53cfbca31f692">CPIO_MAP_GID</a>)
<a name="l00798"></a>00798             st-&gt;st_gid = gid;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         {   <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802             <span class="comment">/*</span>
<a name="l00803"></a>00803 <span class="comment">             * Set file md5 (if not disabled).</span>
<a name="l00804"></a>00804 <span class="comment">             */</span>
<a name="l00805"></a>00805             <span class="keywordflow">if</span> (ts != NULL &amp;&amp; !(<a class="code" href="group__rpmts.html#g4e8995f22601eb9d5d3e264fa005e167" title="Get transaction flags, i.e.">rpmtsFlags</a>(ts) &amp; <a class="code" href="rpmlib_8h.html#451385c9472c6ccc583867853442e2ef383755f9efb4d8d08f56a57ad9644072">RPMTRANS_FLAG_NOMD5</a>)) {
<a name="l00806"></a>00806                 fsm-&gt;<a class="code" href="structfsm__s.html#51a5cdd341abd7081358db3cbcd5b6f4">fmd5sum</a> = (fi-&gt;fmd5s ? fi-&gt;fmd5s[i] : NULL);
<a name="l00807"></a>00807                 fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a> = (fi-&gt;md5s ? (fi-&gt;md5s + (16 * i)) : NULL);
<a name="l00808"></a>00808             } <span class="keywordflow">else</span> {
<a name="l00809"></a>00809                 fsm-&gt;<a class="code" href="structfsm__s.html#51a5cdd341abd7081358db3cbcd5b6f4">fmd5sum</a> = NULL;
<a name="l00810"></a>00810                 fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a> = NULL;
<a name="l00811"></a>00811             }
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814     }
<a name="l00815"></a>00815     <span class="keywordflow">return</span> 0;
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 
<a name="l00823"></a>00823 <span class="comment">/*@-compdef@*/</span>
<a name="l00824"></a><a class="code" href="group__payload.html#g3a1b3d636ff257e751ef5c5139ca29ca">00824</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#g3a1b3d636ff257e751ef5c5139ca29ca" title="Create file from payload stream.">expandRegular</a>(<span class="comment">/*@special@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l00825"></a>00825         <span class="comment">/*@uses fsm-&gt;fmd5sum, fsm-&gt;md5sum, fsm-&gt;sb, fsm-&gt;wfd  @*/</span>
<a name="l00826"></a>00826         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00827"></a>00827         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829     <span class="keyword">const</span> <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l00830"></a>00830     <span class="keywordtype">int</span> <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> = st-&gt;st_size;
<a name="l00831"></a>00831     <span class="keywordtype">int</span> rc = 0;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526ca0424d7c1da847f75997facbd00f76">FSM_WOPEN</a>);
<a name="l00834"></a>00834     <span class="keywordflow">if</span> (rc)
<a name="l00835"></a>00835         <span class="keywordflow">goto</span> exit;
<a name="l00836"></a>00836 
<a name="l00837"></a>00837     <span class="keywordflow">if</span> (st-&gt;st_size &gt; 0 &amp;&amp; (fsm-&gt;<a class="code" href="structfsm__s.html#51a5cdd341abd7081358db3cbcd5b6f4">fmd5sum</a> != NULL || fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a> != NULL))
<a name="l00838"></a>00838         <a class="code" href="group__rpmio.html#g507e26c37b2d2441527b979d6f02de23" title="Attach digest to fd.">fdInitDigest</a>(fsm-&gt;<a class="code" href="structfsm__s.html#de224bd5e027c9ca7ac750452050787d">wfd</a>, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d7e4badf8c607e5c6bd188cc1e48ac8619">PGPHASHALGO_MD5</a>, 0);
<a name="l00839"></a>00839 
<a name="l00840"></a>00840     <span class="keywordflow">while</span> (left) {
<a name="l00841"></a>00841 
<a name="l00842"></a>00842         fsm-&gt;<a class="code" href="structfsm__s.html#db95b796b713d812d21309d1ab93a089">wrlen</a> = (left &gt; fsm-&gt;<a class="code" href="structfsm__s.html#594282d7683026aaf732d781efd2de7a">wrsize</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#594282d7683026aaf732d781efd2de7a">wrsize</a> : left);
<a name="l00843"></a>00843         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fedb55217c2d9644549604f2d8f37ea1">FSM_DREAD</a>);
<a name="l00844"></a>00844         <span class="keywordflow">if</span> (rc)
<a name="l00845"></a>00845             <span class="keywordflow">goto</span> exit;
<a name="l00846"></a>00846 
<a name="l00847"></a>00847         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4529cd1eda1ad81aff279262dae2ef1b825">FSM_WRITE</a>);
<a name="l00848"></a>00848         <span class="keywordflow">if</span> (rc)
<a name="l00849"></a>00849             <span class="keywordflow">goto</span> exit;
<a name="l00850"></a>00850 
<a name="l00851"></a>00851         left -= fsm-&gt;<a class="code" href="structfsm__s.html#eba675bcb78b6e09124e63d66455e14e">wrnb</a>;
<a name="l00852"></a>00852 
<a name="l00853"></a>00853         <span class="comment">/* don't call this with fileSize == fileComplete */</span>
<a name="l00854"></a>00854         <span class="keywordflow">if</span> (!rc &amp;&amp; left)
<a name="l00855"></a>00855             (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fdc0a98795027a9a343cb8468c2074e6">FSM_NOTIFY</a>);
<a name="l00856"></a>00856     }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858     <span class="keywordflow">if</span> (st-&gt;st_size &gt; 0 &amp;&amp; (fsm-&gt;<a class="code" href="structfsm__s.html#51a5cdd341abd7081358db3cbcd5b6f4">fmd5sum</a> || fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a>)) {
<a name="l00859"></a>00859         <span class="keywordtype">void</span> * md5sum = NULL;
<a name="l00860"></a>00860         <span class="keywordtype">int</span> asAscii = (fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a> == NULL ? 1 : 0);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862         (void) <a class="code" href="rpmio_8c.html#151331b54e01d3b4ebe94382603ad609" title="fflush(3) clone.">Fflush</a>(fsm-&gt;<a class="code" href="structfsm__s.html#de224bd5e027c9ca7ac750452050787d">wfd</a>);
<a name="l00863"></a>00863         <a class="code" href="group__rpmio.html#g222eae57c03fb1e4ed9b32c6a1396b13">fdFiniDigest</a>(fsm-&gt;<a class="code" href="structfsm__s.html#de224bd5e027c9ca7ac750452050787d">wfd</a>, <a class="code" href="rpmpgp_8h.html#62b36a3001a9d3870d1fd637a9e355d7e4badf8c607e5c6bd188cc1e48ac8619">PGPHASHALGO_MD5</a>, &amp;md5sum, NULL, asAscii);
<a name="l00864"></a>00864 
<a name="l00865"></a>00865         <span class="keywordflow">if</span> (md5sum == NULL) {
<a name="l00866"></a>00866             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e4b0593b894a5c8df02f45c21e08a1e99">CPIOERR_MD5SUM_MISMATCH</a>;
<a name="l00867"></a>00867             <span class="keywordflow">goto</span> exit;
<a name="l00868"></a>00868         }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a> != NULL) {
<a name="l00871"></a>00871             <span class="keywordflow">if</span> (memcmp(md5sum, fsm-&gt;<a class="code" href="structfsm__s.html#300cfd9da74fbb660e0ec57e88ed4546">md5sum</a>, 16))
<a name="l00872"></a>00872                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e4b0593b894a5c8df02f45c21e08a1e99">CPIOERR_MD5SUM_MISMATCH</a>;
<a name="l00873"></a>00873         } <span class="keywordflow">else</span> {
<a name="l00874"></a>00874             <span class="keywordflow">if</span> (strcmp(md5sum, fsm-&gt;<a class="code" href="structfsm__s.html#51a5cdd341abd7081358db3cbcd5b6f4">fmd5sum</a>))
<a name="l00875"></a>00875                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e4b0593b894a5c8df02f45c21e08a1e99">CPIOERR_MD5SUM_MISMATCH</a>;
<a name="l00876"></a>00876         }
<a name="l00877"></a>00877         md5sum = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(md5sum);
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880 exit:
<a name="l00881"></a>00881     (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452eb1a99b2b31864c90f07457939bae1f1">FSM_WCLOSE</a>);
<a name="l00882"></a>00882     <span class="keywordflow">return</span> rc;
<a name="l00883"></a>00883 }
<a name="l00884"></a>00884 <span class="comment">/*@=compdef@*/</span>
<a name="l00885"></a>00885 
<a name="l00892"></a>00892 <span class="comment">/*@-compdef -compmempass@*/</span>
<a name="l00893"></a><a class="code" href="group__payload.html#gb228a1a0b6d1189f881ca1a0b0c87926">00893</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#gb228a1a0b6d1189f881ca1a0b0c87926" title="Write next item to payload stream.">writeFile</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm, <span class="keywordtype">int</span> writeData)
<a name="l00894"></a>00894         <span class="comment">/*@uses fsm-&gt;path, fsm-&gt;opath, fsm-&gt;sb, fsm-&gt;osb, fsm-&gt;cfd @*/</span>
<a name="l00895"></a>00895         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l00896"></a>00896         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l00897"></a>00897 {
<a name="l00898"></a>00898     <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l00899"></a>00899     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmtool_8c.html#388b138a2eef245efa264b879f68f826">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>;
<a name="l00900"></a>00900     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l00901"></a>00901     <span class="keyword">struct </span>stat * ost = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#83fece2a7d788502e4dd0baeec0c8cca">osb</a>;
<a name="l00902"></a>00902     <span class="keywordtype">char</span> * symbuf = NULL;
<a name="l00903"></a>00903     <span class="keywordtype">int</span> <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>;
<a name="l00904"></a>00904     <span class="keywordtype">int</span> xx;
<a name="l00905"></a>00905     <span class="keywordtype">int</span> rc;
<a name="l00906"></a>00906 
<a name="l00907"></a>00907     st-&gt;st_size = (writeData ? ost-&gt;st_size : 0);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909     <span class="comment">/*@-branchstate@*/</span>
<a name="l00910"></a>00910     <span class="keywordflow">if</span> (S_ISDIR(st-&gt;st_mode)) {
<a name="l00911"></a>00911         st-&gt;st_size = 0;
<a name="l00912"></a>00912     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(st-&gt;st_mode)) {
<a name="l00913"></a>00913         <span class="comment">/*</span>
<a name="l00914"></a>00914 <span class="comment">         * While linux puts the size of a symlink in the st_size field,</span>
<a name="l00915"></a>00915 <span class="comment">         * I don't think that's a specified standard.</span>
<a name="l00916"></a>00916 <span class="comment">         */</span>
<a name="l00917"></a>00917         <span class="comment">/* XXX NUL terminated result in fsm-&gt;rdbuf, len in fsm-&gt;rdnb. */</span>
<a name="l00918"></a>00918         rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525a5e162d7e218ad162e17a7a9d8cf3f1">FSM_READLINK</a>);
<a name="l00919"></a>00919         <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l00920"></a>00920         st-&gt;st_size = fsm-&gt;<a class="code" href="structfsm__s.html#0bca6f694fbca882933fd96be8ead40c">rdnb</a>;
<a name="l00921"></a>00921         symbuf = <a class="code" href="fsm_8c.html#0e6c36aa207979a118f67d4ddb341fce">alloca_strdup</a>(fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a>);     <span class="comment">/* XXX save readlink return. */</span>
<a name="l00922"></a>00922     }
<a name="l00923"></a>00923     <span class="comment">/*@=branchstate@*/</span>
<a name="l00924"></a>00924 
<a name="l00925"></a>00925     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4c92a6a84a77cb0d22d5dba83db4f57fb">CPIO_MAP_ABSOLUTE</a>) {
<a name="l00926"></a>00926 <span class="comment">/*@-boundswrite@*/</span>
<a name="l00927"></a>00927         <span class="keywordtype">int</span> nb = strlen(fsm-&gt;<a class="code" href="structfsm__s.html#311bd72c333f118e811508411ac483cb">dirName</a>) + strlen(fsm-&gt;<a class="code" href="structfsm__s.html#5e07c45abe2d972bd5b9a3e43838af7e">baseName</a>) + <span class="keyword">sizeof</span>(<span class="stringliteral">"."</span>);
<a name="l00928"></a>00928         <span class="keywordtype">char</span> * t = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(nb);
<a name="l00929"></a>00929         *t = <span class="charliteral">'\0'</span>;
<a name="l00930"></a>00930         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = t;
<a name="l00931"></a>00931         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4d90d053c748a6c4d85ca651a30bcdde1">CPIO_MAP_ADDDOT</a>)
<a name="l00932"></a>00932             *t++ = <span class="charliteral">'.'</span>;
<a name="l00933"></a>00933         t = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(t, fsm-&gt;<a class="code" href="structfsm__s.html#311bd72c333f118e811508411ac483cb">dirName</a>), fsm-&gt;<a class="code" href="structfsm__s.html#5e07c45abe2d972bd5b9a3e43838af7e">baseName</a>);
<a name="l00934"></a>00934 <span class="comment">/*@=boundswrite@*/</span>
<a name="l00935"></a>00935     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f469671e9f4719f9a298252f908f72c707">CPIO_MAP_PATH</a>) {
<a name="l00936"></a>00936         <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l00937"></a>00937         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> =
<a name="l00938"></a>00938             (fi-&gt;apath ? fi-&gt;apath[fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>] + fi-&gt;striplen : fi-&gt;bnl[fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>]);
<a name="l00939"></a>00939     }
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527d3ffad609d9e2aee93eea5ad12da67f">FSM_HWRITE</a>);
<a name="l00942"></a>00942     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l00943"></a>00943     <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="keywordflow">if</span> (writeData &amp;&amp; S_ISREG(st-&gt;st_mode)) {
<a name="l00946"></a>00946 <span class="preprocessor">#ifdef HAVE_MMAP</span>
<a name="l00947"></a>00947 <span class="preprocessor"></span>        <span class="keywordtype">char</span> * rdbuf = NULL;
<a name="l00948"></a>00948         <span class="keywordtype">void</span> * mapped = (<span class="keywordtype">void</span> *)-1;
<a name="l00949"></a>00949         <span class="keywordtype">size_t</span> nmapped;
<a name="l00950"></a>00950 <span class="preprocessor">#endif</span>
<a name="l00951"></a>00951 <span class="preprocessor"></span>
<a name="l00952"></a>00952         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452f536b77beea08bb509ebcb64848da31c">FSM_ROPEN</a>);
<a name="l00953"></a>00953         <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l00954"></a>00954 
<a name="l00955"></a>00955         <span class="comment">/* XXX unbuffered mmap generates *lots* of fdio debugging */</span>
<a name="l00956"></a>00956 <span class="preprocessor">#ifdef HAVE_MMAP</span>
<a name="l00957"></a>00957 <span class="preprocessor"></span>        nmapped = 0;
<a name="l00958"></a>00958         mapped = mmap(NULL, st-&gt;st_size, PROT_READ, MAP_SHARED, <a class="code" href="rpmio_8c.html#6728c7372657b891dcaf375c2c50a3da" title="fileno(3) clone.">Fileno</a>(fsm-&gt;<a class="code" href="structfsm__s.html#57d64f1222e1eb1b5a2ea40543043d81">rfd</a>), 0);
<a name="l00959"></a>00959         <span class="keywordflow">if</span> (mapped != (<span class="keywordtype">void</span> *)-1) {
<a name="l00960"></a>00960             rdbuf = fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a>;
<a name="l00961"></a>00961             fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a> = (<span class="keywordtype">char</span> *) mapped;
<a name="l00962"></a>00962             fsm-&gt;<a class="code" href="structfsm__s.html#00c912721636e8709159f21ae7f9fff8">rdlen</a> = nmapped = st-&gt;st_size;
<a name="l00963"></a>00963 <span class="preprocessor">#if defined(MADV_DONTNEED)</span>
<a name="l00964"></a>00964 <span class="preprocessor"></span>            xx = madvise(mapped, nmapped, MADV_DONTNEED);
<a name="l00965"></a>00965 <span class="preprocessor">#endif</span>
<a name="l00966"></a>00966 <span class="preprocessor"></span>        }
<a name="l00967"></a>00967 <span class="preprocessor">#endif</span>
<a name="l00968"></a>00968 <span class="preprocessor"></span>
<a name="l00969"></a>00969         left = st-&gt;st_size;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971         <span class="keywordflow">while</span> (left) {
<a name="l00972"></a>00972 <span class="preprocessor">#ifdef HAVE_MMAP</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>          <span class="keywordflow">if</span> (mapped != (<span class="keywordtype">void</span> *)-1) {
<a name="l00974"></a>00974             fsm-&gt;<a class="code" href="structfsm__s.html#0bca6f694fbca882933fd96be8ead40c">rdnb</a> = nmapped;
<a name="l00975"></a>00975           } <span class="keywordflow">else</span>
<a name="l00976"></a>00976 <span class="preprocessor">#endif</span>
<a name="l00977"></a>00977 <span class="preprocessor"></span>          {
<a name="l00978"></a>00978             fsm-&gt;<a class="code" href="structfsm__s.html#00c912721636e8709159f21ae7f9fff8">rdlen</a> = (left &gt; fsm-&gt;<a class="code" href="structfsm__s.html#d7e0ca496c45215523bf2420f8469df1">rdsize</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#d7e0ca496c45215523bf2420f8469df1">rdsize</a> : left),
<a name="l00979"></a>00979             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ce99bb73bfc3509e90f18c53d3c3888c">FSM_READ</a>);
<a name="l00980"></a>00980             <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l00981"></a>00981           }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983             <span class="comment">/* XXX DWRITE uses rdnb for I/O length. */</span>
<a name="l00984"></a>00984             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526524a4e5d4bbbb7b0c9c134b4e558b83">FSM_DWRITE</a>);
<a name="l00985"></a>00985             <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l00986"></a>00986 
<a name="l00987"></a>00987             left -= fsm-&gt;<a class="code" href="structfsm__s.html#eba675bcb78b6e09124e63d66455e14e">wrnb</a>;
<a name="l00988"></a>00988         }
<a name="l00989"></a>00989 
<a name="l00990"></a>00990 <span class="preprocessor">#ifdef HAVE_MMAP</span>
<a name="l00991"></a>00991 <span class="preprocessor"></span><span class="comment">/*@-branchstate@*/</span>
<a name="l00992"></a>00992         <span class="keywordflow">if</span> (mapped != (<span class="keywordtype">void</span> *)-1) {
<a name="l00993"></a>00993             xx = msync(mapped, nmapped, MS_ASYNC);
<a name="l00994"></a>00994 <span class="preprocessor">#if defined(MADV_DONTNEED)</span>
<a name="l00995"></a>00995 <span class="preprocessor"></span>            xx = madvise(mapped, nmapped, MADV_DONTNEED);
<a name="l00996"></a>00996 <span class="preprocessor">#endif</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span><span class="comment">/*@-noeffect@*/</span>
<a name="l00998"></a>00998             xx = munmap(mapped, nmapped);
<a name="l00999"></a>00999 <span class="comment">/*@=noeffect@*/</span>
<a name="l01000"></a>01000             fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a> = rdbuf;
<a name="l01001"></a>01001         }
<a name="l01002"></a>01002 <span class="comment">/*@=branchstate@*/</span>
<a name="l01003"></a>01003 <span class="preprocessor">#endif</span>
<a name="l01004"></a>01004 <span class="preprocessor"></span>
<a name="l01005"></a>01005     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (writeData &amp;&amp; <a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(st-&gt;st_mode)) {
<a name="l01006"></a>01006         <span class="comment">/* XXX DWRITE uses rdnb for I/O length. */</span>
<a name="l01007"></a>01007 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01008"></a>01008         strcpy(fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a>, symbuf);     <span class="comment">/* XXX restore readlink buffer. */</span>
<a name="l01009"></a>01009 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01010"></a>01010         fsm-&gt;<a class="code" href="structfsm__s.html#0bca6f694fbca882933fd96be8ead40c">rdnb</a> = strlen(symbuf);
<a name="l01011"></a>01011         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526524a4e5d4bbbb7b0c9c134b4e558b83">FSM_DWRITE</a>);
<a name="l01012"></a>01012         <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l01013"></a>01013     }
<a name="l01014"></a>01014 
<a name="l01015"></a>01015     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d879219cd22e4c5fd9bb012cf9908ac3">FSM_PAD</a>);
<a name="l01016"></a>01016     <span class="keywordflow">if</span> (rc) <span class="keywordflow">goto</span> exit;
<a name="l01017"></a>01017 
<a name="l01018"></a>01018     rc = 0;
<a name="l01019"></a>01019 
<a name="l01020"></a>01020 exit:
<a name="l01021"></a>01021     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#57d64f1222e1eb1b5a2ea40543043d81">rfd</a> != NULL)
<a name="l01022"></a>01022         (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45224c1f08820c09b3a73cc99e96fd31561">FSM_RCLOSE</a>);
<a name="l01023"></a>01023 <span class="comment">/*@-dependenttrans@*/</span>
<a name="l01024"></a>01024     fsm-&gt;opath = opath;
<a name="l01025"></a>01025     fsm-&gt;path = path;
<a name="l01026"></a>01026 <span class="comment">/*@=dependenttrans@*/</span>
<a name="l01027"></a>01027     <span class="keywordflow">return</span> rc;
<a name="l01028"></a>01028 }
<a name="l01029"></a>01029 <span class="comment">/*@=compdef =compmempass@*/</span>
<a name="l01030"></a>01030 
<a name="l01036"></a><a class="code" href="group__payload.html#g6d1cb6cacbb90223510503fa6eca9b72">01036</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#g6d1cb6cacbb90223510503fa6eca9b72" title="Write set of linked files to payload stream.">writeLinkedFile</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l01037"></a>01037         <span class="comment">/*@uses fsm-&gt;path, fsm-&gt;nsuffix, fsm-&gt;ix, fsm-&gt;li, fsm-&gt;failedFile @*/</span>
<a name="l01038"></a>01038         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01039"></a>01039         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l01040"></a>01040 {
<a name="l01041"></a>01041     <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01042"></a>01042     <span class="keyword">const</span> <span class="keywordtype">char</span> * nsuffix = fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>;
<a name="l01043"></a>01043     <span class="keywordtype">int</span> iterIndex = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l01044"></a>01044     <span class="keywordtype">int</span> ec = 0;
<a name="l01045"></a>01045     <span class="keywordtype">int</span> rc;
<a name="l01046"></a>01046     <span class="keywordtype">int</span> i;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l01049"></a>01049     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = NULL;
<a name="l01050"></a>01050     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = -1;
<a name="l01051"></a>01051 
<a name="l01052"></a>01052 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01053"></a>01053 <span class="comment">/*@-branchstate@*/</span>
<a name="l01054"></a>01054     <span class="keywordflow">for</span> (i = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#92ac50d8eb3f05209d1000c9ab92b868">nlink</a> - 1; i &gt;= 0; i--) {
<a name="l01055"></a>01055 
<a name="l01056"></a>01056         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] &lt; 0) <span class="keywordflow">continue</span>;
<a name="l01057"></a>01057 
<a name="l01058"></a>01058         fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i];
<a name="l01059"></a>01059 <span class="comment">/*@-compdef@*/</span>
<a name="l01060"></a>01060         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>);
<a name="l01061"></a>01061 <span class="comment">/*@=compdef@*/</span>
<a name="l01062"></a>01062 
<a name="l01063"></a>01063         <span class="comment">/* Write data after last link. */</span>
<a name="l01064"></a>01064         rc = <a class="code" href="group__payload.html#gb228a1a0b6d1189f881ca1a0b0c87926" title="Write next item to payload stream.">writeFile</a>(fsm, (i == 0));
<a name="l01065"></a>01065         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> &amp;&amp; rc != 0 &amp;&amp; *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> == NULL) {
<a name="l01066"></a>01066             ec = rc;
<a name="l01067"></a>01067             *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01068"></a>01068         }
<a name="l01069"></a>01069 
<a name="l01070"></a>01070         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01071"></a>01071         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] = -1;
<a name="l01072"></a>01072     }
<a name="l01073"></a>01073 <span class="comment">/*@=branchstate@*/</span>
<a name="l01074"></a>01074 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01075"></a>01075 
<a name="l01076"></a>01076     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = iterIndex;
<a name="l01077"></a>01077     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = nsuffix;
<a name="l01078"></a>01078     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l01079"></a>01079     <span class="keywordflow">return</span> ec;
<a name="l01080"></a>01080 }
<a name="l01081"></a>01081 
<a name="l01087"></a>01087 <span class="comment">/*@-boundsread@*/</span>
<a name="l01088"></a>01088 <span class="comment">/*@-compdef@*/</span>
<a name="l01089"></a><a class="code" href="group__payload.html#g79aa14b1856aa8e461249eceae17de59">01089</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#g79aa14b1856aa8e461249eceae17de59" title="Create pending hard links to existing file.">fsmMakeLinks</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l01090"></a>01090         <span class="comment">/*@uses fsm-&gt;path, fsm-&gt;opath, fsm-&gt;nsuffix, fsm-&gt;ix, fsm-&gt;li @*/</span>
<a name="l01091"></a>01091         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01092"></a>01092         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l01093"></a>01093 {
<a name="l01094"></a>01094     <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01095"></a>01095     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmtool_8c.html#388b138a2eef245efa264b879f68f826">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>;
<a name="l01096"></a>01096     <span class="keyword">const</span> <span class="keywordtype">char</span> * nsuffix = fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>;
<a name="l01097"></a>01097     <span class="keywordtype">int</span> iterIndex = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l01098"></a>01098     <span class="keywordtype">int</span> ec = 0;
<a name="l01099"></a>01099     <span class="keywordtype">int</span> rc;
<a name="l01100"></a>01100     <span class="keywordtype">int</span> i;
<a name="l01101"></a>01101 
<a name="l01102"></a>01102     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l01103"></a>01103     fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = NULL;
<a name="l01104"></a>01104     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = NULL;
<a name="l01105"></a>01105     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = -1;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#8e26ef91a7b84a55308456007f54dcb9">createdPath</a>];
<a name="l01108"></a>01108     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>);
<a name="l01109"></a>01109     fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01110"></a>01110     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l01111"></a>01111     <span class="comment">/*@-branchstate@*/</span>
<a name="l01112"></a>01112     <span class="keywordflow">for</span> (i = 0; i &lt; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#92ac50d8eb3f05209d1000c9ab92b868">nlink</a>; i++) {
<a name="l01113"></a>01113         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] &lt; 0) <span class="keywordflow">continue</span>;
<a name="l01114"></a>01114         if (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#8e26ef91a7b84a55308456007f54dcb9">createdPath</a> == i) <span class="keywordflow">continue</span>;
<a name="l01115"></a>01115 
<a name="l01116"></a>01116         fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i];
<a name="l01117"></a>01117         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01118"></a>01118         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>);
<a name="l01119"></a>01119         <span class="keywordflow">if</span> (<a class="code" href="rpmlib_8h.html#2ed895afbe3c80bdfb7275869c487104">XFA_SKIPPING</a>(fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a>)) <span class="keywordflow">continue</span>;
<a name="l01120"></a>01120 
<a name="l01121"></a>01121         rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>);
<a name="l01122"></a>01122         <span class="keywordflow">if</span> (!rc) <span class="keywordflow">continue</span>;
<a name="l01123"></a>01123         <span class="keywordflow">if</span> (!(rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>)) <span class="keywordflow">break</span>;
<a name="l01124"></a>01124 
<a name="l01125"></a>01125         <span class="comment">/* XXX link(fsm-&gt;opath, fsm-&gt;path) */</span>
<a name="l01126"></a>01126         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452e4050a267ba77b53c5ce751062f3f0c9">FSM_LINK</a>);
<a name="l01127"></a>01127         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> &amp;&amp; rc != 0 &amp;&amp; *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> == NULL) {
<a name="l01128"></a>01128             ec = rc;
<a name="l01129"></a>01129 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01130"></a>01130             *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01131"></a>01131 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01132"></a>01132         }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>--;
<a name="l01135"></a>01135     }
<a name="l01136"></a>01136     <span class="comment">/*@=branchstate@*/</span>
<a name="l01137"></a>01137     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01138"></a>01138     fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>);
<a name="l01139"></a>01139 
<a name="l01140"></a>01140     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = iterIndex;
<a name="l01141"></a>01141     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = nsuffix;
<a name="l01142"></a>01142     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l01143"></a>01143     fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = opath;
<a name="l01144"></a>01144     <span class="keywordflow">return</span> ec;
<a name="l01145"></a>01145 }
<a name="l01146"></a>01146 <span class="comment">/*@=compdef@*/</span>
<a name="l01147"></a>01147 <span class="comment">/*@=boundsread@*/</span>
<a name="l01148"></a>01148 
<a name="l01154"></a>01154 <span class="comment">/*@-compdef@*/</span>
<a name="l01155"></a><a class="code" href="group__payload.html#g20c401dca511eb11b6ddaec3a8e97643">01155</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__payload.html#g20c401dca511eb11b6ddaec3a8e97643" title="Commit hard linked file set atomically.">fsmCommitLinks</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l01156"></a>01156         <span class="comment">/*@uses fsm-&gt;path, fsm-&gt;nsuffix, fsm-&gt;ix, fsm-&gt;sb,</span>
<a name="l01157"></a>01157 <span class="comment">                fsm-&gt;li, fsm-&gt;links @*/</span>
<a name="l01158"></a>01158         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01159"></a>01159         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l01160"></a>01160 {
<a name="l01161"></a>01161     <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01162"></a>01162     <span class="keyword">const</span> <span class="keywordtype">char</span> * nsuffix = fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>;
<a name="l01163"></a>01163     <span class="keywordtype">int</span> iterIndex = fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>;
<a name="l01164"></a>01164     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l01165"></a>01165     <span class="keywordtype">int</span> rc = 0;
<a name="l01166"></a>01166     <span class="keywordtype">int</span> i;
<a name="l01167"></a>01167 
<a name="l01168"></a>01168     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l01169"></a>01169     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = NULL;
<a name="l01170"></a>01170     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = -1;
<a name="l01171"></a>01171 
<a name="l01172"></a>01172     <span class="comment">/*@-branchstate@*/</span>
<a name="l01173"></a>01173     <span class="keywordflow">for</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>) {
<a name="l01174"></a>01174         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a>.st_ino == st-&gt;st_ino &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a>.st_dev == st-&gt;st_dev)
<a name="l01175"></a>01175             <span class="keywordflow">break</span>;
<a name="l01176"></a>01176     }
<a name="l01177"></a>01177     <span class="comment">/*@=branchstate@*/</span>
<a name="l01178"></a>01178 
<a name="l01179"></a>01179 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01180"></a>01180     <span class="keywordflow">for</span> (i = 0; i &lt; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#92ac50d8eb3f05209d1000c9ab92b868">nlink</a>; i++) {
<a name="l01181"></a>01181         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] &lt; 0) <span class="keywordflow">continue</span>;
<a name="l01182"></a>01182         fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i];
<a name="l01183"></a>01183         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>);
<a name="l01184"></a>01184         <span class="keywordflow">if</span> (!<a class="code" href="rpmlib_8h.html#2ed895afbe3c80bdfb7275869c487104">XFA_SKIPPING</a>(fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a>))
<a name="l01185"></a>01185             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520a6c510c2b2b3cad342aafd895103e50">FSM_COMMIT</a>);
<a name="l01186"></a>01186         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01187"></a>01187         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] = -1;
<a name="l01188"></a>01188     }
<a name="l01189"></a>01189 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = iterIndex;
<a name="l01192"></a>01192     fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = nsuffix;
<a name="l01193"></a>01193     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l01194"></a>01194     <span class="keywordflow">return</span> rc;
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 <span class="comment">/*@=compdef@*/</span>
<a name="l01197"></a>01197 
<a name="l01203"></a><a class="code" href="fsm_8c.html#f893f0155c89e2cb44e61687b612d38e">01203</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#f893f0155c89e2cb44e61687b612d38e" title="Remove (if created) directories not explicitly included in package.">fsmRmdirs</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l01204"></a>01204         <span class="comment">/*@uses fsm-&gt;path, fsm-&gt;dnlx, fsm-&gt;ldn, fsm-&gt;rdbuf, fsm-&gt;iter @*/</span>
<a name="l01205"></a>01205         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01206"></a>01206         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l01207"></a>01207 {
<a name="l01208"></a>01208     <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01209"></a>01209     <span class="keywordtype">void</span> * dnli = <a class="code" href="group__payload.html#g9c78bfa42b2036abb3a0cb98aaa24b13" title="Create directory name iterator.">dnlInitIterator</a>(fsm, 1);
<a name="l01210"></a>01210     <span class="keywordtype">char</span> * dn = fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a>;
<a name="l01211"></a>01211     <span class="keywordtype">int</span> dc = <a class="code" href="group__payload.html#ge7fb0a21248265e78d8e9fc06b4cf708">dnlCount</a>(dnli);
<a name="l01212"></a>01212     <span class="keywordtype">int</span> rc = 0;
<a name="l01213"></a>01213 
<a name="l01214"></a>01214     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l01215"></a>01215 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01216"></a>01216     dn[0] = <span class="charliteral">'\0'</span>;
<a name="l01217"></a>01217     <span class="comment">/*@-observertrans -dependenttrans@*/</span>
<a name="l01218"></a>01218     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a> != NULL &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a> != NULL)
<a name="l01219"></a>01219     <span class="keywordflow">while</span> ((fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g3a778746d4887e03063a884ff6414e57" title="Return next directory name (from file info).">dnlNextIterator</a>(dnli)) != NULL) {
<a name="l01220"></a>01220         <span class="keywordtype">int</span> dnlen = strlen(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01221"></a>01221         <span class="keywordtype">char</span> * te;
<a name="l01222"></a>01222 
<a name="l01223"></a>01223         dc = <a class="code" href="group__payload.html#gba4a4ab97a1721b54010195e06543159">dnlIndex</a>(dnli);
<a name="l01224"></a>01224         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>[dc] &lt; 1 || fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>[dc] &gt;= dnlen)
<a name="l01225"></a>01225             <span class="keywordflow">continue</span>;
<a name="l01226"></a>01226 
<a name="l01227"></a>01227         <span class="comment">/* Copy to avoid const on fsm-&gt;path. */</span>
<a name="l01228"></a>01228         te = <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(dn, fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>) - 1;
<a name="l01229"></a>01229         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = dn;
<a name="l01230"></a>01230 
<a name="l01231"></a>01231         <span class="comment">/* Remove generated directories. */</span>
<a name="l01232"></a>01232         <span class="comment">/*@-usereleased@*/</span> <span class="comment">/* LCL: te used after release? */</span>
<a name="l01233"></a>01233         <span class="keywordflow">do</span> {
<a name="l01234"></a>01234             <span class="keywordflow">if</span> (*te == <span class="charliteral">'/'</span>) {
<a name="l01235"></a>01235                 *te = <span class="charliteral">'\0'</span>;
<a name="l01236"></a>01236 <span class="comment">/*@-compdef@*/</span>
<a name="l01237"></a>01237                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520cab91415883e1a21162dd617bdcd6da">FSM_RMDIR</a>);
<a name="l01238"></a>01238 <span class="comment">/*@=compdef@*/</span>
<a name="l01239"></a>01239                 *te = <span class="charliteral">'/'</span>;
<a name="l01240"></a>01240             }
<a name="l01241"></a>01241             <span class="keywordflow">if</span> (rc)
<a name="l01242"></a>01242                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01243"></a>01243             te--;
<a name="l01244"></a>01244         } <span class="keywordflow">while</span> ((te - fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>) &gt; fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>[dc]);
<a name="l01245"></a>01245         <span class="comment">/*@=usereleased@*/</span>
<a name="l01246"></a>01246     }
<a name="l01247"></a>01247 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01248"></a>01248     dnli = <a class="code" href="group__payload.html#gb360bb38b118640228af9fb4bd6d067d" title="Destroy directory name iterator.">dnlFreeIterator</a>(dnli);
<a name="l01249"></a>01249     <span class="comment">/*@=observertrans =dependenttrans@*/</span>
<a name="l01250"></a>01250 
<a name="l01251"></a>01251     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l01252"></a>01252     <span class="keywordflow">return</span> rc;
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01260"></a><a class="code" href="fsm_8c.html#cd6276d038e9954be2d0970550895f97">01260</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#cd6276d038e9954be2d0970550895f97" title="Create (if necessary) directories not explicitly included in package.">fsmMkdirs</a>(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l01261"></a>01261         <span class="comment">/*@uses fsm-&gt;path, fsm-&gt;sb, fsm-&gt;osb, fsm-&gt;rdbuf, fsm-&gt;iter,</span>
<a name="l01262"></a>01262 <span class="comment">                fsm-&gt;ldn, fsm-&gt;ldnlen, fsm-&gt;ldnalloc @*/</span>
<a name="l01263"></a>01263         <span class="comment">/*@defines fsm-&gt;dnlx, fsm-&gt;ldn @*/</span>
<a name="l01264"></a>01264         <span class="comment">/*@globals h_errno, fileSystem, internalState @*/</span>
<a name="l01265"></a>01265         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l01266"></a>01266 {
<a name="l01267"></a>01267     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l01268"></a>01268     <span class="keyword">struct </span>stat * ost = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#83fece2a7d788502e4dd0baeec0c8cca">osb</a>;
<a name="l01269"></a>01269     <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01270"></a>01270     mode_t st_mode = st-&gt;st_mode;
<a name="l01271"></a>01271     <span class="keywordtype">void</span> * dnli = <a class="code" href="group__payload.html#g9c78bfa42b2036abb3a0cb98aaa24b13" title="Create directory name iterator.">dnlInitIterator</a>(fsm, 0);
<a name="l01272"></a>01272     <span class="keywordtype">char</span> * dn = fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a>;
<a name="l01273"></a>01273     <span class="keywordtype">int</span> dc = <a class="code" href="group__payload.html#ge7fb0a21248265e78d8e9fc06b4cf708">dnlCount</a>(dnli);
<a name="l01274"></a>01274     <span class="keywordtype">int</span> rc = 0;
<a name="l01275"></a>01275     <span class="keywordtype">int</span> i;
<a name="l01276"></a>01276 <span class="comment">/*@-compdef@*/</span>
<a name="l01277"></a>01277     <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm);
<a name="l01278"></a>01278 <span class="comment">/*@=compdef@*/</span>
<a name="l01279"></a>01279     <a class="code" href="system_8h.html#7cb29f84b9b9b1042bb9d0de949f888b">security_context_t</a> scon = NULL;
<a name="l01280"></a>01280 
<a name="l01281"></a>01281     fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01284"></a>01284     dn[0] = <span class="charliteral">'\0'</span>;
<a name="l01285"></a>01285     fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a> = (dc ? <a class="code" href="system_8h.html#9533f3165c8a4af7283dce262b32989f">xcalloc</a>(dc, <span class="keyword">sizeof</span>(*fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>)) : NULL);
<a name="l01286"></a>01286     <span class="comment">/*@-observertrans -dependenttrans@*/</span>
<a name="l01287"></a>01287     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a> != NULL)
<a name="l01288"></a>01288     <span class="keywordflow">while</span> ((fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g3a778746d4887e03063a884ff6414e57" title="Return next directory name (from file info).">dnlNextIterator</a>(dnli)) != NULL) {
<a name="l01289"></a>01289         <span class="keywordtype">int</span> dnlen = strlen(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01290"></a>01290         <span class="keywordtype">char</span> * te;
<a name="l01291"></a>01291 
<a name="l01292"></a>01292         dc = <a class="code" href="group__payload.html#gba4a4ab97a1721b54010195e06543159">dnlIndex</a>(dnli);
<a name="l01293"></a>01293         <span class="keywordflow">if</span> (dc &lt; 0) <span class="keywordflow">continue</span>;
<a name="l01294"></a>01294         fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>[dc] = dnlen;
<a name="l01295"></a>01295         <span class="keywordflow">if</span> (dnlen &lt;= 1)
<a name="l01296"></a>01296             <span class="keywordflow">continue</span>;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298         <span class="comment">/*@-compdef -nullpass@*/</span>        <span class="comment">/* FIX: fsm-&gt;ldn not defined ??? */</span>
<a name="l01299"></a>01299         <span class="keywordflow">if</span> (dnlen &lt;= fsm-&gt;ldnlen &amp;&amp; !strcmp(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>))
<a name="l01300"></a>01300             <span class="keywordflow">continue</span>;
<a name="l01301"></a>01301         <span class="comment">/*@=compdef =nullpass@*/</span>
<a name="l01302"></a>01302 
<a name="l01303"></a>01303         <span class="comment">/* Copy to avoid const on fsm-&gt;path. */</span>
<a name="l01304"></a>01304         (void) <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(dn, fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01305"></a>01305         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = dn;
<a name="l01306"></a>01306 
<a name="l01307"></a>01307         <span class="comment">/* Assume '/' directory exists, "mkdir -p" for others if non-existent */</span>
<a name="l01308"></a>01308         <span class="keywordflow">for</span> (i = 1, te = dn + 1; *te != <span class="charliteral">'\0'</span>; te++, i++) {
<a name="l01309"></a>01309             <span class="keywordflow">if</span> (*te != <span class="charliteral">'/'</span>)
<a name="l01310"></a>01310                 <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01311"></a>01311 
<a name="l01312"></a>01312             *te = <span class="charliteral">'\0'</span>;
<a name="l01313"></a>01313 
<a name="l01314"></a>01314             <span class="comment">/* Already validated? */</span>
<a name="l01315"></a>01315             <span class="comment">/*@-usedef -compdef -nullpass -nullderef@*/</span>
<a name="l01316"></a>01316             <span class="keywordflow">if</span> (i &lt; fsm-&gt;ldnlen &amp;&amp;
<a name="l01317"></a>01317                 (fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>[i] == <span class="charliteral">'/'</span> || fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>[i] == <span class="charliteral">'\0'</span>) &amp;&amp;
<a name="l01318"></a>01318                 !strncmp(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>, i))
<a name="l01319"></a>01319             {
<a name="l01320"></a>01320                 *te = <span class="charliteral">'/'</span>;
<a name="l01321"></a>01321                 <span class="comment">/* Move pre-existing path marker forward. */</span>
<a name="l01322"></a>01322                 fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>[dc] = (te - dn);
<a name="l01323"></a>01323                 <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01324"></a>01324             }
<a name="l01325"></a>01325             <span class="comment">/*@=usedef =compdef =nullpass =nullderef@*/</span>
<a name="l01326"></a>01326 
<a name="l01327"></a>01327             <span class="comment">/* Validate next component of path. */</span>
<a name="l01328"></a>01328             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c14737c46922fefb101602543a0ddacb">FSM_LSTAT</a>);
<a name="l01329"></a>01329             *te = <span class="charliteral">'/'</span>;
<a name="l01330"></a>01330 
<a name="l01331"></a>01331             <span class="comment">/* Directory already exists? */</span>
<a name="l01332"></a>01332             <span class="keywordflow">if</span> (rc == 0 &amp;&amp; S_ISDIR(ost-&gt;st_mode)) {
<a name="l01333"></a>01333                 <span class="comment">/* Move pre-existing path marker forward. */</span>
<a name="l01334"></a>01334                 fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>[dc] = (te - dn);
<a name="l01335"></a>01335             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>) {
<a name="l01336"></a>01336                 <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l01337"></a>01337                 *te = <span class="charliteral">'\0'</span>;
<a name="l01338"></a>01338                 st-&gt;st_mode = S_IFDIR | (fi-&gt;dperms &amp; 07777);
<a name="l01339"></a>01339                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452521a68c56ac73d1ff02e904d90492cce">FSM_MKDIR</a>);
<a name="l01340"></a>01340                 <span class="keywordflow">if</span> (!rc) {
<a name="l01341"></a>01341                     <span class="comment">/* XXX FIXME? only new dir will have context set. */</span>
<a name="l01342"></a>01342                     <span class="comment">/* Get file security context from patterns. */</span>
<a name="l01343"></a>01343                     <span class="keywordflow">if</span> (<a class="code" href="group__rpmts.html#g2e0f222f70e2e2017f8d6c37de090957" title="Get selinuxEnabled flag, i.e.">rpmtsSELinuxEnabled</a>(ts) &amp;&amp;
<a name="l01344"></a>01344                         ! <a class="code" href="group__rpmts.html#g4e8995f22601eb9d5d3e264fa005e167" title="Get transaction flags, i.e.">rpmtsFlags</a>(ts) &amp; <a class="code" href="rpmlib_8h.html#451385c9472c6ccc583867853442e2ef1bffb895a3de9927dc70d9e48aaf5d1e">RPMTRANS_FLAG_NOCONTEXTS</a>) {
<a name="l01345"></a>01345                         <span class="keywordflow">if</span> (matchpathcon(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, st-&gt;st_mode, &amp;scon) == 0 &amp;&amp;
<a name="l01346"></a>01346                             scon != NULL) {
<a name="l01347"></a>01347                                 fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> = scon;
<a name="l01348"></a>01348                                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452132ce1a922a82ca3e960345881777552">FSM_LSETFCON</a>);
<a name="l01349"></a>01349                         }
<a name="l01350"></a>01350                     }
<a name="l01351"></a>01351                         
<a name="l01352"></a>01352                     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> == NULL)
<a name="l01353"></a>01353                         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>,
<a name="l01354"></a>01354                             <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s directory created with perms %04o, no context.\n"</span>),
<a name="l01355"></a>01355                             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, (<span class="keywordtype">unsigned</span>)(st-&gt;st_mode &amp; 07777));
<a name="l01356"></a>01356                     <span class="keywordflow">else</span>
<a name="l01357"></a>01357                         <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG,
<a name="l01358"></a>01358                             <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s directory created with perms %04o, context %s.\n"</span>),
<a name="l01359"></a>01359                             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, (<span class="keywordtype">unsigned</span>)(st-&gt;st_mode &amp; 07777),
<a name="l01360"></a>01360                             fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a>);
<a name="l01361"></a>01361                     fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> = NULL;
<a name="l01362"></a>01362                 }
<a name="l01363"></a>01363                 *te = <span class="charliteral">'/'</span>;
<a name="l01364"></a>01364             }
<a name="l01365"></a>01365             <span class="keywordflow">if</span> (rc)
<a name="l01366"></a>01366                 <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01367"></a>01367         }
<a name="l01368"></a>01368         <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l01369"></a>01369 
<a name="l01370"></a>01370         <span class="comment">/* Save last validated path. */</span>
<a name="l01371"></a>01371 <span class="comment">/*@-compdef@*/</span> <span class="comment">/* FIX: ldn/path annotations ? */</span>
<a name="l01372"></a>01372         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#07c4694a0eda6c7499f0c6ca93d946c7">ldnalloc</a> &lt; (dnlen + 1)) {
<a name="l01373"></a>01373             fsm-&gt;<a class="code" href="structfsm__s.html#07c4694a0eda6c7499f0c6ca93d946c7">ldnalloc</a> = dnlen + 100;
<a name="l01374"></a>01374             fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a> = <a class="code" href="system_8h.html#089316e2770f7e09a135f7128241af8a">xrealloc</a>(fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>, fsm-&gt;<a class="code" href="structfsm__s.html#07c4694a0eda6c7499f0c6ca93d946c7">ldnalloc</a>);
<a name="l01375"></a>01375         }
<a name="l01376"></a>01376         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a> != NULL) { <span class="comment">/* XXX can't happen */</span>
<a name="l01377"></a>01377             strcpy(fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>, fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01378"></a>01378             fsm-&gt;<a class="code" href="structfsm__s.html#b7eb1cf93112a4176d06f1500b6af98c">ldnlen</a> = dnlen;
<a name="l01379"></a>01379         }
<a name="l01380"></a>01380 <span class="comment">/*@=compdef@*/</span>
<a name="l01381"></a>01381     }
<a name="l01382"></a>01382 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01383"></a>01383     dnli = <a class="code" href="group__payload.html#gb360bb38b118640228af9fb4bd6d067d" title="Destroy directory name iterator.">dnlFreeIterator</a>(dnli);
<a name="l01384"></a>01384     <span class="comment">/*@=observertrans =dependenttrans@*/</span>
<a name="l01385"></a>01385 
<a name="l01386"></a>01386     fsm-&gt;path = path;
<a name="l01387"></a>01387     st-&gt;st_mode = st_mode;              <span class="comment">/* XXX restore st-&gt;st_mode */</span>
<a name="l01388"></a>01388 <span class="comment">/*@-compdef@*/</span> <span class="comment">/* FIX: ldn/path annotations ? */</span>
<a name="l01389"></a>01389     <span class="keywordflow">return</span> rc;
<a name="l01390"></a>01390 <span class="comment">/*@=compdef@*/</span>
<a name="l01391"></a>01391 }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393 <span class="preprocessor">#ifdef  NOTYET</span>
<a name="l01394"></a>01394 <span class="preprocessor"></span>
<a name="l01399"></a>01399 <span class="keyword">static</span> <span class="keywordtype">int</span> fsmStat(<span class="comment">/*@special@*/</span> <span class="comment">/*@partial@*/</span> <a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm)
<a name="l01400"></a>01400         <span class="comment">/*@globals fileSystem, internalState @*/</span>
<a name="l01401"></a>01401         <span class="comment">/*@modifies fsm, fileSystem, internalState @*/</span>
<a name="l01402"></a>01402 {
<a name="l01403"></a>01403     <span class="keywordtype">int</span> rc = 0;
<a name="l01404"></a>01404 
<a name="l01405"></a>01405     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> != NULL) {
<a name="l01406"></a>01406         <span class="keywordtype">int</span> saveernno = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l01407"></a>01407         rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, (!(fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f42df34a484b9284f89e51b601daf02fd1">CPIO_FOLLOW_SYMLINKS</a>)
<a name="l01408"></a>01408                         ? <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c14737c46922fefb101602543a0ddacb">FSM_LSTAT</a> : <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527cff4f22668fe661b791651fea2f1dab">FSM_STAT</a>));
<a name="l01409"></a>01409         <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>) {
<a name="l01410"></a>01410             <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l01411"></a>01411             rc = 0;
<a name="l01412"></a>01412             fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 0;
<a name="l01413"></a>01413         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0) {
<a name="l01414"></a>01414             fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 1;
<a name="l01415"></a>01415         }
<a name="l01416"></a>01416     } <span class="keywordflow">else</span> {
<a name="l01417"></a>01417         <span class="comment">/* Skip %ghost files on build. */</span>
<a name="l01418"></a>01418         fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 0;
<a name="l01419"></a>01419     }
<a name="l01420"></a>01420     <span class="keywordflow">return</span> rc;
<a name="l01421"></a>01421 }
<a name="l01422"></a>01422 <span class="preprocessor">#endif</span>
<a name="l01423"></a>01423 <span class="preprocessor"></span>
<a name="l01424"></a><a class="code" href="fsm_8c.html#5390c8ef669a0ca7dfc2b5a843bd3566">01424</a> <span class="preprocessor">#define IS_DEV_LOG(_x)  \</span>
<a name="l01425"></a>01425 <span class="preprocessor">        ((_x) != NULL &amp;&amp; strlen(_x) &gt;= (sizeof("/dev/log")-1) &amp;&amp; \</span>
<a name="l01426"></a>01426 <span class="preprocessor">        !strncmp((_x), "/dev/log", sizeof("/dev/log")-1) &amp;&amp; \</span>
<a name="l01427"></a>01427 <span class="preprocessor">        ((_x)[sizeof("/dev/log")-1] == '\0' || \</span>
<a name="l01428"></a>01428 <span class="preprocessor">         (_x)[sizeof("/dev/log")-1] == ';'))</span>
<a name="l01429"></a>01429 <span class="preprocessor"></span>
<a name="l01430"></a>01430 <span class="comment">/*@-boundsread@*/</span>
<a name="l01431"></a>01431 <span class="comment">/*@-compmempass@*/</span>
<a name="l01432"></a><a class="code" href="fsm_8h.html#ad84b5d64310b6ed28dcd49746a2506f">01432</a> <span class="keywordtype">int</span> <a class="code" href="fsm_8c.html#ad84b5d64310b6ed28dcd49746a2506f" title="File state machine driver.">fsmStage</a>(<a class="code" href="structfsm__s.html" title="File name and stat information.">FSM_t</a> fsm, <a class="code" href="fsm_8h.html#42d68171cc4a6c0495fae9cddb9066d5">fileStage</a> stage)
<a name="l01433"></a>01433 {
<a name="l01434"></a>01434 <span class="preprocessor">#ifdef  UNUSED</span>
<a name="l01435"></a>01435 <span class="preprocessor"></span>    <a class="code" href="fsm_8h.html#42d68171cc4a6c0495fae9cddb9066d5">fileStage</a> prevStage = fsm-&gt;<a class="code" href="structfsm__s.html#805b2b82c85f015019d7890371cc15f7">stage</a>;
<a name="l01436"></a>01436     <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> prev = <a class="code" href="fsm_8c.html#410ee9097708efa9da4cc2d8843baba8" title="Return formatted string representation of file stages.">fileStageString</a>(prevStage);
<a name="l01437"></a>01437 <span class="preprocessor">#endif</span>
<a name="l01438"></a>01438 <span class="preprocessor"></span>    <span class="keyword">static</span> <span class="keywordtype">int</span> modulo = 4;
<a name="l01439"></a>01439     <span class="keyword">const</span> <span class="keywordtype">char</span> * <span class="keyword">const</span> cur = <a class="code" href="fsm_8c.html#410ee9097708efa9da4cc2d8843baba8" title="Return formatted string representation of file stages.">fileStageString</a>(stage);
<a name="l01440"></a>01440     <span class="keyword">struct </span>stat * st = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;
<a name="l01441"></a>01441     <span class="keyword">struct </span>stat * ost = &amp;fsm-&gt;<a class="code" href="structfsm__s.html#83fece2a7d788502e4dd0baeec0c8cca">osb</a>;
<a name="l01442"></a>01442     <span class="keywordtype">int</span> saveerrno = <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>;
<a name="l01443"></a>01443     <span class="keywordtype">int</span> rc = fsm-&gt;<a class="code" href="structfsm__s.html#939f7c265139079eee800d47014b05c3">rc</a>;
<a name="l01444"></a>01444     <span class="keywordtype">size_t</span> <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>;
<a name="l01445"></a>01445     <span class="keywordtype">int</span> i;
<a name="l01446"></a>01446 
<a name="l01447"></a>01447 <span class="preprocessor">#define _fafilter(_a)   \</span>
<a name="l01448"></a>01448 <span class="preprocessor">    (!((_a) == FA_CREATE || (_a) == FA_ERASE || (_a) == FA_COPYIN || (_a) == FA_COPYOUT) \</span>
<a name="l01449"></a>01449 <span class="preprocessor">        ? fileActionString(_a) : "")</span>
<a name="l01450"></a>01450 <span class="preprocessor"></span>
<a name="l01451"></a>01451     <span class="keywordflow">if</span> (stage &amp; <a class="code" href="fsm_8h.html#288ca1948881165a067816a5b2bc4e3d">FSM_DEAD</a>) {
<a name="l01452"></a>01452         <span class="comment">/* do nothing */</span>
<a name="l01453"></a>01453     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stage &amp; <a class="code" href="fsm_8h.html#1bef3bf78d816388d88e6262465cde19">FSM_INTERNAL</a>) {
<a name="l01454"></a>01454         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; !(stage &amp; <a class="code" href="fsm_8h.html#3223a4205dcc762e115d79397f4791c1">FSM_SYSCALL</a>))
<a name="l01455"></a>01455             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <span class="stringliteral">" %8s %06o%3d (%4d,%4d)%10d %s %s\n"</span>,
<a name="l01456"></a>01456                 cur,
<a name="l01457"></a>01457                 (<span class="keywordtype">unsigned</span>)st-&gt;st_mode, (<span class="keywordtype">int</span>)st-&gt;st_nlink,
<a name="l01458"></a>01458                 (<span class="keywordtype">int</span>)st-&gt;st_uid, (<span class="keywordtype">int</span>)st-&gt;st_gid, (<span class="keywordtype">int</span>)st-&gt;st_size,
<a name="l01459"></a>01459                 (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> : <span class="stringliteral">""</span>),
<a name="l01460"></a>01460                 <a class="code" href="fsm_8c.html#773cd9be56ae4de92eb74ca52644c61f">_fafilter</a>(fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a>));
<a name="l01461"></a>01461     } <span class="keywordflow">else</span> {
<a name="l01462"></a>01462         fsm-&gt;<a class="code" href="structfsm__s.html#805b2b82c85f015019d7890371cc15f7">stage</a> = stage;
<a name="l01463"></a>01463         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> || !(stage &amp; <a class="code" href="fsm_8h.html#d102520c9f6720dcf122268db4e11e95">FSM_VERBOSE</a>))
<a name="l01464"></a>01464             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <span class="stringliteral">"%-8s  %06o%3d (%4d,%4d)%10d %s %s\n"</span>,
<a name="l01465"></a>01465                 cur,
<a name="l01466"></a>01466                 (<span class="keywordtype">unsigned</span>)st-&gt;st_mode, (<span class="keywordtype">int</span>)st-&gt;st_nlink,
<a name="l01467"></a>01467                 (<span class="keywordtype">int</span>)st-&gt;st_uid, (<span class="keywordtype">int</span>)st-&gt;st_gid, (<span class="keywordtype">int</span>)st-&gt;st_size,
<a name="l01468"></a>01468                 (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> + fsm-&gt;<a class="code" href="structfsm__s.html#d213d00dd62b29f9c96e34c26c2a5c5c">astriplen</a> : <span class="stringliteral">""</span>),
<a name="l01469"></a>01469                 <a class="code" href="fsm_8c.html#773cd9be56ae4de92eb74ca52644c61f">_fafilter</a>(fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a>));
<a name="l01470"></a>01470     }
<a name="l01471"></a>01471 <span class="preprocessor">#undef  _fafilter</span>
<a name="l01472"></a>01472 <span class="preprocessor"></span>
<a name="l01473"></a>01473     <span class="comment">/*@-branchstate@*/</span>
<a name="l01474"></a>01474     <span class="keywordflow">switch</span> (stage) {
<a name="l01475"></a>01475     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452b832487c2611296f132365ac51d0e023">FSM_UNKNOWN</a>:
<a name="l01476"></a>01476         <span class="keywordflow">break</span>;
<a name="l01477"></a>01477     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>:
<a name="l01478"></a>01478         <span class="keywordflow">while</span> (1) {
<a name="l01479"></a>01479             <span class="comment">/* Clean fsm, free'ing memory. Read next archive header. */</span>
<a name="l01480"></a>01480             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d577ae52b65607332e43f7dd9aa68f55">FSM_INIT</a>);
<a name="l01481"></a>01481 
<a name="l01482"></a>01482             <span class="comment">/* Exit on end-of-payload. */</span>
<a name="l01483"></a>01483             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ead49a14963256f34f3409ee294f239f2">CPIOERR_HDR_TRAILER</a>) {
<a name="l01484"></a>01484                 rc = 0;
<a name="l01485"></a>01485                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01486"></a>01486             }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488             <span class="comment">/* Exit on error. */</span>
<a name="l01489"></a>01489             <span class="keywordflow">if</span> (rc) {
<a name="l01490"></a>01490                 fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a> = 1;
<a name="l01491"></a>01491                 (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2932debdd2a3b0b0fe86dbc86b1e873">FSM_UNDO</a>);
<a name="l01492"></a>01492                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01493"></a>01493             }
<a name="l01494"></a>01494 
<a name="l01495"></a>01495             <span class="comment">/* Extract file from archive. */</span>
<a name="l01496"></a>01496             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525ce36da107c022e04c43298a1af3a007">FSM_PROCESS</a>);
<a name="l01497"></a>01497             <span class="keywordflow">if</span> (rc) {
<a name="l01498"></a>01498                 (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2932debdd2a3b0b0fe86dbc86b1e873">FSM_UNDO</a>);
<a name="l01499"></a>01499                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01500"></a>01500             }
<a name="l01501"></a>01501 
<a name="l01502"></a>01502             <span class="comment">/* Notify on success. */</span>
<a name="l01503"></a>01503             (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fdc0a98795027a9a343cb8468c2074e6">FSM_NOTIFY</a>);
<a name="l01504"></a>01504 
<a name="l01505"></a>01505             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d826a541a6750b0ffbd4f93f5a3012d8">FSM_FINI</a>);
<a name="l01506"></a>01506             <span class="keywordflow">if</span> (rc) {
<a name="l01507"></a>01507                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01508"></a>01508             }
<a name="l01509"></a>01509         }
<a name="l01510"></a>01510         <span class="keywordflow">break</span>;
<a name="l01511"></a>01511     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45279fcf20c3562c3fb85220d2c46d098a3">FSM_PKGERASE</a>:
<a name="l01512"></a>01512     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2d50ea36b03c8ec6dc6c2b5a47cba46">FSM_PKGCOMMIT</a>:
<a name="l01513"></a>01513         <span class="keywordflow">while</span> (1) {
<a name="l01514"></a>01514             <span class="comment">/* Clean fsm, free'ing memory. */</span>
<a name="l01515"></a>01515             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d577ae52b65607332e43f7dd9aa68f55">FSM_INIT</a>);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517             <span class="comment">/* Exit on end-of-payload. */</span>
<a name="l01518"></a>01518             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ead49a14963256f34f3409ee294f239f2">CPIOERR_HDR_TRAILER</a>) {
<a name="l01519"></a>01519                 rc = 0;
<a name="l01520"></a>01520                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01521"></a>01521             }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523             <span class="comment">/* Rename/erase next item. */</span>
<a name="l01524"></a>01524             <span class="keywordflow">if</span> (<a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d826a541a6750b0ffbd4f93f5a3012d8">FSM_FINI</a>))
<a name="l01525"></a>01525                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01526"></a>01526         }
<a name="l01527"></a>01527         <span class="keywordflow">break</span>;
<a name="l01528"></a>01528     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>:
<a name="l01529"></a>01529         <span class="keywordflow">while</span> (1) {
<a name="l01530"></a>01530 
<a name="l01531"></a>01531             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d577ae52b65607332e43f7dd9aa68f55">FSM_INIT</a>);
<a name="l01532"></a>01532 
<a name="l01533"></a>01533             <span class="comment">/* Exit on end-of-payload. */</span>
<a name="l01534"></a>01534             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ead49a14963256f34f3409ee294f239f2">CPIOERR_HDR_TRAILER</a>) {
<a name="l01535"></a>01535                 rc = 0;
<a name="l01536"></a>01536                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01537"></a>01537             }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539             <span class="comment">/* Exit on error. */</span>
<a name="l01540"></a>01540             <span class="keywordflow">if</span> (rc) {
<a name="l01541"></a>01541                 fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a> = 1;
<a name="l01542"></a>01542                 (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2932debdd2a3b0b0fe86dbc86b1e873">FSM_UNDO</a>);
<a name="l01543"></a>01543                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01544"></a>01544             }
<a name="l01545"></a>01545 
<a name="l01546"></a>01546             <span class="comment">/* Copy file into archive. */</span>
<a name="l01547"></a>01547             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525ce36da107c022e04c43298a1af3a007">FSM_PROCESS</a>);
<a name="l01548"></a>01548             <span class="keywordflow">if</span> (rc) {
<a name="l01549"></a>01549                 (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2932debdd2a3b0b0fe86dbc86b1e873">FSM_UNDO</a>);
<a name="l01550"></a>01550                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01551"></a>01551             }
<a name="l01552"></a>01552 
<a name="l01553"></a>01553             <span class="comment">/* Notify on success. */</span>
<a name="l01554"></a>01554             (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fdc0a98795027a9a343cb8468c2074e6">FSM_NOTIFY</a>);
<a name="l01555"></a>01555 
<a name="l01556"></a>01556             <span class="keywordflow">if</span> (<a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d826a541a6750b0ffbd4f93f5a3012d8">FSM_FINI</a>))
<a name="l01557"></a>01557                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01558"></a>01558         }
<a name="l01559"></a>01559 
<a name="l01560"></a>01560         <span class="comment">/* Flush partial sets of hard linked files. */</span>
<a name="l01561"></a>01561         <span class="keywordflow">if</span> (!(fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4490df1434a55cd7a5601d224c87857dc">CPIO_ALL_HARDLINKS</a>)) {
<a name="l01562"></a>01562             <span class="keywordtype">int</span> nlink, j;
<a name="l01563"></a>01563             <span class="keywordflow">while</span> ((fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>) != NULL) {
<a name="l01564"></a>01564                 fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>;
<a name="l01565"></a>01565                 fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = NULL;
<a name="l01566"></a>01566 
<a name="l01567"></a>01567                 <span class="comment">/* Re-calculate link count for archive header. */</span>
<a name="l01568"></a>01568                 <span class="keywordflow">for</span> (j = -1, nlink = 0, i = 0; i &lt; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#92ac50d8eb3f05209d1000c9ab92b868">nlink</a>; i++) {
<a name="l01569"></a>01569                     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] &lt; 0)
<a name="l01570"></a>01570                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l01571"></a>01571                     nlink++;
<a name="l01572"></a>01572                     if (j == -1) j = i;
<a name="l01573"></a>01573                 }
<a name="l01574"></a>01574                 <span class="comment">/* XXX force the contents out as well. */</span>
<a name="l01575"></a>01575 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01576"></a>01576                 <span class="keywordflow">if</span> (j != 0) {
<a name="l01577"></a>01577                     fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[0] = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[j];
<a name="l01578"></a>01578                     fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[j] = -1;
<a name="l01579"></a>01579                 }
<a name="l01580"></a>01580 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01581"></a>01581                 fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a>.st_nlink = nlink;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                 fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#34097a8f320a4f5ae20f44a49ab91b54">sb</a>;  <span class="comment">/* structure assignment */</span>
<a name="l01584"></a>01584                 fsm-&gt;<a class="code" href="structfsm__s.html#83fece2a7d788502e4dd0baeec0c8cca">osb</a> = fsm-&gt;<a class="code" href="structfsm__s.html#de612c70c6544f5ed9c89a0bc6841508">sb</a>;     <span class="comment">/* structure assignment */</span>
<a name="l01585"></a>01585 
<a name="l01586"></a>01586                 <span class="keywordflow">if</span> (!rc) rc = <a class="code" href="group__payload.html#g6d1cb6cacbb90223510503fa6eca9b72" title="Write set of linked files to payload stream.">writeLinkedFile</a>(fsm);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588                 fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = <a class="code" href="group__payload.html#g9ab8b32638e9b9bce798ff8a8cdb100f" title="Destroy set of hard links.">freeHardLink</a>(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>);
<a name="l01589"></a>01589             }
<a name="l01590"></a>01590         }
<a name="l01591"></a>01591 
<a name="l01592"></a>01592         <span class="keywordflow">if</span> (!rc)
<a name="l01593"></a>01593             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ec358073676159e71d37a4747146640c">FSM_TRAILER</a>);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595         <span class="keywordflow">break</span>;
<a name="l01596"></a>01596     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526995a48127c97a657880f596f22570a2">FSM_CREATE</a>:
<a name="l01597"></a>01597         {   <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm);
<a name="l01598"></a>01598 <span class="preprocessor">#define _tsmask (RPMTRANS_FLAG_PKGCOMMIT | RPMTRANS_FLAG_COMMIT)</span>
<a name="l01599"></a>01599 <span class="preprocessor"></span>            fsm-&gt;<a class="code" href="structfsm__s.html#62591602c46d2d47a11e4801528a5d7a">commit</a> = ((ts &amp;&amp; (<a class="code" href="group__rpmts.html#g4e8995f22601eb9d5d3e264fa005e167" title="Get transaction flags, i.e.">rpmtsFlags</a>(ts) &amp; <a class="code" href="fsm_8c.html#1f9f6e6e1258571e9317dc47babc5bcb">_tsmask</a>) &amp;&amp;
<a name="l01600"></a>01600                         fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> != <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2d50ea36b03c8ec6dc6c2b5a47cba46">FSM_PKGCOMMIT</a>) ? 0 : 1);
<a name="l01601"></a>01601 <span class="preprocessor">#undef _tsmask</span>
<a name="l01602"></a>01602 <span class="preprocessor"></span>        }
<a name="l01603"></a>01603         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01604"></a>01604         fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>);
<a name="l01605"></a>01605         fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>);
<a name="l01606"></a>01606 
<a name="l01607"></a>01607         fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>);
<a name="l01608"></a>01608         fsm-&gt;<a class="code" href="structfsm__s.html#07c4694a0eda6c7499f0c6ca93d946c7">ldnalloc</a> = fsm-&gt;<a class="code" href="structfsm__s.html#b7eb1cf93112a4176d06f1500b6af98c">ldnlen</a> = 0;
<a name="l01609"></a>01609 
<a name="l01610"></a>01610         fsm-&gt;<a class="code" href="structfsm__s.html#d7e0ca496c45215523bf2420f8469df1">rdsize</a> = fsm-&gt;<a class="code" href="structfsm__s.html#594282d7683026aaf732d781efd2de7a">wrsize</a> = 0;
<a name="l01611"></a>01611         fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a> = fsm-&gt;<a class="code" href="structfsm__s.html#434196418c8f7646fb47fb3fde6a73ea">rdb</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#434196418c8f7646fb47fb3fde6a73ea">rdb</a>);
<a name="l01612"></a>01612         fsm-&gt;<a class="code" href="structfsm__s.html#97573f2ed933fc8fe4e450c825b41a42">wrbuf</a> = fsm-&gt;<a class="code" href="structfsm__s.html#1e7f881fefc1aec48465c39f2e4e4bb7">wrb</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#1e7f881fefc1aec48465c39f2e4e4bb7">wrb</a>);
<a name="l01613"></a>01613         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> || fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>) {
<a name="l01614"></a>01614             fsm-&gt;<a class="code" href="structfsm__s.html#d7e0ca496c45215523bf2420f8469df1">rdsize</a> = 8 * BUFSIZ;
<a name="l01615"></a>01615             fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a> = fsm-&gt;<a class="code" href="structfsm__s.html#434196418c8f7646fb47fb3fde6a73ea">rdb</a> = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(fsm-&gt;<a class="code" href="structfsm__s.html#d7e0ca496c45215523bf2420f8469df1">rdsize</a>);
<a name="l01616"></a>01616             fsm-&gt;<a class="code" href="structfsm__s.html#594282d7683026aaf732d781efd2de7a">wrsize</a> = 8 * BUFSIZ;
<a name="l01617"></a>01617             fsm-&gt;<a class="code" href="structfsm__s.html#97573f2ed933fc8fe4e450c825b41a42">wrbuf</a> = fsm-&gt;<a class="code" href="structfsm__s.html#1e7f881fefc1aec48465c39f2e4e4bb7">wrb</a> = <a class="code" href="system_8h.html#2ff4ef58da7e543466e75f20f2a2d8b7">xmalloc</a>(fsm-&gt;<a class="code" href="structfsm__s.html#594282d7683026aaf732d781efd2de7a">wrsize</a>);
<a name="l01618"></a>01618         }
<a name="l01619"></a>01619 
<a name="l01620"></a>01620         fsm-&gt;<a class="code" href="structfsm__s.html#9d974694b4fb0371e0971307cf7811ab">mkdirsdone</a> = 0;
<a name="l01621"></a>01621         fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = -1;
<a name="l01622"></a>01622         fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a> = NULL;
<a name="l01623"></a>01623         fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = NULL;
<a name="l01624"></a>01624         <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = 0;      <span class="comment">/* XXX get rid of EBADF */</span>
<a name="l01625"></a>01625 
<a name="l01626"></a>01626         <span class="comment">/* Detect and create directories not explicitly in package. */</span>
<a name="l01627"></a>01627         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) {
<a name="l01628"></a>01628 <span class="comment">/*@-compdef@*/</span>
<a name="l01629"></a>01629             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452cb03d554c418cea506c948af046f819c">FSM_MKDIRS</a>);
<a name="l01630"></a>01630 <span class="comment">/*@=compdef@*/</span>
<a name="l01631"></a>01631             <span class="keywordflow">if</span> (!rc) fsm-&gt;<a class="code" href="structfsm__s.html#9d974694b4fb0371e0971307cf7811ab">mkdirsdone</a> = 1;
<a name="l01632"></a>01632         }
<a name="l01633"></a>01633 
<a name="l01634"></a>01634         <span class="keywordflow">break</span>;
<a name="l01635"></a>01635     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d577ae52b65607332e43f7dd9aa68f55">FSM_INIT</a>:
<a name="l01636"></a>01636         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01637"></a>01637         fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a> = 0;
<a name="l01638"></a>01638         fsm-&gt;<a class="code" href="structfsm__s.html#71fc2d6d86c8e2e8510d5fbd24289985">diskchecked</a> = fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 0;
<a name="l01639"></a>01639         fsm-&gt;<a class="code" href="structfsm__s.html#38c9ded5d4c71f23d5752dfdb658c57c">subdir</a> = NULL;
<a name="l01640"></a>01640         fsm-&gt;<a class="code" href="structfsm__s.html#bdc06f0fea77931224a320be06315c3c">suffix</a> = (fsm-&gt;<a class="code" href="structfsm__s.html#19740d94560dc4b38c782d8246a3c832">sufbuf</a>[0] != <span class="charliteral">'\0'</span> ? fsm-&gt;<a class="code" href="structfsm__s.html#19740d94560dc4b38c782d8246a3c832">sufbuf</a> : NULL);
<a name="l01641"></a>01641         fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a> = <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9921def1a5a9da9556fbaa0120e3e18c3">FA_UNKNOWN</a>;
<a name="l01642"></a>01642         fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a> = NULL;
<a name="l01643"></a>01643         fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a> = NULL;
<a name="l01644"></a>01644 
<a name="l01645"></a>01645         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) {
<a name="l01646"></a>01646             <span class="comment">/* Read next header from payload, checking for end-of-payload. */</span>
<a name="l01647"></a>01647             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45271dd6f1508bddc83c67798efaa8a58b7">FSM_NEXT</a>);
<a name="l01648"></a>01648         }
<a name="l01649"></a>01649         <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l01650"></a>01650 
<a name="l01651"></a>01651         <span class="comment">/* Identify mapping index. */</span>
<a name="l01652"></a>01652         fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = ((fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l01653"></a>01653                 ? <a class="code" href="group__payload.html#gdffbdd1164605996bec9620e6acbe8b1" title="Locate archive path in file info.">mapFind</a>(fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a>, fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>) : <a class="code" href="group__payload.html#gc3e7c71c0c5c6614af0567c5d986843d" title="Return next index into file info.">mapNextIterator</a>(fsm-&gt;<a class="code" href="structfsm__s.html#6a8b9404d4b8b6f4fed0afdd36bb39a5">iter</a>));
<a name="l01654"></a>01654 
<a name="l01655"></a>01655         <span class="comment">/* Detect end-of-loop and/or mapping error. */</span>
<a name="l01656"></a>01656         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> &lt; 0) {
<a name="l01657"></a>01657             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) {
<a name="l01658"></a>01658 <span class="preprocessor">#if 0</span>
<a name="l01659"></a>01659 <span class="preprocessor"></span>                <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#0429b81ac9dd6a698b6da81be7e9a0b3">RPMMESS_WARNING</a>,
<a name="l01660"></a>01660                     <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"archive file %s was not found in header file list\n"</span>),
<a name="l01661"></a>01661                         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01662"></a>01662 <span class="preprocessor">#endif</span>
<a name="l01663"></a>01663 <span class="preprocessor"></span><span class="comment">/*@-boundswrite@*/</span>
<a name="l01664"></a>01664                 <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> &amp;&amp; *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> == NULL)
<a name="l01665"></a>01665                     *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01666"></a>01666 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01667"></a>01667                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e37d6e755048522b400ae4a83c27044fd">CPIOERR_UNMAPPED_FILE</a>;
<a name="l01668"></a>01668             } <span class="keywordflow">else</span> {
<a name="l01669"></a>01669                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ead49a14963256f34f3409ee294f239f2">CPIOERR_HDR_TRAILER</a>;
<a name="l01670"></a>01670             }
<a name="l01671"></a>01671             <span class="keywordflow">break</span>;
<a name="l01672"></a>01672         }
<a name="l01673"></a>01673 
<a name="l01674"></a>01674         <span class="comment">/* On non-install, mode must be known so that dirs don't get suffix. */</span>
<a name="l01675"></a>01675         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> != <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) {
<a name="l01676"></a>01676             <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l01677"></a>01677             st-&gt;st_mode = fi-&gt;fmodes[fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>];
<a name="l01678"></a>01678         }
<a name="l01679"></a>01679 
<a name="l01680"></a>01680         <span class="comment">/* Generate file path. */</span>
<a name="l01681"></a>01681         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>);
<a name="l01682"></a>01682         <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684         <span class="comment">/* Perform lstat/stat for disk file. */</span>
<a name="l01685"></a>01685 <span class="preprocessor">#ifdef  NOTYET</span>
<a name="l01686"></a>01686 <span class="preprocessor"></span>        rc = fsmStat(fsm);
<a name="l01687"></a>01687 <span class="preprocessor">#else</span>
<a name="l01688"></a>01688 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> != NULL &amp;&amp;
<a name="l01689"></a>01689             !(fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> &amp;&amp; S_ISREG(st-&gt;st_mode)))
<a name="l01690"></a>01690         {
<a name="l01691"></a>01691             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, (!(fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f42df34a484b9284f89e51b601daf02fd1">CPIO_FOLLOW_SYMLINKS</a>)
<a name="l01692"></a>01692                         ? <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c14737c46922fefb101602543a0ddacb">FSM_LSTAT</a> : <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527cff4f22668fe661b791651fea2f1dab">FSM_STAT</a>));
<a name="l01693"></a>01693             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>) {
<a name="l01694"></a>01694                 <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l01695"></a>01695                 rc = 0;
<a name="l01696"></a>01696                 fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 0;
<a name="l01697"></a>01697             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == 0) {
<a name="l01698"></a>01698                 fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 1;
<a name="l01699"></a>01699             }
<a name="l01700"></a>01700         } <span class="keywordflow">else</span> {
<a name="l01701"></a>01701             <span class="comment">/* Skip %ghost files on build. */</span>
<a name="l01702"></a>01702             fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> = 0;
<a name="l01703"></a>01703         }
<a name="l01704"></a>01704 <span class="preprocessor">#endif</span>
<a name="l01705"></a>01705 <span class="preprocessor"></span>        fsm-&gt;<a class="code" href="structfsm__s.html#71fc2d6d86c8e2e8510d5fbd24289985">diskchecked</a> = 1;
<a name="l01706"></a>01706         <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l01707"></a>01707 
<a name="l01708"></a>01708         <span class="comment">/* On non-install, the disk file stat is what's remapped. */</span>
<a name="l01709"></a>01709 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01710"></a>01710         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> != <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l01711"></a>01711             *st = *ost;                 <span class="comment">/* structure assignment */</span>
<a name="l01712"></a>01712 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01713"></a>01713 
<a name="l01714"></a>01714         <span class="comment">/* Remap file perms, owner, and group. */</span>
<a name="l01715"></a>01715         rc = <a class="code" href="fsm_8c.html#224238bdc8ab4145c31943f6ddf2e3fb" title="Map file stat(2) info.">fsmMapAttrs</a>(fsm);
<a name="l01716"></a>01716         <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718         fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a> = <a class="code" href="rpmlib_8h.html#2ed895afbe3c80bdfb7275869c487104">XFA_SKIPPING</a>(fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a>);
<a name="l01719"></a>01719         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> || fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>) {
<a name="l01720"></a>01720             <span class="comment">/*@-evalorder@*/</span> <span class="comment">/* FIX: saveHardLink can modify fsm */</span>
<a name="l01721"></a>01721             <span class="keywordflow">if</span> (!S_ISDIR(st-&gt;st_mode) &amp;&amp; st-&gt;st_nlink &gt; 1)
<a name="l01722"></a>01722                 fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a> = <a class="code" href="group__payload.html#gb91f1cf1a421c6c9c565ec9a4f45b658" title="Save hard link in chain.">saveHardLink</a>(fsm);
<a name="l01723"></a>01723             <span class="comment">/*@=evalorder@*/</span>
<a name="l01724"></a>01724         }
<a name="l01725"></a>01725         <span class="keywordflow">break</span>;
<a name="l01726"></a>01726     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452cc786b61ee1bd2df93850e09f613d805">FSM_PRE</a>:
<a name="l01727"></a>01727         <span class="keywordflow">break</span>;
<a name="l01728"></a>01728     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>:
<a name="l01729"></a>01729         rc = <a class="code" href="fsm_8c.html#b5ec0917e40a7ef6bf78edc5ffdde5bd" title="Map next file path and action.">fsmMapPath</a>(fsm);
<a name="l01730"></a>01730         <span class="keywordflow">break</span>;
<a name="l01731"></a>01731     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452cb03d554c418cea506c948af046f819c">FSM_MKDIRS</a>:
<a name="l01732"></a>01732         rc = <a class="code" href="fsm_8c.html#cd6276d038e9954be2d0970550895f97" title="Create (if necessary) directories not explicitly included in package.">fsmMkdirs</a>(fsm);
<a name="l01733"></a>01733         <span class="keywordflow">break</span>;
<a name="l01734"></a>01734     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4524f000e0f91eb552a4272c8373d2d71f7">FSM_RMDIRS</a>:
<a name="l01735"></a>01735         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#14244d35b6446e0c0dbcc0375745f8b3">dnlx</a>)
<a name="l01736"></a>01736             rc = <a class="code" href="fsm_8c.html#f893f0155c89e2cb44e61687b612d38e" title="Remove (if created) directories not explicitly included in package.">fsmRmdirs</a>(fsm);
<a name="l01737"></a>01737         <span class="keywordflow">break</span>;
<a name="l01738"></a>01738     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525ce36da107c022e04c43298a1af3a007">FSM_PROCESS</a>:
<a name="l01739"></a>01739         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a>) {
<a name="l01740"></a>01740             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l01741"></a>01741                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527f80e6c393aa30330ed52aec1ab1a663">FSM_EAT</a>);
<a name="l01742"></a>01742             <span class="keywordflow">break</span>;
<a name="l01743"></a>01743         }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>) {
<a name="l01746"></a>01746             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6335f6224b7feb336e31d32d2b65e0cdf2">RPMFILE_GHOST</a>) <span class="comment">/* XXX Don't if %ghost file. */</span>
<a name="l01747"></a>01747                 <span class="keywordflow">break</span>;
<a name="l01748"></a>01748             <span class="keywordflow">if</span> (!S_ISDIR(st-&gt;st_mode) &amp;&amp; st-&gt;st_nlink &gt; 1) {
<a name="l01749"></a>01749                 <span class="keyword">struct </span><a class="code" href="structhardLink__s.html" title="Keeps track of the set of all hard links to a file in an archive.">hardLink_s</a> * li, * prev;
<a name="l01750"></a>01750 
<a name="l01751"></a>01751 <span class="keywordflow">if</span> (!(fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4490df1434a55cd7a5601d224c87857dc">CPIO_ALL_HARDLINKS</a>)) <span class="keywordflow">break</span>;
<a name="l01752"></a>01752                 rc = <a class="code" href="group__payload.html#g6d1cb6cacbb90223510503fa6eca9b72" title="Write set of linked files to payload stream.">writeLinkedFile</a>(fsm);
<a name="l01753"></a>01753                 <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;  <span class="comment">/* W2DO? */</span>
<a name="l01754"></a>01754 
<a name="l01755"></a>01755                 <span class="keywordflow">for</span> (li = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>, prev = NULL; li; prev = li, li = li-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>)
<a name="l01756"></a>01756                      <span class="keywordflow">if</span> (li == fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>)
<a name="l01757"></a>01757                         <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01758"></a>01758 
<a name="l01759"></a>01759                 <span class="keywordflow">if</span> (prev == NULL)
<a name="l01760"></a>01760                     fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>;
<a name="l01761"></a>01761                 <span class="keywordflow">else</span>
<a name="l01762"></a>01762                     prev-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>;
<a name="l01763"></a>01763                 fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = NULL;
<a name="l01764"></a>01764                 fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = <a class="code" href="group__payload.html#g9ab8b32638e9b9bce798ff8a8cdb100f" title="Destroy set of hard links.">freeHardLink</a>(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>);
<a name="l01765"></a>01765             } <span class="keywordflow">else</span> {
<a name="l01766"></a>01766                 rc = <a class="code" href="group__payload.html#gb228a1a0b6d1189f881ca1a0b0c87926" title="Write next item to payload stream.">writeFile</a>(fsm, 1);
<a name="l01767"></a>01767             }
<a name="l01768"></a>01768             <span class="keywordflow">break</span>;
<a name="l01769"></a>01769         }
<a name="l01770"></a>01770 
<a name="l01771"></a>01771         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> != <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l01772"></a>01772             <span class="keywordflow">break</span>;
<a name="l01773"></a>01773 
<a name="l01774"></a>01774         <span class="keywordflow">if</span> (S_ISREG(st-&gt;st_mode)) {
<a name="l01775"></a>01775             <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01776"></a>01776             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a>)
<a name="l01777"></a>01777                 fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, NULL, NULL);
<a name="l01778"></a>01778             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780             <span class="keywordflow">if</span> (rc == 0 &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a>) {
<a name="l01781"></a>01781                 <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmtool_8c.html#388b138a2eef245efa264b879f68f826">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>;
<a name="l01782"></a>01782                 fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01783"></a>01783                 fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, NULL, fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a>);
<a name="l01784"></a>01784                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45294461187651e936e67ceb6192674fed7">FSM_RENAME</a>);
<a name="l01785"></a>01785                 <span class="keywordflow">if</span> (!rc)
<a name="l01786"></a>01786                     <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#0429b81ac9dd6a698b6da81be7e9a0b3">RPMMESS_WARNING</a>,
<a name="l01787"></a>01787                         <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s saved as %s\n"</span>),
<a name="l01788"></a>01788                                 (fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> : <span class="stringliteral">""</span>),
<a name="l01789"></a>01789                                 (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> : <span class="stringliteral">""</span>));
<a name="l01790"></a>01790                 fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01791"></a>01791                 fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = opath;
<a name="l01792"></a>01792             }
<a name="l01793"></a>01793 
<a name="l01794"></a>01794             <span class="comment">/*@-dependenttrans@*/</span>
<a name="l01795"></a>01795             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l01796"></a>01796             <span class="comment">/*@=dependenttrans@*/</span>
<a name="l01797"></a>01797             <span class="keywordflow">if</span> (!(rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>)) <span class="keywordflow">return</span> rc;
<a name="l01798"></a>01798             rc = <a class="code" href="group__payload.html#g3a1b3d636ff257e751ef5c5139ca29ca" title="Create file from payload stream.">expandRegular</a>(fsm);
<a name="l01799"></a>01799         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISDIR(st-&gt;st_mode)) {
<a name="l01800"></a>01800             mode_t st_mode = st-&gt;st_mode;
<a name="l01801"></a>01801             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>);
<a name="l01802"></a>01802             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>) {
<a name="l01803"></a>01803                 st-&gt;st_mode &amp;= ~07777;          <span class="comment">/* XXX abuse st-&gt;st_mode */</span>
<a name="l01804"></a>01804                 st-&gt;st_mode |=  00700;
<a name="l01805"></a>01805                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452521a68c56ac73d1ff02e904d90492cce">FSM_MKDIR</a>);
<a name="l01806"></a>01806                 st-&gt;st_mode = st_mode;          <span class="comment">/* XXX restore st-&gt;st_mode */</span>
<a name="l01807"></a>01807             }
<a name="l01808"></a>01808         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(st-&gt;st_mode)) {
<a name="l01809"></a>01809             <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmtool_8c.html#388b138a2eef245efa264b879f68f826">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>;
<a name="l01810"></a>01810 
<a name="l01811"></a>01811             <span class="keywordflow">if</span> ((st-&gt;st_size + 1) &gt; fsm-&gt;<a class="code" href="structfsm__s.html#d7e0ca496c45215523bf2420f8469df1">rdsize</a>) {
<a name="l01812"></a>01812                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e7552686b53ad8e2c0fe8abf5f2604902">CPIOERR_HDR_SIZE</a>;
<a name="l01813"></a>01813                 <span class="keywordflow">break</span>;
<a name="l01814"></a>01814             }
<a name="l01815"></a>01815 
<a name="l01816"></a>01816             fsm-&gt;<a class="code" href="structfsm__s.html#db95b796b713d812d21309d1ab93a089">wrlen</a> = st-&gt;st_size;
<a name="l01817"></a>01817             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fedb55217c2d9644549604f2d8f37ea1">FSM_DREAD</a>);
<a name="l01818"></a>01818             <span class="keywordflow">if</span> (!rc &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#0bca6f694fbca882933fd96be8ead40c">rdnb</a> != fsm-&gt;<a class="code" href="structfsm__s.html#db95b796b713d812d21309d1ab93a089">wrlen</a>)
<a name="l01819"></a>01819                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ecb820fe707edd24483b8d8ed6b90e06f">CPIOERR_READ_FAILED</a>;
<a name="l01820"></a>01820             <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l01821"></a>01821 
<a name="l01822"></a>01822 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01823"></a>01823             fsm-&gt;<a class="code" href="structfsm__s.html#97573f2ed933fc8fe4e450c825b41a42">wrbuf</a>[st-&gt;st_size] = <span class="charliteral">'\0'</span>;
<a name="l01824"></a>01824 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01825"></a>01825             <span class="comment">/* XXX symlink(fsm-&gt;opath, fsm-&gt;path) */</span>
<a name="l01826"></a>01826             <span class="comment">/*@-dependenttrans@*/</span>
<a name="l01827"></a>01827             fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#97573f2ed933fc8fe4e450c825b41a42">wrbuf</a>;
<a name="l01828"></a>01828             <span class="comment">/*@=dependenttrans@*/</span>
<a name="l01829"></a>01829             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>);
<a name="l01830"></a>01830             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>)
<a name="l01831"></a>01831                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527293c5fdad84817bac9ccd2482aeb2a6">FSM_SYMLINK</a>);
<a name="l01832"></a>01832             fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = opath;         <span class="comment">/* XXX restore fsm-&gt;path */</span>
<a name="l01833"></a>01833         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISFIFO(st-&gt;st_mode)) {
<a name="l01834"></a>01834             mode_t st_mode = st-&gt;st_mode;
<a name="l01835"></a>01835             <span class="comment">/* This mimics cpio S_ISSOCK() behavior but probably isnt' right */</span>
<a name="l01836"></a>01836             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>);
<a name="l01837"></a>01837             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>) {
<a name="l01838"></a>01838                 st-&gt;st_mode = 0000;             <span class="comment">/* XXX abuse st-&gt;st_mode */</span>
<a name="l01839"></a>01839                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ced8ea36357942863a1bf05fb8d8a7d7">FSM_MKFIFO</a>);
<a name="l01840"></a>01840                 st-&gt;st_mode = st_mode;  <span class="comment">/* XXX restore st-&gt;st_mode */</span>
<a name="l01841"></a>01841             }
<a name="l01842"></a>01842         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISCHR(st-&gt;st_mode) ||
<a name="l01843"></a>01843                    S_ISBLK(st-&gt;st_mode) ||
<a name="l01844"></a>01844     <span class="comment">/*@-unrecog@*/</span> <a class="code" href="system_8h.html#d02743d5133f96f162b88ce2f6406cfc">S_ISSOCK</a>(st-&gt;st_mode) <span class="comment">/*@=unrecog@*/</span>)
<a name="l01845"></a>01845         {
<a name="l01846"></a>01846             rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>);
<a name="l01847"></a>01847             <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>)
<a name="l01848"></a>01848                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452af927b348c046422ada46fd0c9206748">FSM_MKNOD</a>);
<a name="l01849"></a>01849         } <span class="keywordflow">else</span> {
<a name="l01850"></a>01850             <span class="comment">/* XXX Special case /dev/log, which shouldn't be packaged anyways */</span>
<a name="l01851"></a>01851             <span class="keywordflow">if</span> (!<a class="code" href="fsm_8c.html#5390c8ef669a0ca7dfc2b5a843bd3566">IS_DEV_LOG</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>))
<a name="l01852"></a>01852                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e92ac2f69e7bcd41f4e7ce0d6fbb6dc90">CPIOERR_UNKNOWN_FILETYPE</a>;
<a name="l01853"></a>01853         }
<a name="l01854"></a>01854         <span class="keywordflow">if</span> (!S_ISDIR(st-&gt;st_mode) &amp;&amp; st-&gt;st_nlink &gt; 1) {
<a name="l01855"></a>01855             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#8e26ef91a7b84a55308456007f54dcb9">createdPath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#c5e41b006a6a3b4effea6f17fdf2e790">linkIndex</a>;
<a name="l01856"></a>01856             rc = <a class="code" href="group__payload.html#g79aa14b1856aa8e461249eceae17de59" title="Create pending hard links to existing file.">fsmMakeLinks</a>(fsm);
<a name="l01857"></a>01857         }
<a name="l01858"></a>01858         <span class="keywordflow">break</span>;
<a name="l01859"></a>01859     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45262f0fec43f8bb4411961acf383d8a86b">FSM_POST</a>:
<a name="l01860"></a>01860         <span class="keywordflow">break</span>;
<a name="l01861"></a>01861     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fef2b4b17cf9c2b2c127b2e2461b2a5a">FSM_MKLINKS</a>:
<a name="l01862"></a>01862         rc = <a class="code" href="group__payload.html#g79aa14b1856aa8e461249eceae17de59" title="Create pending hard links to existing file.">fsmMakeLinks</a>(fsm);
<a name="l01863"></a>01863         <span class="keywordflow">break</span>;
<a name="l01864"></a>01864     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fdc0a98795027a9a343cb8468c2074e6">FSM_NOTIFY</a>:            <span class="comment">/* XXX move from fsm to psm -&gt; tsm */</span>
<a name="l01865"></a>01865         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> || fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>) {
<a name="l01866"></a>01866             <a class="code" href="rpmlib_8h.html#35d575e76e47e498176ffb43c6bd7fcb" title="The RPM Transaction Set.">rpmts</a> ts = <a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm);
<a name="l01867"></a>01867             <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l01868"></a>01868             <span class="keywordtype">void</span> * ptr;
<a name="l01869"></a>01869             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> archivePos = <a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;<a class="code" href="structfsm__s.html#521fa5b84ca52d34c3392cded706b059">cfd</a>);
<a name="l01870"></a>01870             <span class="keywordflow">if</span> (archivePos &gt; fi-&gt;archivePos) {
<a name="l01871"></a>01871                 fi-&gt;archivePos = archivePos;
<a name="l01872"></a>01872                 ptr = <a class="code" href="rpmts_8c.html#ed33324d0c6a4d1d6c3961caf112ee0c" title="Perform transaction progress notify callback.">rpmtsNotify</a>(ts, fi-&gt;te, <a class="code" href="rpmmessages_8h.html#ee1ee0900a6f9abe699d626b5490c4e3f2472ce803fbc31360ecd0bca1d3a844">RPMCALLBACK_INST_PROGRESS</a>,
<a name="l01873"></a>01873                         fi-&gt;archivePos, fi-&gt;archiveSize);
<a name="l01874"></a>01874             }
<a name="l01875"></a>01875         }
<a name="l01876"></a>01876         <span class="keywordflow">break</span>;
<a name="l01877"></a>01877     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2932debdd2a3b0b0fe86dbc86b1e873">FSM_UNDO</a>:
<a name="l01878"></a>01878         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a>)
<a name="l01879"></a>01879             <span class="keywordflow">break</span>;
<a name="l01880"></a>01880         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>) {
<a name="l01881"></a>01881             (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm,
<a name="l01882"></a>01882                 (S_ISDIR(st-&gt;st_mode) ? <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520cab91415883e1a21162dd617bdcd6da">FSM_RMDIR</a> : <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d1a3135381df0b67e4f43242aeb2e0f9">FSM_UNLINK</a>));
<a name="l01883"></a>01883 
<a name="l01884"></a>01884 <span class="preprocessor">#ifdef  NOTYET  </span><span class="comment">/* XXX remove only dirs just created, not all. */</span>
<a name="l01885"></a>01885             <span class="keywordflow">if</span> (fsm-&gt;dnlx)
<a name="l01886"></a>01886                 (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4524f000e0f91eb552a4272c8373d2d71f7">FSM_RMDIRS</a>);
<a name="l01887"></a>01887 <span class="preprocessor">#endif</span>
<a name="l01888"></a>01888 <span class="preprocessor"></span>            <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l01889"></a>01889         }
<a name="l01890"></a>01890 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01891"></a>01891         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> &amp;&amp; *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> == NULL)
<a name="l01892"></a>01892             *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = <a class="code" href="system_8h.html#700bf3013e33311eacdd1f20d13bdc9a">xstrdup</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01893"></a>01893 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01894"></a>01894         <span class="keywordflow">break</span>;
<a name="l01895"></a>01895     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d826a541a6750b0ffbd4f93f5a3012d8">FSM_FINI</a>:
<a name="l01896"></a>01896         <span class="keywordflow">if</span> (!fsm-&gt;<a class="code" href="structfsm__s.html#2b802a54628c71070bcbdbf195b05774">postpone</a> &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#62591602c46d2d47a11e4801528a5d7a">commit</a>) {
<a name="l01897"></a>01897             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>)
<a name="l01898"></a>01898                 rc = ((!S_ISDIR(st-&gt;st_mode) &amp;&amp; st-&gt;st_nlink &gt; 1)
<a name="l01899"></a>01899                         ? <a class="code" href="group__payload.html#g20c401dca511eb11b6ddaec3a8e97643" title="Commit hard linked file set atomically.">fsmCommitLinks</a>(fsm) : <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520a6c510c2b2b3cad342aafd895103e50">FSM_COMMIT</a>));
<a name="l01900"></a>01900             <span class="keywordflow">if</span> (fsm-&gt;goal == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2d50ea36b03c8ec6dc6c2b5a47cba46">FSM_PKGCOMMIT</a>)
<a name="l01901"></a>01901                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520a6c510c2b2b3cad342aafd895103e50">FSM_COMMIT</a>);
<a name="l01902"></a>01902             <span class="keywordflow">if</span> (fsm-&gt;goal == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45279fcf20c3562c3fb85220d2c46d098a3">FSM_PKGERASE</a>)
<a name="l01903"></a>01903                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520a6c510c2b2b3cad342aafd895103e50">FSM_COMMIT</a>);
<a name="l01904"></a>01904         }
<a name="l01905"></a>01905         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01906"></a>01906         fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>);
<a name="l01907"></a>01907 <span class="comment">/*@-boundswrite@*/</span>
<a name="l01908"></a>01908         memset(st, 0, <span class="keyword">sizeof</span>(*st));
<a name="l01909"></a>01909         memset(ost, 0, <span class="keyword">sizeof</span>(*ost));
<a name="l01910"></a>01910 <span class="comment">/*@=boundswrite@*/</span>
<a name="l01911"></a>01911         <span class="keywordflow">break</span>;
<a name="l01912"></a>01912     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520a6c510c2b2b3cad342aafd895103e50">FSM_COMMIT</a>:
<a name="l01913"></a>01913         <span class="comment">/* Rename pre-existing modified or unmanaged file. */</span>
<a name="l01914"></a>01914         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a> &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#71fc2d6d86c8e2e8510d5fbd24289985">diskchecked</a> &amp;&amp;
<a name="l01915"></a>01915           (fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a> || (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> &amp;&amp; S_ISREG(st-&gt;st_mode))))
<a name="l01916"></a>01916         {
<a name="l01917"></a>01917             <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmtool_8c.html#388b138a2eef245efa264b879f68f826">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>;
<a name="l01918"></a>01918             <span class="keyword">const</span> <span class="keywordtype">char</span> * path = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01919"></a>01919             fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, NULL, NULL);
<a name="l01920"></a>01920             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, NULL, fsm-&gt;<a class="code" href="structfsm__s.html#48911584061f7350d13f7e09b58ff600">osuffix</a>);
<a name="l01921"></a>01921             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45294461187651e936e67ceb6192674fed7">FSM_RENAME</a>);
<a name="l01922"></a>01922             <span class="keywordflow">if</span> (!rc) {
<a name="l01923"></a>01923                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#0429b81ac9dd6a698b6da81be7e9a0b3">RPMMESS_WARNING</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s saved as %s\n"</span>),
<a name="l01924"></a>01924                                 (fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> : <span class="stringliteral">""</span>),
<a name="l01925"></a>01925                                 (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> : <span class="stringliteral">""</span>));
<a name="l01926"></a>01926             }
<a name="l01927"></a>01927             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01928"></a>01928             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l01929"></a>01929             fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>);
<a name="l01930"></a>01930             fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = opath;
<a name="l01931"></a>01931         }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933         <span class="comment">/* Remove erased files. */</span>
<a name="l01934"></a>01934         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45279fcf20c3562c3fb85220d2c46d098a3">FSM_PKGERASE</a>) {
<a name="l01935"></a>01935             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#8738330190b12493d542d3deced64f19">action</a> == <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef96d7eb8b200bfb8a40319085ee6cda356">FA_ERASE</a>) {
<a name="l01936"></a>01936                 <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l01937"></a>01937                 <span class="keywordflow">if</span> (S_ISDIR(st-&gt;st_mode)) {
<a name="l01938"></a>01938                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520cab91415883e1a21162dd617bdcd6da">FSM_RMDIR</a>);
<a name="l01939"></a>01939                     <span class="keywordflow">if</span> (!rc) <span class="keywordflow">break</span>;
<a name="l01940"></a>01940                     <span class="keywordflow">switch</span> (rc) {
<a name="l01941"></a>01941                     <span class="keywordflow">case</span> <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>: <span class="comment">/* XXX rmdir("/") linux 2.2.x kernel hack */</span>
<a name="l01942"></a>01942                     <span class="keywordflow">case</span> <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e2f2b6f9348148b69b04fa21a245b7b92">CPIOERR_ENOTEMPTY</a>:
<a name="l01943"></a>01943         <span class="comment">/* XXX make sure that build side permits %missingok on directories. */</span>
<a name="l01944"></a>01944                         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6364dd4b075b80d72ff5e066d9f1cbf6ad">RPMFILE_MISSINGOK</a>)
<a name="l01945"></a>01945                             <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01946"></a>01946 
<a name="l01947"></a>01947                         <span class="comment">/* XXX common error message. */</span>
<a name="l01948"></a>01948                         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(
<a name="l01949"></a>01949                             (<a class="code" href="fsm_8c.html#b5626c987420c6ab48ddb9541d6a5181">strict_erasures</a> ? <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba1825e6210e500fcdae8bedca3f156bc6">RPMERR_RMDIR</a> : <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66bafdbd0501e7aeaca8eb9c30830f59e87c">RPMDEBUG_RMDIR</a>),
<a name="l01950"></a>01950                             <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s rmdir of %s failed: Directory not empty\n"</span>), 
<a name="l01951"></a>01951                                 <a class="code" href="rpmfi_8c.html#25c70b5c766baaa6ec72b11bd49c34e3" title="Return formatted string representation of package disposition.">rpmfiTypeString</a>(fi), fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l01952"></a>01952                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01953"></a>01953                     <span class="keywordflow">default</span>:
<a name="l01954"></a>01954                         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(
<a name="l01955"></a>01955                             (<a class="code" href="fsm_8c.html#b5626c987420c6ab48ddb9541d6a5181">strict_erasures</a> ? <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba1825e6210e500fcdae8bedca3f156bc6">RPMERR_RMDIR</a> : RPMDEBUG_RMDIR),
<a name="l01956"></a>01956                                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s rmdir of %s failed: %s\n"</span>),
<a name="l01957"></a>01957                                 <a class="code" href="rpmfi_8c.html#25c70b5c766baaa6ec72b11bd49c34e3" title="Return formatted string representation of package disposition.">rpmfiTypeString</a>(fi), fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l01958"></a>01958                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01959"></a>01959                     }
<a name="l01960"></a>01960                 } <span class="keywordflow">else</span> {
<a name="l01961"></a>01961                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d1a3135381df0b67e4f43242aeb2e0f9">FSM_UNLINK</a>);
<a name="l01962"></a>01962                     <span class="keywordflow">if</span> (!rc) <span class="keywordflow">break</span>;
<a name="l01963"></a>01963                     <span class="keywordflow">switch</span> (rc) {
<a name="l01964"></a>01964                     <span class="keywordflow">case</span> <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>:
<a name="l01965"></a>01965                         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e448550aa4921a9641de5ecfd573f696">fflags</a> &amp; <a class="code" href="rpmlib_8h.html#a971f2ba87d2d6dad4105eac2499df6364dd4b075b80d72ff5e066d9f1cbf6ad">RPMFILE_MISSINGOK</a>)
<a name="l01966"></a>01966                             <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01967"></a>01967                         <span class="comment">/*@fallthrough@*/</span>
<a name="l01968"></a>01968                     <span class="keywordflow">default</span>:
<a name="l01969"></a>01969                         <a class="code" href="rpmerr_8h.html#9c6d3f4067f89d2ef665ced76617e0cf" title="Retrofit rpmError() onto rpmlog sub-system.">rpmError</a>(
<a name="l01970"></a>01970                             (<a class="code" href="fsm_8c.html#b5626c987420c6ab48ddb9541d6a5181">strict_erasures</a> ? <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba84e3836c5d67506a1f6e5817dd0d114b">RPMERR_UNLINK</a> : <a class="code" href="rpmerr_8h.html#c60d8521276534617d1a659f5b1b66ba11ddb3139d92103aecba84e89d0d1d80">RPMDEBUG_UNLINK</a>),
<a name="l01971"></a>01971                                 <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s unlink of %s failed: %s\n"</span>),
<a name="l01972"></a>01972                                 <a class="code" href="rpmfi_8c.html#25c70b5c766baaa6ec72b11bd49c34e3" title="Return formatted string representation of package disposition.">rpmfiTypeString</a>(fi), fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>, <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a>));
<a name="l01973"></a>01973                         <span class="comment">/*@innerbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l01974"></a>01974                     }
<a name="l01975"></a>01975                 }
<a name="l01976"></a>01976             }
<a name="l01977"></a>01977             <span class="comment">/* XXX Failure to remove is not (yet) cause for failure. */</span>
<a name="l01978"></a>01978             <span class="keywordflow">if</span> (!<a class="code" href="fsm_8c.html#b5626c987420c6ab48ddb9541d6a5181">strict_erasures</a>) rc = 0;
<a name="l01979"></a>01979             <span class="keywordflow">break</span>;
<a name="l01980"></a>01980         }
<a name="l01981"></a>01981 
<a name="l01982"></a>01982         <span class="comment">/* XXX Special case /dev/log, which shouldn't be packaged anyways */</span>
<a name="l01983"></a>01983         <span class="keywordflow">if</span> (!<a class="code" href="system_8h.html#d02743d5133f96f162b88ce2f6406cfc">S_ISSOCK</a>(st-&gt;st_mode) &amp;&amp; !<a class="code" href="fsm_8c.html#5390c8ef669a0ca7dfc2b5a843bd3566">IS_DEV_LOG</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>)) {
<a name="l01984"></a>01984             <span class="comment">/* Rename temporary to final file name. */</span>
<a name="l01985"></a>01985             <span class="keywordflow">if</span> (!S_ISDIR(st-&gt;st_mode) &amp;&amp;
<a name="l01986"></a>01986                 (fsm-&gt;<a class="code" href="structfsm__s.html#38c9ded5d4c71f23d5752dfdb658c57c">subdir</a> || fsm-&gt;<a class="code" href="structfsm__s.html#bdc06f0fea77931224a320be06315c3c">suffix</a> || fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>))
<a name="l01987"></a>01987             {
<a name="l01988"></a>01988                 fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l01989"></a>01989                 fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, NULL, fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>);
<a name="l01990"></a>01990                 rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45294461187651e936e67ceb6192674fed7">FSM_RENAME</a>);
<a name="l01991"></a>01991                 <span class="keywordflow">if</span> (!rc &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#92563cc2bc5b0cb15008508f6883c726">nsuffix</a>) {
<a name="l01992"></a>01992                     <span class="keyword">const</span> <span class="keywordtype">char</span> * <a class="code" href="rpmtool_8c.html#388b138a2eef245efa264b879f68f826">opath</a> = <a class="code" href="group__payload.html#g8b014cfd9fa8c05f42626c6c8c5b307d" title="Build path to file from file info, ornamented with subdir and suffix.">fsmFsPath</a>(fsm, st, NULL, NULL);
<a name="l01993"></a>01993                     <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#0429b81ac9dd6a698b6da81be7e9a0b3">RPMMESS_WARNING</a>, <a class="code" href="system_8h.html#2ec2c1c3098396e2d147d58b66f18ceb">_</a>(<span class="stringliteral">"%s created as %s\n"</span>),
<a name="l01994"></a>01994                                 (opath ? opath : <span class="stringliteral">""</span>),
<a name="l01995"></a>01995                                 (fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> ? fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> : <span class="stringliteral">""</span>));
<a name="l01996"></a>01996                     opath = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(opath);
<a name="l01997"></a>01997                 }
<a name="l01998"></a>01998                 fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a>);
<a name="l01999"></a>01999             }
<a name="l02000"></a>02000             <span class="comment">/*</span>
<a name="l02001"></a>02001 <span class="comment">             * Set file security context (if not disabled).</span>
<a name="l02002"></a>02002 <span class="comment">             */</span>
<a name="l02003"></a>02003             <span class="keywordflow">if</span> (!rc &amp;&amp; !getuid()) {
<a name="l02004"></a>02004                 rc = <a class="code" href="fsm_8c.html#cc6456db2a1c0155226b18fe0d343079">fsmMapFContext</a>(fsm);
<a name="l02005"></a>02005                 <span class="keywordflow">if</span> (!rc)
<a name="l02006"></a>02006                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452132ce1a922a82ca3e960345881777552">FSM_LSETFCON</a>);
<a name="l02007"></a>02007                 fsm-&gt;<a class="code" href="structfsm__s.html#8a6d2ebc58958db0a15386a5fa9d0b5d">fcontext</a> = NULL;
<a name="l02008"></a>02008             }
<a name="l02009"></a>02009             <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(st-&gt;st_mode)) {
<a name="l02010"></a>02010                 <span class="keywordflow">if</span> (!rc &amp;&amp; !getuid())
<a name="l02011"></a>02011                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209c6764827ee34202e3b3fdeccf43770">FSM_LCHOWN</a>);
<a name="l02012"></a>02012             } <span class="keywordflow">else</span> {
<a name="l02013"></a>02013                 <span class="keywordflow">if</span> (!rc &amp;&amp; !getuid())
<a name="l02014"></a>02014                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45245e109a6453f7b699a2519833fd0a84b">FSM_CHOWN</a>);
<a name="l02015"></a>02015                 <span class="keywordflow">if</span> (!rc)
<a name="l02016"></a>02016                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45205b438ddf396dce086c825b5eb4a0133">FSM_CHMOD</a>);
<a name="l02017"></a>02017                 <span class="keywordflow">if</span> (!rc) {
<a name="l02018"></a>02018                     time_t mtime = st-&gt;st_mtime;
<a name="l02019"></a>02019                     <a class="code" href="rpmlib_8h.html#2f4e0bf6f106ed6889162837ce39b83e" title="File info tag sets from a header, so that a header can be discarded early.">rpmfi</a> fi = <a class="code" href="fsm_8c.html#a372483e106d9a40cdff9929008331a3" title="Retrieve transaction element file info from file state machine iterator.">fsmGetFi</a>(fsm);
<a name="l02020"></a>02020                     <span class="keywordflow">if</span> (fi-&gt;fmtimes)
<a name="l02021"></a>02021                         st-&gt;st_mtime = fi-&gt;fmtimes[fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a>];
<a name="l02022"></a>02022                     rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c7077e4163914aa9516bb6634d41463d">FSM_UTIME</a>);
<a name="l02023"></a>02023                     st-&gt;st_mtime = mtime;
<a name="l02024"></a>02024                 }
<a name="l02025"></a>02025             }
<a name="l02026"></a>02026         }
<a name="l02027"></a>02027 
<a name="l02028"></a>02028         <span class="comment">/* Notify on success. */</span>
<a name="l02029"></a>02029         <span class="keywordflow">if</span> (!rc)                rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fdc0a98795027a9a343cb8468c2074e6">FSM_NOTIFY</a>);
<a name="l02030"></a>02030         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> &amp;&amp; *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> == NULL) {
<a name="l02031"></a>02031 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02032"></a>02032             *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l02033"></a>02033 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02034"></a>02034             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l02035"></a>02035         }
<a name="l02036"></a>02036         <span class="keywordflow">break</span>;
<a name="l02037"></a>02037     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45241ef66ff78867ee0e0bab88c2d973294">FSM_DESTROY</a>:
<a name="l02038"></a>02038         fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>);
<a name="l02039"></a>02039 
<a name="l02040"></a>02040         <span class="comment">/* Check for hard links missing from payload. */</span>
<a name="l02041"></a>02041         <span class="keywordflow">while</span> ((fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a>) != NULL) {
<a name="l02042"></a>02042             fsm-&gt;<a class="code" href="structfsm__s.html#9923f2496ae16b8718572332413a5bd2">links</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a>;
<a name="l02043"></a>02043             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#f2b5bcfebe6d160398d1a1cf64672987">next</a> = NULL;
<a name="l02044"></a>02044             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a> &amp;&amp;
<a name="l02045"></a>02045                         fsm-&gt;<a class="code" href="structfsm__s.html#62591602c46d2d47a11e4801528a5d7a">commit</a> &amp;&amp; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>)
<a name="l02046"></a>02046             {
<a name="l02047"></a>02047                 <span class="keywordflow">for</span> (i = 0 ; i &lt; fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#99373767a1b9c1f5d59bcbb4c53fe34c">linksLeft</a>; i++) {
<a name="l02048"></a>02048                     <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i] &lt; 0)
<a name="l02049"></a>02049                         <span class="comment">/*@innercontinue@*/</span> <span class="keywordflow">continue</span>;
<a name="l02050"></a>02050                     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2eb2ee20a3391f8f40bcfb2feee21ec081">CPIOERR_MISSING_HARDLINK</a>;
<a name="l02051"></a>02051                     if (fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> &amp;&amp; *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> == NULL) {
<a name="l02052"></a>02052                         fsm-&gt;<a class="code" href="structfsm__s.html#6408bf167eb6b839047232ef79eeabb6">ix</a> = fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>-&gt;<a class="code" href="structhardLink__s.html#9704cd34607276c7bb62783049eb3939">filex</a>[i];
<a name="l02053"></a>02053                         if (!<a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>)) {
<a name="l02054"></a>02054 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02055"></a>02055                             *fsm-&gt;<a class="code" href="structfsm__s.html#e637338122e5f69e7617e78801a65ec1">failedFile</a> = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l02056"></a>02056 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02057"></a>02057                             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = NULL;
<a name="l02058"></a>02058                         }
<a name="l02059"></a>02059                     }
<a name="l02060"></a>02060                     <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02061"></a>02061                 }
<a name="l02062"></a>02062             }
<a name="l02063"></a>02063             <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#b911195806b74a4d1ebecd761e3ac50e">goal</a> == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a> &amp;&amp;
<a name="l02064"></a>02064                 (fsm-&gt;<a class="code" href="structfsm__s.html#78a39892188ca1fc9966f0b2e621632b">mapFlags</a> &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f4490df1434a55cd7a5601d224c87857dc">CPIO_ALL_HARDLINKS</a>))
<a name="l02065"></a>02065             {
<a name="l02066"></a>02066                 rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2eb2ee20a3391f8f40bcfb2feee21ec081">CPIOERR_MISSING_HARDLINK</a>;
<a name="l02067"></a>02067             }
<a name="l02068"></a>02068             fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a> = <a class="code" href="group__payload.html#g9ab8b32638e9b9bce798ff8a8cdb100f" title="Destroy set of hard links.">freeHardLink</a>(fsm-&gt;<a class="code" href="structfsm__s.html#d67f19f0203f0f98b1ee14cbb9ada6d8">li</a>);
<a name="l02069"></a>02069         }
<a name="l02070"></a>02070         fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#84a074d7b5c96ae3baf2319f99cfdd3b">ldn</a>);
<a name="l02071"></a>02071         fsm-&gt;<a class="code" href="structfsm__s.html#07c4694a0eda6c7499f0c6ca93d946c7">ldnalloc</a> = fsm-&gt;<a class="code" href="structfsm__s.html#b7eb1cf93112a4176d06f1500b6af98c">ldnlen</a> = 0;
<a name="l02072"></a>02072         fsm-&gt;<a class="code" href="structfsm__s.html#90ba4541201d857cd1d74baa92e92462">rdbuf</a> = fsm-&gt;<a class="code" href="structfsm__s.html#434196418c8f7646fb47fb3fde6a73ea">rdb</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#434196418c8f7646fb47fb3fde6a73ea">rdb</a>);
<a name="l02073"></a>02073         fsm-&gt;<a class="code" href="structfsm__s.html#97573f2ed933fc8fe4e450c825b41a42">wrbuf</a> = fsm-&gt;<a class="code" href="structfsm__s.html#1e7f881fefc1aec48465c39f2e4e4bb7">wrb</a> = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;<a class="code" href="structfsm__s.html#1e7f881fefc1aec48465c39f2e4e4bb7">wrb</a>);
<a name="l02074"></a>02074         <span class="keywordflow">break</span>;
<a name="l02075"></a>02075     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>:
<a name="l02076"></a>02076         <span class="keywordflow">if</span> (fsm-&gt;<a class="code" href="structfsm__s.html#71fc2d6d86c8e2e8510d5fbd24289985">diskchecked</a> &amp;&amp; !fsm-&gt;<a class="code" href="structfsm__s.html#c38c066b82f56be503243b1250b5f291">exists</a>) {
<a name="l02077"></a>02077             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>;
<a name="l02078"></a>02078             <span class="keywordflow">break</span>;
<a name="l02079"></a>02079         }
<a name="l02080"></a>02080         <span class="keywordflow">if</span> (S_ISREG(st-&gt;st_mode)) {
<a name="l02081"></a>02081             <span class="keywordtype">char</span> * path = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(strlen(fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>) + <span class="keyword">sizeof</span>(<span class="stringliteral">"-RPMDELETE"</span>));
<a name="l02082"></a>02082 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02083"></a>02083             (void) <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(path, fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>), <span class="stringliteral">"-RPMDELETE"</span>);
<a name="l02084"></a>02084 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02085"></a>02085             <span class="comment">/*</span>
<a name="l02086"></a>02086 <span class="comment">             * XXX HP-UX (and other os'es) don't permit unlink on busy</span>
<a name="l02087"></a>02087 <span class="comment">             * XXX files.</span>
<a name="l02088"></a>02088 <span class="comment">             */</span>
<a name="l02089"></a>02089             fsm-&gt;<a class="code" href="structfsm__s.html#e02ed137d755961ad2649e0c4e5b16d4">opath</a> = fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a>;
<a name="l02090"></a>02090             fsm-&gt;<a class="code" href="structfsm__s.html#badf4f6472b5d2a0ccd9924eb510b308">path</a> = path;
<a name="l02091"></a>02091             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45294461187651e936e67ceb6192674fed7">FSM_RENAME</a>);
<a name="l02092"></a>02092             <span class="keywordflow">if</span> (!rc)
<a name="l02093"></a>02093                     (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d1a3135381df0b67e4f43242aeb2e0f9">FSM_UNLINK</a>);
<a name="l02094"></a>02094             <span class="keywordflow">else</span>
<a name="l02095"></a>02095                     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e5b65782bb44a2decdb59d4963d516252">CPIOERR_UNLINK_FAILED</a>;
<a name="l02096"></a>02096             fsm-&gt;path = fsm-&gt;opath;
<a name="l02097"></a>02097             fsm-&gt;opath = NULL;
<a name="l02098"></a>02098             <span class="keywordflow">return</span> (rc ? rc : <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>);  <span class="comment">/* XXX HACK */</span>
<a name="l02099"></a>02099             <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l02100"></a>02100         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISDIR(st-&gt;st_mode)) {
<a name="l02101"></a>02101             <span class="keywordflow">if</span> (S_ISDIR(ost-&gt;st_mode))          <span class="keywordflow">return</span> 0;
<a name="l02102"></a>02102             <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(ost-&gt;st_mode)) {
<a name="l02103"></a>02103                 rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527cff4f22668fe661b791651fea2f1dab">FSM_STAT</a>);
<a name="l02104"></a>02104                 <span class="keywordflow">if</span> (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>) rc = 0;
<a name="l02105"></a>02105                 <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l02106"></a>02106                 <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l02107"></a>02107                 <span class="keywordflow">if</span> (S_ISDIR(ost-&gt;st_mode))      <span class="keywordflow">return</span> 0;
<a name="l02108"></a>02108             }
<a name="l02109"></a>02109         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(st-&gt;st_mode)) {
<a name="l02110"></a>02110             <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#1761a975a2e376bb6d46e68544fe831e">S_ISLNK</a>(ost-&gt;st_mode)) {
<a name="l02111"></a>02111         <span class="comment">/* XXX NUL terminated result in fsm-&gt;rdbuf, len in fsm-&gt;rdnb. */</span>
<a name="l02112"></a>02112                 rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525a5e162d7e218ad162e17a7a9d8cf3f1">FSM_READLINK</a>);
<a name="l02113"></a>02113                 <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l02114"></a>02114                 <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l02115"></a>02115                 <span class="keywordflow">if</span> (!strcmp(fsm-&gt;opath, fsm-&gt;rdbuf))    <span class="keywordflow">return</span> 0;
<a name="l02116"></a>02116             }
<a name="l02117"></a>02117         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISFIFO(st-&gt;st_mode)) {
<a name="l02118"></a>02118             <span class="keywordflow">if</span> (S_ISFIFO(ost-&gt;st_mode))         <span class="keywordflow">return</span> 0;
<a name="l02119"></a>02119         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (S_ISCHR(st-&gt;st_mode) || S_ISBLK(st-&gt;st_mode)) {
<a name="l02120"></a>02120             <span class="keywordflow">if</span> ((S_ISCHR(ost-&gt;st_mode) || S_ISBLK(ost-&gt;st_mode)) &amp;&amp;
<a name="l02121"></a>02121                 (ost-&gt;st_rdev == st-&gt;st_rdev))  <span class="keywordflow">return</span> 0;
<a name="l02122"></a>02122         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#d02743d5133f96f162b88ce2f6406cfc">S_ISSOCK</a>(st-&gt;st_mode)) {
<a name="l02123"></a>02123             <span class="keywordflow">if</span> (<a class="code" href="system_8h.html#d02743d5133f96f162b88ce2f6406cfc">S_ISSOCK</a>(ost-&gt;st_mode))         <span class="keywordflow">return</span> 0;
<a name="l02124"></a>02124         }
<a name="l02125"></a>02125             <span class="comment">/* XXX shouldn't do this with commit/undo. */</span>
<a name="l02126"></a>02126         rc = 0;
<a name="l02127"></a>02127         <span class="keywordflow">if</span> (fsm-&gt;stage == <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525ce36da107c022e04c43298a1af3a007">FSM_PROCESS</a>) rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d1a3135381df0b67e4f43242aeb2e0f9">FSM_UNLINK</a>);
<a name="l02128"></a>02128         <span class="keywordflow">if</span> (rc == 0)    rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>;
<a name="l02129"></a>02129         <span class="keywordflow">return</span> (rc ? rc : <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e6bb97262a2b0cb2a87ecc5e7eace5d87">CPIOERR_ENOENT</a>);      <span class="comment">/* XXX HACK */</span>
<a name="l02130"></a>02130         <span class="comment">/*@notreached@*/</span> <span class="keywordflow">break</span>;
<a name="l02131"></a>02131 
<a name="l02132"></a>02132     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d1a3135381df0b67e4f43242aeb2e0f9">FSM_UNLINK</a>:
<a name="l02133"></a>02133         <span class="keywordflow">if</span> (fsm-&gt;mapFlags &amp; <a class="code" href="group__payload.html#ggc863476fd23e3fd0af9465790169e2f40d13a3bd23b4aec9fa4ff5aaae238f24">CPIO_SBIT_CHECK</a>) {
<a name="l02134"></a>02134             <span class="keyword">struct </span>stat stb;
<a name="l02135"></a>02135             <span class="keywordflow">if</span> (<a class="code" href="rpmio_8h.html#ee2e08f0e6b4ae4b948c20020760a449" title="lstat(2) clone.">Lstat</a>(fsm-&gt;path, &amp;stb) == 0 &amp;&amp; S_ISREG(stb.st_mode) &amp;&amp; (stb.st_mode &amp; 06000) != 0)
<a name="l02136"></a>02136                 chmod(fsm-&gt;path, stb.st_mode &amp; 0777);
<a name="l02137"></a>02137         }
<a name="l02138"></a>02138         rc = <a class="code" href="rpmio_8h.html#1c789f4e5cf1fb0106ec85ebad2406ad" title="unlink(2) clone.">Unlink</a>(fsm-&gt;path);
<a name="l02139"></a>02139         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; <a class="code" href="fsm_8h.html#3223a4205dcc762e115d79397f4791c1">FSM_SYSCALL</a>))
<a name="l02140"></a>02140             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(<a class="code" href="rpmmessages_8h.html#05acba3911e7862348a0810fcfba3dea">RPMMESS_DEBUG</a>, <span class="stringliteral">" %8s (%s) %s\n"</span>, cur,
<a name="l02141"></a>02141                 fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02142"></a>02142         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l02143"></a>02143             rc = (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == ENOENT ? CPIOERR_ENOENT : <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e5b65782bb44a2decdb59d4963d516252">CPIOERR_UNLINK_FAILED</a>);
<a name="l02144"></a>02144         <span class="keywordflow">break</span>;
<a name="l02145"></a>02145     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45294461187651e936e67ceb6192674fed7">FSM_RENAME</a>:
<a name="l02146"></a>02146         rc = <a class="code" href="rpmio_8h.html#95f4c89827f6555eba20d2eb2f955d7a" title="rename(2) clone.">Rename</a>(fsm-&gt;opath, fsm-&gt;path);
<a name="l02147"></a>02147 <span class="preprocessor">#if defined(ETXTBSY)</span>
<a name="l02148"></a>02148 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (rc &amp;&amp; errno == ETXTBSY) {
<a name="l02149"></a>02149             <span class="keywordtype">char</span> * path = <a class="code" href="system_8h.html#58ff5c3142f685bf7e95cc0cbfaf49c9">alloca</a>(strlen(fsm-&gt;path) + <span class="keyword">sizeof</span>(<span class="stringliteral">"-RPMDELETE"</span>));
<a name="l02150"></a>02150             (void) <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>( <a class="code" href="system_8h.html#58841684f76853b313e27e663c850381">stpcpy</a>(path, fsm-&gt;path), <span class="stringliteral">"-RPMDELETE"</span>);
<a name="l02151"></a>02151             <span class="comment">/*</span>
<a name="l02152"></a>02152 <span class="comment">             * XXX HP-UX (and other os'es) don't permit rename to busy</span>
<a name="l02153"></a>02153 <span class="comment">             * XXX files.</span>
<a name="l02154"></a>02154 <span class="comment">             */</span>
<a name="l02155"></a>02155             rc = <a class="code" href="rpmio_8h.html#95f4c89827f6555eba20d2eb2f955d7a" title="rename(2) clone.">Rename</a>(fsm-&gt;path, path);
<a name="l02156"></a>02156             <span class="keywordflow">if</span> (!rc) rc = <a class="code" href="rpmio_8h.html#95f4c89827f6555eba20d2eb2f955d7a" title="rename(2) clone.">Rename</a>(fsm-&gt;opath, fsm-&gt;path);
<a name="l02157"></a>02157         }
<a name="l02158"></a>02158 <span class="preprocessor">#endif</span>
<a name="l02159"></a>02159 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02160"></a>02160             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %s) %s\n"</span>, cur,
<a name="l02161"></a>02161                 fsm-&gt;opath, fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02162"></a>02162         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e1a4230f664367a2c3a8d84559020fdce">CPIOERR_RENAME_FAILED</a>;
<a name="l02163"></a>02163         <span class="keywordflow">break</span>;
<a name="l02164"></a>02164     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452521a68c56ac73d1ff02e904d90492cce">FSM_MKDIR</a>:
<a name="l02165"></a>02165         rc = <a class="code" href="rpmio_8h.html#4faa989db577f600d6a7ffdc73d779e6" title="mkdir(2) clone.">Mkdir</a>(fsm-&gt;path, (st-&gt;st_mode &amp; 07777));
<a name="l02166"></a>02166         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02167"></a>02167             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, 0%04o) %s\n"</span>, cur,
<a name="l02168"></a>02168                 fsm-&gt;path, (<span class="keywordtype">unsigned</span>)(st-&gt;st_mode &amp; 07777),
<a name="l02169"></a>02169                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02170"></a>02170         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ed2fda7fdbb23d86ff74dcb26abfc57a6">CPIOERR_MKDIR_FAILED</a>;
<a name="l02171"></a>02171         <span class="keywordflow">break</span>;
<a name="l02172"></a>02172     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520cab91415883e1a21162dd617bdcd6da">FSM_RMDIR</a>:
<a name="l02173"></a>02173         rc = <a class="code" href="rpmio_8h.html#3e95a5143035de193cb66cc52486683d" title="rmdir(2) clone.">Rmdir</a>(fsm-&gt;path);
<a name="l02174"></a>02174         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02175"></a>02175             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s) %s\n"</span>, cur,
<a name="l02176"></a>02176                 fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02177"></a>02177         <span class="keywordflow">if</span> (rc &lt; 0)
<a name="l02178"></a>02178             <span class="keywordflow">switch</span> (errno) {
<a name="l02179"></a>02179             <span class="keywordflow">case</span> ENOENT:        rc = CPIOERR_ENOENT;    <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02180"></a>02180             <span class="keywordflow">case</span> ENOTEMPTY:     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e2f2b6f9348148b69b04fa21a245b7b92">CPIOERR_ENOTEMPTY</a>; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02181"></a>02181             <span class="keywordflow">default</span>:            rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e3d817496c227983a181bb965b02c4125">CPIOERR_RMDIR_FAILED</a>; <span class="comment">/*@switchbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02182"></a>02182             }
<a name="l02183"></a>02183         <span class="keywordflow">break</span>;
<a name="l02184"></a>02184     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452132ce1a922a82ca3e960345881777552">FSM_LSETFCON</a>:
<a name="l02185"></a>02185         <span class="keywordflow">if</span> (fsm-&gt;fcontext == NULL || *fsm-&gt;fcontext == <span class="charliteral">'\0'</span>
<a name="l02186"></a>02186          || !strcmp(fsm-&gt;fcontext, <span class="stringliteral">"&lt;&lt;none&gt;&gt;"</span>))
<a name="l02187"></a>02187             <span class="keywordflow">break</span>;
<a name="l02188"></a>02188         rc = <a class="code" href="system_8h.html#f62ff34a6a872e5f623e55d274d0dded">lsetfilecon</a>(fsm-&gt;path, (<a class="code" href="system_8h.html#7cb29f84b9b9b1042bb9d0de949f888b">security_context_t</a>)fsm-&gt;fcontext);
<a name="l02189"></a>02189         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02190"></a>02190             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %s) %s\n"</span>, cur,
<a name="l02191"></a>02191                 fsm-&gt;path, fsm-&gt;fcontext,
<a name="l02192"></a>02192                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02193"></a>02193         <span class="keywordflow">if</span> (rc &lt; 0) rc = (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == EOPNOTSUPP ? 0 : <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e07dca272a26b01cf3e7e051aa46a8513">CPIOERR_LSETFCON_FAILED</a>);
<a name="l02194"></a>02194         <span class="keywordflow">break</span>;
<a name="l02195"></a>02195     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45245e109a6453f7b699a2519833fd0a84b">FSM_CHOWN</a>:
<a name="l02196"></a>02196         rc = chown(fsm-&gt;path, st-&gt;st_uid, st-&gt;st_gid);
<a name="l02197"></a>02197         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02198"></a>02198             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %d, %d) %s\n"</span>, cur,
<a name="l02199"></a>02199                 fsm-&gt;path, (<span class="keywordtype">int</span>)st-&gt;st_uid, (<span class="keywordtype">int</span>)st-&gt;st_gid,
<a name="l02200"></a>02200                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02201"></a>02201         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2edc43c00d2ce573743077e525c8ee68b3">CPIOERR_CHOWN_FAILED</a>;
<a name="l02202"></a>02202         <span class="keywordflow">break</span>;
<a name="l02203"></a>02203     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209c6764827ee34202e3b3fdeccf43770">FSM_LCHOWN</a>:
<a name="l02204"></a>02204 <span class="preprocessor">#if ! CHOWN_FOLLOWS_SYMLINK</span>
<a name="l02205"></a>02205 <span class="preprocessor"></span>        rc = <a class="code" href="system_8h.html#58a5296ac5f8410c5939ed463ec3640e">lchown</a>(fsm-&gt;path, st-&gt;st_uid, st-&gt;st_gid);
<a name="l02206"></a>02206         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02207"></a>02207             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %d, %d) %s\n"</span>, cur,
<a name="l02208"></a>02208                 fsm-&gt;path, (<span class="keywordtype">int</span>)st-&gt;st_uid, (<span class="keywordtype">int</span>)st-&gt;st_gid,
<a name="l02209"></a>02209                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02210"></a>02210         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2edc43c00d2ce573743077e525c8ee68b3">CPIOERR_CHOWN_FAILED</a>;
<a name="l02211"></a>02211 <span class="preprocessor">#endif</span>
<a name="l02212"></a>02212 <span class="preprocessor"></span>        <span class="keywordflow">break</span>;
<a name="l02213"></a>02213     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45205b438ddf396dce086c825b5eb4a0133">FSM_CHMOD</a>:
<a name="l02214"></a>02214         rc = chmod(fsm-&gt;path, (st-&gt;st_mode &amp; 07777));
<a name="l02215"></a>02215         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02216"></a>02216             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, 0%04o) %s\n"</span>, cur,
<a name="l02217"></a>02217                 fsm-&gt;path, (<span class="keywordtype">unsigned</span>)(st-&gt;st_mode &amp; 07777),
<a name="l02218"></a>02218                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02219"></a>02219         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e040d2d8a2e9f42d5dac7fe26eab48892">CPIOERR_CHMOD_FAILED</a>;
<a name="l02220"></a>02220         <span class="keywordflow">break</span>;
<a name="l02221"></a>02221     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c7077e4163914aa9516bb6634d41463d">FSM_UTIME</a>:
<a name="l02222"></a>02222         {   <span class="keyword">struct </span>utimbuf stamp;
<a name="l02223"></a>02223             stamp.actime = st-&gt;st_mtime;
<a name="l02224"></a>02224             stamp.modtime = st-&gt;st_mtime;
<a name="l02225"></a>02225             rc = utime(fsm-&gt;path, &amp;stamp);
<a name="l02226"></a>02226             <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02227"></a>02227                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, 0x%x) %s\n"</span>, cur,
<a name="l02228"></a>02228                         fsm-&gt;path, (<span class="keywordtype">unsigned</span>)st-&gt;st_mtime,
<a name="l02229"></a>02229                         (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02230"></a>02230             <span class="keywordflow">if</span> (rc &lt; 0) rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e1e3b66871224aac3bc02873a84a4be07">CPIOERR_UTIME_FAILED</a>;
<a name="l02231"></a>02231         }
<a name="l02232"></a>02232         <span class="keywordflow">break</span>;
<a name="l02233"></a>02233     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527293c5fdad84817bac9ccd2482aeb2a6">FSM_SYMLINK</a>:
<a name="l02234"></a>02234         rc = symlink(fsm-&gt;opath, fsm-&gt;path);
<a name="l02235"></a>02235         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02236"></a>02236             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %s) %s\n"</span>, cur,
<a name="l02237"></a>02237                 fsm-&gt;opath, fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02238"></a>02238         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ea07a78f4a1fce2d987ee14d5dda85d8f">CPIOERR_SYMLINK_FAILED</a>;
<a name="l02239"></a>02239         <span class="keywordflow">break</span>;
<a name="l02240"></a>02240     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452e4050a267ba77b53c5ce751062f3f0c9">FSM_LINK</a>:
<a name="l02241"></a>02241         rc = <a class="code" href="rpmio_8h.html#1767e54708ad399474a2d13d2c96cdd5" title="link(2) clone.">Link</a>(fsm-&gt;opath, fsm-&gt;path);
<a name="l02242"></a>02242         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02243"></a>02243             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %s) %s\n"</span>, cur,
<a name="l02244"></a>02244                 fsm-&gt;opath, fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02245"></a>02245         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e2676b4b84f9181f5f552b9becbe60097">CPIOERR_LINK_FAILED</a>;
<a name="l02246"></a>02246         <span class="keywordflow">break</span>;
<a name="l02247"></a>02247     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ced8ea36357942863a1bf05fb8d8a7d7">FSM_MKFIFO</a>:
<a name="l02248"></a>02248         rc = mkfifo(fsm-&gt;path, (st-&gt;st_mode &amp; 07777));
<a name="l02249"></a>02249         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02250"></a>02250             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, 0%04o) %s\n"</span>, cur,
<a name="l02251"></a>02251                 fsm-&gt;path, (<span class="keywordtype">unsigned</span>)(st-&gt;st_mode &amp; 07777),
<a name="l02252"></a>02252                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02253"></a>02253         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ea3cd2a89a57bbcae50c7b47ffdfb8cbf">CPIOERR_MKFIFO_FAILED</a>;
<a name="l02254"></a>02254         <span class="keywordflow">break</span>;
<a name="l02255"></a>02255     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452af927b348c046422ada46fd0c9206748">FSM_MKNOD</a>:
<a name="l02256"></a>02256         <span class="comment">/*@-unrecog -portability @*/</span> <span class="comment">/* FIX: check S_IFIFO or dev != 0 */</span>
<a name="l02257"></a>02257         rc = mknod(fsm-&gt;path, (st-&gt;st_mode &amp; ~07777), st-&gt;st_rdev);
<a name="l02258"></a>02258         <span class="comment">/*@=unrecog =portability @*/</span>
<a name="l02259"></a>02259         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02260"></a>02260             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, 0%o, 0x%x) %s\n"</span>, cur,
<a name="l02261"></a>02261                 fsm-&gt;path, (<span class="keywordtype">unsigned</span>)(st-&gt;st_mode &amp; ~07777),
<a name="l02262"></a>02262                 (<span class="keywordtype">unsigned</span>)st-&gt;st_rdev,
<a name="l02263"></a>02263                 (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02264"></a>02264         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e922dfaaa522313a0a3168fcb6ad30653">CPIOERR_MKNOD_FAILED</a>;
<a name="l02265"></a>02265         <span class="keywordflow">break</span>;
<a name="l02266"></a>02266     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c14737c46922fefb101602543a0ddacb">FSM_LSTAT</a>:
<a name="l02267"></a>02267         rc = <a class="code" href="rpmio_8h.html#ee2e08f0e6b4ae4b948c20020760a449" title="lstat(2) clone.">Lstat</a>(fsm-&gt;path, ost);
<a name="l02268"></a>02268         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL) &amp;&amp; rc &amp;&amp; errno != ENOENT)
<a name="l02269"></a>02269             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, ost) %s\n"</span>, cur,
<a name="l02270"></a>02270                 fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02271"></a>02271         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02272"></a>02272             rc = (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == ENOENT ? CPIOERR_ENOENT : <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e04062662959eacf4abb420b0c29e0a2b">CPIOERR_LSTAT_FAILED</a>);
<a name="l02273"></a>02273             memset(ost, 0, <span class="keyword">sizeof</span>(*ost));       <span class="comment">/* XXX s390x hackery */</span>
<a name="l02274"></a>02274         }
<a name="l02275"></a>02275         <span class="keywordflow">break</span>;
<a name="l02276"></a>02276     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527cff4f22668fe661b791651fea2f1dab">FSM_STAT</a>:
<a name="l02277"></a>02277         rc = <a class="code" href="rpmio_8h.html#dc0189fecdf5b08ae2d6b7c7f7906f87" title="stat(2) clone.">Stat</a>(fsm-&gt;path, ost);
<a name="l02278"></a>02278         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL) &amp;&amp; rc &amp;&amp; errno != ENOENT)
<a name="l02279"></a>02279             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, ost) %s\n"</span>, cur,
<a name="l02280"></a>02280                 fsm-&gt;path, (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02281"></a>02281         <span class="keywordflow">if</span> (rc &lt; 0) {
<a name="l02282"></a>02282             rc = (<a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> == ENOENT ? CPIOERR_ENOENT : <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e7286fa2d91982f974bea5359c99ad3d2">CPIOERR_STAT_FAILED</a>);
<a name="l02283"></a>02283             memset(ost, 0, <span class="keyword">sizeof</span>(*ost));       <span class="comment">/* XXX s390x hackery */</span>
<a name="l02284"></a>02284         }
<a name="l02285"></a>02285         <span class="keywordflow">break</span>;
<a name="l02286"></a>02286     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525a5e162d7e218ad162e17a7a9d8cf3f1">FSM_READLINK</a>:
<a name="l02287"></a>02287         <span class="comment">/* XXX NUL terminated result in fsm-&gt;rdbuf, len in fsm-&gt;rdnb. */</span>
<a name="l02288"></a>02288 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02289"></a>02289         rc = <a class="code" href="rpmio_8h.html#c91f92d5fe048feda9fb07dfee22b625" title="readlink(2) clone.">Readlink</a>(fsm-&gt;path, fsm-&gt;rdbuf, fsm-&gt;rdsize - 1);
<a name="l02290"></a>02290 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02291"></a>02291         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02292"></a>02292             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, rdbuf, %d) %s\n"</span>, cur,
<a name="l02293"></a>02293                 fsm-&gt;path, (<span class="keywordtype">int</span>)(fsm-&gt;rdsize -1), (rc &lt; 0 ? <a class="code" href="file_8h.html#6f7232491f317029917062f23199df69">strerror</a>(errno) : <span class="stringliteral">""</span>));
<a name="l02294"></a>02294         <span class="keywordflow">if</span> (rc &lt; 0)     rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e43eba27fcdd62587d62a263ce5039ec7">CPIOERR_READLINK_FAILED</a>;
<a name="l02295"></a>02295         <span class="keywordflow">else</span> {
<a name="l02296"></a>02296             fsm-&gt;rdnb = rc;
<a name="l02297"></a>02297 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02298"></a>02298             fsm-&gt;rdbuf[fsm-&gt;rdnb] = <span class="charliteral">'\0'</span>;
<a name="l02299"></a>02299 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02300"></a>02300             rc = 0;
<a name="l02301"></a>02301         }
<a name="l02302"></a>02302         <span class="keywordflow">break</span>;
<a name="l02303"></a>02303     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fb0d58c2ef629621671ec54acf98bc4a">FSM_CHROOT</a>:
<a name="l02304"></a>02304         <span class="keywordflow">break</span>;
<a name="l02305"></a>02305 
<a name="l02306"></a>02306     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45271dd6f1508bddc83c67798efaa8a58b7">FSM_NEXT</a>:
<a name="l02307"></a>02307         rc = <a class="code" href="fsm_8c.html#25917a3a7f4e9cf8da6c994f0e6937df">fsmUNSAFE</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c84812a02ee5ae0801dfb5dd81764557">FSM_HREAD</a>);
<a name="l02308"></a>02308         <span class="keywordflow">if</span> (rc) <span class="keywordflow">break</span>;
<a name="l02309"></a>02309         <span class="keywordflow">if</span> (!strcmp(fsm-&gt;path, <a class="code" href="cpio_8h.html#3c091cfbcf3ae6d8f677e5ab9a775da3">CPIO_TRAILER</a>)) { <span class="comment">/* Detect end-of-payload. */</span>
<a name="l02310"></a>02310             fsm-&gt;path = <a class="code" href="rpmlib_8h.html#d608c2923552dbeeb832133a9a289bb7" title="Wrapper to free(3), hides const compilation noise, permit NULL, return NULL.">_free</a>(fsm-&gt;path);
<a name="l02311"></a>02311             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ead49a14963256f34f3409ee294f239f2">CPIOERR_HDR_TRAILER</a>;
<a name="l02312"></a>02312         }
<a name="l02313"></a>02313         <span class="keywordflow">if</span> (!rc)
<a name="l02314"></a>02314             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526b9e8ee4ac25c4e74fc8d394e7424b8d">FSM_POS</a>);
<a name="l02315"></a>02315         <span class="keywordflow">break</span>;
<a name="l02316"></a>02316     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527f80e6c393aa30330ed52aec1ab1a663">FSM_EAT</a>:
<a name="l02317"></a>02317         <span class="keywordflow">for</span> (<a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> = st-&gt;st_size; <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> &gt; 0; <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> -= fsm-&gt;rdnb) {
<a name="l02318"></a>02318             fsm-&gt;wrlen = (<a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> &gt; fsm-&gt;wrsize ? fsm-&gt;wrsize : <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>);
<a name="l02319"></a>02319             rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fedb55217c2d9644549604f2d8f37ea1">FSM_DREAD</a>);
<a name="l02320"></a>02320             <span class="keywordflow">if</span> (rc)
<a name="l02321"></a>02321                 <span class="comment">/*@loopbreak@*/</span> <span class="keywordflow">break</span>;
<a name="l02322"></a>02322         }
<a name="l02323"></a>02323         <span class="keywordflow">break</span>;
<a name="l02324"></a>02324     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526b9e8ee4ac25c4e74fc8d394e7424b8d">FSM_POS</a>:
<a name="l02325"></a>02325         <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> = (modulo - (<a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;cfd) % modulo)) % modulo;
<a name="l02326"></a>02326         <span class="keywordflow">if</span> (<a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>) {
<a name="l02327"></a>02327             fsm-&gt;wrlen = <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>;
<a name="l02328"></a>02328             (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fedb55217c2d9644549604f2d8f37ea1">FSM_DREAD</a>);
<a name="l02329"></a>02329         }
<a name="l02330"></a>02330         <span class="keywordflow">break</span>;
<a name="l02331"></a>02331     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d879219cd22e4c5fd9bb012cf9908ac3">FSM_PAD</a>:
<a name="l02332"></a>02332         <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a> = (modulo - (<a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;cfd) % modulo)) % modulo;
<a name="l02333"></a>02333         <span class="keywordflow">if</span> (<a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>) {
<a name="l02334"></a>02334 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02335"></a>02335             memset(fsm-&gt;rdbuf, 0, <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>);
<a name="l02336"></a>02336 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02337"></a>02337             <span class="comment">/* XXX DWRITE uses rdnb for I/O length. */</span>
<a name="l02338"></a>02338             fsm-&gt;rdnb = <a class="code" href="lparser_8c.html#868cf102388f618f100c5f68cdbdd669">left</a>;
<a name="l02339"></a>02339             (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526524a4e5d4bbbb7b0c9c134b4e558b83">FSM_DWRITE</a>);
<a name="l02340"></a>02340         }
<a name="l02341"></a>02341         <span class="keywordflow">break</span>;
<a name="l02342"></a>02342     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ec358073676159e71d37a4747146640c">FSM_TRAILER</a>:
<a name="l02343"></a>02343         rc = <a class="code" href="cpio_8c.html#9bc52ffb75ef798b4ff5a43e29df9ce1" title="Write cpio trailer.">cpioTrailerWrite</a>(fsm);
<a name="l02344"></a>02344         <span class="keywordflow">break</span>;
<a name="l02345"></a>02345     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c84812a02ee5ae0801dfb5dd81764557">FSM_HREAD</a>:
<a name="l02346"></a>02346         rc = <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526b9e8ee4ac25c4e74fc8d394e7424b8d">FSM_POS</a>);
<a name="l02347"></a>02347         <span class="keywordflow">if</span> (!rc)
<a name="l02348"></a>02348             rc = <a class="code" href="cpio_8c.html#e672b69d8e0ef099707991d463d76164" title="Read cpio header.">cpioHeaderRead</a>(fsm, st);       <span class="comment">/* Read next payload header. */</span>
<a name="l02349"></a>02349         <span class="keywordflow">break</span>;
<a name="l02350"></a>02350     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527d3ffad609d9e2aee93eea5ad12da67f">FSM_HWRITE</a>:
<a name="l02351"></a>02351         rc = <a class="code" href="cpio_8c.html#0364dffab5bf80d3afdaa841da5a497f" title="Write cpio header.">cpioHeaderWrite</a>(fsm, st);          <span class="comment">/* Write next payload header. */</span>
<a name="l02352"></a>02352         <span class="keywordflow">break</span>;
<a name="l02353"></a>02353     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fedb55217c2d9644549604f2d8f37ea1">FSM_DREAD</a>:
<a name="l02354"></a>02354 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02355"></a>02355         fsm-&gt;rdnb = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(fsm-&gt;wrbuf, <span class="keyword">sizeof</span>(*fsm-&gt;wrbuf), fsm-&gt;wrlen, fsm-&gt;cfd);
<a name="l02356"></a>02356 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02357"></a>02357         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02358"></a>02358             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %d, cfd)\trdnb %d\n"</span>,
<a name="l02359"></a>02359                 cur, (fsm-&gt;wrbuf == fsm-&gt;wrb ? <span class="stringliteral">"wrbuf"</span> : <span class="stringliteral">"mmap"</span>),
<a name="l02360"></a>02360                 (<span class="keywordtype">int</span>)fsm-&gt;wrlen, (<span class="keywordtype">int</span>)fsm-&gt;rdnb);
<a name="l02361"></a>02361         <span class="keywordflow">if</span> (fsm-&gt;rdnb != fsm-&gt;wrlen || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fsm-&gt;cfd))
<a name="l02362"></a>02362             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ecb820fe707edd24483b8d8ed6b90e06f">CPIOERR_READ_FAILED</a>;
<a name="l02363"></a>02363         <span class="keywordflow">if</span> (fsm-&gt;rdnb &gt; 0)
<a name="l02364"></a>02364             <a class="code" href="group__rpmio.html#g4f690c6f8e8816af70283a7eec02b7f5">fdSetCpioPos</a>(fsm-&gt;cfd, <a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;cfd) + fsm-&gt;rdnb);
<a name="l02365"></a>02365         <span class="keywordflow">break</span>;
<a name="l02366"></a>02366     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526524a4e5d4bbbb7b0c9c134b4e558b83">FSM_DWRITE</a>:
<a name="l02367"></a>02367         fsm-&gt;wrnb = <a class="code" href="rpmio_8c.html#0b66d10b5a0e926d57e86327f4e9dcc6" title="fwrite(3) clone.">Fwrite</a>(fsm-&gt;rdbuf, <span class="keyword">sizeof</span>(*fsm-&gt;rdbuf), fsm-&gt;rdnb, fsm-&gt;cfd);
<a name="l02368"></a>02368         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02369"></a>02369             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, %d, cfd)\twrnb %d\n"</span>,
<a name="l02370"></a>02370                 cur, (fsm-&gt;rdbuf == fsm-&gt;rdb ? <span class="stringliteral">"rdbuf"</span> : <span class="stringliteral">"mmap"</span>),
<a name="l02371"></a>02371                 (<span class="keywordtype">int</span>)fsm-&gt;rdnb, (<span class="keywordtype">int</span>)fsm-&gt;wrnb);
<a name="l02372"></a>02372         <span class="keywordflow">if</span> (fsm-&gt;rdnb != fsm-&gt;wrnb || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fsm-&gt;cfd))
<a name="l02373"></a>02373             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2eae008ca13418c1092ef0c314a8273d8d">CPIOERR_WRITE_FAILED</a>;
<a name="l02374"></a>02374         <span class="keywordflow">if</span> (fsm-&gt;wrnb &gt; 0)
<a name="l02375"></a>02375             <a class="code" href="group__rpmio.html#g4f690c6f8e8816af70283a7eec02b7f5">fdSetCpioPos</a>(fsm-&gt;cfd, <a class="code" href="group__rpmio.html#g730a48dd3865cc948ae0fc6dc03a9085">fdGetCpioPos</a>(fsm-&gt;cfd) + fsm-&gt;wrnb);
<a name="l02376"></a>02376         <span class="keywordflow">break</span>;
<a name="l02377"></a>02377 
<a name="l02378"></a>02378     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452f536b77beea08bb509ebcb64848da31c">FSM_ROPEN</a>:
<a name="l02379"></a>02379         fsm-&gt;rfd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fsm-&gt;path, <span class="stringliteral">"r.ufdio"</span>);
<a name="l02380"></a>02380         <span class="keywordflow">if</span> (fsm-&gt;rfd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fsm-&gt;rfd)) {
<a name="l02381"></a>02381             <span class="keywordflow">if</span> (fsm-&gt;rfd != NULL)       (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45224c1f08820c09b3a73cc99e96fd31561">FSM_RCLOSE</a>);
<a name="l02382"></a>02382             fsm-&gt;rfd = NULL;
<a name="l02383"></a>02383             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e27dbc04e6a7efe53ef2cf19c050aaeb7">CPIOERR_OPEN_FAILED</a>;
<a name="l02384"></a>02384             <span class="keywordflow">break</span>;
<a name="l02385"></a>02385         }
<a name="l02386"></a>02386         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02387"></a>02387             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, \"r\") rfd %p rdbuf %p\n"</span>, cur,
<a name="l02388"></a>02388                 fsm-&gt;path, fsm-&gt;rfd, fsm-&gt;rdbuf);
<a name="l02389"></a>02389         <span class="keywordflow">break</span>;
<a name="l02390"></a>02390     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ce99bb73bfc3509e90f18c53d3c3888c">FSM_READ</a>:
<a name="l02391"></a>02391 <span class="comment">/*@-boundswrite@*/</span>
<a name="l02392"></a>02392         fsm-&gt;rdnb = <a class="code" href="rpmio_8c.html#243fbe7e1cc405489b11045e43e20207" title="fread(3) clone.">Fread</a>(fsm-&gt;rdbuf, <span class="keyword">sizeof</span>(*fsm-&gt;rdbuf), fsm-&gt;rdlen, fsm-&gt;rfd);
<a name="l02393"></a>02393 <span class="comment">/*@=boundswrite@*/</span>
<a name="l02394"></a>02394         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02395"></a>02395             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (rdbuf, %d, rfd)\trdnb %d\n"</span>,
<a name="l02396"></a>02396                 cur, (<span class="keywordtype">int</span>)fsm-&gt;rdlen, (<span class="keywordtype">int</span>)fsm-&gt;rdnb);
<a name="l02397"></a>02397         <span class="keywordflow">if</span> (fsm-&gt;rdnb != fsm-&gt;rdlen || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fsm-&gt;rfd))
<a name="l02398"></a>02398             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ecb820fe707edd24483b8d8ed6b90e06f">CPIOERR_READ_FAILED</a>;
<a name="l02399"></a>02399         <span class="keywordflow">break</span>;
<a name="l02400"></a>02400     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45224c1f08820c09b3a73cc99e96fd31561">FSM_RCLOSE</a>:
<a name="l02401"></a>02401         <span class="keywordflow">if</span> (fsm-&gt;rfd != NULL) {
<a name="l02402"></a>02402             <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02403"></a>02403                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%p)\n"</span>, cur, fsm-&gt;rfd);
<a name="l02404"></a>02404             (void) <a class="code" href="group__rpmio.html#gf04f16c173697f5e1853472a5f46e3e9" title="Sum statistic counters.">rpmswAdd</a>(<a class="code" href="rpmts_8c.html#c92276220455cb91448e333fd510e346" title="Retrieve operation timestamp from a transaction set.">rpmtsOp</a>(<a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm), <a class="code" href="rpmts_8h.html#00f4ef6cc440476d7078471b8921d7b412f181b0a1d83657264275005c18ef28">RPMTS_OP_DIGEST</a>),
<a name="l02405"></a>02405                         <a class="code" href="group__rpmio.html#ge3f5abab135dae9c547c505016169954">fdstat_op</a>(fsm-&gt;rfd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd132288e1057056fe7b878d817eaf76bd6e">FDSTAT_DIGEST</a>));
<a name="l02406"></a>02406             (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fsm-&gt;rfd);
<a name="l02407"></a>02407             <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l02408"></a>02408         }
<a name="l02409"></a>02409         fsm-&gt;rfd = NULL;
<a name="l02410"></a>02410         <span class="keywordflow">break</span>;
<a name="l02411"></a>02411     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526ca0424d7c1da847f75997facbd00f76">FSM_WOPEN</a>:
<a name="l02412"></a>02412         fsm-&gt;wfd = <a class="code" href="rpmio_8c.html#89bd8d7de2b3d1944f570fc2d2d7470a" title="fopen(3) clone.">Fopen</a>(fsm-&gt;path, <span class="stringliteral">"w.ufdio"</span>);
<a name="l02413"></a>02413         <span class="keywordflow">if</span> (fsm-&gt;wfd == NULL || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fsm-&gt;wfd)) {
<a name="l02414"></a>02414             <span class="keywordflow">if</span> (fsm-&gt;wfd != NULL)       (void) <a class="code" href="fsm_8c.html#5cd1965aa3d5448685dfc97fd6d183ff" title="File state machine driver.">fsmNext</a>(fsm, <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452eb1a99b2b31864c90f07457939bae1f1">FSM_WCLOSE</a>);
<a name="l02415"></a>02415             fsm-&gt;wfd = NULL;
<a name="l02416"></a>02416             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2e27dbc04e6a7efe53ef2cf19c050aaeb7">CPIOERR_OPEN_FAILED</a>;
<a name="l02417"></a>02417         }
<a name="l02418"></a>02418         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02419"></a>02419             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%s, \"w\") wfd %p wrbuf %p\n"</span>, cur,
<a name="l02420"></a>02420                 fsm-&gt;path, fsm-&gt;wfd, fsm-&gt;wrbuf);
<a name="l02421"></a>02421         <span class="keywordflow">break</span>;
<a name="l02422"></a>02422     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4529cd1eda1ad81aff279262dae2ef1b825">FSM_WRITE</a>:
<a name="l02423"></a>02423         fsm-&gt;wrnb = <a class="code" href="rpmio_8c.html#0b66d10b5a0e926d57e86327f4e9dcc6" title="fwrite(3) clone.">Fwrite</a>(fsm-&gt;wrbuf, <span class="keyword">sizeof</span>(*fsm-&gt;wrbuf), fsm-&gt;rdnb, fsm-&gt;wfd);
<a name="l02424"></a>02424         <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02425"></a>02425             <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (wrbuf, %d, wfd)\twrnb %d\n"</span>,
<a name="l02426"></a>02426                 cur, (<span class="keywordtype">int</span>)fsm-&gt;rdnb, (<span class="keywordtype">int</span>)fsm-&gt;wrnb);
<a name="l02427"></a>02427         <span class="keywordflow">if</span> (fsm-&gt;rdnb != fsm-&gt;wrnb || <a class="code" href="rpmio_8c.html#5c33b1522107db905bc2e243e8715b7b" title="ferror(3) clone.">Ferror</a>(fsm-&gt;wfd))
<a name="l02428"></a>02428             rc = <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2eae008ca13418c1092ef0c314a8273d8d">CPIOERR_WRITE_FAILED</a>;
<a name="l02429"></a>02429         <span class="keywordflow">break</span>;
<a name="l02430"></a>02430     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452eb1a99b2b31864c90f07457939bae1f1">FSM_WCLOSE</a>:
<a name="l02431"></a>02431         <span class="keywordflow">if</span> (fsm-&gt;wfd != NULL) {
<a name="l02432"></a>02432             <span class="keywordflow">if</span> (<a class="code" href="poptBT_8c.html#76ef6b61d6c034d5d7a84280e388f483">_fsm_debug</a> &amp;&amp; (stage &amp; FSM_SYSCALL))
<a name="l02433"></a>02433                 <a class="code" href="rpmmessages_8h.html#3cc60bca82a45f1ffbe37d684d8cf76c">rpmMessage</a>(RPMMESS_DEBUG, <span class="stringliteral">" %8s (%p)\n"</span>, cur, fsm-&gt;wfd);
<a name="l02434"></a>02434             (void) <a class="code" href="group__rpmio.html#gf04f16c173697f5e1853472a5f46e3e9" title="Sum statistic counters.">rpmswAdd</a>(<a class="code" href="rpmts_8c.html#c92276220455cb91448e333fd510e346" title="Retrieve operation timestamp from a transaction set.">rpmtsOp</a>(<a class="code" href="fsm_8c.html#79af3076ba347b7d1fea192fb7bf911e" title="Retrieve transaction set from file state machine iterator.">fsmGetTs</a>(fsm), <a class="code" href="rpmts_8h.html#00f4ef6cc440476d7078471b8921d7b412f181b0a1d83657264275005c18ef28">RPMTS_OP_DIGEST</a>),
<a name="l02435"></a>02435                         <a class="code" href="group__rpmio.html#ge3f5abab135dae9c547c505016169954">fdstat_op</a>(fsm-&gt;wfd, <a class="code" href="group__rpmio.html#gg826db0fbaeeb15ebe18f459c0e7edd132288e1057056fe7b878d817eaf76bd6e">FDSTAT_DIGEST</a>));
<a name="l02436"></a>02436             (void) <a class="code" href="rpmio_8c.html#df9d9b5146b0155f3629c50a5fbb3cb8" title="fclose(3) clone.">Fclose</a>(fsm-&gt;wfd);
<a name="l02437"></a>02437             <a class="code" href="system_8h.html#a5e6580e8f12679392f66d3c9b146ab4">errno</a> = saveerrno;
<a name="l02438"></a>02438         }
<a name="l02439"></a>02439         fsm-&gt;wfd = NULL;
<a name="l02440"></a>02440         <span class="keywordflow">break</span>;
<a name="l02441"></a>02441 
<a name="l02442"></a>02442     <span class="keywordflow">default</span>:
<a name="l02443"></a>02443         <span class="keywordflow">break</span>;
<a name="l02444"></a>02444     }
<a name="l02445"></a>02445     <span class="comment">/*@=branchstate@*/</span>
<a name="l02446"></a>02446 
<a name="l02447"></a>02447     <span class="keywordflow">if</span> (!(stage &amp; <a class="code" href="fsm_8h.html#1bef3bf78d816388d88e6262465cde19">FSM_INTERNAL</a>)) {
<a name="l02448"></a>02448         fsm-&gt;rc = (rc == <a class="code" href="group__payload.html#gg4dbf9405fc8be17d6ed0d0b606b65a2ead49a14963256f34f3409ee294f239f2">CPIOERR_HDR_TRAILER</a> ? 0 : rc);
<a name="l02449"></a>02449     }
<a name="l02450"></a>02450     <span class="keywordflow">return</span> rc;
<a name="l02451"></a>02451 }
<a name="l02452"></a>02452 <span class="comment">/*@=compmempass@*/</span>
<a name="l02453"></a>02453 <span class="comment">/*@=boundsread@*/</span>
<a name="l02454"></a>02454 
<a name="l02455"></a><a class="code" href="fsm_8h.html#fed7a234831f706bc74dbcb2da055fcd">02455</a> <span class="comment">/*@obserever@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="fsm_8c.html#fed7a234831f706bc74dbcb2da055fcd" title="Return formatted string representation of file disposition.">fileActionString</a>(<a class="code" href="rpmlib_8h.html#08a1787ab1f9297419fc4d37b587cdee" title="File disposition(s) during package install/erase transaction.">fileAction</a> a)
<a name="l02456"></a>02456 {
<a name="l02457"></a>02457     <span class="keywordflow">switch</span> (a) {
<a name="l02458"></a>02458     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9921def1a5a9da9556fbaa0120e3e18c3">FA_UNKNOWN</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"unknown"</span>;
<a name="l02459"></a>02459     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef947c55521a08d7eed68cbb9b1406334ca">FA_CREATE</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"create"</span>;
<a name="l02460"></a>02460     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef957be9542b973695e13c1733094d77ba8">FA_COPYOUT</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"copyout"</span>;
<a name="l02461"></a>02461     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9219135e7b158ab710ed01f0bb9e19888">FA_COPYIN</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"copyin"</span>;
<a name="l02462"></a>02462     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9ed9be5c788aa54c9b5ce47780865d06f">FA_BACKUP</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"backup"</span>;
<a name="l02463"></a>02463     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9ade30ac387d38766fe8b7a62617df7e1">FA_SAVE</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"save"</span>;
<a name="l02464"></a>02464     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef919269a620de20c363e810c731325846a">FA_SKIP</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"skip"</span>;
<a name="l02465"></a>02465     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9084a19c84c61532dc3c8135f8877ebd6">FA_ALTNAME</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"altname"</span>;
<a name="l02466"></a>02466     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef96d7eb8b200bfb8a40319085ee6cda356">FA_ERASE</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"erase"</span>;
<a name="l02467"></a>02467     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9a3882a6b11b46e69c2d19d171e65170f">FA_SKIPNSTATE</a>: <span class="keywordflow">return</span> <span class="stringliteral">"skipnstate"</span>;
<a name="l02468"></a>02468     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9d6f66a763673c78d1f0737381b923772">FA_SKIPNETSHARED</a>: <span class="keywordflow">return</span> <span class="stringliteral">"skipnetshared"</span>;
<a name="l02469"></a>02469     <span class="keywordflow">case</span> <a class="code" href="rpmlib_8h.html#4409aea3e0e68d6f88c7866c85aafef9cc0c5b0b6d9872ea87b8b3b8c035c373">FA_SKIPCOLOR</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"skipcolor"</span>;
<a name="l02470"></a>02470     <span class="keywordflow">default</span>:            <span class="keywordflow">return</span> <span class="stringliteral">"???"</span>;
<a name="l02471"></a>02471     }
<a name="l02472"></a>02472     <span class="comment">/*@notreached@*/</span>
<a name="l02473"></a>02473 }
<a name="l02474"></a>02474 
<a name="l02475"></a><a class="code" href="fsm_8h.html#410ee9097708efa9da4cc2d8843baba8">02475</a> <span class="comment">/*@observer@*/</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">const</span> <a class="code" href="fsm_8c.html#410ee9097708efa9da4cc2d8843baba8" title="Return formatted string representation of file stages.">fileStageString</a>(<a class="code" href="fsm_8h.html#42d68171cc4a6c0495fae9cddb9066d5">fileStage</a> a) {
<a name="l02476"></a>02476     <span class="keywordflow">switch</span>(a) {
<a name="l02477"></a>02477     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452b832487c2611296f132365ac51d0e023">FSM_UNKNOWN</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"unknown"</span>;
<a name="l02478"></a>02478 
<a name="l02479"></a>02479     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209231ed883a0ccbd29c5bb86aeb3c57e">FSM_PKGINSTALL</a>:<span class="keywordflow">return</span> <span class="stringliteral">"INSTALL"</span>;
<a name="l02480"></a>02480     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45279fcf20c3562c3fb85220d2c46d098a3">FSM_PKGERASE</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"ERASE"</span>;
<a name="l02481"></a>02481     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525457310f4ad7ecf16136f8de7c869277">FSM_PKGBUILD</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"BUILD"</span>;
<a name="l02482"></a>02482     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2d50ea36b03c8ec6dc6c2b5a47cba46">FSM_PKGCOMMIT</a>: <span class="keywordflow">return</span> <span class="stringliteral">"COMMIT"</span>;
<a name="l02483"></a>02483     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c1f1dec9ff18f7bad6e721b87fc6b970">FSM_PKGUNDO</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"UNDO"</span>;
<a name="l02484"></a>02484 
<a name="l02485"></a>02485     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526995a48127c97a657880f596f22570a2">FSM_CREATE</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"create"</span>;
<a name="l02486"></a>02486     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d577ae52b65607332e43f7dd9aa68f55">FSM_INIT</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"init"</span>;
<a name="l02487"></a>02487     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45255b09b0215f12140403fbbfa7ad647a3">FSM_MAP</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"map"</span>;
<a name="l02488"></a>02488     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452cb03d554c418cea506c948af046f819c">FSM_MKDIRS</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"mkdirs"</span>;
<a name="l02489"></a>02489     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4524f000e0f91eb552a4272c8373d2d71f7">FSM_RMDIRS</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"rmdirs"</span>;
<a name="l02490"></a>02490     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452cc786b61ee1bd2df93850e09f613d805">FSM_PRE</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"pre"</span>;
<a name="l02491"></a>02491     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525ce36da107c022e04c43298a1af3a007">FSM_PROCESS</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"process"</span>;
<a name="l02492"></a>02492     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45262f0fec43f8bb4411961acf383d8a86b">FSM_POST</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"post"</span>;
<a name="l02493"></a>02493     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fef2b4b17cf9c2b2c127b2e2461b2a5a">FSM_MKLINKS</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"mklinks"</span>;
<a name="l02494"></a>02494     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fdc0a98795027a9a343cb8468c2074e6">FSM_NOTIFY</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"notify"</span>;
<a name="l02495"></a>02495     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c2932debdd2a3b0b0fe86dbc86b1e873">FSM_UNDO</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"undo"</span>;
<a name="l02496"></a>02496     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d826a541a6750b0ffbd4f93f5a3012d8">FSM_FINI</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"fini"</span>;
<a name="l02497"></a>02497     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520a6c510c2b2b3cad342aafd895103e50">FSM_COMMIT</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"commit"</span>;
<a name="l02498"></a>02498     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45241ef66ff78867ee0e0bab88c2d973294">FSM_DESTROY</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"destroy"</span>;
<a name="l02499"></a>02499     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ea2c4dbbb9e603d9a7217584e5f43824">FSM_VERIFY</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"verify"</span>;
<a name="l02500"></a>02500 
<a name="l02501"></a>02501     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d1a3135381df0b67e4f43242aeb2e0f9">FSM_UNLINK</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"Unlink"</span>;
<a name="l02502"></a>02502     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45294461187651e936e67ceb6192674fed7">FSM_RENAME</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"Rename"</span>;
<a name="l02503"></a>02503     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452521a68c56ac73d1ff02e904d90492cce">FSM_MKDIR</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"Mkdir"</span>;
<a name="l02504"></a>02504     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4520cab91415883e1a21162dd617bdcd6da">FSM_RMDIR</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"rmdir"</span>;
<a name="l02505"></a>02505     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452132ce1a922a82ca3e960345881777552">FSM_LSETFCON</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"lsetfcon"</span>;
<a name="l02506"></a>02506     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45245e109a6453f7b699a2519833fd0a84b">FSM_CHOWN</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"chown"</span>;
<a name="l02507"></a>02507     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45209c6764827ee34202e3b3fdeccf43770">FSM_LCHOWN</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"lchown"</span>;
<a name="l02508"></a>02508     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45205b438ddf396dce086c825b5eb4a0133">FSM_CHMOD</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"chmod"</span>;
<a name="l02509"></a>02509     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c7077e4163914aa9516bb6634d41463d">FSM_UTIME</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"utime"</span>;
<a name="l02510"></a>02510     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527293c5fdad84817bac9ccd2482aeb2a6">FSM_SYMLINK</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"symlink"</span>;
<a name="l02511"></a>02511     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452e4050a267ba77b53c5ce751062f3f0c9">FSM_LINK</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"Link"</span>;
<a name="l02512"></a>02512     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ced8ea36357942863a1bf05fb8d8a7d7">FSM_MKFIFO</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"mkfifo"</span>;
<a name="l02513"></a>02513     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452af927b348c046422ada46fd0c9206748">FSM_MKNOD</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"mknod"</span>;
<a name="l02514"></a>02514     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c14737c46922fefb101602543a0ddacb">FSM_LSTAT</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"Lstat"</span>;
<a name="l02515"></a>02515     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527cff4f22668fe661b791651fea2f1dab">FSM_STAT</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"Stat"</span>;
<a name="l02516"></a>02516     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4525a5e162d7e218ad162e17a7a9d8cf3f1">FSM_READLINK</a>:  <span class="keywordflow">return</span> <span class="stringliteral">"Readlink"</span>;
<a name="l02517"></a>02517     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fb0d58c2ef629621671ec54acf98bc4a">FSM_CHROOT</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"chroot"</span>;
<a name="l02518"></a>02518 
<a name="l02519"></a>02519     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45271dd6f1508bddc83c67798efaa8a58b7">FSM_NEXT</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"next"</span>;
<a name="l02520"></a>02520     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527f80e6c393aa30330ed52aec1ab1a663">FSM_EAT</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"eat"</span>;
<a name="l02521"></a>02521     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526b9e8ee4ac25c4e74fc8d394e7424b8d">FSM_POS</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"pos"</span>;
<a name="l02522"></a>02522     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452d879219cd22e4c5fd9bb012cf9908ac3">FSM_PAD</a>:       <span class="keywordflow">return</span> <span class="stringliteral">"pad"</span>;
<a name="l02523"></a>02523     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ec358073676159e71d37a4747146640c">FSM_TRAILER</a>:   <span class="keywordflow">return</span> <span class="stringliteral">"trailer"</span>;
<a name="l02524"></a>02524     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452c84812a02ee5ae0801dfb5dd81764557">FSM_HREAD</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"hread"</span>;
<a name="l02525"></a>02525     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4527d3ffad609d9e2aee93eea5ad12da67f">FSM_HWRITE</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"hwrite"</span>;
<a name="l02526"></a>02526     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452fedb55217c2d9644549604f2d8f37ea1">FSM_DREAD</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"Fread"</span>;
<a name="l02527"></a>02527     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526524a4e5d4bbbb7b0c9c134b4e558b83">FSM_DWRITE</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"Fwrite"</span>;
<a name="l02528"></a>02528 
<a name="l02529"></a>02529     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452f536b77beea08bb509ebcb64848da31c">FSM_ROPEN</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"Fopen"</span>;
<a name="l02530"></a>02530     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452ce99bb73bfc3509e90f18c53d3c3888c">FSM_READ</a>:      <span class="keywordflow">return</span> <span class="stringliteral">"Fread"</span>;
<a name="l02531"></a>02531     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc45224c1f08820c09b3a73cc99e96fd31561">FSM_RCLOSE</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"Fclose"</span>;
<a name="l02532"></a>02532     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4526ca0424d7c1da847f75997facbd00f76">FSM_WOPEN</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"Fopen"</span>;
<a name="l02533"></a>02533     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc4529cd1eda1ad81aff279262dae2ef1b825">FSM_WRITE</a>:     <span class="keywordflow">return</span> <span class="stringliteral">"Fwrite"</span>;
<a name="l02534"></a>02534     <span class="keywordflow">case</span> <a class="code" href="fsm_8h.html#4213dbca0b428003ba8d02d31c2cc452eb1a99b2b31864c90f07457939bae1f1">FSM_WCLOSE</a>:    <span class="keywordflow">return</span> <span class="stringliteral">"Fclose"</span>;
<a name="l02535"></a>02535 
<a name="l02536"></a>02536     <span class="keywordflow">default</span>:            <span class="keywordflow">return</span> <span class="stringliteral">"???"</span>;
<a name="l02537"></a>02537     }
<a name="l02538"></a>02538     <span class="comment">/*@noteached@*/</span>
<a name="l02539"></a>02539 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Fri Oct 12 08:44:53 2007 for rpm by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.2 </small></address>
</body>
</html>
